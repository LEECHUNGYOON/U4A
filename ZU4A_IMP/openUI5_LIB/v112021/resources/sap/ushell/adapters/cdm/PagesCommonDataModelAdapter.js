// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ushell/adapters/cdm/util/cdmSiteUtils","sap/base/util/extend","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/ushell/Config"],function(e,t,i,n,a,jQuery,s){"use strict";var r=function(){this._oCDMPagesRequests={};this._oUnstableVisualizations={};this._sComponent="sap/ushell/adapters/cdm/PagesCommonDataModelAdapter";this.oSitePromise=new Promise(function(e,t){this.fnSiteResolve=e;this.fnSiteReject=t}.bind(this))};r.prototype.getSite=function(){var e=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("NavigationDataProvider").then(function(e){return e.getNavigationData()}).then(function(e){var n={};var a=e.inbounds;for(var s=0;s<a.length;s++){var r=a[s].permanentKey||a[s].id;n[r]=a[s]}var o={_version:"3.1.0",site:{},catalogs:{},groups:{},visualizations:{},applications:i.getApplications(n),vizTypes:{},systemAliases:t({},e.systemAliases),pages:{}};this.fnSiteResolve(o);return o}.bind(this)).then(e.resolve).catch(function(t){e.reject(t);this.fnSiteReject(t)}.bind(this));return e.promise()};r.prototype.getPage=function(t){if(!t){var i="PagesCommonDataModelAdapter: getPage was called without a pageId";e.fatal(i,null,this._sComponent);return Promise.reject(i)}var n=s.last("/core/stableIDs/enabled");return this.oSitePromise.then(function(i){if(i.pages[t]){return i.pages[t]}return Promise.all([sap.ushell.Container.getServiceAsync("PagePersistence"),sap.ushell.Container.getServiceAsync("NavigationDataProvider")]).then(function(e){var i=e[0];var n=e[1];return Promise.all([i.getPage(t),n.getNavigationData()])}).then(function(e){var t=e[0];var a=e[1];this._addVisualizationsToSite(i,t.visualizations);this._addVizTypesToSite(i,t);this._addPageToSite(i,t.page,a);if(n){this._storeUnstableVisualizations(t.page.id,t.unstableVisualizations)}return i.pages[t.page.id]}.bind(this)).catch(function(t){e.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",t,this._sComponent);return Promise.reject(t)}.bind(this))}.bind(this))};r.prototype._storeUnstableVisualizations=function(e,t){if(!t){return}this._oUnstableVisualizations[e]=t};r.prototype._addVizTypesToSite=function(e,t){var a={};Object.keys(t.vizTypes).forEach(function(i){if(!e.vizTypes[i]){a[i]=t.vizTypes[i]}});n(e.vizTypes,i.getVizTypes(a))};r.prototype._addVisualizationsToSite=function(e,t,a){var s;if(a){s={};Object.keys(t).forEach(function(i){if(!e.visualizations[i]){s[i]=t[i]}})}else{s=t}n(e.visualizations,i.getVisualizations(s))};r.prototype._addPageToSite=function(t,i,n){var a={};var s=n.inbounds;for(var r=0;r<s.length;r++){var o=s[r].permanentKey||s[r].id;a[o]=s[r]}var l=t.pages[i.id]={identification:{id:i.id,title:i.title},payload:{layout:{sectionOrder:i.sections.map(function(e){return e.id})},sections:{}}};var u;var c;for(var d=0;d<i.sections.length;d++){u=i.sections[d];c=l.payload.sections[u.id]={id:u.id,title:u.title,layout:{vizOrder:u.viz.map(function(e){return e.id})},viz:{}};var p,v;for(var h=0;h<u.viz.length;h++){p=u.viz[h];v=!t.visualizations[p.vizId];if(v){var f=c.layout.vizOrder;f.splice(f.indexOf(p.id),1);if(v){e.error("Tile "+p.id+" with vizId "+p.vizId+" has no matching visualization. As the tile cannot be used to start an app it is removed from the page.")}continue}c.viz[p.id]={id:p.id,vizId:p.vizId,displayFormatHint:p.displayFormatHint}}}};r.prototype.getPages=function(t){if(!(t&&Array.isArray(t)&&t.length!==0)){var i="PagesCommonDataModelAdapter: getPages is not an array or does not contain any Page id";e.fatal(i,null,this._sComponent);return Promise.reject(i)}return this.oSitePromise.then(function(i){var n;var a=[];for(var r=0;r<t.length;r++){n=t[r];if(!i.pages[n]){a.push(t[r])}}if(a.length===0){return i.pages}return Promise.all([sap.ushell.Container.getServiceAsync("PagePersistence"),sap.ushell.Container.getServiceAsync("NavigationDataProvider")]).then(function(e){var t=e[0];var i=e[1];return Promise.all([t.getPages(a),i.getNavigationData()])}).then(function(e){var t=e[0];var n=e[1];for(var a=0;a<t.length;a++){this._addVisualizationsToSite(i,t[a].visualizations,true);this._addVizTypesToSite(i,t[a]);this._addPageToSite(i,t[a].page,n);if(s.last("/core/stableIDs/enabled")){this._storeUnstableVisualizations(t[a].page.id,t[a].unstableVisualizations)}}return i.pages}.bind(this)).catch(function(t){e.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",t,this._sComponent);return Promise.reject(t)}.bind(this))}.bind(this)).then(function(e){var i={};t.forEach(function(t){var n=e[t];if(n){i[t]=n}});return i})};r.prototype.getPersonalization=function(t){var i=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("PersonalizationV2").then(async function(n){var s;var r=new a(t);s={container:"sap.ushell.cdm.personalization",item:"data"};if(r.inRange("3.1.0","4.0.0")){s={container:"sap.ushell.cdm3-1.personalization",item:"data"}}var o={validity:"Infinity",keyCategory:n.constants.keyCategory.GENERATED_KEY,writeFrequency:n.constants.writeFrequency.HIGH,clientStorageAllowed:false};const l=await n.getPersonalizer(s,o);l.getPersData().then(function(e){i.resolve(e||{})}).catch(function(t){e.error("Could not load page personalization",t,this._sComponent);i.reject(t)}.bind(this))}.bind(this)).catch(function(){i.reject("Personalization Service could not be loaded")});return i.promise()};r.prototype.setPersonalization=function(e){var t=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("PersonalizationV2").then(async function(i){var n;var s=new a(e.version);n={container:"sap.ushell.cdm.personalization",item:"data"};if(s.inRange("3.1.0","4.0.0")){n={container:"sap.ushell.cdm3-1.personalization",item:"data"}}var r={validity:"Infinity",keyCategory:i.constants.keyCategory.GENERATED_KEY,writeFrequency:i.constants.writeFrequency.HIGH,clientStorageAllowed:false};const o=await i.getPersonalizer(n,r);o.setPersData(e).then(function(){t.resolve(e)}).catch(function(e){t.reject(e)})}).catch(function(){t.reject("Personalization Service could not be loaded")});return t.promise()};r.prototype.getVisualizations=function(){return sap.ushell.Container.getServiceAsync("VisualizationDataProvider").then(function(e){return Promise.all([e.getVisualizationData(),this.oSitePromise]).then(function(e){var t=e[0];var i=e[1];this._addVisualizationsToSite(i,t.visualizations);return i.visualizations}.bind(this))}.bind(this))};r.prototype.getVizTypes=function(){return sap.ushell.Container.getServiceAsync("VisualizationDataProvider").then(function(e){return Promise.all([e.getVisualizationData(),this.oSitePromise]).then(function(e){var t=e[0];var i=e[1];this._addVizTypesToSite(i,t);return i.vizTypes}.bind(this))}.bind(this))};r.prototype.getVizType=function(e){return this.oSitePromise.then(function(t){var a=t.vizTypes[e];if(a){return a}if(!e.startsWith("X-SAP-UI2-CHIP:")){return}return sap.ushell.Container.getServiceAsync("VisualizationDataProvider").then(function(t){return t.loadVizType(e)}).then(function(a){if(!a){return}var s={};s[e]=a;n(t.vizTypes,i.getVizTypes(s));return t.vizTypes[e]})})};r.prototype.getCachedVisualizations=function(){return this.oSitePromise.then(function(e){return e.visualizations})};r.prototype.getCachedVizTypes=function(){return this.oSitePromise.then(function(e){return e.vizTypes})};r.prototype.migratePersonalizedPages=function(e){var t=[];e.forEach(function(e){var i=e.identification.id;var n=this._oUnstableVisualizations[i];if(!n){return}Object.keys(e.payload.sections).forEach(function(a){var s=e.payload.sections[a];Object.keys(s.viz).forEach(function(e){var a=s.viz[e];var r=n[a.vizId];if(r){a.vizId=r.vizId;if(!t.includes(i)){t.push(i)}}})});this._oUnstableVisualizations[i]=null}.bind(this));return Promise.resolve(t)};return r},false);
//# sourceMappingURL=PagesCommonDataModelAdapter.js.map