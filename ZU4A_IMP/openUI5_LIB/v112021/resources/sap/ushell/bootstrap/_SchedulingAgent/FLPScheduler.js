// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/performance/trace/FESR","sap/ushell/bootstrap/_SchedulingAgent/state","sap/base/util/LoaderExtensions","sap/base/Log","sap/ushell/Config"],function(e,o,n,i,t){"use strict";var a={Loaded:"loaded",Wait:"wait",Step:"step",Error:"error",BlockDone:"blockDone",Start:"start",Done:"done",Skipped:"skipped"};var d="sap/ushell/bootstrap/_SchedulingAgent/LoadingConfiguration.json";var s="sap/ushell/bootstrap/_SchedulingAgent/StepConfiguration.json";function r(){return t.last("/core/shell/model/currentState/stateName")}var l={oSchedule:{iBlockIndex:0,aBlocksLoading:[]},initializeSchedule:function(){var e=n.loadResource(s,{async:true});var i=n.loadResource(d,{async:true});var t=Promise.all([e,i]).then(function(e){this._adaptForSpecialEvents(e);var n=e[0];var i=e[1];var t=this._validateConfig(i,n);if(t){this.oSchedule.oBlocks=i.LoadingBlocks;this.oSchedule.oSteps=n;this.oSchedule.aBlockOrder=i.OrderOfLoadingBlocks;this.oSchedule.iBlockIndex=0;o.setForModule(o.id.module.flpScheduler.id,o.id.module.flpScheduler.Initialized,"Schedule validated")}else{o.setForModule(o.id.module.flpScheduler.id,o.id.module.flpScheduler.WrongConfiguration,"Configuration error")}return t}.bind(this));return t},getNextLoadingStep:function(){var e={sStatus:a.Start,oContent:{}};if(this.oSchedule.aBlocksLoading.length===0){var n=this._startLoadingBlock();if(n){e.sStatus=a.Done;return e}}var i=this.oSchedule.aBlocksLoading[this.oSchedule.aBlocksLoading.length-1];var t=this.oSchedule.aBlockOrder.indexOf(i);var d=this.oSchedule.aBlockOrder[t+1];if(this.oSchedule.oBlocks[i].bCanBeLoadedConcurrently&&d){this._startLoadingBlock()}var s=true;var r=false;var l,c,p,u,g,S,h,f,L;for(var k=0;k<this.oSchedule.aBlocksLoading.length;k++){l=this.oSchedule.aBlocksLoading[k];c=this.oSchedule.oBlocks[l];p=c.iStepIndex;u=c.LoadingSteps[p];g=p===c.LoadingSteps.length-1;S=this._checkAndUpdateAsyncQueue(c);L=o.isStepLoaded(u.LoadingStep)||o.isStepSkipped(u.LoadingStep);f=o.isStepLoading(u.LoadingStep);s=S.bAllStepsDone&&L;r=S.bAStepIsLoading||f;if(f&&!u.canBeLoadedAsync||r&&g){e.sStatus=a.Wait;continue}if(!g||!L&&!f){if(L||u.canBeLoadedAsync&&f){p+=1}e=this._prepareStepForLoading(c,l,p)}if(s&&g){h=this.oSchedule.aBlocksLoading.indexOf(l);this.oSchedule.aBlocksLoading.splice(h,1);e.sStatus=a.BlockDone;o.setForLoadingBlock(l,o.id.loadingBlock.Done,"","Block removed from loading queue")}if(e.sStatus!==a.wait){break}}return e},dumpSchedule:function(){i.debug(JSON.stringify(this.oSchedule))},_adaptForSpecialEvents:function(o){var n=o[0];if(n.ConditionalWaitForAppLoading&&n.ConditionalWaitForAppLoading.continueOnEvent&&n.ConditionalWaitForAppLoading.continueOnEvent.eventName==="startUpFesrEnhanced"&&e.getActive()===false){n["ConditionalWaitForAppLoading"].continueOnEvent.timeoutInMs=3e3}},_loadingIsEnabled:function(e){var o;if(Array.isArray(e.oConfig.excludedFLPStates)){if(e.oConfig.excludedFLPStates.indexOf(r())>-1){return false}}if(Array.isArray(e.oConfig.mandatoryFLPStates)&&e.oConfig.mandatoryFLPStates.length!==0){if(e.oConfig.mandatoryFLPStates.indexOf(r())===-1){return false}}function n(e){return e.path&&t.last(e.path)!==e.assertionValue}if(e.oConfig.configSwitch){o=[].concat(e.oConfig.configSwitch);if(o.some(n)){return false}}return true},_checkAndUpdateAsyncQueue:function(e){var n=[];var i,t,a;var d=true;var s=false;for(var r=0;r<e.aAsyncStepsLoading.length;r++){a=e.aAsyncStepsLoading[r];i=o.isStepLoaded(a)||o.isStepSkipped(a);t=o.isStepLoading(a);if(t){n.push(a)}d=d&&i;s=s||t}e.aAsyncStepsLoading=n;return{bAllStepsDone:d,bAStepIsLoading:s}},_startLoadingBlock:function(){var e=false;if(this.oSchedule.iBlockIndex<this.oSchedule.aBlockOrder.length){var n=this.oSchedule.aBlockOrder[this.oSchedule.iBlockIndex];this.oSchedule.aBlocksLoading.push(n);this.oSchedule.oBlocks[n].iStepIndex=0;this.oSchedule.oBlocks[n].aAsyncStepsLoading=[];this.oSchedule.iBlockIndex+=1;o.setForLoadingBlock(n,o.id.loadingBlock.Prepared,"","Block added to the loading queue.")}else{e=true}return e},_prepareStepForLoading:function(e,n,i){var t;var d={sStatus:a.Step,oContent:e.LoadingSteps[i],oConfig:this.oSchedule.oSteps[e.LoadingSteps[i].LoadingStep]};if(!this._loadingIsEnabled(d)){d.sStatus=a.Skipped;e.iStepIndex=i;o.setForLoadingStep(d.oContent.LoadingStep,o.id.loadingStep.Skipped,"","Step set to skipped");return d}var s=this._checkDependencies(d,n);if(s.bMissing){d.sStatus=a.Error}else if(s.bAllLoaded){o.setForLoadingStep(d.oContent.LoadingStep,o.id.loadingStep.Prepared,"","Step prepared for control unit");t=d.oContent.canBeLoadedAsync;e.iStepIndex=i;if(t){o.setForLoadingStep(d.oContent.LoadingStep,o.id.loadingStep.Prepared,"","Step set on the async loading queue");e.aAsyncStepsLoading.push(d.oContent.LoadingStep)}}else{d.sStatus=a.Wait;o.setForLoadingStep(d.oContent.LoadingStep,o.id.loadingStep.WaitingForDependencies,"","Step missing dependencies")}return d},_checkDependencies:function(e,n){var i={bAllLoaded:true,bMissing:false};if(e.oConfig.Dependencies){for(var t=0;t<e.oConfig.Dependencies.length;t++){i.bAllLoaded=i.bAllLoaded&&o.isStepLoaded(e.oConfig.Dependencies[t]);if(!o.isStepLoaded(e.oConfig.Dependencies[t])&&!o.isStepLoading(e.oConfig.Dependencies[t])){o.setForLoadingStep(e.oContent.LoadingStep,o.id.loadingStep.Aborted,e.oConfig.Dependencies[t],"Missing a dependency");o.setForLoadingBlock(n,o.id.loadingBlock.Aborted,e.oConfig.Dependencies[t],"A step is missing a dependency");o.setForModule(o.id.module.flpScheduler.id,o.id.module.flpScheduler.LoadingAborted,"Dependencies can not be resolved: a dependency isn't loading before it is required.");i.bMissing=true;i.bAllLoaded=false;break}}}return i},_validateConfig:function(e,o){var n=e&&e.OrderOfLoadingBlocks&&e.LoadingBlocks&&e.OrderOfLoadingBlocks.length&&o;if(!n){return false}var i=e.OrderOfLoadingBlocks.reduce(function(n,i){n=n&&e.LoadingBlocks[i];if(n){var t=e.LoadingBlocks[i];var a=true;if(t.LoadingSteps){var d;for(var s=0;s<t.LoadingSteps.length;s++){d=t.LoadingSteps[s].LoadingStep;a=a&&o[d]}}n=n&&a}return!!n},true);return i}};return l},false);
//# sourceMappingURL=FLPScheduler.js.map