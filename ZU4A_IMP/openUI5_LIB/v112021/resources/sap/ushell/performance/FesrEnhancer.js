// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ui/performance/trace/FESR","sap/ushell/EventHub","sap/ushell/performance/ShellAnalytics"],function(e,t,n,r,a){"use strict";const i="FesrEnhancer";const s="[FesrFlp]";const c={HOME_INITIAL:"FLP@LOAD",HOME_LOADING:"FLP@DURING_LOAD",FINDER_INITIAL:"FLP@LOAD_FINDER",APP_INITIAL:"FLP@DEEP_LINK",NAVIGATION:"NAVIGATION",CUSTOM_HOME_INITIAL:"FLPCUSTOMHOME"};const o=[c.HOME_INITIAL,c.FINDER_INITIAL,c.CUSTOM_HOME_INITIAL,c.APP_INITIAL];const l={APP_START:1,STEP_IN_APP:2,UNKNOWN:3};const p=["stepName","appNameLong","appNameShort","interactionType","timeToInteractive"];const u={stepName:{maxLength:20},appNameShort:{maxLength:20}};const d={_fnOriginalOnBeforeCreated:null,_lastTrackedRecord:null,init:function(){if(n.getActive()){a.enable();this._fnOriginalOnBeforeCreated=n.onBeforeCreated;n.onBeforeCreated=this._onBeforeCreatedHandler.bind(this)}},reset:function(){n.onBeforeCreated=this._fnOriginalOnBeforeCreated;a.disable();this._setLastTrackedRecord(null)},_getPerformanceEntries:function(e,t){if(t){return performance.getEntriesByName(e)}return performance.getEntriesByType("mark").filter(t=>t.name.includes(e))},_getLastTrackedApplicationId:function(){const e=a.getCurrentApplication();if(e){return e.id}return null},_getLastTrackedRecord:function(){return this._lastTrackedRecord},_setLastTrackedRecord:function(e){this._lastTrackedRecord=e},_onBeforeCreatedHandler:function(n,a){let l=t({},n);try{const{scenario:t,relatedRecord:n}=this._detectScenario(l);e.debug(`${s} identified scenario: ${t}`,null,i);const a=this._getLastTrackedApplicationId();if(a){l.appNameShort=a}let d;switch(t){case c.HOME_INITIAL:case c.CUSTOM_HOME_INITIAL:case c.FINDER_INITIAL:d=this._enhanceInitialStart(l,t,n);break;case c.APP_INITIAL:d=this._enhanceInitialAppStart(t,n);break;case c.NAVIGATION:case c.HOME_LOADING:d=this._enhanceNavigationRecord(t,n);break;default:e.debug(`${s} unknown scenario, step name: ${l.stepName}`,null,i);return l}if(o.includes(t)){r.emit("startUpFesrEnhanced",Date.now())}d=Object.keys(d).reduce((e,t)=>{const n=d[t];if(p.includes(t)&&!!n){const r=u[t];if(r&&r.maxLength){e[t]=n.substring(0,r.maxLength)}else{e[t]=n}}return e},{});l={...l,...d};e.debug(`${s} passing enhancements:`,JSON.stringify(d,null,2),i)}catch(t){e.error(`${s} Could not enhance the FESR:`,t,i)}e.debug(`${s}      => UI5: ${l.stepName} - ${l.appNameShort}`,null,i);return l},_getRelevantPerformanceMark:function(t){if(!t){e.warning(`${s} Could not determine performance mark`,"No Statistical Record found",i);return}const n=[];if(t.getTargetIsHomeApp()){n.push(this._getPerformanceEntries("FLP-TTI-Homepage-Custom",true)[0])}else{switch(t.getTargetApplication()){case"FLP_HOME":n.push(this._getPerformanceEntries("FLP-TTI-Homepage",true)[0]);break;case"FLP_PAGE":n.push(this._getPerformanceEntries("FLP-TTI-Homepage",true)[0]);n.push(this._getPerformanceEntries("FLP-Pages-Service-loadPage-end",false)[0]);break;case"FLP_FINDER":n.push(this._getPerformanceEntries("FLP-TTI-AppFinder",true)[0]);break;default:}}return n.filter(e=>{if(!e){return false}if(typeof e.startTime!=="number"){return false}if(e.startTime>t.getTimeStart()){return true}return false})[0]},_detectScenario:function(t){if(t.stepName==="undetermined_startup"){let n;const r=a.getLastClosedRecord();if(r){this._setLastTrackedRecord(r)}else{e.warning(`${s} Identified undetermined_startup but could not find a closed StatisticalRecord`,null,i);return{scenario:null,relatedRecord:null}}if(r.getTargetIsHomeApp()){n=c.CUSTOM_HOME_INITIAL}else{switch(t.appNameLong){case"sap.ushell.components.homepage":case"sap.ushell.components.pages":n=c.HOME_INITIAL;break;case"sap.ushell.components.appfinder":n=c.FINDER_INITIAL;break;default:n=c.APP_INITIAL}}return{scenario:n,relatedRecord:r}}const n=this._getLastTrackedRecord();const r=a.getNextNavigationRecords(n);if(r.length){const t=r[r.length-1];if(r.length>1){const t=r.reduce((e,t,n)=>{if(n<r.length-1){e.push(t.getTargetHash())}return e},[]);e.warning(`${s} skipped Records:`,JSON.stringify(t,null,2),i)}if(n&&t.isEqual(n)){return{scenario:null,relatedRecord:null}}this._setLastTrackedRecord(t);const a=t.getStep()===c.HOME_LOADING?c.HOME_LOADING:c.NAVIGATION;return{scenario:a,relatedRecord:t}}return{scenario:null,relatedRecord:null}},_enhanceInitialStart:function(t,n,r){const a={};if(n===c.CUSTOM_HOME_INITIAL){a.stepName=n+"@"+t.appNameShort}else{a.stepName=n}a.interactionType=l.APP_START;a.appNameShort=r.getTargetAppNameShort()||r.getTargetApplication();const o=this._getRelevantPerformanceMark(r);if(o){e.debug(`${s} using performance mark: ${o.name}`,null,i);a.timeToInteractive=o.startTime}else{e.warning(`${s} Scenario ${n} detected did not found a performance mark`,null,i)}return a},_enhanceNavigationRecord:function(t,n){const r={};if(t!=="FLP@DURING_LOAD"){r.stepName=n.getStep()}if(n.getTargetApplicationType()==="UI5"){r.interactionType=l.APP_START}r.appNameShort=n.getTargetAppNameShort()||n.getTargetApplication();const a=this._getRelevantPerformanceMark(n);if(/^FLP_BACK/.test(r.stepName)&&a){e.debug(`${s} using performance mark: ${a.name}`,null,i);r.timeToInteractive=a.startTime-n.getTimeStart()}return r},_enhanceInitialAppStart:function(e,t){const n={};n.stepName=e;if(t.getTargetApplicationType()==="UI5"){n.interactionType=l.APP_START}else{n.interactionType=l.STEP_IN_APP}return n}};return d},true);
//# sourceMappingURL=FesrEnhancer.js.map