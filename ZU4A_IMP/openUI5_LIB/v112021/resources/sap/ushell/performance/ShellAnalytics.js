// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/EventHub","sap/ushell/services/AppConfiguration","sap/ushell/performance/StatisticalRecord","sap/ushell/utils"],function(e,n,t,a,i){"use strict";const o="ShellAnalytics";const r="[FesrFlp]";let s=[];let c=[];let l=false;let p=false;let u,d,h;const f={EXPLACE:"EXPLACE",INPLACE:"INPLACE"};const g={"sap.ushell.components.appfinder":"FLP_FINDER","sap.ushell.components.pages":"FLP_PAGE","sap.ushell.components.homepage":"FLP_HOME"};function m(e){if(!e){return false}return e.id==="FLP_HOME"||e.id==="FLP_PAGE"}function C(e){return e&&e.isHomeApp}function v(){return s}function A(){const e=v().filter(e=>e.isClosed());if(e.length>0){return e[e.length-1]}return null}function N(e){if(!e){return v().filter(e=>e.isClosed())}return v().filter(n=>e.getTimeStart()<n.getTimeStart()&&n.isClosed())}function I(){return d}function E(n){e.debug(`${r} ShellAnalytics setCurrentApplication: ${n&&n.id}`,null,o);d=n}function P(){h=performance.now();i.setPerformanceMark("FLP -- change hash")}function y(){if(!u){const e=s[s.length-1]||null;u=new a(e);s.push(u)}return u}function L(e){const n=y();n.setTargetHash(e);n.setTimeStart(h||performance.now())}function S(e){const n=e||"";if(n.slice(-7)==="(TCODE)"){return n.replace(/ .*/,"").replace(/^\*/,"").substring(0,15).concat(" (TR)")}return n}function T(e){let n="";const t=e.componentInstance&&e.componentInstance.getManifest();if(t&&t["sap.app"]&&t["sap.app"].id){n=t["sap.app"].id}return n}async function H(){const e=await sap.ushell.Container.getServiceAsync("AppLifeCycle");const n=e.getCurrentApplication();if(!n){return{}}const a=n&&n.componentInstance&&n.componentInstance.sId&&n.componentInstance.sId.includes("homeApp-component");let i;if(n.getTechnicalParameter){i=n.getTechnicalParameter("sap-fiori-id")}else{i=Promise.resolve([])}const o=await i;let r=o&&o[0];if(a){return{type:"UI5",id:r,isHomeApp:true}}if(n.homePage){const e=g[T(n)]||"FLP_HOME";return{type:"UI5",id:e}}if(n.applicationType==="UI5"){if(!r){r=T(n);r=g[r]||r}r=r.replace(/,/g,"");return{type:"UI5",id:r}}const s=t.getMetadata().technicalName||t.getCurrentApplication().text||n.applicationType;const c=S(s.replace(/,/g,""));return{type:n.applicationType,id:c}}function R(e,n,t,a){if(a){a.setSourceApplication(e&&e.id);a.setTargetApplication(n&&n.id);a.setTargetApplicationType(n&&n.type);a.setNavigationMode(t);a.setTargetIsHomeApp(C(n));a.setSourceIsHomeApp(C(e));if(!l&&(C(n)||m(n))){l=true;a.setHomepageLoading(true)}a.closeRecord()}}function F(e){if(!u){return}const n=u;u=null;H().then(t=>{const a=I();if(e&&e.technicalName){t.id=S(e.technicalName);t.type=t.id.slice(-4)==="(TR)"?"GUI":"NWBC"}E(t);R(a,t,f.INPLACE,n)})}function w(){const e=u;u=null;const n=I();R(n,null,f.EXPLACE,e)}function b(){if(u){const e=I();u.setSourceApplication(e?e.id:undefined);u.closeRecordWithError();u=null}}async function M(){const e=await sap.ushell.Container.getServiceAsync("ShellNavigation");e.hashChanger.attachEvent("hashChanged",P);e.hashChanger.attachEvent("shellHashChanged",P)}async function O(){const e=await sap.ushell.Container.getServiceAsync("ShellNavigation");e.hashChanger.detachEvent("hashChanged",P);e.hashChanger.detachEvent("shellHashChanged",P)}function $(){if(p){return}p=true;const t=[{once:true,eventName:"ShellNavigationInitialized",handler:M},{eventName:"trackHashChange",handler:L},{eventName:"doHashChangeError",handler:b},{once:true,eventName:"firstSegmentCompleteLoaded",handler:F},{once:true,eventName:"firstCatalogSegmentCompleteLoaded",handler:F},{once:true,eventName:"PagesRuntimeRendered",handler:F},{once:true,eventName:"CustomHomeRendered",handler:F},{eventName:"PageRendered",handler:_},{eventName:"AppRendered",handler:F},{eventName:"openedAppInNewWindow",handler:w},{eventName:"CloseFesrRecord",handler:F}];const a=t.map(t=>{if(t.once){return n.once(t.eventName).do((...n)=>{e.debug(`${r} Incoming event: ${t.eventName}`,JSON.stringify(n[0],null,2),o);t.handler(...n)})}return n.on(t.eventName).do((...n)=>{e.debug(`${r} Incoming event: ${t.eventName}`,JSON.stringify(n[0],null,2),o);t.handler(...n)})});c=[...c,...a]}function _(e){const n=y();n.enhanceTargetApplicationData({pageId:e.pageId,spaceId:e.spaceId})}function U(){if(!p){return}c.forEach(e=>{e.off()});c=[];O();E(null);s=[];u=null;p=false}return{enable:$,disable:U,getAllRecords:v,getCurrentApplication:I,getLastClosedRecord:A,getNextNavigationRecords:N}},false);
//# sourceMappingURL=ShellAnalytics.js.map