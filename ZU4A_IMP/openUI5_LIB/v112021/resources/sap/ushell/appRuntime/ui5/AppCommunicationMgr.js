// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/deepExtend","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/components/applicationIntegration/application/PostMessageAPIInterface"],function(e,jQuery,s,t,n){"use strict";var i="sap.ushell.appRuntime.ui5.AppCommunicationMgr";var r={},a=[],o=0;function u(){this.init=function(e){var s=this;s.handleMessageEvent=u.prototype._handleMessageEvent.bind(s,s);addEventListener("message",s.handleMessageEvent);if(e===true){s.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid");setInterval(function(){s.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid")},2500)}n.init(false,this.registerCommHandlers.bind(this))};this.destroy=function(){removeEventListener("message",this.handleMessageEvent)};this.registerCommHandlers=function(s){e(r,s)};this._handleMessageResponse=function(e){if(e.request_id&&a[e.request_id]){var s=a[e.request_id];delete a[e.request_id];if(e.status==="success"){s.resolve(e.body.result)}else{s.reject()}}};this._handleMessageRequest=function(e,n,a){var o=this,u=s.create("sap-ushell-config.services.PostMessage.config"),g=a&&a.service,d,c,l,p,f;t.debug("App Runtime received post message request from origin '"+n.origin+"': "+JSON.stringify(a),null,i);if(!g){return}if(u&&u.enabled===false){t.warning("App Runtime received message for "+c+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,i);return}if(!this._isTrustedPostMessageSource(e,n)){t.warning("App Runtime received message from untrusted origin '"+n.origin+"': "+JSON.stringify(n.data),null,i);return}if(g==="sap.ushell.services.MessageBroker"){g=g.concat("._execute")}if(g.indexOf(".")>0){d=g.split(".");l=d[d.length-1];c=g.substr(0,g.length-l.length-1)}else{t.warning("App Runtime received message with invalid service name ("+g+") :"+JSON.stringify(n.data),null,i);return}var h={oMessage:n,oMessageData:a,oContainer:e};try{p=r[c];f=p&&p.oServiceCalls[l];if(f&&f.executeServiceCallFn){f.executeServiceCallFn(h).then(function(e){var s=e&&e.hasOwnProperty("_noresponse_")?true:false;if(!s){o.sendResponseMessage(n,a,"success",{result:e})}},function(e){o.sendResponseMessage(n,a,"error",{message:e})})}else{t.warning("App Runtime received message with unknown service name ("+a.service+") :"+JSON.stringify(n.data),null,i)}}catch(e){t.warning("Error in processing message: "+e.message+") :"+JSON.stringify(n.data),null,i)}};this._getCFLPWindow=function(){return window.parent};this._isTrustedPostMessageSource=function(e,s){var t=false,n=e._getCFLPWindow();if(n){t=s.source===n}return t};this.sendResponseMessage=function(e,s,n,r){var a=JSON.stringify({type:"response",service:s.service,request_id:s.request_id,status:n,body:r});t.debug("Sending post message response to origin ' "+e.origin+"': "+a,null,i);if(typeof e.source!=="object"||e.source===null){t.debug("Cannot send response message to origin ' "+e.origin,"`source` member of request message is not an object",i);return}e.source.postMessage(a,e.origin)};this._getTargetWindow=function(){return window.parent};this.postMessage=function(e){var s,n=this._getTargetWindow();if(e){try{if(e.type==="request"&&!e.request_id){e.request_id=this.getId()}s=JSON.stringify(e);n.postMessage(s,"*")}catch(s){t.error("Message '"+e+"' cannot be posted: "+s,"sap.ui5Isolation.AppCommunicationMgr")}}};this.sendMessageToOuterShell=function(e,s,t,n,i){var r=new jQuery.Deferred,o={type:"request",service:e,body:s||{},request_id:t};this.postMessage(o);a[o.request_id]=r;if(n){setTimeout(function(){r.resolve(i)},n)}return r.promise()};this.getId=function(){return"SAPUI5_APPRUNTIME_MSGID_"+ ++o}}u.prototype._handleMessageEvent=function(e,s){if(s===undefined){return}var n=s.data;if(typeof n==="string"){try{n=JSON.parse(s.data,this)}catch(e){t.debug("Message received from origin '"+s.origin+"' cannot be parsed: "+e,n,i);return}}if(n.type==="request"){return e._handleMessageRequest(e,s,n)}else if(n.type==="response"){return e._handleMessageResponse(n)}};return new u});
//# sourceMappingURL=AppCommunicationMgr.js.map