// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppCommunicationMgr","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/extend","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/appRuntime/ui5/performance/FesrEnhancer","sap/ushell/EventHub","sap/base/Log","sap/ui/thirdparty/hasher","sap/ui/core/Core","sap/ushell/utils/UrlParsing","sap/ushell/appRuntime/ui5/AppRuntimeContext","sap/base/assert","sap/ushell/resources"],function(e,t,s,n,a,r,i,p,o,u,l,c,f,h,d,g){"use strict";function m(){var m=this,A,v,C=true,y={},S,b={},I={},R={},w={},P,N,O,H,F;this.init=function(t,s,n,a,r,i){this.resetCurrentApp();A=t;S=s;N=n;if(a!==undefined){C=a}this.addAppInfoToCache(r,i);e.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.create(t)}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.destroy(t)}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.store(t)}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.restore(t)}}}}});o.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&I[e.componentId]){I[e.componentId]=e.disable}});this._sendAppRuntimeSetup();if(!g.browserI18n){g.browserI18n=g.getTranslationModel(window.navigator.language).getResourceBundle()}H=g.browserI18n.getText("dataLossExternalMessage");window.onbeforeunload=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()){return H}return undefined}};this._sendAppRuntimeSetup=()=>{const e={isStateful:true,isKeepAlive:true,isIframeValid:true,session:{bLogoutSupport:true}};const s={session:{bLogoutSupport:true}};t.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",window["sap-ushell-config"]?.ui5appruntime?.config?.stateful===false?s:e)};this.create=function(e){return new Promise(function(t,s){var o,u,g,A,v="",C;p.startInteraction();o=e.body.sUrl;if(h.getIsScube()){g=n.fromURL(o).get("sap-remote-intent");d(typeof g==="string","AppLifeCycleAgent::create - sAppIntent must be string");if(e.body.sHash.indexOf("Shell-startIntent")===0){A=f.parseShellHash(e.body.sHash);v=A.params["sap-shell-so"]+"-"+A.params["sap-shell-action"]}}else{u=n.fromURL(o).get("sap-ui-app-id");d(typeof u==="string","AppLifeCycleAgent::create - sAppId must be string")}l.disableCFLPUpdate=true;l.replaceHash("");l.replaceHash(e.body.sHash);l.disableCFLPUpdate=false;if(r.browser.chrome){i.show(0)}if(O){O._resetBackNavigationCallback()}c.getEventBus().publish("launchpad","appOpening",{});m.getAppInfo(u,o,g).then(function(e){let s;if(Object.keys(b).length>0){if(h.getIsScube()&&v.length>0){s=t=>b[t].sAppIntent===v&&b[t].ui5ComponentName===e.oResolvedHashFragment.ui5ComponentName}else{s=t=>b[t].ui5ComponentName&&b[t].ui5ComponentName===e?.oResolvedHashFragment?.ui5ComponentName}C=Object.keys(b).find(s);if(C){m.destroy({body:{sCacheId:C}},true)}}m.expandSapIntentParams(new a(o).query(true)).then(function(s){S(u,s,e.oResolvedHashFragment,g,e.oParsedHash).then(function(e){N(e);c.getEventBus().publish("sap.ushell","appOpened",{});t({deletedKeepAliveId:C})})})})})};this.destroy=function(e,s){function n(e){var t=e.sId||"<unkown>";try{e.destroy()}catch(e){u.error("exception when trying to close sapui5 application with id '"+t+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}var a=e.body.sCacheId;if(P.oApp===undefined&&a===undefined){t.sendMessageToOuterShell("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}if(a&&b[a]){if(b[a].oApp===P.oApp){this.resetCurrentApp()}delete I[b[a].oApp.sId];n(b[a].oApp);delete b[a]}else if(P.oApp){delete I[P.oApp.sId];n(P.oApp);this.resetCurrentApp()}sap.ushell.Container.cleanDirtyStateProviderArray();if(O){O._resetBackNavigationCallback()}p.setAppShortId();c.getEventBus().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.store=function(e){var s=e.body.sCacheId,n=this.cloneCurrentAppEntry(P),a;if(P.oApp===undefined){t.sendMessageToOuterShell("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}b[s]=n;if(O){w[s]=O._getBackNavigationCallback()}a=n.oApp.getComponentInstance();n.oApp.setVisible(false);if(sap.ushell.Container){R[s]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray()}if(a){if(a.isKeepAliveSupported&&a.isKeepAliveSupported()===true){a.deactivate()}else{if(a.suspend){a.suspend()}if(a.getRouter&&a.getRouter()){a.getRouter().stop()}}}c.getEventBus().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.restore=function(e){var s=e.body.sCacheId,n=b[s],a=n.oApp.getComponentInstance(),r=I[n.oApp.sId];l.disableCFLPUpdate=true;l.replaceHash("");l.replaceHash(e.body.sHash);l.disableCFLPUpdate=false;c.getEventBus().publish("launchpad","appOpening",{});n.oApp.setVisible(true);if(R[s]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(R[s])}if(O){O.setBackNavigation(w[s])}if(a){if(a.isKeepAliveSupported&&a.isKeepAliveSupported()===true){a.activate()}else{if(a.restore){a.restore()}if(a.getRouter&&a.getRouter()&&a.getRouter().initialize){if(r===false){a.getRouter().initialize()}else{a.getRouter().initialize(true)}}}P=this.cloneCurrentAppEntry(n)}c.getEventBus().publish("sap.ushell","appOpened",{});setTimeout(function(){t.sendMessageToOuterShell("sap.ushell.services.AppLifeCycle.setNewAppInfo",{info:n.oAppAttributes})},500);return Promise.resolve()};this.expandSapIntentParams=function(e){return new Promise(function(n,r){if(e.hasOwnProperty("sap-intent-param")){var i=e["sap-intent-param"];t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:i}).then(function(t){delete e["sap-intent-param"];var r=s({},e,new a("?"+t).query(true),true);n(r)},function(t){n(e)})}else{n(e)}})};this.addAppParamsToIntent=function(e,t){return m.expandSapIntentParams(new a(e).query(true)).then(function(e){return m.getApplicationParameters(e)})};this.getApplicationParameters=function(e){return new Promise(function(s){var n,r,i;function p(e,t){var s="";if(e&&e.length>0){s=(e.startsWith("?")?"":"?")+e}if(t&&t.length>0){s+=(s.length>0?"&":"?")+t}return s}if(e.hasOwnProperty("sap-startup-params")){n=new a("?"+e["sap-startup-params"]).query(true);if(n.hasOwnProperty("sap-intent-param")){r=n["sap-intent-param"];delete n["sap-intent-param"]}i=new a("?").query(n).toString();if(r){t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:r}).then(function(e){s(p(i,e))},function(e){s(p(i))})}else{s(p(i))}}else{s("")}})};this.getAppInfo=function(e,t,s){return new Promise(function(n){if(s){m.addAppParamsToIntent(t,s).then(function(e){if(e.length>0){e=new a(e).removeSearch("sap-remote-system").removeSearch("sap-ushell-defaultedParameterNames").toString()}sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(t){t.resolveHashFragmentLocal("#"+s+e).done(function(t){var a=f.parseShellHash("#"+s+e);n({oResolvedHashFragment:t,oParsedHash:a})}).fail(function(e){})})})}else{var r=function(){v.getAppInfo(e,t).then(function(t){m.addAppInfoToCache(e,t);n({oResolvedHashFragment:t})})};if(C===true&&y[e]){n({oResolvedHashFragment:JSON.parse(JSON.stringify(y[e]))})}else if(v){r()}else{sap.ui.require([A.replace(/\./g,"/")],function(e){v=e;r()})}}})};this.addAppInfoToCache=function(e,t){if(e&&t&&C===true&&y[e]===undefined){y[e]=JSON.parse(JSON.stringify(t))}};this.setCurrentApp=function(e,t,s){this.resetCurrentApp();P.oApp=e;P.sAppIntent=t;P.ui5ComponentName=s;if(P.oApp){I[P.oApp.sId]=true}};this.setCurrentAppAttributes=function(e){P.oAppAttributes=e};this.resetCurrentApp=function(){P={oApp:undefined,sAppIntent:undefined,ui5ComponentName:undefined,oAppAttributes:{}}};this.cloneCurrentAppEntry=function(e){return{oApp:e.oApp,sAppIntent:e.sAppIntent,ui5ComponentName:e.ui5ComponentName,oAppAttributes:e.oAppAttributes}};this.setShellUIService=function(e){O=e};this.setShellNavigationService=function(e){F=e};this.checkDataLossAndContinue=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag(F.getNavigationContext())){if(window.confirm(H)){sap.ushell.Container.setDirtyFlag(false);return true}else{return false}}return true}}return new m},true);
//# sourceMappingURL=AppLifeCycleAgent.js.map