//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/f/GridContainerItemLayoutData","sap/m/library","sap/ui/core/Component","sap/ui/core/Configuration","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/integration/ActionDefinition","sap/ushell/components/workPageBuilder/controller/WorkPageHost","sap/ui/integration/widgets/Card","sap/ui/model/json/JSONModel","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/utilsCdm","sap/ushell/services/_VisualizationInstantiation/VizInstanceCdm","sap/ushell/utils","sap/ushell/components/workPageBuilder/controller/WorkPageBuilder.accessibility","sap/ushell/components/workPageBuilder/controller/WorkPageBuilder.layout","sap/ui/integration/library","sap/ushell/EventHub"],function(e,t,i,r,o,n,a,s,d,l,g,u,c,h,p,v,f,C,P,m,w,D,y,_,M){"use strict";var E=g.ValueState;var b=["PR","CO","PG"];var V=6;var z=24;var k=2;var x=4;var W=o.LoadState;var B=g.InvisibleMessageMode;var R=_.CardPreviewMode;return u.extend("sap.ushell.components.workPageBuilder.controller.WorkPageBuilder",{onInit:function(){var e=this.byId("workPage");this._fnDeleteRowHandler=this.deleteRow.bind(this);this._fnDeleteCellHandler=this.deleteCell.bind(this);this._fnSaveCardConfiguration=this._onSaveCardEditor.bind(this);this._fnResetCardConfiguration=this._onResetCardConfigurations.bind(this);this.oModel=new v({maxColumns:x,editMode:false,previewMode:false,loaded:false,navigationDisabled:false,showFooter:false,showPageTitle:true,data:{workPage:null,visualizations:[],usedVisualizations:[]}});this.oModel.setSizeLimit(Infinity);this._saveHost();e.bindElement({path:"/data/workPage"});this.oWorkPageBuilderAccessibility=new D;return this.getOwnerComponent().getVizInstantiationPromise().then(function(t){this._oVizInstantiationService=t;this.getView().setModel(this.oModel);y.register(e);this.getView().setModel(y.getModel(),"viewSettings")}.bind(this))},onExit:function(){y.deregister();if(this.oContentFinderPromise){this.oContentFinderPromise.then(e=>{e.destroy()})}if(this.oCardEditorDialogPromise){this.oCardEditorDialogPromise.then(e=>{e.destroy()})}if(this.oCardResetDialogPromise){this.oCardResetDialogPromise.then(e=>{e.destroy()})}if(this.oDeleteCell){this.oDeleteCell.then(e=>{e.destroy()})}if(this.oLoadDeleteDialog){this.oLoadDeleteDialog.then(e=>{e.destroy()})}},onGridContainerBorderReached:function(e){var t=this.byId("workPage");this.oWorkPageBuilderAccessibility._handleBorderReached(e,t)},onAddColumn:function(e){var t=this.getView().getModel();var i=e.getSource();var r=i.getParent();var o=r.indexOfAggregation("columns",i);var n=r.getBindingContext().getPath();var a=n+"/columns/";var s=i.getBindingContext().getPath()+"/descriptor/value/columnWidth";var d=t.getProperty(a);var l=d.length;var g=e.getParameter("left");if(l>=x){return}var u=i.getProperty("columnWidth");var c=Math.floor(u/2)>=V?Math.floor(u/2):V;var h=c%2;t.setProperty(s,c+h);var p=r.indexOfAggregation("columns",i)+(g===true?0:1);var v=this._createEmptyColumn(c-h);var f=[d.slice(0,p),v,d.slice(p)].flat();var C=f.reduce(function(e,t){return e+this._getColumnWidth(t)}.bind(this),0);if(C>z){this._calculateColWidths(f,o,C)}t.setProperty(a,f);this.getOwnerComponent().fireEvent("workPageEdited")},focusFirstItem:function(e){var t=e.getSource();this.oWorkPageBuilderAccessibility.focusFirstItem(t)},setEditMode:function(e){this.oModel.setProperty("/editMode",!!e)},setPreviewMode:function(e){this.oModel.setProperty("/previewMode",!!e)},getPreviewMode:function(){return this.oModel.getProperty("/previewMode")},getEditMode:function(){return this.oModel.getProperty("/editMode")},setShowFooter:function(e){this.oModel.setProperty("/showFooter",!!e)},setShowPageTitle:function(e){this.oModel.setProperty("/showPageTitle",!!e)},setPageData:function(e){var i={};var r=t.get("workPage.usedVisualizations.nodes",e);var o=t.get("workPage.contents",e);if(r&&r.length>0){i=r.reduce(function(e,t){e[t.id]=t;return e},{})}this.oModel.setProperty("/data/usedVisualizations",i);this.oModel.setProperty("/data/workPage",o);this.oModel.setProperty("/loaded",true)},getPageData:function(){var e=this.oModel.getProperty("/data/usedVisualizations")||{};return{workPage:{contents:this.oModel.getProperty("/data/workPage"),usedVisualizations:{nodes:Object.values(e)}}}},setVisualizationData:function(e){return this.oContentFinderPromise.then(function(t){t.setVisualizationData(e)})},setVisualizationDataPaginated:function(e){return this.oContentFinderPromise.then(function(t){t.setVisualizationDataPaginated(e)})},onGridColumnsChange:function(e){var t=e.getParameter("columns");var i=e.getSource();i.getWidgets().filter(function(e){return e.isA("sap.ui.integration.widgets.Card")}).forEach(function(e){e.setLayoutData(new r({columns:t,minRows:1}))})},onDeleteColumn:function(e){var t=this.getView().getModel();var i=e.getSource();var r=i.getColumnWidth();var o=i.getParent();var n=o.indexOfAggregation("columns",i);var a=o.getBindingContext().getPath();var s=a+"/columns/";var d=t.getProperty(s);var l=d.filter(function(e,t){return t!==n});var g=r/2;var u=n-1<0?n:n-1;while(g>0){var c=l[u];this._setColumnWidth(c,this._getColumnWidth(c)+k);u=++u>=l.length?0:u++;g--}t.setProperty(s,l);o.invalidate();this.getOwnerComponent().fireEvent("workPageEdited")},onAddFirstRow:function(){var e="/data/workPage/rows/";this.getView().getModel().setProperty(e,[this._createEmptyRow()]);this.getOwnerComponent().fireEvent("workPageEdited")},onAddRow:function(e){var t=this.getView().getModel();var i=e.getSource();var r=this.byId("workPage");var o="/data/workPage/rows/";var n=t.getProperty(o);var a=this._createEmptyRow();var s=r.indexOfAggregation("rows",i)+(e.getParameter("bottom")===true?1:0);var d=[n.slice(0,s),a,n.slice(s)].flat();t.setProperty(o,d);this.getOwnerComponent().fireEvent("workPageEdited")},onResize:function(e){var t=e.getParameter("posXDiff");var i=e.getSource();var r=i.getParent();var o=r.getSingleColumnWidth();if(o<=0){return}var n=a.getRTL();var s=t/o;if(s>-1&&s<1){return}var d=s<0?Math.floor(t/o):Math.ceil(t/o);var l=d>=0?"right":"left";var g=l==="right"?k:-k;var u=r.indexOfAggregation("columns",i);var c=u-1;var h=r.getColumnFlexValues();g=n?g:-g;if(!this._resizeAllowed(h.length,h[c],h[u],g)){return}h[c]-=g;h[u]+=g;r.setGridLayoutString(h);this._updateModelWithColumnWidths(r,c,u,h[c],h[u])},_resizeAllowed:function(e,t,i,r){var o=this.getView().getModel("viewSettings");var n=o.getProperty("/currentBreakpoint/columnMinFlex");if(t-r<n){return false}if(i+r<n){return false}var a=o.getProperty("/currentBreakpoint/maxColumnsPerRow");if(e>a){return false}return true},onResizeCompleted:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onDeleteCell:function(e){var t=e.getSource().getParent().getParent();var i=t.getWidgets();if(i?.[0]&&i.length===1&&i[0].isA("sap.ui.integration.widgets.Card")){return this.deleteCell(e,{cell:t,dialog:false})}if(!this.oDeleteCell){var r=this.getOwnerComponent().getRootControl();this.oDeleteCell=d.load({id:r.createId("cellDeleteDialog"),name:"sap.ushell.components.workPageBuilder.view.WorkPageCellDeleteDialog",controller:this}).then(function(e){e.setModel(this.getView().getModel("i18n"),"i18n");return e}.bind(this))}return this.oDeleteCell.then(function(e){e.getBeginButton().detachEvent("press",this._fnDeleteCellHandler);e.getBeginButton().attachEvent("press",{cell:t,dialog:true},this._fnDeleteCellHandler);e.open()}.bind(this))},deleteCell:function(e,t){var i=t.cell;var r=this.getView().getModel();var o=i.getParent();var n=o.indexOfAggregation("cells",i);var a=o.getBindingContext().getPath()+"/cells";var s=r.getProperty(a);var d=s.filter(function(e,t){return t!==n});r.setProperty(a,d);this.getOwnerComponent().fireEvent("workPageEdited");if(t.dialog){return this.oDeleteCell.then(function(e){e.close()})}return Promise.resolve()},_deleteVisualization:function(e){var t=e.getParent().getParent();var i=e.getBindingContext();var r=i.getPath();var o=this.getView().getModel();var n=r.substring(0,r.lastIndexOf("/"));var a=t.indexOfAggregation("widgets",e);var s=o.getProperty(n);var d=s.filter(function(e,t){return t!==a});o.setProperty(n,d);this.getOwnerComponent().fireEvent("workPageEdited")},onEditTitle:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onWidgetAdded:function(){this.getOwnerComponent().fireEvent("workPageEdited")},_getWidgetGroups:function(){var e=this.getView().getModel("i18n").getResourceBundle();var t=[{id:"applicationWidgets",widgets:[{id:"widgets-tiles",title:e.getText("ContentFinder.Widgets.Tiles.Title"),description:e.getText("ContentFinder.Widgets.Tiles.Description"),icon:"sap-icon://header",target:"appSearch_tiles"},{id:"widgets-cards",title:e.getText("ContentFinder.Widgets.Cards.Title"),description:e.getText("ContentFinder.Widgets.Cards.Description"),icon:"sap-icon://card",target:"appSearch_cards"}]}];return t},createContentFinderComponent:function(){this.oContentFinderPromise=n.create({id:this.getOwnerComponent().createId("workPageContentFinder"),name:"sap.ushell.components.contentFinder"});return this.oContentFinderPromise},openWidgetGallery:function(e){var t=e.getSource();if(!this.oContentFinderPromise){this.oContentFinderPromise=this.createContentFinderComponent()}return this.oContentFinderPromise.then(function(e){e.setWidgetGroups(this._getWidgetGroups());e.attachVisualizationsAdded(t,this._onAddVisualization,this);e.attachVisualizationFilterApplied(t,function(e){this.getOwnerComponent().fireEvent("visualizationFilterApplied",e.getParameters())},this);e.show("widgetGallery")}.bind(this))},openTilesAppSearch:function(e){var t=e.getSource().getParent().getParent();if(!this.oContentFinderPromise){this.oContentFinderPromise=this.createContentFinderComponent()}return this.oContentFinderPromise.then(function(e){e.setContextData({restrictedVisualizations:this._getRestrictedVisualizationIds(t)});e.setRestrictedMode(true);e.attachVisualizationsAdded(t,this._onAddVisualization,this);e.attachVisualizationFilterApplied(t,function(e){this.getOwnerComponent().fireEvent("visualizationFilterApplied",e.getParameters())},this);e.show("appSearch_tiles")}.bind(this))},_getRestrictedVisualizationIds:function(e){return e.getWidgets().map(function(e){if(e.isA("sap.ushell.ui.launchpad.VizInstanceCdm")){return e.getProperty("vizRefId")}})},_onAddVisualization:function(e,t){const i=this.getView().getModel();var r=e.getParameter("visualizations");if(r.length>0){r.forEach(function(e){var t="/data/usedVisualizations/"+e.id;if(!i.getProperty(t)){i.setProperty(t,e.vizData)}});var o=this._instantiateWidgetData(r);if(t.isA("sap.ushell.components.workPageBuilder.controls.WorkPageCell")){this._setCellData(t,o)}if(t.isA("sap.ushell.components.workPageBuilder.controls.WorkPageColumn")){this._setColumnData(t,o)}}},_instantiateWidgetData:function(e){var t=[];var i;return e.map(function(e){i=this._generateUniqueId(t);t=t.concat([i]);return{id:i,visualization:{id:e.vizData.id}}}.bind(this))},_setCellData:function(e,t){const i=this.getView().getModel();var r=e.getBindingContext().getPath();var o=Object.assign({},i.getProperty(r));o.widgets=o.widgets.concat(t);i.setProperty(r,o);this.onWidgetAdded()},_setColumnData:function(e,t,i){const r=this.getView().getModel();let o=e.getBindingContext().getPath();let n=Object.assign({},r.getProperty(o));let a={id:this._generateUniqueId(),descriptor:{value:{},schemaVersion:"3.2.0"},widgets:t.concat([])};if(!n.cells){n.cells=[]}if(i===undefined||i>n.cells.length){i=n.cells.length}let s=n.cells.concat([]);s.splice(i,0,a);n.cells=s;r.setProperty(o,n);this.onWidgetAdded()},onDeleteRow:function(e){var t=this.getOwnerComponent().getRootControl();var i=e.getSource().getBindingContext();if(!this.oLoadDeleteDialog){this.oLoadDeleteDialog=d.load({id:t.createId("rowDeleteDialog"),name:"sap.ushell.components.workPageBuilder.view.WorkPageRowDeleteDialog",controller:this}).then(function(e){e.setModel(this.getView().getModel("i18n"),"i18n");return e}.bind(this))}return this.oLoadDeleteDialog.then(function(e){e.getBeginButton().detachEvent("press",this._fnDeleteRowHandler);e.getBeginButton().attachEvent("press",{rowContext:i},this._fnDeleteRowHandler);e.open()}.bind(this))},deleteRow:function(e,t){var i=this.getView().getModel();var r=t.rowContext;var o=i.getProperty("/data/workPage/rows");var n=r.getObject();var a=o.filter(function(e){return e.id!==n.id});i.setProperty("/data/workPage/rows",a);this.getOwnerComponent().fireEvent("workPageEdited");return this.oLoadDeleteDialog.then(function(e){e.close()})},onRowDeleteCancel:function(){return this.oLoadDeleteDialog.then(function(e){e.close()})},onCellDeleteCancel:function(){return this.oDeleteCell.then(function(e){e.close()})},_createErrorTile:function(){return new m({state:W.Failed}).attachPress(this.onVisualizationPress,this).bindEditable("/editMode").bindSizeBehavior("viewSettings>/currentBreakpoint/sizeBehavior").setLayoutData(new r({columns:2,rows:2}))},widgetFactory:function(t,i){var r=i.getProperty("visualization/id");if(!r){e.error("No vizId found in widget context.");return this._createErrorTile()}var o=this.getView().getModel().getProperty("/data/usedVisualizations/"+r);if(!o||!o.type){e.error("No viz or vizType found for vizId "+r);return this._createErrorTile()}var n=i.getProperty("configurations")||[];var a=o.configurations||[];var s=this._getMergedAndSortedConfigurations(n,a);var d=i.getPath();switch(o.type){case"sap.card":return this._createCard(o,n,s,d);case"sap.ushell.StaticAppLauncher":case"sap.ushell.DynamicAppLauncher":return this._createVizInstance(o);default:e.error("Unknown type for widget "+o.type);return this._createErrorTile()}},_getMergedAndSortedConfigurations:function(e,t){if(e.length===0&&t.length===0){return[]}var r=b.reduce(function(r,o){var n=e.find(function(e){return e.level===o});var a=t.find(function(e){return e.level===o});var s=i({},a,n);if(Object.keys(s).length>0){r[o]=s}return r},{});return this._sortConfigurations(Object.values(r))},_sortConfigurations:function(e){var t=e&&e.sort(function(e,t){return b.indexOf(e.level)-b.indexOf(t.level)});return t.map(function(e){return e.settings.value})},_createVizInstance:function(i){var o=t.get(["descriptor","value","sap.flp","indicatorDataSource"],i);var n=t.get(["descriptor","value","sap.flp","target","appId"],i);var a=this.getOwnerComponent().getSiteApplication(n);var s=t.get(["sap.app","dataSources"],a);var d=this.getOwnerComponent().getSiteVizType(i.type);var l={};l[n]=a;var g={id:i.id,title:t.get(["descriptor","value","sap.app","title"],i),subtitle:t.get(["descriptor","value","sap.app","subTitle"],i),info:t.get(["descriptor","value","sap.app","info"],i),icon:t.get(["descriptor","value","sap.ui","icons","icon"],i),keywords:t.get(["descriptor","value","sap.app","tags","keywords"],i)||[],_instantiationData:{platform:"CDM",vizType:d},indicatorDataSource:o,vizType:t.get("type",i),dataSource:this._getDataSource(s,o),contentProviderId:t.get(["sap.app","contentProviderId"],a),vizConfig:t.get(["descriptor","value"],i),supportedDisplayFormats:t.get(["descriptor","value","sap.flp","vizOptions","displayFormats","supported"],i),displayFormatHint:t.get(["descriptor","value","sap.flp","vizOptions","displayFormats","default"],i),numberUnit:t.get(["descriptor","value","sap.flp","numberUnit"],i),vizId:i.id,preview:this.oModel.getProperty("/previewMode")};if(!this.oModel.getProperty("/navigationDisabled")){g.target=f.harmonizeTarget(C.getTarget(g)||{});g.targetURL=P.toHashFromVizData(g,l)}var u=this._oVizInstantiationService.instantiateVisualization(g);if(!u){e.error("No VizInstance was created.");return this._createErrorTile()}return u.setActive(true).bindPreview("/previewMode").attachPress(this.onVisualizationPress,this).bindEditable("/editMode").bindSizeBehavior("viewSettings>/currentBreakpoint/sizeBehavior").bindClickable({path:"/navigationDisabled",formatter:function(e){return!e}}).setLayoutData(new r(u.getLayout()))},_getDataSource:function(e,t){if(!t||!e){return}return e[t.dataSource]},onVisualizationPress:function(e){var t=e.getParameter("scope");var i=e.getParameter("action");if(t==="Actions"&&i==="Remove"){this._deleteVisualization(e.getSource())}},_createCard:function(i={},o=[],n=[],a=""){var s={};var d=i.descriptor&&i.descriptor.value&&i.descriptor.value["sap.card"];var l=i.descriptorResources&&(i.descriptorResources.baseUrl||i.descriptorResources.descriptorPath);var g=o.some(function(e){return e.level==="PG"});var u;if(!d&&!l){e.error("No descriptor or descriptorResources for Card");return(new p).setLayoutData(new r({columns:2,rows:2}))}if(d){s.manifest=i.descriptor.value;u=!!t.get(["descriptor","value","sap.card","configuration"],i);if(l){s.baseUrl=i.descriptorResources.baseUrl+i.descriptorResources.descriptorPath}}else if(l){s.manifest=i.descriptorResources.baseUrl+i.descriptorResources.descriptorPath;if(!s.manifest.endsWith(".json")){s.manifest+="/manifest.json"}}s.referenceId="";if(i.id){var c=i.id.indexOf("_");if(c>0){var h=i.id.substring(0,c);s.referenceId=h}}if(s.baseUrl&&s.baseUrl.substr(-1)!=="/"){s.baseUrl+="/"}var v=new p(s);if(u){var f=this._createCardConfigurationActionDefinition(v,a,this._openCardConfigurationEditor.bind(this));v.addActionDefinition(f)}if(g){var C=this._createCardResetActionDefinition(o,a,this._openResetCardConfigurationDialog.bind(this));v.addActionDefinition(C)}return v.setModel(this.oModel,"workPageModel").bindProperty("previewMode",{path:"workPageModel>/previewMode",formatter:function(e){return e?R.MockData:R.Off}}).setManifestChanges(n).addStyleClass("workpageCellWidget").setHost(this.oHost).setLayoutData(new r({columns:16,minRows:1}))},_createCardConfigurationActionDefinition:function(e,t,i){const r=this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Card.ActionDefinition.Configure");const o=new c({type:"Custom",visible:"{/editMode}",buttonType:"Transparent",text:r});o.setModel(this.oModel);o.attachPress({card:e,widgetContextPath:t},i);return o},_createCardResetActionDefinition:function(e,t,i){const r=this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Card.ActionDefinition.Reset");const o=new c({type:"Custom",visible:"{/editMode}",buttonType:"Transparent",text:r});o.setModel(this.oModel);o.attachPress({widgetContextPath:t,widgetConfigurations:e},i);return o},_openCardConfigurationEditor:function(e,t){if(!this.oCardEditorDialogPromise){this.oCardEditorDialogPromise=this._createCardEditorDialog(t.card)}var i=this._createCardEditor(t.card);return Promise.all([i,this.oCardEditorDialogPromise]).then(function(e){this.oCardEditorDialog=e[1];this.oCardEditorDialog.removeAllContent();this.oCardEditorDialog.getBeginButton().detachPress(this._fnSaveCardConfiguration).attachPress(t.widgetContextPath,this._fnSaveCardConfiguration);this._setCardDialogTitle(this.oCardEditorDialog,t.card);this.oCardEditorDialog.addContent(e[0]);this.oCardEditorDialog.open()}.bind(this))},_openResetCardConfigurationDialog:function(e,t){if(!this.oCardResetDialogPromise){this.oCardResetDialogPromise=this._createResetCardConfigurationDialog()}return this.oCardResetDialogPromise.then(function(e){this.oCardResetDialog=e;this.getView().addDependent(this.oCardResetDialog);this.oCardResetDialog.getBeginButton().detachPress(this._fnResetCardConfiguration).attachPress(t,this._fnResetCardConfiguration);this.oCardResetDialog.open()}.bind(this))},_onResetCardConfigurations:function(e,t){var i=e.getSource().getParent();var r=t.widgetConfigurations;var o=t.widgetContextPath+"/configurations";var n=r.filter(function(e){return e.level!=="PG"});this.oModel.setProperty(o,n);this.getOwnerComponent().fireEvent("workPageEdited");i.close()},_createResetCardConfigurationDialog:function(){var e=this.getView().getModel("i18n").getResourceBundle();var t=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Title");var i=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Content");var r=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Accept");var n=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Deny");return new Promise((e,a)=>{sap.ui.require(["sap/m/Dialog","sap/m/Button","sap/m/Text"],(a,s,d)=>{var l=new a({id:this.createId("cardConfigurationResetDialog"),type:o.DialogType.Message,state:E.Warning,title:t,content:new d({text:i}),beginButton:new s({type:o.ButtonType.Emphasized,text:r}),endButton:new s({text:n,press:function(){l.close()}})});e(l)},a)})},_setCardDialogTitle:function(e,t){var i=this.getView().getModel("i18n").getResourceBundle();var r=this._getCardTitle(t)?i.getText("WorkPage.CardEditor.Title",[this._getCardTitle(t)]):i.getText("WorkPage.CardEditor.Title.NoCardTitle");e.setTitle(r)},_createCardEditor:function(e){return new Promise((t,i)=>{sap.ui.require(["sap-ui-integration-card-editor"],()=>{sap.ui.require(["sap/ui/integration/designtime/editor/CardEditor"],i=>{t(new i({previewPosition:"right",card:e,mode:"content"}))},i)},i)})},_createCardEditorDialog:function(e){var t=this.getView().getModel("i18n").getResourceBundle();var i=t.getText("WorkPage.CardEditor.Save");var r=t.getText("WorkPage.CardEditor.Cancel");return new Promise((e,t)=>{sap.ui.require(["sap/m/Dialog","sap/m/Button"],(t,n)=>{var a=new t({id:this.createId("cardEditorDialog"),contentWidth:"40rem",beginButton:new n({text:i,type:o.ButtonType.Emphasized}),endButton:new n({text:r,press:function(){a.close()}})});e(a)},t)})},_getCardTitle:function(e){if(e.getCardHeader()&&e.getCardHeader().getTitle()){return e.getCardHeader().getTitle()}},_onSaveCardEditor:function(e,t){var r=e.getSource().getParent();var o=r.getContent()[0];var n=o.getCard();var a=t+"/configurations";var s=o.getCurrentSettings();var d=this.oModel.getProperty(a)||[];var l=d.find(function(e){return e.level==="PG"});if(!l){l={};l.id=this._generateUniqueId();l.level="PG";l.settings={value:s,schemaVersion:"3.2.0"};d.push(l)}else{d=d.map(function(e){if(e.level==="PG"){e.settings.value=i({},e.settings.value,s)}return e})}this.oModel.setProperty(a,d);n.setManifestChanges([s]);this.getOwnerComponent().fireEvent("workPageEdited");r.close()},executeNavigation:function(e){var t=e.getParameter("parameters"),i=e.getParameter("card");if(e.getParameter("type")!=="Navigation"||this.oModel.getProperty("/navigationDisabled")){return Promise.resolve()}if(t&&t.hasOwnProperty("url")){M.emit("UITracer.trace",{reason:"LaunchApp",source:"Card",data:{cardId:i.getManifestEntry("/sap.app/id"),providerId:i.getReferenceId(),targetUrl:t.url}});return Promise.resolve()}e.preventDefault(true);return this.getOwnerComponent().getUshellContainer().getServiceAsync("Navigation").then(function(e){var r={};if(t.hasOwnProperty("ibnTarget")){r.target=t.ibnTarget}if(t.hasOwnProperty("ibnParams")){r.params=t.ibnParams}if(t.hasOwnProperty("ibnAppSpecificRoute")){r.appSpecificRoute=t.ibnAppSpecificRoute}M.emit("UITracer.trace",{reason:"LaunchApp",source:"Card",data:{cardId:i.getManifestEntry("/sap.app/id"),providerId:i.getReferenceId(),targetUrl:"#"+r.target.semanticObject+"-"+r.target.action}});return e.navigate(r)})},saveEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:true})},cancelEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:false})},onCellDrop:function(e){var t=e.getParameter("draggedControl");var i=e.getParameter("droppedControl");var r=e.getParameter("dropPosition");var o=t.getParent();var n=i.getParent();var a=o.indexOfAggregation("cells",t);var s=n.indexOfAggregation("cells",i);if(r==="After"){s++}this._moveCell(o,n,a,s)},onCellDropOnEmptyColumn:function(e){var t=e.getParameter("draggedControl");var i=e.getParameter("droppedControl");var r=t.getParent();var o=r.indexOfAggregation("cells",t);var n=0;this._moveCell(r,i,o,n)},onVisualizationDropBetweenCells:function(e){const t=e.getParameter("draggedControl");const i=e.getParameter("droppedControl");const r=e.getParameter("dropPosition");const o=t.getParent().getParent();const n=i.getParent();let a=n.indexOfAggregation("cells",i);if(r==="After"){a++}this._moveVisualizationToCellOrColumn(t,o,n,a)},onVisualizationDropOnCell:function(e){const t=e.getParameter("draggedControl");const i=e.getParameter("droppedControl");const r=t.getParent().getParent();const o=0;this._moveVisualizationToCellOrColumn(t,r,i,o)},onVisualizationDropOnEmptyWidgetContainer:function(e){const t=e.getParameter("draggedControl");const i=e.getParameter("droppedControl");const r=t.getParent().getParent();this._moveVisualizationToCellOrColumn(t,r,i)},_moveVisualizationToCellOrColumn:function(e,t,i,r){const o=this.getView().getModel();const n=t.getBindingContext().getPath()+"/widgets";const a=o.getProperty(n);const s=t.indexOfAggregation("widgets",e);const d=e.getBindingContext().getPath();const g=o.getProperty(d);a.splice(s,1);const u=[].concat(a);o.setProperty(n,u);if(i.isA("sap.ushell.components.workPageBuilder.controls.WorkPageCell")){this._setCellData(i,[g])}else if(i.isA("sap.ushell.components.workPageBuilder.controls.WorkPageColumn")){this._setColumnData(i,[g],r)}l.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),B.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},_moveCell:function(e,t,i,r){var o=this.getView().getModel();var n=t.getId()===e.getId();var a=e.getBindingContext().getPath()+"/cells";var s=t.getBindingContext().getPath()+"/cells";var d=o.getProperty(a);var g=o.getProperty(s);if(n){if(i<r){r--}if(i===r){return}}var u=d.filter(function(e,t){return t!==i});if(n){g=u}var c=[g.slice(0,r),d[i],g.slice(r)].flat();o.setProperty(a,u);o.setProperty(s,c);l.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),B.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},onWidgetOnCellDrop:function(e){var t=e.getParameter("draggedControl");var i=t.getParent().getParent();var r=e.getParameter("droppedControl");var o=i.indexOfAggregation("widgets",t);var n=r.getBindingContext().getProperty("widgets").length;this._moveVisualization(i,r,o,n)},onWidgetOnCellDragEnter:function(e,t){let i=e.getParameter("target");let r=!!i.getBindingContext().getProperty("widgets").length;if(i.getTileMode()&&r||t===r){e.preventDefault()}},onGridDrop:function(e){var t=e.getSource();var i=e.getParameter("draggedControl");var r=e.getParameter("droppedControl");var o=e.getParameter("dropPosition");var n=i.getParent().getParent();var a=n.indexOfAggregation("widgets",i);var s=t.indexOfAggregation("widgets",r);var d=t.getId()===n.getId();if(o==="After"){s++}if(d){if(a<s){s--}if(a===s){return}}this._moveVisualization(n,t,a,s)},_moveVisualization:function(e,t,i,r){var o=this.getView().getModel();var n=e.getBindingContext().getPath()+"/widgets";var a=t.getBindingContext().getPath()+"/widgets";var s=n===a;var d=o.getProperty(n);var g=o.getProperty(a);var u=d[i];var c=d.filter(function(e,t){return t!==i});if(s){g=c}var h=[g.slice(0,r),u,g.slice(r)].flat();o.setProperty(n,c);o.setProperty(a,h);l.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),B.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},tileMode:function(e){var i=this.getView().getModel();var r;return!!e&&(e.length>1||!e.some(function(e){r=i.getProperty("/data/usedVisualizations/"+t.get("visualization.id",e));return t.get("type",r)==="sap.card"}))},showAppSearchButton:function(e,t){return this.tileMode(e)&&t},_updateModelWithColumnWidths:function(e,t,i,r,o){var n=this.getView().getModel();var a=e.getBindingContext();var s=a.getPath();var d=s+"/columns/"+t+"/descriptor/value/columnWidth";var l=s+"/columns/"+i+"/descriptor/value/columnWidth";n.setProperty(d,r);n.setProperty(l,o)},_getColumnWidth:function(e){return t.get("descriptor.value.columnWidth",e)||z},_setColumnWidth:function(e,i){t.set("descriptor.value.columnWidth",i,e)},_calculateColWidths:function(e,t,i){var r=e[t];if(this._getColumnWidth(r)-k>=V){this._setColumnWidth(r,this._getColumnWidth(r)-k);i=i-k}if(i>z){var o=t-1>=0?t-1:e.length-1;this._calculateColWidths(e,o,i)}return e},_createEmptyColumn:function(e){return{id:this._generateUniqueId(),descriptor:{value:{columnWidth:e},schemaVersion:"3.2.0"},configurations:[],cells:[]}},_createEmptyRow:function(){return{id:this._generateUniqueId(),descriptor:{value:{title:"",description:"this is not yet rendered"},schemaVersion:"3.2.0"},columns:[this._createEmptyColumn(z)]}},_saveHost:function(){this.oHost=s.byId("sap.shell.host.environment");if(!this.oHost){this.oHost=new h("sap.shell.host.environment",{action:this.executeNavigation.bind(this)});this.oHost.setModel(this.getView().getModel("i18n"),"i18n")}},getNavigationDisabled:function(){return this.oModel.getProperty("/navigationDisabled")},setNavigationDisabled:function(e){this.oModel.setProperty("/navigationDisabled",e)},_generateUniqueId:function(e){var t=(e||[]).concat([]);var i=this.oModel.getProperty("/data/workPage");var r=this._collectIds.bind(this);t=t.concat(r(i));(i.rows||[]).forEach(function(e){t=t.concat(r(e));(e.columns||[]).forEach(function(e){t=t.concat(r(e));(e.cells||[]).forEach(function(e){t=t.concat(r(e));(e.widgets||[]).forEach(function(e){t=t.concat(r(e))})})})});t=t.filter(function(e){return!!e});return w.generateUniqueId(t)},_collectIds:function(e){var t=[e.id];var i=e.configurations||[];var r=i.map(function(e){return e.id});return t.concat(r)}})});
//# sourceMappingURL=WorkPageBuilder.controller.js.map