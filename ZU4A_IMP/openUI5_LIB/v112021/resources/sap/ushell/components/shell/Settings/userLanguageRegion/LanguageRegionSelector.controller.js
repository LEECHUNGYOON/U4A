// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Configuration","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ushell/Config"],function(e,t,r,a,n,i,s,g,o){"use strict";return i.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.oUserInfoServicePromise=sap.ushell.Container.getServiceAsync("UserInfo");this.oUserInfoServicePromise.then(function(e){this.oUser=sap.ushell.Container.getUser();var r=t.getFormatSettings().getFormatLocale();var i=a.getInstance(r);var g,l,u,m,c;var d=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var L=this.oUser.isLanguagePersonalized();var h=e.getUserSettingListEditSupported();var f=[];if(h){var p=t.getFormatSettings();g=p.getLegacyDateFormat();u=p.getLegacyTimeFormat();m=this._getLegacyNumberFormat(p);c=this.oUser.getCalendarWeekNumbering?.()||"Default";f.push(this._loadUserSettingList())}else{g=i.getDatePattern("medium");l=i.getTimePattern("medium");u=l.indexOf("H")===-1?"12h":"24h";c="Default"}var P=new s({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,CalendarWeekNumberingList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:g,selectedTimeFormat:u,selectedNumberFormat:m,selectedTimeZone:this.oUser.getTimeZone(),selectedCalendarWeekNumbering:c,isSettingsLoaded:true,isLanguagePersonalized:L,isEnableSetLanguage:d,isEnableUserProfileSetting:h,isTimeZoneFromServerInUI5:o.last("/core/ui5/timeZoneFromServerInUI5")});P.setSizeLimit(1e3);if(d){f.push(this._loadLanguagesList())}if(f.length>0){this.getView().setBusy(true);return Promise.all(f).then(function(t){var r=h?t[0]:null;var a=null;if(d){a=t.length===1?t[0]:t[1]}if(a?.length>1){P.setProperty("/languageList",a);var i=a.some(function(e){return e.key==="default"});if(!L&&i){P.setProperty("/selectedLanguage","default")}}if(r?.TIME_FORMAT?.length>0){P.setProperty("/TimeFormatList",r.TIME_FORMAT)}if(r?.DATE_FORMAT?.length>0){P.setProperty("/DateFormatList",r.DATE_FORMAT)}if(r?.TIME_ZONE?.length>0){var s=n.getDateTimeWithTimezoneInstance({showDate:false,showTime:false});var g=r.TIME_ZONE.map(function(e){var t=s.format(null,e.description)||e.description;return{description:t,value:e.value}});P.setProperty("/TimeZoneList",g)}if(r?.NUMBER_FORMAT?.length>0){P.setProperty("/NumberFormatList",r.NUMBER_FORMAT)}if(r?.CALENDAR_WEEK_NUMBERING){var o=e.getCalendarWeekNumberingList().map(e=>{e.selected=e.value===P.getProperty("/selectedCalendarWeekNumbering");return e});P.setProperty("/CalendarWeekNumberingList",o)}this.oView.setModel(P);this.getView().setBusy(false)}.bind(this))}this.oView.setModel(P)}.bind(this))},_loadLanguagesList:function(){g.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return this.oUserInfoServicePromise.then(function(t){return new Promise(function(r){g.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");t.getLanguageList().done(function(e){g.end("FLP:LanguageRegionSelector._getLanguagesList");r(e)}).fail(function(t){g.end("FLP:LanguageRegionSelector._getLanguagesList");e.error("Failed to load language list.",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");r(null)})})})},_loadUserSettingList:function(){g.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(t){g.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");e.getUserSettingList().then(function(e){g.end("FLP:LanguageRegionSelector._loadUserSettingList");t(e)})})})},_resetLanguage:function(){var e=this.oUser.getLanguage(),t=this.getView().getModel(),r=t.getData();var a=r.isLanguagePersonalized?e:"default";t.setProperty("/selectedLanguage",a);this._updateTextFields(e)},onCancel:function(){var e=this.getView().getModel(),t=e.getData(),r=t.languageList,a=t.isEnableSetLanguage;if(a&&r){this._resetLanguage()}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}},onSaveSuccess:function(t,r,a){var n={refresh:true};t.resetChangedProperty("dateFormat");t.resetChangedProperty("timeFormat");t.resetChangedProperty("numberFormat");t.resetChangedProperty("timeZone");t.resetChangedProperty("calendarWeekNumbering");if(r){e.debug("[000] onSaveSuccess: oUser.resetChangedPropertyLanguage:","LanguageRegionSelector.controller");t.resetChangedProperty("language");n.obsoleteUrlParams=["sap-language"]}return n},onSave:function(r){var a=this.oUser,n=this.getView().getModel().getData(),i=n.selectedLanguage,s=a.getLanguage(),g=i&&i!==(n.isLanguagePersonalized?s:"default"),o=n.isEnableUserProfileSetting,l=n.isEnableSetLanguage&&n.languageList&&g,u=false,m=["DATE_FORMAT","TIME_FORMAT","NUMBER_FORMAT","TIME_ZONE","LANGUAGE","CALENDAR_WEEK_NUMBERING"];e.debug("[000] LanguageRegionSelector:onSave:bUpdateLanguage, bIsEnableSetUserProfileSetting:",l,"LanguageRegionSelector.controller");if(l){e.debug("[000] LanguageRegionSelector:onSave:UserInfo: oUser.setLanguage:",i,"LanguageRegionSelector.controller");a.setLanguage(i)}else{this._resetLanguage()}if(o){var c=t.getFormatSettings();if(c.getLegacyDateFormat()!==n.selectedDatePattern){u=true;a.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},c.getLegacyDateFormat(),n.selectedDatePattern)}if(c.getLegacyTimeFormat()!==n.selectedTimeFormat){u=true;a.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},c.getLegacyTimeFormat(),n.selectedTimeFormat)}if(this._getLegacyNumberFormat(c)!==n.selectedNumberFormat){u=true;a.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},this._getLegacyNumberFormat(c),n.selectedNumberFormat)}if(!n.selectedTimeZone){this.getView().getModel().setProperty("/selectedTimeZone",this.oUser.getTimeZone())}else if(this.oUser.getTimeZone()!==n.selectedTimeZone){u=true;a.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),n.selectedTimeZone)}if(t.getCalendarWeekNumbering()!==n.selectedCalendarWeekNumbering){u=true;a.setChangedProperties({propertyName:"calendarWeekNumbering",name:"CALENDAR_WEEK_NUMBERING"},t.getCalendarWeekNumbering(),n.selectedCalendarWeekNumbering.trim());t.setCalendarWeekNumbering(n.selectedCalendarWeekNumbering)}}if(l||u){return r().then(function(){e.debug("[000] onSave:fnUpdateUserPreferences","LanguageRegionSelector.controller");return this.onSaveSuccess(a,l,i)}.bind(this)).catch(function(t){e.debug("[000] onSave:catch:errorMessage",t,"LanguageRegionSelector.controller");var r=m.some(function(e){return t.includes(e)});if(!r){return this.onSaveSuccess(a,l,i)}if(l){a.setLanguage(s);a.resetChangedProperty("language");this._updateTextFields(s)}a.resetChangedProperty("dateFormat");a.resetChangedProperty("timeFormat");a.resetChangedProperty("numberFormat");a.resetChangedProperty("timeZone");a.resetChangedProperty("calendarWeekNumbering");if(n.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}e.error("Failed to save Language and Region Settings",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");throw t}.bind(this))}return Promise.resolve()},_restoreUserSettingPreferenceValues:function(){var e=this.getView().getModel();var r=t.getFormatSettings();e.setProperty("/selectedDatePattern",r.getLegacyDateFormat());e.setProperty("/selectedTimeFormat",r.getLegacyTimeFormat());e.setProperty("/selectedNumberFormat",this._getLegacyNumberFormat(r));e.setProperty("/selectedTimeZone",this.oUser.getTimeZone());e.setProperty("/selectedCalendarWeekNumbering",t.getCalendarWeekNumbering());var a=e.getProperty("/CalendarWeekNumberingList").map(e=>{e.selected=e.value===t.getCalendarWeekNumbering();return e});e.setProperty("/CalendarWeekNumberingList",a)},_handleLanguageSelectChange:function(e){var t=e.getSource().getSelectedKey();if(t){this._updateTextFields(t)}},_updateTextFields:function(e){var n;if(e===this.oUser.getLanguage()){n=t.getFormatSettings().getFormatLocale()}else{n=new r(e)}var i=this.getView().getModel(),s=a.getInstance(n),g=s.getDatePattern("medium"),o=s.getTimePattern("medium"),l=o.indexOf("H")===-1?"12h":"24h";if(!i.getData().isEnableUserProfileSetting){i.setProperty("/selectedDatePattern",g);i.setProperty("/selectedTimeFormat",l)}},_getLegacyNumberFormat:function(e){var t=e.getLegacyNumberFormat();if(t){return t.trim()}},_handleCalendarWeekNumberingChange:function(e){var t=e.getSource().getSelectedItem().getCustomData()[0].getValue();this.getView().getModel().setProperty("/selectedCalendarWeekNumbering",t)}})});
//# sourceMappingURL=LanguageRegionSelector.controller.js.map