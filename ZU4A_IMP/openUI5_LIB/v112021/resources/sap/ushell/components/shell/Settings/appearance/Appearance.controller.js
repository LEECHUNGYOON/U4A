// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ui/core/Component","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/services/DarkModeSupport","sap/ushell/User","sap/ushell/utils"],function(e,t,o,r,n,s,i,a,l,jQuery,h,c,d,u,p,g){"use strict";var f=n.MessageType;function m(t){switch(t){case"sap_fiori_3":case"sap_fiori_3_dark":return"SAP Quartz";case"sap_horizon":case"sap_horizon_dark":return"SAP Horizon";case"sap_fiori_3_hcb":case"sap_fiori_3_hcw":return d.i18n.getText("AppearanceHighContrastTheme",["SAP Quartz"]);case"sap_horizon_hcb":case"sap_horizon_hcw":return d.i18n.getText("AppearanceHighContrastTheme",["SAP Horizon"]);default:e.error("Can not find common name for the theme",t);return t||""}}var v={base:"sapUshellBaseIconStyle",sap_bluecrystal:"sapUshellBlueCrystalIconStyle",sap_belize_hcb:"sapUshellHCBIconStyle sapUshellHCBIconStyleOnHCB",sap_belize_hcw:"sapUshellHCWIconStyle sapUshellHCWIconStyleOnHCW",sap_belize:"sapUshellBelizeIconStyle",sap_belize_plus:"sapUshellPlusIconStyle",sap_fiori_3_hcb:"sapUshellQuartzHCBIconStyle sapUshellHCBIconStyleOnHCB",sap_fiori_3_hcw:"sapUshellQuartzHCWIconStyle sapUshellHCWIconStyleOnHCW",sap_fiori_3:"sapUshellQuartzLightIconStyle",sap_fiori_3_dark:"sapUshellQuartzDarkIconStyle",sap_horizon_hcb:"sapUshellHorizonHCBIconStyle sapUshellHCBIconStyleOnHCB",sap_horizon_hcw:"sapUshellHorizonHCWIconStyle sapUshellHCWIconStyleOnHCW",sap_horizon:"sapUshellHorizonLightIconStyle",sap_horizon_dark:"sapUshellHorizonDarkIconStyle"};return i.extend("sap.ushell.components.shell.Settings.appearance.Appearance",{TILE_SIZE:{Small:0,Responsive:1,getName:function(e){return Object.keys(this)[e]}},onInit:function(){var e=this.getView();this.oUser=sap.ushell.Container.getUser();this.aThemeListFromServer=e.getViewData().themeList||[];this.oPersonalizers={};var t=d.getTranslationModel();e.setModel(t,"i18n");e.setModel(this.getConfigurationModel(),"config");r.attachThemeChanged(this._handleThemeApplied,this);this._oDarkModeModel=this.getDarkModeModel(this.aThemeListFromServer);e.setModel(this._oDarkModeModel,"darkMode");var o=this.oUser.getTheme();e.setModel(new l({options:this._getThemeListData(this.aThemeListFromServer,o),ariaTexts:{headerLabel:d.i18n.getText("Appearance")}}));return Promise.all([this._oConfigModelPromise,this._oDarkModeModelPromise])},onExit:function(){r.detachThemeChanged(this._handleThemeApplied,this)},_getSelectedTheme:function(){var e=this.getView().byId("themeList").getSelectedItem();var t=e?e.getBindingContext():null;return t?t.getProperty("id"):this.oUser.getTheme()},_getThemeListData:function(e,t){if(this.oUser.isSetThemePermitted()===false){var o=t;for(var r=0;r<e.length;r++){if(e[r].id===t){o=e[r].name||t;break}}return[{id:t,name:o}]}var n=this.getView().getModel("darkMode").getData();var s=this._isDarkModeActive();return e.reduce(function(e,o){var r={id:o.id,name:o.name||o.id||"",isVisible:true,isSelected:o.id===t,isSapTheme:!!v[o.id]};if(s&&n.supportedThemes[o.id]){var i=n.supportedThemes[o.id];if(i.complementaryTheme===t||o.id===t){r.isVisible=o.id===t}else{r.isVisible=i.mode===u.Mode.LIGHT}r.combineName=i.combineName}e.push(r);return e},[]).sort(function(e,t){var o=e.name.localeCompare(t.name);if(o===0){o=e.id.localeCompare(t.id)}return o})},getConfigurationModel:function(){const e=new l({themeConfigurable:h.last("/core/shell/model/setTheme"),sizeBehaviorConfigurable:h.last("/core/home/sizeBehaviorConfigurable"),tileSize:this.TILE_SIZE[h.last("/core/home/sizeBehavior")],contentDensityConfigurable:h.last("/core/shell/model/contentDensity")&&!a.system.phone,isCozyContentMode:document.body.classList.contains("sapUiSizeCozy"),sapUiContentIconColor:"",textAlign:a.system.phone?"Left":"Right",showContentProviderInfoOnVisualizationsConfigurable:h.last("/core/contentProviders/providerInfo/enabled")&&h.last("/core/contentProviders/providerInfo/userConfigurable"),showContentProviderInfoOnVisualizationsSelected:h.last("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations")});this._oConfigModelPromise=g.getThemingParameters(["sapUiContentIconColor"]).then(([t])=>{e.setProperty("/sapUiContentIconColor",t)});return e},getDarkModeModel:function(e){var t=new l({enabled:false,detectionSupported:false,detectionEnabled:false,supportedThemes:{}});if(h.last("/core/darkMode/enabled")){this._oDarkModeModelPromise=sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(o){t.setProperty("/enabled",true);t.setProperty("/detectionSupported",o.canAutomaticallyToggleDarkMode());t.setProperty("/detectionEnabled",o.canAutomaticallyToggleDarkMode()&&this.oUser.getDetectDarkMode());t.setProperty("/supportedThemes",this._getSupportedDarkModeThemes(e,h.last("/core/darkMode/supportedThemes")||[]))}.bind(this))}else{this._oDarkModeModelPromise=Promise.resolve()}return t},_getSupportedDarkModeThemes:function(e,t){var o=e.reduce(function(e,t){e[t.id]=t.name;return e},{});return t.reduce(function(e,t){var r=t.light;var n=t.dark;var s=o[r];var i=o[n];if(s&&i&&!e[r]&&!e[n]){var a=m(r);e[r]={mode:u.Mode.LIGHT,complementaryTheme:n,combineName:a};e[n]={mode:u.Mode.DARK,complementaryTheme:r,combineName:a}}return e},{})},onAfterRendering:function(){var e=this._isDarkModeActive();var t=this.getView().getModel("config").getProperty("/themeConfigurable");var o=this.getView().byId("themeList");var r=o.getItems();o.toggleStyleClass("sapUshellThemeListDisabled",!t);r.forEach(function(t){var o=t.getCustomData()[0].getValue();var r=t.getContent()[0].getItems()[0].getItems()[0];if(v[o]){r.addStyleClass(v[o])}r.toggleStyleClass("sapUshellDarkMode",e)})},_handleThemeApplied:async function(){var e=this.getView().getModel("config");if(e){const[r]=await g.getThemingParameters(["sapUiContentIconColor"]);e.setProperty("/sapUiContentIconColor",r);var t=this.oUser.getTheme();var o=this._getThemeListData(this.aThemeListFromServer,t);this.getView().getModel().setProperty("/options",o)}},onCancel:function(){var e=this.getView().getModel("config");if(e.getProperty("/themeConfigurable")){var t=this.oUser.getTheme();var o=this.getView().getModel().getProperty("/options");o.forEach(function(e){e.isSelected=t===e.id});this.getView().getModel().setProperty("/options",o)}if(e.getProperty("/showContentProviderInfoOnVisualizationsConfigurable")){e.setProperty("/showContentProviderInfoOnVisualizationsSelected",h.last("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations"))}if(e.getProperty("/contentDensityConfigurable")){e.setProperty("/isCozyContentMode",this.oUser.getContentDensity()==="cozy")}if(e.getProperty("/sizeBehaviorConfigurable")){e.setProperty("/tileSize",this.TILE_SIZE[h.last("/core/home/sizeBehavior")])}if(this._oDarkModeModel&&this._oDarkModeModel.getProperty("/enabled")){this._oDarkModeModel.setProperty("/detectionEnabled",this.oUser.getDetectDarkMode());this.oUser.resetChangedProperty("detectDarkMode")}},onSave:function(e){this._updateUserPreferences=e;var o=this.getView().getModel("config");var r=[];if(o.getProperty("/themeConfigurable")){r.push(this.onSaveThemes().then(function(){c.emit("themeChanged",Date.now())}))}if(o.getProperty("/showContentProviderInfoOnVisualizationsConfigurable")){r.push(this.onSaveShowContentProviderInfoOnVisualizations())}if(o.getProperty("/contentDensityConfigurable")){r.push(this.onSaveContentDensity())}if(o.getProperty("/sizeBehaviorConfigurable")){r.push(this.onSaveTileSize())}if(this._oDarkModeModel&&this._oDarkModeModel.getProperty("/enabled")){r.push(this.onSaveDarkModeEnabled())}return Promise.all(r).then(function(e){var o=[];e.forEach(function(e){if(e&&t.isA(e,"sap.ui.core.message.Message")){o.push(e)}});return o.length>0?Promise.reject(o):Promise.resolve()})},onSaveThemesSuccess:function(e){e.resetChangedProperty("theme");return this._applyDarkMode()},onSaveThemes:function(){var t=this.getView().getModel("config");var o=this._getSelectedTheme();var r=this.oUser;var n=r.getTheme(p.prototype.constants.themeFormat.ORIGINAL_THEME);if(o&&o!==n&&t.getProperty("/themeConfigurable")){r.setTheme(o);return this._updateUserPreferences(r).then(function(){return this.onSaveThemesSuccess(r)}.bind(this)).catch(function(t){if(!t.includes("THEME")){return this.onSaveThemesSuccess(r)}r.setTheme(n);r.resetChangedProperty("theme");e.error("Can not save selected theme",t);throw new s({type:f.Error,description:t})}.bind(this))}return Promise.resolve()},_onSaveContentDensitySuccess:function(e){var t=this.oUser;t.resetChangedProperty("contentDensity");r.getEventBus().publish("launchpad","toggleContentDensity",{contentDensity:e});c.emit("toggleContentDensity",{contentDensity:e});return new Promise(function(e){c.once("toggleContentDensity").do(function(){e()})})},onSaveContentDensity:function(){var t=this.getView().getModel("config");var o=this.oUser;var r=t.getProperty("/isCozyContentMode")?"cozy":"compact";var n=o.getContentDensity();e.debug("[000] onSaveContentDensity","Appearance.controller");if(r!==n&&t.getProperty("/contentDensityConfigurable")){o.setContentDensity(r);e.debug("[000] onSaveContentDensity: sNewContentDensity",r,"Appearance.controller");return this._updateUserPreferences(o).then(function(){return this._onSaveContentDensitySuccess(r)}.bind(this)).catch(function(t){if(!t.includes("CONTENT_DENSITY")){return this._onSaveContentDensitySuccess()}o.setContentDensity(n);o.resetChangedProperty("contentDensity");e.error("Can not save content density configuration",t);throw new s({type:f.Error,message:t})}.bind(this))}return Promise.resolve()},onSaveTileSize:function(){var t=this.getView().getModel("config");var o=this.TILE_SIZE.getName(t.getProperty("/tileSize"));var r=h.last("/core/home/sizeBehavior");if(o&&o!==r&&t.getProperty("/sizeBehaviorConfigurable")){return new Promise(function(t,r){this.writeToPersonalization("flp.settings.FlpSettings","sizeBehavior",o).done(function(){h.emit("/core/home/sizeBehavior",o);var e=document.getElementsByClassName(".sapUshellTile");for(var r=0;r<e.length;r++){e[r].classList.toggle("sapUshellSmall",o!=="Responsive")}t()}).fail(function(t,o){e.error("Cannot save tile size configuration",t);var n=new s({type:f.Error,description:t,message:o.message.value,date:o.innererror.timestamp,httpStatus:o.httpStatus});r(n)})}.bind(this))}return Promise.resolve()},onSaveDarkModeEnabledSuccess:function(e,t){return sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(o){e.resetChangedProperty("detectDarkMode");if(t){o.enableDarkModeBasedOnSystem()}else{o.disableDarkModeBasedOnSystem()}})},onSaveDarkModeEnabled:function(){var t=this._oDarkModeModel.getProperty("/detectionEnabled");var o=this.oUser.getDetectDarkMode();var r=this.oUser;if(t!==o){e.debug("[000] onSaveDarkModeEnabled: setDetectDarkModeEnabled",t,"Appearance.controller");r.setDetectDarkMode(t);return this._updateUserPreferences(this.oUser).then(function(){return this.onSaveDarkModeEnabledSuccess(r,t)}.bind(this)).catch(function(n){if(!n.includes("THEME_DARKMODE_AUTO_DETECTION")){return this.onSaveDarkModeEnabledSuccess(r,t)}r.setDetectDarkMode(o);r.resetChangedProperty("detectDarkMode");e.error("Can not save dark mode configuration",n);throw new s({message:n})}.bind(this))}return Promise.resolve()},onSaveShowContentProviderInfoOnVisualizations:function(){var t=h.last("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations");var o=this.getView().getModel("config").getProperty("/showContentProviderInfoOnVisualizationsSelected");if(o===t){return Promise.resolve()}return new Promise(function(t,r){this.writeToPersonalization("flp.settings.FlpSettings","showContentProviderInfoOnVisualizations",o).done(function(){h.emit("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations",o);t()}).fail(function(t,o){e.error("Cannot save system info on tiles configuration",t);var n=new s({type:f.Error,description:t,message:o.message.value,date:o.innererror.timestamp,httpStatus:o.httpStatus});r(n)})}.bind(this))},writeToPersonalization:function(t,o,r){return jQuery.when(this.getPersonalizer(t,o).then(function(e){return e.setPersData(r)})).catch(function(t){e.error("Personalization service does not work:");e.error(t.name+": "+t.message)})},getPersonalizer:function(e,t){var r=e+"-"+t;if(this.oPersonalizers[r]){return Promise.resolve(this.oPersonalizers[r])}return sap.ushell.Container.getServiceAsync("Personalization").then(function(n){var s=o.getOwnerComponentFor(this.getView());var i={keyCategory:n.constants.keyCategory.FIXED_KEY,writeFrequency:n.constants.writeFrequency.LOW,clientStorageAllowed:true};if(!this.oPersonalizers[r]){this.oPersonalizers[r]=n.getPersonalizer({container:e,item:t},i,s)}return this.oPersonalizers[r]}.bind(this))},_applyDarkMode:function(){var e=this._oDarkModeModel;var t;if(e.getProperty("/enabled")&&e.getProperty("/detectionSupported")&&e.getProperty("/detectionEnabled")){t=sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(e){e._toggleDarkModeBasedOnSystemColorScheme()})}else{t=Promise.resolve()}return t},_isDarkModeActive:function(){var e=this._oDarkModeModel.getProperty("/");return e.enabled&&e.detectionSupported&&e.detectionEnabled},changeSystemModeDetection:function(){var e=this._getSelectedTheme();this.getView().getModel().setProperty("/options",this._getThemeListData(this.aThemeListFromServer,e));this.getView().invalidate()}})});
//# sourceMappingURL=Appearance.controller.js.map