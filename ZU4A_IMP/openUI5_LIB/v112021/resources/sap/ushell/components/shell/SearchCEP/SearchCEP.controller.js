// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/List","sap/m/Text","sap/m/StandardListItem","sap/ushell/components/shell/SearchCEP/SearchProviders/SearchProvider","sap/base/Log","sap/ushell/utils/WindowUtils","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/ui/Device","sap/ui/core/Configuration","sap/base/util/UriParameters","sap/ui/core/Core","sap/ushell/EventHub","sap/m/Avatar"],function(e,t,i,s,r,o,a,n,l,jQuery,h,c,d,u,g,f,p){"use strict";return e.extend("sap.ushell.components.shell.SearchCEP.SearchCEP",{onInit:function(){this._bIsMyHome=false;this._bEscPressed=false;this.bGrowingReset=false;this._SearchCEPService=sap.ushell.Container.getServiceAsync("SearchCEP");this._SearchCEPService.then(function(e){this._registerDefaultProviders(e);this._listenToServiceEvents(e)}.bind(this));this._toggleSearchPopover(false);this._oPlaceHolderSF=g.byId("PlaceHolderSearchField");var e=sap.ushell.Container.getFLPPlatform(true);if(e==="MYHOME"){this._bIsMyHome=true}},onSuggest:function(e){if(this._bEscPressed){return}this.oSF.focus();if(this.bOpeningPopOver===true&&this._oPopover.isOpen()===true){this.bOpeningPopOver=false;return}var t=e.getParameter("suggestValue");this._testProviders(t)},onfocusin:function(e){if(this.oSF.getEnableSuggestions()&&c.system.phone){jQuery(this.oSF.getDomRef()).find("input").attr("inputmode","search");jQuery(this._oPlaceHolderSF.getDomRef()).find("input").attr("inputmode","search")}},onSearch:function(e){var t=e.getParameter("query"),i=e.getParameter("escPressed"),s=e.getParameter("clearButtonPressed"),r=g.byId("SearchResultList");if(i){this._bEscPressed=i;if(this.oSF.getValue()||this._oPlaceHolderSF.getValue()){this.oSF.setValue("");this._oPlaceHolderSF.setValue("")}else{this._oPopover.close()}return}if(s){this.oSF.setValue("");this._oPlaceHolderSF.setValue("");this.bOpeningPopOver=false;this._testProviders();var o=true,a=this._oPopover.getContent()[1].getItems();for(var n in a){if(a[n].getItems().length){o=false}}if(o){this._oPopover.close()}return}if(t){t=t.trim();this._oPlaceHolderSF.setValue(this.oSF.getValue());this._saveSearchTerm(t);if(this._bIsMyHome){if(r.getItems().length>0){var l=r.getItems()[0].getBindingContext("resultModel"),h=l.getObject();this._navigateToApp(h)}}else{this._navigateToResultPage(t)}this._oPopover.close()}},onBeforeOpen:function(){var e=false,t=g.byId("shell-header"),i=t.getSearchState();if(i==="COL"){e=true}this._oPopover.addStyleClass("sapUshellCEPSearchFieldPopover");t.setSearchState("EXP",35,false);t.setSearchState("EXP_S",35,true);if(e===true){t.setSearchState("COL",35,false)}},onAfterOpen:function(){var e=document.getElementById("PlaceHolderSearchField").clientHeight;document.getElementById("CEPSearchField").style.height=e+"px";document.getElementById("CEPSearchField-search").title=h.i18n.getText("search");var t=document.querySelectorAll(".searchCEPList .sapMSLIDiv:not(.sapMGrowingListTriggerText)>.sapMSLITitleOnly");t.forEach(function(e){if(e.scrollWidth>e.offsetWidth){e.parentNode.parentNode.title=e.innerText}})},onAfterClose:function(e){var t=g.byId("sf"),i=g.byId("shell-header"),s=this._getScreenSize(),r=this._oPopover.getContent()[1].getItems();this._oPlaceHolderSF.setValue(this.oSF.getValue());if(this._bEscPressed){this._bEscPressed=false;this._oPlaceHolderSF.focus()}if(s!=="XL"&&this.oSF.getValue()===""){i.setSearchState("COL",35,false);t.setVisible()}else{i.setSearchState("EXP",35,false);i.setSearchState("EXP_S",35,false)}r.forEach(function(t){var i=t._getProviderConfig(),s=this._getDefaultProviderGroupName(i.id);if(!s){if(typeof i.popoverClosed==="function"){var r=i.popoverClosed;r(e)}}}.bind(this))},getHomePageApps:function(){var e="homePageApplications",t=a.defaultProviders[e];t.execSearch("",e)},_listenToServiceEvents:function(e){f.on("updateExtProviderLists").do(this._updateExtProviderLists.bind(this,e))},_updateExtProviderLists:function(e){if(this._oPopover){var t=this._oPopover.getContent()[1],i=t.getItems(),s=e.getExternalSearchProvidersPriorityArray();for(var r in i){var o=i[r],a=o._getProviderConfig(),n=this._getDefaultProviderGroupName(a.id);if(!n){t.removeItem(o);o.destroy();this._oResultModel.setProperty("/"+a.name,[])}}if(!c.support.touch){this._sContentDensityClass="sapUiSizeCompact"}else{this._sContentDensityClass="sapUiSizeCozy"}s.then(function(e){for(var i in e){var s=this._createList(e[i],undefined);s.addStyleClass(this._sContentDensityClass);t.addItem(s)}if(this._oPopover.isOpen()){if(e.length){this._testProviders(this.oSF.getValue())}}}.bind(this))}},_registerDefaultProviders:function(e){for(var t in a.defaultProviders){e._registerDefaultSearchProvider(a.defaultProviders[t])}},_getScreenSize:function(){var e=c.media.getCurrentRange(c.media.RANGESETS.SAP_STANDARD_EXTENDED);if(e.from>=1440){return"XL"}else if(e.from>=1024){return"L"}else if(e.from>=600){return"M"}else if(e.from>=0){return"S"}},_focusNextList:function(e){var t=this._oPopover.getContent()[1].getItems(),i=t.map(function(e){return e.getId()}).indexOf(e.getId()),s=t.slice(i+1);for(var r=0;r<s.length;r++){if(s[r].getVisible()&&s[r].getItems().length){var o=s[r].getItems()[0],a=o.getParent(),n=a._getProviderConfig();o.focus();this._setListNameToAriaLabelledBy(o,n.title);break}}},_focusPreviousList:function(e){var t=this._oPopover.getContent()[1].getItems(),i=t.map(function(e){return e.getId()}).indexOf(e.getId()),s=t.slice(0,i);if(!s.length){this.oSF.focus();return}for(var r=s.length-1;r>=0;r--){if(s[r].getVisible()&&s[r].getItems().length){var o=s[r].getItems(),a=document.getElementById(s[r].getId()+"-triggerList"),n=window.getComputedStyle(a);if(n.display==="none"){o[o.length-1].focus()}else{g.byId(s[r].getId()+"-trigger").focus()}break}if(r===0){this.oSF.focus()}}},_keyDownHandler:function(e){var t=e.srcControl,i=t.getParent(),s=i.getItems();if(e.code===40||e.code==="ArrowDown"){if(s[s.length-1]===t){var r=document.getElementById(i.getId()+"-triggerList"),o=window.getComputedStyle(r);if(o.display==="none"){this._focusNextList(i)}}if(t.getId().endsWith("-trigger")){this._focusNextList(i)}}else if(e.code===38||e.code==="ArrowUp"){if(s[0]===t){this._focusPreviousList(i)}}},_setListNameToAriaLabelledBy:function(e,t){var i=e.getDomRef(),s=jQuery(i).attr("aria-labelledby"),r=g.byId(s).getProperty("text");jQuery(g.byId(s).getDomRef()).text(t+". "+r)},_getDefaultProviderGroupName:function(e){var t={SearchResultList:"applications",FrequentlyUsedAppsList:"frequentApplications",SearchHistoryList:"recentSearches",ProductsList:"homePageApplications",ExternalSearchAppsList:"externalSearchApplications"};return t[e]},_removeTopListDivider:function(){setTimeout(function(){var e=jQuery(this._oPopover.getDomRef()).find(".searchCEPList.sapUshellCEPListDivider").not(":hidden");if(e.length){jQuery.each(e,function(t){if(jQuery(e[t]).hasClass("topCEPlist")){jQuery(e[t]).removeClass("topCEPlist")}});jQuery(e[0]).addClass("topCEPlist")}}.bind(this),300)},_createList:function(e,t){var i=new s({id:e.id,showSeparators:"None",headerText:e.titleVisible?e.title:"",headerLevel:"H1",growing:true,showNoData:e.showNoData||false,growingThreshold:e.defaultItemCount,growingScrollToLoad:false,items:{path:"resultModel>/"+e.name,factory:this._createListItem.bind(this)},growingStarted:this._listUpdateStart.bind(this),updateStarted:this._listUpdateStart.bind(this),itemPress:this._itemPress.bind(this)}).addStyleClass("searchCEPList sapUshellCEPListDivider");switch(e.id){case"SearchResultList":i.attachUpdateFinished(this._resultListUpdateFinish.bind(this));break}i.setModel(t,"resultModel");i._providerConfig=e;i._getProviderConfig=function(){return this._providerConfig};i.addEventDelegate({onkeydown:this._keyDownHandler.bind(this),onsapdown:this._keyDownHandler.bind(this)});return i},_createListItem:function(e,t){var i={type:"Active",title:t.getProperty("text"),iconDensityAware:false},s=t.getProperty("icon");var r=new p("",{displaySize:"XS",backgroundColor:"Transparent",displayShape:"Square",src:s,imageFitType:"Contain",decorative:true});i.avatar=r;if(s.indexOf("sap-icon://")>-1){r.addStyleClass("searchCEPlistItemIcon")}var a=new o(i);a.addStyleClass("sapUiTinyMarginBeginEnd");return a},_itemPress:function(e){var t,i=e.getParameter("srcControl"),s=i.getParent(),r=s._getProviderConfig(),o=this._getDefaultProviderGroupName(r.id);if(o){o=o.charAt(0).toUpperCase()+o.substring(1);t="_on"+o+"Press";this[t](e)}else{t=r.itemPress;t(e);var a=s.getItems().indexOf(i),n=this._oResultModel.getProperty("/"+r.name),l=n[a];if(l.hasOwnProperty("press")&&typeof l.press==="function"){t=l.press;t(e)}if(!l.hasOwnProperty("closePopover")&&r.closePopover===true||l.hasOwnProperty("closePopover")&&l.closePopover===true){this._oPopover.close()}}},_listUpdateStart:function(e){var t=e.getSource(),i=t._getProviderConfig(),s=e.getParameter("actual"),r=e.getParameter("reason"),o=this.bGrowingReset?i.maxItemCount:i.defaultItemCount;if(s&&s>0){if(r){switch(r.toLowerCase()){case"growing":this.bGrowingReset=true;var a=this._oResultModel.getProperty("/"+i.name);this._oResultModel.setProperty("/"+i.name,[]);this._oResultModel.setProperty("/"+i.name,a);t.setGrowingThreshold(i.maxItemCount);break;case"change":t.setGrowingThreshold(o);break}}else{t.setGrowingThreshold(o)}}},_resultListUpdateFinish:function(e){var t=e.getSource(),i=t._getProviderConfig(),s=t.getModel("resultModel").getProperty("/query");if(i.highlightResult&&i.highlightResult===true){var r=t.$().find(".sapMSLITitleOnly");jQuery.each(r,function(e,t){var i=new RegExp(s,"gi"),o=r[t].innerHTML.replace(/<[^>]*>/g,""),a=o.replace(i,function(e,t){return this._getBoldTitle(e,t)}.bind(this,e));r[t].innerHTML=this._getHighlightedHtml(e,a)}.bind(this,i))}},_getBoldTitle:function(e,t){if(e.highlightSearchStringPart&&e.highlightSearchStringPart===true){return"<b>"+t+"</b>"}return"</b>"+t+"<b>"},_getHighlightedHtml:function(e,t){if(!e.highlightSearchStringPart||e.highlightSearchStringPart!==true){return"<b>"+t+"</b>"}return t},_testProviders:function(e){if(!this._oResultModel){this._oResultModel=new t({});this._oPopover.setModel(this._oResultModel,"resultModel")}var i=this._oResultModel,s=(e||"").trim().length,r=this._oPopover.getContent()[1].getItems();i.setProperty("/query",e);if(!c.support.touch){this._sContentDensityClass="sapUiSizeCompact"}else{this._sContentDensityClass="sapUiSizeCozy"}for(var o in r){var a=r[o],n=a._getProviderConfig(),l=this._getDefaultProviderGroupName(n.id);a.setVisible(false);if(s>=n.minQueryLength&&s<=n.maxQueryLength){n.execSearch(e,l).then(function(t,s,r){if(r&&Array.isArray(r)&&r.length>0){var o=this._oResultModel.getProperty("/query");if(o&&(o.length<s.minQueryLength||o.length>s.maxQueryLength)){return}if(!this._oPopover.isOpen()){this._toggleSearchPopover(true)}if(i.getProperty("/"+s.name)){this.bGrowingReset=false;i.setProperty("/"+s.name,[])}t.setVisible(true);var a=r.slice(0,s.maxItemCount);i.setProperty("/"+s.name,a);switch(t.getId()){case"SearchResultList":this._applyResultsAcc(a.length);break}this.oSF.focus()}else{i.setProperty("/"+s.name,[]);switch(t.getId()){case"SearchResultList":this._applyResultsAcc(0);var n=h.i18n.getText("no_apps_found",[e]);t.setNoDataText(n);t.setVisible(true);break}}}.bind(this,a,n))}}this._removeTopListDivider()},_applyResultsAcc:function(e){var t="",i=this.oSF.$("SuggDescr"),s=i.text();if(e===1){t=h.i18n.getText("one_result_search_aria",e)}else if(e>1){t=h.i18n.getText("multiple_results_search_aria",e)}else{t=h.i18n.getText("no_results_search_aria")}if(s.indexOf(".")<0){t+="."}i.text(t)},_toggleSearchPopover:function(e){if(!this._oPopover){i.load({name:"sap.ushell.components.shell.SearchCEP.SearchFieldFragment",type:"XML",controller:this}).then(function(e){this._oPopover=e;var t=this._getScreenSize(),i=document.getElementById("PlaceHolderSearchField").clientWidth;if(t==="S"){i=1.1*i}else{i=1.05*i}this._oPopover.setContentWidth(i+"px");if(d.getRTL()===true){var s=this._oPopover.getOffsetX();this._oPopover.setOffsetX(-1*s)}this._initializeSearchField();var o=new r({id:"popoverTitle",text:"List of search results and navigation suggestions"});o.addStyleClass("sapUiInvisibleText");this._oPopover.addContent(o);this._initLists().then(function(){this._testProviders()}.bind(this))}.bind(this))}else if(e){this._oPopover.openBy(this._oPlaceHolderSF);this.bOpeningPopOver=true;if(this._oPlaceHolderSF.getValue()!==""){this.oSF.setValue(this._oPlaceHolderSF.getValue())}}},_initLists:function(){return this._SearchCEPService.then(function(e){var t=e.getSearchProvidersPriorityArray(),i=this._oPopover.getContent()[1];if(!c.support.touch){this._sContentDensityClass="sapUiSizeCompact"}else{this._sContentDensityClass="sapUiSizeCozy"}return t.then(function(e){for(var t=0;t<e.length;t++){var s=this._createList(e[t],this._oResultModel);s.addStyleClass(this._sContentDensityClass);i.addItem(s)}}.bind(this))}.bind(this))},_keyDownSearchField:function(e){if(e.code===40||e.code==="ArrowDown"){this.oSF.focus();var t=this._oPopover.getContent()[1].getItems();for(var i in t){if(t[i].getVisible()&&t[i].getItems().length>0){var s=t[i].getItems()[0],r=s.getParent(),o=r._getProviderConfig();s.focus();this._setListNameToAriaLabelledBy(s,o.title);break}}}else if(e.code===116||e.code==="F5"){window.location.reload()}else if(e.code===9||e.code==="Tab"){var a;if(e.shiftKey){a=this._oPlaceHolderSF.oParent.getDomRef().firstChild.lastChild.firstChild}else{var n=this._oPlaceHolderSF.oParent.getDomRef().lastChild,l=n.childNodes;for(var h in l){if(getComputedStyle(l[h]).display!=="none"){a=l[h];break}}}setTimeout(function(){if(this._getScreenSize()==="S"||this._getScreenSize()==="M"){g.byId("shell-header").setSearchState("COL",35,false);g.byId("sf").setVisible(true)}if(a){a.focus()}}.bind(this),0)}else if(e.code===27||e.code==="Escape"){this.oSF.setValue("");this._oPlaceHolderSF.setValue("");this._bEscPressed=true}},_initializeSearchField:function(){this.oSF=g.byId("CEPSearchField");var e=document.getElementById("PlaceHolderSearchField").clientWidth;this.oSF.setWidth(e+"px");this.oSF.addEventDelegate({onkeydown:this._keyDownSearchField.bind(this),onfocusin:this.onfocusin.bind(this)})},_saveSearchTerm:function(e){if(e){sap.ushell.Container.getServiceAsync("UserRecents").then(function(t){t.addSearchActivity({sTerm:e})})}},_onRecentSearchesPress:function(e){var t=e.getParameter("listItem").getProperty("title");this.oSF.setValue(t);setTimeout(function(){this._testProviders(t)}.bind(this))},_onApplicationsPress:function(e){var t=this.oSF.getValue(),i=e.getParameter("listItem").getBindingContext("resultModel"),s=i.getObject();this._saveSearchTerm(t);this._navigateToApp(s)},_onHomePageApplicationsPress:function(e){var t=this.oSF.getValue(),i=e.getParameter("listItem").getBindingContext("resultModel"),s=i.getObject();this._saveSearchTerm(t);this._navigateToApp(s)},_onExternalSearchApplicationsPress:function(e){var t=this.oSF.getValue(),i=e.getParameter("listItem").getBindingContext("resultModel"),s=i.getObject();this._saveSearchTerm(t);if(s&&s.isEnterpriseSearch===true){this._navigateToResultPage(t,true)}else{this._navigateToApp(s,t)}},_onFrequentApplicationsPress:function(e){var t=e.getParameter("listItem").getBindingContext("resultModel"),i=t.getObject();this._navigateToApp(i);if(this._oPopover.isOpen()){this._oPopover.close()}},_navigateToApp:function(e,t){this._SearchCEPService.then(function(i){i.navigate(e,t)});if(this.oSF.getValue()!==""){this.oSF.setValue("")}setTimeout(function(){if(this._oPopover.isOpen()){this._oPopover.close()}}.bind(this),500)},_navigateToResultPage:function(e,t){if(e===""){return}var i="#WorkZoneSearchResult-display?searchTerm="+e+"&category=app";if(t===true){i='#Action-search&/top=20&filter={"dataSource":{"type":"Category","id":"All","label":"All","labelPlural":"All"},"searchTerm":"'+e+'","rootCondition":{"type":"Complex","operator":"And","conditions":[]}}'}var s=sap.ushell.Container.getServiceAsync("Navigation");s.then(function(e){e.navigate({target:{shellHash:i}})})}})});
//# sourceMappingURL=SearchCEP.controller.js.map