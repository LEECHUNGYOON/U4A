// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/ushell/components/shell/Settings/ErrorMessageHelper","sap/ui/core/message/Message","sap/ui/base/Object","sap/ui/core/library","sap/base/util/deepClone"],function(e,t,n,s,r,i,a,o,l,u,d,c,g,f,h){"use strict";var p=f.MessageType;return n.extend("sap.ushell.components.shell.Settings.UserSettings",{onInit:function(){this._aPreviouslySelectedItems=[];this.getView().byId("userSettingEntryList").addEventDelegate({onAfterRendering:this._listAfterRendering.bind(this)});this._mLoadedEntryContent=new Map;this._mLoadedWrappers=new Map;this.getView().setModel(new r({entries:{}}),"results");i.orientation.attachHandler(this._fnOrientationChange,this);this._oSelectedItemOnMobile=null;this._oConfigDoable=a.on("/core/userPreferences/entries").do(this._processNewEntries.bind(this))},_fnOrientationChange:function(){var e=this.getView().byId("settingsApp");this._updateHeaderButtonVisibility(e.isMasterShown())},_formatDescription:function(e,t,n){if(t.length>1){return""}return n[e].valueResult||""},_processNewEntries:function(e){var t=this.getView();var n=t.getModel("results");e.forEach(function(e){var t=n.getProperty("/entries/"+e.id);if(!t){n.setProperty("/entries/"+e.id,{valueResult:null,contentResult:null})}this._setEntryValueResult(e.id)}.bind(this));var s=t.getModel();var r=t.byId("userSettingEntryList");var a=r.getSelectedItem();if(!i.system.phone&&!a){a=r.getItems()[0]}if(a){var o=a.getBindingContextPath();var l=s.getProperty(o);this._aPreviouslySelectedItems=l.tabs.map(function(e){return e.id})}s.setProperty("/entries",this._calculateEntryGroups(e));t.byId("userSettingEntryList").invalidate()},_calculateEntryGroups:function(e){var t=[];var n=new Map;var s=this.getView().getModel("results");e.forEach(function(e){if(e.visible===false){var r=s.getProperty("/entries/"+e.id+"/contentResult");if(r){this.getView().byId("settingsApp").removeDetailPage(r);s.setProperty("/entries/"+e.id+"/contentResult",null)}var i=o.last("UserSettingsOpened")||{};delete i[e.id];o.emit("UserSettingsOpened",i);return}if(e.groupingEnablement){s.setProperty("/entries/"+e.id+"/contentResult",null);var a=n.get(e.groupingId);if(a||a===0){t[a].tabs.push(e);return}n.set(e.groupingId,t.length)}e.tabs=[e];t.push(e)}.bind(this));return t},_afterClose:function(){if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("userActionsMenuHeaderButton").focus()}},_listAfterRendering:function(){var e=this.getView();var t=e.getModel();var n=e.byId("userSettingEntryList");var s=n.getItems();s.forEach(function(e){var n=t.getProperty(e.getBindingContextPath()+"/id");this._setEntryValueResult(n)}.bind(this));if(!i.system.phone){if(this._aPreviouslySelectedItems){for(var r=0;r<this._aPreviouslySelectedItems.length;r++){for(var a=0;a<s.length;a++){var o=s[a];if(t.getProperty(o.getBindingContextPath()+"/id")===this._aPreviouslySelectedItems[r]){n.setSelectedItem(o);this._toDetail(o);o.focus();return}}}}var l=s[0];if(l){n.setSelectedItem(l);this._toDetail(l);l.focus()}}},_setEntryValueResult:function(t){var n;var s=this.getView().getModel("results");var r=a.last("/core/userPreferences/entries");var i=r.findIndex(function(e){return e.id===t});if(i===-1){return Promise.resolve()}return Promise.resolve().then(function(){var o=r[i].title;var u=r[i].valueArgument;if(typeof u!=="function"){var d=s.getProperty("/entries/"+t+"/valueResult");if(d!==null&&d!==undefined){return d}return u}n=h(s.getProperty("/entries"));n[t].valueResult=l.i18n.getText("genericLoading");s.setProperty("/entries",n);return Promise.resolve().then(u).then(function(e){if(typeof e!=="object"){return e}if(e&&e.value!==undefined){r=a.last("/core/userPreferences/entries");i=r.findIndex(function(e){return e.id===t});if(i>-1){r[i].visible=!!e.value;a.emit("/core/userPreferences/entries",r)}}return e.displayText}).catch(function(t){e.error("Can not load value for "+o+" entry",t);return l.i18n.getText("loadingErrorMessage")})}).then(function(e){n=h(s.getProperty("/entries"));n[t].valueResult=e||"";s.setProperty("/entries",n)})},_navBackButtonPressHandler:function(){var e=this.getView().byId("settingsApp");e.backDetail();this._updateHeaderButtonVisibility(true)},_navToggleButtonPressHandler:function(){var e=this.getView().byId("settingsApp");var t=e.isMasterShown();if(t){e.hideMaster()}else{e.showMaster()}this._updateHeaderButtonVisibility(!t)},_updateHeaderButtonVisibility:function(e){if(i.system.phone){var t=this.getView().byId("userSettingsNavBackButton");t.setVisible(!e)}else{var n=this.getView().byId("userSettingsMenuButton");if(i.orientation.portrait){n.setVisible(true);n.setPressed(e);n.setTooltip(l.i18n.getText(e?"ToggleButtonHide":"ToggleButtonShow"))}else{n.setVisible(false)}}},_afterMasterClose:function(){this._updateHeaderButtonVisibility(false)},_itemPress:function(e){this._toDetail(e.getSource().getSelectedItem())},_toDetail:function(e){var t=this.getView();var n=t.getModel();var s=t.getModel("results");var r=t.byId("settingsApp");var o=e.getBindingContextPath();var l=n.getProperty(o);var u=l.id;var d=s.getProperty("/entries/"+u+"/contentResult");if(l.tabs){this._aPreviouslySelectedItems=l.tabs.map(function(e){return e.id})}else{this._aPreviouslySelectedItems=[u]}if(i.system.phone){this._oSelectedItemOnMobile=e;e.setSelected(false)}if(d){this._navToDetail(d,t);var c=l.tabs.map(function(e){return e.id}).join("-");var g=this._mLoadedWrappers.get(c);if(g){g.then(function(e){var t=e.getContent()[1];var n=t.getSelectedKey();var s=t.getItems();var r=s.findIndex(function(e){return e.getId()===n});if(r===-1){r=0}this._emitEntryOpened(l.tabs[r].id)}.bind(this));return Promise.resolve()}}if(i.system.phone){r.setBusy(true)}else{this._navToBusyPage()}return Promise.all([this._createContentWrapper(l),this._createEntryContent(l)]).then(function(n){var i=n[0];var o=n[1];var d=a.last("/core/userPreferences/entries");var c=d.some(function(e){return e.id===u&&e.visible!==false});var g=t.byId("userSettingEntryList");var f=g.getSelectedItem()||this._oSelectedItemOnMobile;var h=e===f;if(!c){if(h){if(r.getMode()==="ShowHideMode"){r.showMaster();this._updateHeaderButtonVisibility(true)}else{this._toDetail(f||g.getItems()[0])}}return}r.addDetailPage(i);if(l.tabs.length>1){i.getContent()[1].getItems()[0].addContent(o)}else{i.addContent(o)}var p=i.getId();s.setProperty("/entries/"+u+"/contentResult",p);if(h){this._navToDetail(p,t);this._emitEntryOpened(u)}return i.getId()}.bind(this))},_createEntryContent:function(e){if(!this._mLoadedEntryContent.get(e.id)){if(typeof e.contentFunc==="function"){this._mLoadedEntryContent.set(e.id,new Promise(function(t){e.contentFunc().then(function(e){if(g.isA(e,"sap.ui.core.Control")){t(e)}else{this._createErrorContent(l.i18n.getText("loadingErrorMessage")).then(t)}}.bind(this)).catch(function(){this._createErrorContent(l.i18n.getText("loadingErrorMessage")).then(t)}.bind(this))}.bind(this)))}else{this._mLoadedEntryContent.set(e.id,this._createErrorContent(l.i18n.getText("userSettings.noContent")))}}return this._mLoadedEntryContent.get(e.id)},_createContentWrapper:function(e){var n=e.tabs.map(function(e){return e.id});var i=n.join("-");if(!this._mLoadedWrappers.get(i)){this._mLoadedWrappers.set(i,s.load({name:"sap.ushell.components.shell.Settings.ContentWrapper",controller:{onTabSelected:function(n){var s=t.byId(n.getParameter("id"));var r=n.getParameter("item");var i=s.indexOfItem(r);var a=e.tabs[i];this._emitEntryOpened(a.id);this._createEntryContent(a).then(function(e){r.addContent(e)})}.bind(this)}}).then(function(t){t.setModel(new r({title:e.title,showHeader:!e.provideEmptyWrapper,tabs:e.tabs}),"entryInfo");return t}))}return this._mLoadedWrappers.get(i).then(function(t){var n=t.getContent()[1];var s=n.getSelectedKey();var r=n.getItems().findIndex(function(e){return e.getId()===s});if(r>-1){var i=e.tabs[r];this._emitEntryOpened(i.id)}return t}.bind(this))},_createErrorContent:function(e){return s.load({name:"sap.ushell.components.shell.Settings.ErrorContent"}).then(function(t){t.setModel(new r({errorMessage:e}));return t})},_navToBusyPage:function(){var e=this.getView();this._navToDetail(e.createId("userSettingBusyPage"),e)},_navToDetail:function(e,t){var n=t.byId("settingsApp");n.setBusy(false);n.toDetail(e);if(n.getMode()==="ShowHideMode"){n.hideMaster();this._updateHeaderButtonVisibility(false)}},_emitEntryOpened:function(e){var t=o.last("UserSettingsOpened")||{};t[e]=true;o.emit("UserSettingsOpened",t)},updateUserPreferences:function(){e.debug("[000] updateUserPreferences: ","UserSettings.controller");if(this._updateUserPreferencesPromise){return this._updateUserPreferencesPromise}var t,n;this._updateUserPreferencesPromise=new Promise(function(e,s){t=e;n=s});this._updateUserPreferencesPromise.sendRequest=function(){sap.ushell.Container.getServiceAsync("UserInfo").then(function(s){e.debug("[000] updateUserPreferences: sendRequest","UserSettings.controller");s.updateUserPreferences().done(t).fail(n).always(function(){e.debug("[000] updateUserPreferences: sendRequest: _updateUserPreferencesPromise","UserSettings.controller");this._updateUserPreferencesPromise=null}.bind(this))}.bind(this))}.bind(this);return this._updateUserPreferencesPromise},_maybeReload:function(t){var n=false;var s=false;var r=[];var i=[];t.forEach(function(e){if(e&&e.refresh){n=true}if(e&&e.noHash){s=true}if(e&&e.urlParams&&e.urlParams.length>0){r=r.concat(e.urlParams)}if(e&&e.obsoleteUrlParams&&e.obsoleteUrlParams.length>0){i=i.concat(e.obsoleteUrlParams)}});if(n){e.debug("[000]refresh browser with Parameters:",JSON.stringify(r),"UserSettings.controller");if(s){window.location=window.location.href.replace(window.location.hash,"")}else{u.refreshBrowser(r,i)}return true}},_handleSaveButtonPress:function(){d.removeErrorMessages();var t=this.getView().byId("userSettingsDialog");var n=a.last("/core/userPreferences/entries");var s=o.last("UserSettingsOpened")||{};if(Object.keys(s).length===0){this._handleSettingsDialogClose();this._showSuccessMessageToast();return Promise.resolve()}t.setBusy(true);var r=n.reduce(function(t,n){if(s[n.id]){e.debug("[000] _handleSaveButtonPress: oEntry.id: ",n.id,"UserSettings.controller");t.push(this._executeEntrySave(n))}return t}.bind(this),[]);e.debug("[000] _handleSaveButtonPress:_updateUserPreferencesPromise",this._updateUserPreferencesPromise,"UserSettings.controller");if(this._updateUserPreferencesPromise){this._updateUserPreferencesPromise.sendRequest()}return Promise.all(r).then(function(n){e.debug("[000] _handleSaveButtonPress: then save aResults",JSON.stringify(n),"UserSettings.controller");var s=d.filterMessagesToDisplay();var r={};var i="";var a="";t.setBusy(false);this._handleSettingsDialogClose();if(s.length>0){r=s[0];i=r.getDescription();o.emit("UserSettingsOpened",null);s.forEach(function(e){a+="Entry: "+e.getAdditionalText()+" - Error message: "+e.getDescription()+"\n"});e.error("Failed to save the following entries",a);if(this._maybeReload(n)){return}return sap.ushell.Container.getServiceAsync("Message").then(function(e){e.init();e.show(e.Type.ERROR,l.i18n.getText("userSettings.SavingError.SomeChanges"),{details:i})})}this._showSuccessMessageToast();o.emit("UserSettingsOpened",null);this._maybeReload(n)}.bind(this))},_executeEntrySave:function(t){var n,s;function r(e){return e||{}}function i(n){e.debug("[000] _onError: errorInformation",JSON.stringify(n),"UserSettings.controller");var s;var r=t.id;var i=t.title;if(!n){s=l.i18n.getText("userSettings.SavingError.Undefined")}else if(typeof n==="string"){s=n}else if(Array.isArray(n)){n.forEach(function(e){e.setAdditionalText(i);e.setTechnicalDetails({pluginId:r});d.addMessage(e)});return}else if(g.isA(n,"sap.ui.core.message.Message")){n.setAdditionalText(i);n.setTechnicalDetails({pluginId:r});d.addMessage(n);return}else{s=l.i18n.getText("userSettings.SavingError.WithMessage",[n.message])}d.addMessage(new c({type:p.Error,additionalText:i,technicalDetails:{pluginId:r},description:s,message:s}))}try{e.debug("[000] onSave: oEntry.id: "+t.id,"UserSettings.controller");this._isExecuteEntrySavedInUserSettingsController=true;n=t.onSave(this.updateUserPreferences.bind(this))}catch(e){return i(e)}if(n){if(n.promise){e.warning("jQuery.promise is used to save "+t.title+" settings entry.\n"+"The using of jQuery.promise for onSave is deprecated. Please use the native promise instead.");s=new Promise(function(e){n.done(function(t){e(r(t))}).fail(function(t){e(i(t))})})}else{s=n.then(r).catch(i)}}else{s=Promise.resolve();e.warning(t.title+" settings might not be saved correctly, it seems like the API contract is not correctly fullfilled.\n"+"Please contact the owner of the setting.")}return s},_showSuccessMessageToast:function(){sap.ui.require(["sap/m/MessageToast"],function(e){var t=l.i18n.getText("savedChanges");e.show(t,{offset:"0 -50"})})},_handleCancel:function(){var t=a.last("/core/userPreferences/entries");var n=o.last("UserSettingsOpened")||{};if(n){t.forEach(function(t){if(n[t.id]&&t.onCancel){try{t.onCancel()}catch(t){e.error("Failed to cancel the following entries",t)}}})}o.emit("UserSettingsOpened",null);this._handleSettingsDialogClose()},_handleSettingsDialogClose:function(){sap.ushell.Container.getUser().resetChangedProperties();if(i.system.phone){this.getView().byId("settingsApp").toMaster("settingsView--userSettingMaster")}this.getView().byId("userSettingsMessagePopoverBtn").setVisible(false);this.getView().byId("userSettingsDialog").close()},onExit:function(){this._oConfigDoable.off();i.orientation.detachHandler(this._fnOrientationChange,this)}})});
//# sourceMappingURL=UserSettings.controller.js.map