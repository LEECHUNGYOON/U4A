// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/elements/model","sap/ushell/components/applicationIntegration/Storage","sap/ushell/components/applicationIntegration/application/BlueBoxHandler","sap/ushell/ui5service/ShellUIService","sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/applicationIntegration/application/PostMessageUtils","sap/ushell/components/applicationIntegration/application/WebGUIStatefulHandler","sap/ushell/components/applicationIntegration/relatedServices/RelatedServices","sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements","sap/ushell/components/applicationIntegration/configuration/AppMeta","sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ui/Device","sap/ushell/Config","sap/ushell/ApplicationType","sap/base/util/deepExtend","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/base/Log","sap/ushell/EventHub","sap/ushell/utils/UrlParsing","sap/ui/core/Core","sap/ui/thirdparty/hasher","sap/ushell/services/_MessageBroker/MessageBrokerEngine","sap/ushell/renderer/utils","sap/m/library"],function(e,t,i,n,a,r,s,o,p,l,u,f,c,d,h,g,m,jQuery,C,v,A,I,y,S,T,E){"use strict";function b(){var c,b=["URL"],P,B,U,R=false,w=true,x={},L={home:{embedded:"embedded-home",headerless:"headerless-home",merged:"blank-home",blank:"blank-home"},app:{minimal:"minimal",app:"app",standalone:"standalone",embedded:"embedded",headerless:"headerless",merged:"merged",home:"home",blank:"blank",lean:"lean"}},F=[],O={},M={},D=false,H={FULL:"true",RESTRICTED:"restricted"},V;var _=E.URLHelper;if(window.QUnit===undefined){S.connect("FLP")}this.shellElements=function(){return p};this.service=function(){return o};this.isCurrentApp=function(e){return x.appId===e};this.setComponentCreatedPromise=function(e){if(!M[e]){M[e]={};M[e].promise=new Promise((t,i)=>{M[e].resolve=t;M[e].reject=i})}return M[e]};this.resolveComponentCreatedPromise=function(e){if(!e){return}this.setComponentCreatedPromise(e).resolve()};this.rejectComponentCreatedPromise=function(e){if(!e){return}this.setComponentCreatedPromise(e).reject("Component was not created for app "+e)};this.getComponentCreatedPromise=function(e){if(!e){return}return this.setComponentCreatedPromise(e).promise};this.isAppWithSimilarShellHashInCache=function(e,i){var n=t.get(e);if(n){if(n.shellHash===i){return true}return false}return false};this.isAppInCache=function(e){return!!t.get(e)};this.normalizeAppId=function(e){var t="-component",i=e.endsWith(t);if(i){return e.substring(0,e.length-t.length)}return e};this.onComponentCreated=function(e,i,n){var a=n.component,r=this.normalizeAppId(a.getId());if(this.isAppInCache(r)){t.get(r).app=a;this.active(r)}else{x.app=a;if(a.active){a.active()}}this.resolveComponentCreatedPromise(r)};this.onGetMe=function(e,t,i){i.AppLifeCycle=this};this.store=function(e){var i=t.get(e);if(i){a.store(i);i.stateStored=true}};this.destroyApplication=function(e,n,r,s){var o=t.get(e),u;if(!e||!n){return}function f(){i.deleteBlueBoxByContainer(n);a.destroy(n);p.destroy(n);l.destroy(n)}if(s===true){t.removeByContainer(n);this.removeControl(e);f();if(r){r.resolve()}return}if(o){t.removeById(e);if(i.isStatefulContainer(o.container)){u=i.statefulDestroyApp(o.container,e)}else if(!i.returnUnusedKeepAliveContainer(o.container)){this.removeControl(e);i.deleteBlueBoxByContainer(o.container);o.container.destroy();u=Promise.resolve()}else{u=this.handleExitStateful(e,o.container,false)}if(r){u.then(r.resolve)}}else{this.removeControl(e);var c=n&&n.sendBeforeAppCloseEvent&&n.sendBeforeAppCloseEvent();if(c===undefined){f();if(r){r.resolve()}}else{c.then(function(){f();if(r){r.resolve()}},function(e){f();if(r){r.resolve()}C.error("FLP got a failed response from the iframe for the 'sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent' message sent",e,"sap.ushell.components.applicationIntegration.AppLifeCycle.js")})}}};this.restore=function(e){var i=t.get(e);if(i&&i.stateStored===true){o.restore(i.service);l.restore();a.restore(i)}};this.active=function(e){var i=t.get(e);if(i){a.active(i.app)}};this.handleExitStateful=function(e,n,a,r){var s=n.getCurrentAppId&&n.getCurrentAppId();if(t.get(s)){if(o.isBackNavigation()===true&&!a||r===true){I.getEventBus().publish("sap.ushell","appClosed",n);t.removeById(s);return i.statefulDestroyApp(n)}I.getEventBus().publish("sap.ushell","appClosed",n);return i.statefulStoreKeepAliveApp(n,s)}return i.statefulDestroyApp(n)};this.handleExitApplication=function(e,n,a,s,p,l){var u=this,f,c,d;if(a&&s&&s.getIframeReusedForApp&&s.getIframeReusedForApp()===true){s.setProperty("iframeReusedForApp",false,true);r.postMessageToIframeApp(s,"sap.ushell.sessionHandler","afterApplicationShow",{},false)}if(p===false&&l===true&&(i.isStatefulContainer(n)||i.isStatefulContainerInKeepAlivePool(n))){return(new jQuery.Deferred).resolve().promise()}if(n&&n.getCurrentAppId&&n.getCurrentAppId()){e=n.getCurrentAppId()}if(e&&n){if(i.isStatefulContainer(n)){c=this.handleExitStateful(e,n,p)}else if(t.get(e)){if(o.isBackNavigation()===true&&!p){if(!i.returnUnusedKeepAliveContainer(n)){d=new jQuery.Deferred;this.destroyApplication(e,n,d);c=d.promise()}else{c=this.handleExitStateful(e,n,p)}}else if(n.getApplicationType()==="UI5"){c=this.getComponentCreatedPromise(e).then(()=>{this.store(e)})}else{this.store(e)}I.getEventBus().publish("sap.ushell","appClosed",n)}else if(n.getStatefulType&&n.getStatefulType()===i.STATEFUL_TYPES.GUI_V1){if(p){c=r.postMessageToIframeApp(n,"sap.gui","triggerCloseSessionImmediately")}}else{f=b.indexOf(n.getApplicationType)>=0;var h=this.isAppOfTypeCached(e,f);if(h===false){d=new jQuery.Deferred;this.destroyApplication(e,n,d);c=d.promise()}}if(p===true){if(c===undefined){this.closeKeepAliveApps(N)}else{c.then(function(){u.closeKeepAliveApps(N)})}}if(e.indexOf("Shell-appfinder-component")>0){I.getEventBus().publish("sap.ushell","appFinderAfterNavigate")}}I.getEventBus().publish("relatedServices","resetBackNavigation");if(c===undefined){c=(new jQuery.Deferred).resolve().promise()}return c};function N(e){return e.keepAliveMode===H.RESTRICTED}this.closeKeepAliveApps=function(e,n){try{var a=this,r=[];t.forEach(function(t){if(e.apply(this,[t])===true){r.push(t)}});r.forEach(function(e){var t;var r=!i.returnUnusedKeepAliveContainer(e.container);if(r){if(n){t=new jQuery.Deferred;n.push(t.promise())}a.destroyApplication(e.appId,e.container,t)}else{t=a.handleExitStateful(e.appId,e.container,true,true);if(n){n.push(t.promise())}}})}catch(e){C.error("Error: sap.ushell.services.appLifeCycle.closeOtherKeepAliveRestrictedApps:"+e)}};this.onBeforeNavigate=function(e,n){if(e&&n&&n._getIFrame&&n._getIFrame()&&(n.getStatefulType&&n.getStatefulType()>i.STATEFUL_TYPES.NOT_SUPPORTED)||t.get(e)){r.postMessageToIframeApp(n,"sap.ushell.sessionHandler","beforeApplicationHide",{},false)}};this.onAfterNavigate=function(e,i,n,r){var s=n.indexOf("Shell-appfinder-component")>0||n.indexOf("Shell-home-component")>0||n.indexOf("pages-component-container")>0||n.indexOf("homeApp-component-container")>0||n.indexOf("workPageRuntime-component-container")>0||n.indexOf("runtimeSwitcher-component-container")>0;this.handleExitApplication(e,i,n,r,s,true);if(s===true){a.setActiveAppContainer(undefined)}if(n){if(t.get(n)){this.restore(n)}else{}}};this.storeApp=function(e,i,n,a,r){if(!this.isAppInCache(e)){if(i.setProperty){i.setProperty("isKeepAlive",true,true)}t.set(e,{service:{},shellHash:a,appId:e,stt:"loading",appRelatedElements:p.getAppRelatedElement(),container:i,meta:u.getMetadata(n),app:undefined,keepAliveMode:r&&(r.globalValue||r.paramValue),appTarget:n,ui5ComponentName:n&&n.ui5ComponentName,enableRouterRetrigger:w,stateStored:false});return true}return false};this.storeAppExtensions=async function(){const e=this.getCurrentApplication();if(!e){return}const i=e.appId;const n=t.get(i);if(!n){return}o.store(n.service);l.store(n.meta)};this.changeAppKeepAliveStatus=function(e,n){var a,r;if(f.isSAPLegacyApplicationType(e.getApplicationType(),e.getFrameworkId())&&n.bKeepAlive===true&&e.getIsKeepAlive()===false){a=A.parseShellHash(y.getHash());r="application-"+a.semanticObject+"-"+a.action;if(!t.get(r)&&i.changeAppContainerToKeepAlive(e)){this.storeApp(r,e,e.getCurrentAppTargetResolution(),y.getHash(),{paramValue:H.RESTRICTED})}}};this.isAppOfTypeCached=function(e,t,i){var n;if(e==="application-Shell-startIntent"){return false}if(!R&&e.indexOf(P)!==-1){return true}if(!R&&e.indexOf("Shell-appfinder")!==-1){return true}n=m.fromURL(window.location.href).get("sap-keep-alive");if(n===H.FULL||n===H.RESTRICTED){if(i){i.globalValue=n}return true}return false};this.isCachedEnabledAsAppParameter=function(e,t,i){var n;if(e&&e.semanticObject==="Shell"&&e.action==="startIntent"){return false}n=e&&e.params&&e.params["sap-keep-alive"];if(n===H.FULL||n===H.RESTRICTED){if(i){i.paramValue=n}return true}if(t&&t.url){n=m.fromURL(t.url).get("sap-keep-alive");if(n===H.FULL||n===H.RESTRICTED){if(i){i.paramValue=n}return true}}return false};this.calculateAppType=function(e){if(e.applicationType==="URL"&&e.additionalInformation&&e.additionalInformation.startsWith("SAPUI5.Component=")){return"SAPUI5"}return e.applicationType};this.reloadCurrentApp=function(e){var n=i.getBlueBoxById(e.sAppContainerId);if(n){var a=n.getUrl();i.removeCapabilities(n);t.removeByContainer(n);this.destroyApplication(e.sAppContainerId,n);i.deleteBlueBoxByUrl(a)}sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(t){try{t.hashChanger.treatHashChanged(e.sCurrentHash)}catch(e){C.error("Error when trying to re-load the current displayed application",e,"sap.ushell.services.AppLifeCycle")}})};this.openApp=function(e,n,r,s){var o,p,l=b.indexOf(n.applicationType)>=0,f,c,d,h={globalValue:undefined,paramValue:undefined};var g="application"+e;o=i.getBlueBoxByUrl(n.url);var m=this.isAppOfTypeCached(g,l,h);var C=this.isCachedEnabledAsAppParameter(r,n,h);if(i.isStatefulContainer(o)){if(m||C){if(!this.isAppInCache(g)){this.storeApp(g,o,n,s,h)}if(this.isAppInCache(g)){x=t.get(g)}}else{x={appId:g,stt:"loading",container:o,meta:u.getMetadata(n),app:undefined}}}else if(m||C){if(!this.isAppInCache(g)){c=i.findFreeContainerForNewKeepAliveApp(n);if(!c){p=r.semanticObject+"-"+r.action;f=i.getBlueBoxById("application-"+p)||this.getControl(p);if(f){d=f.getUrl();i.removeCapabilities(f);this.destroyApplication("application-"+p,f);i.deleteBlueBoxByUrl(d)}o=a.createApplicationContainer(e,n)}else{o=c}this.storeApp(g,o,n,s,h)}if(this.isAppInCache(g)){x=t.get(g)}}else if(n.applicationType==="TR"||n.appCapabilities&&n.appCapabilities.appFrameworkId==="GUI"){o=i.getBlueBoxByUrl(n.url);if(o&&o.getStatefulType&&o.getStatefulType()!==i.STATEFUL_TYPES.GUI_V1){o=undefined}if(r){p=r.semanticObject+"-"+r.action;f=i.getBlueBoxById("application-"+p)||this.getControl(p);if(f&&(!o||f!==o)){d=f.getUrl();i.removeCapabilities(f);this.destroyApplication("application-"+p,f);i.deleteBlueBoxByUrl(d)}}if(!o){o=a.createApplicationContainer(e,n)}x={appId:g,stt:"loading",container:o,meta:u.getMetadata(n),app:undefined}}else{if(o){p=r.semanticObject+"-"+r.action;this.removeApplication(p)}else if(n.applicationType==="URL"||n.applicationType==="TR"||n.applicationType==="NWBC"){p=r.semanticObject+"-"+r.action;f=i.getBlueBoxById("application-"+p)||this.getControl(p);if(f){d=f.getUrl();i.removeCapabilities(f);this.destroyApplication("application-"+p,f,undefined,true);i.deleteBlueBoxByUrl(d)}}o=a.createApplicationContainer(e,n);x={appId:g,stt:"loading",container:o,meta:u.getMetadata(n),app:undefined}}};this.getAppMeta=function(){return l};this.addEvents=function(){var e=false;return function(){if(!e){e=true;var i=this;v.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){var i=e.intent.semanticObject+"-"+e.intent.action;var n="application-"+i;w=e.disable;if(t.get(n)){t.get(n).enableRouterRetrigger=e.disable}});v.on("setApplicationFullWidth").do(function(e){i.setApplicationFullWidth(e.bValue)});v.on("reloadCurrentApp").do(function(e){i.reloadCurrentApp(e)})}}}();this.init=function(e,t,s,o,u,h){if(sap.ushell&&sap.ushell.Container&&d.last("/core/shell/enablePersistantAppstateWhenSharing")){sap.ushell.Container.getServiceAsync("AppState").then(function(e){V=_.triggerEmail.bind(_);_.triggerEmail=function(t,i,n,a,r){var s=document.URL;e.setAppStateToPublic(s).done(function(e,s,o,p,l){i=i&&s&&p&&i.includes(s)?i.replace(s,p):i;i=i&&o&&l&&i.includes(o)?i.replace(o,l):i;n=n&&s&&p&&n.includes(s)?n.replace(s,p):n;n=n&&o&&l&&n.includes(o)?n.replace(o,l):n;V(t,i,n,a,r)}).fail(function(e,t,i,n,a){V(e,t,i,n,a)})}})}B=new n({scopeObject:u.ownerComponent,scopeType:"component"});U=e;c=t;P=s;l.init(P);R=o;i.init();a.init(i,r);r.init(a,i);this.registerShellCommunicationHandler({"sap.ushell.services.AppLifeCycle":{oRequestCalls:{create:{isActiveOnly:true,distributionType:["URL"]},destroy:{isActiveOnly:true,distributionType:["URL"]},store:{isActiveOnly:true,distributionType:["URL"]},restore:{isActiveOnly:true,distributionType:["URL"]}},oServiceCalls:{subscribe:{executeServiceCallFn:function(e){i.addCapabilities(e.oContainer,e.oMessageData.body);return(new jQuery.Deferred).resolve({}).promise()}},setup:{executeServiceCallFn:function(e){var t=e.oMessageData&&e.oMessageData.body,n=[],a=false;if(t){if(e.oContainer.getIsKeepAlive()===true&&f.isSAPLegacyApplicationType(e.oContainer.getApplicationType(),e.oContainer.getFrameworkId())){a=true}if(t.isStateful===true){if(a){e.oContainer.setProperty("statefulType",-i.STATEFUL_TYPES.FLP_V2,true)}else{n.push({action:"create",service:"sap.ushell.services.AppLifeCycle"});n.push({action:"destroy",service:"sap.ushell.services.AppLifeCycle"});e.oContainer.setProperty("statefulType",i.STATEFUL_TYPES.FLP_V2,true)}}if(t.isIframeValid===true){n.push({action:"iframeIsValid",service:"sap.ushell.appRuntime"})}if(t.session&&t.session.bLogoutSupport===true){n.push({action:"logout",service:"sap.ushell.sessionHandler"})}if(n.length>0){i.addCapabilities(e.oContainer,n)}}return(new jQuery.Deferred).resolve().promise()}}}},"sap.gui":{oServiceCalls:{loadFinished:{executeServiceCallFn:function(e){if(e.oContainer.getIsKeepAlive()===false){e.oContainer.setProperty("statefulType",i.STATEFUL_TYPES.GUI_V1,true);x={appId:e.oContainer.getId(),stt:"loading",container:e.oContainer,meta:undefined,app:undefined}}else{e.oContainer.setProperty("statefulType",-i.STATEFUL_TYPES.GUI_V1,true)}return(new jQuery.Deferred).resolve({}).promise()}}}}});I.getEventBus().subscribe("sap.ushell","appComponentLoaded",this.onComponentCreated,this);I.getEventBus().subscribe("sap.ushell","getAppLifeCycle",this.onGetMe,this);p.init(this.getElementsModel(),h);this.addEvents()};this.registerHandleHashChange=function(e){e.hashChanger.attachEvent("hashChanged",function(t){if(y.disableBlueBoxHashChangeTrigger===true){return}if(t.mParameters&&e.hashChanger.isInnerAppNavigation(t.mParameters.newHash,t.mParameters.oldHash)){r.postMessageToMultipleIframes("sap.ushell.appRuntime","innerAppRouteChange",{oHash:t.mParameters})}r.postMessageToMultipleIframes("sap.ushell.appRuntime","hashChange",{sHash:t.mParameters.fullHash})})};this.addControl=function(e){c.addCenterViewPort(e)};this.removeControl=function(e){var t=i.getBlueBoxById(e),n=i.isStatefulContainer(t);if(!n){c.removeCenterViewPort(e,true)}};this.removeApplication=function(e){var t=this.getControl(e);if(t){this.removeControl(t.getId());t.destroy()}};this.getControl=function(e){return c&&(c.getViewPortControl("centerViewPort","application-"+e)||c.getViewPortControl("centerViewPort","applicationShellPage-"+e))};this.getViewPortContainer=function(){return c};this.navTo=function(e){c.navTo("centerViewPort",e,"show")};this.getCurrentApplication=function(){return x};this.unsetCurrentApplication=function(){x={}};this.setApplicationFullWidth=function(e){var t=this.getCurrentApplication();if(t.container){t.container.toggleStyleClass("sapUShellApplicationContainerLimitedWidth",!e)}};this.createComponent=function(e,t){function i(t){return t.ui5ComponentName===e.ui5ComponentName}var n=[],r=new jQuery.Deferred;this.shellElements().setDangling(true);this.closeKeepAliveApps(i,n);Promise.all(n).then(function(){a.createComponent(e,t).done(r.resolve).fail(r.reject)});return r.promise()};this.getAppContainer=function(e,t,i,n,a){t.shellUIService=B.getInterface();t.targetNavigationMode=i?"explace":"inplace";this.openApp(e,t,n,a);if(F.length>0){x.container.registerShellCommunicationHandler(F)}if(O.UI5APP){x.container.setIframeHandlers(O.UI5APP)}return x.container};this.getShellUIService=function(){return B};this.initShellUIService=function(e){B._attachHierarchyChanged(l.onHierarchyChange.bind(this));B._attachTitleChanged(l.onTitleChange.bind(this));B._attachRelatedAppsChanged(l.onRelatedAppsChange.bind(this));B._attachBackNavigationChanged(e.fnOnBackNavigationChange.bind(this))};this.getElementsModel=function(){return e};this.activeContainer=function(e){i.forEach(function(t){if(t&&t!==e){try{C.info("Deactivating container "+t.getId());t.setActive(false)}catch(e){}}});if(e){C.info("Activating container "+e.getId());e.setActive(true)}};this.showApplicationContainer=function(e){this.navTo(e.getId());if(e.hasStyleClass("sapUShellApplicationContainerShiftedIframe")){e.toggleStyleClass("sapUShellApplicationContainerIframeHidden",false)}else{e.toggleStyleClass("hidden",false)}a.setActiveAppContainer(e);C.info("New application context opened successfully in an existing transaction UI session.")};this.initAppMetaParams=function(){if(!this.getAppMeta().getIsHierarchyChanged()){B.setHierarchy()}if(!this.getAppMeta().getIsTitleChanged()){var e=y.getHash();if(e&&e.indexOf("Shell-startIntent")===0){B.setTitle("",true)}else{B.setTitle()}}if(!this.getAppMeta().getIsRelatedAppsChanged()){B.setRelatedApps()}if(!D){B.setBackNavigation()}};this.publishNavigationStateEvents=function(e,t,i){var n,a=e.getId?e.getId():"",r=this;var s=u.getMetadata(),o=s.icon,p=s.title;e.addEventDelegate({onAfterRendering:i});n=e.exit;e.exit=function(){if(n){n.apply(this,arguments)}r.getAppMeta()._applyContentDensityByPriority();setTimeout(function(){var e=g({},t);delete e.componentHandle;e.appId=a;e.usageIcon=o;e.usageTitle=p;I.getEventBus().publish("sap.ushell","appClosed",e);C.info("app was closed")},0);var e=r._publicEventDataFromResolutionResult(t);T.publishExternalEvent("appClosed",e)}};this._publicEventDataFromResolutionResult=function(e){var t={};if(!e){return e}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(i){t[i]=e[i]});Object.freeze(t);return t};this.getInMemoryInstance=function(e,i,n,a){var r="application-"+e,s=t.get(r),o="",p=false,l;if(s){if(a!==null&&a!==undefined&&a!==""){o=a.toLowerCase();p=o.indexOf("shell-home")>=0||o.indexOf("launchpad-openflppage")>=0||o.indexOf("launchpad-openworkpage")>=0||o.indexOf("shell-appfinder")>=0}l=p&&(typeof n==="string"&&n.length>0);if(s.shellHash===i&&!l){return{isInstanceSupported:true,appId:s.appId,container:s.container}}return{isInstanceSupported:false,appId:s.appId,container:s.container}}return{isInstanceSupported:false,appId:undefined,container:undefined}};this.handleOpenStateful=function(e,n,a,r,s,o,p,l,u){var f=this,c;r.setProperty("iframeReusedForApp",true,true);if(t.get(a)&&e===false&&!u){c=i.statefulRestoreKeepAliveApp(r,s.url,a,s,l).then(function(){f.showApplicationContainer(r)},function(e){C.error(e&&e.message||e)})}else{this.initAppMetaParams();c=i.statefulCreateApp(r,s.url,a,s,l).then(function(e){if(e&&e.deletedKeepAliveId){t.removeById(e.deletedKeepAliveId)}f.showApplicationContainer(r)},function(e){C.error(e&&e.message||e)});if(n&&!this.isAppInCache(a)){this.storeApp(a,r,s,o,p)}}return c};this.handleControl=function(e,n,a,r,o,p,l){var d=this,g,m,v=false,y=false,S=b.indexOf(r.applicationType)>=0,T="application-"+e,E,P,B,U=false,R,w,L,F=new jQuery.Deferred,O,M,D,H,V,_=(new jQuery.Deferred).resolve().promise(),N={globalValue:undefined,paramValue:undefined},k,K,W,j,G=false;V=i.getBlueBoxByUrl(r.url);if(i.isStatefulContainer(V)){k=(new Date).getTime()-V.getIsIframeValidTime().time;if(i.isIframeIsValidSupported(V)&&k>=3500||V.getIsInvalidIframe()===true){var Y=V.getIsInvalidIframe()===true?"iframe did not ping in the last '"+k+"' ms":"iframe is in invalid state";C.warning("Destroying statefull container iframe due to unresponsiveness ("+V.getId()+")","reason: "+Y,"sap.ushell.components.applicationIntegration.AppLifeCycle");i.removeCapabilities(V);this.destroyApplication(T,V);i.deleteBlueBoxByUrl(r.url);V=undefined;l=undefined}}if(typeof l==="string"){K=A.parseShellHash(l);if(K){W="application-"+K.semanticObject+"-"+K.action;H=t.get(W)}if(H){D=H.container}else{j=c.getCurrentCenterPage?c.getCurrentCenterPage():undefined;if(j){D=I.byId(j)}}}m=i.isStatefulContainer(D);var z=i.isStatefulContainerInKeepAlivePool(D)&&D.getCurrentAppId&&D.getCurrentAppId().length>0;if(m||z){_=this.handleExitApplication(W,D,undefined,undefined,false,false);if(D===V){G=true}}_.then(function(){P=d.isAppOfTypeCached(T,S,N)||d.isCachedEnabledAsAppParameter(a,r,N);B=d.calculateAppType(r);R=h.getDefaultFullWidthSetting(B);g=i.getBlueBoxByUrl(r.url);m=i.isStatefulContainer(g);if(!m){if(x&&T!==x.appId){g=undefined}E=t.get("application"+n);if(E){g=E.container;if(!m&&P&&g!==undefined){w=true}}}var l,C;l=r.appCapabilities&&r.appCapabilities.fullWidth;M=u.getMetadata(r);if(R===true){if(r.fullWidth===false||r.fullWidth==="false"||M.fullWidth===false||M.fullWidth==="false"||l===false){C=false}}else if(r.fullWidth===true||r.fullWidth==="true"||M.fullWidth===true||M.fullWidth==="true"){C=true}if(C===undefined){C=R}if(m){if(!g){g=o(e,M,a,r,n,C,p);if(this.isAppInCache(g.getId())){x=t.get(g.getId())}d.navTo(g.getId());U=true}}else if(i.getStatefulContainerType(r.url,true)!==i.STATEFUL_TYPES.GUI_V1&&g&&!P){L=new jQuery.Deferred;d.destroyApplication(g.getId(),g,L);L.then(function(){g=o(e,M,a,r,n,C,p)})}else if(!g){g=o(e,M,a,r,n,C,p);if(g.getIsFetchedFromCache&&g.getIsFetchedFromCache()&&g.getStatefulType){if(g.getStatefulType()===-i.STATEFUL_TYPES.GUI_V1){y=true}else{m=true;v=true}}}if(L===undefined){L=(new jQuery.Deferred).resolve()}if(g&&g.getDeffedControlCreation){O=g.getDeffedControlCreation()}else{O=Promise.resolve()}L.then(function(){O.then(function(){if(g.getStatefulType&&g.getStatefulType()!==i.STATEFUL_TYPES.GUI_V1&&!m){if(w===true){I.getEventBus().publish("launchpad","appOpening",r)}if(d.isAppInCache(g.getId())){x=t.get(g.getId())}d.navTo(g.getId());if(w===true){d.initAppMetaParams();I.getEventBus().publish("sap.ushell","appOpened",r)}}var e=(new jQuery.Deferred).resolve().promise();if(g.getApplicationType()===h.TR.type){d.activeContainer(g)}if(m){if(r.appCapabilities&&r.appCapabilities.appFrameworkId==="UI5"){g.setProperty("active",true,true)}e=d.handleOpenStateful(U,P,"application"+n,g,r,p,N,G,v)}else if(g.getStatefulType&&g.getStatefulType()===i.STATEFUL_TYPES.GUI_V1||y){e=s.guiStatefulCreateApp(d,g,r)}e.then(function(){c.switchState("Center");f.setPerformanceMark("FLP -- centerViewPort");if(g.getApplicationType()!==h.TR.type){d.activeContainer(g)}if(x.appId!==T){x={appId:T,stt:"loading",container:g,meta:u.getMetadata(r),app:undefined}}F.resolve()})})})});return F.promise()};this.switchViewState=function(i,n,a){var r=i,s;if(L[i]&&L[i][U]){r=L[i][U]}var o=d.last("/core/shell/model/currentState/stateName")==="home";if(!o&&(!x.appId||!t.get(x.appId))){e.destroyManageQueue()}s=t.get("application"+a);if(s){p.restore(s)}else{p.assignNew(i)}e.switchState(r,n,a);this.shellElements().setDangling(false);this.shellElements().processDangling();if(i==="searchResults"){this.getElementsModel().setProperty("/lastSearchScreen","");if(!y.getHash().indexOf("Action-search")===0){var l=I.getModel("searchModel");y.setHash("Action-search&/searchTerm="+l.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(l.getProperty("/uiFilter/dataSource").getJson()))}}};this.registerShellCommunicationHandler=function(e){a.registerShellCommunicationHandler(e)};this.registerIframeCommunicationHandler=function(e,t){O[t]=e};this.setBackNavigationChanged=function(e){D=e};this.getBackNavigationChanged=function(){return D}}return new b},true);
//# sourceMappingURL=AppLifeCycle.js.map