// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/application/BlueBoxesCache","sap/ushell/components/applicationIntegration/application/PostMessageUtils","sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/thirdparty/hasher","sap/base/Log","sap/ushell/utils"],function(e,t,jQuery,r,s,i,p){"use strict";function a(){var i={},a=[{service:"sap.ushell.services.AppLifeCycle",action:"create"},{service:"sap.ushell.services.AppLifeCycle",action:"destroy"}];this.STATEFUL_TYPES={NOT_SUPPORTED:0,GUI_V1:1,FLP_V2:2};this.init=function(){i={};e.init()};this.AddNewBlueBox=function(t,r,s){i[t]=t;e.add(r.url,t);if(t.setBlueBoxCapabilities){t.setProperty("blueBoxCapabilities",{},true)}if(s){this.addCapabilities(t,s)}};this.deleteBlueBoxByUrl=function(t){if(t){var r=e.get(t);if(r&&i[r]){delete i[r]}e.remove(t)}};this.deleteBlueBoxByContainer=function(t){if(t&&i[t]){delete i[t];e.removeByContainer(t)}};this.getBlueBoxesCount=function(){return Object.keys(i).length+e.getSize(true)};this.getBlueBoxByUrl=function(t){return e.get(t)};this.getBlueBoxById=function(t){return e.getById(t)};this.addCapabilities=function(e,t){if(!i[e]||!e.getBlueBoxCapabilities){return}var r=e.getBlueBoxCapabilities();t.forEach(function(e){if(e.service==="sap.ushell.services.appLifeCycle"){e.service="sap.ushell.services.AppLifeCycle"}r[e.service+"."+e.action]=true});if(r["sap.ushell.services.AppLifeCycle.create"]){e.setProperty("statefulType",this.STATEFUL_TYPES.FLP_V2,true)}};this.removeCapabilities=function(e,t){if(!i[e]||!e.getBlueBoxCapabilities){return}if(!t){e.setProperty("blueBoxCapabilities",{},true)}else{var r=e.getBlueBoxCapabilities();t.forEach(function(t){delete r[t.service+"."+t.action];if(t.service+"."+t.action==="sap.ushell.services.AppLifeCycle.create"){e.setProperty("statefulType",0-e.getStatefulType(),true)}})}};this.statefulCreateApp=function(e,i,a,n,u){var l=new jQuery.Deferred,o,c;function f(){if(o){o["sap-flp-url"]=sap.ushell.Container.getFLPUrl(true);o["system-alias"]=e.getSystemAlias();c["sap-flp-params"]=o}r.getEventBus().publish("launchpad","appOpening",n);t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","create",c,true).then(function(t){sap.ushell.Container.getServiceAsync("AppLifeCycle").then(function(s){if(u===true){s.prepareCurrentAppObject("URL",undefined,false,e)}r.getEventBus().publish("sap.ushell","appOpened",n);l.resolve(t&&t.body&&t.body.result)})})}e.setProperty("reservedParameters",n.reservedParameters,true);e.setProperty("currentAppUrl",i,true);e.setProperty("currentAppId",a,true);e.setProperty("currentAppTargetResolution",n,true);if(e._checkNwbcUrlAdjustment){i=e._checkNwbcUrlAdjustment(e,n.applicationType,i)}c={sCacheId:a,sUrl:i,sHash:s.getHash()};if(i.indexOf("sap-iframe-hint=GUI")>0||i.indexOf("sap-iframe-hint=WDA")>0||i.indexOf("sap-iframe-hint=WCF")>0){var h=p.getParamKeys(i);if(h.aAppStateNamesArray.length>0){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){e.getAppStateData(h.aAppStateKeysArray).then(function(e){o={};h.aAppStateNamesArray.forEach(function(t,r){if(e[r][0]){o[t]=e[r][0]}});f()},function(){f()})})}else{o={};f()}}else{f()}return l.promise()};this.statefulDestroyApp=function(e,s){var i,p;e.setProperty("currentAppUrl","",true);e.setProperty("currentAppId","",true);p=e.getCurrentAppTargetResolution();e.setProperty("currentAppTargetResolution",undefined,true);sap.ushell.Container.setAsyncDirtyStateProvider(undefined);i=t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","destroy",{sCacheId:s},true);i.then(function(){r.getEventBus().publish("sap.ushell","appClosed",p)});return i};this.statefulStoreKeepAliveApp=function(e,s){var i,p;e.setProperty("currentAppUrl","",true);e.setProperty("currentAppId","",true);p=e.getCurrentAppTargetResolution();e.setProperty("currentAppTargetResolution",undefined,true);sap.ushell.Container.setAsyncDirtyStateProvider(undefined);i=t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","store",{sCacheId:s},true);i.then(function(){r.getEventBus().publish("sap.ushell","appClosed",p)});return i};this.statefulRestoreKeepAliveApp=function(e,i,p,a,n){return new Promise(function(u){e.setProperty("currentAppUrl",i,true);e.setProperty("currentAppId",p,true);e.setProperty("currentAppTargetResolution",a,true);r.getEventBus().publish("launchpad","appOpening",a);t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","restore",{sCacheId:p,sUrl:a.url,sHash:s.getHash()},true).then(function(){sap.ushell.Container.getServiceAsync("AppLifeCycle").then(function(t){if(n===true){t.prepareCurrentAppObject("URL",undefined,false,e)}r.getEventBus().publish("sap.ushell","appOpened",a);u()})})})};this.isCapabilitySupported=function(e,t,r){if(e&&e.getBlueBoxCapabilities&&e.getBlueBoxCapabilities()[t+"."+r]){return true}return false};this.isStatefulContainer=function(e){return this.isCapabilitySupported(e,"sap.ushell.services.AppLifeCycle","create")};this.isIframeIsValidSupported=function(e){return this.isCapabilitySupported(e,"sap.ushell.appRuntime","iframeIsValid")};this.isStatefulContainerInKeepAlivePool=function(e){return!!(e&&e.getStatefulType&&e.getStatefulType()<this.STATEFUL_TYPES.NOT_SUPPORTED)};this.findFreeContainerForNewKeepAliveApp=function(t){if(!t){return undefined}if(!p.isSAPLegacyApplicationType(t.applicationType,t.appCapabilities&&t.appCapabilities.appFrameworkId)){return undefined}var r;var s=t.url.replaceAll("sap-keep-alive","sap-temp");r=e.get(s,true);if(r){i[r]=r}else{r=e.get(s);if(r&&r.getStatefulType()>this.STATEFUL_TYPES.NOT_SUPPORTED){if(r.getStatefulType()===this.STATEFUL_TYPES.FLP_V2){this.removeCapabilities(r,a)}else{r.setProperty("statefulType",0-r.getStatefulType(),true)}e.remove(s)}}if(r){e.add(t.url,r);r.setProperty("currentAppUrl","",true);r.setProperty("isFetchedFromCache",true,true)}return r};this.returnUnusedKeepAliveContainer=function(t){if(!t){return false}if(!p.isSAPLegacyApplicationType(t.getApplicationType&&t.getApplicationType(),t.getFrameworkId&&t.getFrameworkId())){return false}if(t.getStatefulType()<this.STATEFUL_TYPES.NOT_SUPPORTED){var r=t.getCurrentAppUrl();var s=e.getBlueBoxCacheKeyValues(r.replaceAll("sap-keep-alive","sap-temp")).sKey;var i=e.get(s);if(i){e.add(r.replaceAll("sap-keep-alive","sap-temp"),t,true);this.deleteBlueBoxByUrl(r)}else{e.remove(r);e.add(r.replaceAll("sap-keep-alive","sap-temp"),t);if(t.getStatefulType()===-this.STATEFUL_TYPES.FLP_V2){this.addCapabilities(t,a)}else{t.setProperty("statefulType",this.STATEFUL_TYPES.GUI_V1,true)}}t.setProperty("currentAppUrl","",true);t.setProperty("isFetchedFromCache",false,true);return true}return false};this.changeAppContainerToKeepAlive=function(t){if(!p.isSAPLegacyApplicationType(t.getApplicationType&&t.getApplicationType(),t.getFrameworkId&&t.getFrameworkId())){return false}t.setProperty("statefulType",-t.getStatefulType(),true);e.remove(t.getCurrentAppUrl());e.add(t.getCurrentAppUrl()+"&sap-keep-alive=restricted",t);return true};this.getStatefulContainerType=function(t,r){if(r===true){t=t.replaceAll("sap-keep-alive","sap-temp")}var s=e.get(t);if(s){return s.getStatefulType()}return this.STATEFUL_TYPES.NOT_SUPPORTED};this.forEach=function(t){Object.keys(i).forEach(function(e){t(i[e])});e.forEach(t)};this.destroyApp=function(e){t.postMessageToMultipleIframes("sap.ushell.services.appLifeCycle","destroy",{appId:e})};this.storeApp=function(e){t.postMessageToMultipleIframes("sap.ushell.services.appLifeCycle","store",{appId:e,sHash:s.getHash()})};this.restoreApp=function(e){t.postMessageToMultipleIframes("sap.ushell.services.appLifeCycle","restore",{appId:e,sHash:s.getHash()})};this._getStorageForDebug=function(){return{oBlueBoxContainer:i,oBlueBoxesCache:e._getStorageForDebug()}}}return new a},true);
//# sourceMappingURL=BlueBoxHandler.js.map