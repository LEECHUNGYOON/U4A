// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/hasher","sap/base/util/ObjectPath","sap/ushell/utils","sap/ushell/User","sap/ui/core/Configuration","sap/ushell/Config","sap/ui/thirdparty/URI","sap/ui/core/routing/History","sap/ushell/_ApplicationType/utils","sap/base/util/deepClone"],function(e,a,t,n,r,i,s,o,p,l,u){"use strict";var d=new o(document.URL).search(true),c=d["iframe-url"];function m(n,r,i){return new Promise(function(r){sap.ui.require(["sap/ushell/URLTemplateProcessor"],function(i){var s=n.inbound;var o=s.templateContext;var p=o.payload.capabilities||{};if(sap?.cf?.config?.siteId!==undefined&&o?.siteAppSection["sap.integration"]?.navMode==="inplace"){e.warning("URL template's navigationMode capability is ignored! navigationMode is forced to 'embedded'.");p.navigationMode="embedded"}if(n.mappedIntentParamsPlusSimpleDefaults&&n.mappedIntentParamsPlusSimpleDefaults.hasOwnProperty("sap-ushell-innerAppRoute")){var d=a.getHash();if(n.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"].length>0&&d.indexOf("&/")===-1){d+="&/"+n.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"];a.replaceHash(d)}}var m={innerAppRoute:T(o)||n.parsedIntent.appSpecificRoute,targetNavMode:R(n),defaultParameterNames:n.mappedDefaultedParamNames,startupParameter:n.mappedIntentParamsPlusSimpleDefaults,remoteApplication:{remoteSO:undefined,remoteAction:undefined}};S().then(function(a){m.env=a;var d=t.get(["sap.integration","urlTemplateParams","query"],o.siteAppSection)||{};if(d.hasOwnProperty("sap-cssurl")){m.env.themeServiceRoot=undefined;m.env.theme=undefined}if(p.appFrameworkId==="UI5"&&m.startupParameter){for(var A in m.startupParameter){if(A!=="sap-ushell-innerAppRoute"){m.startupParameter[A][0]=encodeURIComponent(m.startupParameter[A][0])}if(A==="sap-shell-so"){m.remoteApplication.remoteSO=m.startupParameter[A][0]}if(A==="sap-shell-action"){m.remoteApplication.remoteAction=m.startupParameter[A][0]}}if(n.mappedDefaultedParamNames&&n.mappedDefaultedParamNames.length>0){var P=n.mappedDefaultedParamNames.filter(function(e){return e!=="sap-shell-so"&&e!=="sap-shell-action"&&e!=="sap-system"});m.startupParameter["sap-ushell-defaultedParameterNames"]=[JSON.stringify(P)]}delete m.startupParameter["sap-shell-so"];delete m.startupParameter["sap-shell-action"]}var w="/universal_search/search";var b=m.innerAppRoute&&m.innerAppRoute.indexOf(w);var S;if(b===0){S=m.innerAppRoute.substring(1);m.innerAppRoute="/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE"}var T=i.expand(o.payload,o.site,m,o.siteAppSection,"startupParameter");if(b===0){T=T.replace("/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE","/"+S)}if(m.env.theme===undefined){T=T.replace("&sap-theme=","")}if(p.appFrameworkId==="UI5"&&U.getBrowserHash().length>1){T=T.split("#")[0]+U.getBrowserHash();e.debug("- created URL with fixed hash: "+T,"sap.ushell.ApplicationType")}var R=function(e){var a=u(o.payload,20);a.urlTemplate=e;return i.expand(a,o.site,m,o.siteAppSection,"startupParameter")};var I={applicationType:"URL",text:s.title,appCapabilities:y(p,o.siteAppSection,R),url:T,extendedInfo:l.getExtendedInfo(n,o.siteAppSection,o.site),contentProviderId:s.contentProviderId||"",systemAlias:o.siteAppSection["sap.app"]&&o.siteAppSection["sap.app"].destination||o.siteAppSection.destination||""};l.addIframeCacheHintToURL(I,I.appCapabilities.appFrameworkId);l.addKeepAliveToURLTemplateResult(I);f(I);h(I,o.siteAppSection,m);var L=new Promise(function(e){sap.ushell.Container.getServiceAsync("URLTemplate").then(function(a){sap.ui.require(["sap/ushell/components/applicationIntegration/application/BlueBoxesCache"],function(t){var n=t.get(I.url)===undefined;a.handlePostTemplateProcessing(I.url,o.siteAppSection,n).then(e)})})});L.then(function(e){if(c&&e.indexOf("ui5appruntime.html")>0){var a=e.split("?");a[0]=c;e=a.join("?")}I.url=e;v(i,I.url,p,o).then(function(e){I.url=e;if(I.url&&typeof I.url==="string"&&I.url.indexOf("sap-iframe-hint=GUI")>0){r(I)}else{g(I.url,m.targetNavMode,p).then(function(e){I.url=e;r(I)},function(){r(I)})}})})})})})}function f(e){if(e.url&&typeof e.url==="string"){let a=e.url,t=s.last("/core/spaces/enabled"),n=a.indexOf("ui5appruntime.html")>-1,r=a.indexOf("ui5appruntimescube.html")>-1;if(t===true&&(n||r)){l.appParameterToUrl(e,"sap-spaces",t)}}}function h(e,a,t){var r=n.getMember(a,"sap|integration.urlTemplateId");if(r==="urltemplate.url-dynamic"&&e.url.indexOf("sap-language=")===-1){l.appParameterToUrl(e,"sap-language",t.env.language)}}function g(e,a,t){return new Promise(function(n,r){var i=new o(e);var s=i.query(true);var p=true;var l=["sap-language","sap-theme","sap-shell","sap-ui-app-id","transaction","sap-iframe-hint","sap-keep-alive","sap-ui-versionedLibCss","sap-wd-configId","wcf-target-id"];if(t&&t.mandatoryUrlParams){l=l.concat(t.mandatoryUrlParams.split(","));l=l.filter(function(e,a){return l.indexOf(e)===a})}if(a==="explace"){p=false}sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(a){a.compactParams(s,l,undefined,p).done(function(a){if(!a.hasOwnProperty("sap-intent-param")){n(e);return}var t;if(a["sap-theme"]){var r="sap-theme="+a["sap-theme"];a["sap-theme"]="sap-theme-temp-placeholder";i.query(a);t=i.toString();t=t.replace("sap-theme=sap-theme-temp-placeholder",r)}else{i.query(a);t=i.toString()}n(t)}).fail(function(e){r(e)})})})}function v(a,n,r,i){return new Promise(function(s){var p=r.urlTransformation||{enabled:false};if(A(a,p,i)){var l=new o(n);var u=p.transformations[0];var d=u.service.uri;var c=a.prepareExpandData({urlTemplate:"",parameters:{names:d.queryOptions}},{},{urlComponent:{query:l.query(),fragment:l.fragment()}},i.siteAppSection,"");var m=o.expand("{+rootPath}/{+resourcePath}{?queryParams*}",{rootPath:d.rootPath,resourcePath:d.resourcePath,queryParams:c.oResolvedParameters}).toString();sap.ui.require(["sap/ui/thirdparty/datajs"],function(a){a.read({requestUri:m,headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}},function(a){var r=t.get("transformAppLaunchQueryString.value",a);if(r===undefined){r=t.get("transformAppLaunchIntent.value",a)}if(r===undefined){r=t.get("transformAppLaunchQueryString.queryString",a)}e.info("URL Transformation Succeeded",JSON.stringify({URLBeforeTransformation:n,URLAfterTransformation:r}),"sap.ushell.ApplicationType");var i=u.sourceURLComponent;if(i===undefined){i="query"}if(i==="query"||i==="fragment"){n=l[i](r).toString()}else{e.error("The "+i+" component of the URL in URI.js is not transformed","","sap.ushell.ApplicationType")}s(n)},function(a){e.error("URL Transformation Failed",JSON.stringify(a),"sap.ushell.ApplicationType");s(n)})})}else{s(n)}})}function A(e,a,t){if(typeof a.enabled==="boolean"){return a.enabled}var n=e.prepareExpandData({urlTemplate:"",parameters:{names:{enabled:a.enabled}}},{},{},t.siteAppSection,"");return typeof n.oResolvedParameters.enabled==="boolean"?n.oResolvedParameters.enabled:false}function P(a,t){var r=n.getMember(t,"sap|integration.navMode");switch(r){case"inplace":if(["embedded","inplace","newWindowThenEmbedded"].includes(a)){return"embedded"}e.error("App-defined navigation mode was ignored","Application requests to be opened inplace, but the template's navigation mode doesn't allow!","sap.ushell.ApplicationType");return"newWindow";case"explace":if(["embedded","inplace","newWindowThenEmbedded"].includes(a)){return"newWindowThenEmbedded"}if(["standalone","explace","newWindow"].includes(a)){return"newWindow"}default:e.error("App-defined navigation mode is not valid!","Fallback to URL Template's capability","sap.ushell.ApplicationType");if(["embedded","inplace","newWindowThenEmbedded"].includes(a)){return"embedded"}return"newWindow"}}function w(e){if(["embedded","inplace","newWindowThenEmbedded"].includes(e)){return"embedded"}if(["standalone","explace","newWindow"].includes(e)){return"standalone"}}function y(e,a,t){var n=u(e);n.navigationMode=P(e.navigationMode,a);n.templateNavigationMode=w(e.navigationMode);n.appId=t(e.appId||"");n.technicalAppComponentId=t(e.technicalAppComponentId||"");n.appSupportInfo=a["sap.app"]&&a["sap.app"].ach;n.appFrameworkId=e.appFrameworkId;delete n.urlTransformation;return n}function b(){var e=a&&a.getHash();var t="";if(e&&e.length>0&&e.indexOf("sap-iapp-state=")>0){var n=/(?:sap-iapp-state=)([^&/\\]+)/.exec(e);if(n&&n.length===2){t=n[1]}}return t}function S(){return new Promise(function(e){Promise.all([sap.ushell.Container.getServiceAsync("UserInfo"),sap.ushell.Container.getServiceAsync("PluginManager"),n.getUi5Version()]).then(function(a){var t=a[0];var n=a[1];var o=a[2];var l=t.getUser();var u=l.getContentDensity()||(document.body.classList.contains("sapUiSizeCompact")?"compact":"cozy");var d=l.getTheme();if(d.indexOf("sap_")!==0){var c=r.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;d=l.getTheme(c)}var m=i.getLanguage&&i.getLanguage();var f=i.getSAPLogonLanguage&&i.getSAPLogonLanguage();var h=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";var g=0;if(s.last("/core/shell/sessionTimeoutIntervalInMinutes")>0){g=s.last("/core/shell/sessionTimeoutIntervalInMinutes")}var v=false;if(window["sap-ui-debug"]!==false&&window["sap-ui-debug"]!==undefined){v=window["sap-ui-debug"]}const A=s.last("/core/shell/enablePersonalization");e({language:m,logonLanguage:f,theme:d,themeServiceRoot:h,isDebugMode:v,ui5Version:o,contentDensity:u,sapPlugins:n._getNamesOfPluginsWithAgents(),innerAppState:b(),sessionTimeout:g,historyDirection:p.getInstance().getDirection()||"",enableShellPersonalization:A})})})}function T(t){var n=t.payload;var r;var i=a.getHash()||U.getBrowserHash();var s=i.indexOf("&/");var o=1;var p=false;if(t.siteAppSection?.["sap.integration"]?.urlTemplateId==="urltemplate.jam"){p=true}if(s>0){if(n&&n.capabilities&&n.capabilities.appFrameworkId==="UI5"){o=2}r=i.substring(s+o);try{if(!p&&r&&r.length>0){r=decodeURIComponent(r)}}catch(a){e.warning("inner route should be double encoded",a,"sap.ushell.ApplicationType.getInnerAppRoute")}}return r}function R(e){var a=e.targetNavigationMode;if(a===undefined||a===""){if(n.isColdStart()){a="explace"}else{a="inplace"}}return a}function I(){return window.location.hash}var U={generateURLTemplateResolutionResult:m,handleURLTransformation:v,getBrowserHash:I,_createEnv:S};return U});
//# sourceMappingURL=urlTemplateResolution.js.map