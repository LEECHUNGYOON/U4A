// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/utils/Deferred","sap/ui/core/Core","sap/ui/core/Configuration","sap/ui/core/ws/SapPcpWebSocket","sap/ui/model/json/JSONModel","sap/ui/thirdparty/datajs","sap/ushell/utils"],function(e,t,i,s,n,o,a,r){"use strict";const c="/sap/bc/apc/iwngw/notification_push_apc";const u=60;function f(f,l,d){const h=new o;const g=d&&d.config;const p={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getEmailSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}};const N=[];const _=[];const S=5e3;const T=6e3;const I={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,GET_EMAIL_SUPPORT_SETTINGS:10,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"};const v={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3};const m=new t;const C=new t;const b=m.promise();const y={};const P=10;let E=new Date;let R;let D;let O;let A;let B=false;let k=[];let U=false;let w=false;let F=true;let q="fetch";let G;let M=false;let L;let W=false;let H=true;let V;let X;let x=false;let $=false;let z=false;let J=[];let j;this.isEnabled=function(){if(!g.enabled||!g.serviceUrl){F=false;if(g.enabled&&!g.serviceUrl){e.warning("No serviceUrl was found in the service configuration")}}else{F=true}return F};this.init=function(){if(!U&&this.isEnabled()){i.getEventBus().subscribe("launchpad","sessionTimeout",this.destroy,this);j=this.fireInitialRequest();this.lastNotificationDate=new Date;this._setWorkingMode();U=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization()}i.getEventBus().subscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this.fireInitialRequest=async function(){return new Promise(e=>{const t={requestUri:g.serviceUrl+"/GetBadgeNumber()",headers:{"X-CSRF-Token":q}};a.request(t,t=>{if(t.response){this._updateCSRF(t.response)}e()},t=>{if(t.response){this._updateCSRF(t.response)}e()})})};this.fireODataRequest=async function(e){await j;if(e.headers&&e.headers["X-CSRF-Token"]){e.headers["X-CSRF-Token"]=q}a.request.apply(this,arguments)};this.fireODataRead=async function(e){await j;if(e.headers&&e.headers["X-CSRF-Token"]){e.headers["X-CSRF-Token"]=q}a.read.apply(this,arguments)};this._onSetConnectionToServer=function(e,t,i){if(i.active){this._resumeConnection()}else{this._closeConnection()}};this.getUnseenNotificationsCount=function(){return Promise.resolve(h.getProperty("/UnseenCount"))};this.getNotificationsCount=function(){return h.getProperty("/NotificationsCount")||"0"};this._createRequest=function(e){const t={"Accept-Language":s.getLanguageTag(),"X-CSRF-Token":this._getHeaderXcsrfToken()||"fetch"};return{requestUri:e,headers:t}};this.getNotificationsByTypeWithGroupHeaders=function(){const t=this._createRequest(this._getRequestURI(I.NOTIFICATIONS_BY_TYPE));return new Promise((i,s)=>{this.fireODataRequest(t,i,t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.NotificationsV2");s(t)}})})};this.getNotificationsGroupHeaders=function(){const t=this._createRequest(this._getRequestURI(I.NOTIFICATIONS_GROUP_HEADERS));return new Promise((i,s)=>{this.fireODataRequest(t,i,t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.NotificationsV2");s()}})})};this.getNotificationsBufferInGroup=function(t,i,s){if(x===true){const e=y[I.NOTIFICATIONS_IN_GROUP].slice(i,i+s);const t=JSON.stringify({"@odata.context":"$metadata#Notifications",value:e});return new Promise(e=>{window.setTimeout(()=>e(t),1e3)})}const n=this;const o={group:t,skip:i,top:s};const a=this._createRequest(this._getRequestURI(I.NOTIFICATIONS_IN_GROUP,o));return new Promise((t,i)=>{this.fireODataRequest(a,e=>{n._updateCSRF(e.response);t(e.value)},s=>{if(s.response&&s.response.statusCode===200&&s.response.body){n._updateCSRF(s.response);t(JSON.parse(s.response.body).value)}else{e.error("Notification service - oData executeAction failed: ",s,"sap.ushell.services.NotificationsV2");i()}})})};this.getNotificationsBufferBySortingType=function(t,i,s){if(x===true){const e=JSON.stringify({"@odata.context":"$metadata#Notifications",value:y[t].slice(i,i+s)});return new Promise(t=>window.setTimeout(()=>t(e),1e3))}const n=this;const o={skip:i,top:s};const a=this._createRequest(this._getRequestURI(t,o));return new Promise((t,i)=>{this.fireODataRequest(a,e=>{n._updateCSRF(e.response);t(e.value)},s=>{if(s.response&&s.response.statusCode===200&&s.response.body){n._updateCSRF(s.response);t(JSON.parse(s.response.body).value)}else{e.error("Notification service - oData executeAction failed: ",s,"sap.ushell.services.NotificationsV2");i()}})})};this.getNotifications=function(){if(L===v.FIORI_CLIENT||L===v.PACKAGED_APP){return this._readNotificationsData(false).then(()=>h.getProperty("/Notifications"))}return Promise.resolve(h.getProperty("/Notifications"))};this.executeBulkAction=function(e,t){return new Promise((i,s)=>{this.sendBulkAction(e,t).then(e=>{const t=[];const n=[];e.forEach(e=>{const i=e.NotificationId;if(e.Success){t.push(i)}else{n.push(i)}});const o={succededNotifications:t,failedNotifications:n};if(n.length){s(o)}else{i(o)}})})};this.dismissBulkNotifications=function(e){return this.sendBulkDismiss(e)};this.executeAction=function(t,i){const s=this;const n=g.serviceUrl+"/ExecuteAction";const o={NotificationId:t,ActionId:i};const a={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:G,"X-CSRF-Token":q}};return new Promise((n,o)=>{this.fireODataRequest(a,e=>{const t={isSucessfull:true,message:""};if(e&&e.response&&e.response.statusCode===200&&e.response.body){const i=JSON.parse(e.response.body);t.isSucessfull=i.Success;t.message=i.MessageText}n(t)},a=>{const r={isSucessfull:false,message:""};if(a.response&&a.response.statusCode===200&&a.response.body){const e=JSON.parse(a.response.body);r.isSucessfull=e.Success;r.message=e.MessageText;n(r)}else if(s._csrfTokenInvalid(a)&&$===false){s._invalidCsrfTokenRecovery(n,o,s.executeAction,[t,i])}else{e.error("Notification service - oData executeAction failed: ",a,"sap.ushell.services.NotificationsV2");o(a)}})})};this.sendBulkAction=function(t,i){const s=this;const n=g.serviceUrl+"/BulkActionByHeader";const o={ParentId:t,ActionId:i};const a={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:G,"X-CSRF-Token":q}};return new Promise((n,o)=>{this.fireODataRequest(a,e=>{let t;if(e&&e.response&&e.response.statusCode===200&&e.response.body){let i=JSON.parse(e.response.body);t=i.value}n(t)},a=>{if(a.response&&a.response.statusCode===200&&a.response.body){let e=JSON.parse(a.response.body);let t=e.value;n(t)}else if(s._csrfTokenInvalid(a)&&$===false){s._invalidCsrfTokenRecovery(n,o,s.sendBulkAction,[t,i])}else{e.error("Notification service - oData executeBulkAction failed: ",a.message,"sap.ushell.services.NotificationsV2");o()}})})};this.sendBulkDismiss=function(t){const i=this;const s=g.serviceUrl+"/DismissAll";const n={ParentId:t};const o={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:G,"X-CSRF-Token":q}};return new Promise((s,n)=>{this.fireODataRequest(o,()=>s(),o=>{if(o.response&&o.response.statusCode===200){s()}else if(i._csrfTokenInvalid(o)&&$===false){i._invalidCsrfTokenRecovery(s,n,i.sendBulkDismiss,[t])}else{const t=o?o.message:"";e.error("Notification service - oData executeBulkAction failed: ",t,"sap.ushell.services.NotificationsV2");n()}})})};this.markRead=function(t){const i=this;const s=g.serviceUrl+"/MarkRead";const n={NotificationId:t};const o={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:G,"X-CSRF-Token":q}};return new Promise((s,n)=>{this.fireODataRequest(o,()=>s(),o=>{if(i._csrfTokenInvalid(o)&&$===false){i._invalidCsrfTokenRecovery(s,n,i.markRead,[t])}else{e.error("Notification service - oData reset badge number failed: ",o,"sap.ushell.services.NotificationsV2");n(o)}})})};this.dismissNotification=function(t){const i=g.serviceUrl+"/Dismiss";const s=this;const n={NotificationId:t};const o={requestUri:i,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:G,"X-CSRF-Token":q}};return new Promise((i,n)=>{this.fireODataRequest(o,()=>{s._addDismissNotifications(t);i()},o=>{if(s._csrfTokenInvalid(o)&&$===false){s._invalidCsrfTokenRecovery(i,n,s.dismissNotification,[t])}else{e.error("Notification service - oData dismiss notification failed: ",o,"sap.ushell.services.NotificationsV2");n(o)}})})};this.registerNotificationsUpdateCallback=function(e){N.push(e)};this.registerNotificationCountUpdateCallback=function(e){_.push(e)};this.isFirstDataLoaded=function(){return W};this.getUserSettingsFlags=async function(){try{await r.promisify(b)}catch(e){}return{highPriorityBannerEnabled:H}};this.setUserSettingsFlags=function(e){H=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e)};this._getNotificationSettingsMobileSupport=function(){return V};this._getDismissNotifications=function(){return J};this.filterDismisssedItems=function(e,t){return e.filter(e=>!t.some(t=>t===e.originalItemId))};this._addDismissNotifications=function(e){if(J.indexOf(e)===-1){J.push(e)}};this._initializeDismissNotifications=function(){J=[]};this._getNotificationSettingsEmailSupport=function(){return X};this.destroy=function(){w=true;if(D){clearTimeout(D)}else if(O){clearTimeout(O)}else if(A){clearTimeout(A)}if(L===v.WEB_SOCKET&&R){R.close()}i.getEventBus().unsubscribe("launchpad","sessionTimeout",this.destroy,this);i.getEventBus().unsubscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._readUnseenNotificationsCount=function(){const t=this;const i=this._createRequest(this._getRequestURI(I.GET_BADGE_NUMBER));return new Promise((s,n)=>{this.fireODataRead(i,(e,i)=>{h.setProperty("/UnseenCount",i.data.GetBadgeNumber.Number);t._setNativeIconBadge(i.data.GetBadgeNumber.Number);s(i.data.GetBadgeNumber.Number)},i=>{if(i.response&&i.response.statusCode===200&&i.response.body){const e=JSON.parse(i.response.body);h.setProperty("/UnseenCount",e.value);t._setNativeIconBadge(e.value);s(e.value)}else{e.error("Notification service - oData read unseen notifications count failed: ",i.message,"sap.ushell.services.NotificationsV2");n(i)}})})};this.readNotificationsCount=function(){const t=this._createRequest(this._getRequestURI(I.GET_NOTIFICATIONS_COUNT));return new Promise((i,s)=>{this.fireODataRead(t,(e,t)=>i(t.data),t=>{if(t.response&&t.response.statusCode===200&&t.response.body){const e=JSON.parse(t.response.body);i(e.value)}else{e.error("Notification service - oData read notifications count failed: ",t.message,"sap.ushell.services.NotificationsV2");s(t)}})})};this._getNotificationSettingsAvailability=function(){return C.promise()};this.notificationsSeen=function(){const t=this;const i={requestUri:this._getRequestURI(I.RESET_BADGE_NUMBER),method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:G,"X-CSRF-Token":q}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0)}return new Promise((s,n)=>{this.fireODataRequest(i,s,function(i){if(t._csrfTokenInvalid(i)&&$===false){t._invalidCsrfTokenRecovery(s,n,t.notificationsSeen)}else{e.error("Notification service - oData reset badge number failed: ",i,"sap.ushell.services.NotificationsV2");n(i)}})})};this._readNotificationsData=function(e){const t=this;this.readNotificationsCount().then(e=>h.setProperty("/NotificationsCount",e));const i=this._readUnseenNotificationsCount(e).then(()=>{if(e===true){t._updateNotificationsCountConsumers()}});const s=this.getNotificationsBufferBySortingType(I.NOTIFICATIONS_BY_DATE_DESCENDING,0,P).then(i=>{h.setProperty("/Notifications",i);t._notificationAlert(i);if(e===true){t._updateNotificationsConsumers()}});return Promise.all([i,s])};this._getHeaderXcsrfToken=function(){return q};this._getDataServiceVersion=function(){return G};this._getRequestURI=function(e,t){const i=encodeURI(this._getConsumedIntents(e));let s;switch(e){case I.NOTIFICATIONS:if(p.getNotifications.basic===undefined){p.getNotifications.basic=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false"}if(this._isIntentBasedConsumption()){if(p.getNotifications.byIntents===undefined){p.getNotifications.byIntents=p.getNotifications.basic.concat("&intents%20eq%20"+i)}return p.getNotifications.byIntents}return p.getNotifications.basic;case I.NOTIFICATIONS_BY_TYPE:if(p.getNotificationsByType.basic===undefined){p.getNotificationsByType.basic=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams"}if(this._isIntentBasedConsumption()){if(p.getNotificationsByType.byIntents===undefined){p.getNotificationsByType.byIntents=p.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+i)}return p.getNotificationsByType.byIntents}return p.getNotificationsByType.basic;case I.NOTIFICATIONS_GROUP_HEADERS:if(p.getNotificationsGroupHeaders.basic===undefined){p.getNotificationsGroupHeaders.basic=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true"}if(this._isIntentBasedConsumption()){if(p.getNotificationsGroupHeaders.byIntents===undefined){p.getNotificationsGroupHeaders.byIntents=p.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+i)}return p.getNotificationsGroupHeaders.byIntents}return p.getNotificationsGroupHeaders.basic;case I.NOTIFICATIONS_IN_GROUP:s=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt desc&$filter=IsGroupHeader eq false and ParentId eq "+t.group+"&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){s=s.concat("&intents%20eq%20"+i)}break;case I.GET_BADGE_NUMBER:if(p.getBadgeNumber.basic===undefined){p.getBadgeNumber.basic=g.serviceUrl+"/GetBadgeNumber()"}if(this._isIntentBasedConsumption()){if(p.getBadgeNumber.byIntents===undefined){p.getBadgeNumber.byIntents=g.serviceUrl+"/GetBadgeCountByIntent("+i+")"}return p.getBadgeNumber.byIntents}return p.getBadgeNumber.basic;case I.GET_NOTIFICATIONS_COUNT:if(p.getNotificationCount.basic===undefined){p.getNotificationCount.basic=g.serviceUrl+"/Notifications/$count"}return p.getNotificationCount.basic;case I.RESET_BADGE_NUMBER:if(p.resetBadgeNumber.basic===undefined){p.resetBadgeNumber.basic=g.serviceUrl+"/ResetBadgeNumber"}return p.resetBadgeNumber.basic;case I.GET_SETTINGS:if(p.getNotificationTypesSettings.basic===undefined){p.getNotificationTypesSettings.basic=g.serviceUrl+"/NotificationTypePersonalizationSet"}return p.getNotificationTypesSettings.basic;case I.GET_MOBILE_SUPPORT_SETTINGS:if(p.getMobileSupportSettings.basic===undefined){p.getMobileSupportSettings.basic=g.serviceUrl+"/Channels(ChannelId='SAP_SMP')"}return p.getMobileSupportSettings.basic;case I.GET_EMAIL_SUPPORT_SETTINGS:if(p.getEmailSupportSettings.basic===undefined){p.getEmailSupportSettings.basic=g.serviceUrl+"/Channels(ChannelId='SAP_EMAIL')"}return p.getEmailSupportSettings.basic;case I.VALIDATE_WEBSOCKET_CHANNEL:if(p.getWebSocketValidity.basic===undefined){p.getWebSocketValidity.basic=g.serviceUrl+"/Channels('SAP_WEBSOCKET')"}return p.getWebSocketValidity.basic;case I.NOTIFICATIONS_BY_DATE_DESCENDING:s=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){s=s.concat("&intents%20eq%20"+i)}break;case I.NOTIFICATIONS_BY_PRIORITY_DESCENDING:s=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){s=s.concat("&intents%20eq%20"+i)}break;default:s=""}return s};this.readSettings=function(){const t=this._createRequest(this._getRequestURI(I.GET_SETTINGS));return new Promise((i,s)=>{this.fireODataRequest(t,e=>i(e.results),t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.NotificationsV2");s(t)}})})};this._readMobileSettingsFromServer=function(){return this._readChannelSettingsFromServer(I.GET_MOBILE_SUPPORT_SETTINGS)};this._readEmailSettingsFromServer=function(){return this._readChannelSettingsFromServer(I.GET_EMAIL_SUPPORT_SETTINGS)};this._readChannelSettingsFromServer=function(t){const i=this._getRequestURI(t);const s=this._createRequest(i);let n;let o;return new Promise(t=>{this.fireODataRequest(s,e=>{if(typeof e.results==="string"){n=JSON.parse(e.results);n.successStatus=true;o=JSON.stringify(n);t(o)}else{e.results.successStatus=true;t(e.results)}},i=>{if(i.response&&i.response.statusCode===200&&i.response.body){n=JSON.parse(i.response.body);n.successStatus=true;o=JSON.stringify(n);t(o)}else{e.error("Notification service - oData get settings failed: ",i,"sap.ushell.services.NotificationsV2");t(JSON.stringify({successStatus:false}))}})})};this._checkWebSocketActivity=function(){const t=this._createRequest(this._getRequestURI(I.VALIDATE_WEBSOCKET_CHANNEL));return new Promise(i=>{this.fireODataRequest(t,e=>{if(typeof e.results==="string"){const t=JSON.parse(e.results);i(t.IsActive)}else{i(false)}},t=>{if(t.response&&t.response.statusCode===200&&t.response.body){const e=JSON.parse(t.response.body);i(e.IsActive)}else{e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.NotificationsV2");i(false)}})})};this.saveSettingsEntry=function(t){const i=this;const s=this._getRequestURI(I.GET_SETTINGS)+"(NotificationTypeId="+t.NotificationTypeId+")";const n={requestUri:s,method:"PUT",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:G,"X-CSRF-Token":q}};n.data=JSON.parse(JSON.stringify(t));n.data["@odata.context"]="$metadata#NotificationTypePersonalizationSet/$entity";return new Promise((s,o)=>{this.fireODataRequest(n,s,n=>{if(n.response&&n.response.statusCode===200&&n.response.body){s(n.response.body)}else if(i._csrfTokenInvalid(n)&&$===false){i._invalidCsrfTokenRecovery(s,o,i.saveSettingsEntry,[t])}else{e.error("Notification service - oData set settings entry failed: ",n,"sap.ushell.services.NotificationsV2");o(n)}})})};this._updateNotificationsConsumers=function(){N.forEach(e=>e())};this._updateNotificationsCountConsumers=function(){_.forEach(e=>e())};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers()};this._getModel=function(){return h};this._getMode=function(){return L};this._setWorkingMode=function(){let e;if(g.intentBasedConsumption===true){k=this._getIntentsFromConfiguration(g.consumedIntents);if(k.length>0){B=true}}if(this._isPackagedMode()){L=v.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){k=e}if(k.length>0){B=true}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return}this._performFirstRead()};this._performFirstRead=function(){const t=this;this._readNotificationsData(true).then(()=>{const e=t._getFioriClientRemainingDelay();if(e<=0){t._fioriClientStep()}else{D=setTimeout(function(){t._fioriClientStep()},e)}W=true}).catch(t=>{e.error("Notifications oData read failed. Error: "+t)})};this._fioriClientStep=function(){if(this._isFioriClientMode()){L=v.FIORI_CLIENT;this._addPushNotificationHandler();this.getUnseenNotificationsCount().then(function(e){this._setNativeIconBadge(e,()=>{})}.bind(this)).catch(()=>{})}else{this._webSocketStep()}};this._webSocketStep=function(){L=v.WEB_SOCKET;this._establishWebSocketConnection()};this._webSocketRecoveryStep=function(){if(M===false){M=true;O=window.setTimeout(this._webSocketStep.bind(this),S)}else{this._activatePollingAfterInterval()}};this._activatePollingAfterInterval=function(){const e=g.pollingIntervalInSeconds||u;window.clearTimeout(A);A=window.setTimeout(this._activatePolling.bind(this),r.sanitizeTimeoutDelay(e*1e3))};this._activatePolling=function(){const e=g.pollingIntervalInSeconds||u;L=v.POLLING;this._readNotificationsData(true);window.clearTimeout(A);A=window.setTimeout(this._activatePolling.bind(this,e,false),r.sanitizeTimeoutDelay(e*1e3))};this._formatAsDate=function(e){return new Date(e)};this._notificationAlert=function(e){if(H===false){return}const t=[];let s=0;for(const i in e){if(this.lastNotificationDate&&this._formatAsDate(e[i].CreatedAt)>this.lastNotificationDate){if(e[i].Priority==="HIGH"){t.push(e[i])}}if(s<this._formatAsDate(e[i].CreatedAt)){s=this._formatAsDate(e[i].CreatedAt)}}if(this.lastNotificationDate&&t.length>0){i.getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",t)}this.lastNotificationDate=s};this._getFioriClientRemainingDelay=function(){return T-(new Date-E)};this._establishWebSocketConnection=function(){const t=this;let i=false;try{R=this._getWebSocketObjectObject(g.webSocketUrl||c,[n.SUPPORTED_PROTOCOLS.v10]);R.attachMessage(this,function(e){const i=e.getParameter("pcpFields");if(i&&i.Command&&i.Command==="Notification"){t._readNotificationsData(true)}});R.attachOpen(this,function(){t._checkWebSocketActivity().then(e=>{if(!e){i=true;R.close();t._activatePollingAfterInterval()}});e.info("Notifications UShell service WebSocket: webSocket connection opened")});R.attachClose(this,function(s){e.warning("Notifications UShell service WebSocket: attachClose called with code: "+s.mParameters.code+" and reason: "+s.mParameters.reason);if(!w&&!i){t._webSocketRecoveryStep()}});R.attachError(this,function(){e.warning("Notifications UShell service WebSocket: attachError called!")})}catch(t){e.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+t.message)}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined)};this._isPackagedMode=function(){return window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true};this._setNativeIconBadge=function(e){if(sap.Push&&sap.Push.setBadgeNumber){sap.Push.setBadgeNumber(e,()=>{})}};this._setNativeIconBadgeWithDelay=function(){setTimeout(function(){this.getUnseenNotificationsCount().then(function(e){this._setNativeIconBadge(e)}.bind(this)).catch(()=>{})}.bind(this),4e3)};this._getIntentsFromConfiguration=function(e){const t=[];if(e&&e.length>0){let i;for(let s=0;s<e.length;s++){i=e[s].intent;t.push(i)}}return t};this._handlePushedNotification=function(e){let t;let i;let s;let n=[];if(e!==undefined){if(e.additionalData===undefined||e.additionalData.foreground===true){this._readNotificationsData(true)}else{if(e.additionalData&&e.additionalData.NavigationTargetObject){t=e.additionalData.NavigationTargetObject}else{t=e.NavigationTargetObject}if(e.additionalData&&e.additionalData.NavigationTargetAction){i=e.additionalData.NavigationTargetAction}else{i=e.NavigationTargetAction}if(e.additionalData&&e.additionalData.NavigationTargetParam){s=e.additionalData.NavigationTargetParam}else{s=e.NavigationTargetParam}if(s){if(typeof s==="string"||s instanceof String){n[0]=s}else if(Array.isArray(s)===true){n=s}}const o=e.NotificationId;if(t&&i){r.toExternalWithParameters(t,i,n)}this.markRead(o);this._readNotificationsData(true)}}};this._registerForPush=function(){if(sap.Push){sap.Push.initPush(this._handlePushedNotification.bind(this))}};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false)};this._isIntentBasedConsumption=function(){return B};this._getConsumedIntents=function(e){let t="";if(!this._isIntentBasedConsumption()){return t}if(k.length>0){if(e!==I.GET_BADGE_NUMBER){t="&"}for(let i=0;i<k.length;i++){if(e===I.GET_BADGE_NUMBER){if(i===0){t=k[i]}else{t=t+","+k[i]}}else{t=t+"NavigationIntent%20eq%20%27"+k[i]+"%27"}}}return t};this._revalidateCsrfToken=function(){q="fetch";z=false;return this.getNotificationsBufferBySortingType(I.NOTIFICATIONS_BY_DATE_DESCENDING,0,1)};this._csrfTokenInvalid=function(e){const t=e.response;const i=t&&t.statusCode===403;const s=t&&t.headers["x-csrf-token"]||"";const n=s.toLowerCase()==="required";return i&&n};this._invalidCsrfTokenRecovery=function(t,i,s,n){const o=this;$=true;this._revalidateCsrfToken().then(()=>{s.apply(o,n).then(t).catch(e=>{if(e.response&&e.response.statusCode===200&&e.response.body){t(e.response.body)}else{i(e)}}).finally(()=>{$=false})}).catch(t=>{$=false;e.error("Notification service - oData markRead failed: ",t.message,"sap.ushell.services.NotificationsV2");i(t)})};this._getWebSocketObjectObject=function(e,t){return new n(e,t)};this.getOperationEnum=function(){return I};this._readUserSettingsFlagsFromPersonalization=function(){const t=this;this._getUserSettingsPersonalizer().then(i=>{i.getPersData().then(e=>{if(e===undefined){t._writeUserSettingsFlagsToPersonalization({highPriorityBannerEnabled:H})}else{H=e.highPriorityBannerEnabled}m.resolve()}).catch(()=>{e.error("Reading User Settings flags from Personalization service failed");m.reject()})}).catch(t=>{e.error("Personalization service does not work:");e.error(t.name+": "+t.message);e.error("Reading User Settings flags from Personalization service failed")})};this._writeUserSettingsFlagsToPersonalization=function(t){return this._getUserSettingsPersonalizer().then(e=>e.setPersData(t)).catch(t=>{e.error("Personalization service does not work:");e.error(t.name+": "+t.message)})};this._getUserSettingsPersonalizer=function(){if(!this.oUserSettingsPersonalizerPromise){this.oUserSettingsPersonalizerPromise=sap.ushell.Container.getServiceAsync("PersonalizationV2").then(e=>{const t={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true};const i={container:"sap.ushell.services.Notifications",item:"userSettingsData"};return e.getPersonalizer(i,t)})}return this.oUserSettingsPersonalizerPromise};this._updateCSRF=function(e){if(z===true||e.headers===undefined){return}if(this._getHeaderXcsrfToken()==="fetch"){q=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"]||"fetch"}if(!this._getDataServiceVersion()){G=e.headers.DataServiceVersion||e.headers["odata-version"]}z=true};this._userSettingInitialization=function(){const t={settingsAvailable:false,mobileAvailable:false,emailAvailable:false};this._readUserSettingsFlagsFromPersonalization();const i=this.readSettings();const s=this._readMobileSettingsFromServer();const n=this._readEmailSettingsFromServer();const o=[i,s,n];i.then(()=>{t.settingsAvailable=true}).catch(()=>{e.warning("User settings for the Notification service are not available.");C.promise().catch(()=>{});C.reject()});s.then(e=>{const i=JSON.parse(e);if(i.successStatus){V=e?i.IsActive:false;t.mobileAvailable=V}else{V=false;t.mobileAvailable=false}}).catch(()=>{e.warning("Mobile settings for the Notification service are not available.");V=false;t.mobileAvailable=false});n.then(e=>{const i=JSON.parse(e);if(i.successStatus){X=e?i.IsActive:false;t.emailAvailable=X}else{X=false;t.emailAvailable=false}}).catch(()=>{e.warning("Email settings for the Notification service are not available.");X=false;t.emailAvailable=false});Promise.all(o).then(()=>{C.resolve(t)}).catch(()=>e.warning("Settings for the Notification service are not loaded completely."))};this._closeConnection=function(){if(!w){if(L===v.WEB_SOCKET&&R){R.close();w=true}if(L===v.POLLING&&A){window.clearTimeout(A);w=true}}};this._resumeConnection=function(){if(w){w=false;this._webSocketStep()}}}f.hasNoAdapter=true;return f},true);
//# sourceMappingURL=NotificationsV2.js.map