// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/base/util/isEmptyObject","sap/ui/core/CalendarType","sap/ui/core/Configuration","sap/ui/core/format/DateFormat","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/v4/ODataUtils","sap/ui/thirdparty/jquery","sap/ushell/User"],function(e,r,t,a,n,s,i,l,jQuery,u){"use strict";var o="sap.ushell.services.ReferenceResolver";function f(){this.getValue=function(e){var r=new jQuery.Deferred;var t;if(e==="User.env.sap-ui-legacy-date-format"){t=n.getFormatSettings().getLegacyDateFormat()}if(e==="User.env.sap-ui-legacy-number-format"){t=n.getFormatSettings().getLegacyNumberFormat()}if(e==="User.env.sap-ui-legacy-time-format"){t=n.getFormatSettings().getLegacyTimeFormat()}if(e==="User.env.sap-language"){t=sap.ushell.Container.getUser().getLanguage()}if(e==="User.env.sap-languagebcp47"){t=sap.ushell.Container.getUser().getLanguageBcp47()}if(e==="User.env.sap-accessibility"){t=sap.ushell.Container.getUser().getAccessibilityMode()?"X":undefined}if(e==="User.env.sap-statistics"){t=n.getStatisticsEnabled()?"true":undefined}if(e==="User.env.sap-theme"){t=sap.ushell.Container.getUser().getTheme(u.prototype.constants.themeFormat.THEME_NAME_PLUS_URL)}if(e==="User.env.sap-theme-name"){t=sap.ushell.Container.getUser().getTheme()}if(e==="User.env.sap-theme-NWBC"){t=sap.ushell.Container.getUser().getTheme(u.prototype.constants.themeFormat.NWBC)}r.resolve({value:t});return r.promise()}}function c(n,u,c){this._getUserEnvReferenceResolver=function(){if(!this.oUserEnvReferenceResolver){this.oUserEnvReferenceResolver=new f}return this.oUserEnvReferenceResolver};this.resolveReferences=function(r,a){var n=this;var s=new jQuery.Deferred;var i=[];var l=true;var u={};var f={};var c=sap.ushell.Container.getServiceAsync("UserDefaultParameters");var d;var v;if(!a){v=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext()})}else{v=Promise.resolve(a)}var m=r.map(function(r){var t;if(r.indexOf("User.env.")===0){t=r;f[t]=1}if(r.indexOf("UserDefault.")===0){t=n._extractAnyUserDefaultReferenceName(r);u[t]=1}if(typeof t!=="string"){l=false;e.error("'"+r+"' is not a legal reference name",null,o)}return{full:r,name:t}});if(!l){return s.reject("One or more references could not be resolved").promise()}Promise.all([v,c]).then(function(e){var r=e[0];var a=e[1];Object.keys(u).forEach(function(e){i.push(a.getValue(e,r))});Object.keys(f).forEach(function(e){d=d||n._getUserEnvReferenceResolver();i.push(d.getValue(e))});jQuery.when.apply(jQuery,i).done(function(){var e={};var r=0;var a=arguments;Object.keys(u).forEach(function(e){u[e]=a[r];r=r+1});Object.keys(f).forEach(function(e){f[e]=a[r];r=r+1});m.forEach(function(r){var a;if(r.full.indexOf("UserDefault.extended.")===0){a=n.mergeSimpleAndExtended(u[r.name]);if(!t(a)){e[r.full]=a}else{e[r.full]=undefined}}else if(r.full.indexOf("UserDefault.")===0){e[r.full]=u[r.name].value}else if(r.full.indexOf("User.env.")===0){e[r.full]=f[r.name].value}});s.resolve(e)})});return s.promise()};this._extractAnyUserDefaultReferenceName=function(e){var r=this.extractExtendedUserDefaultReferenceName(e);if(typeof r==="string"){return r}return this.extractUserDefaultReferenceName(e)};this.extractExtendedUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.extended.")!==0){return undefined}return e.replace(/^UserDefault[.]extended[.]/,"")};this.extractUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.")!==0||e.indexOf("UserDefault.extended.")===0){return undefined}return e.replace(/^UserDefault[.]/,"")};this.mergeSimpleAndExtended=function(e){var t=r({},e.extendedValue);if(typeof e.value==="string"){if(!Array.isArray(t.Ranges)){t.Ranges=[]}t.Ranges.push({Sign:"I",Option:"EQ",Low:e.value,High:null})}return t};function d(e){var r=/{([^}%]*%%[^%]+%%)}?/g;var t=/([^%]*)%%/;var a=/%%([^%]+)%%/;var n=[];var s=r.exec(e);while(s){var i=t.exec(s[1]);var l=a.exec(s[1]);n.push({edmType:i[1],name:l[1]});s=r.exec(e)}return n}this._extractUrlPlaceholders=function(e,r){var t;var a;var n=[];t=/[^(?]*/.exec(e);a=t===null?[]:d(t[0]);a.forEach(function(e){n.push(e.name)});t=/[(?][^]*/.exec(e);a=t===null?[]:d(t[0]);var s=a.filter(function(e){var t=e.name;if(r.test(t)){return true}n.push(t);return false});return{extractedReferences:s,ignoredReferences:n}};this._replaceUrlPlaceholders=function(e,r,t){var a=e;var n=[];var s=t?l.formatLiteral.bind(l):i.formatValue.bind(i);r.forEach(function(e){var r=e.name;var t=null;var i=false;while(t!==a){t=a;if(e.value!==undefined){var l=s(e.value,e.edmType);a=a.replace("{"+e.edmType+"%%"+r+"%%}",window.encodeURIComponent(l))}else{i=true;a=a.replace("{"+e.edmType+"%%"+r+"%%}","")}}if(i){n.push(r)}});return{resolvedUrl:a,placeholdersWithoutValue:n}};this.resolveUserDefaultParameters=function(e,r){var t=new jQuery.Deferred;var a=this._extractUrlPlaceholders(e,/^UserDefault\.(?!extended\.).+/);var n=a.extractedReferences;var s=a.ignoredReferences;if(n.length===0){t.resolve({url:e,defaultsWithoutValue:[],ignoredReferences:s});return t.promise()}var i=n.map(function(e){return e.name});this.resolveReferences(i,r).done(function(r){n.forEach(function(e){e.value=r[e.name]});var a=this._replaceUrlPlaceholders(e,n);t.resolve({url:a.resolvedUrl,defaultsWithoutValue:a.placeholdersWithoutValue,ignoredReferences:s})}.bind(this));return t.promise()};this._loadDynamicDateRange=function(){return sap.ui.getCore().loadLibrary("sap.ui.unified",{async:true}).then(function(){return new Promise(function(e){sap.ui.require(["sap/m/DynamicDateRange"],function(r){e(r)})})})};this._rSemanticDateRangeRegex=/^DynamicDate\..+/;this.resolveSemanticDateRanges=function(r,t){var a=this._extractUrlPlaceholders(r,this._rSemanticDateRangeRegex);var n=a.extractedReferences;var s=a.ignoredReferences;if(n.length===0){return Promise.resolve({url:r,hasSemanticDateRanges:false,invalidSemanticDates:[],ignoredReferences:s})}var i=["2.0","4.0"];if(!t||!i.includes(t)){return Promise.reject("Invalid OData version: "+t)}var l=t==="4.0";return this._resolveSemanticDateRanges(n,l).then(function(a){var i=this._replaceUrlPlaceholders(r,a,l);if(e.getLevel()>=e.Level.DEBUG){var u=a.filter(function(e){return"value"in e});e.debug("Resolving semantic date ranges \n"+"- OData Version: "+t+"\n"+"- URL: "+r+"\n"+"- ignoring references: "+JSON.stringify(s,null,4)+"\n"+"- resolved semantic date ranges: "+JSON.stringify(u,null,4)+"\n"+"- invalid semantic date ranges:"+JSON.stringify(i.placeholdersWithoutValue,null,4)+"\n"+"- final URL: "+i.resolvedUrl,null,o)}return{url:i.resolvedUrl,hasSemanticDateRanges:n.length>0,invalidSemanticDates:i.placeholdersWithoutValue,ignoredReferences:s}}.bind(this))};this._resolveSemanticDateRanges=function(e,r){var t=this._getDateTimeFormatters();return this._loadDynamicDateRange().then(function(a){return e.map(function e(n){var s={name:n.name,edmType:n.edmType};var i=n.name.split(".");var l={operator:i[1],values:[]};var u;if(i.length===3){u=i[2]}else if(i.length===4){l.values.push(i[2]);u=i[3]}else if(i.length===5){l.values=i.slice(2,4);u=i[4]}var o;try{o=a.toDates(l)}catch(e){return s}if(i.length>=3&&u!=="start"&&u!=="end"){return s}var f;if(u==="end"){f=o[1]}else{f=o[0]}if(!f){return s}switch(n.edmType){case"Edm.String":s.value=t.string.format(f);break;case"Edm.Date":s.value=t.date.format(f);break;case"Edm.DateTime":f.setUTCFullYear(f.getFullYear(),f.getMonth(),f.getDate());f.setUTCHours(0,0,0,0);s.value=f;break;case"Edm.DateTimeOffset":if(r){s.value=t.dateTimeOffsetV4.format(f,true)}else{s.value=f}break;default:break}return s})})};this._getDateTimeFormatters=function(){if(!this._oDateTimeFormatters){this._oDateTimeFormatters={string:s.getDateInstance({pattern:"yyyyMMdd",calendarType:a.Gregorian}),date:s.getDateInstance({pattern:"yyyy-MM-dd",calendarType:a.Gregorian}),dateTimeOffsetV4:s.getDateInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss'Z'",calendarType:a.Gregorian})}}return this._oDateTimeFormatters};this.hasSemanticDateRanges=function(e){var r=this._extractUrlPlaceholders(e,this._rSemanticDateRangeRegex);return r.extractedReferences.length>0}}c.hasNoAdapter=true;return c},true);
//# sourceMappingURL=ReferenceResolver.js.map