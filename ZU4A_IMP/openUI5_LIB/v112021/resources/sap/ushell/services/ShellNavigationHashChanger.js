// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ushell/utils/UrlShortening","sap/ushell/utils/UrlParsing","sap/ui/core/routing/HashChanger","sap/ui/performance/trace/Interaction","sap/ui/thirdparty/hasher","sap/base/util/isEmptyObject","sap/ui/thirdparty/jquery","sap/base/Log"],function(e,t,a,i,r,n,s,jQuery,o){"use strict";var h=e.NavigationState;var p={HASH_SET:{name:"hashSet",historyEntry:true},HASH_REPLACED:{name:"hashReplaced",historyEntry:false},SHELL_HASH_CHANGED:{name:"shellHashChanged",historyEntry:true,usedByUi5HistoryDetection:true,ui5EventParameterNames:{oldHash:"oldAppSpecificRouteNoSeparator",newHash:"newAppSpecificRouteNoSeparator"},updateHashOnly:true},SHELL_HASH_PARAMETER_CHANGED:{name:"shellHashParameterChanged",historyEntry:null},HASH_CHANGED:{name:"hashChanged",historyEntry:false,usedByUi5HistoryDetection:true,ui5EventParameterNames:{newHash:"newHash",fullHash:"fullHash"}}};const l="ShellNavigationHashChanger";const u="[FesrFlp]";var c=i.extend("sap.ushell.services.ShellNavigationHashChanger",{constructor:function(e){this.oServiceConfig=e;this._oNavigationState={};i.apply(this);this._initializedByShellNav=false;this._bReloadApplication=false;this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.aNavigationFilters=[];this.NavigationFilterStatus={Continue:"Continue",Custom:"Custom",Abandon:"Abandon",Keep:"Keep"};this.getRelevantEventsInfo=function(){return this._getAllEvents().filter(function(e){return e.usedByUi5HistoryDetection}).map(function(e){var t={name:e.name,paramMapping:e.ui5EventParameterNames};if(e.updateHashOnly!==undefined){t.updateHashOnly=e.updateHashOnly}return t})}}});c.prototype.privgetCurrentShellHash=function(){var e=this.privsplitHash(n.getHash());return{hash:"#"+(e&&e.shellPart?e.shellPart:"")}};c.prototype.privconstructHash=function(e){var t=this.privgetCurrentShellHash();t.hash+=e;return t};c.prototype.privconstructShellHash=function(e){return a.constructShellHash(e)};c.prototype.privsplitHash=function(e){if(e===undefined||e===null||e===""){return{shellPart:null,appSpecificRoute:null,intent:null,params:null}}var t=a.parseShellHash(e);if(t===undefined||t===null){return null}var i=t.params&&!s(t.params)?t.params:null;var r=t.appSpecificRoute;t.appSpecificRoute=undefined;return{shellPart:this.privstripLeadingHash(this.privconstructShellHash(t))||null,appSpecificRoute:r||null,intent:t.semanticObject&&t.action&&t.semanticObject+"-"+t.action+(t.contextRaw||"")||null,params:i}};c.prototype.privsetHash=function(e,t,a){n.prependHash="";e=this.privstripLeadingHash(e);t=t||"";if(a===undefined){a=true}if(a){this.fireEvent(p.HASH_SET.name,{sHash:t});n.setHash(e)}else{this.fireEvent(p.HASH_REPLACED.name,{sHash:t});n.replaceHash(e)}};c.prototype.privstripLeadingHash=function(e){if(e[0]==="#"){return e.substring(1)}return e};c.prototype.registerNavigationFilter=function(e){if(typeof e!=="function"){throw new Error("fnFilter must be a function")}this.aNavigationFilters.push(e)};c.prototype.unregisterNavigationFilter=function(e){if(typeof e!=="function"){throw new Error("fnFilter must be a function")}this.aNavigationFilters=this.aNavigationFilters.filter(function(t){return t!==e})};function f(e,t,a){this.oAppState=undefined;this.oPromise=(new jQuery.Deferred).resolve();this.getNextKey=function(){this.oAppState=e.createEmptyAppState(t,a);return this.oAppState.getKey()};this.store=function(e){var t;this.oAppState.setData(e);t=this.oAppState.save();this.oPromise=jQuery.when(this.oPromise,t)};this.getPromise=function(){return this.oPromise}}c.prototype.compactParams=function(e,i,r,n){var s=new jQuery.Deferred;var o=a.constructShellHash({target:{semanticObject:"SO",action:"action"},params:e});if(e===undefined||Object.keys(e).length===0){return s.resolve(e).promise()}sap.ushell.Container.getServiceAsync("AppState").then(function(e){var h=new f(e,r,n);var p=t.compactHash(o,i,h);var l=a.parseParameters(p.hash.match(/\?.*/)[0]);var u=h.getPromise();u.done(function(){s.resolve(l)}).fail(function(e){s.reject(e)})});return s.promise()};c.prototype.hrefForExternal=function(e,t){function a(e,t){if(t===true){e.hash=encodeURI(e.hash)}else{e=encodeURI(e)}return e}return this.hrefForExternalNoEncAsync(e,t).then(function(e){return a(e,t)})};c.prototype.hrefForExternalSync=function(e,t,a){function i(e,t){if(t===true){e.hash=encodeURI(e.hash)}else{e=encodeURI(e)}return e}var r=this.hrefForExternalNoEnc(e,t,a);return i(r,t)};c.prototype.hrefForExternalNoEnc=function(e,t,a,i){o.error("Deprecated API call of 'sap.ushell.services.ShellNavigationHashChanger.hrefForExternalNoEnc'. Please use 'hrefForExternalNoEncAsync' instead",null,"sap.ushell.services.ShellNavigationHashChanger");if(i){var r=new jQuery.Deferred;this.hrefForExternalNoEncAsync(e,t).then(r.resolve).catch(r.reject);return r.promise()}var n=this.privhrefForExternalNoEnc(e);if(t===true){return{hash:n.hash,params:n.params,skippedParams:n.skippedParams}}return n.hash};c.prototype.hrefForExternalNoEncAsync=function(e,t){var a;var i=this.privhrefForExternalNoEnc(e);if(t===true){a={hash:i.hash,params:i.params,skippedParams:i.skippedParams}}else{a=i.hash}return new Promise(function(e){e(a)})};c.prototype.privhrefForExternalNoEnc=function(e){if(e===undefined){return this.privgetCurrentShellHash()}if(e&&e.target&&(typeof e.target.semanticObject==="string"||typeof e.target.shellHash==="string")){return{hash:"#"+this.privconstructShellHash(e)}}return this.privgetCurrentShellHash()};c.prototype.privgetAppHash=function(e){var t;if(e&&e.target&&typeof e.target.shellHash==="string"){var i=a.parseShellHash(e.target.shellHash);t=i&&i.appSpecificRoute;t=t&&t.substring(2)}return t};c.prototype.hrefForAppSpecificHash=function(e){return encodeURI(this.privconstructHash(this.privappHashPrefix+e).hash)};c.prototype.toExternal=function(e,t,a){var i=this.privhrefForExternalNoEnc(e).hash;var r=this.privgetAppHash(e);this.privsetHash(i,r,a);return Promise.resolve()};c.prototype.toAppHash=function(e,t){var a=this.privconstructHash(this.privappHashPrefix+e).hash;this.privsetHash(a,e,t)};c.prototype.initShellNavigation=function(e){if(this._initializedByShellNav){o.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false}this.privfnShellCallback=e;n.changed.add(this.treatHashChanged,this);if(!n.isActive()){n.initialized.addOnce(this.treatHashChanged,this);n.init()}else{this.treatHashChanged(n.getHash())}this._initializedByShellNav=true;return true};c.prototype.init=function(){if(this._initialized){o.info("init already called on this ShellNavigationHashChanger instance.");return false}var e=this.privsplitHash(n.getHash());var t=(e&&e.appSpecificRoute||"  ").substring(2);var a=t?"&/":"";var i=e&&e.shellPart||"";this.fireEvent(p.HASH_CHANGED.name,{newHash:t,fullHash:i+a+t});this._initialized=true;return true};c.prototype._removeInnerAppSeparator=function(e){return(e||"").replace("&/","")};c.prototype._setNavigationStatus=function(e){if(e===h.InProgress&&!this._fnResolveInteraction){o.debug(`${u} Interaction Start`,null,l);this._fnResolveInteraction=r.notifyAsyncStep()}else if(e===h.Finished&&this._fnResolveInteraction){o.debug(`${u} Interaction End`,null,l);this._fnResolveInteraction();this._fnResolveInteraction=null}this._oNavigationState.status=e};c.prototype._trackNavigation=function(e,t){this._oNavigationState.newHash=e;this._oNavigationState.oldHash=t};c.prototype.getCurrentNavigationState=function(){return this._oNavigationState};c.prototype.treatHashChanged=function(e,i){this._trackNavigation(e,i);this._setNavigationStatus(h.InProgress);if(this.inAbandonFlow){this._setNavigationStatus(h.Finished);this.setReloadApplication(false);return}var r;e=t.expandHash(e);i=t.expandHash(i);var s=this.privsplitHash(e);var l=this.privsplitHash(i);if(!s){var u=new Error("Illegal new hash - cannot be parsed: '"+e+"'");this.fireEvent(p.SHELL_HASH_CHANGED.name,{newShellHash:e,newAppSpecificRoute:null,fullHash:e,oldShellHash:l?l.shellPart:i,error:u});this.privfnShellCallback(e,null,l?l.shellPart:i,l?l.appSpecificRoute:null,u);this._setNavigationStatus(h.Finished);this.setReloadApplication(false);return}if(!l){l={shellPart:i,appSpecificRoute:null}}for(var c=0;c<this.aNavigationFilters.length;c++){try{var f;var v=this.aNavigationFilters[c].call(undefined,e,i);var H=v;if(typeof v!=="string"){H=v.status;f=v.hash}if(H===this.NavigationFilterStatus.Custom){if(f&&f.length>0){this.inAbandonFlow=true;n.replaceHash(f);this.inAbandonFlow=false}this._setNavigationStatus(h.Finished);this.setReloadApplication(false);return}if(H===this.NavigationFilterStatus.Abandon){this.inAbandonFlow=true;n.replaceHash(i);this.inAbandonFlow=false;this._setNavigationStatus(h.Finished);this.setReloadApplication(false);return}if(H===this.NavigationFilterStatus.Keep){r=true}}catch(e){o.error("Error while calling Navigation filter! ignoring filter...",e.message,"sap.ushell.services.ShellNavigation")}}if(r){this.fireEvent(p.HASH_CHANGED.name,{newHash:e,oldHash:i,fullHash:e});this._setNavigationStatus(h.Finished);this.setReloadApplication(false);return}var g=i===undefined;var S=a.compareHashes(e,i);S.sameIntent=S.sameIntent&&!g;var d=S.sameIntent&&S.sameParameters&&S.sameAppSpecificRoute;if(d){o.info("Navigation happened but hash stayed the same",null,"sap.ushell.services.ShellNavigation");this.fireEvent(p.HASH_CHANGED.name,{newHash:this._removeInnerAppSeparator(s.appSpecificRoute),oldHash:this._removeInnerAppSeparator(l.appSpecificRoute),fullHash:e});this._setNavigationStatus(h.Finished);sap.ui.getCore().getEventBus().publish("relatedServices","resetBackNavigation");this.setReloadApplication(false);return}var m=S.sameIntent&&S.sameParameters;if(m){if(this.getReloadApplication()){this.setReloadApplication(false)}else{var A=this._removeInnerAppSeparator(s.appSpecificRoute);var y=this._removeInnerAppSeparator(l.appSpecificRoute);o.info("Inner App Hash changed from '"+y+"' to '"+A+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent(p.HASH_CHANGED.name,{newHash:A,oldHash:y,fullHash:e});this._setNavigationStatus(h.Finished);sap.ui.getCore().getEventBus().publish("relatedServices","resetBackNavigation");return}}if(S.sameIntent&&this.hasListeners(p.SHELL_HASH_PARAMETER_CHANGED.name)){var E=a.paramsToString(s.params);var N=a.paramsToString(l.params);o.info("Shell hash parameters changed from '"+N+"' to '"+E+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent(p.SHELL_HASH_PARAMETER_CHANGED.name,{oNewParameters:s.params,oOldParameters:l.params});this._setNavigationStatus(h.Finished);this.setReloadApplication(false);return}o.info("Outer shell hash changed from '"+i+"' to '"+e+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent(p.SHELL_HASH_CHANGED.name,{newShellHash:s.shellPart,newAppSpecificRoute:s.appSpecificRoute,fullHash:e,oldShellHash:l.shellPart,oldAppSpecificRoute:l.appSpecificRoute,error:"",oldAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(l.appSpecificRoute),newAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(s.appSpecificRoute)});this.privfnShellCallback(s.shellPart,s.appSpecificRoute,l.shellPart,l.appSpecificRoute);if(S.sameIntent){sap.ui.getCore().getEventBus().publish("relatedServices","resetBackNavigation")}this._setNavigationStatus(h.Finished);this.setReloadApplication(false)};c.prototype.setHash=function(e){this.toAppHash(e,true)};c.prototype.replaceHash=function(e){this.toAppHash(e,false)};c.prototype.getHash=function(){return this.getAppHash()};c.prototype.getAppHash=function(){var e=this.privsplitHash(n.getHash());var t=(e&&e.appSpecificRoute||"  ").substring(2);return t};c.prototype.destroy=function(){n.changed.remove(this.treatHashChanged,this);i.prototype.destroy.apply(this,arguments)};c.prototype._getAllEvents=function(){return Object.keys(p).map(function(e){return p[e]})};c.prototype.getReplaceHashEvents=function(){return this._getAllEvents().filter(function(e){return e.historyEntry===false}).map(function(e){return e.name})};c.prototype.getSetHashEvents=function(){return this._getAllEvents().filter(function(e){return e.historyEntry===true}).map(function(e){return e.name})};c.prototype.isInnerAppNavigation=function(e,t){var i=a.parseShellHash(e);var r=a.parseShellHash(t);var n=t===undefined;var s=a.haveSameIntent(i,r)&&!n;var o=a.haveSameIntentParameters(i,r);return s&&o};c.prototype.getReloadApplication=function(){return this._bReloadApplication};c.prototype.setReloadApplication=function(e){this._bReloadApplication=e};return c});
//# sourceMappingURL=ShellNavigationHashChanger.js.map