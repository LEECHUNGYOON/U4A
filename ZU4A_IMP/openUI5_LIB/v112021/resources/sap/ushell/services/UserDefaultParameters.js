// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/deepEqual","sap/base/util/deepExtend","sap/base/util/isEmptyObject","sap/ui/base/EventProvider","sap/ui/thirdparty/jquery","sap/ushell/utils"],function(e,t,a,n,r,i,jQuery,s){"use strict";var o="valueStored";var u=["value","noEdit","noStore","extendedValue","alwaysAskPlugin"];function l(s,l,f,d){this._aPlugins=[];this._oUserDefaultParametersNames={};this._oWasParameterPersisted={};var h=this;var c=new i;function m(e){var t=typeof e.getComponentData==="function"&&e.getComponentData()&&e.getComponentData().config&&e.getComponentData().config["sap-priority"]||0;if(typeof t!=="number"||isNaN(t)){return 0}return t}this._insertPluginOrdered=function(e,t){var a=m(t);for(var n=0;n<e.length&&t;++n){var r=m(e[n]);if(t&&a>r){e.splice(n,0,t);t=undefined}}if(t){e.push(t)}return e};this.registerPlugin=function(e){this._aPlugins=this._insertPluginOrdered(this._aPlugins,e)};this._getUserDefaultValueFromPlugin=function(t,a,n,r){var i;if(typeof t.getUserDefault==="function"){i=new Promise(function(i,s){t.getUserDefault(a,r,n).done(function(s){var o=s||r;var u=this._getComponentNameOfPlugin(t);e.debug('[UserDefaults] Fetched "'+a+'" for SystemContext='+n.id+" from Plugin="+u,JSON.stringify(o,null,2));i(o)}.bind(this)).fail(function(){e.error('invocation of getUserDefault("'+a+'") for plugin '+h._getComponentNameOfPlugin(t)+" rejected.",null,"sap.ushell.services.UserDefaultParameters");i(r)})}.bind(this))}else{i=Promise.resolve(r)}return i};this._iterateOverPluginsToGetDefaultValue=function(t,a,n){return new Promise(function(r,i){sap.ushell.Container.getServiceAsync("PluginManager").then(function(s){s.loadPlugins("UserDefaults").done(function(){var e=this._aPlugins.reduce(function(e,a){var r=e.then(this._getUserDefaultValueFromPlugin.bind(this,a,t,n));return r}.bind(this),Promise.resolve(a));e.then(r)}.bind(this)).fail(function(){e.error("Cannot get value for "+t+". One or more plugins could not be loaded.");i("Initialization of plugins failed")})}.bind(this))}.bind(this))};this._getStoreDate=function(){return(new Date).toString()};this._storeValue=function(e,t,a,n){if(a&&t.extendedValue){return sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(r){return new Promise(function(i){r.getUserDefaultParameterNames(n).done(function(r){var s=this._extractKeyArrays(r);var o=s.extended.indexOf(e)<0;this._saveParameterValue(e,t,a,o,n).then(i)}.bind(this)).fail(function(){this._saveParameterValue(e,t,a,false,n).then(i)}.bind(this))}.bind(this))}.bind(this))}return this._saveParameterValue(e,t,a,false,n)};this._saveParameterValue=function(e,a,r,i,s){if(i){a.extendedValue=undefined}if(r&&this._valueIsEmpty(a)){a=undefined;this._oWasParameterPersisted[e]=false}else{a._shellData=n({storeDate:this._getStoreDate()},a._shellData)}return sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(n){return new Promise(function(r){n.saveParameterValue(e,a,s).always(function(){var n={parameterName:e,parameterValue:t(a||{}),systemContext:s};c.fireEvent(o,n);r(e)})})})};this._getPersistedValue=function(e,t){return new Promise(function(a,n){sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(r){r.loadParameterValue(e,t).done(a).fail(n)})})};this._valueIsEmpty=function(e){return!e||!e.value&&!e.extendedValue};this._haveSameMembersValue=function(e,t,n){return n.every(function(n){return e[n]===t[n]||a(e[n],t[n])})};this._getUserDefaultParameterNames=function(e){if(!this._oUserDefaultParametersNames[e.id]){this._oUserDefaultParametersNames[e.id]=new Promise(function(t){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(a){a.getUserDefaultParameterNames(e).done(function(e){var a=this._extractKeyArrays(e);var n=a.extended;var r=a.allParameters;var i=this._arrayToObject(r);t({aAllParameterNames:r,aExtendedParameterNames:n,oMetadataObject:i})}.bind(this))}.bind(this))}.bind(this))}return this._oUserDefaultParametersNames[e.id]};this._isRelevantParameter=function(e,t){return this._getUserDefaultParameterNames(t).then(function(t){if(!t.aAllParameterNames||t.aAllParameterNames.indexOf(e)===-1){throw new Error('The given parameter "'+e+'" is not part of the list of parameters for the given system context.')}})};this.hasRelevantMaintainableParameters=function(e){var t=false;var a=[];return new Promise(function(n){this._getUserDefaultParameterNames(e).then(function(i){if(!r(i)&&i.aAllParameterNames){i.aAllParameterNames.forEach(function(n){var r=this.getValue(n,e);a.push(r);r.done(function(e){if(e&&!e.hasOwnProperty("noEdit")){t=true}})}.bind(this));jQuery.when.apply(undefined,a).done(function(){n(t)}).fail(function(){n()})}else{n()}}.bind(this))}.bind(this))};this.getValue=function(e,a){var n=new jQuery.Deferred;this._isRelevantParameter(e,a).then(function(){return this._getPersistedValue(e,a).then(function(t){this._oWasParameterPersisted[e]=true;return t||{}}.bind(this)).catch(function(){return{value:undefined}})}.bind(this)).then(function(r){var i=t(r);var s=!r._shellData&&this._valueIsEmpty(r)||r.noStore||r.alwaysAskPlugin;if(!s){n.resolve(r);return}return this._iterateOverPluginsToGetDefaultValue(e,r,a).then(function(t){if(!this._oWasParameterPersisted[e]||!this._haveSameMembersValue(i,t,u)){this._oWasParameterPersisted[e]=true;this._storeValue(e,t,false,a).then(function(){n.resolve(t)})}else{n.resolve(t)}}.bind(this)).catch(n.reject)}.bind(this)).catch(function(){n.resolve({value:undefined})});return n.promise()};this._addParameterValuesToParameters=function(e,t,a){var n=new jQuery.Deferred;var r=[];t.forEach(function(t){var n=this.getValue(t,a);r.push(n);n.done(function(a){e[t].valueObject=a})}.bind(this));jQuery.when.apply(jQuery,r).done(n.resolve.bind(n,e)).fail(n.reject.bind(n,e));return n.promise()};this._arrayToObject=function(e){var t={};e.forEach(function(e){t[e]={}});return t};this._getComponentNameOfPlugin=function(e){try{return e.getMetadata().getComponentName()||""}catch(e){return"'name of plugin could not be determined'"}};this._getEditorDataAndValue=function(t,a,r,i,s){var o=this;var u=[];var l=[];this._aPlugins.forEach(function(t){if(typeof t.getEditorMetadata==="function"){var a=new jQuery.Deferred;u.push(a);try{var n=u.length-1;t.getEditorMetadata(i,s).done(function(e){l[n]=e}).always(a.resolve).fail(function(){e.error("EditorMetadata for plugin "+o._getComponentNameOfPlugin(t)+"cannot be invoked.",null,"sap.ushell.services.UserDefaultParameters");a.resolve()})}catch(t){e.error("Error invoking getEditorMetaData on plugin: "+t+t.stack,null,"sap.ushell.services.UserDefaultParameters");a.resolve()}}});jQuery.when.apply(jQuery,u).done(function(){var u=[];var f=l.reverse().reduce(function(e,t){a.forEach(function(a){if(t[a]&&t[a].editorMetadata){e[a].editorMetadata=t[a].editorMetadata}});return e},i);a.forEach(function(e){if(!(f[e]&&f[e].editorMetadata)){u.push(e)}});o._addParameterValuesToParameters(f,a,s).done(function(a){var i=n({},a);r.forEach(function(e){if(i[e]){i[e].editorMetadata=i[e].editorMetadata||{};i[e].editorMetadata.extendedUsage=true}});var s=Object.keys(i).splice(0);s.forEach(function(e){var t;if(i[e].valueObject&&i[e].valueObject.noEdit===true){delete i[e];t=u.indexOf(e);if(t>=0){u.splice(t,1)}}});if(u.length>0){e.error('The following parameter names have no editor metadata and thus likely no configured plugin:\n"'+u.join('",\n"')+'".')}t.resolve(i)}).fail(t.reject.bind(t))})};this.editorGetParameters=function(t){var a=new jQuery.Deferred;Promise.all([sap.ushell.Container.getServiceAsync("PluginManager"),this._getUserDefaultParameterNames(t)]).then(function(n){var r=n[0];var i=n[1];if(i.oMetadataObject.length===0){a.resolve({})}else{r.loadPlugins("UserDefaults").done(function(){this._getEditorDataAndValue(a,i.aAllParameterNames,i.aExtendedParameterNames,i.oMetadataObject,t)}.bind(this)).fail(function(){e.error("One or more plugins could not be loaded");a.reject("Initialization of plugins failed")})}}.bind(this));return a.promise()};this._extractKeyArrays=function(e){var t={simple:e&&e.simple&&Object.keys(e.simple).sort()||[],extended:e&&e.extended&&Object.keys(e.extended).sort()||[]};var a=t.extended.filter(function(e){return t.simple.indexOf(e)<0});t.allParameters=t.simple.concat(a).sort();return t};this.editorSetValue=function(e,t,a){var n=new jQuery.Deferred;this._storeValue(e,t,true,a).then(n.resolve);return n.promise()};this.attachValueStored=function(e){c.attachEvent(o,e)};this.detachValueStored=function(e){c.detachEvent(o,e)}}l.hasNoAdapter=true;return l},true);
//# sourceMappingURL=UserDefaultParameters.js.map