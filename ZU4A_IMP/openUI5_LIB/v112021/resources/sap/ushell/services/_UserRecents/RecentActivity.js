// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_UserRecents/UserRecentsBase","sap/base/Log","sap/base/util/extend","sap/ui/Device","sap/ushell/EventHub","sap/ushell/library"],function(e,t,i,s,r,n){"use strict";var a=n.AppType;var c=e.extend("sap.ushell.services.UserRecents.RecentActivity",{constructor:function(t){e.call(this,"RecentActivity",t,c._compareItems)}});c.MAX_DAYS=30;c.ITEM_COUNT=30;const o=["#Shell-launchURL","#Shell-startGUI","#Shell-startIntent","#Shell-startURL","#Shell-startWDA"];c._compareItems=function(e,t){if(e.appType===t.appType){if(e.appType!==a.APP){return e.url===t.url}const i=e.appId===t.appId;if(i&&o.includes(e.appId)){return e.title===t.title}return i}else if(e.appType===a.APP||t.appType===a.APP){return e.appId===t.appId&&e.url===t.url}return false};c.prototype._updateIfAlreadyIn=function(t,s){return this.oRecentActivities.recentUsageArray.some(function(r){var n;if(c._compareItems(r.oItem,t)){if(t.appType===r.oItem.appType||t.appType!==a.APP){i(r.oItem,t);r.iTimestamp=s;r.oItem.timestamp=s;r.mobile=undefined;r.tablet=undefined;r.desktop=undefined;if(t.appType===r.oItem.appType||t.appType!==a.APP&&r.oItem.appType!==a.APP){r.aUsageArray[r.aUsageArray.length-1]+=1;r.iCount+=1}this.oRecentActivities.recentUsageArray.sort(e.itemSorter)}n=true}else{n=false}return n}.bind(this))};c.prototype._insertNew=function(e,t,i){e.timestamp=t;if(i){e.icon=i}var s={oItem:e,iTimestamp:t,aUsageArray:[1],iCount:1,mobile:undefined,tablet:undefined,desktop:undefined};if(this.oRecentActivities.recentUsageArray.length===this.iMaxItems){this.oRecentActivities.recentUsageArray.pop()}this.oRecentActivities.recentUsageArray.unshift(s)};c.prototype.newItem=function(e){const t=Date.now();const i=this.getActivityIcon(e.appType,e.icon);let s;const n=this.getDayFromDateObj(new Date);return new Promise((a,c)=>{this.load().then(o=>{this.oRecentActivities=this.getRecentActivitiesFromLoadedData(o);if(n!==this.oRecentActivities.recentDay){this.addNewDay();this.oRecentActivities.recentDay=n}s=this._updateIfAlreadyIn(e,t);if(!s){this._insertNew(e,t,i)}this.save(this.oRecentActivities).then(()=>{r.emit("newUserRecentsItem",this.oRecentActivities);a()}).catch(e=>{c(e)})})})};c.prototype.getActivityIcon=function(e,t){switch(e){case a.SEARCH:return t||"sap-icon://search";case a.COPILOT:return t||"sap-icon://co";case a.URL:return t||"sap-icon://internet-browser";default:return t||"sap-icon://product"}};c.prototype.clearAllActivities=function(){return new Promise((e,t)=>{this.save([]).then(()=>{r.emit("userRecentsCleared",Date.now());e()}).catch(e=>{t(e)})})};c.prototype.getRecentItemsHelper=function(e){let t;let i;let r;let n=false;const a=[];const c=[];const o=this.getDayFromDateObj(new Date);if(s.system.desktop){r="desktop"}else if(s.system.tablet){r="tablet"}else{r="mobile"}return new Promise((s,p)=>{this.load().then(h=>{this.oRecentActivities=this.getRecentActivitiesFromLoadedData(h);var l=false;var u;if(o!==this.oRecentActivities.recentDay){this.addNewDay();this.oRecentActivities.recentDay=o;l=true}for(t=0;t<this.oRecentActivities.recentUsageArray.length&&!n;t++){const e={target:{shellHash:""}};i=this.oRecentActivities.recentUsageArray[t];if(i[r]===undefined){if(!(i.oItem.url[0]==="#")){c.push(i.oItem.url)}else if(i.oItem.url.indexOf("?")>-1){u=i.oItem.url.substring(i.oItem.url.indexOf("?"));if(u.indexOf("&/")>-1){u=u.substring(0,u.indexOf("&/"))}const t=i.oItem.appId.split("#")[1];e.target.shellHash=t+u;a.push(e)}else{const t=i.oItem.appId.split("#")[1];e.target.shellHash=t;a.push(e)}}else{n=true}}if(c.length>0){var A;for(t=0;t<this.oRecentActivities.recentUsageArray.length;t++){if(!(this.oRecentActivities.recentUsageArray[t].oItem.url[0]==="#")){A=this.oRecentActivities.recentUsageArray[t];A[r]=true}}if(a.length<=0){this.save(this.oRecentActivities).then(()=>{const t=this._getRecentItemsForDevice(r,this.oRecentActivities,e);s(t)}).catch(e=>{p(e)})}}if(a.length>0){sap.ushell.Container.getServiceAsync("Navigation").then(c=>{c.isNavigationSupported(a).then(a=>{n=false;for(t=0;t<this.oRecentActivities.recentUsageArray.length&&!n;t++){i=this.oRecentActivities.recentUsageArray[t];if(i[r]===undefined){u="";if(i.oItem.url.indexOf("?")>-1){u=i.oItem.url.substring(i.oItem.url.indexOf("?"));if(u.indexOf("&/")>-1){u=u.substring(0,u.indexOf("&/"))}}var c=a[t];i[r]=!!(c&&c.supported)}else if(i.oItem.url[0]==="#"){n=true}}this.save(this.oRecentActivities).then(()=>{const t=this._getRecentItemsForDevice(r,this.oRecentActivities,e);s(t)}).catch(e=>{p(e)})}).catch(e=>{p(e)})})}else if(a.length<=0&&c.length<=0){if(l){this.save(this.oRecentActivities).then(()=>{const t=this._getRecentItemsForDevice(r,this.oRecentActivities,e);s(t)}).catch(e=>{p(e)})}else{const t=this._getRecentItemsForDevice(r,this.oRecentActivities,e);s(t)}}}).catch(e=>{p(e)})})};c.prototype._getRecentItemsForDevice=function(e,t,i){var s=[];var r=0;var n;for(var a=0;a<t.recentUsageArray.length&&(!i||r<i);a++){n=t.recentUsageArray[a];if(n[e]){s.push(n);r++}}return s};c.prototype.getRecentItems=function(){return new Promise((e,t)=>{this.getRecentItemsHelper(c.ITEM_COUNT).then(t=>{e(t.map(e=>e.oItem))}).catch(e=>{t(e)})})};c.prototype.getFrequentItems=function(){return new Promise((e,t)=>{this.getRecentItemsHelper().then(t=>{var i;var s=0;var r=[];var n;var a=t[0]?new Date(t[0].iTimestamp):undefined;var o;for(i=0;i<t.length&&s<c.MAX_DAYS;i++){n=t[i];if(n.iCount>1){r.push(n)}o=new Date(n.iTimestamp);if(a.toDateString()!==o.toDateString()){s++;a=o}}r.sort(function(e,t){return t.iCount-e.iCount});r=r.slice(0,c.ITEM_COUNT);e(r.map(e=>e.oItem))}).catch(e=>{t(e)})})};c.prototype.addNewDay=function(){var e;for(var t=0;t<this.oRecentActivities.recentUsageArray.length;t++){if(this.oRecentActivities.recentUsageArray[t].aUsageArray){e=this.oRecentActivities.recentUsageArray[t].aUsageArray}else{e=[];this.oRecentActivities.recentUsageArray[t].aUsageArray=e;this.oRecentActivities.recentUsageArray[t].iCount=0}e[e.length]=0;if(e.length>c.MAX_DAYS){this.oRecentActivities.recentUsageArray[t].iCount-=e[0];e.shift()}}};c.prototype.getDayFromDateObj=function(e){return e.getUTCFullYear()+"/"+(e.getUTCMonth()+1)+"/"+e.getUTCDate()};c.prototype.getRecentActivitiesFromLoadedData=function(e){var i;if(Array.isArray(e)){i={recentDay:null,recentUsageArray:e}}else{i=e||{recentDay:null,recentUsageArray:[]}}i.recentUsageArray=(i.recentUsageArray||[]).filter(function(e){var i=e&&e.oItem&&e.oItem.url;if(!i){t.error("FLP Recent Activity",e,"is not valid. The activity is removed from the list.")}return i});return i};return c});
//# sourceMappingURL=RecentActivity.js.map