// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_UserRecents/UserRecentsBase","sap/base/Log","sap/ushell/utils"],function(e,a,t){"use strict";var s=e.extend("sap.ushell.services.UserRecents.RecentAppsUsage",{constructor:function(){e.call(this,"AppsUsage")}});s.MAX_DAYS=30;s.prototype.init=function(){return new Promise((e,t)=>{const s=this.getDayFromDateObj(new Date);let p=false;if(!p||s!==this.oAppsUsageData.recentDay){p=true;this.load().then(async a=>{this.oAppsUsageData=a||{recentDay:null,recentAppsUsageMap:{}};await this.calculateInitialUsage(s);e(this.oAppsUsageData)}).catch(()=>{a.error("UShell-lib ; RecentAppsUsage ; Load data in Init failed");t()})}})};s.prototype.calculateInitialUsage=async function(e){if(e!==this.oAppsUsageData.recentDay){this.addNewDay();this.oAppsUsageData.recentDay=e;setTimeout(function(){this.cleanUnusedHashes()}.bind(this),3e3);await this.saveAppsUsage(this.oAppsUsageData)}};s.prototype.addAppUsage=function(e){if(!t.validHash(e)){return Promise.reject("Non valid hash")}return this.init().then(()=>{const a=this.oAppsUsageData.recentAppsUsageMap[e]||[];if(a.length===0){a[0]=1}else{a[a.length-1]+=1}this.oAppsUsageData.recentAppsUsageMap[e]=a;return this.saveAppsUsage(this.oAppsUsageData)}).catch(()=>{a.error("Ushell-lib ; addAppUsage ; Initialization falied!")})};s.prototype.getAppsUsage=function(){return new Promise((e,a)=>{this.init().then(()=>{e(this.summarizeUsage())}).catch(()=>{a("Not initialized yet")})})};s.prototype.summarizeUsage=function(){var e={};var a,t;var s=true;for(var p in this.oAppsUsageData.recentAppsUsageMap){e[p]=this.getHashUsageSum(p);if(s){a=t=e[p];s=false}else if(e[p]<t){t=e[p]}else if(e[p]>a){a=e[p]}}return{usageMap:e,maxUsage:a,minUsage:t}};s.prototype.addNewDay=function(){var e;for(var a in this.oAppsUsageData.recentAppsUsageMap){e=this.oAppsUsageData.recentAppsUsageMap[a];e[e.length]=0;if(e.length>s.MAX_DAYS){e=e.shift()}}};s.prototype.cleanUnusedHashes=function(){var e;for(var a in this.oAppsUsageData.recentAppsUsageMap){e=this.getHashUsageSum(a);if(e===0){delete this.oAppsUsageData.recentAppsUsageMap[a]}}};s.prototype.getHashUsageSum=function(e){var a=0;var t;var s=this.oAppsUsageData.recentAppsUsageMap[e];var p=s.length;for(t=0;t<p;t++){a+=s[t]}return a};s.prototype.saveAppsUsage=function(e){return this.save(e).catch(()=>{a.error("Ushell-lib ; saveAppsUsage ; Save action failed")})};s.prototype.getDayFromDateObj=function(e){return e.getUTCFullYear()+"/"+(e.getUTCMonth()+1)+"/"+e.getUTCDate()};return s});
//# sourceMappingURL=RecentAppsUsage.js.map