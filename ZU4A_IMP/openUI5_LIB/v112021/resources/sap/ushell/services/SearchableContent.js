// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/adapters/cdm/v3/_LaunchPage/readApplications","sap/ushell/adapters/cdm/v3/_LaunchPage/readPages","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/values","sap/ushell/library","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/base/Log","sap/ushell/utils/UrlParsing"],function(e,t,i,a,n,r,o,s,l,u){"use strict";var c=o.DisplayFormat;var p=function(){};p.COMPONENT_NAME="sap/ushell/services/SearchableContent";p.prototype.getApps=function(t={}){const i={includeAppsWithoutVisualizations:false,enableVisualizationPreview:true};const a={includeAppsWithoutVisualizations:t.includeAppsWithoutVisualizations??i.includeAppsWithoutVisualizations,enableVisualizationPreview:t.enableVisualizationPreview??i.enableVisualizationPreview};if(e.last("/core/spaces/enabled")){return this._getPagesAppData(a).then(function(e){return this._filterGetApps(e,a)}.bind(this))}return this._getLaunchPageAppData(a).then(function(e){return this._filterGetApps(e,a)}.bind(this)).then(function(e){l.debug("SearchableContent@getApps in classic mode found "+e.length+" apps");return e}).catch(function(e){l.error("SearchableContent@getApps in classic mode failed",e);return Promise.reject(e)})};p.prototype._filterGetApps=function(e,t){var i=e;i.forEach(function(e){var t=e.visualizations;var i=[];e.visualizations=[];t.forEach(function(t){var a=JSON.stringify({title:t.title,subtitle:t.subtitle,icon:t.icon,vizType:t.vizType});if(i.indexOf(a)===-1){e.visualizations.push(t);i.push(a)}})});if(!t.includeAppsWithoutVisualizations){i=i.filter(function(e){return e.visualizations.length>0})}return i};p.prototype._getLaunchPageAppData=function(e){return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this._oLaunchPageService=e;return this._collectLaunchPageTiles()}.bind(this)).then(function(e){var t=e[0];var i=e[1];var a=t.concat(i);return Promise.all(a.map(function(e){var i=t.includes(e);var a={tileId:null,tile:e};var n;try{if(i){a.tileId=this._oLaunchPageService.getCatalogTileId(e)}else{a.tileId=this._oLaunchPageService.getTileId(e)}n=this._oLaunchPageService.getCatalogTilePreviewTitle(e)}catch(e){l.error("Could not get search data from tile "+a.tileId,e)}if(!n){return new Promise(function(t,a){if(i){this._oLaunchPageService.getCatalogTileViewControl(e).done(t).fail(a)}else{this._oLaunchPageService.getTileView(e).done(t).fail(a)}}.bind(this)).then(function(e){a.view=e;return a}).catch(function(e){l.error("Could not get search data from tile "+a.tileId,e);return a})}return Promise.resolve(a)}.bind(this)))}.bind(this)).then(function(t){var i={};var a=t.map(function(t){try{return this._buildVizDataFromLaunchPageTile(t.tile,e)}catch(e){l.error("Could not get search data from tile "+t.tileId,e);return null}}.bind(this)).filter(function(e){return e});t.forEach(function(e){var t=e.view;if(t){if(!t.destroy){l.error("The tile with id '"+e.tileId+"' does not implement mandatory function destroy")}else{t.destroy()}}});a.forEach(function(e){var t=e.targetURL;if(t){if(i[t]){i[t].visualizations.push(e)}else{i[t]=this._buildAppDataFromViz(e)}}}.bind(this));return r(i)}.bind(this))};p.prototype._collectLaunchPageTiles=function(){var e=this._oLaunchPageService.getGroups().then(function(e){return e.reduce(function(e,t){return Promise.all([e,this._oLaunchPageService.getGroupTilesForSearch(t)]).then(function(e){var t=e[0];var i=e[1];return t.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));var t=this._oLaunchPageService.getCatalogs().then(function(e){return e.reduce(function(e,t){return Promise.all([e,this._oLaunchPageService.getCatalogTiles(t)]).then(function(e){var t=e[0];var i=e[1];return t.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));return Promise.all([t,e])};p.prototype._getPagesAppData=function(e){var t;var i;return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(e){return Promise.all([e.getAllPages({personalizedPages:true}),e.getApplications(),e.getVisualizations(),e.getVizTypes(),sap.ushell.Container.getServiceAsync("ClientSideTargetResolution")])}).then(function(a){var n=a[0];var r=a[1];var o=a[2];var s=a[3];var l=a[4];i={applications:r,visualizations:o,vizTypes:s};t={};this._applyCdmVisualizations(i,t,e);this._applyCdmPages(i,n,t,e);return this._filterAppDataByIntent(t,l)}.bind(this)).then(function(){this._applyCdmApplications(i,t,e);return r(t)}.bind(this))};p.prototype._filterAppDataByIntent=function(e,t){var i=Object.keys(e).map(function(e){return u.isIntentUrlAsync(e).then(function(t){return t?e:null})});return Promise.all(i).then(function(i){var a=i.filter(function(e){return!!e});if(a.length===0){return}var n=500;var r=0;var o=n;var s=[];while(r<a.length){s.push(a.slice(r,o));r=r+n;o=o+n}return s.reduce(function(i,a){return i.then(function(e){return new Promise(function(i,a){t.isIntentSupported(e).done(i).fail(a)})}.bind(null,a)).then(function(t){Object.keys(t).forEach(function(i){if(!t[i].supported&&e[i]){delete e[i]}})}).catch(function(){})},Promise.resolve())})};p.prototype._applyCdmApplications=function(e,i,a){var n={};Object.keys(i).forEach(function(a){try{var n=i[a].visualizations;var r=n.find(function(e){return e.target.appId&&e.target.inboundId});if(r){var o=e.applications[r.target.appId];var s=t.getInbound(o,r.target.inboundId);i[a]=this._buildAppDataFromAppAndInbound(o,s);i[a].visualizations=n;i[a].target=n[0].target}else{i[a]=this._buildAppDataFromViz(n[0]);i[a].visualizations=n;i[a].target=n[0].target}}catch(e){l.error("Could not get search data from application "+a,e)}}.bind(this));if(a.includeAppsWithoutVisualizations){r(i).forEach(function(e){n[e.id]=e});r(e.applications).forEach(function(e){var a=t.getId(e);var o=r(t.getInbounds(e));var s=o.length>0?o[0]:undefined;if(!n.hasOwnProperty(a)){i[a]=this._buildAppDataFromAppAndInbound(e,s,true)}}.bind(this))}};p.prototype._applyCdmVisualizations=function(e,t,i){Object.keys(e.visualizations).forEach(function(n){try{var r={vizId:n,displayFormatHint:c.Standard};var o=a.getVizData(e,r);var s=o.targetURL;if(i.enableVisualizationPreview){this._changeVizType(o);o.preview=true}if(s){if(t[s]){t[s].visualizations.push(o)}else{t[s]={visualizations:[o]}}}}catch(e){l.error("Could not get search data from visualization "+n,e)}}.bind(this))};p.prototype._applyCdmPages=function(e,t,n,r){t.forEach(function(t){var o=i.getVisualizationReferences(t);o.forEach(function(t){try{if(t.displayFormatHint&&t.displayFormatHint!==c.Standard){t=Object.assign({},t);t.displayFormatHint=c.Standard}var i=a.getVizData(e,t);var o=i.targetURL;if(r.enableVisualizationPreview){this._changeVizType(i);i.preview=true}if(o){if(n[o]){n[o].visualizations.push(i)}else{n[o]={visualizations:[i]}}}}catch(e){l.error("Could not get search data from vizReference "+t.id,e)}}.bind(this))}.bind(this))};p.prototype._changeVizType=function(e){if(e._instantiationData.platform==="CDM"&&!s.isStandardVizType(e.vizType)){e.vizType="sap.ushell.StaticAppLauncher";e._instantiationData.vizType={"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}};p.prototype._buildAppDataFromAppAndInbound=function(e,i,a){i=i||{};var r={id:t.getId(e),title:i.title||t.getTitle(e),subtitle:i.subTitle||t.getSubTitle(e),icon:i.icon||t.getIcon(e),info:i.info||t.getInfo(e),keywords:i.keywords||t.getKeywords(e),technicalAttributes:t.getTechnicalAttributes(e),visualizations:[]};var o;if(a){o=n.toHashFromInbound(i);if(o){r.targetURL="#"+o}}return r};p.prototype._buildAppDataFromViz=function(e){return{id:e.vizId,title:e.title,subtitle:e.subtitle,icon:e.icon,info:e.info,keywords:e.keywords,technicalAttributes:e.technicalAttributes,target:e.target,visualizations:[e]}};p.prototype._buildVizDataFromLaunchPageTile=function(e,t){var i;if(this._oLaunchPageService.getCatalogTileTargetURL(e)&&this._oLaunchPageService.isTileIntentSupported(e)){i={id:this._oLaunchPageService.getTileId(e)||this._oLaunchPageService.getCatalogTileId(e),vizId:this._oLaunchPageService.getCatalogTileId(e)||this._oLaunchPageService.getTileId(e)||"",vizType:"",title:this._oLaunchPageService.getCatalogTilePreviewTitle(e)||this._oLaunchPageService.getCatalogTileTitle(e)||this._oLaunchPageService.getTileTitle(e)||"",subtitle:this._oLaunchPageService.getCatalogTilePreviewSubtitle(e)||"",icon:this._oLaunchPageService.getCatalogTilePreviewIcon(e)||"sap-icon://business-objects-experience",info:this._oLaunchPageService.getCatalogTilePreviewInfo(e)||"",keywords:this._oLaunchPageService.getCatalogTileKeywords(e)||[],technicalAttributes:this._oLaunchPageService.getCatalogTileTechnicalAttributes(e)||[],target:{type:"URL",url:this._oLaunchPageService.getCatalogTileTargetURL(e)},targetURL:this._oLaunchPageService.getCatalogTileTargetURL(e)};i._instantiationData={platform:"LAUNCHPAGE",launchPageTile:e};if(e.getContract){e.getContract("preview").setEnabled(t.enableVisualizationPreview)}if(t.enableVisualizationPreview){if(!e.getChip){i._instantiationData={platform:"CDM",vizType:{"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}}}}return i};p.hasNoAdapter=true;return p},true);
//# sourceMappingURL=SearchableContent.js.map