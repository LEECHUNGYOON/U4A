// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/base/util/isPlainObject","sap/fe/navigation/SelectionVariant","sap/base/Log"],function(e,jQuery,t,a,r,n,i){"use strict";function s(t,a){var r=new jQuery.Deferred,n,i=t.resolutionResult,s=t.inbound&&(t.inbound.signature||{}),m=f(i)||s.additionalParameters==="ignored"||c(t);if(!m){u(r,t);return r.promise()}var p=t.intentParamsPlusAllDefaults["sap-xapp-state"]&&t.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(p){b(a,p).then(S).then(function(m){if(f(i)){var p=e.constructParameterDominatorMap(s.parameters);Object.keys(i.oNewAppStateMembers).forEach(function(e){var t=p[e].dominatedBy;if(l(m,t)){delete i.oNewAppStateMembers[e]}})}var d=s.additionalParameters==="ignored";if(!f(i)&&!c(t)&&!d){u(r,t);return}n=a.createEmptyAppState(undefined,true);if(n){n.setData(m);o(n,t,r)}},function(){delete i.oNewAppStateMembers;u(r,t);return});return r.promise()}if(f(i)){var d=a.createEmptyAppState(undefined,true);o(d,t,r);return r.promise()}u(r,t);return r.promise()}function o(e,t,a){var r=e.getData()||{},i,s={},o=t.inbound.signature,m=t.resolutionResult;if(r.selectionVariant){i=new n(JSON.stringify(r.selectionVariant))}else{i=new n}if(f(m)){Object.keys(m.oNewAppStateMembers).forEach(function(e){i.massAddSelectOption(e,m.oNewAppStateMembers[e].Ranges)})}var l=o.additionalParameters==="ignored";i=p(i,s,o.parameters,l);if(i.getParameterNames().length!==0||i.getSelectOptionsPropertyNames().length!==0||s.deleted){r.selectionVariant=i.toJSONObject()}if(!s.changed&&!s.deleted&&!f(m)){u(a,t);return}e.setData(r);e.save().done(function(){t.intentParamsPlusAllDefaults["sap-xapp-state"]=[e.getKey()];t.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[e.getKey()];u(a,t)})}function u(e,t){g(t);P(t);delete t.resolutionResult.oNewAppStateMembers;e.resolve(t)}function f(e){return e.oNewAppStateMembers&&!a(e.oNewAppStateMembers)}function m(e,t){return Array.isArray(e)&&e.some(function(e){return t.indexOf(e)!==-1})}function l(e,t){if(e&&e.selectionVariant){var a=new n(JSON.stringify(e.selectionVariant)),r=a.getSelectOptionsPropertyNames()||[],i=a.getParameterNames()||[];if(m(r,t)||m(i,t)){return true}}return false}function p(e,t,a,r){var s=new n,o=e.getParameterNames()||[],u=e.getSelectOptionsPropertyNames()||[],f,m;o.forEach(function(n){f=e.getParameter(n);if(r&&!a[n]){t.deleted=true;return}if(a[n]&&a[n].renameTo){if(s.getParameter(a[n].renameTo)===undefined&&s.getSelectOption(a[n].renameTo)===undefined){s.addParameter(a[n].renameTo,f);t.changed=true}else{i.error("renaming of appstate creates duplicates "+n+"->"+a[n].renameTo)}}else if(s.getParameter(n)===undefined&&s.getSelectOption(n)===undefined){s.addParameter(n,f)}});u.forEach(function(n){m=e.getSelectOption(n);if(r&&!a[n]){t.deleted=true;return}if(a[n]&&a[n].renameTo){if(s.getSelectOption(a[n].renameTo)===undefined&&s.getParameter(a[n].renameTo)===undefined){s.massAddSelectOption(a[n].renameTo,m);t.changed=true}else{i.error("renaming of appstate creates duplicates "+n+"->"+a[n].renameTo)}}else if(s.getSelectOption(n)===undefined&&s.getParameter(n)===undefined){s.massAddSelectOption(n,m)}});o.forEach(function(t){e.removeParameter(t)});u.forEach(function(t){e.removeSelectOption(t)});s.getParameterNames().forEach(function(t){e.addParameter(t,s.getParameter(t))});s.getSelectOptionsPropertyNames().forEach(function(t){e.massAddSelectOption(t,s.getSelectOption(t))});return e}function d(e){if(e===undefined||r(e)){return false}return true}function c(e){return e.inbound&&e.inbound.signature&&e.inbound.signature.parameters&&Object.keys(e.inbound.signature.parameters).some(function(t){return!!e.inbound.signature.parameters[t].renameTo})}function g(e){e.defaultedParamNames=e.defaultedParamNames.filter(function(t){if(e.intentParamsPlusAllDefaults[t]&&!Array.isArray(e.intentParamsPlusAllDefaults[t])){if(!(e.resolutionResult.oNewAppStateMembers&&e.resolutionResult.oNewAppStateMembers[t])){return false}}return true})}function P(e){var a=t.get("inbound.signature.parameters",e)||{},r={};e.defaultedParamNames.forEach(function(e){var t=a[e]&&a[e].renameTo||e;if(r[t]){i.error("renaming of defaultedParamNames creates duplicates"+e+"->"+t)}else{r[t]=true}});e.mappedDefaultedParamNames=Object.keys(r).sort()}function S(e){if(d(e)){return Promise.reject()}return Promise.resolve(e)}function b(e,t){return new Promise(function(a,r){e.getAppState(t).done(function(e){a(e.getData())}).fail(function(e){r(e)})})}return{mixAppStateIntoResolutionResultAndRename:s,_hasRenameTo:c}});
//# sourceMappingURL=XAppStateProcessing.js.map