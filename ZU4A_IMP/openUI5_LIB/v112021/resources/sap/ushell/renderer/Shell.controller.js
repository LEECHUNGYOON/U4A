// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["./History","sap/base/Log","sap/base/util/extend","sap/base/util/isPlainObject","sap/m/InstanceManager","sap/ui/core/Component","sap/ui/core/Configuration","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/performance/trace/Interaction","sap/ui/performance/Measurement","sap/ui/thirdparty/hasher","sap/ui/thirdparty/jquery","sap/ui/util/Storage","sap/ushell/bootstrap/SchedulingAgent","sap/ushell/components/_HeaderManager/ControlManager","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/components/applicationIntegration/relatedServices/RelatedServices","sap/ushell/components/HeaderManager","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/library","sap/ushell/performance/FesrEnhancer","sap/ushell/renderer/LogonFrameProvider","sap/ushell/resources","sap/ushell/services/AppConfiguration","sap/ushell/UserActivityLog","sap/ushell/utils","sap/ushell/utils/WindowUtils","sap/ushell/renderer/ShellLayout","sap/ushell/renderer/utils","sap/base/util/ObjectPath"],function(e,t,n,i,a,o,r,s,l,c,h,d,p,g,u,f,v,jQuery,m,C,y,S,b,w,_,A,F,P,I,D,E,H,k,N,T,U,L){"use strict";var R=T.LAYOUT_MAPPING;var M=l.routing.HistoryDirection;var B=F.AppType;var x=true;var O=false;var W;var V=S.getElementsModel();var z;var j={embedded:0,newWindowThenEmbedded:1,newWindow:1,replace:0};var q={embedded:"embedded",newWindowThenEmbedded:"newWindowThenEmbedded",newWindow:"newWindow",replace:"replace"};var X={};P.init();const G="Shell.controller";const Y="[FesrFlp]";return c.extend("sap.ushell.renderer.Shell",{_aDoables:[],addDoable:function(e){this._aDoables.push(e)},_aDanglingControls:[],addDanglingControl:function(e){this._aDanglingControls.push(e)},_aDanglingBindings:[],addDanglingBinding:function(e){this._aDanglingBindings.push(e)},removeDanglingBinding:function(e){var t=this._aDanglingBindings.findIndex(function(t){return t===e});if(t>-1){this._aDanglingBindings.splice(t,1)}},_aPendingInitializations:[],addPendingInitialization:function(e){this._aPendingInitializations.push(e);return e},awaitPendingInitializations:function(){var e=this._aPendingInitializations.length;return Promise.allSettled(this._aPendingInitializations).then(function(){var t=this._aPendingInitializations.length;if(e<t){return this.awaitPendingInitializations()}}.bind(this))},onComponentTargetDisplay:function(e){var t=e.getParameters();var n=t.control;var i=t.object;if(this.bRestorePreviousHash){this.bRestorePreviousHash=false}n.navTo("centerViewPort",i.getId(),"show")},onInit:function(){var t=o.getOwnerComponentFor(this.getView()).getRouter();t.getTarget("home").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("appfinder").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("pages").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("workpages").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("runtimeSwitcher").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("wzsearch").attachDisplay(this.onComponentTargetDisplay,this);if(_.last("/core/homeApp/enabled")){t.getTarget("homeapp").attachDisplay(this.onComponentTargetDisplay,this)}t.oHashChanger=h.getInstance();t.initialize(true);this.bEnableHashChange=true;x=true;var n=this.getView();var i=n.getViewData()||{};var a=window.matchMedia("(min-width: 600px)");var r=i.config||{};var l=S.shellElements().model();w.init(r,l);n.setModel(i.helperModel,"helper");n.setModel(i.shellModel);this.initShellModel(r,l);var c=function(e){_.emit("/core/shell/model/isPhoneWidth",!e.matches)};if(a.addListener){a.addListener(c);c(a)}n.setModel(D.i18nModel,"i18n");s.getEventBus().subscribe("externalSearch",this.externalSearchTriggered,this);s.getEventBus().subscribe("sap.ushell","appOpened",this.onAppOpened,this);s.getEventBus().subscribe("ESHSearchFinished",this._logSearchActivity,this);this._setConfigurationToModel();this._registerAndCreateEventHubDoables();W.addHeaderEndItem(["userActionsMenuHeaderButton"],false,["home","app","minimal","standalone","embedded","embedded-home","lean"],true);var d=[];if(r&&!r.moveContactSupportActionToShellHeader){d.push("ContactSupportBtn")}this.history=e;this.oViewPortContainer=s.byId("viewPortContainer");S.init(r.appState,this.oViewPortContainer,r.rootIntent,r.disableHomeAppCache,{ownerComponent:this.getOwnerComponent()},d,r.cacheConfiguration);var g=function(e,n){this.oShellNavigation=e;this.oShellNavigation.registerPrivateFilters(n);this.oShellNavigation.registerExtraRouter(t);this.oShellNavigation.registerNavigationFilter(this._handleEmptyHash.bind(this));this.oShellNavigation.init(this.doHashChange.bind(this));this.oShellNavigation.registerNavigationFilter(this._disableSourceAppRouter.bind(this));this.oShellNavigation.registerNavigationFilter(this.handleDataLoss.bind(this));S.registerHandleHashChange(this.oShellNavigation);A.emit("ShellNavigationInitialized",Date.now())}.bind(this);Promise.all([sap.ushell.Container.getServiceAsync("URLParsing"),sap.ushell.Container.getServiceAsync("ShellNavigation"),sap.ushell.Container.getServiceAsync("AppLifeCycle")]).then(function(e){this.oURLParsing=e[0];var t=e[1];this._oAppLifeCycleService=e[2];g(t,this._oAppLifeCycleService)}.bind(this));sap.ushell.Container.setLogonFrameProvider(this._getLogonFrameProvider());if(p.system.desktop){sap.ui.require(["sap/ushell/renderer/AccessKeysHandler"],function(e){e.init(z)})}window.onbeforeunload=function(){if(sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()&&!(p.browser.name===p.browser.BROWSER.INTERNET_EXPLORER&&S.getCurrentApplication().container.getApplicationType()==="NWBC")){if(!D.browserI18n){D.browserI18n=D.getTranslationModel(window.navigator.language).getResourceBundle()}return D.browserI18n.getText("dataLossExternalMessage")}return undefined};if(_.last("/core/shell/model/contentDensity")){S.getAppMeta()._applyContentDensityClass()}this.initShellUIService();if(!r.disableSignOut&&(r.sessionTimeoutTileStopRefreshIntervalInMinutes>0||r.sessionTimeoutReminderInMinutes>0)){this._createSessionHandler(r)}if(p.system.desktop){sap.ui.require(["sap/ushell/renderer/AccessKeysHandler"],function(e){n.waitForShellLayout().then(function(){var t=document.getElementById(R.NavigationBar);t.addEventListener("focusin",function(){e.bFocusOnShell=false;e.bFocusPassedToExternalHandlerFirstTime=false});t.addEventListener("focusout",function(){e.bFocusOnShell=true;e.bFocusPassedToExternalHandlerFirstTime=true});var n=document.getElementById(R.RendererRootView);n.addEventListener("focusin",function(){e.bFocusOnShell=false;e.bFocusPassedToExternalHandlerFirstTime=false});n.addEventListener("focusout",function(){e.bFocusOnShell=true;e.bFocusPassedToExternalHandlerFirstTime=true})})})}},shellUpdateAggItem:function(e,t){return s.byId(t.getObject())},getViewPortContainer:function(){return s.byId("viewPortContainer")},_registerAndCreateEventHubDoables:function(){[A.once("CenterViewPointContentRendered").do(this._loadCoreExt.bind(this)),A.once("PagesRuntimeRendered").do(this._loadCoreExt.bind(this)),A.once("AppRendered").do(this._loadCoreExtNonUI5.bind(this)),A.on("toggleContentDensity").do(this.toggleContentDensity.bind(this)),A.on("ShellFloatingContainerUndockOnResize").do(this._handleFloatingContainerUndockOnResize.bind(this)),A.on("ShellFloatingContainerDockedIsResized").do(this._emitFloatingContainerResizeEvent.bind(this)),A.on("LaunchpadCustomRouterRouteMatched").do(this._centerViewPort.bind(this)),A.once("CoreResourcesComplementLoaded").do(this._onCoreResourcesComplementLoaded.bind(this)),A.once("loadRendererExtensions").do(this._loadRendererExtensionPlugins.bind(this)),A.once("loadUsageAnalytics").do(this._loadUsageAnalytics.bind(this)),A.once("loadWarmupPlugins").do(this._loadWarmupPlugins.bind(this)),A.once("loadTrackingActivitiesSetting").do(this._loadTrackingActivitiesSetting.bind(this)),A.on("centerViewPort").do(this._centerViewPort.bind(this))].forEach(function(e){this.addDoable(e)}.bind(this))},initShellModel:function(e,t){W=V;W.init(e,t);z=this.getView().getViewData().shellModel;_.emit("/core/shell/model/personalization",_.last("/core/shell/enablePersonalization"))},initShellUIService:function(){S.initShellUIService({fnOnBackNavigationChange:this.onBackNavigationChange.bind(this)});if(X.enableOnlineStatus){sap.ui.require(["sap/ushell/ui5service/UserStatus"],function(e){this.oUserStatus=new e({scopeObject:this.getOwnerComponent(),scopeType:"component"})}.bind(this))}},onBackNavigationChange:function(e){S.setBackNavigationChanged(true);var t=e.getParameters().data;var n=_.last("/core/shell/model/currentState");if(t){S.service().setNavigateBack(t);if(n.stateName==="minimal"||n.stateName==="standalone"||n.stateName==="embedded"){sap.ushell.Container.getRenderer("fiori2").showHeaderItem("backBtn",true)}}else{S.service().resetNavigateBack()}},toggleContentDensity:function(e){var t=e.contentDensity==="compact";S.getAppMeta()._applyContentDensityByPriority(t,true)},_handleEmptyHash:function(e){e=typeof e==="string"?e:"";e=e.split("?")[0];if(e.length===0){var t=this.getView()?this.getView().getViewData():{};X=t.config||{};if(X.migrationConfig){return this.oShellNavigation.NavigationFilterStatus.Continue}if(X.rootIntent){window.setTimeout(function(){window.hasher.setHash(X.rootIntent)},0);return this.oShellNavigation.NavigationFilterStatus.Abandon}}return this.oShellNavigation.NavigationFilterStatus.Continue},_setConfigurationToModel:function(){var e=this.getView().getViewData();if(e){X=e.config||{}}if(X){if(X.states){V.extendStates(X.states);w.extendStates(X.states)}if(X.enableSetTheme!==undefined){z.setProperty("/setTheme",X.enableSetTheme)}z.setProperty("/contentDensity",X.enableContentDensity===undefined?true:X.enableContentDensity);if(X.migrationConfig!==undefined){z.setProperty("/migrationConfig",X.migrationConfig)}if(X.enableUserDefaultParameters!==undefined){z.setProperty("/userDefaultParameters",X.enableUserDefaultParameters)}if(X.disableHomeAppCache!==undefined){z.setProperty("/disableHomeAppCache",X.disableHomeAppCache)}z.setProperty("/enableHelp",_.last("/core/extension/enableHelp"));z.setProperty("/searchAvailable",X.enableSearch!==false)}},_loadTrackingActivitiesSetting:function(e){this._getPersData({container:"flp.settings.FlpSettings",item:"userActivitesTracking"}).then(function(t){if(t===undefined){t=true}z.setProperty("/enableTrackingActivity",t);A.emit("StepDone",e.stepName)}).catch(function(n){t.error("Failed to load tracking activities state from the personalization, tracking activities is disabled",n,"sap.ushell.components.flp.settings.FlpSettings");z.setProperty("/enableTrackingActivity",false);A.emit("StepDone",e.stepName)})},_getPreviousPageDirty:function(){return O},_setPreviousPageDirty:function(e){O=e},getModelConfiguration:function(){var e=this.getView().getViewData();var t;if(e){var i=e.config||{};t=n({},i)}delete t.applications;return t},_getLogonFrameProvider:function(){return I},onExit:function(){this._aDoables.forEach(function(e){e.off()});this._aDoables=[];this._aDanglingControls.forEach(function(e){e.destroy()});this._aDanglingControls=[];this._aDanglingBindings.forEach(function(e){e.destroy()});this._aDanglingBindings=[];s.getEventBus().unsubscribe("externalSearch",this.externalSearchTriggered,this);s.getEventBus().unsubscribe("ESHSearchFinished",this._logSearchActivity,this);s.getEventBus().unsubscribe("sap.ushell","appOpened",this.onAppOpened,this);if(this.oShellNavigation){this.oShellNavigation.hashChanger.destroy()}w.destroy();y.destroy();H.deactivate();W.destroy();S.shellElements().clean();W=undefined},_getCurrentAppRouter:function(){var e=this._oAppLifeCycleService;var t=e&&e.getCurrentApplication&&e.getCurrentApplication();var n=t&&t.componentInstance;if(n){return n.getRouter()}return null},_disableSourceAppRouter:function(e,t){if(!this.bEnableHashChange||this.bRestorePreviousHash){return this.oShellNavigation.NavigationFilterStatus.Continue}var n=this.oShellNavigation.hashChanger.isInnerAppNavigation(e,t);if(!n){var i=this._getCurrentAppRouter();if(i&&i.isInitialized()){i.stop()}}return this.oShellNavigation.NavigationFilterStatus.Continue},_resumeAppRouterIgnoringCurrentHash:function(){var e=this._getCurrentAppRouter();if(e){e.initialize(true)}},handleDataLoss:function(e,t){var n=this.oShellNavigation.hashChanger;var i=n.getReloadApplication();if(this.bReloadApplication!==null&&this.bReloadApplication!==undefined){n.setReloadApplication(this.bReloadApplication);this.bReloadApplication=null}if(t===""||v.disableBlueBoxHashChangeTrigger===true){return this.oShellNavigation.NavigationFilterStatus.Continue}if(!this.bEnableHashChange&&!this.bRedoNavigation){this.bEnableHashChange=true;return this.oShellNavigation.NavigationFilterStatus.Custom}if(this.bRestorePreviousHash){return this.oShellNavigation.NavigationFilterStatus.Continue}if(this.bRedoNavigation){this.bRedoNavigation=false;this.bEnableHashChange=true;this.bExplaceNavigation=false;return this.oShellNavigation.NavigationFilterStatus.Continue}var a=this.oURLParsing.parseShellHash(e);var o=sap.ushell.Container.getRenderer()._isBuiltInIntent(a);var r=a.params["sap-ushell-navmode"];var s=r&&r[0];if(!o&&(this.bExplaceNavigation||s==="explace"||s==="frameless")){this.bExplaceNavigation=false;return this.oShellNavigation.NavigationFilterStatus.Continue}var l=sap.ushell.Container.getDirtyFlag();var c=sap.ushell.Container.isAsyncDirtyStateProviderSet();if(!c&&!l){O=l;return this.oShellNavigation.NavigationFilterStatus.Continue}var h=d.getInstance().getHistoryStateOffset()<0;Promise.all([this._waitForHash(t),sap.ushell.Container.getServiceAsync("NavTargetResolution"),sap.ushell.Container.getDirtyFlagsAsync()]).then(function(t){var n=t[1];var a=t[2];O=a;if(!a){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo");return}if(o){if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}}else{var r="#"+e;n.resolveHashFragment(r).then(function(t){var n=t.targetNavigationMode==="explace"||t.targetNavigationMode==="frameless";var a=h&&t.navigationMode===q.newWindowThenEmbedded;if(n&&!a){this.bExplaceNavigation=true;this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}else if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this.bReloadApplication=i;this._restoreHashUsingAction(e,"redo")}}.bind(this)).catch(function(){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}.bind(this))}}.bind(this));return this._restoreHashUsingAction(t,"undo")},_waitForHash:function(e){var t="#"+e;return new Promise(function(e){var n=function(){var i=t===decodeURIComponent(window.location.hash);if(i){window.removeEventListener("hashchange",n);e()}};window.addEventListener("hashchange",n)})},_handleDirtyStateUserConfirm:function(){t.debug(`${Y} Interaction Start`,"_handleDirtyStateUserConfirm",G);const e=u.notifyAsyncStep();if(window.confirm(D.i18n.getText("dataLossInternalMessage"))){sap.ushell.Container.setDirtyFlag(false);if(b.isBackNavigation()===true){b.resetBackNavigationFlag()}t.debug(`${Y} Interaction End`,"_handleDirtyStateUserConfirm",G);e();O=true;return true}t.debug(`${Y} Interaction End`,"_handleDirtyStateUserConfirm",G);e();return false},_restoreHashUsingAction:function(e,t){var n=this.oShellNavigation.wasHistoryEntryReplaced();var i=this._getRestoreHashStrategy(n,t);this._resumeAppRouterIgnoringCurrentHash();return this._restoreHash(i,e)},_getRestoreHashStrategy:function(e,t){if(e){return{strategy:"replaceHash",stepCount:0}}var n;var i=d.getInstance().getHistoryStateOffset();if(i===undefined||i>=0){i=1}else if(i<0){i=-1}if(t==="undo"){if(i<0){n="historyForward"}else{n="historyBack"}this.sLastUndoStrategy=n}else{switch(this.sLastUndoStrategy){case"historyBack":n="historyForward";break;case"historyForward":n="historyBack";break;default:n="replaceHash"}}return{strategy:n,stepCount:1}},_restoreHash:function(e,t){var n={status:this.oShellNavigation.NavigationFilterStatus.Custom,hash:""};switch(e.strategy){case"historyBack":this.bEnableHashChange=false;this._windowHistoryBack(e.stepCount);break;case"historyForward":this.bEnableHashChange=false;this._windowHistoryForward(e.stepCount);break;case"replaceHash":this.bEnableHashChange=false;v.replaceHash(t);break;default:throw new Error("Cannot execute unknown navigation strategy")}return n},_setEnableHashChange:function(e){this.bEnableHashChange=e},_logRecentActivity:async function(e){if(!this.oInitialEnableTrackingPromise){if(_.last("/core/shell/model/enableTrackingActivity")!==undefined){this.oInitialEnableTrackingPromise=Promise.resolve()}else{this.oInitialEnableTrackingPromise=new Promise(function(e){_.once("/core/shell/model/enableTrackingActivity").do(e)})}}return this.oInitialEnableTrackingPromise.then(function(){if(_.last("/core/shell/model/enableTrackingActivity")){return new Promise(function(t,n){E.addActivity(e).done(t).fail(n)})}t.warning("Tracking is not enabled",null,"sap.ushell.renderer.Shell.controller");return Promise.reject()})},doHashChange:function(e,n,i,a,o){t.debug(`${Y} Interaction Start`,"doHashChange",G);const r=u.notifyAsyncStep();f.start("FLP:ShellController.doHashChange","doHashChange","FLP");k.setPerformanceMark("FLP-ShellController-doHashChange-begin");A.emit("trackHashChange",e);var l=s.byId("sapUshellDashboardPage");if(l){l.setBlocked(true);l.setBusy(true)}return this._doHashChange(this,e,n,i,a,o).then(function(){f.end("FLP:ShellController.doHashChange");t.debug(`${Y} Interaction End`,"doHashChange",G);r()},function(){f.end("FLP:ShellController.doHashChange");A.emit("doHashChangeError",Date.now());if(l){l.setBlocked(false);l.setBusy(false)}t.debug(`${Y} Interaction End`,"doHashChange",G);r()})},_doHashChange:function(e,t,n,i,a,o){this._wasHistoryEntryReplaced=this.oShellNavigation.wasHistoryEntryReplaced();this.oShellNavigation.resetHistoryEntryReplaced();var r;if(!this.bEnableHashChange){this.bEnableHashChange=true;return jQuery.when()}if(this.bRestorePreviousHash){this.bRestorePreviousHash=false;return jQuery.when()}if(o){e.hashChangeFailure(e.history.getHistoryLength(),o.message,null,"sap.ushell.renderer.Shell.controller",false);return jQuery.when()}var l=new jQuery.Deferred;var c=e.history.getHistoryLength();var h=e.fixShellHash(t);var d=e.fixShellHash(i);e.history.hashChange(h,i);e.currentAppBeforeNav=E.getCurrentApplication();e._resolveHashFragment(h).then(function(t,o){var p=o?o.semanticObject+"-"+o.action:"";var g=e._getConfig();var u=!!(t&&t.componentHandle);var v=t&&t.ui5ComponentName;t=e._calculateNavigationMode(t);if(e.currentAppBeforeNav){S.storeAppExtensions()}e._handleEarlyNavigation(h,n,t).then(function(m){if(m!==true){if(g&&g.applications&&g.applications[p]){t.applicationConfiguration=g.applications[p]}r=S.getInMemoryInstance(p,h,n,i);if(r.isInstanceSupported){e._initiateApplication(t,h,o,c,n,d,a);l.resolve();return}if(u||!v){var C=new jQuery.Deferred;if((t.applicationType==="URL"||k.isSAPLegacyApplicationType(t.applicationType))&&r.isInstanceSupported===false&&r.appId){S.destroyApplication(r.appId,r.container,C)}else{C.resolve()}C.done(function(){e._initiateApplication(t,h,o,c,n,d,a);l.resolve()});return}S.destroyApplication(r.appId,r.container);S.removeApplication(p);E.setApplicationInInitMode();s.getEventBus().publish("ApplicationContainer","_prior.newUI5ComponentInstantion",{name:v});f.start("FLP:ShellController.UI5createComponent","UI5 createComponent","FLP");sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(){S.createComponent(t,o).done(function(){f.end("FLP:ShellController.UI5createComponent");e._initiateApplication(t,h,o,c,n,d,a)}).fail(function(t){var n=D.i18n.getText("cannot_load_ui5_component_details",[h]);var i="Failed to load UI5 component for navigation intent "+h;E.setCurrentApplication(e.currentAppBeforeNav);e.hashChangeFailure(c,{title:D.i18n.getText("error"),message:D.i18n.getText("failed_to_open_ui5_component"),technicalMessage:i},{info:n,technicalMessage:t.message+"\n"+t.stack},"sap.ushell.renderer.Shell.controller",false)})})}l.resolve()})},function(t){var n=D.i18n.getText("cannot_resolve_navigation_target_details",[h]);var i="Failed to resolve navigation target: "+h+". This is most likely caused by an incorrect SAP Fiori launchpad content configuration or by missing role assignment.";e.hashChangeFailure(c,{title:D.i18n.getText("error"),message:D.i18n.getText("failed_to_open_app_missing_configuration_or_role_assignment"),technicalMessage:i},{info:n,fixedShellHash:h,technicalMessage:t},"sap.ushell.renderer.Shell.controller",false);l.reject(i)});return l.promise()},_handleEarlyNavigation:function(e,n,i){var o=this;var r;return new Promise(function(l){o._openAppViaNWBC(i).then(function(c){if(c===true){i.sFixedShellHash=e;o.logOpenAppAction(i,n).catch(()=>{t.info("NWBC application was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});r=s.byId("sapUshellDashboardPage");if(r){r.setBlocked(false);r.setBusy(false)}l(true);return}var h=i&&i.navigationMode===q.newWindow;if(h){i.sFixedShellHash=e;o.logOpenAppAction(i,n).catch(()=>{t.info("Application in new window was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});sap.ui.require(["sap/ushell/components/container/ApplicationContainer"],function(e){i.url=e.prototype._checkNwbcUrlAdjustment(undefined,i.applicationType,i.url,true);o._openAppInNewWindowAndRestore(i);r=s.byId("sapUshellDashboardPage");if(r){r.setBlocked(false);r.setBusy(false)}l(true)});return}if(a&&x){a.closeAllDialogs();a.closeAllPopovers()}x=true;if(_.last("/core/shell/model/migrationConfig")){X.migrationConfig=false;o.getModel().setProperty("/migrationConfig",false);if(i&&e==="#"){X.rootIntent=""}else if(e==="#"){window.setTimeout(function(){window.hasher.setHash(X.rootIntent)},0);l(true);return}}l(false);return})})},_initiateApplication:function(e,n,i,a,o,r){f.start("FLP:ShellController._initiateApplication","_initiateApplication","FLP");var s=E.getMetadata(e);var l=_.last("/core/extension/SupportTicket");var c;if(s.title){window.document.title=s.title}else{t.debug("Shell controller._initiateApplication: the title of the window is not changed because most probably the application was resolved with undefined")}if(l){window.setTimeout(function(){H.activate()},0)}try{c=this.oShellNavigation.isInitialNavigation();this.navigate(i,n,s,e,r)}catch(e){if(e.stack){t.error("Application initialization (Intent: \n"+n+"\n failed due to an Exception:\n"+e.stack)}this.oShellNavigation.setIsInitialNavigation(c);this.hashChangeFailure(a,e.name,e.message,s?s.title:"",false)}f.end("FLP:ShellController._initiateApplication")},_resolveHashFragment:function(e){f.start("FLP:ShellController._resolveHashFragment","_resolveHashFragment","FLP");var t=this.oURLParsing.parseShellHash(e);var n=new jQuery.Deferred;var i=this._getConfig();if(window["sap-ushell-async-libs-promise-directstart"]){window["sap-ushell-async-libs-promise-directstart"].then(function(e){n.resolve(e.resolvedHashFragment,t);delete window["sap-ushell-async-libs-promise-directstart"]},function(e){n.reject(e);delete window["sap-ushell-async-libs-promise-directstart"]});return n.promise()}sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(a){a.resolveHashFragment(e).done(function(e){E.setCurrentApplication(e);if(t&&t.semanticObject+"-"+t.action===i.rootIntent){e.navigationMode="embedded"}f.end("FLP:ShellController._resolveHashFragment");k.setPerformanceMark("FLP-ShellController-resolveHashFragment-end");n.resolve(e,t)}).fail(function(e){n.reject(e)})});return n.promise()},_calculateNavigationMode:function(e){if(!e){return undefined}var t=e.navigationMode;if(t===q.newWindowThenEmbedded){if(k.isColdStart()||d.getInstance().getDirection()===M.Backwards){e.navigationMode=q.embedded}else{e.navigationMode=q.newWindow;if(!k.isNativeWebGuiNavigation(e)){e.url=this._getCurrentLocationHash()}}return e}if(t===q.newWindow&&k.isColdStart()){if(this._hasAppCapabilitiesNavigationMode(e)&&e.appCapabilities.navigationMode===q.embedded){e.navigationMode=q.embedded;return e}e.navigationMode=q.replace;return e}if(t===q.newWindow&&this._hasAppCapabilitiesNavigationMode(e)&&e.appCapabilities.navigationMode===q.embedded){e.url=this._getCurrentLocationHash()}return e},_hasAppCapabilitiesNavigationMode:function(e){return k.isPlainObject(e.appCapabilities)&&e.appCapabilities.hasOwnProperty("navigationMode")},_usesNavigationRedirect:function(e){if(!e){return(new jQuery.Deferred).reject().promise()}var n=this;var i=e.getInstance({});if(i&&typeof i.navigationRedirect==="function"){var a=new jQuery.Deferred;var o=i.navigationRedirect();if(o&&typeof o.then==="function"){o.then(function(e){t.warning("Performing navigation redirect to hash "+e);i.destroy();n.history.pop();sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(t){t.toExternal({target:{shellHash:e}},undefined,false);a.resolve(true)})},function(){a.reject()});return a.promise()}}return(new jQuery.Deferred).reject().promise()},navigate:function(e,n,a,o,r){f.start("FLP:ShellController.navigate","navigate","FLP");var s=i(o)?o.navigationMode:null;var l=this;if(s===null){if(k.isColdStart()){window.hasher.setHash("");return}this.bEnableHashChange=false;this.history.pop();this._windowHistoryBack(1);return Promise.resolve()}o=this._calculateNavigationMode(o);s=i(o)?o.navigationMode:null;if(!s){t.error("Mandatory member 'navigationMode' is missing in the resolution result! Temporarily set to 'embedded' for further processing...","sap.ushell.renderer.Shell.controller");s="embedded"}if(s===q.embedded){if(!k.isColdStart()&&!this._wasHistoryEntryReplaced){this.oShellNavigation.setIsInitialNavigation(false)}var c=this._usesNavigationRedirect(o.componentHandle);var h=new Promise(function(t){c.then(null,function(){l._handleEmbeddedNavMode(n,e,a,o,r).then(function(){A.emit("CloseFesrRecord",{time:Date.now(),technicalName:a.technicalName});t()})});f.end("FLP:ShellController.navigate")});return h}if(s===q.replace){this.oShellNavigation.setIsInitialNavigation(false);this.bEnableHashChange=false;this._changeWindowLocation(o.url);return Promise.resolve()}if(s===q.newWindow){this._openAppInNewWindowAndRestore(o);return Promise.resolve()}this.hashChangeFailure(this.history.getHistoryLength(),"Navigation mode is not recognized",null,"sap.ushell.renderer.Shell.controller",false);return Promise.resolve()},_openAppViaNWBC:function(e){var n=this;return new Promise(function(i){var a;if(e&&(k.isNativeWebGuiNavigation(e)||e.nativeNWBCNavigation)){a=true}else{a=false}if(a===false){i(false);return}var o=k.getPrivateEpcm();var r=j[e.navigationMode];var l;var c;if(k.hasNavigationModeCapability()){c=r||j[q.embedded]}var h=n._appendUserIdToUrl("sap-user",e.url).then(async function(t){l=await k.appendSapShellParam(t);return new Promise(function(t){try{var n=e.applicationType;var i=e.appCapabilities&&e.appCapabilities.appFrameworkId;var a={};var o=[];var r;var s=function(){a["sap-flp-url"]=sap.ushell.Container.getFLPUrl(true);a["system-alias"]=e.systemAlias;return[{name:"sap-flp-params",value:JSON.stringify(a)}]};var c=function e(t,n){var i=[];var a=function(e,a){if(t.indexOf(e+"=")>0){var o=new RegExp("(?:"+e+"=)([^&/]+)").exec(t);if(o&&o.length===2){i.push([o[1]]);n.push(a)}}};a("sap-iapp-state","sap-iapp-state-data");a("sap-xapp-state","sap-xapp-state-data");a("sap-xapp-state-data","sap-xapp-state-data");a("sap-intent-param","sap-intent-param-data");return i};if(k.isSAPLegacyApplicationType(n,i)){sap.ushell.Container.getServiceAsync("Navigation").then(function(e){r=c(l,o);if(r.length>0){e.getAppStateData(r).then(function(e){o.forEach(function(t,n){if(e[n][0]){a[t]=e[n][0]}});t(s())},function(){t()})}else{t(s())}})}else{t()}}catch(e){t()}})});h.then(function(a){try{s.getEventBus().publish("launchpad","appOpening",e);if(!o.doNavigate(l,c,undefined,undefined,undefined,undefined,undefined,a)){i(false);return}s.getEventBus().publish("sap.ushell","appOpened",e);n._restoreAfterNwbcNavigation(e).then(function(){if(n._oAppLifeCycleService.getCurrentApplication()&&n._oAppLifeCycleService.getCurrentApplication().homePage){n._setMenuVisible(true)}i(true)})}catch(a){if(a.stack){t.error("Application initialization failed due to an Exception:\n"+a.stack)}n.hashChangeFailure(n.history.getHistoryLength(),a.name,a.message,e.text,false);i(false)}})})},_restoreAfterNwbcNavigation:function(e){if(this.history.getHistoryLength()===1&&!this._oAppLifeCycleService.getCurrentApplication()){return sap.ushell.Container.getServiceAsync("Navigation").then(function(e){e.navigate({target:{shellHash:"#"},writeHistory:false})})}this._restorePreviousHashAfterOpenNewWindow(e);return Promise.resolve()},_appendUserIdToUrl:function(e,t){return sap.ushell.Container.getServiceAsync("UserInfo").then(function(n){var i=n.getUser().getId();var a=t.indexOf("?")>=0?"&":"?";return t+a+e+"="+i})},_restorePreviousHashAfterOpenNewWindow:function(e){this.history.pop();var t=e.componentHandle&&e.componentHandle.getInstance&&e.componentHandle.getInstance({});if(t){t.destroy()}this._resumeAppRouterIgnoringCurrentHash();this.bRestorePreviousHash=true;this._windowHistoryBack(1);E.setCurrentApplication(this.currentAppBeforeNav);A.emit("openedAppInNewWindow",Date.now())},_openAppInNewWindowAndRestore:function(e){s.getEventBus().publish("launchpad","appOpening",e);this._openAppNewWindow(e.url);s.getEventBus().publish("sap.ushell","appOpened",e);this._restorePreviousHashAfterOpenNewWindow(e)},_handleEmbeddedNavMode:function(e,t,n,i,a){f.start("FLP:ShellController._handleEmbeddedNavMode","_handleEmbeddedNavMode","FLP");var o=this,r=this._getConfig();this.resetShellUIServiceHandlers();S.getAppMeta().setAppIcons();var s="-"+t.semanticObject+"-"+t.action;var l=e==="#"||r.rootIntent&&k.getBasicHash(r.rootIntent)===t.semanticObject+"-"+t.action;var c=t?t.semanticObject+"-"+t.action:"";S.switchViewState(S.shellElements().calculateElementsState(l?"home":"app",i.applicationType,r.appState,i.explicitNavMode),undefined,s);if(l){S.getShellUIService().setBackNavigation()}i.sFixedShellHash=e;var h=S.handleControl(c,s,t,i,this.getWrappedApplicationWithMoreStrictnessInIntention.bind(this),e,a);if(this.currentAppBeforeNav){if(k.isTRApplicationType(this.currentAppBeforeNav.applicationType,L.get("appCapabilities.appFrameworkId",this.currentAppBeforeNav))&&!k.isTRApplicationType(i.applicationType)){sap.ui.require(["sap/ushell/components/applicationIntegration/application/BlueBoxHandler","sap/ushell/components/applicationIntegration/application/WebGUIStatefulHandler"],function(e,t){var n=e.getBlueBoxByUrl(o.currentAppBeforeNav.url);if(n&&n.getStatefulType()===e.STATEFUL_TYPES.GUI_V1){t.guiStatefulCloseCurrentApp(n)}})}}f.end("FLP:ShellController._handleEmbeddedNavMode");return h},_centerViewPort:function(){this.oViewPortContainer.switchState("Center")},_isShellHomeIntent:function(e){return e==="#"||e===X.rootIntent},getWrappedApplicationWithMoreStrictnessInIntention:function(e,n,i,a,o,r,l){var c=this;if(p.system.desktop){sap.ui.require(["sap/ushell/renderer/AccessKeysHandler"],function(e){var t=s.byId("shellAppTitle");if(t&&_.last("/core/shell/model/currentState/stateName")==="app"){var n=t.getFocusDomRef();if(n){e.sendFocusBackToShell(n.getAttribute("id"))}}})}window.setTimeout(function(){window.setTimeout(function(){c.readNavigationEnd()},600);s.getEventBus().publish("launchpad","appOpening",a);t.info("app is being opened")},0);if(X.applications){a.applicationConfiguration=X.applications[e]}var h=S.getAppContainer(o,a,k.isColdStart(),i,l);var d=false;if(h.getIsFetchedFromCache&&h.getIsFetchedFromCache()){d=true}if(!d){S.publishNavigationStateEvents(h,a,this.onAppAfterRendering.bind(this,a));if(k.isSAPLegacyApplicationType(h.getApplicationType(),h.getFrameworkId())){h.addStyleClass("sapUShellApplicationContainerShiftedIframe")}if(!r){h.addStyleClass("sapUShellApplicationContainerLimitedWidth")}if(this._isFloatingContainerDocked()&&window.matchMedia("(min-width: 106.4rem)").matches){h.addStyleClass("sapUShellDockingContainer");h.removeStyleClass("sapUShellApplicationContainerLimitedWidth")}else if(this._isFloatingContainerDocked()){h.removeStyleClass("sapUShellApplicationContainerLimitedWidth")}h.toggleStyleClass("sapUshellDefaultBackground",!n.hideLightBackground);S.getAppMeta()._applyContentDensityByPriority();S.addControl(h)}k.setPerformanceMark("FLP - addAppContainer");f.end("FLP:ShellController.getWrappedApplication");return h},resetShellUIServiceHandlers:function(){S.getAppMeta().resetShellUIServiceHandlers();S.setBackNavigationChanged(false)},onAppAfterRendering:function(e){var n=S.getShellUIService();window.setTimeout(function(){s.getEventBus().publish("sap.ushell","appOpened",e);t.info("app was opened")},0);var i=S._publicEventDataFromResolutionResult(e);A.emit("AppRendered",i,true);U.publishExternalEvent("appOpened",i);k.setPerformanceMark("FLP.appOpened");if(n){S.initAppMetaParams()}W.updateStateProperty("application/icon",S.getAppMeta().getAppIcon(),true)},_saveHomePageComponent:function(){if(this.oHomeApp){return}var e=this;var t="sap.ushell";var n=function(i,a,o){e.oHomeApp=o.component;s.getEventBus().unsubscribe(t,"appComponentLoaded",n)};s.getEventBus().subscribe(t,"appComponentLoaded",n)},hashChangeFailure:function(e,t,n,i,a){var o=s.byId("sapUshellDashboardPage");if(o){o.setBlocked(false);o.setBusy(false)}if(k.isPlainObject(t)){this.reportError(t.technicalMessage,n.technicalMessage,i);sap.ushell.Container.getServiceAsync("Message").then(function(e){e.show(e.Type.ERROR,t.message,{title:t.title,details:n})})}else{this.reportError(t,n,i);this.delayedMessageError(D.i18n.getText("fail_to_start_app_try_later"))}x=false;this._resumeAppRouterIgnoringCurrentHash();if(e===0){window.hasher.setHash("")}else if(new URLSearchParams(window.location.search).get("bFallbackToShellHome")){window.hasher.setHash("")}else{this.bEnableHashChange=a;sap.ushell.Container.setDirtyFlag(O);this._windowHistoryBack(1)}},reportError:function(e,n,i){t.error(e,n,i)},delayedMessageError:function(e){window.setTimeout(function(){if(sap.ushell.Container!==undefined){sap.ushell.Container.getServiceAsync("Message").then(function(t){t.error(e)})}},0)},fixShellHash:function(e){if(!e){e="#"}else if(e.charAt(0)!=="#"){e="#"+e}return e},_openAppNewWindow:function(e){var t=N.openURL(e);if(!t&&!this._checkWindowLocationSearch("workzone-mobile-app=true")){var n=D.i18n.getText("fail_to_start_app_popup_blocker",[window.location.hostname]);this.delayedMessageError(n)}},_checkWindowLocationSearch:function(e){return window.location.search.indexOf(e)>-1},_windowHistoryBack:function(e){window.history.go(-1*e)},_windowHistoryForward:function(e){window.history.go(e)},_changeWindowLocation:function(e){window.location.href=e},_setMenuVisible:function(e){var t=document.getElementById(R.NavigationBar);if(!t){return}e=e||_.last("/core/menu/enabled")&&_.last("/core/menu/visibleInAllStates");t.classList.toggle("sapUshellShellHidden",!e)},onAppOpened:function(e,n,i){if(i.targetNavigationMode!=="explace"&&i.targetNavigationMode!=="frameless"){this._setMenuVisible(false)}var a=this.oShellNavigation.hashChanger.getAppHash();var o=a?"&/"+a:null;this.logOpenAppAction(i,o).catch(()=>{t.info("Opened application was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});this._notifyUITracer(i)},externalSearchTriggered:function(e,t,n){_.emit("/core/shell/model/searchTerm",n.searchTerm);n.query=n.searchTerm},onBeforeNavigate:function(e){var t=e.getParameter("to");var n=this.getOwnerComponent();var i=t===n.byId("Shell-home-component-container");var a=t===n.byId("pages-component-container");var o=t===n.byId("homeApp-component-container");var r=t===n.byId("workPageRuntime-component-container");var s=t===n.byId("runtimeSwitcher-component-container");var l=i||a||o||r||s;S.onBeforeNavigate(e.getParameter("fromId"),e.getParameter("from"),e.getParameter("toId"),e.getParameter("to"));this._setMenuVisible(l)},onAfterNavigate:function(e){var t=e.mParameters?e.mParameters.toId:undefined;var n=s.byId("sapUshellDashboardPage");if(n){n.setBlocked(false);n.setBusy(false)}S.onAfterNavigate(e.getParameter("fromId"),e.getParameter("from"),t,e.getParameter("to"));s.getEventBus().publish("sap.ushell","navigated",{})},logOpenAppAction:async function(e,t){const n=_.last("/core/shell/enableRecentActivity")&&_.last("/core/shell/enableRecentActivityLogging");if(!n){return Promise.reject()}const i=E.getMetadata(e);const a=e.sFixedShellHash||this._getCurrentLocationHash();const o={title:i.title,appType:B.APP,url:t?a+t:a};const r=await sap.ushell.Container.getServiceAsync("URLParsing");const s=r.parseShellHash(a);if(s){o.appId="#"+r.constructShellHash({semanticObject:s.semanticObject,action:s.action})}else{o.appId=a}if(a&&a.indexOf("#Action-search")===-1&&a.indexOf("#Shell-startIntent")===-1){return new Promise((e,t)=>{window.setTimeout(()=>{this._logRecentActivity(o).then(e).catch(t)},1500)})}return Promise.reject()},_notifyUITracer:function(e){try{var n=e.ui5ComponentName;if(e.reservedParameters){n=e.reservedParameters["sap-fiori-id"]||e.reservedParameters["sap-ui-app-id-hint"]}A.emit("UITracer.trace",{reason:"NavigateApp",source:"Intent",data:{applicationId:n||"",applicationType:e.applicationType||"",hash:e.sFixedShellHash||"",targetNavigationMode:e.targetNavigationMode||"",providerId:e.contentProviderId||"",targetUrl:e.url||""}})}catch(e){t.warning("Could not emit UITracer.trace event",e,"sap.ushell.renderer.Shell.controller")}},_logSearchActivity:function(){if(_.last("/core/shell/enableRecentActivity")&&_.last("/core/shell/enableRecentActivityLogging")){var e="";try{e=s.byId("searchFieldInShell-input").getModel().getLastSearchTerm()}catch(e){t.error("Shell: last search term is not available to log a recent activity")}this._logRecentActivity({appId:"#Action-search",appType:B.SEARCH,title:e,url:"#"+window.hasher.getHash()}).catch(()=>{t.info("Search activity was not logged.",undefined,"sap.ushell.renderer.Shell.controller")})}},readNavigationEnd:function(){var e=document.getElementById("sapUshellLoadingAccessibilityHelper-loadingComplete");if(e){e.setAttribute("aria-live","polite");e.innerHTML=D.i18n.getText("loadingComplete");window.setTimeout(function(){e.setAttribute("aria-live","off");e.innerHTML=""},0)}},_loadCoreExtNonUI5:function(e){if(e&&e.applicationType!=="SAPUI5"){this._loadCoreExt()}},_loadUsageAnalytics:function(e){sap.ushell.Container.getServiceAsync("UsageAnalytics").then(function(t){t.init(D.i18n.getText("usageAnalytics"),D.i18n.getText("i_agree"),D.i18n.getText("i_disagree"),D.i18n.getText("remind_me_later"));A.emit("StepDone",e.stepName)},function(){A.emit("StepFailed",e.stepName)})},_onCoreResourcesComplementLoaded:function(){k.setPerformanceMark("SchedulingAgent-StartOfFlow");var e=this.getView();if(e){e.createPostCoreExtControls()}C._initialize();A.emit("startScheduler")},_loadRendererExtensionPlugins:function(e){var t=new URLSearchParams(window.location.search);var n=t.get("sap-ushell-xx-pluginmode")==="delayed";function i(t){function i(){A.emit("StepDone",e.stepName)}function a(){t.loadPlugins("RendererExtensions").always(i)}if(n){window.setTimeout(a,5e3)}else{a()}}sap.ushell.Container.getServiceAsync("PluginManager").then(i.bind(this))},_loadWarmupPlugins:function(e){sap.ushell.Container.getServiceAsync("PluginManager").then(function(n){n.loadPlugins("AppWarmup").always(function(){t.debug("WARMUP plugins loaded",null,"sap.ushell.renderer.Shell");A.emit("StepDone",e.stepName);k.setPerformanceMark("SchedulingAgent-EndOfFlow");k.setPerformanceMeasure("SchedulingAgentTotalTime","SchedulingAgent-StartOfFlow","SchedulingAgent-EndOfFlow")})})},_loadCoreExt:function(){f.end("FLP:Container.InitLoading");sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(){A.emit("loadCoreResourcesComplement",Date.now())})},getCurrentViewportState:function(){return _.last("/core/shell/model/currentViewPortState")},_activateFloatingUIActions:function(e){if(e<417){this.oFloatingUIActions.disable()}else{this.oFloatingUIActions.enable()}},setFloatingContainerDragSelector:function(e){if(!this._oFloatingContainerPromise){this._oFloatingContainerPromise=this.getView().createFloatingContainer()}this._oFloatingContainerPromise.then(function(){var n=document.querySelector(e);if(n){n.classList.add("sapUshellFloatingContainerSelector")}else{t.error("setFloatingContainerDragSelector could not find the element","sap.ushell.renderer.Shell.controller")}sap.ui.require(["sap/ushell/UIActions"],function(n){if(!this.oFloatingUIActions){this.oFloatingUIActions=new n({containerSelector:".sapUiBody",wrapperSelector:".sapUshellFloatingContainerWrapper",draggableSelector:".sapUshellFloatingContainerWrapper",rootSelector:".sapUiBody",cloneClass:"sapUshellFloatingContainer-clone",dragCallback:this._handleFloatingContainerDrag.bind(this),endCallback:this._handleFloatingContainerDrop.bind(this),moveTolerance:3,onDragStartUIHandler:this._onFloatingContainerDragStart.bind(this),onDragEndUIHandler:this._onFloatingContainerDragEnd.bind(this),dragAndScrollCallback:this._onFloatingContainerDrag.bind(this),switchModeDelay:1e3,isLayoutEngine:false,isTouch:false,elementToCapture:e,defaultMouseMoveHandler:function(){},debug:t.getLevel()>=t.Level.DEBUG})}else{this.oFloatingUIActions.elementsToCapture=jQuery(e)}this._activateFloatingUIActions(jQuery(window).width());var i;addEventListener("resize",function(){clearTimeout(i);i=window.setTimeout(this._activateFloatingUIActions(jQuery(window).width()),300)}.bind(this))}.bind(this))}.bind(this))},_onFloatingContainerDrag:function(e){f.start("FLP:Shell.controller._doDock","dragging co-pilot element","FLP");if(!this._isFloatingContainerDockSupported()){f.end("FLP:Shell.controller._doDock");return}var t=jQuery(window).width();if(e){e.docked={};var n=e.docked;if(e.moveX>=t-64){n.dockPos="right";n.setIsDockingAreaOpen=true;this._handleDockingPreview(e)}else if(e.moveX<64){n.dockPos="left";n.setIsDockingAreaOpen=true;this._handleDockingPreview(e)}else{if(this._isDockingAreaOpen()){this._handleDockingPreview(false)}if(this._isFloatingContainerDocked()){this._handleDockingPreview(false);this._undockFloatingContainer()}}}f.end("FLP:Shell.controller._doDock")},_isFloatingContainerDockSupported:function(){var e=p.media.getCurrentRange(p.media.RANGESETS.SAP_STANDARD);return e.name==="Desktop"},_finishDoDock:function(e){this._handleDockingPreview(false);this._saveFloatingContainerState("docked:"+e.dockPos);this._moveFloatingContainerIntoDock(e);const t={isDocked:(this.getFloatingContainerState()||"").startsWith("docked"),isVisible:this.getFloatingContainerVisibility()};s.getEventBus().publish("launchpad","shellFloatingContainerIsDocked",t)},_expandFloatingContainerToDock:function(){var e=document.getElementById(R.FloatingContainer);e.style.height="100%";s.byId("shell-floatingContainer").addStyleClass("sapUshellShellFloatingContainerFullHeight")},_shrinkFloatingContainerToDragUI:function(){var e=document.getElementById(R.FloatingContainer);e.classList.remove("sapUshellContainerDocked");s.byId("shell-floatingContainer").removeStyleClass("sapUshellShellFloatingContainerFullHeight");jQuery(".sapUshellShellFloatingContainerFullHeight").removeClass("sapUshellShellFloatingContainerFullHeight")},_emitFloatingContainerResizeEvent:function(){var e=s.byId("viewPortContainer");if(e){e._handleSizeChange()}window.setTimeout(function(){s.getEventBus().publish("launchpad","appFinderWithDocking")},300)},_undockFloatingContainer:function(){if(this._isFloatingContainerDocked()){this._saveFloatingContainerState("floating");this._shrinkFloatingContainerToDragUI();this._removeFloatingContainerFromDock();this._startFloatingContainerAnimation(false)}},_handleFloatingContainerUndockOnResize:function(){this._undockFloatingContainer();const e={isDocked:(this.getFloatingContainerState()||"").startsWith("docked"),isVisible:this.getFloatingContainerVisibility()};s.getEventBus().publish("launchpad","shellFloatingContainerIsUnDockedOnResize",e)},_onFloatingContainerDragStart:function(){f.start("FLP:Shell.controller._onDragStartUI","start drag","FLP");this._undockFloatingContainer();const e={isDocked:(this.getFloatingContainerState()||"").startsWith("docked"),isVisible:this.getFloatingContainerVisibility()};s.getEventBus().publish("launchpad","shellFloatingContainerIsUnDocked",e);f.end("FLP:Shell.controller._onDragStartUI")},_startFloatingContainerAnimation:function(e){return new Promise(function(t){this._clearFloatingContainerAnimation();var n=Array.from(document.getElementsByClassName("sapUshellFloatingContainerWrapper"));n.forEach(function(n){if(e){n.classList.add("sapUshellContainerDockedExtendCoPilot");this._emitFloatingContainerResizeEvent()}else{return}["webkitAnimationEnd","onanimationend","msAnimationEnd","animationend"].forEach(function(e){n.addEventListener(e,function(){this._clearFloatingContainerAnimation();t()}.bind(this),{once:true})}.bind(this))}.bind(this))}.bind(this))},_clearFloatingContainerAnimation:function(){var e=Array.from(document.getElementsByClassName("sapUshellFloatingContainerWrapper"));e.forEach(function(e){e.classList.remove("sapUshellContainerDockedExtendCoPilot");e.classList.remove("sapUshellContainerDockedMinimizeCoPilot")})},_handleDockingPreview:function(e){var t=e?e.docked:false;var n=t?t.setIsDockingAreaOpen:false;if(n&&jQuery("#DockingAreaDiv").length===0){var i=r.getRTL();if(t.dockPos==="right"&&e.clone&&!i||t.dockPos==="left"&&e.clone&&i){jQuery('<div id="DockingAreaDiv" class="sapUshellShellDisplayDockingAreaRight">').appendTo(e.clone.parentElement)}else if(t.dockPos==="left"&&e.clone&&!i||t.dockPos==="right"&&e.clone&&i){jQuery('<div id="DockingAreaDiv" class="sapUshellShellDisplayDockingAreaLeft">').appendTo(e.clone.parentElement)}e.clone.oDockedProp={};e.clone.oDockedProp.dockPos=t.dockPos}else if(!n){window.setTimeout(function(){jQuery(".sapUshellShellDisplayDockingAreaRight").remove();jQuery(".sapUshellShellDisplayDockingAreaLeft").remove()},150)}},_isFloatingContainerDocked:function(){return document.getElementsByClassName("sapUshellContainerDocked").length!==0},_isDockingAreaOpen:function(){return document.getElementsByClassName("sapUshellShellDisplayDockingAreaRight").length!==0||document.getElementsByClassName("sapUshellShellDisplayDockingAreaLeft").length!==0},_moveFloatingContainerIntoDock:function(e){var t=r.getRTL();var n=document.getElementById(R.FloatingContainer);n.classList.add("sapUshellContainerDocked");var i;if(e.dockPos==="left"&&!t||e.dockPos==="right"&&t){i=R.FloatingContainerDockStart}else{i=R.FloatingContainerDockEnd}if(e.dockPos==="left"){n.classList.add("sapUshellContainerDockedStart");n.classList.remove("sapUshellContainerDockedEnd")}else{n.classList.remove("sapUshellContainerDockedStart");n.classList.add("sapUshellContainerDockedEnd")}var a=document.getElementById(i);a.appendChild(n);this._expandFloatingContainerToDock();this._emitFloatingContainerResizeEvent()},_removeFloatingContainerFromDock:function(){var e=document.getElementById(R.FloatingContainer);document.body.appendChild(e);e.classList.remove("sapUshellContainerDocked");e.classList.remove("sapUshellContainerDockedStart");e.classList.remove("sapUshellContainerDockedEnd");this._emitFloatingContainerResizeEvent()},_onFloatingContainerDragEnd:function(e){var t=jQuery(window).width();if(this._isFloatingContainerDocked()){if(e&&(e.clientX>=t-64||e.clientX<64)){this._startFloatingContainerAnimation(false)}}else{}},_handleFloatingContainerDrop:function(e,t,n){f.start("FLP:Shell.controller._handleFloatingContainerDrop","drop floating container","FLP");var i=t.firstChild?s.byId(t.firstChild.id):undefined;var a=new m(m.Type.local,"com.sap.ushell.adapters.local.FloatingContainer");var o=jQuery(window).width();var r=jQuery(window).height();var l=n.deltaX/o;var c=-n.deltaY/r;var h=t.style.visibility;var d=t.style.display;var p=parseFloat(t.style.left.replace("%",""));var g=parseFloat(t.style.top.replace("%",""));if(typeof p==="number"){l=p+100*n.deltaX/o}if(typeof g==="number"){c=g+100*n.deltaY/r}if(this._isDockingAreaOpen()){c=0}t.style.left=l+"%";t.style.top=c+"%";t.style.position="absolute";t.style.display="block";t.visibility=h;t.display=d;a.put("floatingContainerStyle",t.style.cssText);if(i){i.handleDrop();if(n.clone.oDockedProp&&this._isDockingAreaOpen()){this._finishDoDock(n.clone.oDockedProp)}}f.end("FLP:Shell.controller.handleFloatingContainerDrop")},_handleFloatingContainerDrag:function(e,t){f.start("FLP:Shell.controller._handleFloatingContainerUIStart","starts dragging floating container","FLP");t.style.display="none";if(window.getSelection){var n=window.getSelection();try{n.removeAllRanges()}catch(e){}}f.end("FLP:Shell.controller._handleFloatingContainerUIStart")},getFloatingContainerState:function(){var e=new m(m.Type.local,"com.sap.ushell.adapters.local.CopilotLastState");var t="floating";if(e!==null){t=e.get("lastState");if(t===null){t="floating"}}return t},_saveFloatingContainerState:function(e){var t=new m(m.Type.local,"com.sap.ushell.adapters.local.CopilotLastState");t.put("lastState",e)},setFloatingContainerVisibility:function(e){if(!this._oFloatingContainerPromise){this._oFloatingContainerPromise=this.getView().createFloatingContainer()}this.getView().getModel("helper").setProperty("/shell/floatingContainerVisible",e);return this._oFloatingContainerPromise.then(function(){var t=this.getFloatingContainerState()||"";if(t==="floating"){}else if(t.indexOf("docked")!==-1){if(e){if(this._isFloatingContainerDockSupported()){var n=t.indexOf("right")!==-1?"right":"left";this._moveFloatingContainerIntoDock({dockPos:n});this._startFloatingContainerAnimation(true)}else{this._saveFloatingContainerState("floating")}}else{this._startFloatingContainerAnimation(false)}this._emitFloatingContainerResizeEvent()}}.bind(this))},getFloatingContainerVisibility:function(){return this.getView().getModel("helper").getProperty("/shell/floatingContainerVisible")},setFloatingContainerContent:function(e,t,n,i){W.setFloatingContainerContent(e,t,n,i)},getRightFloatingContainerVisibility:function(){var e=this.getView().getRightFloatingContainer();return e&&e.getVisible()},setHeaderTitle:function(e){w.updateStates({propertyName:"title",value:e||"",aStates:["home","app"],bCurrentState:false,bDoNotPropagate:false})},setNavigationBar:function(e){e.placeAt(R.NavigationBar,"only");this.addDanglingControl(e)},setShellShapes:function(e){if(e.placeAt){e.placeAt(R.ShellShapes,"only");this.addDanglingControl(e)}else if(e instanceof Node){document.getElementById(R.ShellShapes).appendChild(e)}},setFooter:function(e){var n=this.getView();var i=n.getModel("helper");if(typeof e!=="object"||!e.getId){throw new Error("oFooter value is invalid")}var a=i.getProperty("/shell/footerContent");if(a){t.warning("You can only set one footer. Replacing existing footer: "+a+", with the new footer: "+e.getId()+".")}i.setProperty("/shell/footerContent",e.getId());e.placeAt(R.Footer,"only");this.addDanglingControl(e);if(e._applyContextClassFor){e._applyContextClassFor("footer")}},getFooterId:function(){var e=this.getView();var t=e.getModel("helper");return t.getProperty("/shell/footerContent")},removeFooter:function(){var e=this.getView();var t=e.getModel("helper");var n=t.getProperty("/shell/footerContent");if(n){var i=s.byId(n);if(i&&i.destroy){i.destroy()}}t.setProperty("/shell/footerContent","")},addUserPreferencesEntry:function(e,t){this._validateUserPrefEntryConfiguration(e,t);this._updateUserPrefModel(e,t)},addUserProfilingEntry:function(e){this._validateUserPrefEntryConfiguration(e);this._updateProfilingModel(e)},_validateUserPrefEntryConfiguration:function(e,t){if(!e||typeof e!=="object"){throw new Error("object oConfig was not provided")}if(!e.title){throw new Error("title was not provided")}if(!e.value){throw new Error("value was not provided")}if(typeof e.entryHelpID!=="undefined"){if(typeof e.entryHelpID!=="string"){throw new Error("entryHelpID type is invalid")}else if(e.entryHelpID===""){throw new Error("entryHelpID should not be an empty string")}}if(e.title&&typeof e.title!=="string"){throw new Error("title type is invalid")}if(typeof e.value!=="function"&&typeof e.value!=="string"&&typeof e.value!=="number"){throw new Error("value type is invalid")}["onSave","content","onCancel"].forEach(function(t){if(e[t]&&typeof e[t]!=="function"){throw new Error(t+" type is  "+typeof e[t]+" but should be a function")}});if(t){[{name:"groupingId",type:"string"},{name:"groupingTabTitle",type:"string"},{name:"groupingTabHelpId",type:"string"}].forEach(function(t){if(!e[t.name]){throw new Error(t.name+" is missing")}else if(typeof e[t.name]!==t.type){throw new Error(t.name+" type is "+typeof e[t.name]+" but should be a "+t.type)}})}},_createSessionHandler:function(e){var t=this;var n=2e4;sap.ui.require(["sap/ushell/SessionHandler"],function(i){t.oSessionHandler=new i(S);t.oSessionHandler.initLogout();window.setTimeout(function(){t.oSessionHandler.init({sessionTimeoutReminderInMinutes:e.sessionTimeoutReminderInMinutes,sessionTimeoutIntervalInMinutes:e.sessionTimeoutIntervalInMinutes,sessionTimeoutTileStopRefreshIntervalInMinutes:e.sessionTimeoutTileStopRefreshIntervalInMinutes,enableAutomaticSignout:e.enableAutomaticSignout})},n)})},_getSessionHandler:function(){return this.oSessionHandler},_navBack:function(){this.setUserActionsMenuSelected(false);S.service().navigateBack()},_updateUserPrefModel:function(e,t){var n=this._getModelEntryFromEntryObject(e);var i=_.last("/core/userPreferences/entries")||[];if(t){n.groupingEnablement=true;n.groupingId=e.groupingId;n.groupingTabTitle=e.groupingTabTitle;n.groupingTabHelpId=e.groupingTabHelpId}i.push(n);i=this._reorderUserPrefEntries(i);_.emit("/core/userPreferences/entries",i)},_updateProfilingModel:function(e){var t=this._getModelEntryFromEntryObject(e);var n=_.last("/core/userPreferences/profiling")||[];n.push(t);_.emit("/core/userPreferences/profiling",n)},_getModelEntryFromEntryObject:function(e){return{id:k._getUid(),entryHelpID:e.entryHelpID,title:e.title,valueArgument:e.value,valueResult:null,onSave:e.onSave,onCancel:e.onCancel,contentFunc:e.content,contentResult:null,icon:e.icon,provideEmptyWrapper:e.provideEmptyWrapper}},_reorderUserPrefEntries:function(e){var t=[];var n=["userAccountEntry","themes","homepageEntry","spacesEntry","userActivitiesEntry","userProfiling","language","notificationsEntry","userDefaultEntry"];var i={};for(var a=e.length-1;a>=0;a--){if(n.indexOf(e[a].id)!==-1){var o=e.splice(a,1)[0];i[o.id]=o}}n.forEach(function(e){var n=i[e];if(n){t.push(n)}});return t.concat(e)},getModel:function(){return z},_getConfig:function(){return X||{}},_getPersData:function(e){var t=o.getOwnerComponentFor(this.getView());return sap.ushell.Container.getServiceAsync("PersonalizationV2").then(async function(n){var i={keyCategory:n.constants.keyCategory.FIXED_KEY,writeFrequency:n.constants.writeFrequency.LOW,clientStorageAllowed:true};var a=await n.getPersonalizer(e,i,t);return a.getPersData()})},_getCurrentLocationHash:function(){return window.location.hash},setUserActionsMenuSelected:function(e){A.emit("showUserActionsMenu",e)},getUserActionsMenuSelected:function(){return _.last("/core/shell/model/currentViewPortState")==="LeftCenter"},setNotificationsSelected:function(e){A.emit("showNotifications",e)},getNotificationsSelected:function(){return _.last("/core/shell/model/currentViewPortState")==="RightCenter"}})});
//# sourceMappingURL=Shell.controller.js.map