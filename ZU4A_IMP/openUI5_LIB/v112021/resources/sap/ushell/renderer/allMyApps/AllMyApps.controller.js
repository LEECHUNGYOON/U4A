// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/m/StandardListItem","sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ushell/Config","sap/ushell/library","sap/ushell/renderer/allMyApps/AllMyAppsKeyboardHandler","sap/ushell/renderer/allMyApps/AllMyAppsManager","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/ushell/EventHub"],function(e,t,s,a,l,i,r,n,o,p,d,u,h){"use strict";var g=e.ListType;var A=n.AllMyAppsState;var M=n.AllMyAppsProviderType;var c=n.AppTitleState;var y=false;return s.extend("sap.ushell.renderer.allMyApps.AllMyApps",{iNumberOfProviders:0,onInit:function(){this.bFirstLoadOfAllMyApps=true;var e=new l;var t=this.getView();var s=sap.ui.getCore().getEventBus();e.setSizeLimit(1e4);e.setProperty("/AppsData",[]);e.setProperty("/catalogEnabled",r.last("/core/catalog/enabled"));t.setModel(d.getTranslationModel(),"i18n");t.setModel(e,"allMyAppsModel");s.subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext,this);s.subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);s.subscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);s.subscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this)},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext);e.unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);e.unsubscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);e.unsubscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this)},onAfterRendering:function(){return new Promise(function(e,t){var s=this;var l=this.getView();var i=l.getModel("allMyAppsModel");var r=this._getSplitApp();var n=l.byId("sapUshellAllMyAppsMasterPage");var o=l.byId("sapUshellAllMyAppsDetailsPage");if(!this.bAfterInitialLoading){if(n){n.setBusy(true)}if(o){o.setBusy(true)}r.toMaster(this.createId("sapUshellAllMyAppsMasterPage"),"show");if(!a.system.phone){r.toDetail("sapUshellAllMyAppsDetailsPage","show")}}if(this.bFirstLoadOfAllMyApps){i.setProperty("/AppsData",[])}else{var p=i.getProperty("/AppsData");i.setProperty("/AppsData",p)}setTimeout(function(){s._getAllMyAppsManager().loadAppsData(i,s._getPopoverObject(),s.bFirstLoadOfAllMyApps);s._isSingleDataSource().then(function(t){y=t;s.switchToInitialState();s.bFirstLoadOfAllMyApps=false;e()})},0)}.bind(this))},switchToInitialState:function(){var e=this._getDataSourceList();return this._isSingleDataSource().then(function(t){if(t){r.emit("/core/shell/model/allMyAppsMasterLevel",A.FirstLevelSpread);e.bindItems("allMyAppsModel>/AppsData/0/groups",this._getMasterListItemTemplate)}else{r.emit("/core/shell/model/allMyAppsMasterLevel",A.FirstLevel);e.bindItems("allMyAppsModel>/AppsData",this._getMasterListItemTemplate())}if(a.system.phone){this._getSplitApp().toMaster(this.createId("sapUshellAllMyAppsMasterPage"),"show")}e.rerender();this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:true});this._getPopoverHeaderLabel().setText(d.i18n.getText("allMyApps_headerTitle"));this.updateHeaderButtonsState()}.bind(this))},handleSwitchToMasterAreaOnPhone:function(){var e=this._getDataSourcesSelectedPath();var t=e.split("/");this._getSplitApp().toMaster(this.createId("sapUshellAllMyAppsMasterPage"),"show");return this._isSingleDataSource().then(function(e){if(e){r.emit("/core/shell/model/allMyAppsMasterLevel",A.FirstLevelSpread)}else if(t.length===3){r.emit("/core/shell/model/allMyAppsMasterLevel",A.FirstLevel)}else{r.emit("/core/shell/model/allMyAppsMasterLevel",A.SecondLevel)}this.updateHeaderButtonsState()}.bind(this))},handleMasterListItemPress:function(e){this.lastPressedMasterItem=e.getParameter("listItem");var t=this._getClickedDataSourceItemPath(this.lastPressedMasterItem);var s=this.getView();var a=s.getModel("allMyAppsModel");var l=a.getProperty(t+"/type");var i=r.last("/core/shell/model/allMyAppsMasterLevel");var n=this._getCustomPanel();var o=this._getCustomPanelLabel();var p=this._getCustomPanelLink();var d=l===M.CATALOG;var u;if(d||i===A.FirstLevelSpread||i===A.SecondLevel){u=this.handleMasterListItemPressToDetails(t)}else{u=this.handleMasterListItemPressToSecondLevel(t)}n.setBindingContext(u,"allMyAppsModel");o.setBindingContext(u,"allMyAppsModel");if(p&&p.getVisible&&p.getVisible()){p.setBindingContext(u,"allMyAppsModel")}},handleMasterListItemPressToSecondLevel:function(e){var t=this.getView();var s=t.getModel("allMyAppsModel");var l=s.getProperty(e+"/type");var i=s.getProperty(e+"/title");var n=this._getSplitApp();var o=this._getDataSourceList();if(!a.system.phone){n.toDetail(this.createId("sapUshellAllMyAppsDetailsPage"))}o.bindItems("allMyAppsModel>"+e+"/groups",this._getMasterListItemTemplate());r.emit("/core/shell/model/allMyAppsMasterLevel",A.SecondLevel);var p=this._setBindingContext(e+"/groups/0",t.byId("oItemsContainerlist"));o.rerender();o.setSelectedItem(o.getItems()[0]);var u=o.getSelectedItem();if(u){u.focus()}if(l===M.HOME){this._getPopoverHeaderLabel().setText(d.i18n.getText("allMyApps_homeEntryTitle"))}else if(l===M.EXTERNAL){this._getPopoverHeaderLabel().setText(i)}this._getDetailsHeaderLabel().setText(s.getProperty(e+"/groups/0/title"));this.updateHeaderButtonsState();return p},handleMasterListItemPressToDetails:function(e){var t=this.getView();var s=t.getModel("allMyAppsModel");var l=this._setBindingContext(e,t.byId("oItemsContainerlist"));this._getDetailsHeaderLabel().setText(s.getProperty(e+"/title"));if(a.system.phone){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsDetailsPage"));r.emit("/core/shell/model/allMyAppsMasterLevel",A.Details)}this.updateHeaderButtonsState();return l},onMasterLoad:function(){var e=this.getView();var t=this._getPopoverHeaderBackButton();this.bAfterInitialLoading=true;e.byId("sapUshellAllMyAppsMasterPage").setBusy(false);t.focus();this._isSingleDataSource().then(function(e){y=e;this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:false})}.bind(this))},onDetailLoad:function(){var e=this.getView();var t=e.byId("sapUshellAllMyAppsDetailsPage");t.setBusy(false);this.bAfterInitialLoading=true;if(!a.system.phone){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsDetailsPage"),"show")}},onNoCatalogsLoaded:function(){var e=this.getView();var t=e.byId("sapUshellAllMyAppsDetailsPage");t.setBusy(false);this.bAfterInitialLoading=true;if(!a.system.phone&&!y){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsEmptyDetailsPage"),"show")}else if(!a.system.phone&&y){this._getSplitApp().toDetail(this.createId("sapUshellAllMyAppsDetailsPage"))}},updateMasterFocusAndDetailsContext:function(e,t,s){var a=this.getView();var l=a.getModel("allMyAppsModel");var r=this._getInitialFirstLevelSelectionIndex();var n=this._getDataSourceList();var o=this._getCustomPanelLabel();var p=this._getCustomPanelLink();var d;var u;if(y===true){d=l.createBindingContext("/AppsData/0/groups/0");u=l.getProperty(d.getPath())}else{d=l.createBindingContext("/AppsData/"+r);u=l.getProperty(d.getPath())}a.byId("oItemsContainerlist").setBindingContext(d,"allMyAppsModel");o.setBindingContext(d,"allMyAppsModel");a.byId("sapUshellAllMyAppsCustomPanel").setBindingContext(d,"allMyAppsModel");if(p.getVisible()){p.setBindingContext(d,"allMyAppsModel")}if(u!==undefined){this._getDetailsHeaderLabel().setText(u.title)}if(s.bFirstCatalogLoadedEvent===true){n.rerender()}if(s.bFirstCatalogLoadedEvent===false&&r===0){this.onNoCatalogsLoaded()}n.setSelectedItem(n.getItems()[r]);var h=n.getSelectedItem();if(h){setTimeout(function(){h.focus()},0)}if(s.bFirstCatalogLoadedEvent){i.end("FLP:ShellAppTitle.onClick");i.end("FLP:ShellNavMenu.footerClick")}},handleCustomPanelLinkPress:function(e){var t=this.getView();var s=t.byId("sapUshellAllMyAppsCustomPanelLink");var a=s.getVisible()?s.getBindingContext("allMyAppsModel").getObject():{};if(a.handlePress){a.handlePress(e.getSource(),a)}},updateHeaderButtonsState:function(){this._getShellAppTitleToggleListButton().setVisible(this.getToggleListButtonVisible());this._getPopoverHeaderBackButton().setVisible(this.getBackButtonVisible())},getToggleListButtonVisible:function(){var e=this.getCurrentState();var t=a.media.getCurrentRange(a.media.RANGESETS.SAP_STANDARD).name==="Phone";var s=(t||a.system.phone)&&e===A.Details;return s},getBackButtonVisible:function(){var e=r.last("/core/shellHeader/ShellAppTitleState");if(e!==c.AllMyAppsOnly){return true}var t=this.getCurrentState();return t===A.SecondLevel||t===A.Details},onAppItemClick:function(e){var t=this.getView().getModel("allMyAppsModel");var s=e.getSource().getBindingContext("allMyAppsModel").getPath();var a=t.getProperty(s+"/url");if(a){h.emit("UITracer.trace",{reason:"LaunchApp",source:"Tile",data:{targetUrl:a}});if(a[0]==="#"){hasher.setHash(a);setTimeout(function(){this.getView().getParent().close()}.bind(this),50)}else{u.openURL(a,"_blank")}}},getCurrentState:function(){return r.last("/core/shell/model/allMyAppsMasterLevel")},_isSingleDataSource:function(){return sap.ushell.Container.getServiceAsync("AllMyApps").then(function(e){if(e.isCatalogAppsEnabled()){return false}if(!e.isExternalProviderAppsEnabled()&&e.isHomePageAppsEnabled()){return true}return e.isExternalProviderAppsEnabled()&&Object.keys(e.getDataProviders()).length===1&&!e.isHomePageAppsEnabled()})},_getInitialFirstLevelSelectionIndex:function(){var e=this.getView();var t=e.getModel("allMyAppsModel");var s=t.getProperty("/AppsData");for(var a=0;a<s.length;a++){var l=s[a];if(l.type===M.CATALOG){return a}}return 0},_getPopoverHeaderBackButton:function(){if(!this._oPopoverHeaderBackButton){this._oPopoverHeaderBackButton=this._getPopoverHeaderContent(0)}return this._oPopoverHeaderBackButton},_getShellAppTitleToggleListButton:function(){if(!this._oShellAppTitleToggleListButton){this._oShellAppTitleToggleListButton=this._getPopoverHeaderContent(1)}return this._oShellAppTitleToggleListButton},_getPopoverHeaderContent:function(e){var t=this._getPopoverObject().getCustomHeader();var s=t.getContentLeft();var a=s[e];return a},_getPopoverHeaderLabel:function(){var e=this._getPopoverObject().getCustomHeader();var t=e.getContentMiddle();return t[0]},_getPopoverObject:function(){return this.getView().getParent()},_getDetailsHeaderLabel:function(){return this.getView().byId("sapUshellAllMyAppsDetailsHeaderLabel")},_setBindingContext:function(e,t){var s=this.getView().getModel("allMyAppsModel");var a=s.createBindingContext(e);t.setBindingContext(a,"allMyAppsModel");return a},_getClickedDataSourceItemPath:function(e){return e.getBindingContext("allMyAppsModel").getPath()},_getAllMyAppsManager:function(){return p},_getDataSourcesSelectedPath:function(){return this.lastPressedMasterItem.getBindingContextPath()},getControllerName:function(){return"sap.ushell.renderer.allMyApps.AllMyApps"},formatListItemType:function(e,t){var s=a.system.phone||t===A.FirstLevel&&e!==M.CATALOG;return s?g.Navigation:g.Active},_afterOpen:function(){if(!this.bAfterOpenHandlerCalled){this.bAfterOpenHandlerCalled=true;if(a.system.desktop){o.init(this.getView())}}},_getMasterListItemTemplate:function(){if(!this.oTemplate){this.oTemplate=new t({type:{parts:["allMyAppsModel>type","/allMyAppsMasterLevel"],formatter:this.formatListItemType},title:"{allMyAppsModel>title}",wrapping:true})}return this.oTemplate},_getSplitApp:function(){return this.getView().byId("sapUshellAllMyAppsMasterDetail")},_getDataSourceList:function(){return this.getView().byId("sapUshellAllMyAppsDataSourcesList")},_getCustomPanel:function(){return this.getView().byId("sapUshellAllMyAppsCustomPanel")},_getCustomPanelLabel:function(){return this.getView().byId("sapUshellAllMyAppsCustomPanelLabel")},_getCustomPanelLink:function(){return this.getView().byId("sapUshellAllMyAppsCustomPanelLink")}})});
//# sourceMappingURL=AllMyApps.controller.js.map