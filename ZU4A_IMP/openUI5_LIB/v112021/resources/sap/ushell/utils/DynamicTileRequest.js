//Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/HttpClient","sap/ui/thirdparty/URI","sap/base/util/isEmptyObject","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/Configuration","sap/base/util/ObjectPath","sap/ushell/EventHub","sap/ushell/utils"],function(e,t,s,r,n,i,a,o,l){"use strict";const u="sap.ushell.utils.DynamicTileRequest";class c{#e=()=>{};#t=()=>{};#s=null;#r=null;#n=null;#i=null;#a=null;#o=null;#l=null;#u=null;#c=null;#h=Promise.resolve();constructor(e,t,s,r,i){this.#e=t;this.#t=s;this.#s=e;this.#r=a.get(["dataSource","settings","odataVersion"],i);this.#n=true;this.#i=r;this.#h=this.#f(e,r).then(e=>{if(e){this.#a=e}}).catch(e=>{n.error("Was not able to create a DynamicTileRequest:",e,u)});this._oInitialRefreshPromise=this.#h.then(()=>{if(this.#a){return this.refresh()}})}set originalUrl(e){throw new Error("originalUrl is read-only!")}get originalUrl(){return this.#s}set oDataVersion(e){throw new Error("oDataVersion is read-only!")}get oDataVersion(){return this.#r}refresh(){if(!this.#o){this.#o=this.#h.then(this.#g.bind(this)).then(e=>{if(e){return this.#d(e)}})}return this.#o}async#g(){if(!this.#n){return this.#a}try{const e=await sap.ushell.Container.getServiceAsync("ReferenceResolver");const t=await e.resolveSemanticDateRanges(this.#a,this.#r);if(t.ignoredReferences&&t.ignoredReferences.length>0||t.invalidSemanticDates&&t.invalidSemanticDates.length>0){const e=[].concat(t.invalidSemanticDates||[],t.ignoredReferences||[]);n.error("The service URL contains invalid Reference(s): "+e.join(", "),"",u);return}this.#n=t.hasSemanticDateRanges;return t.url}catch(e){n.error("Could not resolve semantic date ranges:",e,u);return Promise.reject(e)}}#d(s){let r=new t(s).escapeQuerySpace(false);const n=i.getSAPLogonLanguage();if(n&&!r.hasQuery("sap-language")){r.addQuery("sap-language",n)}let a=false;if(r.is("relative")){a=true;r=r.absoluteTo(location.href)}const o=this.#R(a);const l={headers:o};this.#c=r.origin();this.#u=r.href();this.#l=new e(this.#c,l);return this.#l.get(r.relativeTo(this.#c).href()).then(this.#m.bind(this)).catch(this.#U.bind(this))}abort(){if(this.#o&&this.#l){this.#l.abortAll();this.#l=null;this.#o=null;return true}return false}#m(e){o.emit("UITracer.trace",{source:"Tile",reason:"FetchData",data:{providerId:this.#i,targetUrl:this.#u,status:200}});let t;try{t=JSON.parse(e.responseText)}catch(e){throw new Error("Was not able to parse response of dynamic tile request")}this.#l=null;this.#o=null;let s;if(typeof t==="object"){t=t.d?t.d:t;const e=r.fromURL(this.#u);if(e.get("$inlinecount")==="allpages"){s={number:t.__count}}else if(e.get("$count")==="true"){s={number:t["@odata.count"]}}else{s=this.#p(t)}}else if(typeof t==="string"||typeof t==="number"){s={number:t}}this.#e(s)}#U(e){o.emit("UITracer.trace",{source:"Tile",reason:"FetchData",data:{providerId:this.#i,targetUrl:this.#u,status:e.status}});this.#l=null;this.#o=null;this.#t(e)}#p(e){const t=["results","icon","title","number","numberUnit","info","infoState","infoStatus","targetParams","subtitle","stateArrow","numberState","numberDigits","numberFactor"];const r=Object.keys(e).reduce((s,r)=>{if(t.indexOf(r)>-1){s[r]=e[r]}return s},{});if(!s(r)){return r}const n=Object.keys(e)[0];if(n!==undefined&&Object.keys(e).length===1){return Object.keys(e[n]).reduce((s,r)=>{if(t.indexOf(r)>-1){s[r]=e[n][r]}return s},{})}return{}}#R(e){const t={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":i.getLanguage()||"",Accept:"application/json, text/plain"};const s=i.getSAPLogonLanguage();if(s){t["sap-language"]=s}if(e){const e=sap.ushell.Container.getLogonSystem();const s=e&&e.getClient();if(s){t["sap-client"]=s}}return t}async#f(e,t){const s=await sap.ushell.Container.getServiceAsync("ClientSideTargetResolution");const r=await sap.ushell.Container.getServiceAsync("ReferenceResolver");const i=await s.getSystemContext(t);const a=await l.promisify(r.resolveUserDefaultParameters(e,i));if(a.defaultsWithoutValue&&a.defaultsWithoutValue.length>0){n.error("The service URL contains User Default(s) with no set value: "+a.defaultsWithoutValue.join(", "),"",u);return}if(a.ignoredReferences&&a.ignoredReferences.length>0){const e=a.ignoredReferences.filter(e=>!e.startsWith("DynamicDate"));if(e.length>0){n.error("The service URL contains invalid Reference(s): "+e.join(", "),"",u);return}}return a.url}destroy(){this.abort();this.#t=null;this.#e=null}}return c});
//# sourceMappingURL=DynamicTileRequest.js.map