/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 * POC
 */
sap.ui.define(["sap/ui/base/Object"],function(e){"use strict";var s="sap-insights";var n={available:"cardsAvailable",requested:"cardRequested",provided:"cardProvided",subscribed:"clientSubscribed"};function i(){this.subscribers={};this.onMessage=function(e){if(typeof e.data==="string"){var n=JSON.parse(e.data);if(n.type==="request"){if(n.body.channelId===s&&this.onNewMessage){this.onNewMessage(n.body.clientId,n.body.channelId,n.body.messageName,n.body.data)}else if(this.onSubscriptionChange){if(n.body.messageName==="clientSubscribed"&&!this.subscribers[n.body.clientId]){this.subscribers[n.body.clientId]=true;this.onSubscriptionChange(n.body.messageName,n.body.clientId,n.body.channels)}else if(n.body.messageName==="clientUnsubscribed"&&this.subscribers[n.body.clientId]){delete this.subscribers[n.body.clientId];this.onSubscriptionChange(n.body.messageName,n.body.clientId,n.body.channels)}}}}};this.connect=function(e){return new Promise(function(n){var i=function(e){if(typeof e.data==="string"){var s=JSON.parse(e.data);if(s.body.messageName==="connect"){window.removeEventListener("message",i);n()}}};window.addEventListener("message",i);window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:s,clientId:e,messageName:"connect"}}),"*")})};this.subscribe=function(e,s,n,i){this.onNewMessage=n;this.onSubscriptionChange=i;window.addEventListener("message",this.onMessage.bind(this));window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:"sap.ushell.MessageBroker",clientId:e,messageName:"subscribe",subscribedChannels:s}}),"*");return Promise.resolve()};this.publish=function(e,s,n,i,t,r){window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:n,body:{channelId:e,clientId:s,messageName:i,targetClientIds:t,data:r}}),"*");return Promise.resolve()};this.unsubscribe=function(e,s){delete this.onNewMessage;delete this.onSubscriptionChange;window.addEventListener("message",this.onMessage.bind(this));window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:"sap.ushell.MessageBroker",clientId:e,messageName:"unsubscribe",subscribedChannels:s}}),"*");return Promise.resolve()};this.disconnect=function(e){window.removeEventListener("message",this.onMessage.bind(this));window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:s,clientId:e,messageName:"disconnect"}}),"*");return Promise.resolve()}.bind(this)}function t(e,i,t){this.onSubscriptionChange=function(n,t,r){if(e!==t&&r.find(function(e){return e.channelId===s})){if(n==="clientSubscribed"){i.onConsumerConnected(t)}else if(n==="clientUnsubscribed"){i.onConsumerDisconnected(t)}}};this.onNewMessage=function(e,t,r,o){if(t===s){switch(r){case n.subscribed:i.onConsumerConnected(e);break;case n.requested:i.onCardRequested(e,o);break;default:break}}};this.register=function(){return t.connect(e).then(function(){return t.subscribe(e,[{channelId:s}],this.onNewMessage,this.onSubscriptionChange)}.bind(this))}}function r(e,i,t){this.onSubscriptionChange=function(r,o,a){if(e!==o&&a.find(function(e){return e.channelId===s})){if(r==="clientSubscribed"){t.publish(s,e,Date.now().toString(),n.subscribed,[o])}else if(r==="clientUnsubscribed"){i.onCardsAvailable(o,[])}}};this.onNewMessage=function(e,t,r,o){if(t===s){switch(r){case n.available:i.onCardsAvailable(e,o);break;case n.provided:i.onCardProvided(e,o);break;default:break}}};this.register=function(){return t.connect(e).then(function(){return t.subscribe(e,[{channelId:s}],this.onNewMessage,this.onSubscriptionChange)}.bind(this))}}var o=e.extend("sap.insights.CardsChannel",{constructor:function(){this.clients={}},isEnabled:function(){return!!this.broker},init:function(){var e;if(sap.ushell.Container){e=sap.ushell.Container.getServiceAsync("MessageBroker")}else{e=Promise.resolve(new i)}return e.then(function(e){this.broker=e}.bind(this))},registerProvider:function(e,s){this.clients[e]=new t(e,s,this.broker);return this.clients[e].register()},registerConsumer:function(e,s){this.clients[e]=new r(e,s,this.broker);return this.clients[e].register()},publishAvailableCards:function(e,i,t){if(!t){t="*"}return this.broker.publish(s,e,Date.now().toString(),n.available,[t],i)},requestCard:function(e,i,t){return this.broker.publish(s,e,Date.now().toString(),n.requested,[t],i)},publishCard:function(e,i,t){if(!t){t="*"}return this.broker.publish(s,e,Date.now().toString(),n.provided,[t],i)},unregister:function(e){return this.broker.unsubscribe(e,[{channelId:s}]).then(function(){delete this.clients[e];return this.broker.disconnect(e)}.bind(this))},destroy:function(){var e=[];for(var s in this.clients){e.push(this.unregister(s))}return Promise.all(e).then(function(){delete this.broker}.bind(this))}});return o});
//# sourceMappingURL=CardsChannel.js.map