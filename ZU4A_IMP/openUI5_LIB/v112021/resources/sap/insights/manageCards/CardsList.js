/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Control","sap/ui/core/Icon","sap/ui/core/dnd/DragDropInfo","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/resource/ResourceModel","sap/ui/integration/widgets/Card","sap/m/MessageStrip","sap/m/FlexBox","sap/m/HBox","sap/m/VBox","sap/m/Text","sap/m/Button","sap/m/Title","sap/m/SearchField","sap/m/ScrollContainer","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/CheckBox","sap/m/Link","sap/m/MessageBox","sap/m/FormattedText","sap/m/MessageToast","sap/m/Popover","sap/m/Page","sap/m/Label","sap/m/Switch","../CardHelper","../utils/CardRanking","../base/InMemoryCachingHost","sap/f/IllustratedMessage","sap/ui/model/BindingMode","sap/ui/core/Lib","../utils/CardPreviewManager","../utils/DeviceType","../utils/AppConstants"],function(e,t,i,s,r,a,n,o,l,d,h,g,p,u,C,c,f,m,x,b,y,B,v,T,_,w,S,I,P,M,F,V,A,H,L,D,R,E){"use strict";var N=L.getResourceBundleFor("sap.insights");var k=e.getLogger("sap.insights.manageCards.CardsList");var W;var U;var O=t.extend("sap.insights.manageCards.CardsList",{metadata:{properties:{enableResetAllCards:{type:"boolean",group:"Behavior",defaultValue:false},_count:{type:"number",group:"Appearance",defaultValue:0},_visibleCount:{type:"number",group:"Appearance",defaultValue:0},_dtCards:{type:"array",group:"Appearance",defaultValue:[]}},aggregations:{_page:{type:"sap.m.Page",multiple:false,visibility:"hidden"}},events:{listPress:{allowPreventDefault:true,parameters:{manifest:"string"}}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.style("height","100%");e.style("width","100%");e.openEnd();e.renderControl(t.getAggregation("_page"));e.close("div");return}}});O.prototype.init=function(){this._oWrapperFlexBox=new d(this.getId()+"--flexContainerCardsContent",{alignItems:"Start",justifyContent:"Start",height:"100%",width:"100%",direction:"Column",busy:"{/isLoading}"}).addStyleClass("flexContainerCards");this.i18Bundle=new n({bundle:N}).getResourceBundle();var e=new S(this.getId()+"--insightCardPage",{title:this.i18Bundle.getText("insightsCards"),showHeader:true,backgroundDesign:"List",enableScrolling:false,content:this._oWrapperFlexBox});this.setAggregation("_page",e);this.host=new V("CardListHost")};O.prototype._handleModelChange=function(){if(this.getModel()){var e=this.getModel().getProperty("/cards");if(e.length>0){this._setHeaderStaticControls();this._setProperties();this._createTableContent();if(this.oScrollContainerNoCards){this.oScrollContainerNoCards.setVisible(false)}}else{this._createNoCardContent()}}};O.prototype._setHeaderStaticControls=function(){if(!this.oMessageStrip){this.oMessageStrip=new l(this.getId()+"--insightMaxCardMsg",{text:this.i18Bundle.getText("insightMaxCardText"),type:"Warning",showIcon:true});this.oTextMessage=new p(this.getId()+"--insightCardText",{text:this.i18Bundle.getText("insightCardTabText"),textAlign:"Begin",width:"100%"}).addStyleClass("sapUiSmallMarginTop");this.oMessageVBox=new g(this.getId()+"--insightCardMessageVBox",{alignItems:"Start",width:"calc(100% - 2rem)",items:[this.oMessageStrip,this.oTextMessage]}).addStyleClass("sapUiSmallMarginTop sapUiSmallMarginBegin");this.oCardListHeaderHBox=new h(this.getId()+"--insightCardListHeaderVBox",{width:"calc(100% - 2rem)",alignItems:"Center"}).addStyleClass("sapUiSmallMarginTop sapUiSmallMarginBegin insightsCardTitleFlex");this.oCardCountTitle=new C(this.getId()+"--availableInsightsCardsTitle",{titleStyle:"H5"});this.oCardListHeaderHBox.addItem(this.oCardCountTitle);var e=new h(this.getId()+"--insightCardSearchHBox",{width:"100%",justifyContent:"End"});var t=new h(this.getId()+"--insightCardVisFilterHBox",{width:"50%",alignItems:"Center",justifyContent:"End"});t.addItem(new I({text:this.i18Bundle.getText("cardsVisibleFilter")}));this._oVisibleFilterSwitch=new P(this.getId()+"--insightCardSwitchBtn",{customTextOn:" ",customTextOff:" ",ariaLabelledBy:[this.getId()+"--insightCardVisFilterHBox",this.getId()+"--insightCardSwitchBtn"],change:this._handleVisibleFilterChange.bind(this)});t.addItem(this._oVisibleFilterSwitch);e.addItem(t);this._oSearchField=new c(this.getId()+"--insightCardSearch",{ariaLabelledBy:"availableInsightsCardsTitle",liveChange:this._onCardSearch.bind(this),width:"100%"});e.addItem(this._oSearchField);this.oCardListHeaderHBox.addItem(e);this._oWrapperFlexBox.addItem(this.oMessageVBox);this._oWrapperFlexBox.addItem(this.oCardListHeaderHBox)}else{this.oMessageVBox.setVisible(true);this.oCardListHeaderHBox.setVisible(true)}};O.prototype._applyFilters=function(e,t){var i;var s=[];if(t){i=new r("visibility",a.EQ,true);s.push(i)}if(this._oSearchField.getValue()){i=new r("descriptorContent/sap.card/header/title",a.Contains,e);s.push(i)}var n=this._oTable.getBinding("items");n.filter(s,"Application")};O.prototype._handleVisibleFilterChange=function(e){var t=e.getSource().getState();this._applyFilters(this._oSearchField.getValue(),t)};O.prototype._createResetBox=function(){if(!this.oRefreshHBox){this.oRefreshHBox=new h(this.getId()+"--insightCardMessageHBox",{alignItems:"Center"});this.oRefreshHBox.addItem(new p(this.getId()+"--insightsRefreshText",{text:this.i18Bundle.getText("refreshText")}));this.oRefreshHBox.addItem(new u(this.getId()+"--insightsRefreshIcon",{tooltip:this.i18Bundle.getText("refresh"),icon:"sap-icon://refresh",type:"Transparent",press:this._refreshCardList.bind(this)}));this.oMessageVBox.addItem(this.oRefreshHBox)}else{this.oRefreshHBox.setVisible(true)}};O.prototype._setProperties=function(){var e=this.getModel().getProperty("/cards");this.setProperty("_count",e.length);var t=e.filter(function(e){return e.descriptorContent["sap.insights"].isDtCardCopy});this.setProperty("_dtCards",t);var i=e.filter(function(e){return e.visibility});this.setProperty("_visibleCount",i.length);this.bEnableResetAll=this.getEnableResetAllCards();if(this.getProperty("_visibleCount")>9){this.oMessageStrip.setVisible(true);this.oTextMessage.setVisible(false)}else{this.oTextMessage.setVisible(true);this.oMessageStrip.setVisible(false)}this.oCardCountTitle.setText(this.i18Bundle.getText("availableCards")+" ("+this.getProperty("_visibleCount")+"/"+this.getProperty("_count")+")");if(this.bEnableResetAll||this.getProperty("_dtCards").length>0){this._createResetBox()}else if(this.oRefreshHBox){this.oRefreshHBox.setVisible(false)}if(this._oTable){this._oTable.updateAggregation("items")}};O.prototype._createNoCardContent=function(){if(!this.oScrollContainerNoCards){this.oNoCardMessage=new A(this.getId()+"--editInsightNoInsightsCardsMsg",{illustrationSize:"Auto",illustrationType:"sapIllus-SimpleEmptyList",title:this.i18Bundle.getText("editInsightsEmptyCardTitle"),description:this.i18Bundle.getText("editInsightsEmptyCardSubTitle")}).addStyleClass("sapFIllustratedMessageAlign sapFFrequentIllustratedMessageAlign sapUiMargin-24Top");this.oScrollContainerNoCards=new f(this.getId()+"--idNoCardCardsScrollContainer",{vertical:true,horizontal:false,height:"100%",width:"100%",content:[this.oNoCardMessage]});this._oWrapperFlexBox.addItem(this.oScrollContainerNoCards)}else{this.oScrollContainerNoCards.setVisible(true)}if(this.oCardListHeaderHBox){this.oCardListHeaderHBox.setVisible(false)}if(this.oMessageVBox){this.oMessageVBox.setVisible(false)}if(this.oTableFlexBox){this.oTableFlexBox.setVisible(false)}};O.prototype._handleTableItemsChange=function(e){if(e&&e.getParameters()&&e.getParameters().reason!=="filter"){this._handleModelChange()}};O.prototype._createTableContent=function(){if(!this.oTableFlexBox){this.oTableFlexBox=new d(this.getId()+"--editInsightsCardsFlex",{alignItems:"Start",justifyContent:"Start",height:"100%",width:"calc(100% - 2rem)",direction:"Row"}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginTop flexContainerCards");this.oTableVBox=new g(this.getId()+"--insightsCardsVBox",{height:"100%",width:"100%",justifyContent:"Start",direction:"Column"});this.oScrollContainer=new f(this.getId()+"--idCardsScrollContainer",{vertical:true,horizontal:false,height:"100%",width:"100%",content:this._createTable()});this.oTableVBox.addItem(this.oScrollContainer);this.oTableFlexBox.addItem(this.oTableVBox);this._oWrapperFlexBox.addItem(this.oTableFlexBox);this._oTable.getBinding("items").attachChange(this._handleTableItemsChange.bind(this))}else{this.oTableFlexBox.setVisible(true)}};O.prototype._onCardSearch=function(e,t){var i=e?e.getSource().getValue():t;this._applyFilters(i,this._oVisibleFilterSwitch.getState())};O.prototype._createTable=function(){if(!this._oTable){this._oTable=new m(this.getId()+"--insightsCardsListTable",{columns:[new x(this.getId()+"--idTableDnDIconColumn",{hAlign:"Center",width:"5%"}),new x(this.getId()+"--idSectionTitleColumn",{width:R.getDialogBasedDevice()!==E.DEVICE_TYPES.Mobile?"85%":"81%"}),new x(this.getId()+"--idSectionVisColumn",{width:R.getDialogBasedDevice()!==E.DEVICE_TYPES.Mobile?"10%":"14%"})],updateFinished:function(){if(W){this.getItems()[W].focus()}if(U){var e=this.getItems().findIndex(function(e){return e.getBindingContextPath()===U});if(e!==-1){this.getItems()[e].getCells()[2].getItems()[0].focus()}}}}).addStyleClass("sapContrastPlus");this._oTable.bindAggregation("items",{path:"/cards",length:100,factory:this._generateTableColumnsTemplate.bind(this)});this._oTable.addDragDropConfig(new s({sourceAggregation:"items",targetAggregation:"items",drop:this._handleDrop.bind(this)}));this._oTable.attachBrowserEvent("keydown",this._attachDndHandler.bind(this,this._oTable,this._handleDrop.bind(this)))}return this._oTable};O.prototype._generateTableColumnsTemplate=function(){var e=new b({press:this._handleCardListItemPress.bind(this),type:"Navigation"}).addStyleClass("insightsListItem insightsListMargin");var t=new h({items:[new i({src:"sap-icon://BusinessSuiteInAppSymbols/icon-grip"}).addStyleClass("insightsDndIcon")]});var s=new g({items:[new B({text:"{descriptorContent/sap.card/header/title}",wrapping:true,press:this._showCardPreviewPopover.bind(this)}),new h({visible:"{= ${descriptorContent/sap.card/header/subTitle} ? true : false }",items:[new p({text:"{descriptorContent/sap.card/header/subTitle}"})]}).addStyleClass("cardsSubTitleMargin")]}).addStyleClass("cardsTitlePadding");var r=new h({items:[new u({type:{path:"visibility",formatter:function(e){return e==true?"Emphasized":"Default"}},enabled:{path:"visibility",mode:"TwoWay",formatter:function(e){if(e==false&&this.getProperty("_visibleCount")>=10){return false}return true}.bind(this)},press:this._handleCardVisibilityToggle.bind(this),icon:"sap-icon://show",tooltip:{path:"visibility",formatter:function(e){return e==true?this.i18Bundle.getText("hideBtn"):this.i18Bundle.getText("showBtn")}.bind(this)}})]});e.addCell(t);e.addCell(s);e.addCell(r);return e};O.prototype._refreshCardList=function(){var e;if(this.bEnableResetAll){e=this.i18Bundle.getText("deleteAllCardsMsg")}else{var t=this.getProperty("_dtCards");var i="<p>"+this.i18Bundle.getText("refreshAllCards")+"</p>";i+="<ul>";t.forEach(function(e){i+='<li class="sapUiTinyMarginBottom">'+e.descriptorContent["sap.card"].header.title+"</li>"});i+="</ul>";e=new T({htmlText:i})}v.show(e,{icon:v.Icon.WARNING,title:this.i18Bundle.getText("refresh"),actions:[v.Action.OK,v.Action.CANCEL],emphasizedAction:v.Action.OK,onClose:function(e){if(e===v.Action.OK){M.getServiceAsync().then(function(e){return e._refreshUserCards(this.bEnableResetAll).then(function(){return this._handleModelChange()}.bind(this))}.bind(this))}}.bind(this)})};O.prototype._handleCardListItemPress=function(e,t){if(e){this.currentCardPreviewPath=e.getSource().getBindingContextPath()}else if(t){this.currentCardPreviewPath=t.getBindingContextPath()}var i=this.getModel().getProperty(this.currentCardPreviewPath);this.fireListPress({manifest:JSON.stringify(i)})};O.prototype._handleCardVisibilityToggle=function(e){this._oWrapperFlexBox.setBusy(true);var t=e.getSource();U=t.getBindingContext().sPath;var i=t.getBindingContext().getPath();var s=this.getModel().getProperty(i);var r=!s.visibility;s.visibility=r;s.descriptorContent["sap.insights"].visible=r;M.getServiceAsync().then(function(e){e._updateCard(s.descriptorContent,true).then(function(){this._oWrapperFlexBox.setBusy(false);this._handleModelChange();if(this._oTable){this._oTable.updateAggregation("items");this._applyFilters(this._oSearchField.getValue(),this._oVisibleFilterSwitch.getState())}return}.bind(this)).catch(function(e){this._oWrapperFlexBox.setBusy(false);_.show(e.message);k.error(e.message)})}.bind(this))};O.prototype._showCardPreviewPopover=function(e){var t=this.getModel();var i=e.getSource().getParent().getBindingContext().getPath();var s=t.getProperty(i);var r=e.getSource();var a=new g({alignItems:"Center",justifyContent:"Center"}).addStyleClass("sapUiSmallMargin");var n=new o({manifest:D.getCardPreviewManifest(s.descriptorContent),width:"17rem",height:"23.5rem",host:this.host});a.addItem(n);var l=new w({title:this.i18Bundle.getText("preview"),placement:"VerticalPreferredBottom",initialFocus:"idCardPreviewPopover",showHeader:true}).addStyleClass("sapContrastPlus previewPopoverBackground");l.addContent(a);l.openBy(r)};O.prototype._handleDrop=function(e){var t=e.getParameter?e.getParameter("draggedControl"):e.draggedControl,i=t.getParent().indexOfItem(t),s=e.getParameter?e.getParameter("droppedControl"):e.droppedControl,r=t.getParent().indexOfItem(s);if(i!==r){var a=this._setCardsRanking(i,r);a=a.map(function(e){var t=JSON.parse(JSON.stringify(e));var i=t.descriptorContent["sap.app"].id;t.descriptorContent["sap.insights"].ranking=t.rank;t.descriptorContent=JSON.stringify(t.descriptorContent);return{id:i,descriptorContent:t.descriptorContent}});try{this._oWrapperFlexBox.setBusy(true);M.getServiceAsync().then(function(e){e._updateMultipleCards(a,"PUT").then(function(){var e=this.getModel().getProperty("/cards");e=e.sort(function(e,t){if(e.rank<t.rank){return-1}return 1});this.getModel().setProperty("/cards",e);this._oWrapperFlexBox.setBusy(false)}.bind(this))}.bind(this))}catch(e){this._oWrapperFlexBox.setBusy(false);k.error(e.message)}}};O.prototype._attachDndHandler=function(e,t,i){var s=i.metaKey||i.ctrlKey;if(s&&(i.key==="ArrowUp"||i.key==="ArrowDown")){i.preventDefault();var r=i.key==="ArrowUp"?"Before":"After";var a=e.getItems();var n=sap.ui.getCore().getCurrentFocusedControlId();var o=a.findIndex(e=>e.getId()===n);if(o>=0&&o<a.length){var l=i.key==="ArrowDown"?o+1:o-1;if(l>=0&&l<a.length){var d=a[o];var h=a[l];var g={draggedControl:d,droppedControl:h,dropPosition:r};W=l;t(g)}a.forEach(function(e,t){e.tabIndex=t===l?0:-1})}}};O.prototype._setCardsRanking=function(e,t){var i=this._oTable.getItems().map(function(e){return e.getBindingContext().getObject()});if(e<t){return F.reorder(i,e,t+1)}return F.reorder(i,e,t)};return O});
//# sourceMappingURL=CardsList.js.map