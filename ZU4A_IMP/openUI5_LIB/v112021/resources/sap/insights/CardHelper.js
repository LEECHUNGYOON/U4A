/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/model/json/JSONModel","sap/insights/CardsChannel","./utils/BatchHelper","./utils/AppConstants","sap/ui/core/Lib"],function(e,t,r,a,i,n){"use strict";var s=e.getLogger("sap.insights.CardHelper");var o=n.getResourceBundleFor("sap.insights");function c(e){return i.REPO_BASE_URL+i.CARD_ENTITY_NAME+"('"+e+"')"}function d(){return fetch(i.REPO_BASE_URL,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(e){var t=e.headers.get("X-CSRF-Token");if(e.ok&&t){return t}f(o.getText("tokenFetchError"))})}function u(e,t,r){if([i.PUT,i.POST].indexOf(r)===-1){f("Method not supported.")}var a=e["sap.app"].id;var n=r===i.PUT?c(a):i.REPO_BASE_URL+i.CARD_ENTITY_NAME;e={descriptorContent:JSON.stringify(e),id:a};var o=JSON.stringify(e);return fetch(n,{method:r,headers:{"X-CSRF-Token":t,"content-type":"application/json;odata.metadata=minimal;charset=utf-8"},body:o}).then(function(e){return e.json()}).then(function(e){if(e.error&&e.error.code==="/UI2/INSIGHTS_MSG/007"){s.error(e.error.message);throw new Error(e.error.code)}else if(e.error){f(e.error.message)}return JSON.parse(e.descriptorContent)})}function p(e){var t=e.split(".");if(t[0]!=="user"){f("sap.app.id value should start with user.<id>.")}}function l(e,t){return fetch(c(e),{method:"DELETE",headers:{"X-CSRF-Token":t}}).then(function(e){return e.ok?{}:e.json()}).then(function(t){if(t.error){f(t.error.message)}return e})}function h(){var e="sap.insights is not enabled for this system.";var t="ux.eng.s4producthomes1";try{var r=window["sap-ushell-config"];var a=r.apps.insights.enabled;var i=r.ushell.homeApp.component.name;var n=i===t;var s=r.ushell.spaces.enabled;if(a&&n&&s){return Promise.resolve(true)}return Promise.reject(new Error(e))}catch(t){return Promise.reject(new Error(e))}}function f(e){s.error(e);throw new Error(e)}function g(e){var t=false;if(e&&e.parameters&&e.parameters.ibnTarget&&e.parameters.ibnTarget.semanticObject&&e.parameters.ibnTarget.action){t=true}if(e&&e.ibnTarget&&e.ibnTarget.semanticObject&&e.ibnTarget.action){t=true}return t}function C(e){var t=false;if(!e["sap.app"]){s.error("Invalid card manifest. sap.app namespace do not exists.");t=true}if(!t&&!e["sap.app"].id){s.error("Invalid card manifest. sap.app.id do not exists.");t=true}if(!t){p(e["sap.app"].id,false)}if(!t&&!e["sap.app"].type){s.error("Invalid card manifest. sap.app.type do not exists.");t=true}if(!t&&e["sap.app"].type.toLowerCase()!=="card"){s.error("Invalid card manifest. invalid value for sap.app.type, expected card.");t=true}if(!t&&!e["sap.card"]){s.error("Invalid card manifest. sap.card namespace do not exists.");t=true}if(!t&&!e["sap.card"].type){s.error("Invalid card manifest. sap.card.type do not exists.");t=true}var r=["Analytical","List","Table"];if(!t&&r.indexOf(e["sap.card"].type)===-1){s.error("Invalid card manifest. Invalid value for sap.card.type. Supported types: "+r);t=true}if(!t&&!e["sap.insights"]){s.error("Invalid card manifest. sap.insights namespace do not exists.");t=true}if(!t&&!e["sap.insights"].parentAppId){s.error("Invalid card manifest. sap.insights.parentAppId do not exists.");t=true}if(!t&&!e["sap.insights"].cardType){s.error("Invalid card manifest. sap.insights.cardType do not exists.");t=true}if(!t&&e["sap.insights"].cardType!=="RT"){s.error("Invalid card manifest. Invalid value for sap.insights.cardType, supported value is RT");t=true}if(!t&&!e["sap.insights"].versions||!e["sap.insights"].versions.ui5){s.error("Invalid card manifest. Invalid value for sap.insights version");t=true}if(!t&&e["sap.insights"].templateName==="OVP"){var a,i,n,c=false,d=e["sap.card"].type;if(d==="Analytical"){a=e["sap.card"].content.actions||[];i=e["sap.card"].header.actions||[];a=a.filter(function(e){return e.type==="Navigation"&&e.parameters&&e.parameters.ibnTarget&&e.parameters.ibnTarget.semanticObject&&e.parameters.ibnTarget.action});i=i.filter(function(e){return e.type==="Navigation"&&e.parameters&&e.parameters.ibnTarget&&e.parameters.ibnTarget.semanticObject&&e.parameters.ibnTarget.action});if(a.length>0||i.length>0){c=true}if(e["sap.card"].configuration.parameters.state&&e["sap.card"].configuration.parameters.state.value){n=JSON.parse(e["sap.card"].configuration.parameters.state.value);c=g(n)}}if(d==="List"||d==="Table"){a=(d==="List"?e["sap.card"].content.item.actions:e["sap.card"].content.row.actions)||[];i=e["sap.card"].header.actions||[];a=a.filter(function(e){return e.type==="Navigation"});i=i.filter(function(e){return e.type==="Navigation"});if(a.length>0||i.length>0){var u={},l={};if(e["sap.card"].configuration.parameters.headerState&&e["sap.card"].configuration.parameters.headerState.value){u=JSON.parse(e["sap.card"].configuration.parameters.headerState.value)}if(e["sap.card"].configuration.parameters.lineItemState&&e["sap.card"].configuration.parameters.lineItemState.value){l=JSON.parse(e["sap.card"].configuration.parameters.lineItemState.value)}var h=g(u),f=g(l);c=h||f}}if(!c){s.error("Invalid card manifest. Card should have navigation.");t=true}}if(t){throw new Error(o.getText("invalidManifest"))}}var v;var m={localCardCache:{},userCardModel:(new t).setDefaultBindingMode("OneWay"),userVisibleCardModel:(new t).setDefaultBindingMode("OneWay"),parentAppDetailsCache:{},_oViewCache:{},_mergeCard:function(e,t,r){try{if(!r){C(e)}}catch(e){return Promise.reject(e)}this.userVisibleCardModel.setProperty("/isLoading",true);return d().then(function(r){return u(e,r,t)}).then(function(e){this.localCardCache={};this.userVisibleCardModel.setProperty("/isLoading",false);return e}.bind(this)).catch(function(e){this.userVisibleCardModel.setProperty("/isLoading",false);return Promise.reject(e)}.bind(this))},_createCard:function(e,t){return this._mergeCard(e,i.POST,t)},_createCards:function(e){var t=function(e){return e.filter(function(e){try{C(e);return true}catch(e){return false}})};var r=function(e){return e.map(function(e){var t=JSON.parse(JSON.stringify(e));return{id:t["sap.app"].id,descriptorContent:JSON.stringify(t)}})};var a=t(e);if(a.length>0){return this._updateMultipleCards(r(a),i.POST)}return Promise.resolve()},_updateCard:function(e,t){return this._mergeCard(e,i.PUT,t)},_deleteCard:function(e){try{p(e)}catch(e){return Promise.reject(e)}this.userVisibleCardModel.setProperty("/isLoading",true);return d().then(function(t){return l(e,t)}).then(function(e){this.localCardCache={};this.userVisibleCardModel.setProperty("/isLoading",false);var t=this.userCardModel.getProperty("/cards");var r=t.findIndex(function(t){return t.id===e});if(r>-1){t.splice(r,1)}this.userCardModel.setProperty("/cards",t);return e}.bind(this))},_getUserAllCards:function(){if(this.localCardCache&&this.localCardCache.userCards){return Promise.resolve(this.localCardCache.userCards)}var e=i.CARD_READ_URL+"?$orderby=rank";return this._readCard(e).then(function(e){this.localCardCache.userCards=e;return e}.bind(this))},_getUserAllCardModel:function(){return this._getUserAllCards().then(function(e){var t=e.filter(function(e){return e.visibility});this.userCardModel.setProperty("/cards",e);this.userCardModel.setProperty("/cardCount",e.length);this.userCardModel.setProperty("/visibleCardCount",t.length);return this.userCardModel}.bind(this))},_getUserVisibleCards:function(){if(this.localCardCache.userVisibleCards){return Promise.resolve(this.localCardCache.userVisibleCards)}var e=i.CARD_READ_URL+"?$filter=visibility eq true&$select=descriptorContent,visibility,rank&$orderby=rank&$skip=0&$top=10";return this._readCard(e).then(function(e){this.localCardCache.userVisibleCards=e;return e}.bind(this))},_getUserVisibleCardModel:function(){return this._getUserVisibleCards().then(function(e){this.userVisibleCardModel.setProperty("/cards",e);this.userVisibleCardModel.setProperty("/cardCount",e.length);this.userVisibleCardModel.setProperty("/isLoading",false);return this.userVisibleCardModel}.bind(this))},_readCard:function(e){return fetch(e).then(function(e){if(e.ok){return e.json()}f("Cannot read user's suggested cards.")}).then(function(e){e.value.forEach(function(e){if(e.descriptorContent){e.descriptorContent=JSON.parse(e.descriptorContent)}});return e.value})},_refreshUserCards:function(e){this.userVisibleCardModel.setProperty("/isLoading",true);this.userCardModel.setProperty("/isLoading",true);var t=e?{deleteAllCards:"X"}:{};return new Promise(function(e){fetch(i.REPO_BASE_URL,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(r){var a=r.headers.get("X-CSRF-Token");fetch(i.REPO_BASE_URL+i.CARD_ENTITY_NAME+"/com.sap.gateway.srvd.ui2.insights_cards_repo_srv.v0001.deleteCards?",{method:i.POST,headers:{"X-CSRF-Token":a,"content-type":"application/json;odata.metadata=minimal;charset=utf-8"},body:JSON.stringify(t)}).then(function(e){return e.json()}).then(function(t){var r=t.value||[];this.iVisCardCount=0;r.forEach(function(e){if(e.descriptorContent){e.descriptorContent=JSON.parse(e.descriptorContent)}if(e.visibility){this.iVisCardCount++}}.bind(this));this.localCardCache={};this.localCardCache.userCards=r;this.userVisibleCardModel.setProperty("/isLoading",false);return this._getUserAllCardModel().then(function(){this.userCardModel.setProperty("/isLoading",false);e()}.bind(this))}.bind(this))}.bind(this))}.bind(this))},getParentAppDetails:function(e){if(this.parentAppDetailsCache[e.descriptorContent["sap.app"].id]){return Promise.resolve(this.parentAppDetailsCache[e.descriptorContent["sap.app"].id])}var t={};var r=e.descriptorContent["sap.insights"].parentAppUrl;if(r){return sap.ushell.Container.getServiceAsync("URLParsing").then(function(a){var i=a.parseShellHash(r);return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){return e.isNavigationSupported([{target:{semanticObject:i.semanticObject,action:i.action},params:i.params}])}).then(function(a){if(a[0].supported){t.semanticObject=i.semanticObject;t.action=i.action;t.semanticURL=r;t.title=e.descriptorContent["sap.app"].title;this.parentAppDetailsCache[e.descriptorContent["sap.app"].id]=t;return Promise.resolve(t)}else{return this._getParentApp(e)}}.bind(this))}.bind(this))}else{return this._getParentApp(e)}},_getParentApp:function(e){var t={};return sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(r){var a=r._oAdapter._aInbounds||[];var i=a.find(function(t){return t.resolutionResult&&t.resolutionResult.applicationDependencies&&t.resolutionResult.applicationDependencies.name===e.descriptorContent["sap.insights"].parentAppId});if(i){t.semanticObject=i.semanticObject;t.action=i.action;t.semanticURL="#"+i.semanticObject+"-"+i.action;t.title=e.descriptorContent["sap.app"].title;this.parentAppDetailsCache[e.descriptorContent["sap.app"].id]=t}return t}.bind(this))},_updateMultipleCards:function(e,t){try{return a.createMultipartRequest(e,t).then(function(){this.localCardCache={};return Promise.resolve()}.bind(this)).catch(function(e){return Promise.reject(e)})}catch(e){return Promise.reject(e)}},showCardPreview:function(e,t,r,a,i,n){return new Promise(function(o,c){try{sap.ui.require(["sap/insights/ManagePreview"],function(s){if(!this._oManagePreviewDialog){this._oManagePreviewDialog=new s({transformation:t,cardMessageInfo:r,confirmButtonText:a,dialogTitle:n,manifest:e})}else{this._oManagePreviewDialog.setTransformation(t);this._oManagePreviewDialog.setCardMessageInfo(r);this._oManagePreviewDialog.setConfirmButtonText(a);this._oManagePreviewDialog.setManifest(e);this._removeAllEventListeners(this._oManagePreviewDialog,"onConfirmButtonPress")}if(i){this._oManagePreviewDialog.attachOnConfirmButtonPress(i)}this._oManagePreviewDialog.openPreviewDialog();o(this._oManagePreviewDialog)}.bind(this))}catch(e){s.error(e.message);c(e.message)}}.bind(this))},_removeAllEventListeners:function(e,t){if(e.hasListeners(t)){e.mEventRegistry[t].forEach(function(r){e.detachEvent(t,r.fFunction,r.oListener)})}},getCardsChannel:function(){if(v){return Promise.resolve(v)}else{return new Promise(function(e){v=new r;v.init().then(function(){e(v)})})}}};return{getServiceAsync:function(){return h().then(function(){return m}).catch(function(e){return Promise.reject(e)})}}});
//# sourceMappingURL=CardHelper.js.map