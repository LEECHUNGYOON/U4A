sap.ui.define(["sap/ui/core/library","sap/ui/core/Control","sap/ui/model/type/Date","sap/ui/model/odata/type/ODataType","sap/ui/core/format/DateFormat","./TimePickerSlider","./TimePickerSlidersRenderer","./VisibleItem","sap/ui/core/LocaleData","sap/ui/Device","sap/ui/core/Locale","sap/ui/thirdparty/jquery","sap/ui/core/Configuration","sap/ui/core/date/UI5Date"],(function(e,t,i,r,s,n,o,a,l,u,p,jQuery,d,g){"use strict";var h=e.CalendarType,c=t.extend("sap.m.TimePickerSliders",{metadata:{library:"sap.m",properties:{localeId:{type:"string",group:"Data"},displayFormat:{type:"string",group:"Appearance"},labelText:{type:"string"},minutesStep:{type:"int",group:"Misc",defaultValue:1},secondsStep:{type:"int",group:"Misc",defaultValue:1},width:{type:"sap.ui.core.CSSSize",group:"Appearance"},height:{type:"sap.ui.core.CSSSize",group:"Appearance"},value:{type:"string",group:"Data",defaultValue:null},valueFormat:{type:"string",group:"Data",defaultValue:null},support2400:{type:"boolean",group:"Misc",defaultValue:!1}},aggregations:{_columns:{type:"sap.m.TimePickerSlider",multiple:!0,visibility:"hidden"}},events:{change:{parameters:{value:{type:"string"}}}}},renderer:o});function _(){return!1}return c.prototype.init=function(){var e=d.getFormatSettings().getFormatLocale(),t=l.getInstance(e),i=t.getDayPeriods("abbreviated"),r=t.getTimePattern("medium");this._fnLayoutChanged=jQuery.proxy(this._onOrientationChanged,this),u.resize.attachHandler(this._fnLayoutChanged),this._sAM=i[0],this._sPM=i[1],this._onSliderExpanded=this._onSliderExpanded.bind(this),this._onSliderCollapsed=this._onSliderCollapsed.bind(this),this.setDisplayFormat(r),this._setTimeValues(),this._iMinutes,this._iSeconds},c.prototype.exit=function(){this.$().off(u.browser.firefox?"DOMMouseScroll":"mousewheel",this._onmousewheel),u.resize.detachHandler(this._fnOrientationChanged)},c.prototype.onAfterRendering=function(){this.$().off(u.browser.firefox?"DOMMouseScroll":"mousewheel",this._onmousewheel),this.$().on(u.browser.firefox?"DOMMouseScroll":"mousewheel",jQuery.proxy(this._onmousewheel,this)),this.$().on("selectstart",_),this._getShouldOpenSliderAfterRendering()&&u.system.desktop&&this._getFirstSlider().setIsExpanded(!0)},c.prototype.setLocaleId=function(e){var t,i;return e=this.validateProperty("localeId",e),this.setProperty("localeId",e,!0),e&&(t=new p(e),i=l.getInstance(t).getDayPeriods("abbreviated"),this._sAM=i[0],this._sPM=i[1],this._destroyColumns(),this._setupLists()),this},c.prototype.setSupport2400=function(e){return this.setProperty("support2400",e,!0),this._destroyColumns(),this._setupLists(),this},c.prototype.setDisplayFormat=function(e){return this.setProperty("displayFormat",e,!0),this._destroyColumns(),this._setupLists(),this},c.prototype.setMinutesStep=function(e){return e=Math.max(1,e||1),this.setProperty("minutesStep",e,!0),this._destroyColumns(),this._setupLists(),this},c.prototype.setSecondsStep=function(e){return e=Math.max(1,e||1),this.setProperty("secondsStep",e,!0),this._destroyColumns(),this._setupLists(),this},c.prototype.setValue=function(e){var t,i=this._getHoursSlider(),r=this._getValueFormatPattern(),s=r.indexOf("HH"),n=r.indexOf("H"),o=i&&"24"===i.getSelectedValue(),a=c._isHoursValue24(e,s,n);return o&&this._isFormatSupport24()&&!a&&(e=c._replaceZeroHoursWith24(e,s,n)),e=this.validateProperty("value",e),this.setProperty("value",e,!0),e&&(t=this._parseValue(a?c._replace24HoursWithZero(e,s,n):e)),t&&this._setTimeValues(t,a),this},c.prototype.getTimeValues=function(){var e=this._getHoursSlider(),t=this._getMinutesSlider(),i=this._getSecondsSlider(),r=this._getFormatSlider(),s=null,n=null,o=g.getInstance();return e&&(s=parseInt(e.getSelectedValue())),r&&(n=r.getSelectedValue()),"am"===n&&12===s?s=0:"pm"===n&&12!==s&&(s+=12),null!==s&&o.setHours(s.toString()),t&&o.setMinutes(t.getSelectedValue()),i&&o.setSeconds(i.getSelectedValue()),o},c.prototype.collapseAll=function(){var e=this.getAggregation("_columns");if(e)for(var t=0;t<e.length;t++)e[t].getIsExpanded()&&e[t].setIsExpanded(!1);return this},c.prototype.openFirstSlider=function(){var e=this._getFirstSlider();return e.setIsExpanded(!0),e.focus(),this},c.prototype._setTimeValues=function(e,t){var i,r=this._getHoursSlider(),s=this._getMinutesSlider(),n=this._getSecondsSlider(),o=this._getFormatSlider(),a=null;if(e=e||g.getInstance(),"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e))throw new Error("Date must be a JavaScript date object; "+this);if(t)i=24;else{var l=this._formatValue(e,!0);this.setProperty("value",l,!0),i=e.getHours()}o&&(a=i>=12?"pm":"am",i=0===(i=i>12?i-12:i)?12:i),r&&r.setSelectedValue(i.toString()),s&&s._updateStepAndValue(e.getMinutes(),this.getMinutesStep()),n&&n._updateStepAndValue(e.getSeconds(),this.getSecondsStep()),o&&o.setSelectedValue(a),t?(this._disableSlider(s),s&&s.setSelectedValue("0"),this._disableSlider(n),n&&n.setSelectedValue("0")):(this._enableSlider(s),this._enableSlider(n))},c.prototype._updateSlidersValues=function(){var e=this.getAggregation("_columns");if(e)for(var t=0;t<e.length;t++)e[t]._updateScroll()},c.prototype.onsaphome=function(e){var t=this._getFirstSlider(),i=this._getCurrentSlider();i&&document.activeElement===i.getDomRef()&&this._isSliderEnabled(t)&&t.focus()},c.prototype.onsapend=function(e){var t=this._getLastSlider(),i=this._getCurrentSlider();i&&document.activeElement===i.getDomRef()&&this._isSliderEnabled(t)&&t.focus()},c.prototype.onsapleft=function(e){var t,i=this._getCurrentSlider(),r=-1,s=this.getAggregation("_columns");i&&document.activeElement===i.getDomRef()&&(r=s.indexOf(i),t=s[r>0?r-1:s.length-1],this._isSliderEnabled(t)&&t.focus())},c.prototype.onsapright=function(e){var t,i=this._getCurrentSlider(),r=-1,s=this.getAggregation("_columns");i&&document.activeElement===i.getDomRef()&&(r=s.indexOf(i),t=s[r<s.length-1?r+1:0],this._isSliderEnabled(t)&&t.focus())},c.prototype._onmousewheel=function(e){var t=this._getCurrentSlider();t&&t._onmousewheel(e)},c.prototype._onOrientationChanged=function(){var e=this.getAggregation("_columns");if(e)for(var t=0;t<e.length;t++)e[t].getIsExpanded()&&e[t]._updateSelectionFrameLayout()},c.prototype._generatePickerListValues=function(e,t,i,r){for(var s,n=[],o=e;o<=t;o+=1){s=o<10&&r?"0"+o.toString():o.toString();var l=new a({key:o.toString(),text:s});o%i!=0&&l.setVisible(!1),n.push(l)}return n},c.prototype._checkStyle=function(e){return"short"===e||"medium"===e||"long"===e||"full"===e},c.prototype._getDisplayFormatPattern=function(){var e=this.getDisplayFormat();return this._checkStyle(e)&&(e=this._getLocaleBasedPattern(e)),e},c.prototype._getValueFormatPattern=function(){var e=this._getBoundValueTypePattern()||this.getValueFormat()||"medium";return this._checkStyle(e)&&(e=this._getLocaleBasedPattern(e)),e},c.prototype._getLocaleBasedPattern=function(e){return l.getInstance(d.getFormatSettings().getFormatLocale()).getTimePattern(e)},c.prototype._destroyColumns=function(){this.getAggregation("_columns")&&this.destroyAggregation("_columns")},c.prototype._setupLists=function(){var e=sap.ui.getCore().getLibraryResourceBundle("sap.m"),t=e.getText("TIMEPICKER_LBL_HOURS"),i=e.getText("TIMEPICKER_LBL_MINUTES"),r=e.getText("TIMEPICKER_LBL_SECONDS"),s=e.getText("TIMEPICKER_LBL_AMPM"),o=this.getMinutesStep(),l=this.getSecondsStep(),u=this._getDisplayFormatPattern();if(void 0!==u){var p,d,g=!1,h=!1;if(-1!==u.indexOf("HH")?(g=!0,p=0,d=this.getSupport2400()?24:23,h=!0):-1!==u.indexOf("H")?(g=!0,p=0,d=this.getSupport2400()?24:23):-1!==u.indexOf("hh")?(g=!0,p=1,d=12,h=!0):-1!==u.indexOf("h")&&(g=!0,p=1,d=12),g&&this.addAggregation("_columns",new n(this.getId()+"-listHours",{items:this._generatePickerListValues(p,d,1,h),expanded:this._onSliderExpanded,collapsed:this._onSliderCollapsed,label:t}).attachEvent("_selectedValueChange",this._handleHoursChange,this)),-1!==u.indexOf("m")){var c=this._generatePickerListValues(0,59,o,!0);this.addAggregation("_columns",new n(this.getId()+"-listMins",{items:c,expanded:this._onSliderExpanded,collapsed:this._onSliderCollapsed,label:i}))}if(-1!==u.indexOf("s")){c=this._generatePickerListValues(0,59,l,!0);this.addAggregation("_columns",new n(this.getId()+"-listSecs",{items:c,expanded:this._onSliderExpanded,collapsed:this._onSliderCollapsed,label:r}))}-1!==u.indexOf("a")&&this.addAggregation("_columns",new n(this.getId()+"-listFormat",{items:[new a({key:"am",text:this._sAM}),new a({key:"pm",text:this._sPM})],expanded:this._onSliderExpanded,collapsed:this._onSliderCollapsed,label:s,isCyclic:!1}).addStyleClass("sapMTimePickerSliderShort"));var _,S=this.getValue();S&&(_=this._parseValue(S)),_&&this._setTimeValues(_)}},c.prototype._getCurrentSlider=function(){var e=this.getAggregation("_columns");if(e)for(var t=0;t<e.length;t++)if(e[t].getIsExpanded())return e[t];return null},c.prototype._getHoursSlider=function(){return sap.ui.getCore().byId(this.getId()+"-listHours")||null},c.prototype._getMinutesSlider=function(){return sap.ui.getCore().byId(this.getId()+"-listMins")||null},c.prototype._getSecondsSlider=function(){return sap.ui.getCore().byId(this.getId()+"-listSecs")||null},c.prototype._getFormatSlider=function(){return sap.ui.getCore().byId(this.getId()+"-listFormat")||null},c.prototype._getFirstSlider=function(){return this.getAggregation("_columns")[0]||null},c.prototype._getLastSlider=function(){var e=this.getAggregation("_columns");return e[e.length-1]||null},c.prototype._parseValue=function(e){return this._getFormatter().parse(e)},c.prototype._isSliderEnabled=function(e){return e._getEnabled()},c.prototype._getFormatter=function(){var e,t=this._getBoundValueTypePattern(),i=!1,r=this.getBinding("value");return r&&r.oType&&r.oType.oOutputFormat&&(i=!!r.oType.oOutputFormat.oFormatOptions.relative,e=r.oType.oOutputFormat.oFormatOptions.calendarType),t||(t=this.getValueFormat()||"medium",e=h.Gregorian),e||(e=d.getCalendarType()),this._getFormatterInstance(t,i,e)},c.prototype._getBoundValueTypePattern=function(){var e=this.getBinding("value"),t=e&&e.getType&&e.getType();return t instanceof i?t.getOutputPattern():t instanceof r&&t.oFormat?t.oFormat.oFormatOptions.pattern:void 0},c.prototype._getFormatterInstance=function(e,t,i,r){return this._checkStyle(e)?this._getFormatInstance({style:e,strictParsing:!0,relative:t,calendarType:i}):this._getFormatInstance({pattern:e,strictParsing:!0,relative:t,calendarType:i})},c.prototype._getFormatInstance=function(e,t){return s.getTimeInstance(e)},c.prototype._formatValue=function(e){return e?this._getFormatter().format(e):""},c.prototype._onSliderExpanded=function(e){for(var t=this.getAggregation("_columns"),i=0;i<t.length;i++)t[i]!==e.oSource&&t[i].getIsExpanded()&&t[i].setIsExpanded(!1)},c.prototype._onSliderCollapsed=function(e){var t=this.getTimeValues();this.setValue(this._formatValue(t,!0)),this.fireChange({value:this.getValue()})},c.prototype._getShouldOpenSliderAfterRendering=function(){return this._shouldOpenSliderAfterRendering},c.prototype._setShouldOpenSliderAfterRendering=function(e){return this._shouldOpenSliderAfterRendering=e,this},c.prototype._isFormatSupport24=function(){var e=this._getDisplayFormatPattern();return-1!==e.indexOf("HH")||-1!==e.indexOf("H")},c.prototype._disableSlider=function(e){return e&&e._setEnabled(!1),this},c.prototype._enableSlider=function(e){return e&&e._setEnabled(!0),this},c.prototype._handleHoursChange=function(e){var t=e.getParameter("value"),i=this._getMinutesSlider(),r=this._getSecondsSlider();this.getSupport2400()&&("24"===t?(i&&i._getEnabled()&&(this._iMinutes=i.getSelectedValue(),this._disableSlider(i),i.setSelectedValue("0")),r&&r._getEnabled()&&(this._iSeconds=r.getSelectedValue(),this._disableSlider(r),r.setSelectedValue("0"))):(i&&!i._getEnabled()&&(this._enableSlider(i),i.setSelectedValue(this._iMinutes)),r&&!r._getEnabled()&&(this._enableSlider(r),r.setSelectedValue(this._iSeconds))))},c._replaceZeroHoursWith24=function(e,t,i){var r=2,s=t;return-1===t&&(r=1,s=i),e.substr(0,s)+"24"+e.substr(s+r)},c._replace24HoursWithZero=function(e,t,i){var r=2,s=t;return-1===t&&(r=1,s=i),e.substr(0,s)+function(e,t){for(var i="",r=0;r<t;r++)i+=e;return i}(0,r)+e.substr(s+2)},c._isHoursValue24=function(e,t,i){if(-1===t&&-1===i)return!1;var r=t;return-1===t&&(r=i),"24"===e.substr(r,2)},c}));