sap.ui.define(["sap/m/library","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/delegate/ScrollEnablement","./WizardProgressNavigator","sap/ui/core/util/ResponsivePaddingsEnablement","sap/ui/Device","./WizardRenderer","sap/ui/core/CustomData","sap/base/Log","sap/ui/base/DesignTime","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/Focusable"],(function(t,e,i,r,n,s,o,a,p,h,g,u,jQuery){"use strict";var c=t.PageBackgroundDesign,l=t.WizardRenderMode,S=r.TitleLevel,d=e.extend("sap.m.Wizard",{metadata:{library:"sap.m",designtime:"sap/m/designtime/Wizard.designtime",interfaces:["sap.f.IDynamicPageStickyContent"],properties:{width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},showNextButton:{type:"boolean",group:"Behavior",defaultValue:!0},finishButtonText:{type:"string",group:"Appearance",defaultValue:"Review"},enableBranching:{type:"boolean",group:"Behavior",defaultValue:!1},backgroundDesign:{type:"sap.m.PageBackgroundDesign",group:"Appearance",defaultValue:c.Standard},renderMode:{type:"sap.m.WizardRenderMode",group:"Appearance",defaultValue:l.Scroll},stepTitleLevel:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:S.H3}},defaultAggregation:"steps",aggregations:{steps:{type:"sap.m.WizardStep",multiple:!0,singularName:"step"},_progressNavigator:{type:"sap.ui.core.Control",multiple:!1,visibility:"hidden"},_nextButton:{type:"sap.m.Button",multiple:!1,visibility:"hidden"}},associations:{currentStep:{type:"sap.m.WizardStep",multiple:!1}},events:{stepActivate:{parameters:{index:{type:"int"}}},navigationChange:{parameters:{step:{type:"sap.m.WizardStep"}}},complete:{parameters:{}}},dnd:{draggable:!1,droppable:!0}},renderer:p});return d.CONSTANTS={MINIMUM_STEPS:0,MAXIMUM_STEPS:99,ANIMATION_TIME:300,SCROLL_OFFSET:16},o.call(d.prototype,{header:{suffix:"progressNavigator"},content:{suffix:"step-container"}}),d.prototype.init=function(){this._iStepCount=0,this._aStepPath=[],this._bScrollLocked=!1,this._oScroller=this._initScrollEnablement(),this._oResourceBundle=i.getLibraryResourceBundle("sap.m"),this._initProgressNavigator(),this._initResponsivePaddingsEnablement(),this._iNextButtonHeight=0},d.prototype.onBeforeRendering=function(){var t=this._getStartingStep(),e=this.getStepTitleLevel()===S.Auto?S.H3:this.getStepTitleLevel();this._isStepCountInRange()||g.error("The Wizard is supposed to handle from 3 to 8 steps."),this._saveInitialValidatedState(),t&&this._aStepPath.indexOf(t)<0&&(this._activateStep(t),t._setNumberInvisibleText(1)),this.getSteps().forEach((function(t){t.setProperty("_titleLevel",e)}))},d.prototype.onAfterRendering=function(){this.getCurrentStep()||this.setAssociation("currentStep",this._getStartingStep(),!0);var t=this._getCurrentStepInstance();t&&this._activateAllPreceedingSteps(t),this._attachScrollHandler(),this._renderPageMode()},d.prototype._renderPageMode=function(t,e){var r,n,s;this.getRenderMode()===l.Page&&(t?(r=this._aStepPath.indexOf(t)+1,n=t):(r=this._getProgressNavigator().getCurrentStep(),n=this._aStepPath[r-1]),(s=i.createRenderManager()).renderControl(this._updateStepTitleNumber(n,r)),s.flush(this.getDomRef("step-container")),s.destroy(),e&&this._focusFirstStepElement(t))},d.prototype._updateStepTitleNumber=function(t,e){var i=t.getCustomData().filter((function(t){return"stepIndex"===t.getKey()}))[0];return i?i.setValue(e):t.addCustomData(new h({key:"stepIndex",value:e})),t},d.prototype.exit=function(){var t=this.getDomRef("step-container");t&&(t.onscroll=null),this._oScroller.destroy(),this._oScroller=null,this._aStepPath=null,this._iStepCount=null,this._bScrollLocked=null,this._oResourceBundle=null,this._iNextButtonHeight=null},d.prototype.validateStep=function(t){return this._containsStep(t)?(t.setValidated(!0),this):(g.error("The wizard does not contain this step"),this)},d.prototype.invalidateStep=function(t){return this._containsStep(t)?(t.setValidated(!1),this):(g.error("The wizard does not contain this step"),this)},d.prototype.nextStep=function(){var t=this._getProgressNavigator().getProgress()-1,e=this._aStepPath[t];return this.validateStep(e),e._complete(),this},d.prototype.previousStep=function(){var t=this._getProgressNavigator().getProgress()-2;return t>=0&&this.discardProgress(this._aStepPath[t]),this},d.prototype.getProgress=function(){return this._getProgressNavigator().getProgress()},d.prototype.getProgressStep=function(){return this._aStepPath[this.getProgress()-1]},d.prototype.goToStep=function(t,e){var i=function(){var e=this._getProgressNavigator();e&&e._updateCurrentStep(this._aStepPath.indexOf(t)+1)};if(!this.getVisible()||this._aStepPath.indexOf(t)<0)return this;if(this.getRenderMode()===l.Page)return i.call(this),this._renderPageMode(t,e),this;t._setNumberInvisibleText(this.getProgress());var r=this,n={scrollTop:this._getStepScrollOffset(t)},s={queue:!1,duration:d.CONSTANTS.ANIMATION_TIME,start:function(){r._bScrollLocked=!0},complete:function(){r._bScrollLocked=!1,i.call(r),(e||void 0===e)&&r._focusFirstStepElement(t)}};return jQuery(this.getDomRef("step-container")).animate(n,s),this},d.prototype.discardProgress=function(t,e){var i=this.getProgress(),r=this._aStepPath,n=this._aStepPath.indexOf(t),s=this._aStepPath[n],o=n+1;if(o>i||o<=0)return g.warning("The given step is either not yet reached, or is not present in the wizard control."),this;this._getProgressNavigator().discardProgress(o,!0),this._updateProgressNavigator(),this._restoreInitialValidatedState(o);for(var a=o;a<r.length;a++)r[a]._deactivate(),r[a].getSubsequentSteps().length>1&&r[a].setNextStep(null);return this.setAssociation("currentStep",t),s.setWizardContext({sButtonText:this._getNextButtonText(),bLast:!0}),t.getSubsequentSteps().length>1&&!e&&t.setNextStep(null),r.splice(o),this},d.prototype.setCurrentStep=function(t){var e="string"==typeof t?i.byId(t):t;return this.getEnableBranching()||this.setAssociation("currentStep",t,!0),e&&this._isStepReachable(e)?this._activateAllPreceedingSteps(e):g.error("The given step could not be set as current step."),this},d.prototype.setShowNextButton=function(t){return this.setProperty("showNextButton",t,!0),this.getSteps().forEach((function(e){e.setWizardContext({bParentAllowsButtonShow:t})})),this},d.prototype.getFinishButtonText=function(){return"Review"===this.getProperty("finishButtonText")?this._oResourceBundle.getText("WIZARD_FINISH"):this.getProperty("finishButtonText")},d.prototype.addStep=function(t){return this._isMaxStepCountReached()?(g.error("The Wizard is supposed to handle up to 8 steps."),this):(t.setWizardContext({bParentAllowsButtonShow:this.getShowNextButton()}),this._incrementStepCount(),this.addAggregation("steps",t))},d.prototype.setBackgroundDesign=function(t){var e=this.getBackgroundDesign();return this.setProperty("backgroundDesign",t,!0),this.$().removeClass("sapMWizardBg"+e).addClass("sapMWizardBg"+this.getBackgroundDesign()),this},d.prototype.insertStep=function(t,e){if(u.isDesignModeEnabled())return this.insertAggregation("steps",t,e);throw new Error("Dynamic step insertion is not yet supported.")},d.prototype.removeStep=function(t){if(u.isDesignModeEnabled())return this.removeAggregation("steps",t);throw new Error("Dynamic step removal is not yet supported.")},d.prototype.removeAllSteps=function(){return this._resetStepCount(),this.removeAllAggregation("steps").map((function(t){return t}),this)},d.prototype.destroySteps=function(){return this._resetStepCount(),this.destroyAggregation("steps")},d.prototype._getStickyContent=function(){return this._getProgressNavigator()},d.prototype._returnStickyContent=function(){this.bIsDestroyed||this._getStickyContent().$().prependTo(this.$())},d.prototype._setStickySubheaderSticked=function(t){this._bStickyContentSticked=t},d.prototype._getStickySubheaderSticked=function(){return this._bStickyContentSticked},d.prototype._activateAllPreceedingSteps=function(t){if(this._aStepPath.indexOf(t)>=0)this.discardProgress(t,!0);else for(;this.getProgressStep()!==t;)this.nextStep()},d.prototype._isNextStepDetermined=function(t,e){return!this.getEnableBranching()||(t=t||this._getCurrentStepInstance(),null!==this._getNextStep(t,e))},d.prototype._isStepReachable=function(t){if(this.getEnableBranching()){for(var e=this._getStartingStep();e!==t;)if(null==(e=e._getNextStepReference()))return!1;return this.setAssociation("currentStep",t),!0}return this.getSteps().indexOf(t)>=0},d.prototype._initScrollEnablement=function(){return new n(this,null,{scrollContainerId:this.getId()+"-step-container",horizontal:!1,vertical:!0})},d.prototype._initProgressNavigator=function(){var t=this,e=new s(this.getId()+"-progressNavigator",{stepChanged:this._handleStepChanged.bind(this)});e._setOnEnter((function(e,i){var r=t._aStepPath[i];setTimeout(function(){this._focusFirstStepElement(r)}.bind(t),d.CONSTANTS.ANIMATION_TIME)})),this.setAggregation("_progressNavigator",e)},d.prototype._handleNextButtonPress=function(){var t=this._getProgressNavigator(),e=t.getProgress();if(this.isStepFinal())this.fireComplete();else{var i=this.getProgressStep();if(!this._isNextStepDetermined(i,e))throw new Error("The wizard is in branching mode, and the nextStep association is not set.");t.incrementProgress(),this._handleStepActivated(t.getProgress()),this._handleStepChanged(t.getProgress(),!0)}},d.prototype._getStepScrollOffset=function(t){var e=this.getDomRef("step-container"),i=e?e.scrollTop:0,r=0,n=0,s=this._getNextButtonHeight(),o=t.getDomRef()?t.getDomRef().scrollHeight:0,a=e?e.clientHeight:0;return t&&t.$()&&t.$().position()&&(r=t.$().position().top||0),s>0&&o>a&&(n=s),this._setNextButtonHeight(0),i+r-(d.CONSTANTS.SCROLL_OFFSET+n)},d.prototype._focusFirstStepElement=function(t){var e=t.$();e&&e.firstFocusableDomRef()&&e.firstFocusableDomRef().focus()},d.prototype._handleStepChanged=function(t,e){var i=("number"==typeof t?t:t.getParameter("current"))-2,r=this._aStepPath[i],n=this._getNextStep(r,i),s=!!a.system.desktop;!e&&this.fireNavigationChange({step:n}),this.goToStep(n,s)},d.prototype._handleStepActivated=function(t){var e=t-2,i=this._aStepPath[e],r=this._getNextStep(i,e),n=this._getNextButton().getDomRef();this._setNextButtonHeight(n?n.offsetHeight:0),this._activateStep(r),this._updateProgressNavigator(),this.fireStepActivate({index:t}),this.setAssociation("currentStep",this.getProgressStep(),!0),this.getProgressStep().setWizardContext({bLast:!0,bReviewStep:this.isStepFinal(),sButtonText:this._getNextButtonText()})},d.prototype._isMaxStepCountReached=function(){var t=this._getStepCount();return!this.getEnableBranching()&&t>=d.CONSTANTS.MAXIMUM_STEPS},d.prototype._isStepCountInRange=function(){var t=this._getStepCount();return!(t<d.CONSTANTS.MINIMUM_STEPS||!this.getEnableBranching()&&t>d.CONSTANTS.MAXIMUM_STEPS)},d.prototype._getStepCount=function(){return this._iStepCount},d.prototype._incrementStepCount=function(){this._iStepCount+=1,this._getProgressNavigator().setStepCount(this._getStepCount())},d.prototype._decrementStepCount=function(){this._iStepCount-=1,this._getProgressNavigator().setStepCount(this._getStepCount())},d.prototype._resetStepCount=function(){this._iStepCount=0,this._getProgressNavigator().setStepCount(this._getStepCount())},d.prototype._getProgressNavigator=function(){return this.getAggregation("_progressNavigator")},d.prototype._saveInitialValidatedState=function(){this._aInitialValidatedState||(this._aInitialValidatedState=this.getSteps().map((function(t){return t.getValidated()})))},d.prototype._restoreInitialValidatedState=function(t){for(var e=this._aStepPath,i=this.getSteps(),r=t;r<e.length;r++){var n=e[r],s=i.indexOf(n),o=this._aInitialValidatedState[s];n.setValidated(o)}},d.prototype._getNextStep=function(t,e){if(!this.getEnableBranching())return this.getSteps()[e+1];if(e<0)return this._getStartingStep();var i=t._getNextStepReference();if(null===i)throw new Error("The wizard is in branching mode, and no next step is defined for the current step, please set one.");if(!this._containsStep(i))throw new Error("The next step that you have defined is not part of the wizard steps aggregation.Please add it to the wizard control.");if(t.getSubsequentSteps().length>0&&!t._containsSubsequentStep(i.getId()))throw new Error("The next step that you have defined is not contained inside the subsequentSteps association of the current step.");return i},d.prototype.isStepFinal=function(){var t=this._getStepCount(),e=this.getProgress();return this.getEnableBranching()?this._aStepPath[this._aStepPath.length-1]._isLeaf():e===t},d.prototype._getNextButtonText=function(){return this.isStepFinal()?this.getFinishButtonText():this._oResourceBundle.getText("WIZARD_STEP")+" "+(this.getProgress()+1)},d.prototype._getNextButton=function(){var t=this._getCurrentStepInstance();return t?t.getAggregation("_nextButton"):null},d.prototype._updateProgressNavigator=function(){var t=this._getProgressNavigator(),e=this._getStartingStep(),i=this.getSteps(),r=[e.getTitle()],n=[e.getIcon()],s=[e.getOptional()],o=1;if(this.getEnableBranching()){for(;!e._isLeaf()&&null!==e._getNextStepReference();)o++,e=e._getNextStepReference(),r.push(e.getTitle()),s.push(e.getOptional()),n.push(e.getIcon());t.setVaryingStepCount(e._isBranched()),t.setStepCount(o)}else r=i.map((function(t){return t.getTitle()})),s=i.map((function(t){return t.getOptional()})),n=i.map((function(t){return t.getIcon()}));t.setStepTitles(r),t._aStepOptionalIndication=s,t.setStepIcons(n)},d.prototype._getStartingStep=function(){return this.getSteps()[0]},d.prototype._attachScrollHandler=function(){this.getDomRef("step-container").onscroll=this._scrollHandler.bind(this)},d.prototype._scrollHandler=function(t){if(!this._bScrollLocked){var e=t.target.scrollTop,i=this._getProgressNavigator(),r=this._aStepPath[i.getCurrentStep()-1],n=this._aStepPath[i.getCurrentStep()],s=r&&r.getDomRef();if(s){var o=s.clientHeight,a=s.offsetTop;e+100>=a+o&&i._isActiveStep(i._iCurrentStep+1)&&(i.nextStep(),this.fireNavigationChange({step:n}));for(var p=this.getSteps(),h=0;h<p.length;h++)if(e+100<=a){if(i.previousStep(),s=(r=this._aStepPath[i.getCurrentStep()-1])&&r.getDomRef(),this.fireNavigationChange({step:r}),!s)break;a=s.offsetTop}}}},d.prototype._getCurrentStepInstance=function(){return i.byId(this.getCurrentStep())},d.prototype._containsStep=function(t){return this.getSteps().some((function(e){return e===t}))},d.prototype._checkCircularReference=function(t){if(this._aStepPath.indexOf(t)>=0)throw new Error("The step that you are trying to activate has already been visited. You are creating a loop inside the wizard.")},d.prototype._activateStep=function(t){this._checkCircularReference(t),this._aStepPath.push(t),t._activate()},d.prototype._getNextButtonHeight=function(){return this._iNextButtonHeight},d.prototype._setNextButtonHeight=function(t){this._iNextButtonHeight=t},d}));