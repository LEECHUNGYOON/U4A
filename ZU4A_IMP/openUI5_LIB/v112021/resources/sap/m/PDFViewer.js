sap.ui.define(["./library","sap/ui/core/Control","sap/ui/Device","sap/m/PDFViewerRenderManager","sap/m/MessageBox","sap/m/PDFViewerRenderer","sap/base/Log","sap/base/assert","sap/ui/thirdparty/jquery","./PDFViewerRenderer","sap/ui/core/Lib","sap/m/IllustrationPool"],(function(e,t,o,i,r,n,s,a,jQuery,p,l,u){"use strict";var d=e.PDFViewerDisplayType,h=t.extend("sap.m.PDFViewer",{metadata:{library:"sap.m",properties:{height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},source:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},errorMessage:{type:"string",group:"Misc",defaultValue:null,deprecated:!0},errorPlaceholderMessage:{type:"string",group:"Misc",defaultValue:null},popupHeaderTitle:{type:"string",group:"Misc",defaultValue:null,deprecated:!0},title:{type:"string",group:"Misc",defaultValue:null},showDownloadButton:{type:"boolean",group:"Misc",defaultValue:!0},displayType:{type:"sap.m.PDFViewerDisplayType",group:"Misc",defaultValue:d.Auto},isTrustedSource:{type:"boolean",group:"Misc",defaultValue:!1}},aggregations:{errorPlaceholder:{type:"sap.ui.core.Control",multiple:!1},popupButtons:{type:"sap.m.Button",multiple:!0,singularName:"popupButton"},_illustratedMessage:{type:"sap.m.IllustratedMessage",multiple:!1,visibility:"hidden"},_nonTrustedIllustratedMessage:{type:"sap.m.IllustratedMessage",multiple:!1,visibility:"hidden"}},events:{loaded:{},error:{parameters:{target:{type:"any"}}},sourceValidationFailed:{}}},renderer:p});return h.prototype.init=function(){this._objectsRegister={},this._bIsPopupOpen=!1,this._isError=!1,this._initPopupControl(),this._initPopupDownloadButtonControl(),this._initErrorPlaceholderIllustratedMessageControl(),this._initToolbarDownloadButtonControl(),this._initOverflowToolbarControl(),this._initControlState();var e={setFamily:"tnt",setURI:sap.ui.require.toUrl("sap/tnt/themes/base/illustrations")};u.registerIllustrationSet(e,!1)},h.prototype._initControlState=function(){this._bRenderPdfContent=!0},h.prototype.setWidth=function(e){this.setProperty("width",e,!0);var t=this.$();return null===t||t.css("width",this._getRenderWidth()),this},h.prototype.setHeight=function(e){this.setProperty("height",e,!0);var t=this.$();return null===t||t.css("height",this._getRenderHeight()),this},h.prototype.onBeforeRendering=function(){try{this._getIframeDOMElement().remove()}catch(e){s.info(e)}},h.prototype.onAfterRendering=function(){var e=function(){var e=this._getIframeDOMElement();e.on("load",this._onLoadListener.bind(this)),e.on("error",this._onErrorListener.bind(this))}.bind(this);try{if(!this._bRenderPdfContent)return;this.setBusy(!0),e()}catch(e){s.warning("[U4A LOG 메시지]",e),this._isError&&(this._isError=!1,this._objectsRegister.getErrorPlaceholderIllustratedMessageControl().invalidate()),this.setBusy(!1)}},h.prototype._fireErrorEvent=function(e){this._renderErrorState(),this.fireError({target:e||null})},h.prototype._renderErrorState=function(){this._objectsRegister.getToolbarDownloadButtonControl().setEnabled(!1),this._objectsRegister.getPopupDownloadButtonControl().setEnabled(!1),this.setBusy(!1),this._bRenderPdfContent=!1,t.prototype.invalidate.call(this)},h.prototype._fireLoadedEvent=function(){this._bRenderPdfContent=!0,this.setBusy(!1);try{this._getIframeDOMElement().removeClass("sapMPDFViewerLoading")}catch(e){s.fatal("Iframe not founded in loaded event"),s.fatal(e)}this.fireEvent("loaded")},h.prototype._onLoadListener=function(e){try{var t=jQuery(e.target),i=!0,r="application/pdf";try{var a=t[0].contentWindow.document.embeds;(i=!!a&&1===a.length)&&(r=a[0].attributes.getNamedItem("type").value)}catch(e){if(!o.browser.firefox&&this.fireEvent("sourceValidationFailed",{},!0))return void this._fireLoadedEvent()}i&&n._isSupportedMimeType(r)&&n._isPdfPluginEnabled()?this._fireLoadedEvent():this._fireErrorEvent(e.target)}catch(e){s.fatal(!1,"Fatal error during the handling of load event happened."),s.fatal(!1,e.message)}},h.prototype._onErrorListener=function(){this._fireErrorEvent()},h.prototype.downloadPDF=function(){var e=window.open(this.getSource());e.opener=null,e.focus()},h.prototype._onSourceValidationErrorMessageBoxCloseListener=function(e){e===r.Action.CANCEL?this._renderErrorState():this._fireLoadedEvent()},h.prototype._onAfterPopupClose=function(e){this._objectsRegister.getPopup().removeAllContent(),this._bIsPopupOpen=!1},h.prototype._shouldRenderPdfContent=function(){return n._isPdfPluginEnabled()&&this._bRenderPdfContent&&this._isSourceValidToDisplay()},h.prototype._isSourceValidToDisplay=function(){var e=this.getSource();return null!==e&&""!==e&&void 0!==e},h.prototype.invalidate=function(e){this._initControlState(),t.prototype.invalidate.call(this,e)},h.prototype.open=function(){this._isSourceValidToDisplay()?(n._isPdfPluginEnabled()||s.warning("The PDF plug-in is not available on this device."),this._isEmbeddedModeAllowed()&&this.getIsTrustedSource()?this._openOnDesktop():this._openOnMobile()):a(!1,"The PDF file cannot be opened with the given source. Given source: "+this.getSource())},h.prototype._openOnDesktop=function(){var e=this._objectsRegister.getPopup();this._bIsPopupOpen||(this._initControlState(),this._preparePopup(e),e.addContent(this),this._bIsPopupOpen=!0,e.open())},h.prototype._openOnMobile=function(){var e=window.open(this.getSource());e.opener=null,e.focus()},h.prototype._getIframeDOMElement=function(){var e=this.$("iframe");if(0===e.length)throw Error("Underlying iframe was not found in DOM.");return e.length>1&&s.fatal("Initialization of iframe fails. Reason: the control somehow renders multiple iframes"),e},h.prototype._isEmbeddedModeAllowed=function(){return this._isDisplayTypeAuto()?o.system.desktop:this._isDisplayTypeEmbedded()},h.prototype._isDisplayTypeAuto=function(){return this.getDisplayType()===d.Auto},h.prototype._isDisplayTypeEmbedded=function(){return this.getDisplayType()===d.Embedded},h.prototype._isDisplayTypeLink=function(){return this.getDisplayType()===d.Link},h.prototype._isDisplayDownloadButton=function(){return this.getShowDownloadButton()||this._isDisplayTypeLink()||this._isDisplayTypeAuto()&&!this._isEmbeddedModeAllowed()},h.prototype._getLibraryResourceBundle=function(){return l.getResourceBundleFor("sap.m")},h.prototype._getIllustratedMessageErrorMessage=function(){return this.getErrorPlaceholderMessage()?this.getErrorPlaceholderMessage():this._getLibraryResourceBundle().getText("PDF_VIEWER_PLACEHOLDER_ERROR_TEXT")},h.prototype._getRenderWidth=function(){return this._bIsPopupOpen?"100%":this.getWidth()},h.prototype._getRenderHeight=function(){return this._bIsPopupOpen?"100%":this._isEmbeddedModeAllowed()?this.getHeight():"auto"},h.prototype._showMessageBox=function(){r.show(this._getLibraryResourceBundle().getText("PDF_VIEWER_SOURCE_VALIDATION_MESSAGE_TEXT"),{icon:r.Icon.WARNING,title:this._getLibraryResourceBundle().getText("PDF_VIEWER_SOURCE_VALIDATION_MESSAGE_HEADER"),actions:[r.Action.OK,r.Action.CANCEL],defaultAction:r.Action.CANCEL,id:this.getId()+"-validationErrorSourceMessageBox",styleClass:"sapUiSizeCompact",contentWidth:"100px",onClose:this._onSourceValidationErrorMessageBoxCloseListener.bind(this)})},h.prototype.exit=function(){jQuery.each(this._objectsRegister,(function(e,t){var o=t(!0);o&&o.destroy()}));try{this._getIframeDOMElement().off()}catch(e){s.info(e)}},i.extendPdfViewer(h),h}));