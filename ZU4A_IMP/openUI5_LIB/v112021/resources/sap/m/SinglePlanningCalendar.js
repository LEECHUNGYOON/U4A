sap.ui.define(["./library","./PlanningCalendarHeader","./SegmentedButtonItem","./SinglePlanningCalendarWeekView","./SinglePlanningCalendarGrid","./SinglePlanningCalendarMonthGrid","./SinglePlanningCalendarRenderer","sap/base/Log","sap/ui/core/Control","sap/ui/core/InvisibleText","sap/ui/core/ResizeHandler","sap/ui/core/format/DateFormat","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/DateRange","sap/ui/unified/DateTypeRange","sap/ui/unified/library","sap/ui/base/ManagedObjectObserver","sap/ui/core/date/UI5Date","sap/ui/thirdparty/jquery","sap/ui/core/date/CalendarWeekNumbering"],(function(e,t,i,a,r,n,s,o,g,l,d,p,h,c,u,_,y,f,jQuery,m){"use strict";var D=e.PlanningCalendarStickyMode,w=e.SinglePlanningCalendarSelectionMode,S="_sHeaderResizeHandlerId",C="--item",A=g.extend("sap.m.SinglePlanningCalendar",{metadata:{library:"sap.m",properties:{title:{type:"string",group:"Appearance",defaultValue:""},startDate:{type:"object",group:"Data"},startHour:{type:"int",group:"Data",defaultValue:0},endHour:{type:"int",group:"Data",defaultValue:24},fullDay:{type:"boolean",group:"Data",defaultValue:!0},stickyMode:{type:"sap.m.PlanningCalendarStickyMode",group:"Behavior",defaultValue:D.None},scaleFactor:{type:"float",group:"Data",defaultValue:1},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:!1},enableAppointmentsResize:{type:"boolean",group:"Misc",defaultValue:!1},enableAppointmentsCreate:{type:"boolean",group:"Misc",defaultValue:!1},firstDayOfWeek:{type:"int",group:"Appearance",defaultValue:-1},calendarWeekNumbering:{type:"sap.ui.core.date.CalendarWeekNumbering",group:"Appearance",defaultValue:null},dateSelectionMode:{type:"sap.m.SinglePlanningCalendarSelectionMode",group:"Behavior",defaultValue:w.SingleSelect}},aggregations:{actions:{type:"sap.ui.core.Control",multiple:!0,singularName:"action",forwarding:{getter:"_getHeader",aggregation:"actions"}},appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:!0,singularName:"appointment",forwarding:{getter:"_getCurrentGrid",aggregation:"appointments"}},views:{type:"sap.m.SinglePlanningCalendarView",multiple:!0,singularName:"view"},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:!0,singularName:"specialDate",forwarding:{getter:"_getCurrentGrid",aggregation:"specialDates"}},_header:{type:"sap.m.PlanningCalendarHeader",multiple:!1,visibility:"hidden"},_grid:{type:"sap.ui.core.Control",multiple:!1,visibility:"hidden"},_mvgrid:{type:"sap.ui.core.Control",multiple:!1,visibility:"hidden"},selectedDates:{type:"sap.ui.unified.DateRange",multiple:!0,singularName:"selectedDate",forwarding:{getter:"_getCurrentGrid",aggregation:"selectedDates"}}},associations:{selectedView:{type:"sap.m.SinglePlanningCalendarView",multiple:!1},legend:{type:"sap.m.PlanningCalendarLegend",multiple:!1}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentResize:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"}}},appointmentCreate:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},headerDateSelect:{parameters:{date:{type:"object"}}},startDateChange:{parameters:{date:{type:"object"}}},cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},moreLinkPress:{parameters:{date:{type:"object"}}},viewChange:{}}},renderer:s});return A.prototype.init=function(){var e=this.getId();this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.m"),this._oDefaultView=new a({key:"DEFAULT_INNER_WEEK_VIEW_CREATED_FROM_CONTROL",title:""}),this.setAssociation("selectedView",this._oDefaultView),this.setAggregation("_header",this._createHeader()),this.setAggregation("_grid",new r(e+"-Grid")),this.setAggregation("_mvgrid",new n(e+"-GridMV")),this._attachHeaderEvents(),this._attachGridEvents(),this._attachDelegates(),this.setStartDate(f.getInstance())},A.prototype.onBeforeRendering=function(){this._toggleStickyClasses(),-1!==this.getFirstDayOfWeek()&&this.getCalendarWeekNumbering()&&o.warning("Both properties firstDayOfWeek and calendarWeekNumbering should not be used at the same time!")},A.prototype.onAfterRendering=function(){var e=this._getHeader();this._adjustColumnHeadersTopOffset(),this.toggleStyleClass("sapMSinglePCActionsHidden",!e._getActionsToolbar().getVisible()),this._registerResizeHandler(S,e,this._onHeaderResize.bind(this))},A.prototype.exit=function(){this._oDefaultView&&(this._oDefaultView.destroy(),this._oDefaultView=null),this._afterRenderFocusCell&&(this.removeDelegate(this._afterRenderFocusCell),this._afterRenderFocusCell=null),this._deRegisterResizeHandler(S)},A.prototype._onHeaderResize=function(e){return e.oldSize.height===e.size.height||(this.toggleStyleClass("sapMSinglePCActionsHidden",!this._getHeader()._getActionsToolbar().getVisible()),this._adjustColumnHeadersTopOffset()),this},A.prototype.setTitle=function(e){return this._getHeader().setTitle(e),this.setProperty("title",e)},A.prototype.setScaleFactor=function(e){if(!(e<1||e>6))return this.setProperty("scaleFactor",parseInt(e)),this.getAggregation("_grid").setProperty("scaleFactor",parseInt(e)),this},A.prototype.setStartDate=function(e){return this.setProperty("startDate",e),this._alignColumns(),this},A.prototype.setStartHour=function(e){return this.getAggregation("_grid").setStartHour(e),this.setProperty("startHour",e),this},A.prototype.setEndHour=function(e){return this.getAggregation("_grid").setEndHour(e),this.setProperty("endHour",e),this},A.prototype.setFullDay=function(e){return this.getAggregation("_grid").setFullDay(e),this.setProperty("fullDay",e),this},A.prototype.setEnableAppointmentsDragAndDrop=function(e){return this.getAggregation("_grid").setEnableAppointmentsDragAndDrop(e),this.getAggregation("_mvgrid").setEnableAppointmentsDragAndDrop(e),this.setProperty("enableAppointmentsDragAndDrop",e,!0)},A.prototype.setEnableAppointmentsResize=function(e){return this.getAggregation("_grid").setEnableAppointmentsResize(e),this.setProperty("enableAppointmentsResize",e,!0)},A.prototype.setEnableAppointmentsCreate=function(e){return this.getAggregation("_grid").setEnableAppointmentsCreate(e),this.setProperty("enableAppointmentsCreate",e,!0)},A.prototype.setDateSelectionMode=function(e){return this.getAggregation("_mvgrid").setDateSelectionMode(e),this.getAggregation("_grid").setDateSelectionMode(e),this.setProperty("dateSelectionMode",e)},A.prototype._toggleStickyClasses=function(){var e=this.getStickyMode();return this.toggleStyleClass("sapMSinglePCStickyAll",e===D.All),this.toggleStyleClass("sapMSinglePCStickyNavBarAndColHeaders",e===D.NavBarAndColHeaders),this},A.prototype.removeAllSelectedDates=function(){return this._getCurrentGrid().removeAllSelectedDates()},A.prototype.getSelectedDates=function(){return this._getCurrentGrid().getAggregation("selectedDates")},A.prototype.addSelectedDate=function(e){return this._getCurrentGrid().addAggregation("selectedDates",e),this},A.prototype._adjustColumnHeadersTopOffset=function(){var e,t=this.getStickyMode(),i=this.getAggregation("_grid"),a=i&&i._getColumnHeaders();if(!a||!a.getDomRef())return this;switch(t){case D.All:e=this._getHeader().$().outerHeight();break;case D.NavBarAndColHeaders:e=this._getHeader()._getNavigationToolbar().$().outerHeight();break;default:e="auto"}return a.$().css("top",e),a._setTopPosition(e),this},A.prototype.addView=function(e){var t,a,r=this._getHeader(),n=e.getId()+C;return e?this._isViewKeyExisting(e.getKey())?(o.error("There is an existing view with the same key.",this),this):(this.addAggregation("views",e),t=r._getOrCreateViewSwitch(),a=new i(n,{key:e.getKey(),text:e.getTitle()}),t.addItem(a),this._observeViewTitle(e),this._getSelectedView().getKey()===this._oDefaultView.getKey()&&this.setAssociation("selectedView",e),this._alignView(),this.getViews().length>4&&r._convertViewSwitchToSelect(),this):this},A.prototype.insertView=function(e,t){var a,r,n=this._getHeader(),s=e.getId()+C;return e?this._isViewKeyExisting(e.getKey())?(o.error("There is an existing view with the same key.",this),this):(this.insertAggregation("views",e,t),a=n._getOrCreateViewSwitch(),r=new i(s,{key:e.getKey(),text:e.getTitle()}),a.insertItem(r,t),this._observeViewTitle(e),this._getSelectedView().getKey()===this._oDefaultView.getKey()&&this.setAssociation("selectedView",e),this._alignView(),this.getViews().length>4&&n._convertViewSwitchToSelect(),this):this},A.prototype.removeView=function(e){if(!e)return this;if("function"!=typeof e?.isA)return this;var t,i,a=this._getHeader(),r=a._getOrCreateViewSwitch(),n=r.getItems(),s=this._getSelectedView(),o=e.getKey();for(1===this.getViews().length?this._disconnectAndDestroyViewsObserver():this._oViewsObserver.unobserve(e,{properties:["title"]}),i=0;i<n.length;i++)if((t=n[i]).getKey()===o){r.removeItem(t);break}return this.removeAggregation("views",e),o===s.getKey()&&this.setAssociation("selectedView",this.getViews()[0]||this._oDefaultView),this._alignView(),this.getViews().length<=4&&a._convertViewSwitchToSegmentedButton(),this},A.prototype.removeAllViews=function(){var e=this._getHeader()._getOrCreateViewSwitch();return this._disconnectAndDestroyViewsObserver(),e.removeAllItems(),this.setAssociation("selectedView",this._oDefaultView),this._alignView(),this.removeAllAggregation("views")},A.prototype.destroyViews=function(){var e=this._getHeader()._getOrCreateViewSwitch();return this._disconnectAndDestroyViewsObserver(),e.destroyItems(),this.setAssociation("selectedView",this._oDefaultView),this._alignView(),this.destroyAggregation("views")},A.prototype._viewsObserverCallbackFunction=function(e){sap.ui.getCore().byId(e.object.getId()+C).setText(e.current)},A.prototype._getViewsObserver=function(){return this._oViewsObserver||(this._oViewsObserver=new y(this._viewsObserverCallbackFunction)),this._oViewsObserver},A.prototype._observeViewTitle=function(e){this._getViewsObserver().observe(e,{properties:["title"]})},A.prototype._disconnectAndDestroyViewsObserver=function(){this._oViewsObserver&&(this._oViewsObserver.disconnect(),this._oViewsObserver.destroy(),this._oViewsObserver=null)},A.prototype.setSelectedView=function(e){return"string"==typeof e?e=this._getViewById(e):e.isA("sap.m.SinglePlanningCalendarView")&&!this._isViewKeyExisting(e.getKey())&&(e=null),e?(this._setupNewView(e),this._getHeader()._getOrCreateViewSwitch().setSelectedKey(e.getKey()),this):(o.error("There is no such view.",this),this)},A.prototype.getSelectedAppointments=function(){return this.getAggregation("_grid").getSelectedAppointments()},A.prototype.setLegend=function(e){var t,i;return this.setAssociation("legend",e),this.getAggregation("_grid").setAssociation("legend",e),this.getAggregation("_mvgrid").setAssociation("legend",e),(t=this.getLegend())&&(this.getAggregation("_grid")._sLegendId=t,this.getAggregation("_mvgrid")._sLegendId=t,i=sap.ui.getCore().byId(t)),i&&new y(function(e){this.invalidate()}.bind(this)).observe(i,{destroy:!0}),this},A.prototype.setFirstDayOfWeek=function(e){if(!(e<-1||e>6)){this.setProperty("firstDayOfWeek",e),this.getViews().forEach((function(t){t.setFirstDayOfWeek(e)}));var t=this._getHeader(),i=t.getAggregation("_calendarPicker")?t.getAggregation("_calendarPicker"):t._oPopup.getContent()[0],a=this._getSelectedView(),r=this.getStartDate()||f.getInstance(),n=a.calculateStartDate(f.getInstance(r.getTime())),s=this.getAggregation("_mvgrid");return this.setStartDate(n),s.setFirstDayOfWeek(e),i.setFirstDayOfWeek(e),this}o.error(e+" is not a valid value to the property firstDayOfWeek. Valid values are from -1 to 6.")},A.prototype.setCalendarWeekNumbering=function(e){this.setProperty("calendarWeekNumbering",e),this.getViews().forEach((function(t){t.setCalendarWeekNumbering(e)}));var t=this._getHeader(),i=t.getAggregation("_calendarPicker")?t.getAggregation("_calendarPicker"):t._oPopup.getContent()[0];return this.getAggregation("_mvgrid").setCalendarWeekNumbering(this.getCalendarWeekNumbering()),i.setCalendarWeekNumbering(this.getCalendarWeekNumbering()),this._alignColumns(),this},A.prototype._alignView=function(){return this._switchViewButtonVisibility(),this._alignColumns(),this},A.prototype._createHeader=function(){var e=new t(this.getId()+"-Header");return e.getAggregation("_actionsToolbar").addAriaLabelledBy(l.getStaticId("sap.m","SPC_ACTIONS_TOOLBAR")),e.getAggregation("_navigationToolbar").addAriaLabelledBy(l.getStaticId("sap.m","SPC_NAVIGATION_TOOLBAR")),e},A.prototype._isViewKeyExisting=function(e){return this.getViews().some((function(t){return t.getKey()===e}))},A.prototype.getViewByKey=function(e){var t,i=this.getViews();for(t=0;t<i.length;t++)if(i[t].getKey()===e)return i[t];return null},A.prototype._getViewById=function(e){var t,i=this.getViews();for(t=0;t<i.length;t++)if(i[t].getId()===e)return i[t];return null},A.prototype._getSelectedView=function(){var e,t,i=this.getViews(),a=sap.ui.getCore().byId(this.getAssociation("selectedView"));if(null==a)return this._oDefaultView;t=a.getKey();for(var r=0;r<i.length;r++)if(t===i[r].getKey()){e=i[r];break}return e||this._oDefaultView},A.prototype._switchViewButtonVisibility=function(){var e=this._getHeader()._getOrCreateViewSwitch(),t=e.getItems().length>1;return e.setProperty("visible",t),this},A.prototype._attachHeaderEvents=function(){var e=this._getHeader();return e.attachEvent("viewChange",this._handleViewChange,this),e.attachEvent("pressPrevious",this._handlePressArrow,this),e.attachEvent("pressToday",this._handlePressToday,this),e.attachEvent("pressNext",this._handlePressArrow,this),e.attachEvent("dateSelect",this._handleCalendarPickerDateSelect,this),this},A.prototype._attachDelegates=function(){this._afterRenderFocusCell={onAfterRendering:function(){this._sGridCellFocusSelector&&(jQuery(this._sGridCellFocusSelector).trigger("focus"),this._sGridCellFocusSelector=null)}.bind(this)},this.getAggregation("_grid").addDelegate(this._afterRenderFocusCell),this.getAggregation("_mvgrid").addDelegate(this._afterRenderFocusCell)},A.prototype._attachGridEvents=function(){var e=this.getAggregation("_grid"),t=this.getAggregation("_mvgrid"),i=function(e){this.fireAppointmentSelect({appointment:e.getParameter("appointment"),appointments:e.getParameter("appointments")})},a=function(e){this.fireAppointmentDrop({appointment:e.getParameter("appointment"),startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate"),copy:e.getParameter("copy")})},r=function(e){this.fireEvent("cellPress",{startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate")})};return e._getColumnHeaders().attachEvent("select",(function(e){this.fireHeaderDateSelect({date:e.getSource()._oDate.toLocalJSDate()})}),this),e.attachEvent("appointmentSelect",i,this),t.attachEvent("appointmentSelect",i,this),e.attachEvent("appointmentDrop",a,this),t.attachEvent("appointmentDrop",a,this),e.attachEvent("appointmentResize",(function(e){this.fireAppointmentResize({appointment:e.getParameter("appointment"),startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate")})}),this),e.attachEvent("appointmentCreate",(function(e){this.fireAppointmentCreate({startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate")})}),this),e.attachEvent("cellPress",r,this),t.attachEvent("cellPress",r,this),t.attachEvent("moreLinkPress",(function(e){this.fireEvent("moreLinkPress",{date:e.getParameter("date")})}),this),e.attachEvent("borderReached",(function(e){var t=this.getAggregation("_grid"),i=t._getDateFormatter(),a=this._getSelectedView().getScrollEntityCount()-t._getColumns()+1,r=f.getInstance(e.getParameter("startDate")),n=e.getParameter("fullDay"),s=this.getStartDate();e.getParameter("next")?(r.setDate(r.getDate()+a),s=f.getInstance(s.setDate(s.getDate()+this._getSelectedView().getScrollEntityCount())),this.setStartDate(s)):(r.setDate(r.getDate()-a),s=f.getInstance(s.setDate(s.getDate()-this._getSelectedView().getScrollEntityCount())),this.setStartDate(s)),this._sGridCellFocusSelector=n?"[data-sap-start-date='"+i.format(r)+"'].sapMSinglePCBlockersColumn":"[data-sap-start-date='"+i.format(r)+"'].sapMSinglePCRow"}),this),t.attachEvent("borderReached",(function(e){var t,i=f.getInstance(e.getParameter("startDate")),a=h.fromLocalJSDate(i);a.setDate(a.getDate()+e.getParameter("offset")),t=a.toLocalJSDate(),this.setStartDate(t),this._sGridCellFocusSelector="[sap-ui-date='"+a.valueOf()+"'].sapMSPCMonthDay"}),this),this},A.prototype._handleViewChange=function(e){var t=e.getParameter("item").getProperty("key"),i=this.getViewByKey(t);this._setupNewView(i),this.fireViewChange()},A.prototype._handlePressArrow=function(e){this._applyArrowsLogic("pressPrevious"===e.getId()),this._adjustColumnHeadersTopOffset()},A.prototype._handlePressToday=function(){var e=this._getSelectedView().calculateStartDate(f.getInstance());this.setStartDate(e),this.fireStartDateChange({date:e}),this._adjustColumnHeadersTopOffset()},A.prototype._setupNewView=function(e){var t=this._getCurrentGrid();this.setAssociation("selectedView",e),this._transferAggregations(t),this._alignColumns(),this._adjustColumnHeadersTopOffset()},A.prototype._transferAggregations=function(e){var t,i,a,r,n=this._getCurrentGrid();if(e.getId()!==n.getId()){for(t=e.removeAllAggregation("appointments",!0),r=0;r<t.length;r++)n.addAggregation("appointments",t[r],!0);for(i=e.removeAllAggregation("specialDates",!0),r=0;r<i.length;r++)n.addAggregation("specialDates",i[r],!0);for(a=e.removeAllAggregation("selectedDates",!0),r=0;r<a.length;r++)n.addAggregation("selectedDates",a[r],!0)}},A.prototype._handleCalendarPickerDateSelect=function(){var e,t=this._getHeader().getStartDate();e=this._getSelectedView().calculateStartDate(f.getInstance(t.getTime())),this.setStartDate(e),this._getSelectedView().isA("sap.m.SinglePlanningCalendarMonthView")||this.getAggregation("_grid")._getColumnHeaders().setDate(t),this.fireStartDateChange({date:e}),this._adjustColumnHeadersTopOffset()},A.prototype._updateCalendarPickerSelection=function(){var e,t=this._getFirstAndLastRangeDate(),i=this._getHeader(),a=i.getAggregation("_calendarPicker")?i.getAggregation("_calendarPicker"):i._oPopup.getContent()[0];e=new c({startDate:t.oStartDate.toLocalJSDate(),endDate:t.oEndDate.toLocalJSDate()}),a.destroySelectedDates(),a.addSelectedDate(e)},A.prototype._formatPickerText=function(){var e,t,i=this._getFirstAndLastRangeDate(),a=i.oStartDate.toLocalJSDate(),r=i.oEndDate.toLocalJSDate();return this._getSelectedView().isA("sap.m.SinglePlanningCalendarMonthView")?t=(e=p.getDateInstance({format:"yMMMM"})).format(a):(t=(e=p.getDateInstance({format:"yMMMMd"})).format(a),a.getTime()!==r.getTime()&&(t+=" - "+e.format(r))),t},A.prototype._applyArrowsLogic=function(e){var t,i=h.fromLocalJSDate(this.getStartDate()||f.getInstance()),a=e?-1:1,r=this._getSelectedView().getScrollEntityCount(this.getStartDate(),a);e&&(r*=-1),i.setDate(i.getDate()+r),t=i.toLocalJSDate(),this.setStartDate(t),this.fireStartDateChange({date:t})},A.prototype._getFirstAndLastRangeDate=function(){var e,t,i=this._getSelectedView(),a=this._getHeader().getStartDate()||f.getInstance(),r=i.getEntityCount()-1;return e=h.fromLocalJSDate(i.calculateStartDate(f.getInstance(a.getTime()))),(t=new h(e)).setDate(e.getDate()+r),{oStartDate:e,oEndDate:t}},A.prototype._alignColumns=function(){var e=this._getHeader(),t=this.getAggregation("_grid"),i=this.getAggregation("_mvgrid"),a=this._getSelectedView(),r=this.getStartDate()||f.getInstance(),n=a.calculateStartDate(f.getInstance(r.getTime())),s=h.fromLocalJSDate(n);e.setStartDate(n),e.setPickerText(this._formatPickerText(s)),this._updateCalendarPickerSelection(),t.setStartDate(n),i.setStartDate(n),t._setColumns(a.getEntityCount()),this._setColumnHeaderVisibility()},A.prototype._setColumnHeaderVisibility=function(){var e;this._getSelectedView().isA("sap.m.SinglePlanningCalendarMonthView")||(e=!this._getSelectedView().isA("sap.m.SinglePlanningCalendarDayView"),this.getAggregation("_grid")._getColumnHeaders().setVisible(e),this.toggleStyleClass("sapMSinglePCHiddenColHeaders",!e))},A.prototype._getHeader=function(){return this.getAggregation("_header")},A.prototype._getCurrentGrid=function(){return this._getSelectedView().isA("sap.m.SinglePlanningCalendarMonthView")?this.getAggregation("_mvgrid"):this.getAggregation("_grid")},A.prototype._registerResizeHandler=function(e,t,i){return this[e]||(this[e]=d.register(t,i)),this},A.prototype._deRegisterResizeHandler=function(e){return this[e]&&(d.deregister(this[e]),this[e]=null),this},A.prototype._getSpecialDates=function(){for(var e=this.getSpecialDates(),t=0;t<e.length;t++){if(e[t].getSecondaryType()===_.CalendarDayType.NonWorking&&e[t].getType()!==_.CalendarDayType.NonWorking){var i=new u;i.setType(_.CalendarDayType.NonWorking),i.setStartDate(e[t].getStartDate()),e[t].getEndDate()&&i.setEndDate(e[t].getEndDate()),e.push(i)}}return e},A}));