sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/EnabledPropagator","sap/ui/core/IconPool","./delegate/ValueStateMessage","sap/ui/core/message/MessageMixin","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/Device","./InputBaseRenderer","sap/base/Log","sap/ui/events/KeyCodes","sap/ui/thirdparty/jquery","sap/ui/core/Lib","sap/ui/dom/jquery/cursorPos","sap/ui/dom/jquery/getSelectedText","sap/ui/dom/jquery/selectText"],(function(e,t,a,s,n,o,i,r,u,l,p,c,jQuery,h){"use strict";var g=r.TextDirection,d=r.TextAlign,f=r.ValueState,y=t.extend("sap.m.InputBase",{metadata:{interfaces:["sap.ui.core.IFormContent"],library:"sap.m",properties:{value:{type:"string",group:"Data",defaultValue:null,bindable:"bindable"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},enabled:{type:"boolean",group:"Behavior",defaultValue:!0},valueState:{type:"sap.ui.core.ValueState",group:"Appearance",defaultValue:f.None},name:{type:"string",group:"Misc",defaultValue:null},placeholder:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Behavior",defaultValue:!0},valueStateText:{type:"string",group:"Misc",defaultValue:null},showValueStateMessage:{type:"boolean",group:"Misc",defaultValue:!0},textAlign:{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:d.Initial},textDirection:{type:"sap.ui.core.TextDirection",group:"Appearance",defaultValue:g.Inherit},required:{type:"boolean",group:"Misc",defaultValue:!1}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaLabelledBy"},ariaDescribedBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaDescribedBy"}},events:{change:{parameters:{value:{type:"string"}}}},aggregations:{formattedValueStateText:{type:"sap.m.FormattedText",multiple:!1},_invisibleFormattedValueStateText:{type:"sap.m.FormattedText",multiple:!1,visibility:"hidden"},_endIcon:{type:"sap.ui.core.Icon",multiple:!0,visibility:"hidden"},_beginIcon:{type:"sap.ui.core.Icon",multiple:!0,visibility:"hidden"}},designtime:"sap/m/designtime/InputBase.designtime"},renderer:l});return a.call(y.prototype),s.insertFontFaceStyle(),o.call(y.prototype),y.ICON_PRESSED_CSS_CLASS="sapMInputBaseIconPressed",y.ICON_CSS_CLASS="sapMInputBaseIcon",y.prototype.bShowLabelAsPlaceholder=!u.support.input.placeholder,y.prototype._getPlaceholder=function(){return this.getPlaceholder()||""},y.prototype._getInputValue=function(e){return void 0===e?this.$("inner").val()||"":e.toString()},y.prototype._getInputElementTagName=function(){return this._sInputTagElementName||(this._sInputTagElementName=this._$input&&this._$input.get(0)&&this._$input.get(0).tagName),this._sInputTagElementName},y.prototype.init=function(){this.setLastValue(""),this.bRenderingPhase=!1,this._oValueStateMessage=new n(this),this._bIsComposingCharacter=!1,this.setLastValueStateText(""),this.setErrorMessageAnnouncementState(!1),this.fnCloseValueStateOnClick=function(){this.closeValueStateMessage()}},y.prototype.oncompositionstart=function(){this._bIsComposingCharacter=!0},y.prototype.oncompositionend=function(e){this._bIsComposingCharacter=!1,u.browser.firefox||(this._bCheckDomValue=!0)},y.prototype.isComposingCharacter=function(){return this._bIsComposingCharacter},y.prototype.onBeforeRendering=function(){var e,t=this.getFocusDomRef(),a=this.getFormattedValueStateText();if(this._oInvisibleMessage||(this._oInvisibleMessage=i.getInstance()),this._bCheckDomValue&&!this.bRenderingPhase&&(this.isActive()?this._sDomValue=this._getInputValue():this._bCheckDomValue=!1),a){var s=this.getAggregation("_invisibleFormattedValueStateText");e=a.getHtmlText()!==(s&&s.getHtmlText())}else e=!1;if(this.getValueState()===f.Error&&t){var n=e||this.getValueStateText()!==this.getLastValueStateText();this.setErrorMessageAnnouncementState(!t.hasAttribute("aria-invalid")||n)}e&&(s&&s.destroy(),this.setAggregation("_invisibleFormattedValueStateText",a.clone())),this.bRenderingPhase=!0},y.prototype.onAfterRendering=function(){var e=this.getValueState(),t=this.getFocusDomRef()===document.activeElement,a=e===f.None,s=document.getElementById(this.getValueStateMessageId()+"-sr");if(this._bCheckDomValue&&this._sDomValue!==this._getInputValue()&&this.$("inner").val(this._sDomValue),this.getErrorMessageAnnouncementState()&&this.hasStyleClass("sapMFocus")&&(s&&this._oInvisibleMessage.announce(s.textContent),this.setErrorMessageAnnouncementState(!1)),this.$("message").text(this.getValueStateText()),this._bCheckDomValue=!1,this.bRenderingPhase=!1,t&&this[a?"closeValueStateMessage":"openValueStateMessage"](),this.getAggregation("_invisibleFormattedValueStateText")&&this.getAggregation("_invisibleFormattedValueStateText").getControls().forEach((function(e){e.getDomRef()&&e.getDomRef().setAttribute("tabindex",-1)})),this.setLastValueStateText(this.getValueStateText()),this.getType&&"Number"===this.getType()){var n=this.getDomRef("inner");n&&(n.setAttribute("type","text"),n.setAttribute("inputmode","decimal"))}},y.prototype.exit=function(){this._oValueStateMessage&&this._oValueStateMessage.destroy(),this._oInvisibleMessage&&(this._oInvisibleMessage.destroy(),this._oInvisibleMessage=null),this._oValueStateMessage=null},y.prototype.ontouchstart=function(e){e.setMarked()},y.prototype.onfocusin=function(e){this.addStyleClass("sapMFocus"),this.openValueStateMessage()},y.prototype.onfocusout=function(e){this.removeStyleClass("sapMFocus"),this._bClickOnValueStateLink(e)||this.closeValueStateMessage()},y.prototype.onsapfocusleave=function(e){this.preventChangeOnFocusLeave(e)||this.onChange(e)},y.prototype.preventChangeOnFocusLeave=function(e){return this.bFocusoutDueRendering},y.prototype.getChangeEventParams=function(){return{}},y.prototype.ontap=function(e){},y.prototype.onChange=function(e,t,a){if(t=t||this.getChangeEventParams(),!this.getDomRef()||this.getEditable()&&this.getEnabled()){var s=this._getInputValue(a);if(s!==this.getLastValue())return this.setValue(s),s=this.getValue(),this.setLastValue(s),this.fireChangeEvent(s,t),!0;this._bCheckDomValue=!1}},y.prototype.fireChangeEvent=function(e,t){var a=jQuery.extend({value:e,newValue:e},t);this.fireChange(a)},y.prototype.onValueRevertedByEscape=function(e,t){this.fireEvent("liveChange",{value:e,escPressed:!0,previousValue:t,newValue:e})},y.prototype.onsapenter=function(e){u.browser.safari&&this.isComposingCharacter()?e.setMarked("invalid"):this.onChange(e)},y.prototype.onsapescape=function(e){var t=this._getInputValue();t!==this.getLastValue()&&(e.setMarked(),e.preventDefault(),this.updateDomValue(this.getLastValue()),this.onValueRevertedByEscape(this.getLastValue(),t))},y.prototype.oninput=function(e){this._bCheckDomValue=!0},y.prototype.onkeydown=function(e){this.getDomRef("inner")&&this.getDomRef("inner").getAttribute("readonly")&&e.keyCode==c.BACKSPACE&&e.preventDefault()},y.prototype.oncut=function(e){},y.prototype.selectText=function(e,t){return this.$("inner").selectText(e,t),this},y.prototype.getSelectedText=function(){return this.$("inner").getSelectedText()},y.prototype.setProperty=function(e,a,s){return"value"==e&&(this._bCheckDomValue=!1),t.prototype.setProperty.apply(this,arguments)},y.prototype.getFocusInfo=function(){var e=t.prototype.getFocusInfo.call(this),a=this.getFocusDomRef();if(jQuery.extend(e,{cursorPos:0,selectionStart:0,selectionEnd:0}),a){e.cursorPos=jQuery(a).cursorPos();try{e.selectionStart=a.selectionStart,e.selectionEnd=a.selectionEnd}catch(e){}}return e},y.prototype.applyFocusInfo=function(e){return t.prototype.applyFocusInfo.call(this,e),this.$("inner").cursorPos(e.cursorPos),this.selectText(e.selectionStart,e.selectionEnd),this},y.prototype.updateDomValue=function(e){var t=this.getFocusDomRef();return this.isActive()?(e=this._getInputValue(e),this._getInputValue()===e||(this._bCheckDomValue=!0,this._bPreferUserInteraction?this.handleInputValueConcurrency(e):t.value=e),this):this},y.prototype._aValueStateLinks=function(){return this.getFormattedValueStateText()&&this.getFormattedValueStateText().getHtmlText()&&this.getFormattedValueStateText().getControls().length?this.getFormattedValueStateText().getControls():[]},y.prototype._bClickOnValueStateLink=function(e){return this._aValueStateLinks().some((function(t){return e.relatedTarget===t.getDomRef()}))},y.prototype._attachValueStateLinkPress=function(){this._aValueStateLinks().forEach((function(e){e.attachPress(this.fnCloseValueStateOnClick,this)}),this)},y.prototype._detachValueStateLinkPress=function(){this._aValueStateLinks().forEach((function(e){e.detachPress(this.fnCloseValueStateOnClick,this)}),this)},y.prototype.handleInputValueConcurrency=function(e){var t=this.getFocusDomRef(),a=t&&this._getInputValue(),s=this.getProperty("value"),n=document.activeElement===t,o=this.isBound("value")&&this.getBindingInfo("value").skipModelUpdate;if(n&&o&&a&&s!==a)return this;t.value=e,n&&o&&!a&&t.select()},y.prototype._setPreferUserInteraction=function(e){this._bPreferUserInteraction=e},y.prototype.closeValueStateMessage=function(){setTimeout(function(){this._oValueStateMessage&&(this._detachValueStateLinkPress(),this._oValueStateMessage.close())}.bind(this),0)},y.prototype.getDomRefForValueStateMessage=function(){return this.getDomRef("content")},y.prototype.getPopupAnchorDomRef=function(){return this.getDomRef()},y.prototype.iOpenMessagePopupDuration=0,y.prototype.getValueStateMessageId=function(){return this.getId()+"-message"},y.prototype.getErrorMessageAnnouncementState=function(){return this._bErrorStateShouldBeAnnounced},y.prototype.setErrorMessageAnnouncementState=function(e){this._bErrorStateShouldBeAnnounced=e},y.prototype.setLastValueStateText=function(e){this._sLastValueStateText=e},y.prototype.getLastValueStateText=function(){return this._sLastValueStateText},y.prototype.getLabels=function(){var e=this.getAriaLabelledBy().map((function(e){return sap.ui.getCore().byId(e)})),t=sap.ui.require("sap/ui/core/LabelEnablement");return t&&(e=e.concat(t.getReferencingLabels(this).map((function(e){return sap.ui.getCore().byId(e)})))),e},y.prototype.openValueStateMessage=function(){this._oValueStateMessage&&this.shouldValueStateMessageBeOpened()&&setTimeout(function(){this.bIsDestroyed||(this._detachValueStateLinkPress(),this._attachValueStateLinkPress(),this._oValueStateMessage.open())}.bind(this),0)},y.prototype.shouldValueStateMessageBeOpened=function(){return this.getValueState()!==f.None&&this.getEditable()&&this.getEnabled()&&this.getShowValueStateMessage()},y.prototype._calculateIconsSpace=function(){var e,t=this.getAggregation("_endIcon")||[],a=this.getAggregation("_beginIcon")||[];return t.concat(a).reduce((function(t,a){return e=a&&a.getDomRef()?parseFloat(getComputedStyle(a.getDomRef()).marginRight):0,t+(a&&a.getDomRef()?a.getDomRef().offsetWidth:0)+e}),0)},y.prototype.setValue=function(e){return e=this.validateProperty("value",e),e=this._getInputValue(e),this.updateDomValue(e),e!==this.getProperty("value")&&this.setLastValue(e),this.setProperty("value",e,!0),this},y.prototype.getFocusDomRef=function(){return this.getDomRef("inner")},y.prototype.getIdForLabel=function(){return this.getId()+"-inner"},y.prototype.getAccessibilityInfo=function(){var e=h.getResourceBundleFor("sap.m"),t=this.getRequired()?e.getText("ELEMENT_REQUIRED"):"",a=this.getRenderer();return{role:a.getAriaRole(this),type:e.getText("ACC_CTR_TYPE_INPUT"),description:[this.getValueDescriptionInfo(),a.getLabelledByAnnouncement(this),a.getDescribedByAnnouncement(this),t].join(" ").trim(),focusable:this.getEnabled(),enabled:this.getEnabled(),editable:this.getEnabled()&&this.getEditable()}},y.prototype.getValueDescriptionInfo=function(){return this.getValue()||h.getResourceBundleFor("sap.m").getText("INPUTBASE_VALUE_EMPTY")},y.prototype._addIcon=function(e,t,a){if(-1===["begin","end"].indexOf(e))return p.error('icon position is not "begin", neither "end", please check again the passed setting'),null;var n=s.createControlByURI(t).addStyleClass(y.ICON_CSS_CLASS);return void 0!==a?this.insertAggregation("_"+e+"Icon",n,a):this.addAggregation("_"+e+"Icon",n),n},y.prototype.addBeginIcon=function(e){return this._addIcon("begin",e)},y.prototype.addEndIcon=function(e,t){return this._addIcon("end",e,t)},Object.defineProperty(y.prototype,"_$input",{get:function(){return this.$("inner")}}),y.prototype.setLastValue=function(e){return this._lastValue=e,this},y.prototype.getLastValue=function(){return this._lastValue},y}));