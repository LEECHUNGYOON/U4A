// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell_abap/bootstrap/evo/abap.xhrlogon.LibLoader","./abap.bootstrap.utils","./abap.request.startup","./abap.request.pageset","./abap.xhrlogon.handler","./abap.theme.handler","sap/ushell/EventHub","sap/ui/performance/trace/initTraces","sap/base/util/ObjectPath","sap/base/Log","sap/ushell_abap/pbServices/ui2/Utils","./SAPCompanionConditionSetter"],function(e,a,t,r,i,n,s,o,l,c,u,p){"use strict";var g={};var f=new RegExp("^(#)?([A-Za-z0-9_]+)-([A-Za-z0-9_]+)"),h,m;function d(e){function a(e){if(!e){return false}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0||e.indexOf("Action-search")===0}function t(){return window["sap-ushell_abap-bootstrap-abap-noInitialTarget"]!==undefined}var r=e.match(f);var i=r&&r[2];var n=r&&r[3];var s=e&&!a(e)&&!t()&&i&&n;return s}function v(){var e,t=a.getLocationHref(),r=t.indexOf("#");if(r<0){return""}e=decodeURI(t.slice(r+1));return e}function b(){var e=v(),a=e.indexOf("&/");return a<0?e:e.slice(0,a)}function P(e){var a=e.match(f);return a?{semanticObject:a[2],action:a[3]}:undefined}function S(e){if(!e||e==="#"){return true}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0}function C(e){if(e===undefined){return undefined}try{return JSON.parse(JSON.stringify(e))}catch(e){c.error("Could not clone object",null,"sap.ushell_abap.bootstrap");return undefined}}function y(e){return e.indexOf("sap_")===0}function F(e,a){var t=sap.ui.require("sap/ui/core/Configuration");var r=t.getFormatSettings();c.debug("setSapui5Settings()",JSON.stringify(e),"sap.ushell_abap.bootstrap.abap");if(e.language){t.setLanguage(e.language,e.ABAPLanguage)}if(e.legacyDateFormat){r.setLegacyDateFormat(e.legacyDateFormat)}if(e.legacyDateCalendarCustomizing){r.setLegacyDateCalendarCustomizing(e.legacyDateCalendarCustomizing)}if(e.legacyNumberFormat){r.setLegacyNumberFormat(e.legacyNumberFormat)}if(e.legacyTimeFormat){r.setLegacyTimeFormat(e.legacyTimeFormat)}if(typeof a==="object"){r.addCustomCurrencies(a)}if(e.useTimeZoneIana&&e.timeZoneIana!==""){t.setTimezone(e.timeZoneIana)}}function A(e){(l.get("sap-ushell-config.services.Container.adapter.config")||l.create("sap-ushell-config.services.Container.adapter.config")).bootTheme=C(e)}function T(e){if(!e){c.error("extractSystemThemeRoot: mandatory parameter oStartupServiceResult not supplied")}if(e.themeRoot){return e.themeRoot}if(e.client){c.warning("Theme root was not contained in startup service result. A fallback to /sap/public/bc/themes/~client-<client number> is used",null,"sap.ushell_abap.bootstrap");return"/sap/public/bc/themes/~client-"+e.client}c.error("extractSystemThemeRoot: Could not determine system theme root")}function L(e){var a,t;if(e&&e.userProfile&&e.userProfile.filter){a=e.userProfile.filter(function(e){return e.id==="THEME"});t=a.length?a[0]:{};if(t.value){return t.value}}if(e&&e.theme){return e.theme}return""}function w(e,a){if(e&&y(e)){return""}return a}function _(e,a){var t;t=L(e);return{theme:t,root:w(t,a)}}function x(e){var t,r;t=a.getUrlParameterValue("sap-theme");if(t){if(t.indexOf("@")>0){r=t.split("@",2);return{theme:r[0],root:r[1]}}return{theme:t,root:w(t,e)}}return undefined}function I(){var e=u.getParameterMap()["sap-theme"]&&u.getParameterMap()["sap-theme"][0];if(e){return e}return undefined}function R(e){var a=e;var t=e.indexOf("@");if(t>=0){var r=a.slice(t+1);return n.isThemeRootSafe(r)}return true}function O(e,a){var t;var r={};var i;var n=I();var s=sap.ui.require("sap/ui/core/Core");if(n&&R(n)){t=x(a);i=t;c.debug("theme: URL theme = '"+i.theme+"' theme root = '"+i.root+"'",null,"sap.ushell_abap.bootstrap");if(i.root){s.setThemeRoot(i.theme,i.root.replace(/\/?$/,"/UI5/"))}}else if(e){i=e;c.debug("theme: startup service theme = '"+i.theme+"' theme root = '"+i.root+"'",null,"sap.ushell_abap.bootstrap");if(i.root){s.applyTheme(i.theme,i.root+"/UI5/")}else{s.applyTheme(i.theme)}}else{r.theme=l.get("sap-ui-config.theme");if(r.theme){r.root=l.get("sap-ui-config.themeRoots."+r.theme||"");if(!r.root){r.root=w(r.theme,a)}i={theme:r.theme,root:r.root};c.debug("theme: html file theme = '"+i.theme+"' theme root = '"+i.root+"'",null,"sap.ushell_abap.bootstrap")}else{i={theme:"",root:""};c.error("Could not determine theme",null,"sap.ushell_abap.bootstrap")}}A(i);return i}function z(e){var t=u.getParameterMap(),r=a.getUrlParameterValue("sap-locale",t),i={},n,s,o;n=l.get("sap-ushell-config.services.SupportTicket.config")||l.create("sap-ushell-config.services.SupportTicket.config");if(n.enabled!==false){n.enabled=e.isEmbReportingActive===true}n=l.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services")||l.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services");n.targetMappings=e.services&&e.services.targetMappings;n=l.get("sap-ushell-config.services.LaunchPage.adapter.config.services")||l.create("sap-ushell-config.services.LaunchPage.adapter.config.services");n.targetMappings=e.services&&e.services.targetMappings;n.launchPage=e.services&&e.services.pbFioriHome;n=l.get("sap-ushell-config.services.VisualizationDataProvider.adapter")||l.create("sap-ushell-config.services.VisualizationDataProvider.adapter");n.module="sap.ushell_abap.adapters.abap.LaunchPageAdapter";n=l.get("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services")||l.create("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services");n.targetMappings=e.services&&e.services.targetMappings;n.launchPage=e.services&&e.services.pbFioriHome;n=l.get("sap-ushell-config.services.PageBuilding.adapter.config.services")||l.create("sap-ushell-config.services.PageBuilding.adapter.config.services");n.pageBuilding=e.services&&e.services.pbFioriHome;n=l.get("sap-ushell-config.services.Personalization.adapter.config.services")||l.create("sap-ushell-config.services.Personalization.adapter.config.services");n.personalization=e.services&&e.services.personalization;if(!r){i={language:e.languageBcp47||e.language,ABAPLanguage:e.language,legacyDateFormat:e.dateFormat,legacyDateCalendarCustomizing:e.tislcal,legacyNumberFormat:e.numberFormat===""?" ":e.numberFormat,legacyTimeFormat:e.timeFormat}}o=l.get("sap-ushell-config.ui5.timeZoneFromServerInUI5");if(o===undefined){l.set("sap-ushell-config.startupConfig.timeZoneFromServerInUI5",false);l.set("ushell.ui5.timeZoneFromServerInUI5",false);o=l.get("sap-ushell-config.startupConfig.timeZoneFromServerInUI5")}s=l.get("sap-ushell-config.startupConfig.timeZone");if(s===undefined){l.set("sap-ushell-config.startupConfig.timeZone","");s=l.get("sap-ushell-config.startupConfig.timeZone")}i.useTimeZoneIana=o;i.timeZoneIana=s;O(m,h);F(i,e.currencyFormats)}function D(e){var a=g._getShellHash(),r=v(),i=P(a),n=[i],s={},o={},c;var u=l.get("sap-ushell-config.services.AppState.config")||l.create("sap-ushell-config.services.AppState.config");var p=l.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||l.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");function f(e,a){var t=a.match(e);var r=[];if(!t){return}r=t[2].toString().split("=");o[r[0]]=r[1]}function h(e,a,t,r,i){if(a&&a[i]&&t&&t[r]){e[t[r]]=a[i]}}if(d(a)){f(/(\?|&)(sap-xapp-state=[A-Z0-9]+)/,a);f(/(\?|&)(sap-intent-param=[A-Z0-9]+)/,a);f(/(\?|&)(sap-system=[A-Z0-9]+)/,a);f(/(\?|&|[/])(sap-iapp-state=[A-Z0-9]+)/,r);c=t.requestDirectStart(e,i,o);u.initialAppStatesPromise=c.then(function(e){h(s,e,o,"sap-intent-param","iparState");h(s,e,o,"sap-iapp-state","iappState");h(s,e,o,"sap-xapp-state","xappState");u.initialAppStates=s;return Promise.resolve(s)});p.initialSegmentPromise=c.then(function(e){if(e.targetMappings){return Promise.resolve([n,e.targetMappings,e.systemAliases,e.urlTemplates])}return Promise.resolve(null)})}else{u.initialAppStatesPromise=Promise.resolve({});p.initialSegmentPromise=Promise.resolve(null)}}function Z(){var e=new Promise(function(e,a){var t,r;r=function(){c.info("Direct application start: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(r)};s.once("ShellNavigationInitialized").do(function(){t=sap.ushell.Container.getRenderer();if(t){c.info("Direct application start: resolving component waitFor promise immediately (shell renderer already created).");e()}else{sap.ushell.Container.attachRendererCreatedEvent(r)}})});return e}function H(){p.run();var a=g._getShellHash();if(S(a)&&window["sap-ushell-config"].ushell&&window["sap-ushell-config"].ushell.spaces&&window["sap-ushell-config"].ushell.spaces.enabled){g._loadPage(a)}e.getLib().then(function(e){var a=e.FrameLogonManager.getInstance();sap.ushell.Container.oFrameLogonManager=a});if(d(a)){var t,r;window["sap-ushell-async-libs-promise-directstart"]=new Promise(function(e,a){t=e;r=a});window["sap-ushell-async-libs-promise-directstart"].catch(function(e){});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(e){e.resolveHashFragment("#"+g._getShellHash()).done(function(e){sap.ui.require(["sap/ushell/services/AppConfiguration"],function(i){i.setCurrentApplication(e);if(e&&e.ui5ComponentName){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(i){i.createComponent(e,P(a),Z(),"Application").done(function(e){t({resolvedHashFragment:e,dependenciesLoaded:true})}).fail(function(e){r(e)})})}else{t({resolvedHashFragment:e,dependenciesLoaded:false})}})}).fail(function(e){r(e)})})}}function M(e){if(e&&e.indexOf("Shell-appfinder")===0){return}sap.ushell.Container.getServiceAsync("PersonalizationV2").then(async function(e){var a={container:"sap.ushell.cdm3-1.personalization",item:"data"};var t={validity:"Infinity",keyCategory:e.constants.keyCategory.GENERATED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:false};const r=await e.getPersonalizer(a,t);return r.getPersData()});sap.ui.require(["sap/ushell/components/pages/controller/PagesAndSpaceId"],function(a){var t=a.getPageAndSpaceId(e);var r=sap.ushell.Container.getServiceAsync("PagePersistence");Promise.all([t,r]).then(function(e){var a=e[0];var t=e[1];t.getPage(a.pageId)}).catch(function(e){c.error(e)})})}function q(e){i.initXhrLogon(window["sap-ushell-config"]);o();t.requestStartupConfig().then(function(e){var a=g._getShellHash();(l.get("sap-ushell-config.services.Container.adapter")||l.create("sap-ushell-config.services.Container.adapter")).config=e;var i=l.get("sap-ushell-config.services.LaunchPage.adapter.config")||l.create("sap-ushell-config.services.LaunchPage.adapter.config");var n=l.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||l.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");if(l.get("sap-ushell-config.ushell.spaces.enabled")){l.set("sap-ushell-config.services.VisualizationDataProvider.adapter.config",i);l.set("sap-ushell-config.services.NavigationDataProvider.adapter.config",n)}D(e);h=T(e);m=_(e,h);if(!I()&&m){c.debug("theme: load theme from startup service via window",null,"sap.ushell_abap.bootstrap")}if(S(a)&&!l.get("sap-ushell-config.ushell.spaces.enabled")){r.requestPageSet(e)}var s=t.requestFullTM(e);n.navTargetDataPromise=s;i.compactTMPromise=s;return Promise.resolve(e)},function(e){c.error("start_up request failed: "+e,null,"sap.ushell_abap.bootstrap");return Promise.resolve({})}).then(function(a){z(a);e()})}g.start=q;g.afterBootstrap=H;g._getShellHash=b;g._getFullShellHash=v;g._createWaitForRendererCreatedPromise=Z;g._loadPage=M;return g});
//# sourceMappingURL=boottask.js.map