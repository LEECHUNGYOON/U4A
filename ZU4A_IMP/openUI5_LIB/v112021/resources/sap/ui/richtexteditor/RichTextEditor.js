sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Control","sap/ui/core/library","sap/ui/core/Locale","sap/ui/core/Popup","sap/ui/core/ResizeHandler","./library","./ToolbarWrapper","sap/ui/dom/includeScript","sap/base/Log","sap/base/security/sanitizeHTML","sap/ui/events/KeyCodes","sap/ui/core/Core","./RichTextEditorRenderer"],(function(jQuery,t,e,i,o,r,n,s,a,u,p,l,h){"use strict";var d=e.TextDirection,y="Initial",c="Loading",g="Initializing",E="Loaded",_="Ready",T="Destroyed",b=t.extend("sap.ui.richtexteditor.RichTextEditor",{metadata:{library:"sap.ui.richtexteditor",properties:{value:{type:"string",group:"Data",defaultValue:""},textDirection:{type:"sap.ui.core.TextDirection",group:"Appearance",defaultValue:d.Inherit},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},editorType:{type:"string",group:"Misc",defaultValue:"TinyMCE"},editorLocation:{type:"string",group:"Misc",defaultValue:"js/tiny_mce6/tinymce.js",deprecated:!0},editable:{type:"boolean",group:"Misc",defaultValue:!0},showGroupFontStyle:{type:"boolean",group:"Misc",defaultValue:!0},showGroupTextAlign:{type:"boolean",group:"Misc",defaultValue:!0},showGroupStructure:{type:"boolean",group:"Misc",defaultValue:!0},showGroupFont:{type:"boolean",group:"Misc",defaultValue:!1},showGroupClipboard:{type:"boolean",group:"Misc",defaultValue:!0},showGroupInsert:{type:"boolean",group:"Misc",defaultValue:!1},showGroupLink:{type:"boolean",group:"Misc",defaultValue:!1},showGroupUndo:{type:"boolean",group:"Misc",defaultValue:!1},wrapping:{type:"boolean",group:"Appearance",defaultValue:!0},required:{type:"boolean",group:"Misc",defaultValue:!1},sanitizeValue:{type:"boolean",group:"Misc",defaultValue:!0},plugins:{type:"object[]",group:"Behavior",defaultValue:[]},useLegacyTheme:{type:"boolean",group:"Appearance",defaultValue:!0,deprecated:!0},buttonGroups:{type:"object[]",group:"Behavior",defaultValue:[]},customToolbar:{type:"boolean",group:"Misc",defaultValue:!1}},events:{change:{parameters:{newValue:{type:"string"}}},ready:{},readyRecurring:{},beforeEditorInit:{}},aggregations:{_toolbarWrapper:{type:"sap.ui.richtexteditor.IToolbar",multiple:!1,visibility:"hidden",defaultValue:null},customButtons:{type:"sap.ui.core.Control",multiple:!0,singularName:"customButton",defaultValue:null}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaLabelledBy"}}}});b._lastId=0,b._iCountInstances=0,b.BUTTON_GROUPS=n.ButtonGroups,b.EDITORTYPE_TINYMCE5=n.EditorType.TinyMCE5,b.EDITORTYPE_TINYMCE6=n.EditorType.TinyMCE6,b.EDITORTYPE_TINYMCE=n.EditorType.TinyMCE;var f={};f[b.EDITORTYPE_TINYMCE]="js/tiny_mce6/tinymce.min.js",f[b.EDITORTYPE_TINYMCE5]="js/tiny_mce5/tinymce.min.js",f[b.EDITORTYPE_TINYMCE6]="js/tiny_mce6/tinymce.min.js",b.DEFAULT_PLUGINS_TINYMCE5=["emoticons","directionality","tabfocus","table","image","link","textcolor","colorpicker","textpattern","powerpaste"],b.DEFAULT_PLUGINS_TINYMCE6=["emoticons","directionality","image","table","link","powerpaste"],b.MAPPED_LANGUAGES_TINYMCE={bg:"bg_BG",en_US:"en_GB",fr:"fr_FR",fr_CA:"fr_FR",hu:"hu_HU",in:"id",iw:"he",ji:"yi",ko:"ko_KR",no:"nb",pt:"pt_PT",sh:"sr",sl:"sl_SI",sv:"sv_SE",th:"th_TH"},b.SUPPORTED_LANGUAGES_TINYMCE={en:!0,af_ZA:!0,ar_SA:!0,ar:!0,az:!0,be:!0,bg_BG:!0,bn_BD:!0,bs:!0,ca:!0,cs_CZ:!0,cs:!0,cy:!0,da:!0,de_AT:!0,de:!0,dv:!0,el:!0,en_CA:!0,en_GB:!0,es_MX:!0,es:!0,et:!0,eu:!0,fa_IR:!0,fa:!0,fi:!0,fo:!0,fr_FR:!0,ga:!0,gd:!0,gl:!0,he_IL:!0,hi:!0,hi_IN:!0,hr:!0,hu_HU:!0,hy:!0,id:!0,is_IS:!0,it:!0,ja:!0,ka_GE:!0,kab:!0,kk:!0,km_KH:!0,ko_KR:!0,ku_IQ:!0,ku:!0,lb:!0,lt:!0,lv:!0,ml_IN:!0,ml:!0,mn_MN:!0,nb_NO:!0,nl:!0,pl:!0,pt_BR:!0,pt_PT:!0,ro:!0,ru:!0,si_LK:!0,sk:!0,sl_SI:!0,sl:!0,sr:!0,sv_SE:!0,ta_IN:!0,ta:!0,tg:!0,th_TH:!0,tr_TR:!0,tr:!0,tt:!0,ug:!0,uk_UA:!0,uk:!0,uz:!0,vi_VN:!0,vi:!0,zh_CN:!0,zh_TW:!0},b.SUPPORTED_LANGUAGES_TINYMCE5={eo:!0,es_ES:!0,it_IT:!0,ro_RO:!0},b.SUPPORTED_LANGUAGES_TINYMCE6={eo:!0,es_ES:!0,it_IT:!0,ro_RO:!0},b.SUPPORTED_LANGUAGES_DEFAULT_REGIONS={zh:"CN",fr:"FR",bn:"BD",bg:"BG",ka:"GE",he:"IL",hi:"IN",hu:"HU",is:"IS",km:"KH",ko:"KR",ku:"IQ",ml:"IN",mn:"MN",nb:"NO",pt:"PT",si:"SI",sl:"SI",sv:"SE",th:"TH",tr:"TR",vi:"VN"},b.SUPPORTED_LANGUAGES_DEFAULT_REGIONS_TINYMCE6={zh:"CN",fr:"FR",bn:"BD",bg:"BG",ka:"GE",he:"IL",hu:"HU",is:"IS",km:"KH",ko:"KR",ku:"IQ",ml:"IN",mn:"MN",nb:"NO",pt:"PT",si:"SI",sl:"SI",sv:"SE",th:"TH"},b.pLoadTinyMCE=null;var C={};return C[b.EDITORTYPE_TINYMCE]=b.EDITORTYPE_TINYMCE6,C[b.EDITORTYPE_TINYMCE5]=b.EDITORTYPE_TINYMCE5,C[b.EDITORTYPE_TINYMCE6]=b.EDITORTYPE_TINYMCE6,b.loadTinyMCE=function(t){if(t){var e=sap.ui.require.toUrl("sap/ui/richtexteditor/"+t),i=document.querySelector("#sapui5-tinyMCE");e!==(i?i.getAttribute("src"):"")&&1===b._iCountInstances&&(delete window.tinymce,delete window.TinyMCE,b.pLoadTinyMCE=null),b.pLoadTinyMCE||(b.pLoadTinyMCE=a({id:"sapui5-tinyMCE",url:e}))}return b.pLoadTinyMCE},b.prototype.init=function(){var t=C[this.getEditorType()]||b.EDITORTYPE_TINYMCE;this._bEditorCreated=!1,this._sTimerId=null,b._iCountInstances++,this._textAreaId=this.getId()+"-textarea",this._iframeId=this._textAreaId+"_ifr",this._textAreaDom=document.createElement("textarea"),this._textAreaDom.id=this._textAreaId,this._textAreaDom.style.height="100%",this._textAreaDom.style.width="100%",this.setEditorType(t),this._setupToolbar(),this._uid=sap.ui.requireSync("sap/base/util/uid")},b.prototype.onBeforeRendering=function(){this._customToolbarEnablement();var t=this.getAggregation("_toolbarWrapper");t&&t.setToolbarEnabled(this.getEditable(),!0),!this._bCustomToolbarRequirementsFullfiled&&this.getCustomToolbar()&&u.warning("Cannot set custom toolbar - not all requirements are fulfilled."),this.isPropertyInitial("editorType")&&u.info("You are using the default value of the editorType which is subject to changes and might affect your application."),this.onBeforeRenderingTinyMCE()},b.prototype.onAfterRendering=function(){if(void 0===window?.oU4A?.taskPromiseStack)return void this.onAfterRenderingTinyMCE();let t=this.sId,e=this._uid(),i=new Promise((function(i){!function o(){setTimeout((()=>{let r=sap.ui.getCore().byId(t)||void 0;if(void 0===r){if(void 0!==window?.oU4AErroHandle?.seterroHTML){var n="[U4A Error] rich Text Editor UI Instance not found.";throw oU4AErroHandle.seterroHTML(n),zu4aGFwating(!1),new Error(n)}return i(e)}"undefined"!==r?._oEditor?.container?"undefined"!==r?._oEditor?.contentAreaContainer&&r?._oEditor?.contentAreaContainer&&0!==r._oEditor.contentAreaContainer.getElementsByTagName("iframe").length?i(e):o():o()}),100)}()}));i.uKey=e,oU4A.taskPromiseStack.push(i),this.onAfterRenderingTinyMCE()},b.prototype.reinitialize=function(){clearTimeout(this._iReinitTimeout),this._iReinitTimeout=window.setTimeout(this.reinitializeTinyMCE.bind(this),0)},b.prototype.getNativeApi=function(){return this.getNativeApiTinyMCE()},b.prototype.exit=function(){clearTimeout(this._reinitDelay),this.exitTinyMCE(),b._iCountInstances--},b.prototype.setValue=function(t){return t=null==t?"":t,this.getSanitizeValue()&&(u.trace("sanitizing HTML content for "+this),t=p(t)),t===this.getValue()||(this.setProperty("value",t,!0),t=this.getProperty("value"),C[this.getEditorType()]?this.setValueTinyMCE(t):this.reinitialize()),this},b.prototype.setEditable=function(t){var e=this.getAggregation("_toolbarWrapper");return this.setProperty("editable",t,!0),e&&e.setToolbarEnabled(t,!0),this.reinitialize(),this},b.prototype.setWrapping=function(t){return this.setProperty("wrapping",t,!0),this.reinitialize(),this},b.prototype.setRequired=function(t){return this.setProperty("required",t,!0),this.reinitialize(),this},b.prototype._setShowGroup=function(t,e){var i=this.getAggregation("_toolbarWrapper");return this.setProperty(e.property,t,!0),this.setButtonGroupVisibility(e.buttonGroup,t),i?(i.setShowGroup(e.buttonGroup,t),this):(this.reinitialize(),this)},b.prototype.setShowGroupFontStyle=function(t){return this._setShowGroup(t,{property:"showGroupFontStyle",buttonGroup:"font-style"})},b.prototype.setShowGroupTextAlign=function(t){return this._setShowGroup(t,{property:"showGroupTextAlign",buttonGroup:"text-align"})},b.prototype.setShowGroupStructure=function(t){return this._setShowGroup(t,{property:"showGroupStructure",buttonGroup:"structure"})},b.prototype.setShowGroupFont=function(t){return this._setShowGroup(t,{property:"showGroupFont",buttonGroup:"font"})},b.prototype.setShowGroupClipboard=function(t){return this._setShowGroup(t,{property:"showGroupClipboard",buttonGroup:"clipboard"})},b.prototype.setShowGroupInsert=function(t){return this._setShowGroup(t,{property:"showGroupInsert",buttonGroup:"insert"})},b.prototype.setShowGroupLink=function(t){return this._setShowGroup(t,{property:"showGroupLink",buttonGroup:"link"})},b.prototype.setShowGroupUndo=function(t){return this._setShowGroup(t,{property:"showGroupUndo",buttonGroup:"undo"})},b.prototype.setCustomToolbar=function(t){return this._tinyMCEStatus&&this._tinyMCEStatus!==y?u.error("Cannot set customToolbar property to "+t+" after initialization.",this):this.setProperty("customToolbar",t),this},b.prototype.addPlugin=function(t){"string"==typeof t&&(t={name:t});var e=this.getProperty("plugins")||[];return!e.some((function(e){return e.name===t.name}))&&e.push(t),this.setProperty("plugins",e),this.reinitialize(),this},b.prototype.removePlugin=function(t){for(var e=this.getProperty("plugins").slice(0),i=0;i<e.length;++i)e[i].name===t&&(e.splice(i,1),--i);return this.setProperty("plugins",e),this.reinitialize(),this},b.prototype.addButtonGroup=function(t){var e=this.getProperty("buttonGroups").slice(),i=this.getAggregation("_toolbarWrapper");if(!t)return this;for(var o=0;o<e.length;++o)if("string"==typeof t&&e[o].name===t||e[o].name===t.name)return u.warning("Trying to add already existing group: "+("string"==typeof t?t:t.name)+". Please remove the group first and then add it.",this),this;if(!("object"!=typeof t||t.name&&Array.isArray(t.buttons)))return u.error("The properties 'name' and 'buttons' are mandatory for the group configuration object. Please make sure they exist within the provided configuration.",this),this;if(!("object"!=typeof t||Array.isArray(t.buttons)&&t.buttons.length))return u.error("The 'buttons' array of the provided group configuration object cannot be empty.",this),this;if("string"==typeof t)switch(t){case"formatselect":t={name:"formatselect",buttons:["formatselect"]};break;case"styleselect":t={name:"styleselect",buttons:["styleselect"],customToolbarPriority:40};break;case"table":t={name:"table",buttons:["table"],customToolbarPriority:90};break;case"blocks":t={name:"blocks",buttons:["blocks"]};break;case"styles":t={name:"styles",buttons:["styles"],customToolbarPriority:40};break;default:t={name:this._createId("buttonGroup"),buttons:[t]}}this._checkAndUpdateGroupInfo(t);var r=this.getButtonGroups();return r.push(t),this.setProperty("buttonGroups",r),i&&i.addButtonGroupToContent(t),this},b.prototype.removeButtonGroup=function(t){for(var e=this.getProperty("buttonGroups").slice(0),i=this.getAggregation("_toolbarWrapper"),o=0;o<e.length;++o)e[o].name===t&&(e.splice(o,1),--o,i&&i.removeButtonGroup(t));return this.setProperty("buttonGroups",e),this.reinitialize(),this},b.prototype.setButtonGroups=function(t){var e;return Array.isArray(t)?(t.forEach(this._checkAndUpdateGroupInfo),this.setProperty("buttonGroups",t),(e=this.getAggregation("_toolbarWrapper"))&&e.setButtonGroups(t),this.reinitialize(),this):(u.error("Button groups cannot be set: "+t+" is not an array."),this)},b.prototype._checkAndUpdateGroupInfo=function(t){void 0===t.visible&&(t.visible=!0),void 0===t.priority&&(t.priority=10),void 0===t.row&&(t.row=0)},b.prototype.setPlugins=function(t){var e;return Array.isArray(t)?(e=t.filter((function(t){return"lists"===t.name})),this.getShowGroupStructure()&&!e.length&&t.push({name:"lists"}),this.setProperty("plugins",t)):(u.error("Plugins cannot be set: "+t+" is not an array."),this)},b.prototype.setButtonGroupVisibility=function(t,e){for(var i=this.getButtonGroups(),o=0,r=i.length;o<r;++o)i[o].name===t&&(i[o].visible=e);return this},b.prototype._createId=function(t){return void 0===t&&(t="_rte"),t+b._lastId++},b.prototype._setupToolbar=function(){var t=function(t){return t.map((function(t){return{name:t}}))},e={TinyMCE:t(b.DEFAULT_PLUGINS_TINYMCE6),TinyMCE6:t(b.DEFAULT_PLUGINS_TINYMCE6)};e.TinyMCE5=t(b.DEFAULT_PLUGINS_TINYMCE5),this.setPlugins(e[this.getEditorType()]);var i={TinyMCE:["fontfamily","fontsize","forecolor","backcolor"],TinyMCE6:["fontfamily","fontsize","forecolor","backcolor"],TinyMCE5:["fontselect","fontsizeselect","forecolor","backcolor"]};this.setButtonGroups([{name:"font-style",visible:this.getShowGroupFontStyle(),row:0,priority:10,customToolbarPriority:20,buttons:["bold","italic","underline","strikethrough"]},{name:"font",visible:this.getShowGroupFont(),row:0,priority:30,customToolbarPriority:50,buttons:i[this.getEditorType()]},{name:"clipboard",visible:this.getShowGroupClipboard(),row:1,priority:10,customToolbarPriority:110,buttons:["cut","copy","paste"]},{name:"structure",visible:this.getShowGroupStructure(),row:1,priority:20,customToolbarPriority:60,buttons:["bullist","numlist","outdent","indent"]},{name:"undo",visible:this.getShowGroupUndo(),row:1,priority:40,customToolbarPriority:100,buttons:["undo","redo"]},{name:"insert",visible:this.getShowGroupInsert(),row:1,priority:50,customToolbarPriority:80,buttons:["image","emoticons"]},{name:"link",visible:this.getShowGroupLink(),row:1,priority:60,customToolbarPriority:70,buttons:["link","unlink"]},{name:"text-align",visible:this.getShowGroupTextAlign(),row:0,priority:20,customToolbarPriority:30,buttons:["alignleft","aligncenter","alignright","alignjustify"]},{name:"table",buttons:["table"],customToolbarPriority:90,visible:!0,priority:10,row:0}])},b.prototype.setEditorType=function(t){return this._bEditorCreated?u.error("editorType property cannot be set after the RichtextEditor has been rendered"):(this.setProperty("editorType",t),t=this.getEditorType(),this._setupToolbar(),C[t]||(this.setProperty("editorType",b.EDITORTYPE_TINYMCE),u.error("Invalid editorType value set. Fallbacks to latest.")),"TinyMCE5"===C[t]&&u.warning("TinyMCE version 5 is used as editor type. TinyMCE 5 is depreacated and will be removed from the code entirely in future."),this.initTinyMCE()),this},b.prototype.setEditorLocation=function(t){return this._bEditorCreated?u.error("editorLocation property cannot be set after the RichtextEditor has been rendered"):this.setProperty("editorLocation",t),this},b.prototype._createButtonRowsTinyMCE=function(t,e){t=void 0===t?",":t,e=void 0===e?"|":e;var i,o,r,n=this.getButtonGroups(),s=t+e+t,a={},u="";for(i=0,o=n.length;i<o;++i)a[(r=n[i]).priority]||(a[r.priority]=[]),void 0===r.priority&&(r.priority=Number.MAX_VALUE),a[r.priority].push(r);for(var p in a)for(i=0,o=a[p].length;i<o;++i)(r=a[p][i]).visible&&r.buttons&&0!==r.buttons.length&&(u||(u=""),u+=r.buttons.join(t)+s);return u},b.prototype._createPluginsListTinyMCE=function(){for(var t=this.getPlugins(),e=[],i=0,o=t.length;i<o;++i)e.push(t[i].name);return e.join(",")},b.prototype.onTinyMCEChange=function(t){var e=this.getValue(),i=t.getContent(),o=this.getSanitizeValue()?p(i):i;e===o||this.bExiting||(this.setProperty("value",o,!0),this.fireChange({oldValue:e,newValue:o}))},b.prototype.initTinyMCE=function(){this._oEditor=null,this._tinyMCEStatus=y,this._boundResizeEditorTinyMCE=this._resizeEditorTinyMCE.bind(this),this._bInitializationPending=!1,this._lastRestHeight=0},b.prototype.exitTinyMCE=function(){this._bUnloading=!0,r.deregister(this._resizeHandlerId),this._resizeHandlerId=null,this._removeEditorTinyMCE()},b.prototype._removeEditorTinyMCE=function(){switch(this._tinyMCEStatus){case y:case c:case E:break;case g:this._pTinyMCEInitialized.then(this._removeEditorTinyMCE.bind(this,this._oEditor));break;case _:this._oEditor.remove(),this._tinyMCEStatus=T,this._boundResizeEditorTinyMCE=null,this._oEditor=null;break;case T:break;default:u.error("Unknown TinyMCE status: "+this._tinyMCEStatus)}},b.prototype._shouldLoadTinyMCE=function(){var t=this.getEditorType();return!window.tinymce||(t===b.EDITORTYPE_TINYMCE5?"5"!=window.tinymce.majorVersion:t===b.EDITORTYPE_TINYMCE6&&"6"!=window.tinymce.majorVersion)},b.prototype.onBeforeRenderingTinyMCE=function(){if(this._shouldLoadTinyMCE()){var t=f[this.getEditorType()];this._tinyMCEStatus=c,this._pTinyMCELoaded=b.loadTinyMCE(t).then(function(){this._tinyMCEStatus=E}.bind(this))}else this._pTinyMCELoaded=Promise.resolve(),this._tinyMCEStatus=E},b.prototype.onAfterRenderingTinyMCE=function(){var t=this.getDomRef();if(this._shouldLoadTinyMCE())this._pTinyMCELoaded.then(this.onAfterRenderingTinyMCE.bind(this));else if(t)switch(this._tinyMCEStatus){case g:t.appendChild(this._textAreaDom);break;case E:case c:this.getDomRef().appendChild(this._textAreaDom),this.reinitializeTinyMCE();break;case _:t.appendChild(this._textAreaDom),this.reinitializeTinyMCE();break;default:u.error("Unknown TinyMCE status: "+this._tinyMCEStatus)}},b.prototype.reinitializeTinyMCE=function(){if(!this._bInitializationPending&&!this._bUnloading){var t=function(){this._oEditor&&this._oEditor.remove(),this._initializeTinyMCE()}.bind(this);switch(this._tinyMCEStatus){case y:break;case c:this._bInitializationPending=!0,this._pTinyMCELoaded.then(t);break;case g:this._bInitializationPending=!0,this._pTinyMCEInitialized.then(t);break;case E:case _:this._bInitializationPending=!0,setTimeout((function(){t()}),0);break;default:u.error("Unknown TinyMCE status: "+this._tinyMCEStatus)}}},b.prototype.getNativeApiTinyMCE=function(){return this._oEditor},b.prototype.setValueTinyMCE=function(t){switch(this._tinyMCEStatus){case y:case g:case c:break;case _:this._oEditor.setContent(t),this._oEditor.undoManager.clear(),this._oEditor.undoManager.add(),this.getEditable()||jQuery.each(this._oEditor.getDoc().getElementsByTagName("a"),(function(t,e){e.target="_blank"}));break;default:u.error("Unknown TinyMCE status: "+this._tinyMCEStatus)}},b.prototype._initializeTinyMCE=function(){this._pTinyMCEInitialized=new Promise(function(t,e){this._bInitializationPending=!1,this._tinyMCEStatus=g,this._textAreaDom.value=this._patchTinyMCEValue(this.getValue()),window.tinymce.init(this._createConfigTinyMCE(function(){this._tinyMCEStatus=_,setTimeout(function(){this._bInitializationPending||this._onAfterReadyTinyMCE(),t()}.bind(this),0)}.bind(this)))}.bind(this))},b.prototype._patchTinyMCEValue=function(t){return 0===t.indexOf("\x3c!--")&&(t="&#8203;"+t),t},b.prototype._onAfterReadyTinyMCE=function(){var t=document.getElementById(this._iframeId),e=this.getAggregation("_toolbarWrapper"),i=e&&e.getAggregation("_toolbar").getDomRef(),o=h.getLibraryResourceBundle("sap.ui.richtexteditor");if(t&&t.setAttribute("aria-labelledby",this.getAriaLabelledBy().join(" ")),!this._bUnloading){!this._tinyMCEDesktopDetected()&&this._bHasNativeMobileSupport||e&&e.getAggregation("_toolbar").removeStyleClass("sapUiHidden"),this._oEditor.on("change",(t=>this.onTinyMCEChange(this._oEditor))),this._oEditor.on("focusout",(t=>this.onTinyMCEChange(this._oEditor))),this.getCustomToolbar()&&this._oEditor.save();var n=jQuery(t);if(this.getTooltip()&&this.getTooltip().length>0){var s=this.getTooltip_Text();this._oEditor.getBody().setAttribute("title",s),n.attr("title",s)}this._registerWithPopupTinyMCE(),this._resizeHandlerId||(this._resizeHandlerId=r.register(this,this._boundResizeEditorTinyMCE)),this._resizeEditorOnDocumentReady(),i&&i.setAttribute("aria-roledescription",o.getText("CUSTOM_TOOLBAR_ARIA_ROLEDESCRIPTION")),this._oEditor.getContainer().classList.add("sapUiRteEditorContainer"),this.fireReadyTinyMCE()}},b.prototype._resizeEditorOnDocumentReady=function(){var t=this._resizeEditorTinyMCE.bind(this),e=this._oEditor.getDoc();e&&("complete"==e.readyState?t():e.addEventListener("readystatechange",(function(){"complete"==e.readyState&&t()})))},b.prototype._tinyMCEDesktopDetected=function(){return window.tinymce&&window.tinymce.Env.desktop},b.prototype.fireReadyTinyMCE=function(){switch(this._tinyMCEStatus){case y:case c:case E:case g:break;case _:this._bInitializationPending||(this._readyFired||(this._readyFired=!0,this.fireReady.apply(this,arguments)),this.fireReadyRecurring.apply(this,arguments));break;default:u.error("Unknown TinyMCE status: "+this._tinyMCEStatus)}},b.prototype._getTextDirection=function(){return this.getTextDirection()===this.getMetadata().getProperty("textDirection").getDefaultValue()?h.getConfiguration().getRTL()?"rtl":"ltr":this.getTextDirection().toLowerCase()},b.prototype._createConfigTinyMCE=function(t){var e=this.getAggregation("_toolbarWrapper"),i=this._createButtonRowsTinyMCE(" ","|");0===i.length&&(i=!1);var o=this._createPluginsListTinyMCE();this.getEditable()||(o=o.replace(/(,powerpaste|powerpaste,)/gi,""));var r=this.getEditorType()===b.EDITORTYPE_TINYMCE6||this.getEditorType()===b.EDITORTYPE_TINYMCE;r&&(o=this.getPlugins().map((function(t){return t.name}))),r&&!this.getEditable()&&(o=o.filter((function(t){return"powerpaste"!==t})));var n={height:"calc(100% - var(--_sap_ui_richtexteditor__toolbar_height))",directionality:this._getTextDirection(),selector:"[id='"+this._textAreaId+"']",theme:"silver",menubar:!1,language:this._getLanguageTinyMCE(),browser_spellcheck:!0,convert_urls:!1,plugins:o,contextmenu:!1,toolbar_items_size:"small",toolbar:i,toolbar_mode:"sliding",statusbar:!1,image_advtab:!0,readonly:!this.getEditable(),nowrap:!this.getWrapping(),init_instance_callback:function(e){this._oEditor=e,t()}.bind(this)};return this._bCustomToolbarRequirementsFullfiled&&e&&(n=e.modifyRTEToolbarConfig(n)),this.fireBeforeEditorInit({configuration:n}),this._bHasNativeMobileSupport=n.mobile,n},b.prototype._getLanguageTinyMCE=function(){var t,e=new i(h.getConfiguration().getLanguage()),o=e.getLanguage(),r=e.getRegion(),n=this.getEditorType()===b.EDITORTYPE_TINYMCE6||this.getEditorType()===b.EDITORTYPE_TINYMCE;return o=b.MAPPED_LANGUAGES_TINYMCE[o]||o,r||(r=n?b.SUPPORTED_LANGUAGES_DEFAULT_REGIONS_TINYMCE6[o]:b.SUPPORTED_LANGUAGES_DEFAULT_REGIONS[o]),t=r?o+"_"+r.toUpperCase():o,b.SUPPORTED_LANGUAGES_TINYMCE[t]||b.SUPPORTED_LANGUAGES_TINYMCE6[t]?t:b.SUPPORTED_LANGUAGES_TINYMCE6[o]||b.SUPPORTED_LANGUAGES_TINYMCE[o]?o:"en"},b.prototype._resizeEditorTinyMCE=function(){if(this._tinyMCEStatus===_){var t,e,i=this._oEditor.getContentAreaContainer(),o=this.getDomRef().offsetHeight,r=this._oEditor.getContainer().offsetHeight,n=i.offsetHeight,s=this.getAggregation("_toolbarWrapper");if(t=o-(r-n)-(s?s.getAggregation("_toolbar").getDomRef().offsetHeight:"0"),0==(e=Math.abs(this._lastRestHeight-t))||e>5)try{this._oEditor.theme.resizeTo(void 0,t-2)}catch(t){}this._lastRestHeight=t}},b.prototype._registerWithPopupTinyMCE=function(){var t=this.$().closest("[data-sap-ui-popup]");setTimeout(function(){if(1===t.length){var e="tox-dialog-"+this.getId();this._oEditor&&(this._oEditor.on("OpenWindow",(function(t){jQuery(".tox-dialog[role='dialog']").attr("id",e);var i="#"+e;o.addExternalContent(i,!0)})),this._oEditor.on("CloseWindow",(function(t){var i="#"+e;o.removeExternalContent(i,!0),jQuery(".tox-dialog[role='dialog']").attr("id")})))}}.bind(this),0)},b.prototype._checkCustomToolbarRequirements=function(){var t=this.getCustomToolbar()&&C[this.getEditorType()]&&n.RichTextEditorHelper.bSapMLoaded;return this.$().toggleClass("sapUiRTEWithCustomToolbar",t),t},b.prototype._customToolbarEnablement=function(){var t,e=this.getAggregation("_toolbarWrapper");this._bCustomToolbarRequirementsFullfiled=this._checkCustomToolbarRequirements(),this._bCustomToolbarRequirementsFullfiled&&!e&&(t=this.getAggregation("customButtons"),this.removeAllAggregation("customButtons"),e=new s({editor:this}),this.setAggregation("_toolbarWrapper",e),setTimeout((function(){var t=e.getAggregation("_toolbar");t&&t.addStyleClass("sapUiHidden")}),0),t&&t.length&&setTimeout((function(){t.forEach((function(t){e.modifyToolbarContent("add",t)}))}),0))},["add","destroy","get","indexOf","insert","removeAll","remove"].forEach((function(t){var e=t+"CustomButton"+(["destroy","get","removeAll"].indexOf(t)>-1?"s":""),i=/^(add|insert|destroy)/.test(t);b.prototype[e]=function(){var e=null,o=arguments[0],r=this.getAggregation("_toolbarWrapper");return"object"==typeof o&&"sap.m.Button"!==o.getMetadata().getName()?(u.error("Only sap.m.Button is allowed as aggregation."),i?this:void 0):(e=r&&r.modifyToolbarContent?r.modifyToolbarContent.bind(r,t).apply(r,arguments):this[t+"Aggregation"].bind(this,"customButtons").apply(this,arguments),i?this:e)}})),b}));