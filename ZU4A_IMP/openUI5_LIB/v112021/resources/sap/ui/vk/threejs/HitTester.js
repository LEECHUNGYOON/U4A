/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../thirdparty/three"],function(e,r){"use strict";const t=31;const a=31;var n=function(){this._maskMaterial=new r.MeshBasicMaterial({side:r.DoubleSide,fog:false});this._depthMaterial=new r.ShaderMaterial({vertexShader:["#include <clipping_planes_pars_vertex>","void main() {","\t#include <data_texture_explicit>","\t#include <begin_vertex>","\t#include <project_vertex>","\t#include <clipping_planes_vertex>","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","void main() {","\t#include <clipping_planes_fragment>","\thighp vec4 value = vec4(fract(vec4(1.0, 255.0, 65025.0, 16581375.0) * gl_FragCoord.z));","\tvalue.xyz -= value.yzw * (1.0 / 255.0);","\tgl_FragColor = value;","}"].join("\n"),side:r.DoubleSide,clipping:true});this._renderTarget=new r.WebGLRenderTarget(t,a,{minFilter:r.NearestFilter,magFilter:r.NearestFilter});this._renderTarget.texture.generateMipmaps=false;this._renderTarget.depthBuffer=true};var i;var l=new r.Matrix4;var o=new r.Frustum;var s=new r.Matrix4;var c=new r.Vector2;var u=new r.Raycaster;var d=new r.Ray;var p=new r.Sphere;var f=[];var g=new Uint8Array(4);var h=new r.Vector3;function v(e){var r=e.parent;while(r){if(r.userData.closed){e=r}r=r.parent}while(e.parent&&e.userData.skipIt){e=e.parent}return e}n.prototype.hitTest=function(e,n,x,m,_,y,M,C,w){if(i?.constructor!==M.constructor){i=new M.constructor}i.copy(M);const b=t>>1;const T=a>>1;const S=0;const j=0;var B=M.view;if(B){const r=B.width/x;const a=B.height/m;i.setViewOffset(B.fullWidth,B.fullHeight,B.offsetX+(e-.5*t)*r,B.offsetY+(n-.5*t)*a,r*t,a*t)}else{i.setViewOffset(x,m,e-t*.5,n-a*.5,t,a)}i.updateMatrixWorld();i.updateProjectionMatrix();l.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);o.setFromProjectionMatrix(l);u.setFromCamera(c.set(S,j),i);const D=_.getContextRedBits();const F=_.getContextGreenBits();const P=_.getContextBlueBits();const R=D+F;const I=(1<<D)-1;const $=(1<<F)-1;const O=(1<<P)-1;const k=1/I;const V=1/$;const W=1/O;const z=this._maskMaterial;var A=new r.Color;_.getClearColor(A);var G=_.getClearAlpha();var N=_.autoClear;_.setRenderTarget(this._renderTarget);_.clippingPlanes=C||[];_.autoClear=false;_.setClearColor(0,0);_.clear(true,true,false);var E=z.color;var L=0;f.length=0;var U=w&&w.ignoreUnderlay?null:[];var H=[];var X=w&&w.ignoreOverlay?null:[];function Y(e,t){if(!e.visible||e.userData.selectable===false){return}t=t||e.userData.renderStage;var a=e.geometry;if(a&&e.material&&o.intersectsObject(e)){var n=e.matrixWorld;var i=e.userData.renderGroup;if(i&&i.boundingSphere){p.setFromPackedArray(i.boundingSphere)}else{if(a.boundingSphere==null){a.computeBoundingSphere()}p.copy(a.boundingSphere)}p.applyMatrix4(n);if(u.ray.intersectsSphere(p)){s.copy(n).invert();d.copy(u.ray).applyMatrix4(s);var l=i&&i.boundingBox?r.Box3.newFromPackedArray(i.boundingBox):a.boundingBox;if(l==null||d.intersectsBox(l)){if(!t){H.push(e)}else if(t<0){if(U){U.push(e)}}else if(X){X.push(e)}}}}var c=e.children;for(var f=0,g=c.length;f<g;f++){Y(c[f],t)}}Y(y);function q(e){L+=1;f.push(e);E.setRGB((L&I)*k,(L>>D&$)*V,(L>>R&O)*W);var r=e.material;e.material=z;_.render(e,i);e.material=r}if(U!=null&&U.length>0){U.forEach(q);_.clearDepth()}H.forEach(q);if(X!=null&&X.length>0){_.clearDepth();X.forEach(q)}_.readRenderTargetPixels(this._renderTarget,b,T,1,1,g);L=(g[0]>>8-D)+(g[1]>>8-F<<D)+(g[2]>>8-P<<R);let J=L>0?f[L-1]:null;if(J){const e=J.material;J.material=this._depthMaterial;_.clear(true,true,false);_.render(J,i);J.material=e;_.readRenderTargetPixels(this._renderTarget,b,T,1,1,g);const t=(g[0]+(g[1]+(g[2]+g[3]/255)/255)/255)/255*2-1;h.set(S,j,t).unproject(i);if(J.geometry.userData.isPointCloud&&y.userData._instanceIndexToNodeMap instanceof Map){this._clusterIndexMaterial??=new r.ShaderMaterial({vertexShader:["#include <clipping_planes_pars_vertex>","varying lowp vec3 clusterColor;","void main() {","\t#include <data_texture_explicit>","\t#include <begin_vertex>","\t#include <project_vertex>","\t#include <clipping_planes_vertex>","\thighp int index = int(clusterInstance);",`\tclusterColor.x = float(index & ${I}) * ${k};`,`\tclusterColor.y = float((index >> ${D}) & ${$}) * ${V};`,`\tclusterColor.z = float((index >> ${R}) & ${O}) * ${W};`,"}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","varying lowp vec3 clusterColor;","void main() {","\t#include <clipping_planes_fragment>","\tgl_FragColor = vec4(clusterColor, 1.0);","}"].join("\n"),side:r.DoubleSide,clipping:true});J.material=this._clusterIndexMaterial;J.material.specularMap=e.specularMap;_.clear(true,true,false);_.render(J,i);J.material=e;_.readRenderTargetPixels(this._renderTarget,b,T,1,1,g);const t=(g[0]>>8-D)+(g[1]>>8-F<<D)+(g[2]>>8-P<<R);if(t>0){J=y.userData._instanceIndexToNodeMap.get(t)??J}}}_.setRenderTarget(null);_.clippingPlanes=[];_.setClearColor(A,G);_.autoClear=N;return J?{distance:u.ray.origin.distanceTo(h),point:h,object:v(J)}:null};n.prototype.hitTestPrecise=function(e,r,t,a,n,i,l){u.setFromCamera(c.set(e/t*2-1,r/a*-2+1),i);if(l&&l.length>0){for(var o in l){var s=l[o];var d=s.distanceToPoint(u.ray.origin),p=-d/s.normal.dot(u.ray.direction);if(p>0){if(d<0){u.near=Math.max(u.near,p)}else{u.far=Math.min(u.far,p)}}else if(d<0){return null}}}var f=u.intersectObjects(n.children,true);if(l&&l.length>0){u.near=0;u.far=Infinity}if(f){for(var g in f){var h=f[g];var x=v(h.object);if(x.visible&&!x.isBillboard&&!x.isDetailView){h.object=x;return h}}}return null};n.prototype.hitTestPoint=function(e,r,t,a,n,i,l){u.setFromCamera(c.set(e/t*2-1,r/a*-2+1),i);if(l&&l.length>0){for(var o in l){var s=l[o];var d=s.distanceToPoint(u.ray.origin),p=-d/s.normal.dot(u.ray.direction);if(p>0){if(d<0){u.near=Math.max(u.near,p)}else{u.far=Math.min(u.far,p)}}else if(d<0){return null}}}var f=u.intersectObjects(n.children,true);if(l&&l.length>0){u.near=0;u.far=Infinity}return f.length===1?f[0].point:null};return n});
//# sourceMappingURL=HitTester.js.map