/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./MarchingCubes","../ObjectType"],function(e,r,t,n){"use strict";var a=new Float32Array(1);var i={};i.createWebGLImageRenderer=function(r,t,n){var a=new e.WebGLRenderer({canvas:r,preserveDrawingBuffer:true,antialias:true,alpha:true});a.useLegacyLights=true;a.setSize(t,n);a.outputColorSpace=e.LinearSRGBColorSpace;return a};i.createWebGLRenderer=function(r,t){var n=new e.WebGLRenderer({antialias:true,alpha:true});n.useLegacyLights=true;n.setPixelRatio(r);n.setSize(1,1);if(t){n.shadowMap.enabled=true}n.outputColorSpace=e.LinearSRGBColorSpace;return n};i._disposeMaterial=function(e){if(e.map){e.map.dispose()}if(e.lightMap){e.lightMap.dispose()}if(e.bumpMap){e.bumpMap.dispose()}if(e.normalMap){e.normalMap.dispose()}if(e.envMap){e.envMap.dispose()}if(e.alphaMap){e.alphaMap.dispose()}if(e.emissiveMap){e.emissiveMap.dispose()}if(e.aoMap){e.aoMap.dispose()}e.dispose()};i.disposeMaterial=function(e){if(e){i._disposeMaterial(e)}};i.disposeObject=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}if(r.material){i._disposeMaterial(r.material)}}};i.disposeGeometry=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}}};i.getAllTHREENodes=function(t,n,a){if(!t){return}if(!n||!a){r.error("getAllTHREENodes input parameters - all3DNodes and/or allGroupNodes are undefined.");return}t.forEach(function(r){if(r instanceof e.Mesh){n.push(r)}else if(r instanceof e.Light){n.push(r)}else if(r instanceof e.Camera){n.push(r)}else if(r instanceof e.Box3Helper){n.push(r)}else if(r instanceof e.Group){a.push(r)}if(r.children&&r.children.length>0){i.getAllTHREENodes(r.children,n,a)}})};var o=new e.Vector3;var s=function(e,r){r.makeEmpty();e.updateMatrixWorld(true);e.traverse(function(e){if(e.userData.objectType===n.Hotspot||e.userData.objectType===n.PMI){return}var t;var a;var i=e.geometry;if(i!=null){if(i.isGeometry){var s=i.vertices;for(t=0,a=s.length;t<a;t++){o.copy(s[t]);o.applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}else if(i.isBufferGeometry){var f=i.attributes.position;if(f!=null){var u=e.userData.renderGroup;for(t=u?u.firstVertex:0,a=u?u.lastVertex:f.count;t<a;t++){o.fromBufferAttribute(f,t).applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}}}});return r};i.computeObjectOrientedBoundingBox=function(e,r){var t=e.parent;var n=e.matrix.clone();var a=e.matrixAutoUpdate;e.parent=null;e.matrix.identity();e.matrixAutoUpdate=false;s(e,r);e.matrixAutoUpdate=a;e.matrix.copy(n);e.parent=t;e.updateMatrixWorld(true);return r};i.computeClusterBoundingBoxes=function(r,t,n,a){var i=new Uint8Array(t.buffer);var o,s,f,u,l,d,c,p,v,h,m,b,x;var g;var y=new e.Matrix4;var M=y.elements;var I=new e.Vector3;for(var C=0,U=r.length;C<U;++C){if(a[3+C]===0){continue}var w=new e.Box3;var k=new e.Vector3;g=0;m=r[C].additionalRenderables;o=r[C].geometry;f=o.userData.renderInstanceCount||1;s=o.contents;for(h=0;h<2;++h){for(u=0,l=s.length;u<l;++u){d=s[u].instanceIndex;for(c=0;c<f;++c){p=d*20;d++;if((i[p*4+3]&3)>0){M[0]=t[p+8];M[4]=t[p+9];M[8]=t[p+10];M[12]=t[p+11];M[1]=t[p+12];M[5]=t[p+13];M[9]=t[p+14];M[13]=t[p+15];M[2]=t[p+16];M[6]=t[p+17];M[10]=t[p+18];M[14]=t[p+19];for(v=0;v<8;++v){I.x=t[p+((v&1)>0?3:2)];I.y=t[p+((v&2)>0?5:4)];I.z=t[p+((v&4)>0?7:6)];I.applyMatrix4(y);if(h>0){g=Math.max(g,k.distanceToSquared(I))}else{w.expandByPoint(I)}}}}}for(u=0,l=m.length;u<l;++u){b=m[u];x=b.userData.renderGroup;if(x.instanceIndex===null){for(v=0;v<8;++v){I.x=x.boundingBox[p+((v&1)>0?3:0)];I.y=x.boundingBox[p+((v&2)>0?4:1)];I.z=x.boundingBox[p+((v&4)>0?5:2)];I.applyMatrix4(b.matrixWorld);if(h>0){g=Math.max(g,k.distanceToSquared(I))}else{w.expandByPoint(I)}}}}if(h===0){if(w.isEmpty()){o.boundingBox=null;o.boundingSphere=null;break}w.getCenter(k)}else{o.boundingBox=w;o.boundingSphere=new e.Sphere(k,Math.sqrt(g))}}}};i.initClustersBeforeProcessingHierarchy=function(e){for(var r=0,t=e.length;r<t;++r){e[r].additionalRenderables.length=0}};i.processUpdatedDataTexture=function(e,r,t){var n=e.userData.textureUpdateParams;if(n){r=Math.min(r,n.updatedFrom);t=Math.max(t,n.updatedTo)}var a=4;var i=a*e.image.width;var o=Math.floor(r/i);var s=Math.ceil(t/i);var f=s-o;var u=0;var l=e.image.width;var d=o*i;if(f===1){u=Math.floor((r-i*o)/a);d+=u*a;l=Math.ceil((t-d)/a)}e.userData.textureUpdateParams={xOffset:u,yOffset:o,width:l,height:f,dataOffset:d,updatedFrom:r,updatedTo:t};e.needsUpdate=true};i.prepareTextureUpdateResults=function(e,r){var t=3+e;if(!r){var n=new Uint32Array(t);n[0]=4294967295;return n}if(r.length>=t){return r}var a=new Uint32Array(t);a.set(r);return a};function f(e,r,t,n,a){for(var i=0,o=t.instanceIndex*20;i<a;++i,++o){if(e[o]!=n[i]){e[o]=n[i];r[3+t.clusterIndex]=1;if(o<r[0]){r[0]=o}if(o>r[1]){r[1]=o}}}}function u(e,r,t,n){var a=e.userData.renderGroup;if(a&&a.instanceIndex!==null){f(t,n,a,r,1)}var i=e.children;for(var o=0,s=i.length;o<s;o++){u(i[o],r,t,n)}}i.removeNodeFromClusterRenderingRecursive=function(e,r,t){u(e,a,r,t)};i.updateNodeClusterRenderingInfo=function(e,r,t,n,a){var i=e.userData;var o=i.renderGroup;if(o&&o.clusterIndex!==undefined){var s=r[o.clusterIndex];if(o.instanceIndex===null){s.additionalRenderables.push(e)}else if(n){var u=new Uint8Array(t.buffer);u[0]=0;u[1]=0;u[2]=0;if(i.initialMaterialId!==i.materialId||e.renderOrder!=0||i.highlightingColor||i.defaultMaterial||e.material.transparent===true){u[3]=2;s.additionalRenderables.push(e)}else if(i.highlightColor||i.tintColor){var l=e.material.emissive;var d=e.material.specular;if(l.r===.0235&&l.g===.0235&&l.b===.0235&&d.r===.0602&&d.g===.0602&&d.b===.0602){l=e.material.color;u[0]=255*l.r;u[1]=255*l.g;u[2]=255*l.b;u[3]=3}else{u[3]=2;s.additionalRenderables.push(e)}}else{u[3]=1}t[1]=s.isPoints?e.userData.pointSize||1:-1;var c=o.boundingBox;if(c){t[2]=c[0];t[3]=c[3];t[4]=c[1];t[5]=c[4];t[6]=c[2];t[7]=c[5]}var p=e.matrixWorld.elements;t[8]=p[0];t[9]=p[4];t[10]=p[8];t[11]=p[12];t[12]=p[1];t[13]=p[5];t[14]=p[9];t[15]=p[13];t[16]=p[2];t[17]=p[6];t[18]=p[10];t[19]=p[14];f(n,a,o,t,20)}}else if(e.isMesh||e.isLine||e.isPoints||e._vkUpdate){a[2]=1}};function l(e,r,t,n,a,i,o,s,f){if(i===o){r[a*f*f+n*f+t]=1}if(i<o){var u=e[s[0]];s[0]++;t*=2;n*=2;a*=2;var d,c,p;for(p=0;p<2;++p){for(c=0;c<2;++c){for(d=0;d<2;++d){if((u&1<<p*4+c*2+d)!==0){l(e,r,t+d,n+c,a+p,i+1,o,s,f)}}}}}}function d(e,r){var t,n,a,i;var o=r*r;var s=true;var f;while(s){s=false;f=0;for(a=0;a<r;++a){for(n=0;n<r;++n){for(t=0;t<r;++t){if(e[a*o+n*r+t]>0){t++;for(i=r-1;i>t;--i){if(e[a*o+n*r+i]>0){for(;t<i;++t){if(e[a*o+n*r+t]===0){e[a*o+n*r+t]=1;s=true}}break}}f++;break}}}}for(a=0;a<r;++a){for(t=0;t<r;++t){for(n=0;n<r;++n){if(e[a*o+n*r+t]>0){n++;for(i=r-1;i>n;--i){if(e[a*o+i*r+t]>0){for(;n<i;++n){if(e[a*o+n*r+t]===0){e[a*o+n*r+t]=1;s=true}}break}}f++;break}}}}for(n=0;n<r;++n){for(t=0;t<r;++t){for(a=0;a<r;++a){if(e[a*o+n*r+t]>0){a++;for(i=r-1;i>a;--i){if(e[i*o+n*r+t]>0){for(;a<i;++a){if(e[a*o+n*r+t]===0){e[a*o+n*r+t]=1;s=true}}break}}f++;break}}}}}return f*2}function c(e,r,t,n){var a=r*4;var i,o,s,f;switch(e){case 0:i=[t[0],t[1],t[5],t[3],t[1],t[5],t[0],t[4],t[5],t[3],t[4],t[5]];o=0;s=0;f=1;break;case 1:i=[t[0],t[1],t[2],t[0],t[4],t[2],t[3],t[1],t[2],t[3],t[4],t[2]];o=0;s=0;f=-1;break;case 2:i=[t[0],t[4],t[5],t[3],t[4],t[5],t[0],t[4],t[2],t[3],t[4],t[2]];o=0;s=1;f=0;break;case 3:i=[t[0],t[1],t[5],t[0],t[1],t[2],t[3],t[1],t[5],t[3],t[1],t[2]];o=0;s=-1;f=0;break;case 4:i=[t[3],t[1],t[5],t[3],t[1],t[2],t[3],t[4],t[5],t[3],t[4],t[2]];o=1;s=0;f=0;break;default:i=[t[0],t[1],t[5],t[0],t[4],t[5],t[0],t[1],t[2],t[0],t[4],t[2]];o=-1;s=0;f=0;break}n.points.set(i,a*3);if(n.normals!==undefined){n.normals.set([o,s,f,o,s,f,o,s,f,o,s,f],a*3)}n.indices.set([a+0,a+1,a+2,a+2,a+1,a+3],r*6)}function p(e,r,t,n,a,i){e[0]=a[0]+r*i[0];e[1]=a[1]+t*i[1];e[2]=a[2]+n*i[2];e[3]=e[0]+i[0];e[4]=e[1]+i[1];e[5]=e[2]+i[2]}function v(e,r,t,n,a,i){var o,s,f,u;var l=r*t;var d=0;var v=[(a[3]-a[0])/r,(a[4]-a[1])/t,(a[5]-a[2])/n];var h=[0,0,0,0,0,0];for(f=0;f<n;++f){for(s=0;s<t;++s){for(o=0;o<r;++o){if(e[f*l+s*r+o]>0){p(h,o,s,f,a,v);c(5,d,h,i);d++;for(u=r-1;u>=o;--u){if(e[f*l+s*r+u]>0){p(h,u,s,f,a,v);c(4,d,h,i);d++;break}}break}}}}for(f=0;f<n;++f){for(o=0;o<r;++o){for(s=0;s<t;++s){if(e[f*l+s*r+o]>0){p(h,o,s,f,a,v);c(3,d,h,i);d++;for(u=t-1;u>=s;--u){if(e[f*l+u*r+o]>0){p(h,o,u,f,a,v);c(2,d,h,i);d++;break}}break}}}}for(s=0;s<t;++s){for(o=0;o<r;++o){for(f=0;f<n;++f){if(e[f*l+s*r+o]>0){p(h,o,s,f,a,v);c(1,d,h,i);d++;for(u=n-1;u>=f;--u){if(e[u*l+s*r+o]>0){p(h,o,s,u,a,v);c(0,d,h,i);d++;break}}break}}}}return d*4}function h(e,r,t,n,a,i,o,s){const f=t==null;let u;if(i>0){u=false}else if(i<0){u=true}else if(f){u=r>n}else{u=r>n||t>a}const l=u?r:n;const d=u?t:a;const c=f?0:o*d;const p=e.tempBuffer;e.points=p.points.subarray(0,l*3);if(c>0){const r=s*o;if(p.indices.length<c){p.indices=new Uint16Array(c)}else if(r<p.previousIndexCount){p.indices.fill(0,r,p.previousIndexCount)}p.previousIndexCount=c;e.indices=p.indices.subarray(0,c)}else{e.indices=undefined}if(e.normals!==undefined){e.normals=p.normals.subarray(0,l*3)}if(e.colors!==undefined){e.colors=p.colors.subarray(0,l*3);e.colors.fill(1)}if(e.uvs!==undefined){e.uvs=p.uvs.subarray(0,l*2)}}function m(e,r,t,n){var a=t[0]<=2?Infinity:(n[3]-n[0])/t[0];var i=t[1]<=2?Infinity:(n[4]-n[1])/t[1];var o=t[2]<=2?Infinity:(n[5]-n[2])/t[2];var s=-1;if(a<=i&&a<=o){if(a!==Infinity){s=0}}else if(i<=a&&i<=o){if(i!==Infinity){s=1}}else if(o<=a&&o<=i){if(o!==Infinity){s=2}}if(s<0){return 0}a=t[0];i=t[1];o=t[2];var f=a*i;var u=a,l=i,d=o;var c=u*l;var p,v,h;if(s===0){t[0]=t[0]>>1;u=t[0];c=u*l;for(h=0;h<o;++h){for(v=0;v<i;++v){for(p=0;p<a;++p){r[h*c+v*u+p]=e[h*f+v*a+p*2]|e[h*f+v*a+p*2+1]}}}}if(s===1){t[1]=t[1]>>1;l=t[1];c=u*l;for(h=0;h<o;++h){for(v=0;v<i;++v){for(p=0;p<a;++p){r[h*c+v*u+p]=e[h*f+v*2*a+p]|e[h*f+(v*2+1)*a+p]}}}}if(s===2){t[2]=t[2]>>1;d=t[2];c=u*l;for(h=0;h<o;++h){for(v=0;v<i;++v){for(p=0;p<a;++p){r[h*c+v*u+p]=e[h*2*f+v*a+p]|e[(h*2+1)*f+v*a+p]}}}}var m=0;for(h=0;h<d;++h){for(v=0;v<l;++v){for(p=0;p<u;++p){if(r[h*c+v*u+p]>0){m++;break}}}}for(h=0;h<d;++h){for(p=0;p<u;++p){for(v=0;v<l;++v){if(r[h*c+v*u+p]>0){m++;break}}}}for(v=0;v<l;++v){for(p=0;p<u;++p){for(h=0;h<d;++h){if(r[h*c+v*u+p]>0){m++;break}}}}return m*2}i.buildEmptyMesh=function(e,r,t,n,a){var i={tempBuffer:a,points:null,normals:(r&3)>0?null:undefined,colors:(r&32)>0?null:undefined,uvs:(r&4)>0?null:undefined,indices:null};h(i,t,n,t,n,-1,3-(r&1),0);var o=i.points;o[0]=e[0];o[1]=e[1];o[2]=e[2];for(var s=1;s<t;++s){o[s*3]=e[3];o[s*3+1]=e[4];o[s*3+2]=e[5]}return i};i.buildTemporaryMesh=function(e,r,n,a,i,o,s,f){var u=s<=0;var p={tempBuffer:f,points:null,normals:(r&3)>0?null:undefined,colors:(r&32)>0?null:undefined,uvs:(r&4)>0?null:undefined,indices:null};var b=0;var x=0;var g=null;var y=0;if(!o&&i&&(u||n>=384&&a>=192)){var M=atob(i);var I=M.length;g=new Uint8Array(I);for(var C=0;C<I;++C){g[C]=M.charCodeAt(C)}y=g[0]}var U=null;var w=0;if(y>0){U=new Uint8Array(Math.pow(Math.pow(2,y),3));w=Math.pow(2,y);var k=new Uint32Array(2);k[0]=1;l(g,U,0,0,0,0,y,k,w);var A=t.count(U,w);var B=u?21845:Math.min(n/3,a);if(!u&&A>B){x=d(U,w);A=t.count(U,w)}if(A<=B){h(p,A*3,A,n,a,s,3,A);t.march(U,w,e,p.points,p.normals,p.indices);b=A*3}}if(b===0&&w>=2){var G=Math.floor(Math.min(n/4,a/2));if(u){G=x}var R=new Uint8Array(w*w*w/2);var S=[w,w,w];var D=false;var L=0;for(;;){if(x<=G){h(p,x*4,x*2,n,a,s,3,x*2);b=v(D?R:U,S[0],S[1],S[2],e,p);break}x=L===4?0:m(D?R:U,D?U:R,S,e);if(!x){break}D=!D;L++}}if(b===0){h(p,24,12,n,a,s,3,12);for(;b<6;++b){c(b,b,e,p)}b=24}var P=p.points;for(var T=b,E=P.length/3;T<E;++T){P[T*3]=P[0];P[T*3+1]=P[1];P[T*3+2]=P[2]}return p};function b(e,r,t){const n=e.updateRange;if(n.count<0){n.offset=r;n.count=t}else{n.count+=n.offset;n.offset=Math.min(n.offset,r);n.count=Math.max(n.count,r+t)-n.offset}}i.updateClusterAttrib=function(e,r,t,n){var a=e.getAttribute(r);a.array.set(n,t);b(a,t,n.length)};i.updateClusterIndices=function(e,r,t,n,a){var i=e.getIndex();b(i,n,a);var o=i.array;for(var s=0;s<a;++s){o[n+s]=t+r[s]}};i._updateClusterInstanceAttribute=function(e,r,t,n,a){const i=e.getAttribute("clusterInstance");const o=e.getAttribute("position").array;const s=r+t;const f=i.array;const u=new Set;for(let t=r,i=r*3;t<s;t++,i+=3){let r;u.clear();for(let e=0;e<a.length;e++){const t=a[e];if(t.containsPoint(o[i],o[i+1],o[i+2])&&!u.has(t.node)){if(t.type!==1){r=t;break}else{u.add(t.node)}}}if(r){r.node.userData.renderGroup.clusterIndex=e.userData.clusterIndex}f[t]=r?r.instanceIndex:n}b(i,r,t);i.needsUpdate=true};i._updateGeometryClusterInstance=function(e,r){const t=e.geometry;if(t.userData.isPointCloud){this._updateClusterInstanceAttribute(t,e.vertexStart,e.vertexCount,e.instanceIndex,r)}};i.updateClusterGeometry=function(e,r,t,n,a,o,s){if(r.length===e.vertexCount*3&&(!o||!o.length||o.length===e.indexCount)){var f=e.geometry;var u=!f.userData.isPolyline;var l=e.instanceIndex;var d=f.contents;for(var c=0,p=d.length;c<p;++c){if(d[c].instanceIndex===l){if(d[c].isFinal!==true){d[c].isFinal=true;var v=e.vertexStart;i.updateClusterAttrib(f,"position",v*3,r);if(t&&t.length&&u){i.updateClusterAttrib(f,"normal",v*3,t)}if(n&&n.length){i.updateClusterAttrib(f,"color",v*3,n)}if(a&&a.length){i.updateClusterAttrib(f,"uv",v*2,a)}if(o&&o.length){i.updateClusterIndices(f,o,v,e.indexStart,e.indexCount)}if(s?.length>0){i._updateGeometryClusterInstance(e,s)}if(f.shouldUpload<1){f.shouldUpload=1}}return true}}}return false};i.prepareClustersForGpuUpload=function(e){var r,t,n,a,i;var o=e.length;var s=0;for(var f=0;f<o;++f){r=e[f].geometry;t=r.shouldUpload;if(t===1&&o>=100){n=r.contents;i=n.length;for(a=0;a<i;++a){if(!n[a].isFinal){t=0;s++;break}}}if(t>0){r.shouldUpload=0;t=r.getIndex();if(t){t.needsUpdate=true}t=r.attributes;t.position.needsUpdate=true;if(t.normal){t.normal.needsUpdate=true}if(t.color){t.color.needsUpdate=true}if(t.uv){t.uv.needsUpdate=true}if(t.clusterInstance){t.clusterInstance.needsUpdate=true}}}return s};i.increaseCurrentInstance=function(e){if(e.currentInstanceIndex<e.maxInstanceIndex){e.currentInstanceIndex++}else{r.error("Maximum number of instances in a texture reached!")}};i.partitionCluster=function(e,r,t,n){var a;var i=null;var o=r.length-1;for(var s=0,f=e.length;s<f;++s){a=e[s];if(!i||i.verts+a.verts>65536){i={verts:0,elems:0};r.push(i);o++}t.set(a.submeshId,o);n[a.meshIndex].submeshes[a.submeshIndex].clusterIndex=o;i.verts+=a.verts;i.elems+=a.elems}};return i});
//# sourceMappingURL=ThreeUtils.js.map