/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ViewStateManagerBase","../thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight","../AnimationTrackType","../AnimationTrackValueType","../AnimationMath","../NodeContentType","./ThreeUtils","sap/ui/core/Core","../TransformationMatrix"],function(e,t,i,r,n,a,o,s,l,u,c,f,h,d,p,y,v,g,_,m,A,w){"use strict";var C;var b=t.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{library:"sap.ui.vk"}});var S=b.getMetadata().getParent().getClass().prototype;b.prototype.init=function(){if(S.init){S.init.call(this)}this._nodeHierarchy=null;this._nodeStates=new Map;this._selectedNodes=new Set;this._outlineRenderer=new f(1);this._outlinedNodes=new Set;this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1);this._visibilityTracker=new C;this._showSelectionBoundingBox=true;this._boundingBoxesScene=new i.Scene;this._selectedNodesBoundingBox=new i.Box3;this._selectionColor=new i.Color(12632064);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._nodesTransitionHelper=new c;this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new h;this._highlightPlayer.setViewStateManager(this);this._transitionPlayer=new h;this._transitionPlayer.setViewStateManager(this);e.getEventBus().subscribe("sap.ui.vk","activateView",this._onActivateView,this)};b.prototype._clearBoundingBoxScene=function(){var e=[];var t=[];m.getAllTHREENodes([this._boundingBoxesScene],e,t);e.forEach(function(e){m.disposeObject(e);e.parent.remove(e)});t.forEach(function(e){e.parent.remove(e)})};b.prototype.exit=function(){e.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onActivateView,this);if(this._nodesTransitionHelper){this._nodesTransitionHelper.destroy()}if(this._outlineRenderer){this._outlineRenderer.dispose();this._outlineRenderer=null}if(this._boundingBoxesScene){this._clearBoundingBoxScene();this._boundingBoxesScene=null}};b.prototype._setContent=function(e){if(e===this._scene){return this}var t=null;if(e&&e instanceof s){t=e}this._setScene(t);if(t){var i=t.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrentView(this._currentView)}}return this};b.prototype._setScene=function(e){if(this._boundingBoxesScene){this._clearBoundingBoxScene()}this._boundingBoxesScene=new i.Scene;this._setNodeHierarchy(e?e.getDefaultNodeHierarchy():null);if(e){e.setViewStateManager(this)}this._scene=e;if(this._scene){var t=this._scene.getInitialView();if(t){this.activateView(t)}}return this};b.prototype._setNodeHierarchy=function(e){var t=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear()}if(e){this._nodeHierarchy=e;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var i=this;var r=e.findNodesByName();r.forEach(function(e){i._initialState[e.visible?"visible":"hidden"].push(e)});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden})}if(e!==t){this.fireNodeHierarchyReplaced({oldNodeHierarchy:t,newNodeHierarchy:e})}return this};b.prototype._getJointByChildNode=function(e){var t;if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===e){t=this._jointCollection[i];break}}}return t};b.prototype._handleNodeReplaced=function(e){var t=e.getParameter("ReplacedNodeRef");var i=e.getParameter("ReplacementNodeRef");if(this.getSelectionState(t)){this.setSelectionStates(i,t)}};b.prototype._handleNodeUpdated=function(e){var t=e.getParameter("nodeRef");if(this.getSelectionState(t)){this.setSelectionStates([],t);this.setSelectionStates(t,[])}};b.prototype._handleNodeRemoving=function(e){var t=e.getParameter("nodeRef");if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===t){this._jointCollection[i].node=null;break}if(this._jointCollection[i].parent===t){this._jointCollection[i].parent=null;break}}}if(this.getSelectionState(t)){this.setSelectionStates([],t,true,true)}};b.prototype._renderOutline=function(e,t,r){var n=a(this._outlineColorABGR);var o=new i.Color(n.red/255,n.green/255,n.blue/255);this._outlineRenderer.render(e,t,r,Array.from(this._outlinedNodes),o,this._jointCollection)};b.prototype.getNodeHierarchy=function(){return this._nodeHierarchy};b.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null};b.prototype.getCurrentView=function(){var e=A.byId(this.getViewManager());if(!e){return null}var t=e.getActiveView();return t};b.prototype.resetNodeProperty=function(e,t){var r=this.getCurrentView();if(!r){return}var n=r.getNodeInfos();if(n){var a=[];a.push(e);if(this._jointCollection&&this._jointCollection.length>0){for(var o=0;o<this._jointCollection.length;o++){var s=this._jointCollection[o];if(!s.node||!s.parent){continue}var l=s.parent;if(l!==e){break}a.push(s.node)}}n.forEach(function(r){if(!a.includes(r.target)){return}if(!t||t!==y.Opacity){var o={nodeRefs:[],positions:[]};var s;var l;var u;if(r.transform){var c=new i.Vector3;var f=new i.Quaternion;var h=new i.Vector3;var d=T(r.transform);d.decompose(c,f,h);s=c.toArray();l=f.toArray();u=h.toArray()}else if(r[y.Scale]&&r[y.Rotate]&&r[y.Translate]){s=r[y.Translate].slice();l=r[y.Rotate].slice();u=r[y.Scale].slice()}if(s){o.nodeRefs.push(r.target);o.positions.push({translation:s,quaternion:l,scale:u});this.setTransformation(o.nodeRefs,o.positions)}}else{e._vkSetOpacity(r.opacity,this._jointCollection);var p={changed:e,opacity:n.opacity};this.fireOpacityChanged(p)}}.bind(this))}};b.prototype.getVisibilityComplete=function(){var e=this.getNodeHierarchy(),t=e.findNodesByName(),i=[],r=[];t.forEach(function(t){var n=e.createNodeProxy(t);var a=n.getVeId();e.destroyNodeProxy(n);if(a){if(this.getVisibilityState(t)){i.push(a)}else{r.push(a)}}},this);return{visible:i,hidden:r}};b.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();return this};b.prototype.getVisibilityState=function(e){if(Array.isArray(e)){return e.map(function(e){return e?e.visible:false})}return e?e.visible:false};b.prototype.setVisibilityState=function(e,t,i,r){if(!Array.isArray(e)){e=[e]}var n=Array.isArray(t);var a=[];var o=e;if(i){o=[];e.forEach(function(e,i){var r=this._collectNodesRecursively(e);o=o.concat(r);var s=a.length;a.length=s+r.length;a.fill(n?t[i]:t,s)},this)}else if(!n){a.length=o.length;a.fill(t)}else{a=t}var s=[];var l=new Set;var u=o.filter(function(e,t){if(e==null||e.userData.skipIt&&e.visible||l.has(e)){return false}l.add(e);var i=e?e.visible!=a[t]:false;if(i){s.push(a[t])}return i},this);if(u.length>0){var c={visible:[],hidden:[]};u.forEach(function(e,t){e.visible=s[t];var i=e.children;if(i.length===1&&i[0].userData.skipIt){i[0].visible=e.visible}c[e.visible?"visible":"hidden"].push(e);if(r&&e.visible){var n=e.parent;while(n){n.visible=true;n=n.parent}}},this);if(this.getShouldTrackVisibilityChanges()){u.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker)}this.fireVisibilityChanged(c)}return this};b.prototype.enumerateSelection=function(e){this._selectedNodes.forEach(e);return this};b.prototype.enumerateOutlinedNodes=function(e){this._outlinedNodes.forEach(e);return this};b.prototype.getSelectionState=function(e){var t=this._selectedNodes;function i(e){return t.has(e)}return Array.isArray(e)?e.map(i):i(e)};b.prototype._getSelectionComplete=function(){var e=this.getNodeHierarchy(),t=[],i=[];function r(t){var i=e.createNodeProxy(t);var r=i.getVeId();e.destroyNodeProxy(i);return r}this._selectedNodes.forEach(function(e){var i=r(e);if(i){t.push(i)}});this._outlinedNodes.forEach(function(e){var t=r(e);if(t){i.push(t)}});return{selected:t,outlined:i}};b.prototype._isAChild=function(e,t){var i=e.parent;while(i){if(t.has(i)){return true}i=i.parent}return false};b.prototype._AddBoundingBox=function(e){e._vkCalculateObjectOrientedBoundingBox()};b.prototype._RemoveBoundingBox=function(e){delete e.userData.boundingBox};b.prototype._expandBoundingBoxWithSelected=function(e){if(!this._selectedNodesBoundingBox.isEmpty()){e.union(this._selectedNodesBoundingBox)}};b.prototype._updateBoundingBoxes=function(){var e;var t=new i.Vector3;var r=new i.Vector3;var n=new i.Quaternion;var a=new i.Matrix4;var o,s;this._selectedNodesBoundingBox.makeEmpty();var l=null;var u=this._selectedNodes.size;if(u>0){l=new Float32Array(u*16);u=0;this._selectedNodes.forEach(function(i){i._vkCalculateObjectOrientedBoundingBox();e=i.userData.boundingBox;if(e&&!e.isEmpty()){e.getCenter(t);e.getSize(r);r.multiplyScalar(.5);a.compose(t,n,r);a.premultiply(i.matrixWorld);s=a.elements;for(o=0;o<16;++o){l[u++]=s[o]}for(o=0;o<8;++o){t.x=(o&1)>0?1:-1;t.y=(o&2)>0?1:-1;t.z=(o&4)>0?1:-1;t.applyMatrix4(a);this._selectedNodesBoundingBox.expandByPoint(t)}}},this);if(u!==l.length){l=l.slice(0,u)}}var c=this._boundingBoxesScene.children.length>0?this._boundingBoxesScene.children[0]:null;var f=false;var h=false;if(u>0){if(!c){h=true}else{var d=c.geometry.attributes.itm;if(u===d.array.length){s=d.array;for(o=0;o<u;++o){if(l[o]!==s[o]){d.set(l);d.version++;break}}}else{f=true;h=true}}}else if(c){f=true}var p=null;if(f){if(h){p=c.material}this._boundingBoxesScene.remove(c);m.disposeObject(c);c=null}if(h){if(!p){p=new i.LineBasicMaterial({color:this._selectionColor,onBeforeCompile:function(e){e.vertexShader=("attribute mat4 itm;\n"+e.vertexShader).replace("#include <begin_vertex>","#include <begin_vertex>\ntransformed = (itm * vec4(transformed, 1.0)).xyz;\n")}})}var y=new i.InstancedBufferGeometry;y.setIndex(new i.BufferAttribute(new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),1));y.setAttribute("position",new i.Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3));y.setAttribute("itm",new i.InstancedBufferAttribute(l,16));c=new i.LineSegments(y,p);c.frustumCulled=false;this._boundingBoxesScene.add(c)}};b.prototype.setShowSelectionBoundingBox=function(e){this._showSelectionBoundingBox=e;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(e){this._AddBoundingBox(e)}.bind(this))}else{this._selectedNodes.forEach(function(e){this._RemoveBoundingBox(e)}.bind(this))}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]})};b.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox};b.prototype._isAncestorSelected=function(e){e=e.parent;while(e){if(this._selectedNodes.has(e)){return true}e=e.parent}return false};b.prototype._updateHighlightColor=function(e,t){var i=t||this._selectedNodes.has(e);var r=e._vkGetNodeContentType();if(r===_.Background||r===_.Symbol){return}else{e.userData.highlightColor=i?this._highlightColorABGR:undefined;e._vkUpdateMaterialColorAndOpacity();var n=e.children;for(var a=0,o=n.length;a<o;a++){var s=n[a].userData;if(s&&s.objectType===l.Hotspot){continue}this._updateHighlightColor(n[a],i)}}};b.prototype.setSelectionState=function(e,t,i,r){if(!e){return this}if(!Array.isArray(e)){e=[e]}e=(i||this.getRecursiveSelection()?this._collectNodesRecursively(e):e).filter(function(e,t,i){return i.indexOf(e)===t});if(this.getRecursiveSelection()&&!t){e=this._nodeHierarchy._appendAncestors(e)}var n=e.filter(function(e){return this._selectedNodes.has(e)!==t},this);if(n.length>0){n.forEach(function(e){if(e){this._selectedNodes[t?"add":"delete"](e);if(this._showSelectionBoundingBox){this[t?"_AddBoundingBox":"_RemoveBoundingBox"](e)}}},this);n.forEach(function(e){if(e){this._updateHighlightColor(e,t||this._isAncestorSelected(e))}},this);if(!r){this.fireSelectionChanged({selected:t?n:[],unselected:t?[]:n})}}return this};b.prototype.setSelectionStates=function(e,t,i,r){if(!Array.isArray(e)){e=[e]}if(!Array.isArray(t)){t=[t]}e=i||this.getRecursiveSelection()?this._collectNodesRecursively(e):e;t=i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t;if(this.getRecursiveSelection()){t=this._nodeHierarchy._appendAncestors(t,e)}var n=e.filter(function(e){return this._selectedNodes.has(e)===false},this);var a=t.filter(function(e){return this._selectedNodes.has(e)===true},this);if(n.length>0||a.length>0){n.forEach(function(e){this._selectedNodes.add(e);this._updateHighlightColor(e,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(e)}},this);a.forEach(function(e){this._selectedNodes.delete(e);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(e)}},this);a.forEach(function(e){this._updateHighlightColor(e,this._isAncestorSelected(e))},this);if(!r){this.fireSelectionChanged({selected:n,unselected:a})}}return this};b.prototype.setOutlineColor=function(e){switch(typeof e){case"number":this._outlineColorABGR=e;break;case"string":if(sap.ui.core.CSSColor.isValid(e)){this._outlineColorABGR=o(r(e))}break;default:return this}this.fireOutlineColorChanged({outlineColor:n(a(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this};b.prototype.getOutlineColor=function(e){return e?this._outlineColorABGR:n(a(this._outlineColorABGR))};b.prototype.getOutliningState=function(e){var t=this._outlinedNodes;function i(e){return t.has(e)}return Array.isArray(e)?e.map(i):i(e)};b.prototype.setOutliningStates=function(e,t,i,r){if(!Array.isArray(e)){e=[e]}if(!Array.isArray(t)){t=[t]}e=i||this.getRecursiveOutlining()?this._collectNodesRecursively(e):e;t=i||this.getRecursiveOutlining()?this._collectNodesRecursively(t):t;if(this.getRecursiveOutlining()){t=this._nodeHierarchy._appendAncestors(t,e)}var n=e.filter(function(e){return this._outlinedNodes.has(e)===false},this);var a=t.filter(function(e){return this._outlinedNodes.has(e)===true},this);if(n.length>0||a.length>0){n.forEach(function(e){this._outlinedNodes.add(e)},this);a.forEach(function(e){this._outlinedNodes.delete(e)},this);if(!r){this.fireOutliningChanged({outlined:n,unoutlined:a})}}return this};b.prototype.setOutlineWidth=function(e){this._outlineWidth=e;this._outlineRenderer.setOutlineWidth(e);this.fireOutlineWidthChanged({width:e});return this};b.prototype.getOutlineWidth=function(){return this._outlineWidth};b.prototype._collectNodesRecursively=function(e){var t=[];var i=this._nodeHierarchy;(Array.isArray(e)?e:[e]).forEach(function e(r){t.push(r);i.enumerateChildren(r,e,false,true)});return t};b.prototype._getOpacity=function(e){return e.userData.opacity!==undefined?e.userData.opacity:null};b.prototype.getOpacity=function(e){if(Array.isArray(e)){return e.map(this._getOpacity,this)}else{return this._getOpacity(e)}};b.prototype.setOpacity=function(e,t,i){if(!Array.isArray(e)){e=[e]}var r=Array.isArray(t);if(t==null){t=undefined}else if(r){t.forEach(function(e,i){if(e==null){t[i]=undefined}})}var n=[];var a=e;if(!r){n.length=a.length;n.fill(t)}else{n=t}var o=[];var s=new Set;var l=a.filter(function(e,t){if(s.has(e)){return false}s.add(e);var i=e?e.userData.opacity!==n[t]:false;if(i){o.push(n[t])}return i},this);if(l.length>0){l.forEach(function(e,t){e._vkSetOpacity(o[t],this._jointCollection)},this);var u={changed:l,opacity:r?o:o[0]};this.fireOpacityChanged(u)}return this};b.prototype._getTintColorABGR=function(e){return e.userData.tintColor!==undefined?e.userData.tintColor:null};b.prototype._getTintColor=function(e){return e.userData.tintColor!==undefined?n(a(e.userData.tintColor)):null};b.prototype.getTintColor=function(e,t){var i=t?"_getTintColorABGR":"_getTintColor";if(Array.isArray(e)){return e.map(this[i],this)}else{return this[i](e)}};b.prototype.setTintColor=function(e,t,i){if(!Array.isArray(e)){e=[e]}var n=function(e){var t=null;switch(typeof e){case"number":t=e;break;case"string":if(sap.ui.core.CSSColor.isValid(e)){t=o(r(e))}break;default:t=undefined;break}return t};var a=Array.isArray(t);var s=[];var l=e;if(i){l=[];e.forEach(function(e,i){var r=this._collectNodesRecursively(e);l=l.concat(r);var n=s.length;s.length=n+r.length;s.fill(a?t[i]:t,n)},this)}else if(!a){s.length=l.length;s.fill(t)}else{s=t}var u=[];var c=new Set;var f=l.filter(function(e,t){if(c.has(e)){return false}c.add(e);var i=e?e.userData.tintColor!==n(s[t]):false;if(i){u.push(s[t])}return i},this);if(f.length>0){var h=[];f.forEach(function(e,t){var i=n(u[t]);e._vkSetTintColor(i);h.push(i)},this);var d={changed:f,tintColor:a?u:u[0],tintColorABGR:a?h:h[0]};this.fireTintColorChanged(d)}return this};b.prototype.setHighlightColor=function(e){switch(typeof e){case"number":this._highlightColorABGR=e;break;case"string":if(sap.ui.core.CSSColor.isValid(e)){this._highlightColorABGR=o(r(e))}break;default:return this}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(e){this._updateHighlightColor(e,true)},this)}this.fireHighlightColorChanged({highlightColor:n(a(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this};b.prototype.getHighlightColor=function(e){return e?this._highlightColorABGR:n(a(this._highlightColorABGR))};b.prototype.getRestTransformationUsingJoint=function(e){var t=this._getJointByChildNode(e);if(t&&t.translation&&t.scale&&t.quaternion){return t}else{return this.getRestTransformation(e)}};b.prototype.getRelativeTransformation=function(e){var t=function(e){var t=this.getRestTransformation(e);var r=[e.position.x-t.translation[0],e.position.y-t.translation[1],e.position.z-t.translation[2]];var n=(new i.Quaternion).fromArray(t.quaternion).invert().premultiply(e.quaternion).toArray();var a=[e.scale.x/t.scale[0],e.scale.y/t.scale[1],e.scale.z/t.scale[2]];return{translation:r,quaternion:n,scale:a}}.bind(this);if(!Array.isArray(e)){return t(e)}var r=[];e.forEach(function(e){r.push(t(e))});return r};b.prototype.getTransformationWorld=function(e){var t=function(e){var t=new i.Vector3;var r=new i.Vector3;var n=new i.Quaternion;e.updateMatrixWorld();e.matrixWorld.decompose(t,n,r);return{translation:t.toArray(),quaternion:n.toArray(),scale:r.toArray()}};if(!Array.isArray(e)){return t(e)}var r=[];e.forEach(function(e){r.push(t(e))});return r};b.prototype.getTransformation=function(e){var t=function(e){return{translation:this.getTranslation(e),quaternion:this.getRotation(e,u.Quaternion),scale:this.getScale(e)}}.bind(this);if(!Array.isArray(e)){return t(e)}var i=[];e.forEach(function(e){i.push(t(e))});return i};b.prototype.getTranslation=function(e){var t=function(e){return e.position.toArray()};if(!Array.isArray(e)){return t(e)}var i=[];e.forEach(function(e){i.push(t(e))});return i};b.prototype.getScale=function(e){var t=function(e){return e.scale.toArray()};if(!Array.isArray(e)){return t(e)}var i=[];e.forEach(function(e){i.push(t(e))});return i};b.prototype._convertQuaternionToAngleAxis=function(e){if(e.w>1){e.normalize()}if(e.w>.9999&&e.x<1e-4&&e.y<1e-4&&e.z<1e-4){e.w=1;e.x=0;e.y=0;e.z=0}var t=2*Math.acos(e.w);var i;var r;var n;var a=Math.sqrt(1-e.w*e.w);if(a<1e-4){i=1;r=0;n=0}else{i=e.x/a;r=e.y/a;n=e.z/a}return[i,r,n,t]};b.prototype.getRotation=function(e,t){var r=function(e){var r=e.quaternion;var n;switch(t){case u.AngleAxis:n=this._convertQuaternionToAngleAxis(r);break;case u.Euler:var a=new i.Euler;a.setFromQuaternion(r);n=a.toArray();break;default:n=r.toArray()}return n};if(!Array.isArray(e)){return r(e)}var n=[];e.forEach(function(e){n.push(r(e))});return n};b.prototype.setTransformation=function(e,t){var r=Array.isArray(e);if(!Array.isArray(e)){e=[e]}var n={changed:[],transformation:[]};var a=function(e){return{position:e.position.toArray(),quaternion:e.quaternion.toArray(),scale:e.scale.toArray()}};if(!t){e.forEach(function(e){if(e.userData.position&&e.userData.quaternion&&e.userData.scale){e.position=e.userData.position;e.quaternion=e.userData.quaternion;e.scale=e.userData.scale;e.updateMatrix();delete e.userData.position;delete e.userData.quaternion;delete e.userData.scale}n.changed.push(e);n.transformation.push(a(e))},this)}else{if(!Array.isArray(t)){t=[t]}e.forEach(function(e,r){var o=e.userData;if(!o){return}if(!o.position){o.position=e.position.clone()}if(!o.quaternion){o.quaternion=e.quaternion.clone()}if(!o.scale){o.scale=e.scale.clone()}var s=t[r];if(s.transform){var l=T(s.transform);l.decompose(e.position,e.quaternion,e.scale)}else{e.position.fromArray(s.translation);e.scale.fromArray(s.scale);if(s.quaternion){e.quaternion.fromArray(s.quaternion)}else if(s.angleAxis){var u=new i.Vector3(s.angleAxis[0],s.angleAxis[1],s.angleAxis[2]);e.quaternion.setFromAxisAngle(u,s.angleAxis[3])}else if(s.euler){var c=new i.Euler;c.fromArray(s.euler[0],s.euler[1],s.euler[2],s.euler[3]);e.quaternion.setFromEuler(c)}}e.updateMatrix();n.changed.push(e);n.transformation.push(a(e))},this)}if(!r){n.changed=n.changed[0];n.transformation=n.transformation[0]}this.fireTransformationChanged(n);return this};b.prototype.getJoints=function(){return this._jointCollection};b.prototype.setJoints=function(e,t){this._jointCollection=[];this._playbackAssociatedWithJoints=null;if(!e){return this}var i=new Set;var r=new Map;e.forEach(function(e){if(!e.node||!e.parent){return}i.add(e.node);r.set(e.node,e)});while(i.size>0){var n=i.values().next().value;i.delete(n);var a=r.get(n);var o=[a];var s=[];var l=a.parent;while(l){a=r.get(l);if(a!==undefined){if(i.delete(l)){o.push(a)}if(s.length>0){a.nodesToUpdate=a.nodesToUpdate||[];while(s.length>0){var u=s.pop();if(a.nodesToUpdate.indexOf(u)>=0){break}a.nodesToUpdate.push(u)}}s.length=0;l=a.parent}else{s.push(l);l=l.parent}}while(o.length>0){this._jointCollection.push(o.pop())}}if(this._jointCollection&&this._jointCollection.length>0){this._playbackAssociatedWithJoints=t;this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}e.translation=null;e.scale=null;e.quaternion=null;e.opacity=null;if(e.node.userData){e.node.userData.offsetTranslation=null;e.node.userData.offsetQuaternion=null;e.node.userData.offsetScale=null;e.node.userData.originalRotationType=null;e.node.userData.offsetOpacity=null}});this._jointCollection.forEach(function(e){this._updateJointNode(e,this._playbackAssociatedWithJoints)}.bind(this))}return this};b.prototype._updateJointNode=function(e,t){if(!e.node||!e.parent){return}if(e.translation&&e.quaternion&&e.scale&&e.opacity){return}var r=new Map;if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}r.set(e.node,e)})}var n,a,o,s,l,u;var c=e.node;var f=new i.Matrix4;var h,d=1;while(c){u=this.getRestOpacity(c);l=this.getRestTransformation(c);if(!l){c=c.parent;continue}n=new i.Vector3(l.translation[0],l.translation[1],l.translation[2]);a=new i.Vector3(l.scale[0],l.scale[1],l.scale[2]);o=new i.Quaternion(l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]);h=u;if(t){var p=this._getEndPropertyInPreviousPlayback(c,y.Translate,t,true);if(p){n.x+=p[0];n.y+=p[1];n.z+=p[2]}var v=this._getEndPropertyInPreviousPlayback(c,y.Scale,t,true);if(v){a.x*=v[0];a.y*=v[1];a.z*=v[2]}var g=this._getEndPropertyInPreviousPlayback(c,y.Rotate,t,true);if(g){var _=new i.Quaternion(g[0],g[1],g[2],g[3]);o=_.multiply(o)}var m=this._getEndPropertyInPreviousPlayback(c,y.Opacity,t,true);if(m!=null){h*=m}}s=(new i.Matrix4).compose(n,o,a);f.premultiply(s);d*=h;c=c.parent}var A=e.parent;var w=new i.Matrix4;var C=1;while(A){var b=r.get(A);if(b){if(!b.translation){this._updateJointNode(b)}n=new i.Vector3(b.translation[0],b.translation[1],b.translation[2]);a=new i.Vector3(b.scale[0],b.scale[1],b.scale[2]);o=new i.Quaternion(b.quaternion[0],b.quaternion[1],b.quaternion[2],b.quaternion[3]);h=b.opacity;A=b.parent}else{u=this.getRestOpacity(A);l=this.getRestTransformation(A);if(!l){A=A.parent;continue}n=new i.Vector3(l.translation[0],l.translation[1],l.translation[2]);a=new i.Vector3(l.scale[0],l.scale[1],l.scale[2]);o=new i.Quaternion(l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]);h=u;if(t){var S=this._getEndPropertyInPreviousPlayback(A,y.Translate,t,true);if(S){n.x+=S[0];n.y+=S[1];n.z+=S[2]}var x=this._getEndPropertyInPreviousPlayback(A,y.Scale,t,true);if(x){a.x*=x[0];a.y*=x[1];a.z*=x[2]}var T=this._getEndPropertyInPreviousPlayback(A,y.Rotate,t,true);if(T){var N=new i.Quaternion(T[0],T[1],T[2],T[3]);o=N.multiply(o)}var R=this._getEndPropertyInPreviousPlayback(A,y.Opacity,t,true);if(R!=null){h*=R}}A=A.parent}s=(new i.Matrix4).compose(n,o,a);w.premultiply(s);C*=h}var k=w.copy(w).invert().multiply(f);k.decompose(n,o,a);e.translation=n.toArray();e.quaternion=o.toArray();e.scale=a.toArray();var V=function(e,t){if(e===t){return 1}else if(Math.abs(t)<1e-4){return 1}return e/t};e.opacity=V(d,C)};b.prototype._propagateOpacityToJointChildren=function(e,t){if(!e||!t||e.length!==t.length){return this}if(!this._jointCollection||!this._jointCollection.length){return this}var i=new Map;this._jointCollection.forEach(function(e){var t=i.get(e.parent);if(!t){t=[];i.set(e.parent,t)}t.push(e)});var r=function(e,t){if(e.opacity!=null&&e.node&&e.node.userData){e.node.userData.opacity=e.opacity*t;if(e.node.userData.offsetOpacity!=null){e.node.userData.opacity*=e.node.userData.offsetOpacity}}};e.forEach(function(e,n){var a=i.get(e);if(a){a.forEach(function(e){r(e,t[n])})}});return this};b.prototype._updateMaterialInNode=function(e){var t=e.target;for(var i=0,r=t.children.length;i<r;i++){var n=t.children[i];if(n.userData.animatedColor){n._vkUpdateMaterialColorAndOpacity()}}var a=e.materialId;if(t.userData.materialId!==a){t.userData.materialId=a;this._scene._setNodeMaterial(t,a)}};b.prototype.getSymbolNodes=function(e){var t=this.getCurrentView()||this._scene.getViews()[0];var i=t?t.getNodeInfos().reduce(function(t,i){if(i.target._vkGetNodeContentType()===_.Symbol&&i.target.parent){if(!e||e===i.target.userData.treeNode.sid){t.push(i.target)}}return t},[]):[];return i};var x={sphere:"360Image",plane:"2DImage"};b.prototype._getBackgroundNodeInfos=function(){var e=null,t=[];function i(t){if(t.visible){if(t._vkGetNodeContentType()===_.Background&&x[t.name]){e=t;return}var r=t.children;for(var n=0,a=r.length;n<a&&e===null;n++){i(r[n])}}}i(this._scene.getSceneRef());if(e){t=e.parent.children.filter(function(e){return e._vkGetNodeContentType()===_.Background})}return{current:e,all:t}};b.prototype.getBackgroundImageType=function(){var e=this._getBackgroundNodeInfos().current;return e?x[e.name]:null};b.prototype.setBackgroundImageType=function(e){var t=this._getBackgroundNodeInfos();var i=t.all.find(function(t){return e===x[t.name]});if(i&&!this.getVisibilityState(i)){if(t.current){t.current.visible=false}i.visible=true;this.setVisibilityState(t.all,false,false);this.setVisibilityState(i,true,false)}return i};function T(e){var t=new i.Matrix4;if(e.length===3){t.setPosition((new i.Vector3).fromArray(e))}else if(e.length===12){t.fromArray(w.convertTo4x4(e))}else if(e.length===16){t.fromArray(e.slice())}else{throw"Invalid matrix format"}return t}b.prototype._resetNodesStatusByCurrentView=function(e,t,r){var n=this.getNodeHierarchy();if(n){var a;if(e){a=e.getPlaybacks()}var o=e.getNodeInfos();if(o){this._nodesTransitionHelper.clear();var s={nodeRefs:[],positions:[]};var l=new i.Vector3;var u=new i.Quaternion;var c=new i.Vector3;o.forEach(function(e){if(e.target===null){return}if(e.transform){var t=T(e.transform);if(!g.equalMatrices(t,e.target.matrix,1e-6)){if((!a||!a.length)&&r){var i=n.createNodeProxy(e.target);this._nodesTransitionHelper.setNodeForDisplay(i,t)}else{t.decompose(l,u,c);s.nodeRefs.push(e.target);s.positions.push({translation:l.toArray(),quaternion:u.toArray(),scale:c.toArray()})}}}else if(e[y.Scale]&&e[y.Rotate]&&e[y.Translate]){s.nodeRefs.push(e.target);s.positions.push({translation:e[y.Translate].slice(),quaternion:e[y.Rotate].slice(),scale:e[y.Scale].slice()})}}.bind(this));if(e.userData&&e.userData.nodeStartDataByAnimation){e.userData.nodeStartDataByAnimation.forEach(function(e,t){if(e[y.Translate]&&e[y.Rotate]&&e[y.Scale]){s.nodeRefs.push(t);s.positions.push({translation:e[y.Translate].slice(),quaternion:e[y.Rotate].slice(),scale:e[y.Scale].slice()})}},this)}if(s.nodeRefs.length){this.setTransformation(s.nodeRefs,s.positions)}if(t){var f=[];var h=[];o.forEach(function(e){if(!e.target.userData.skipIt){(e.visible?f:h).push(e.target)}});this.setVisibilityState(n.getChildren()[0].children,false,true);if(this.getSymbolNodes().length){this.getSymbolNodes().forEach(function(e){e.traverse(function(e){e.visible=true})})}this.setVisibilityState(f,true,false);this.setVisibilityState(h,false,false);this._startViewChangeNodeTransition()}}}};b.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var e=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){e=false});var t=function(){if(e){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(t)}}.bind(this);window.requestAnimationFrame(t)};b.prototype._resetNodesMaterialAndOpacityByCurrentView=function(e){if(!e){return}var t=e.getNodeInfos();if(t){t.forEach(function(e){if(!e.target){return}this._updateMaterialInNode(e)}.bind(this));t.forEach(function(e){if(!e.target||!e.target.userData){return}e.target.userData.opacity=e.opacity});var i=this._scene.getSceneRef();i._vkSetOpacity(undefined,this._jointCollection)}this._selectedNodes.forEach(function(e){this._updateHighlightColor(e)}.bind(this))};b.prototype._onActivateView=function(e,t,i){var r=this.getViewManager();if(!r||i.source.getId()!==r){return}this.activateView(i.view,false,i.playViewGroup,i.skipCameraTransitionAnimation)};b.prototype.activateView=function(t,i,r,n){this.fireViewStateApplying({view:t});this.setJoints(undefined);this._resetNodesMaterialAndOpacityByCurrentView(t);this._prepareTransition(t);this._resetNodesStatusByCurrentView(t,true,false);this._highlightPlayer.reset(t,this._scene);this.fireViewStateApplied({view:t,ignoreAnimationPosition:i,skipCameraTransitionAnimation:n,playViewGroup:r});e.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:t,ignoreAnimationPosition:i,skipCameraTransitionAnimation:n,playViewGroup:r});return this};b.prototype.setHighlightDisplayState=function(e){if(e===d.playing){this._highlightPlayer.start(Date.now())}else if(e===d.stopped){this._highlightPlayer.stop()}else if(e===d.pausing){this._highlightPlayer.pause(Date.now())}this.fireHighlightColorChanged({highlightColor:n(a(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this};b.prototype._startHighlight=function(){this._highlightPlayer.start(Date.now());return this};b.prototype._playHighlight=function(){return this._highlightPlayer.play(Date.now())};b.prototype._prepareTransition=function(e){this._transitionPlayer.reset();this._transitionPlayer.fadeInNodes=[];this._transitionPlayer.fadeOutNodes=[];this._fadeInBackground=null;this._fadeOutBackground=null;var t=e.getNodeInfos();if(!t){return}var i=new Set;var r=new Set;t.forEach(function(e){(e.visible?i:r).add(e.target)});var n=this._transitionPlayer.fadeInNodes;var a=this._transitionPlayer.fadeOutNodes;var o=this._nodeHierarchy;var s=function(e,t,r){if(!e.userData.skipIt){t=t&&i.has(e);r=r&&e.visible}if(e.geometry&&t!==r){if(e.parent&&e.parent.userData.symbolContent){e.renderOrder=2}(t?n:a).push(e)}if(e._vkGetNodeContentType()===_.Background){if(t){this._fadeInBackground=e}else if(r){this._fadeOutBackground=e}}e.children.forEach(function(e){s(e,t,r)})}.bind(this);o.getChildren()[0].children.forEach(function(e){s(e,true,true)});if(this._fadeInBackground){this._fadeInBackground.traverse(function(e){if(e.material){e.renderOrder=-2}})}if(this._fadeOutBackground){this._fadeOutBackground.traverse(function(e){if(e.material){e.renderOrder=1}})}};b.prototype._startTransition=function(e){var t=this._transitionPlayer.fadeInNodes;var i=this._transitionPlayer.fadeOutNodes;if(t&&t.length){var r=new p("FadeIn",{duration:e/500,opacities:[0,1],cycles:1});this._transitionPlayer.addHighlights(r,t)}if(i&&i.length){var n=new p("FadeOut",{duration:e/500,opacities:[1,0],cycles:1,fadeOut:true});this._transitionPlayer.addHighlights(n,i)}if(t&&t.length||i&&i.length){this._transitionPlayer.start(Date.now());this._transitionPlayer.play(Date.now());return e}return 0};b.prototype._playTransition=function(){return this._transitionPlayer.play(Date.now())};b.prototype.updateNodesRestTransformation=function(e){for(var t=0;t<e.length;t++){this.updateRestTransformation(e[t],true);if(this._playbackAssociatedWithJoints&&t===e.length-1){var i=this._playbackAssociatedWithJoints.getSequence();if(i){i._fireSequenceChanged()}}}return this};b.prototype.updateRestTransformation=function(e,t){var i=this.getCurrentView();if(!i){return this}var r=i.getNodeInfos();if(r){r.forEach(function(t){if(t.target!==e){return}e.updateMatrix();t.transform=e.matrix.elements.slice()})}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.parent===e||t.node===e){t.translation=null;t.scale=null;t.quaternion=null;if(t.node.userData){t.node.userData.offsetTranslation=null;t.node.userData.offsetQuaternion=null;t.node.userData.offsetScale=null;t.node.userData.originalRotationType=null}}});this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.parent===e){this._updateJointNode(t,this._playbackAssociatedWithJoints);this.restoreRestTransformation(t.node)}}.bind(this));this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.node===e){this._updateJointNode(t,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints&&!t){var n=this._playbackAssociatedWithJoints.getSequence();if(n){n._fireSequenceChanged()}}}return this};b.prototype.restoreRestTransformation=function(e){var t=this.getCurrentView();if(!t){return this}var i=t.getNodeInfos();if(i){i.forEach(function(t){if(t.target!==e){return}if(t.transform){var i=T(t.transform);i.decompose(e.position,e.quaternion,e.scale)}else if(t[y.Scale]&&t[y.Rotate]&&t[y.Translate]){e.position.set(t[y.Translate][0],t[y.Translate][1],t[y.Translate][2]);e.quaternion.set(t[y.Rotate][0],t[y.Rotate][1],t[y.Rotate][2],t[y.Rotate][3]);e.scale.set(t[y.Scale][0],t[y.Scale][1],t[y.Scale][2])}e.updateMatrix()})}var r={changed:[e],transformation:[{position:e.position.toArray(),quaternion:e.quaternion.toArray(),scale:e.scale.toArray()}]};this.fireTransformationChanged(r);return this};b.prototype.setRestTransformation=function(e,t,r,n){var a=this.getCurrentView();if(!a){return this}var o=a.getNodeInfos();if(o){o.forEach(function(a){if(a.target!==e){return}if(!t||!r||!n){if(a.transform){var o=new i.Vector3;var s=new i.Quaternion;var l=new i.Vector3;var u=T(a.transform);u.decompose(o,s,l);if(!t){t=[o.x,o.y,o.z]}if(!n){n=[l.x,l.y,l.z]}if(!r){r=[s.x,s.y,s.z,s.w]}}else if(a[y.Scale]&&a[y.Rotate]&&a[y.Translate]){if(!t){t=a[y.Translate].slice()}if(!n){n=a[y.Scale].slice()}if(!r){r=a[y.Rotate].slice()}}}var c=new i.Vector3(t[0],t[1],t[2]);var f=new i.Quaternion(r[0],r[1],r[2],r[3]);var h=new i.Vector3(n[0],n[1],n[2]);var d=new i.Matrix4;d.compose(c,f,h);a.transform=d.elements.slice()})}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.parent===e||t.node===e){t.translation=null;t.scale=null;t.quaternion=null;if(t.node.userData){t.node.userData.offsetTranslation=null;t.node.userData.offsetQuaternion=null;t.node.userData.offsetScale=null;t.node.userData.originalRotationType=null}}});this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.parent===e){this._updateJointNode(t,this._playbackAssociatedWithJoints);this.restoreRestTransformation(t.node)}},this);this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.node===e){this._updateJointNode(t,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged()}}}return this};b.prototype.getRestOpacity=function(e){var t;var i=this.getCurrentView();if(i){t=i.getNodeInfos()}var r=1;if(t&&t.length){for(var n=0;n<t.length;n++){var a=t[n];if(a.target!==e){continue}if(a.opacity!==undefined&&a.opacity!==null){r=a.opacity}break}}return r};b.prototype.setRestOpacity=function(e,t){var i;var r=this.getCurrentView();if(r){i=r.getNodeInfos()}if(i){i.forEach(function(i){if(i.target!==e){return}i.opacity=t})}return this};b.prototype.restoreRestOpacity=function(e){var t;var i=this.getCurrentView();if(i){t=i.getNodeInfos()}if(t){t.forEach(function(t){if(t.target!==e){return}var i=1;if(t.opacity!==undefined){i=t.opacity}this.setOpacity(e,i)}.bind(this))}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.parent===e||t.node===e){t.opacity=null;if(t.node.userData){t.node.userData.offsetOpacity=null}}});this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.parent===e){this._updateJointNode(t,this._playbackAssociatedWithJoints);this.restoreRestOpacity(t.node)}},this);this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.node===e){this._updateJointNode(t,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var r=this._playbackAssociatedWithJoints.getSequence();if(r){r._fireSequenceChanged()}}}return this};b.prototype.updateRestOpacity=function(e){var t;var i=this.getCurrentView();if(i){t=i.getNodeInfos()}if(t){t.forEach(function(t){if(t.target!==e){return}if(e.userData&&e.userData.opacity!==undefined&&e.userData.opacity!==null){t.opacity=e.userData.opacity}else{delete t.opacity}})}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.parent===e||t.node===e){t.opacity=null;if(t.node.userData){t.node.userData.offsetOpacity=null}}});this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}if(t.node===e){this._updateJointNode(t,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var r=this._playbackAssociatedWithJoints.getSequence();if(r){r._fireSequenceChanged()}}}return this};b.prototype.getRestTransformationWorld=function(e){var t;var r=this.getCurrentView();if(r){t=r.getNodeInfos()}var n;if(t){var a=new i.Matrix4;while(e){for(var o=0;o<t.length;o++){var s=t[o];if(s.target!==e){continue}var l;if(s.transform){l=T(s.transform)}else if(s[y.Scale]&&s[y.Rotate]&&s[y.Translate]){var u=new i.Vector3(s[y.Translate][0],s[y.Translate][1],s[y.Translate][2]);var c=new i.Quaternion(s[y.Rotate][0],s[y.Rotate][1],s[y.Rotate][2],s[y.Rotate][3]);var f=new i.Vector3(s[y.Scale][0],s[y.Scale][1],s[y.Scale][2]);l=(new i.Matrix4).compose(u,c,f)}if(l){a.premultiply(l)}break}e=e.parent}var h=new i.Vector3;var d=new i.Quaternion;var p=new i.Vector3;a.decompose(h,d,p);n={};n.translation=h.toArray();n.quaternion=d.toArray();n.scale=p.toArray()}if(!n){n=this.getTransformationWorld(e)}return n};b.prototype.getRestTransformation=function(e){var t;var r=this.getCurrentView();if(r){t=r.getNodeInfos()}var n;if(t){t.forEach(function(t){if(t.target!==e){return}if(t.transform){var r=new i.Vector3;var a=new i.Quaternion;var o=new i.Vector3;var s=T(t.transform);s.decompose(r,a,o);n={};n.translation=r.toArray();n.quaternion=a.toArray();n.scale=o.toArray()}else if(t[y.Scale]&&t[y.Rotate]&&t[y.Translate]){n={};n.translation=t[y.Translate].slice();n.quaternion=t[y.Rotate].slice();n.scale=t[y.Scale].slice()}})}if(!n&&e){n={};n.translation=e.userData.position?e.userData.position.toArray():e.position.toArray();n.quaternion=e.userData.quaternion?e.userData.quaternion.toArray():e.quaternion.toArray();n.scale=e.userData.scale?e.userData.scale.toArray():e.scale.toArray();n.matrix=e.matrix.clone()}return n};b.prototype._addToTransformation=function(e,t,r,n,a,o){var s={};var l;if(t){s.translation=[];for(l=0;l<3;l++){s.translation.push(t[l]+e.translation[l])}}else{s.translation=e.translation}if(n){s.scale=[];for(l=0;l<3;l++){s.scale.push(n[l]*e.scale[l])}}else{s.scale=e.scale}if(r){var c=new i.Quaternion(e.quaternion[0],e.quaternion[1],e.quaternion[2],e.quaternion[3]);var f=new i.Quaternion(r[0],r[1],r[2],r[3]);if(a===u.Euler){var h=o?o[3]:6;var d=g.threeQuatToNeutralEuler(c,h);var p=o?o:g.threeQuatToNeutralEuler(f,h);d[0]+=p[0];d[1]+=p[1];d[2]+=p[2];s.quaternion=g.glMatrixQuatToNeutral(g.neutralEulerToGlMatrixQuat(d))}else{var y=(new i.Matrix4).makeRotationFromQuaternion(c);var v=(new i.Matrix4).makeRotationFromQuaternion(f);y.premultiply(v);c.setFromRotationMatrix(y);s.quaternion=[c.x,c.y,c.z,c.w]}}else{s.quaternion=e.quaternion}return s};b.prototype.setInterpolatedRelativeValues=function(e,t){if(!e.userData){e.userData={}}if(t.rtranslate){e.userData.offsetTranslation=t.rtranslate}else{e.userData.offsetTranslation=null}if(t.rscale){e.userData.offsetScale=t.rscale}else{e.userData.offsetScale=null}if(t.rrotate){e.userData.offsetQuaternion=t.rrotate;e.userData.originalRotationType=t.originalRotationType}else{e.userData.offsetQuaternion=null;e.userData.originalRotationType=null}if(t.Euler){e.userData.Euler=t.Euler}else{e.userData.Euler=null}if(t.ropacity!=null){e.userData.offsetOpacity=t.ropacity}else{e.userData.offsetOpacity=null}return this};b.prototype._setJointNodeMatrix=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}var t=e.node;if(t.userData.skipUpdateJointNode){return}var r={};r.translation=e.translation.slice();r.scale=e.scale.slice();r.quaternion=e.quaternion.slice();var n=this._addToTransformation(r,t.userData.offsetTranslation,t.userData.offsetQuaternion,t.userData.offsetScale,t.userData.originalRotationType,t.userData.Euler);t.position.fromArray(n.translation);t.scale.fromArray(n.scale);t.quaternion.fromArray(n.quaternion);t.updateMatrix();var a=t.quaternion.clone();var o=new i.Matrix4;if(e.parent){e.parent.updateMatrixWorld();o=e.parent.matrixWorld.clone();t.matrixWorld.multiplyMatrices(e.parent.matrixWorld,t.matrix)}else{t.matrixWorld.copy(t.matrix)}var s=new i.Matrix4;if(t.parent){t.parent.updateWorldMatrix(true,false);s.copy(t.parent.matrixWorld);t.matrix.copy(t.parent.matrixWorld).invert().multiply(t.matrixWorld)}else{t.matrix.copy(t.matrixWorld)}t.matrix.decompose(t.position,t.quaternion,t.scale);var l=[t.scale.x,t.scale.y,t.scale.z];this._adjustQuaternionAndScale(o,s,a,t.quaternion,n.scale,l);t.scale.x=l[0];t.scale.y=l[1];t.scale.z=l[2];if(e.nodesToUpdate){e.nodesToUpdate.forEach(function(e){if(e.matrixAutoUpdate){e.updateMatrix()}e.matrixWorld.multiplyMatrices(e.parent.matrixWorld,e.matrix)})}}.bind(this))}};b.prototype._getEndPropertyInLastPlayback=function(e,t){var i;var r=this.getCurrentView();if(!r){return i}var n=r.getPlaybacks();if(!n||!n.length){return i}for(var a=n.length-1;a>=0;a--){var o=n[a];var s=o.getSequence();if(s._convertedFromAbsolute){return i}i=o.getNodeBoundaryProperty(e,t,true);if(i){break}}return i};b.prototype._getEndPropertyInPreviousPlayback=function(e,t,i,r){var n;var a=this._getJointByChildNode(e);if(a&&!r){return n}var o=i.getSequence();if(o&&o._convertedFromAbsolute){return n}var s=this.getCurrentView();if(!s){return n}var l=s.getPlaybacks();for(var u=1;u<l.length;u++){var c=l[u];if(c!==i){continue}for(var f=u-1;f>=0;f--){var h=l[f];n=h.getNodeBoundaryProperty(e,t,true);if(n){break}}}return n};b.prototype._convertTracksToRelative=function(e,t){if(t&&e._conversionDoneForReversed||!t&&e._conversionDone){return this}e._convertedFromAbsolute=false;var r=this.getCurrentView();if(!r){return this}var n=e.getNodeAnimation();if(!n||!n.length){return this}var a=r.getNodeInfos();if(a){a.forEach(function(t){var r;for(var a=0;a<n.length;a++){if(t.target===n[a].nodeRef){r=n[a];break}}if(!r){return}var o=[0,0,0];var s=[1,1,1];var l=new i.Quaternion;var u=new i.Vector3;var c=new i.Vector3;if(t.transform){var f=T(t.transform);f.decompose(u,l,c);o=u.toArray();s=c.toArray()}else if(t[y.Scale]&&t[y.Rotate]&&t[y.Translate]){o=t[y.Translate].slice();l=new i.Quaternion(t[y.Rotate][0],t[y.Rotate][1],t[y.Rotate][2],t[y.Rotate][3]);s=t[y.Scale].slice()}else{t.target.matrix.decompose(u,l,c);o=u.toArray();s=c.toArray()}var h,d,p,_;var m=r[y.Translate];if(m&&m.getIsAbsoluteValue()){d=m.getKeysCount();for(h=0;h<d;h++){p=m.getKey(h);_=[p.value[0]-o[0],p.value[1]-o[1],p.value[2]-o[2]];m.updateKey(h,_,true)}m.setIsAbsoluteValue(false);e._convertedFromAbsolute=true}var A=r[y.Scale];if(A&&A.getIsAbsoluteValue()){d=A.getKeysCount();for(h=0;h<d;h++){p=A.getKey(h);_=[p.value[0]/s[0],p.value[1]/s[1],p.value[2]/s[2]];A.updateKey(h,_,true)}A.setIsAbsoluteValue(false);e._convertedFromAbsolute=true}var w=r[y.Opacity];if(w&&w.getIsAbsoluteValue()){var C=this.getRestOpacity(t.target);if(!C){C=1}d=w.getKeysCount();for(h=0;h<d;h++){p=w.getKey(h);_=p.value/C;w.updateKey(h,_,true)}w.setIsAbsoluteValue(false);e._convertedFromAbsolute=true}var b=r[y.Rotate];if(b&&b.getIsAbsoluteValue()){var S;var x=(new i.Matrix4).makeRotationFromQuaternion(l);var N=(new i.Matrix4).copy(x).invert();var R=new i.Matrix4;var k=new i.Matrix4;d=b.getKeysCount();var V=b.getKeysType();for(h=0;h<d;h++){p=b.getKey(h);if(V===v.Quaternion){S=new i.Quaternion(p.value[0],p.value[1],p.value[2],p.value[3]);R.makeRotationFromQuaternion(S);k.multiplyMatrices(R,N);S.setFromRotationMatrix(k);_=S.toArray();b.updateKey(h,_,true)}else if(V===v.Euler){var B=p.value;var D=g.threeQuatToNeutralEuler(l,B[3]);_=[B[0]-D[0]+g.getModulatedAngularValue(B[0]),B[1]-D[1]+g.getModulatedAngularValue(B[1]),B[2]-D[2]+g.getModulatedAngularValue(B[2]),B[3]];b.updateKey(h,_,true)}else if(h===0){var E=new i.Vector3(p.value[0],p.value[1],p.value[2]);R.makeRotationAxis(E,p.value[3]);k.multiplyMatrices(R,N);S=(new i.Quaternion).setFromRotationMatrix(k);_=this._convertQuaternionToAngleAxis(S);b.updateKey(h,_,true);break}}b.setIsAbsoluteValue(false);e._convertedFromAbsolute=true}}.bind(this))}if(!t){e._conversionDone=true;e._conversionDoneForReversed=false}else{e._conversionDone=false;e._conversionDoneForReversed=true}return this};b.prototype._getTrackKeys=function(e){var t=[];var i=e.getKeysCount();for(var r=0;r<i;r++){var n=e.getKey(r);var a;if(Array.isArray(n.value)){a=n.value.slice()}else{a=n.value}t.push({time:n.time,value:a})}return t};b.prototype._setJointNodeOffsets=function(e,t){var r=this._getJointByChildNode(e);if(r){var n=new i.Matrix4;if(e.parent){n=e.parent.matrixWorld.clone()}var a=new i.Matrix4;e.updateMatrixWorld();var o=new i.Matrix4;if(r.parent){r.parent.updateMatrixWorld();o=r.parent.matrixWorld.clone();a.copy(r.parent.matrixWorld).invert().multiply(e.matrixWorld)}else{a.copy(e.matrixWorld)}var s=new i.Vector3;var l=new i.Vector3;var u=new i.Quaternion;a.decompose(s,u,l);if(t===y.Translate){var c=s.toArray();e.userData.offsetTranslation=[c[0]-r.translation[0],c[1]-r.translation[1],c[2]-r.translation[2]]}else if(t===y.Scale){var f=l.toArray();this._adjustQuaternionAndScale(n,o,e.quaternion,u,e.scale.toArray(),f);e.userData.offsetScale=[f[0]/r.scale[0],f[1]/r.scale[1],f[2]/r.scale[2]]}else{this._adjustQuaternionAndScale(n,o,e.quaternion,u,e.scale.toArray(),l.toArray());var h=new i.Quaternion(r.quaternion[0],r.quaternion[1],r.quaternion[2],r.quaternion[3]);var d=(new i.Matrix4).makeRotationFromQuaternion(h);var p=(new i.Matrix4).copy(d).invert();var v=(new i.Matrix4).makeRotationFromQuaternion(u);var g=(new i.Matrix4).multiplyMatrices(v,p);var _=(new i.Quaternion).setFromRotationMatrix(g);e.userData.offsetQuaternion=_.toArray()}}return this};b.prototype.setTranslationKey=function(e,t,r,n){var a=r.getSequence();if(!a){return null}var o;var s=new i.Vector3;e.matrix.decompose(s,new i.Quaternion,new i.Vector3);var l=this._getJointByChildNode(e);if(l){o=l.translation.slice();e.updateMatrixWorld();var u=new i.Matrix4;if(l.parent){l.parent.updateMatrixWorld();u.copy(l.parent.matrixWorld).invert().multiply(e.matrixWorld)}else{u.matrix.copy(e.matrixWorld)}u.decompose(s,new i.Quaternion,new i.Vector3)}else{var c=this.getRestTransformation(e);o=c.translation}var f=s.toArray();var h=[f[0]-o[0],f[1]-o[1],f[2]-o[2]];var d=this._getEndPropertyInPreviousPlayback(e,y.Translate,r);if(d){h[0]-=d[0];h[1]-=d[1];h[2]-=d[2]}var p=a.getNodeAnimation(e,y.Translate);var g;if(!p){p=this._scene.createTrack(null,{trackValueType:v.Vector3,isAbsoluteValue:false});a.setNodeAnimation(e,y.Translate,p,true)}else{g=this._getTrackKeys(p)}p.insertKey(t,h,n);var _=this._getTrackKeys(p);return{KeyValue:h,absoluteValue:f,offset:d,PreviousTrack:g,CurrentTrack:_}};b.prototype._adjustQuaternionAndScale=function(e,t,r,n,a,o){function s(e,t,i,r){var n=Math.abs(e.dot(t));var a=Math.abs(e.dot(i));var o=Math.abs(e.dot(r));if(n>=a&&n>=o){return 0}else if(a>=n&&a>=o){return 1}else{return 2}}if(a[0]>0&&a[1]>0&&a[2]>0){return}var l=e.clone().multiply((new i.Matrix4).makeRotationFromQuaternion(r));var u=(new i.Matrix4).makeRotationFromQuaternion(n);var c=t.clone().multiply(u);var f=new i.Vector3;var h=new i.Vector3;var d=new i.Vector3;l.extractBasis(f,h,d);var p=[f,h,d];var y=new i.Vector3;var v=new i.Vector3;var g=new i.Vector3;c.extractBasis(y,v,g);var _=[1,1,1];for(var m=0;m<3;m++){var A=s(p[m],y,v,g);if(a[m]*o[A]<0){_[A]=-1;o[A]=-o[A]}}u.scale(new i.Vector3(_[0],_[1],_[2]));var w=(new i.Quaternion).setFromRotationMatrix(u);n.x=w.x;n.y=w.y;n.z=w.z;n.w=w.w};b.prototype.setScaleKey=function(e,t,r,n){var a=r.getSequence();if(!a){return null}var o;var s=e.scale.toArray();var l=e.quaternion.clone();var u=this._getJointByChildNode(e);if(u){var c=new i.Matrix4;if(e.parent){c=e.parent.matrixWorld.clone()}o=u.scale.slice();e.updateMatrixWorld();var f=new i.Matrix4;var h=new i.Matrix4;if(u.parent){u.parent.updateMatrixWorld();h=u.parent.matrixWorld.clone();f.copy(u.parent.matrixWorld).invert().multiply(e.matrixWorld)}else{f.copy(e.matrixWorld)}var d=new i.Quaternion;var p=new i.Vector3;f.decompose(new i.Vector3,d,p);var g=p.toArray();this._adjustQuaternionAndScale(c,h,l,d,s,g);s=g}else{var _=this.getRestTransformation(e);o=_.scale}var m=[s[0]/o[0],s[1]/o[1],s[2]/o[2]];var A=this._getEndPropertyInPreviousPlayback(e,y.Scale,r);if(A){m[0]/=A[0];m[1]/=A[1];m[2]/=A[2]}var w=a.getNodeAnimation(e,y.Scale);var C;if(!w){w=this._scene.createTrack(null,{trackValueType:v.Vector3,isAbsoluteValue:false});a.setNodeAnimation(e,y.Scale,w,true)}else{C=this._getTrackKeys(w)}w.insertKey(t,m,n);var b=this._getTrackKeys(w);return{KeyValue:m,absoluteValue:s,offset:A,PreviousTrack:C,CurrentTrack:b}};b.prototype.setRotationKey=function(e,t,r,n,a){var o=n.getSequence();if(!o){return null}var s=36;var l=[r[0],r[1],r[2],s];var u=o.getNodeAnimation(e,y.Rotate);if(u&&u.getKeysType()!==v.Euler){return null}var c;if(!u){u=this._scene.createTrack(null,{trackValueType:v.Euler,isAbsoluteValue:false});o.setNodeAnimation(e,y.Rotate,u,true)}else{c=this._getTrackKeys(u)}u.insertKey(t,l,a);var f=this._getTrackKeys(u);var h=new i.Quaternion;var d=new i.Euler(r[0],r[1],r[2]);h.setFromEuler(d);var p=this._getEndPropertyInPreviousPlayback(e,y.Rotate,n);if(p){var g=new i.Quaternion(p[0],p[1],p[2],p[3]);h.multiply(g)}var _=this._getJointByChildNode(e);var m=new i.Quaternion;if(_){m.fromArray(_.quaternion)}else{var A=this.getRestTransformation(e);m.fromArray(A.quaternion)}h.multiply(m);return{KeyValue:l,absoluteValue:h.toArray(),offset:p,PreviousTrack:c,CurrentTrack:f}};b.prototype.setAxisAngleRotationKey=function(e,t,i,r,n){var a=r.getSequence();if(!a){return null}var o=a.getNodeAnimation(e,y.Rotate);if(o&&o.getKeysType()!==v.AngleAxis){if(!o.setKeysType(v.AngleAxis)){return null}}var s=[i[0],i[1],i[2],i[3]];var l;if(!o){o=this._scene.createTrack(null,{trackValueType:v.AngleAxis,isAbsoluteValue:false});a.setNodeAnimation(e,y.Rotate,o,true)}else{l=this._getTrackKeys(o)}o.insertKey(t,s,n);var u=this._getTrackKeys(o);return{KeyValue:s,PreviousTrack:l,CurrentTrack:u}};b.prototype.getTotalOpacity=function(e){return e._vkGetTotalOpacity(this._jointCollection)};b.prototype.setTotalOpacity=function(e,t){var i=1;var r=this._getJointByChildNode(e);if(r&&r.parent){i=r.parent._vkGetTotalOpacity(this._jointCollection)}else if(e.parent){i=e.parent._vkGetTotalOpacity(this._jointCollection)}if(!e.userData){e.userData={}}var n=this.getOpacity(e);if(i!==0){n=t/i}else{t=0}e._vkSetOpacity(n,this._jointCollection);var a={changed:e,opacity:n};this.fireOpacityChanged(a);return{opacity:n,totalOpacity:t}};b.prototype.setOpacityKey=function(e,t,i,r){var n=i.getSequence();if(!n){return null}var a=1;if(e.userData&&e.userData.opacity!==undefined&&e.userData.opacity!==null){a=e.userData.opacity}var o=this.getRestOpacity(e);if(!o&&n._convertedFromAbsolute){o=1}a/=o;var s=this._getEndPropertyInPreviousPlayback(e,y.Opacity,i);if(s){a/=s}var l=n.getNodeAnimation(e,y.Opacity);var u;if(!l){l=this._scene.createTrack(null,{trackValueType:v.Opacity});n.setNodeAnimation(e,y.Opacity,l,true)}else{u=this._getTrackKeys(l)}l.insertKey(t,a,r);var c=this._getTrackKeys(l);return{KeyValue:a,totalOpacity:this.getTotalOpacity(e),PreviousTrack:u,CurrentTrack:c}};C=function(){this._visibilityChanges=new Set};C.prototype.getInfo=function(e){var t=[];this._visibilityChanges.forEach(function(i){var r=e.createNodeProxy(i);var n=r.getVeId();e.destroyNodeProxy(r);if(n){t.push(n)}else{t.push(e.getScene().nodeRefToPersistentId(i))}});return t};C.prototype.clear=function(){this._visibilityChanges.clear()};C.prototype.trackNodeRef=function(e){if(this._visibilityChanges.has(e)){this._visibilityChanges.delete(e)}else{this._visibilityChanges.add(e)}};function N(e){while(!e.isScene){var t=e.userData.selectable;if(t!=null){return t}e=e.parent}return true}b.prototype.getSelectable=function(e){if(Array.isArray(e)){return e.map(N)}else{return N(e)}};b.prototype.setSelectable=function(e,t){if(!Array.isArray(e)){e=[e]}e.forEach(function(e){e.userData.selectable=t});return this};b.prototype.updateAssociatedMarkerMatrix=function(){var e=this._scene?this._scene.getSceneBuilder():null;if(e){let t=e.getAllNodesWithBoundMarkers();if(t){t.forEach((e,t)=>{const i=this._scene.persistentIdToNodeRef(t);if(i){var r=i.matrixWorld;e.forEach((e,t)=>{if(e.coordinateSpace!==this._scene.PoiCoordinateSpaces.ReferenceNodeSpace){return}const i=this._scene.persistentIdToNodeRef(t);if(i?.visible){const e=i.userData.treeNode?.transform;if(e){let t=T(e);t.premultiply(r);t.decompose(i.position,i.quaternion,i.scale);i.updateMatrix()}}})}})}}};return b});
//# sourceMappingURL=ViewStateManager.js.map