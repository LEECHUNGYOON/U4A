/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Core","sap/base/Log","../measurements/Edge","../measurements/Face","../measurements/Vertex","../measurements/MeshAnalyzer","../measurements/MeshAnalyzer2D","../measurements/Settings","./MeasurementToolState","./Gizmo","../thirdparty/three"],function(e,t,r,s,a,n,i,u,o,l,h){"use strict";var c=l.extend("sap.ui.vk.tools.MeasurementToolGizmo",{metadata:{library:"sap.ui.vk"}});var _=c.getMetadata().getParent().getClass().prototype;c.prototype.hasDomElement=function(){return false};c.prototype.init=function(){if(_.init){_.init.call(this)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=o.Off;this._hoverPoint=null;this._currentFeature=null;this._currentFeatureIndex=0;this._firstFeature=null;this._secondFeature=null;this._vertexFeatures=[new a];this._edgeFeatures=[new r];this._faceFeatures=[new s];this._currentMeasurement=null;this._meshAnalyzerMap=new Map;this._is2D=false};c.prototype.setCurrentFeatureIndex=function(e){if(e<1&&this._firstFeature){t.error("setCurrentFeatureIndex: first feature not null with index="+e)}if(e<2&&this._secondFeature){t.error("setCurrentFeatureIndex: second feature not null with index="+e)}var n=e-this._currentFeatureIndex;if(n===1){this._currentFeatureIndex++;this._vertexFeatures.push(new a);this._edgeFeatures.push(new r);this._faceFeatures.push(new s)}else if(n===-1){this._currentFeatureIndex--;this._vertexFeatures.pop();this._edgeFeatures.pop();this._faceFeatures.pop()}else if(e===0){this._currentFeatureIndex=0;this._vertexFeatures.splice(1);this._edgeFeatures.splice(1);this._faceFeatures.splice(1)}else if(n!==0){t.error("setCurrentFeatureIndex: "+this._currentFeatureIndex+" => "+e)}};c.prototype._createMeshAnalyzer=function(e){let t=null;let r=0;let s=0;let a=0;let i,u,o;let l=function(e){if(e.geometry&&e.geometry.isBufferGeometry){const s=e.geometry.getAttribute("position");const n=e.geometry.getIndex();const l=e.userData.renderGroup;if(s&&n){if(t){for(let r=l?l.start:0,a=l?l.start+l.count:n.count;r<a;r+=3){i=(new h.Vector3).fromArray(s.array,n.array[r]*3);u=(new h.Vector3).fromArray(s.array,n.array[r+1]*3);o=(new h.Vector3).fromArray(s.array,n.array[r+2]*3);i.applyMatrix4(e.matrixWorld);u.applyMatrix4(e.matrixWorld);o.applyMatrix4(e.matrixWorld);t.addTriangle([i.x,i.y,i.z],[u.x,u.y,u.z],[o.x,o.y,o.z])}}else{r+=l?l.count:n.count}}else if(s){if(t){for(let r=l?l.start:0,a=l?l.start+l.count:s.count;r<a;++r){i=(new h.Vector3).fromArray(s.array,r*3);i.applyMatrix4(e.matrixWorld);t._addVertex([i.x,i.y,i.z])}}else{a+=l?l.count:s.count}}}e.children.forEach(l)};for(let i=0;i<2;++i){l(e);if(i===0){t=new n(r/3,s,a)}}t.finishMeshBuilding();return t};c.prototype._createMeshAnalyzer2D=function(e){return new i(e,this._viewport.getCamera()._getViewBox())};c.prototype._getMeshAnalyzer=function(e){var t=this._meshAnalyzerMap.get(e);if(t!=null){return t}var r=this._is2D?this._createMeshAnalyzer2D(e):this._createMeshAnalyzer(e);this._meshAnalyzerMap.set(e,r);return r};c.prototype.show=function(t,r){this._viewport=t;this._surface=t.getMeasurementSurface();this._tool=r;this._vsm=e.byId(t.getViewStateManager());this._is2D=t.getScene().getMetadata().getName()==="sap.ui.vk.svg.Scene";this._settings=u.load();this._state=o.SearchingFirstFeature;this.setCurrentFeatureIndex(0)};c.prototype.hide=function(){if(this._surface!=null){var e=this._surface;for(var t=0,r=this._faceFeatures.length;t<r;++t){e.removeFeature(this._faceFeatures[t])}for(var s=0,a=this._edgeFeatures.length;s<a;++s){e.removeFeature(this._edgeFeatures[s])}for(var n=0,i=this._vertexFeatures.length;n<i;++n){e.removeFeature(this._vertexFeatures[n])}if(this._currentMeasurement!=null){e.removeMeasurement(this._currentMeasurement);this._currentMeasurement=null}}var u=this._vsm;var l=this._hoverPoint&&this._hoverPoint.nodeRef;if(l!=null&&u!=null){u.setOutliningStates([],[l],false,true)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=o.Off;this._currentFeature=null;this._firstFeature=null;this._secondFeature=null;this.setCurrentFeatureIndex(0);this._hoverPoint=null};c.prototype._computeSphereRadius=function(e,t){var r=this._is2D?5:3;if(this._is2D){var s=t._camera._worldToScreen(e[0],e[1]);var a=t._camera._screenToWorld(s.x+r,s.y);r=Math.abs(e[0]-a.x)}else{var n=t.getDomRef().getBoundingClientRect();var i=n.width*.5;var u=n.height*.5;var o=t.getCamera().getCameraRef();var l=(new h.Vector3).fromArray(e);var c=l.clone();c.project(o);var _=r/i;var f=r/u;r=0;for(var p=0;p<4;++p){var m=p%2?-1:1;var d=new h.Vector3(c.x+m*(p<2?_:0),c.y+m*(p>=2?f:0),c.z);d.unproject(o);var v=d.distanceTo(l);if(v>r){r=v}}}return r};c.prototype._replaceCurrentFeature=function(e,t,r){var s=false;if(e!==this._currentFeature){this._surface.removeFeature(this._currentFeature);this._surface.addFeature(e);this._currentFeature=e;s=true}else if(r!==e.getContext()||t!==e.getFeatureId()){s=true}if(s){e.setContext(r);e.setFeatureId(t)}return s};return c});
//# sourceMappingURL=MeasurementToolGizmo.js.map