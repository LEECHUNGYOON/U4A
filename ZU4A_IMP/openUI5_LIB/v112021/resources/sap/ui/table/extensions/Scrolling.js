sap.ui.define(["./ExtensionBase","../utils/TableUtils","../library","sap/ui/Device","sap/ui/performance/trace/Interaction","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/scrollLeftRTL"],(function(e,t,o,r,l,i,jQuery){"use strict";var n=o.SharedDomRef,a=t.Hook.Keys,s=t.createWeakMapFacade(),c=1e6,d={HORIZONAL:"HORIZONTAL",VERTICAL:"VERTICAL",BOTH:"BOTH"};function f(e,t){i.debug("sap.ui.table.extensions.Scrolling",e,t)}function p(e,t){var o,r=!0,l=!1,i=[],n={cancel:function(){if(!this.isCancelled()&&this.isRunning()){l=!0;for(var e=0;e<i.length;e++)i[e]();f("Process cancelled: "+t.id)}},isCancelled:function(){return l},addCancelListener:function(e){i.push(e)},isRunning:function(){return r},getInfo:function(){return t},onPromiseCreated:function(e){}};return f("Process started: "+t.id),o="function"==typeof e?new Promise((function(){e.apply(this,Array.prototype.slice.call(arguments).concat(n))})):Promise.resolve(),Object.assign(o,n),o.then((function(){n.isCancelled()?f("Process finished due to cancellation: "+t.id):f("Process finished: "+t.id),r=!1})),n.onPromiseCreated(o),o}function u(){this.iIndex=0,this.nOffset=0,this.sOffsetType=u.OffsetType.Pixel,this.bIsInitial=!0}u.OffsetType={Pixel:"Pixel",Percentage:"Percentage",PercentageOfViewport:"PercentageOfViewport"},u.prototype.getIndex=function(){return this.iIndex},u.prototype.getOffset=function(){return this.nOffset},u.prototype.getOffsetType=function(){return this.sOffsetType},u.prototype.isOffsetInPixel=function(){return this.sOffsetType===u.OffsetType.Pixel},u.prototype.isInitial=function(){return this.bIsInitial},u.prototype.setPosition=function(e,t,o){f("ScrollPosition#setPosition(index: "+e+", offset: "+t+", offsetType: "+o+")"),u._isPositiveNumber(e)&&(u._isPositiveNumber(t)||(this.nOffset=0),this.setIndex(e),this.setOffset(t,o))},u.prototype.setIndex=function(e){f("ScrollPosition#setIndex(index: "+e+")"),u._isPositiveNumber(e)&&(this.bIsInitial=!1,this.iIndex=e)},u.prototype.setOffset=function(e,t){f("ScrollPosition#setOffset(offset: "+e+", offsetType: "+t+")"),u._isPositiveNumber(e)&&(this.bIsInitial=!1,this.sOffsetType=t in u.OffsetType?t:u.OffsetType.Pixel,this.isOffsetInPixel()?this.nOffset=Math.round(e):this.nOffset=Math.min(e,1))},u.prototype.scrollRows=function(e){var t=this.getIndex()+e,o=this.getOffset();(!this.isOffsetInPixel()||t<0)&&(o=0),this.setPosition(Math.max(0,t),o)},u._isPositiveNumber=function(e){return"number"==typeof e&&!isNaN(e)&&e>=0};var g={UpdateFromFirstVisibleRow:{id:"UpdateFromFirstVisibleRow",rank:6},UpdateFromScrollPosition:{id:"UpdateFromScrollPosition",rank:5},RestoreScrollPosition:{id:"RestoreScrollPosition",rank:4},AdjustToTotalRowCount:{id:"AdjustToTotalRowCount",rank:3},OnRowsUpdated:{id:"OnRowsUpdated",rank:3},UpdateFromScrollbar:{id:"UpdateFromScrollbar",rank:2},UpdateFromViewport:{id:"UpdateFromViewport",rank:1},canStart:function(e,t){var o=s(e).pVerticalScrollUpdateProcess,r=o?o.getInfo():null;return!(o&&o.isRunning()&&r.rank>t.rank)||(f("Cannot start update process "+t.id+" - A higher-ranked update process is currently running ("+r.id+")",e),!1)},start:function(e,t,o){g.canStart(e,t)&&(s(e).pVerticalScrollUpdateProcess&&s(e).pVerticalScrollUpdateProcess.cancel(),s(e).pVerticalScrollUpdateProcess=new p(o,t))}},S={onScrollbarScroll:function(e){var t=e.target.scrollLeft,o=e.target._scrollLeft;if(l.notifyScrollEvent&&l.notifyScrollEvent(e),t!==o){var r=S.getScrollAreas(this);e.target._scrollLeft=t;for(var i=0;i<r.length;i++){var n=r[i];n!==e.target&&n.scrollLeft!==t&&(n.scrollLeft=t,n._scrollLeft=t)}s(this).iHorizontalScrollPosition=t}let a=this.getDomRef("tableCCnt")||void 0;void 0!==a&&!0===a.contains(document.activeElement)&&document.activeElement.blur()},restoreScrollPosition:function(e){var t=e._getScrollExtension().getHorizontalScrollbar();if(t&&null!==s(e).iHorizontalScrollPosition){for(var o=S.getScrollAreas(e),r=0;r<o.length;r++){delete o[r]._scrollLeft}if(t.scrollLeft!==s(e).iHorizontalScrollPosition)t.scrollLeft=s(e).iHorizontalScrollPosition;else{var l=jQuery.Event("scroll");l.target=t,S.onScrollbarScroll.call(e,l)}}},updateScrollbar:function(e){var t=e._getScrollExtension(),o=t.getHorizontalScrollbar();if(o){var l=e._collectTableSizes(),i=e.$(),n=l.tableCtrlScrollWidth;r.browser.safari&&(n=Math.max(n,e._getColumnsWidth(e.getComputedFixedColumnCount())));var a=n>l.tableCtrlScrWidth;if(a){if(!t.isHorizontalScrollbarVisible())if(i.addClass("sapUiTableHScr"),o.classList.remove("sapUiTableHidden"),r.browser.safari)i.find(".sapUiTableCtrlScroll, .sapUiTableColHdrScr > .sapUiTableColHdr").outerWidth(n);var s=l.tableCtrlFixedWidth;i.find(".sapUiTableRowHdrScr").length>0&&(s+=l.tableRowHdrScrWidth),e._bRtlMode?(o.style.marginRight=s+"px",o.style.marginLeft=""):(o.style.marginLeft=s+"px",o.style.marginRight="");var c=e.getDomRef("hsb-content");c&&(c.style.width=n+"px")}!a&&t.isHorizontalScrollbarVisible()&&(i.removeClass("sapUiTableHScr"),o.classList.add("sapUiTableHidden"),r.browser.safari&&i.find(".sapUiTableCtrlScroll, .sapUiTableColHdr").css("width",""))}},onScrollbarMouseDown:function(e){this._getKeyboardExtension().setActionMode(!1)},addEventListeners:function(e){var t=e._getScrollExtension(),o=t.getHorizontalScrollbar(),r=S.getScrollAreas(e);t._onHorizontalScrollEventHandler||(t._onHorizontalScrollEventHandler=S.onScrollbarScroll.bind(e));for(var l=0;l<r.length;l++)r[l].addEventListener("scroll",t._onHorizontalScrollEventHandler);o&&(t._onHorizontalScrollbarMouseDownEventHandler||(t._onHorizontalScrollbarMouseDownEventHandler=S.onScrollbarMouseDown.bind(e)),o.addEventListener("mousedown",t._onHorizontalScrollbarMouseDownEventHandler))},removeEventListeners:function(e){var t=e._getScrollExtension(),o=t.getHorizontalScrollbar(),r=S.getScrollAreas(e);if(t._onHorizontalScrollEventHandler){for(var l=0;l<r.length;l++)r[l].removeEventListener("scroll",t._onHorizontalScrollEventHandler),delete r[l]._scrollLeft;delete t._onHorizontalScrollEventHandler}o&&t._onHorizontalScrollbarMouseDownEventHandler&&(o.removeEventListener("mousedown",t._onHorizontalScrollbarMouseDownEventHandler),delete t._onHorizontalScrollbarMouseDownEventHandler)},getScrollAreas:function(e){var t;return e.getDomRef()&&(t=Array.prototype.slice.call(e.getDomRef().querySelectorAll(".sapUiTableCtrlScr"))),[e._getScrollExtension().getHorizontalScrollbar()].concat(t).filter((function(e){return null!=e}))}},h={performUpdateFromFirstVisibleRow:function(e,o){f("VerticalScrollingHelper.performUpdateFromFirstVisibleRow",e),g.start(e,g.UpdateFromFirstVisibleRow,(function(r,l,i){if(t.Hook.call(e,a.Signal,"StartTableUpdate"),i.onPromiseCreated=function(o){o.finally((function(){t.Hook.call(e,a.Signal,"EndTableUpdate")}))},!0===o){var n=function(){return f("VerticalScrollingHelper.performUpdateFromFirstVisibleRow (async: rows update)",e),h._performUpdateFromFirstVisibleRow(e,i).then(r),!1};h.addOnRowsUpdatedPreprocessor(e,n),i.addCancelListener((function(){h.removeOnRowsUpdatedPreprocessor(e,n)&&r()}))}else h._performUpdateFromFirstVisibleRow(e,i).then(r)}))},_performUpdateFromFirstVisibleRow:function(e,t){return h.adjustScrollPositionToFirstVisibleRow(e,t).then((function(){return h.fixTemporaryFirstVisibleRow(e,null,t)})).then((function(){return h.fixScrollPosition(e,t)})).then((function(){return Promise.all([h.scrollViewport(e,t),h.scrollScrollbar(e,t)])}))},performUpdateFromScrollPosition:function(e){f("VerticalScrollingHelper.performUpdateFromScrollPosition",e),g.start(e,g.UpdateFromScrollPosition,(function(o,r,l){t.Hook.call(e,a.Signal,"StartTableUpdate"),l.onPromiseCreated=function(o){o.finally((function(){t.Hook.call(e,a.Signal,"EndTableUpdate")}))},h.adjustFirstVisibleRowToScrollPosition(e,null,l).then((function(){if(!l.isCancelled()){var o=s(e).oVerticalScrollPosition;f("VerticalScrollingHelper.performUpdateFromScrollPosition (async: firstVisibleRow update)",e),o.getIndex()>e.getFirstVisibleRow()&&(o.setIndex(e.getFirstVisibleRow()),t.isVariableRowHeightEnabled(e)?o.setOffset(1,u.OffsetType.Percentage):o.setOffset(0))}})).then((function(){return h.fixScrollPosition(e,l)})).then((function(){return Promise.all([h.scrollViewport(e,l),h.scrollScrollbar(e,l)])})).then(o)}))},performUpdateFromScrollbar:function(e){f("VerticalScrollingHelper.performUpdateFromScrollbar",e),clearTimeout(s(e).mTimeouts.largeDataScrolling),delete s(e).mTimeouts.largeDataScrolling,g.start(e,g.UpdateFromScrollbar,(function(o,r,l){t.Hook.call(e,a.Signal,"StartTableUpdate"),l.onPromiseCreated=function(o){o.finally((function(){t.Hook.call(e,a.Signal,"EndTableUpdate")}))},e._getKeyboardExtension().setActionMode(!1),e._bLargeDataScrolling?(s(e).mTimeouts.largeDataScrolling=setTimeout((function(){delete s(e).mTimeouts.largeDataScrolling,null!=e._getScrollExtension().getVerticalScrollbar()?(f("VerticalScrollingHelper.performUpdateFromScrollbar (async: large data scrolling)",e),h._performUpdateFromScrollbar(e,l).then(o)):f("VerticalScrollingHelper.performUpdateFromScrollbar (async: large data scrolling): No scrollbar",e)}),300),l.addCancelListener((function(){null!=s(e).mTimeouts.largeDataScrolling&&(clearTimeout(s(e).mTimeouts.largeDataScrolling),delete s(e).mTimeouts.largeDataScrolling,o())}))):h._performUpdateFromScrollbar(e,l).then(o)}))},_performUpdateFromScrollbar:function(e,t){return h.adjustScrollPositionToScrollbar(e,t).then((function(){return h.adjustFirstVisibleRowToScrollPosition(e,null,t)})).then((function(){return h.fixScrollPosition(e,t)})).then((function(){return h.scrollViewport(e,t)}))},performUpdateFromViewport:function(e){f("VerticalScrollingHelper.performUpdateFromViewport",e),g.start(e,g.UpdateFromViewport,(function(o,r,l){t.Hook.call(e,a.Signal,"StartTableUpdate"),l.onPromiseCreated=function(o){o.finally((function(){t.Hook.call(e,a.Signal,"EndTableUpdate")}))},h.adjustScrollPositionToViewport(e,l).then((function(){return h.adjustFirstVisibleRowToScrollPosition(e,!0,l)})).then((function(){return h.scrollScrollbar(e,l)})).then(o)}))},onScrollbarScroll:function(e){l.notifyScrollEvent&&l.notifyScrollEvent(e);var t=e.target.scrollTop,o=t!==e.target._scrollTop;delete e.target._scrollTop,0!==t||e.target.isConnected?o?(f("VerticalScrollingHelper.onScrollbarScroll: Scroll position changed to "+t+" by interaction",this),h.performUpdateFromScrollbar(this)):f("VerticalScrollingHelper.onScrollbarScroll: Scroll position changed to "+t+" by API",this):f("VerticalScrollingHelper.onScrollbarScroll: Scrollbar is not connected with the DOM",this)},onViewportScroll:function(e){if(g.canStart(this,g.UpdateFromViewport)){var t=e.target.scrollTop,o=e.target._scrollTop;delete e.target._scrollTop,t!==o?(f("VerticalScrollingHelper.onViewportScroll: Scroll position changed to "+t+" by interaction",this),h.performUpdateFromViewport(this)):f("VerticalScrollingHelper.onViewportScroll: Scroll position changed to "+t+" by API",this)}},adjustFirstVisibleRowToScrollPosition:function(e,t,o){if(o&&o.isCancelled())return Promise.resolve();t=!0===t;var r=s(e).oVerticalScrollPosition,l=r.getOffsetType()===u.OffsetType.PercentageOfViewport,i=r.getIndex(),n=e.getFirstVisibleRow(),a=h.isIndexInBuffer(e,i)||l;return f('VerticalScrollingHelper.adjustFirstVisibleRowToScrollPosition: Set "firstVisibleRow" from '+n+" to "+i,e),e._setFirstVisibleRowIndex(i,{onScroll:!0,suppressEvent:a,suppressRendering:t})?new Promise((function(t){var r=function(r){return f("VerticalScrollingHelper.adjustFirstVisibleRowToScrollPosition (async: rows updated): Reason "+r.getParameters().reason,this),a?h.fixTemporaryFirstVisibleRow(e,!0,o).then(t):t(),!1};h.addOnRowsUpdatedPreprocessor(e,r),o&&o.addCancelListener((function(){h.removeOnRowsUpdatedPreprocessor(e,r)&&t()}))})):a?h.fixTemporaryFirstVisibleRow(e,!0,o):Promise.resolve()},fixTemporaryFirstVisibleRow:function(e,t,o){if(o&&o.isCancelled())return Promise.resolve();t=!0===t;var r=s(e).oVerticalScrollPosition,l=r.getOffsetType()===u.OffsetType.PercentageOfViewport,i=r.getIndex(),n=h.isIndexInBuffer(e,i);if(!(n||l))return f("VerticalScrollingHelper.fixTemporaryFirstVisibleRow: Aborted - The index is already final",e),Promise.resolve();var a,c=i,d=h.getScrollRangeOfViewport(e),p=e._getMaxFirstRenderedRowIndex(),g=e._aRowHeights;if(f("VerticalScrollingHelper.fixTemporaryFirstVisibleRow",e),l){var S=d*r.getOffset();for(n&&(c=p),a=0;a<g.length;a++){var b=S-g[a];if(!(b>=0))break;S=b,c++}}else if(n){var v=Math.max(0,Math.min(g.length-1,i-p)),m=0;for(a=0;a<v;a++)if((m+=g[a])>d){c=p+a;break}}return(i!==c||t)&&(f('VerticalScrollingHelper.fixTemporaryFirstVisibleRow: Set "firstVisibleRow" to '+c,e),e._setFirstVisibleRowIndex(c,{onScroll:!0,forceEvent:t,suppressRendering:!0})),Promise.resolve()},adjustScrollPositionToFirstVisibleRow:function(e,t){return t&&t.isCancelled()||(f("VerticalScrollingHelper.adjustScrollPositionToFirstVisibleRow",e),s(e).oVerticalScrollPosition.setPosition(e.getFirstVisibleRow())),Promise.resolve()},adjustScrollPositionToScrollbar:function(e,o){if(o&&o.isCancelled())return Promise.resolve();var r,l=s(e).oVerticalScrollPosition,i=h.getScrollPositionOfScrollbar(e),n=h.getScrollRange(e),a=h.getScrollRangeRowFraction(e),c=0,d=0,p=u.OffsetType.Percentage;if(f("VerticalScrollingHelper.adjustScrollPositionToScrollbar",e),t.isVariableRowHeightEnabled(e))if(h.isScrollPositionOfScrollbarInBuffer(e)){var g=h.getScrollRangeBuffer(e),S=(i-(n-g))/g;if(c=e._getMaxFirstRenderedRowIndex(),h.isIndexInBuffer(e,l.getIndex()))for(var b=h.getScrollRangeOfViewport(e)*S,v=e._aRowHeights,m=0;m<v.length;m++){var T=b-v[m];if(!(T>=0)){d=Math.round(b),p=u.OffsetType.Pixel;break}b=T,c++}else d=S,p=u.OffsetType.PercentageOfViewport}else d=(r=i/a)-(c=Math.floor(r));else n-i<1?(c=e._getMaxFirstVisibleRowIndex(),d=0,p=u.OffsetType.Pixel):d=(r=i/a)-(c=Math.floor(r));return l.setPosition(c,d,p),Promise.resolve()},adjustScrollPositionToViewport:function(e,t){if(t&&t.isCancelled())return Promise.resolve();var o=s(e).oVerticalScrollPosition,r=e._aRowHeights,l=e._getFirstRenderedRowIndex(),i=0,n=h.getScrollPositionOfViewport(e);f("VerticalScrollingHelper.adjustScrollPositionToViewport",e);for(var a=0;a<r.length;a++){var c=n-r[a];if(!(c>=0)){i=Math.round(n);break}n=c,l++}return o.setPosition(l,i),Promise.resolve()},fixScrollPosition:function(e,o){if(o&&o.isCancelled())return Promise.resolve();var r=s(e).oVerticalScrollPosition,l=e.getDomRef("tableCCnt"),i=h.getScrollRangeOfViewport(e),n=e._aRowHeights;if(!l||!e.getBinding())return f("VerticalScrollingHelper.fixScrollPosition: Aborted - Viewport or binding not available",e),Promise.resolve();f("VerticalScrollingHelper.fixScrollPosition",e);var a,c=r.getIndex(),d=r.getOffset(),p=0,g=e._getFirstRenderedRowIndex();switch(r.getOffsetType()){case u.OffsetType.Pixel:case u.OffsetType.Percentage:var S=r.getIndex(),b=0,v=r.getOffsetType();if(h.isIndexInBuffer(e,S)){var m=0;for(p=Math.max(0,Math.min(n.length-1,S-g)),a=0;a<p;a++){if((m+=n[a])>i){c=g+a,d=i-b,v=u.OffsetType.Pixel,p=a;break}b=m}}(b+=d=v===u.OffsetType.Pixel?Math.min(d,n[p]):n[p]*d)>i&&t.isVariableRowHeightEnabled(e)&&(d-=b-i);break;case u.OffsetType.PercentageOfViewport:var T=i*r.getOffset();for(a=0;a<n.length;a++){var V=T-n[a];if(!(V>=0)){c=g+p,d=Math.round(T);break}T=V,p++}}return r.setPosition(c,d),Promise.resolve()},scrollViewport:function(e,o){if(o&&o.isCancelled())return Promise.resolve();if(!t.isVariableRowHeightEnabled(e))return f("VerticalScrollingHelper.scrollViewport: Aborted - Variable row height not enabled",e),Promise.resolve();var r=s(e).oVerticalScrollPosition,l=e.getDomRef("tableCCnt"),i=h.getScrollRangeOfViewport(e),n=e._aRowHeights,a=0;if(0===i)return f("VerticalScrollingHelper.scrollViewport: Aborted - No overflow in viewport",e),l.scrollTop=a,l._scrollTop=l.scrollTop,Promise.resolve();if(f("VerticalScrollingHelper.scrollViewport",e),r.getOffsetType()!==u.OffsetType.Pixel)return f("VerticalScrollingHelper.scrollViewport: The viewport can only be scrolled if the offset is in pixel",e),Promise.resolve();for(var c=r.getIndex(),d=Math.max(0,Math.min(n.length-1,c-e._getFirstRenderedRowIndex())),p=0;p<d;p++)a+=n[p];return a+=r.getOffset(),f("VerticalScrollingHelper.scrollViewport: Scroll from "+l.scrollTop+" to "+a,e),l.scrollTop=a,l._scrollTop=l.scrollTop,Promise.resolve()},scrollScrollbar:function(e,t){if(t&&t.isCancelled())return Promise.resolve();var o,r=s(e).oVerticalScrollPosition,l=r.getIndex(),i=h.getScrollRangeBuffer(e),n=h.getScrollRange(e),a=n-i,c=0,d=0,p=h.getScrollRangeOfViewport(e),g=e._aRowHeights;if(f("VerticalScrollingHelper.scrollScrollbar",e),0===n||0===g.length)return f("VerticalScrollingHelper.scrollScrollbar: No scrollable content",e),Promise.resolve();if(r.getOffsetType()!==u.OffsetType.Pixel)return f("VerticalScrollingHelper.scrollViewport: The scrollbar can only be scrolled if the offset is in pixel",e),Promise.resolve();if(h.isIndexInBuffer(e,l)){var S=0;o=Math.max(0,Math.min(g.length-1,l-e._getMaxFirstRenderedRowIndex()));for(var b=0;b<o;b++)S+=g[b];S+=Math.min(g[o],r.getOffset()),c=a+i*Math.min(S/p,1)}else{var v=h.getScrollRangeRowFraction(e);c=l*v,o=Math.max(0,Math.min(g.length-1,l-e._getFirstRenderedRowIndex())),c+=v*Math.min(r.getOffset()/g[o],1)}d=c>0&&c<.5?1:c>=n-.5&&c<n?n-1:Math.round(c);var m=e._getScrollExtension().getVerticalScrollbar();return m?(f("VerticalScrollingHelper.scrollScrollbar: Scroll from "+m.scrollTop+" to "+d,e),m.scrollTop=d,m._scrollTop=m.scrollTop):f("VerticalScrollingHelper.scrollScrollbar: Not scrolled - No scrollbar available",e),Promise.resolve()},getScrollRange:function(e){var t=e._getScrollExtension(),o=t.getVerticalScrollHeight()-t.getVerticalScrollbarHeight();return Math.max(0,o)},getScrollRangeBuffer:function(e){return t.isVariableRowHeightEnabled(e)?2*e._getBaseRowHeight():0},getScrollPositionOfScrollbar:function(e){var t=e._getScrollExtension();return t.isVerticalScrollbarVisible()?t.getVerticalScrollbar().scrollTop:0},getScrollPositionOfViewport:function(e){var t=e?e.getDomRef("tableCCnt"):null;return t?t.scrollTop:0},getScrollRangeRowFraction:function(e){var o,r=e._getScrollExtension(),l=e._getTotalRowCount()-e._getRowCounts()._fullsize;t.isVariableRowHeightEnabled(e)?(o=h.getScrollRange(e)-h.getScrollRangeBuffer(e),r.getVerticalScrollHeight()===c||(o+=e._getBaseRowHeight())):o=h.getScrollRange(e);return o/Math.max(1,l)},isScrollPositionOfScrollbarInBuffer:function(e){return!!t.isVariableRowHeightEnabled(e)&&h.getScrollRange(e)-h.getScrollPositionOfScrollbar(e)<=h.getScrollRangeBuffer(e)},isIndexInBuffer:function(e,o){return!!t.isVariableRowHeightEnabled(e)&&o>=e._getMaxFirstRenderedRowIndex()},getScrollRangeOfViewport:function(e){if(!e||!e._aRowHeights)return 0;var t=e._aRowHeights,o=e._getBaseRowHeight()*e._getRowCounts()._fullsize;e._getRowCounts()._fullsize>=e._getTotalRowCount()&&(t=t.slice(0,e._getTotalRowCount()));var r=t.reduce((function(e,t){return e+t}),0)-o;return r>0&&(r=Math.ceil(r)),Math.max(0,r)},addOnRowsUpdatedPreprocessor:function(e,t){s(e).aOnRowsUpdatedPreprocessors.push(t)},removeOnRowsUpdatedPreprocessor:function(e,t){if(!t)return s(e).aOnRowsUpdatedPreprocessors=[],!1;var o=s(e).aOnRowsUpdatedPreprocessors.indexOf(t);return o>-1&&(s(e).aOnRowsUpdatedPreprocessors.splice(o,1),!0)},onRowsUpdated:function(e){if(f("VerticalScrollingHelper.onRowsUpdated: Reason "+e.getParameters().reason,this),h.updateScrollbarVisibility(this),s(this).aOnRowsUpdatedPreprocessors.length>0){f("VerticalScrollingHelper.onRowsUpdated (preprocessors)",this);var o=s(this).aOnRowsUpdatedPreprocessors.reduce((function(t,o){var r=o.call(this,e);return!(t&&!r)}),!0);if(h.removeOnRowsUpdatedPreprocessor(this),!o)return void f("VerticalScrollingHelper.onRowsUpdated (preprocessors): Default prevented",this)}if(t.isVariableRowHeightEnabled(this)){var r=this;g.start(this,g.OnRowsUpdated,(function(e,o,l){t.Hook.call(r,a.Signal,"StartTableUpdate"),l.onPromiseCreated=function(e){e.finally((function(){t.Hook.call(r,a.Signal,"EndTableUpdate")}))},h.fixScrollPosition(r,l).then((function(){return Promise.all([h.adjustFirstVisibleRowToScrollPosition(r,!0,l),h.scrollViewport(r,l),h.scrollScrollbar(r,l)])})).then(e)}))}else f("VerticalScrollingHelper.onRowsUpdated: Aborted - Variable row heights not enabled",this)},restoreScrollPosition:function(e,o){f("VerticalScrollingHelper.restoreScrollPosition",e),g.start(e,g.RestoreScrollPosition,(function(r,l,i){if(t.Hook.call(e,a.Signal,"StartTableUpdate"),i.onPromiseCreated=function(o){o.then((function(){i.isCancelled()||h._restoreScrollPosition(e)})).finally((function(){t.Hook.call(e,a.Signal,"EndTableUpdate")}))},!0===o){var n=function(){return f("VerticalScrollingHelper.restoreScrollPosition (async: rows updated)",e),r(),!1};h.addOnRowsUpdatedPreprocessor(e,n),i.addCancelListener((function(){h.removeOnRowsUpdatedPreprocessor(e,n)&&r()}))}else r()}))},_restoreScrollPosition:function(e){var t=s(e).oVerticalScrollPosition.isInitial();f("VerticalScrollingHelper.restoreScrollPosition: Scroll position is"+(t?" ":" not ")+"initial",e),t?h.performUpdateFromFirstVisibleRow(e):h.performUpdateFromScrollPosition(e)},onTotalRowCountChanged:function(){h.adjustToTotalRowCount(this)},adjustToTotalRowCount:function(e){var o=e._getScrollExtension();f("VerticalScrollingHelper.adjustToTotalRowCount",e),h.updateScrollbarVisibility(e),S.updateScrollbar(e),o.updateVerticalScrollHeight(),g.start(e,g.AdjustToTotalRowCount,(function(o,r,l){if(t.Hook.call(e,a.Signal,"StartTableUpdate"),l.onPromiseCreated=function(o){o.then((function(){l.isCancelled()||s(e).oVerticalScrollPosition.isInitial()||h.performUpdateFromScrollPosition(e)})).finally((function(){t.Hook.call(e,a.Signal,"EndTableUpdate")}))},s(e).oVerticalScrollPosition.isInitial())o();else{var i=function(){return f("VerticalScrollingHelper.adjustToTotalRowCount (async: rows updated)",e),o(),!1};h.addOnRowsUpdatedPreprocessor(e,i),l.addCancelListener((function(){h.removeOnRowsUpdatedPreprocessor(e,i)&&o()}))}}))},onUpdateTableSizes:function(e){h.updateScrollbarVisibility(this),S.updateScrollbar(this)},updateScrollbarVisibility:function(e){var t=e._getScrollExtension(),o=t.getVerticalScrollbar(),r=e?e.getDomRef():null;if(o&&r){var l=t.isVerticalScrollbarRequired();r.classList.toggle("sapUiTableVScr",l&&!t.isVerticalScrollbarExternal()),o.parentElement.classList.toggle("sapUiTableHidden",!l)}},addEventListeners:function(e){var t=e._getScrollExtension(),o=h.getScrollAreas(e),r=e.getDomRef("tableCCnt");t._onVerticalScrollEventHandler||(t._onVerticalScrollEventHandler=h.onScrollbarScroll.bind(e));for(var l=0;l<o.length;l++)o[l].addEventListener("scroll",t._onVerticalScrollEventHandler);r&&(t._onViewportScrollEventHandler||(t._onViewportScrollEventHandler=h.onViewportScroll.bind(e)),r.addEventListener("scroll",t._onViewportScrollEventHandler)),e.attachRowsUpdated(h.onRowsUpdated)},removeEventListeners:function(e){var t=e._getScrollExtension(),o=h.getScrollAreas(e),r=e.getDomRef("tableCCnt");if(t._onVerticalScrollEventHandler){for(var l=0;l<o.length;l++)o[l].removeEventListener("scroll",t._onVerticalScrollEventHandler);delete t._onVerticalScrollEventHandler}r&&t._onViewportScrollEventHandler&&(r.removeEventListener("scroll",t._onViewportScrollEventHandler),delete t._onViewportScrollEventHandler),e.detachRowsUpdated(h.onRowsUpdated)},getScrollAreas:function(e){return[e._getScrollExtension().getVerticalScrollbar()].filter((function(e){return null!=e}))}},b={onMouseWheelScrolling:function(e,o){var r=this._getScrollExtension(),l=Math.abs(o.deltaY)>Math.abs(o.deltaX),i=l?o.deltaY:o.deltaX,n=l&&o.shiftKey||!l,a=i>0,c=!1;if(0!==i)if(!n||e.scrollDirection!==d.HORIZONAL&&e.scrollDirection!==d.BOTH){if(!n&&(e.scrollDirection===d.VERTICAL||e.scrollDirection===d.BOTH)){var f=r.getVerticalScrollbar(),p=s(this).oVerticalScrollPosition;if(c=a?f.scrollTop===f.scrollHeight-f.offsetHeight:0===f.scrollTop,!r.isVerticalScrollbarVisible()||c)return;if(o.preventDefault(),o.stopPropagation(),o.deltaMode===window.WheelEvent.DOM_DELTA_PIXEL){var u=i/this._getDefaultRowHeight();u>=0?p.scrollRows(Math.max(1,Math.floor(u))):p.scrollRows(Math.min(-1,Math.ceil(u)))}else o.deltaMode===window.WheelEvent.DOM_DELTA_LINE?p.scrollRows(i):o.deltaMode===window.WheelEvent.DOM_DELTA_PAGE&&p.scrollRows(i*this._getRowCounts()._scrollSize);this._getKeyboardExtension().setActionMode(!1),h.performUpdateFromScrollPosition(this)}}else{var g=r.getHorizontalScrollbar();if(o.deltaMode!==window.WheelEvent.DOM_DELTA_PIXEL){var S=t.Column.getMinColumnWidth();i=a?S:-S}c=a?g.scrollLeft===g.scrollWidth-g.offsetWidth:0===g.scrollLeft,r.isHorizontalScrollbarVisible()&&!c&&(o.preventDefault(),o.stopPropagation(),this._getKeyboardExtension().setActionMode(!1),g.scrollLeft=g.scrollLeft+i)}},onTouchStart:function(e,t){if("touchstart"===t.type||"touch"===t.pointerType){var o=this._getScrollExtension(),r=o.getHorizontalScrollbar(),l=o.getVerticalScrollbar(),i=t.touches?t.touches[0]:t;s(this).mTouchSessionData={initialPageX:i.pageX,initialPageY:i.pageY,initialScrollTop:l?l.scrollTop:0,initialScrollLeft:r?r.scrollLeft:0,initialScrolledToEnd:null,touchMoveDirection:null}}},onTouchMoveScrolling:function(e,t){if("touchmove"===t.type||"touch"===t.pointerType){var o=this._getScrollExtension(),r=s(this).mTouchSessionData;if(r){var l=t.touches?t.touches[0]:t,i=l.pageX-r.initialPageX,n=l.pageY-r.initialPageY,a=!1;if(!r.touchMoveDirection){if(0===i&&0===n)return;r.touchMoveDirection=Math.abs(i)>Math.abs(n)?"horizontal":"vertical"}switch(r.touchMoveDirection){case"horizontal":var c=o.getHorizontalScrollbar();!c||e.scrollDirection!==d.HORIZONAL&&e.scrollDirection!==d.BOTH||(this._getKeyboardExtension().setActionMode(!1),null==r.initialScrolledToEnd&&(r.initialScrolledToEnd=i<0?c.scrollLeft===c.scrollWidth-c.offsetWidth:0===c.scrollLeft),r.initialScrolledToEnd||(c.scrollLeft=r.initialScrollLeft-i,a=!0));break;case"vertical":var f=o.getVerticalScrollbar();!f||e.scrollDirection!==d.VERTICAL&&e.scrollDirection!==d.BOTH||(this._getKeyboardExtension().setActionMode(!1),null==r.initialScrolledToEnd&&(r.initialScrolledToEnd=n<0?f.scrollTop===f.scrollHeight-f.offsetHeight:0===f.scrollTop),r.initialScrolledToEnd||(f.scrollTop=r.initialScrollTop-n,a=!0))}a&&t.preventDefault()}}},addEventListeners:function(e){var t=e._getScrollExtension(),o=b.getEventListenerTargets(e);t._mMouseWheelEventListener=this.addMouseWheelEventListener(o,e,{scrollDirection:d.BOTH}),t._mTouchEventListener=this.addTouchEventListener(o,e,{scrollDirection:d.BOTH})},addMouseWheelEventListener:function(e,t,o){for(var r=b.onMouseWheelScrolling.bind(t,o),l=0;l<e.length;l++)e[l].addEventListener("wheel",r);return{wheel:r}},addTouchEventListener:function(e,t,o){for(var l=b.onTouchStart.bind(t,o),i=b.onTouchMoveScrolling.bind(t,o),n={},a=0;a<e.length;a++)r.support.pointer&&r.system.desktop?(e[a].addEventListener("pointerdown",l),e[a].addEventListener("pointermove",i,!!r.browser.chrome&&{passive:!0})):r.support.touch&&(e[a].addEventListener("touchstart",l),e[a].addEventListener("touchmove",i));return r.support.pointer&&r.system.desktop?n={pointerdown:l,pointermove:i}:r.support.touch&&(n={touchstart:l,touchmove:i}),n},removeEventListeners:function(e){var t=e._getScrollExtension(),o=b.getEventListenerTargets(e);function r(e,t){for(var o in t){var r=t[o];r&&e.removeEventListener(o,r)}}for(var l=0;l<o.length;l++)r(o[l],t._mMouseWheelEventListener),r(o[l],t._mTouchEventListener);delete t._mMouseWheelEventListener,delete t._mTouchEventListener},getEventListenerTargets:function(e){return[e.getDomRef("tableCCnt")].filter((function(e){return null!=e}))}},v={onBeforeRendering:function(e){this._getScrollExtension()._clearCache()},onAfterRendering:function(e){var t=this._getScrollExtension();null!=e&&e.isMarked("renderRows")&&(t.updateVerticalScrollbarHeight(),t.updateVerticalScrollHeight()),h.restoreScrollPosition(this,null!=this.getBinding()),S.restoreScrollPosition(this)},onfocusin:function(e){var o,l=t.getCellInfo(e.target),i=this._getScrollExtension().getHorizontalScrollbar();if(l.isOfType(t.CELLTYPE.DATACELL)?o=this.getDomRef("sapUiTableCtrlScr"):l.isOfType(t.CELLTYPE.COLUMNHEADER)&&(o=this.getDomRef("sapUiTableColHdrScr")),o&&i&&l.columnIndex>=this.getComputedFixedColumnCount()){var n,s=jQuery(i),c=l.cell[0],d=this._bRtlMode?s.scrollLeftRTL():i.scrollLeft,f=o.clientWidth,p=c.offsetLeft,u=p-d,g=p+c.offsetWidth-f-d;u<0&&g<0?n=d+u:g>0&&u>0&&(n=d+g),null!=n&&(this._bRtlMode?s.scrollLeftRTL(n):i.scrollLeft=n)}var S=t.getParentCell(this,e.target);if(S){var h=this,b=function(){var e=S.find(".sapUiTableCellInner");e.length>0&&(h._bRtlMode?e.scrollLeftRTL(e[0].scrollWidth-e[0].clientWidth):e[0].scrollLeft=0,e[0].scrollTop=0),t.Hook.call(h,a.Signal,"EndFocusHandling"),t.Hook.call(h,a.Signal,"EndTableUpdate")};t.Hook.call(this,a.Signal,"StartTableUpdate"),t.Hook.call(this,a.Signal,"StartFocusHandling"),Promise.resolve().then((function(){r.browser.safari?window.setTimeout(b,0):b()}))}}},m=e.extend("sap.ui.table.extensions.Scrolling",{_init:function(e,o,r){var l=s(e);return l.oHorizontalScrollbar=null,l.iHorizontalScrollPosition=null,l.oVerticalScrollbar=null,l.oVerticalScrollPosition=new u(e),l.pVerticalScrollUpdateProcess=null,l.oExternalVerticalScrollbar=null,l.bIsVerticalScrollbarExternal=!1,l.mTimeouts={},l.mAnimationFrames={},l.mTouchSessionData=null,l.aOnRowsUpdatedPreprocessors=[],t.addDelegate(e,v,e),"ScrollExtension"},_attachEvents:function(){var e=this.getTable();S.addEventListeners(e),h.addEventListeners(e),b.addEventListeners(e),t.Hook.register(e,t.Hook.Keys.Table.TotalRowCountChanged,h.onTotalRowCountChanged,e),t.Hook.register(e,t.Hook.Keys.Table.UpdateSizes,h.onUpdateTableSizes,e)},_detachEvents:function(){var e=this.getTable();S.removeEventListeners(e),h.removeEventListeners(e),b.removeEventListeners(e),t.Hook.deregister(e,t.Hook.Keys.Table.TotalRowCountChanged,h.onTotalRowCountChanged,e),t.Hook.deregister(e,t.Hook.Keys.Table.UpdateSizes,h.onUpdateTableSizes,e)},destroy:function(){var o=this.getTable();this._clearCache(),o&&(t.removeDelegate(o,v),s(o).pVerticalScrollUpdateProcess&&(s(o).pVerticalScrollUpdateProcess.cancel(),s(o).pVerticalScrollUpdateProcess=null)),e.prototype.destroy.apply(this,arguments)}});return m.prototype.scrollVertically=function(e,t){var o=this.getTable();if(o){var r=o._getRowCounts(),l=o._getFirstRenderedRowIndex(),i=!0===t?r.scrollable:1;!0===e?s(o).oVerticalScrollPosition.setPosition(l+i,1,u.OffsetType.PercentageOfViewport):s(o).oVerticalScrollPosition.setPosition(Math.max(0,l-i)),h.performUpdateFromScrollPosition(o)}},m.prototype.scrollVerticallyMax=function(e){var t=this.getTable();t&&(!0===e?s(t).oVerticalScrollPosition.setPosition(t._getMaxFirstRenderedRowIndex(),1,u.OffsetType.PercentageOfViewport):s(t).oVerticalScrollPosition.setPosition(0),h.performUpdateFromScrollPosition(t))},m.prototype.getHorizontalScrollbar=function(){var e=this.getTable();return e?(e._bInvalid||s(e).oHorizontalScrollbar||(s(e).oHorizontalScrollbar=e.getDomRef(n.HorizontalScrollBar)),s(e).oHorizontalScrollbar):null},m.prototype.getVerticalScrollbar=function(){var e=this.getTable(),t=this.isVerticalScrollbarExternal();if(!e)return null;e._bInvalid||s(e).oVerticalScrollbar||(s(e).oVerticalScrollbar=e.getDomRef(n.VerticalScrollBar),!s(e).oVerticalScrollbar&&t&&(s(e).oVerticalScrollbar=s(e).oExternalVerticalScrollbar));var o=s(e).oVerticalScrollbar;return!o||t||o.isConnected?o:null},m.prototype.isHorizontalScrollbarVisible=function(){var e=this.getHorizontalScrollbar();return null!=e&&!e.classList.contains("sapUiTableHidden")},m.prototype.isVerticalScrollbarVisible=function(){var e=this.getVerticalScrollbar();return null!=e&&!e.parentElement.classList.contains("sapUiTableHidden")},m.prototype.isVerticalScrollbarExternal=function(){var e=this.getTable();return!!e&&s(e).bIsVerticalScrollbarExternal},m.prototype.markVerticalScrollbarAsExternal=function(e){var t=this.getTable();t&&e&&(s(t).bIsVerticalScrollbarExternal=!0,s(t).oExternalVerticalScrollbar=e)},m.prototype.updateVerticalScrollbarHeight=function(){var e=this.getTable(),t=this.getVerticalScrollbar();e&&t&&(t.style.maxHeight=this.getVerticalScrollbarHeight()+"px",t._scrollTop=t.scrollTop)},m.prototype.getVerticalScrollbarHeight=function(){var e=this.getTable();return e?e._getRowCounts()._scrollSize*e._getBaseRowHeight():0},m.prototype.updateVerticalScrollPosition=function(e){var t=this.getTable();t&&((e=!0===e)||t.getBinding()?h.performUpdateFromFirstVisibleRow(t,e):h.adjustScrollPositionToFirstVisibleRow(t))},m.prototype.restoreVerticalScrollPosition=function(){h.restoreScrollPosition(this.getTable())},m.prototype.updateVerticalScrollHeight=function(){var e=this.getVerticalScrollbar(),t=e?e.firstChild:null;t&&(t.style.height=this.getVerticalScrollHeight()+"px",e._scrollTop=e.scrollTop)},m.prototype.getVerticalScrollHeight=function(e){var o=this.getTable();if(!o)return 0;var r,l=o._getTotalRowCount(),i=o._getRowCounts(),n=Math.max(l,i.count),a=o._getBaseRowHeight();return r=t.isVariableRowHeightEnabled(o)?a*(n-1)+h.getScrollRangeBuffer(o):a*n,!0===e?r:Math.min(c,r)},m.prototype.isVerticalScrollbarRequired=function(){var e=this.getTable();return!!e&&(t.isVariableRowHeightEnabled(e)&&h.getScrollRangeOfViewport(e)>0||e._getTotalRowCount()>e._getRowCounts()._fullsize)},m.prototype.registerForMouseWheel=function(t,o){var r=this.getTable();return e.isEnrichedWith(r,"sap.ui.table.extensions.Synchronization")?b.addMouseWheelEventListener(t,r,o):(i.error("This method can only be used with synchronization enabled.",r,"sap.ui.table.extensions.Scrolling#registerForMouseWheel"),null)},m.prototype.registerForTouch=function(t,o){var r=this.getTable();return e.isEnrichedWith(r,"sap.ui.table.extensions.Synchronization")?b.addTouchEventListener(t,r,o):(i.error("This method can only be used with synchronization enabled.",r,"sap.ui.table.extensions.Scrolling#registerForTouch"),null)},m.prototype._clearCache=function(){var e=this.getTable();e&&(s(e).oVerticalScrollbar=null,s(e).oHorizontalScrollbar=null)},m.ScrollDirection=d,m}));