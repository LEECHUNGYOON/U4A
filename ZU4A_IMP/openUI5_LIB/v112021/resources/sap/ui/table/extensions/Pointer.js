sap.ui.define(["./ExtensionBase","../utils/TableUtils","../library","sap/ui/Device","sap/ui/core/Element","sap/ui/core/Popup","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/scrollLeftRTL","sap/ui/dom/jquery/control"],(function(e,t,i,o,n,s,l,jQuery){"use strict";var a=i.SelectionMode,r=i.SelectionBehavior,d=["sapMBtnBase","sapMInputBase","sapMLnk","sapMSlt","sapMCb","sapMRI","sapMSegBBtn","sapUiIconPointer","sapMBtnIcon","sapMObjStatusActive"],u={_getEventPosition:function(e,t){var i;return{x:(i=function(i){if(!t._isTouchEvent(i))return null;for(var o=["touches","targetTouches","changedTouches"],n=0;n<o.length;n++){var s=o[n];if(e[s]&&e[s][0])return e[s][0];if(e.originalEvent[s]&&e.originalEvent[s][0])return e.originalEvent[s][0]}return null}(e)||e).pageX,y:i.pageY}},_skipClick:function(e,i,o){if(!o.isOfType(t.CELLTYPE.DATACELL|t.CELLTYPE.ROWACTION))return!1;if(e.isMarked())return!0;var s=n.closestTo(i[0]);if(s){var l=s.$();if(l.length)for(var a=0;a<d.length;a++)if(l.hasClass(d[a]))return"function"!=typeof s.getEnabled||s.getEnabled()}return!1},_handleClickSelection:function(e,i,o){t.toggleRowSelection(o,i,null,(function(t){var i=o._getSelectionPlugin();e.shiftKey?i.setSelected(t,!0,{range:!0}):o._legacyMultiSelection?o._legacyMultiSelection(t.getIndex(),e):i.setSelected(t,!i.isSelected(t))}))}},h={initColumnResizing:function(e,t){if(!e._bIsColumnResizerMoving){e._bIsColumnResizerMoving=!0,e._bColumnResizerMoved=!1,e._iColumnResizeStart=u._getEventPosition(t,e).x,e.$().toggleClass("sapUiTableResizing",!0);var i=jQuery(document),o=e._isTouchEvent(t);e._$colResize=e.$("rsz"),i.on((o?"touchend":"mouseup")+".sapUiTableColumnResize",h.exitColumnResizing.bind(e)),i.on((o?"touchmove":"mousemove")+".sapUiTableColumnResize",h.onMouseMoveWhileColumnResizing.bind(e)),e._disableTextSelection()}},exitColumnResizing:function(e){var i=u._getEventPosition(e,this).x,o=this._getVisibleColumns()[this._iLastHoveredVisibleColumnIndex],n=this.$().find('th[data-sap-ui-colid="'+o.getId()+'"]'),s=n[0].offsetWidth,l=s-n.width(),a=i-(n.offset().left+(this._bRtlMode?0:s)),r=Math.round(s+a*(this._bRtlMode?-1:1))-l,d=Math.max(r,t.Column.getMinColumnWidth());h._resizeColumn(this,this._iLastHoveredVisibleColumnIndex,this._bColumnResizerMoved?d:null)},onMouseMoveWhileColumnResizing:function(e){var t=u._getEventPosition(e,this).x,i=this.$().find(".sapUiTableCnt").offset().left,o=Math.floor(t-i);!this._bColumnResizerMoved&&Math.abs(t-this._iColumnResizeStart)>=5&&(this._bColumnResizerMoved=!0),this._$colResize.css("left",o+"px"),this._$colResize.toggleClass("sapUiTableColRszActive",!0),this._isTouchEvent(e)&&(e.stopPropagation(),e.preventDefault())},_cleanupColumResizing:function(e){e._$colResize&&(e._$colResize.toggleClass("sapUiTableColRszActive",!1),e._$colResize=null),e._bIsColumnResizerMoving=!1,e.$().toggleClass("sapUiTableResizing",!1),e._enableTextSelection();var t=jQuery(document);t.off("touchmove.sapUiTableColumnResize"),t.off("touchend.sapUiTableColumnResize"),t.off("mousemove.sapUiTableColumnResize"),t.off("mouseup.sapUiTableColumnResize")},_resizeColumn:function(e,i,o){var n,s=e._getVisibleColumns();i>=0&&i<s.length&&(n=s[i],null!=o&&t.Column.resizeColumn(e,e.indexOfColumn(n),o)),h._cleanupColumResizing(e),n.focus()},doAutoResizeColumn:function(e,t){var i,o=e._getVisibleColumns();if(t>=0&&t<o.length){if(!(i=o[t]).getAutoResizable()||!i.getResizable())return;var n=h._calculateAutomaticColumnWidth.apply(e,[i,t]);n&&h._resizeColumn(e,t,n)}},_calculateAutomaticColumnWidth:function(e,i){e=e||this.getColumns()[i];var o=this.$(),n=jQuery("<div>").addClass("sapUiTableHiddenSizeDetector sapUiTableHeaderDataCell sapUiTableDataCell");o.append(n);var s=o.find('td[data-sap-ui-colid = "'+e.getId()+'"]:not([colspan])').filter((function(e,t){return"none"!=t.style.display})).children().clone();s.removeAttr("id");var l=n.append(s).width()+4;return l=Math.min(l,o.find(".sapUiTableCnt").width()),l=Math.max(l+4,t.Column.getMinColumnWidth()),n.remove(),l},initColumnTracking:function(e){e.$().find(".sapUiTableCtrlScr, .sapUiTableCtrlScrFixed").on("mousemove",function(e){var t=this.getDomRef("sapUiTableCnt");if(t&&!this._bIsColumnResizerMoving){for(var i=e.clientX,o=t.getBoundingClientRect(),n=0,s=this._bRtlMode?1e4:-1e4,l=0;l<this._aTableHeaders.length;l++){var a=this._aTableHeaders[l].getBoundingClientRect();if(this._bRtlMode){if(i<a.right-5&&i>=a.left){n=l,s=a.left-o.left;break}}else if(i>a.left+5&&i<=a.right){n=l,s=a.right-o.left;break}}var r=this._getVisibleColumns()[n];r&&r.getResizable()&&(this.$("rsz").css("left",s+"px"),this._iLastHoveredVisibleColumnIndex=n)}}.bind(e))}},c={initReordering:function(e,i,o){var n=e.getColumns()[i],l=n.$(),a=e.$();e._disableTextSelection(),a.addClass("sapUiTableDragDrop");var r=l.clone();r.find("*").addBack(r).removeAttr("id").removeAttr("data-sap-ui").removeAttr("tabindex"),r.attr("id",e.getId()+"-roghost").addClass("sapUiTableColReorderGhost").css({left:-1e4,top:-1e4,"z-index":s.getNextZIndex()}),r.toggleClass(t.getContentDensity(e),!0),r.appendTo(document.body),e._$ReorderGhost=e.getDomRef("roghost"),a.find("td[data-sap-ui-colid='"+n.getId()+"']").toggleClass("sapUiTableColReorderFade",!0),jQuery("<div id='"+e.getId()+"-roind' class='sapUiTableColReorderIndicator'><div class='sapUiTableColReorderIndicatorArrow'></div><div class='sapUiTableColReorderIndicatorInner'></div></div>").appendTo(e.getDomRef("sapUiTableCnt")),e._$ReorderIndicator=e.getDomRef("roind"),e._iDnDColIndex=i;var d=jQuery(document),u=e._isTouchEvent(o);d.on((u?"touchend":"mouseup")+".sapUiColumnMove",c.exitReordering.bind(e)),d.on((u?"touchmove":"mousemove")+".sapUiColumnMove",c.onMouseMoveWhileReordering.bind(e))},onMouseMoveWhileReordering:function(e){var i=u._getEventPosition(e,this),o=i.x,n=i.y,s=this._iNewColPos;this._iNewColPos=this._iDnDColIndex,e.preventDefault();var l=c.findColumnForPosition(this,o);if(l&&l.id){var a=this.getDomRef("sapUiTableColHdrScr"),r=jQuery(a),d=a.getBoundingClientRect(),h=r.outerWidth(),f=this._bRtlMode?r.scrollLeftRTL():r.scrollLeft();this._bReorderScroll=!1,o>d.left+h-40&&f+h<a.scrollWidth?(this._bReorderScroll=!0,c.doScroll(this,!this._bRtlMode),c.adaptReorderMarkerPosition(this,l,!1)):o<d.left+40&&f>0&&(this._bReorderScroll=!0,c.doScroll(this,this._bRtlMode),c.adaptReorderMarkerPosition(this,l,!1)),jQuery(this._$ReorderGhost).css({left:o+5,top:n+5}),!this._bReorderScroll&&l&&(l.before||l.after&&l.index==this._iDnDColIndex?this._iNewColPos=l.index:l.after&&l.index!=this._iDnDColIndex&&(this._iNewColPos=l.index+1),t.Column.isColumnMovableTo(this.getColumns()[this._iDnDColIndex],this._iNewColPos)?c.adaptReorderMarkerPosition(this,l,!0):this._iNewColPos=s)}else this._iNewColPos=s},exitReordering:function(e){var i=this._iDnDColIndex,o=this._iNewColPos,n=jQuery(document);n.off("touchmove.sapUiColumnMove"),n.off("touchend.sapUiColumnMove"),n.off("mousemove.sapUiColumnMove"),n.off("mouseup.sapUiColumnMove"),this._bReorderScroll=!1,this.$().removeClass("sapUiTableDragDrop"),delete this._iDnDColIndex,delete this._iNewColPos,jQuery(this._$ReorderGhost).remove(),delete this._$ReorderGhost,jQuery(this._$ReorderIndicator).remove(),delete this._$ReorderIndicator,this.$().find(".sapUiTableColReorderFade").removeClass("sapUiTableColReorderFade"),this._enableTextSelection(),t.Column.moveColumnTo(this.getColumns()[i],o)},findColumnForPosition:function(e,t){for(var i,o,n,s,l,a,r,d=0;d<e._aTableHeaders.length;d++)if(i=e._aTableHeaders[d],o=jQuery(i),n=i.getBoundingClientRect(),s=o.outerWidth(),a=t>=(l={left:n.left,center:n.left+s/2,right:n.left+s,width:s,index:parseInt(o.attr("data-sap-ui-headcolindex")),id:o.attr("data-sap-ui-colid")}).left&&t<=l.center,r=t>=l.center&&t<=l.right,a||r)return l.before=e._bRtlMode?r:a,l.after=e._bRtlMode?a:r,l;return null},doScroll:function(e,t){if(e._mTimeouts.horizontalReorderScrollTimerId&&(window.clearTimeout(e._mTimeouts.horizontalReorderScrollTimerId),e._mTimeouts.horizontalReorderScrollTimerId=null),e._bReorderScroll){var i=t?30:-30;e._bRtlMode&&(i*=-1),e._mTimeouts.horizontalReorderScrollTimerId=setTimeout(c.doScroll.bind(e,e,t),60);var o=e.$("sapUiTableColHdrScr"),n=e._bRtlMode?"scrollLeftRTL":"scrollLeft";o[n](o[n]()+i)}},adaptReorderMarkerPosition:function(e,t,i){if(t&&e._$ReorderIndicator){var o=t.left-e.getDomRef().getBoundingClientRect().left;(e._bRtlMode&&t.before||!e._bRtlMode&&t.after)&&(o+=t.width),jQuery(e._$ReorderIndicator).css({left:o+"px"}).toggleClass("sapUiTableColReorderIndicatorActive",i)}}},f={ROWAREAS:[".sapUiTableRowSelectionCell",".sapUiTableRowActionCell",".sapUiTableCtrlFixed > tbody > .sapUiTableTr",".sapUiTableCtrlScroll > tbody > .sapUiTableTr"],initRowHovering:function(e){var t=e.$();f.ROWAREAS.forEach((function(i){f._initRowHoveringForArea(e,t,i)}))},_initRowHoveringForArea:function(e,t,i){t.find(i).on("mouseenter",(function(){f._onHover(e,t,i,this)})).on("mouseleave",(function(){f._onUnhover(e,t,i,this)}))},_onHover:function(e,t,i,o){if(e.getSelectionMode()!==a.None&&e.getSelectionBehavior()!==r.RowSelector||e.hasListeners("cellClick")){var n=t.find(i).index(o),s=e.getRows()[n];s&&s._setHovered(!0)}},_onUnhover:function(e,t,i,o){var n=t.find(i).index(o),s=e.getRows()[n];s&&s._setHovered(!1)}},C={onmousedown:function(e){var i,n=this._getPointerExtension(),s=t.getCell(this,e.target),l=t.getCellInfo(s),a=jQuery(e.target);if(this._getKeyboardExtension().initItemNavigation(),0===e.button){if(e.target===this.getDomRef("rsz"))e.preventDefault(),e.stopPropagation(),h.initColumnResizing(this,e);else if(a.hasClass("sapUiTableColResizer")){var r=a.closest(".sapUiTableHeaderCell").attr("data-sap-ui-colindex");this._iLastHoveredVisibleColumnIndex=this._getVisibleColumns().indexOf(this.getColumns()[r]),h.initColumnResizing(this,e)}else l.isOfType(t.CELLTYPE.COLUMNHEADER)&&((i=this.getColumns()[l.columnIndex].getAggregation("menu"))&&i.isOpen()||(n._bShowMenu=!0,this._mTimeouts.delayedMenuTimerId=setTimeout((function(){delete n._bShowMenu}),200)),!this.getEnableColumnReordering()||this._isTouchEvent(e)&&a.hasClass("sapUiTableColDropDown")||this._getPointerExtension().doReorderColumn(l.columnIndex,e));(o.browser.firefox&&(e.metaKey||e.ctrlKey)||1===a.closest(".sapUiTableHSb",this.getDomRef()).length||1===a.closest(".sapUiTableVSb",this.getDomRef()).length)&&e.preventDefault()}if(2===e.button){if(u._skipClick(e,a,l))return void(n._bShowDefaultMenu=!0);l.isOfType(t.CELLTYPE.COLUMNHEADER)?(i=this.getColumns()[l.columnIndex].getAggregation("menu"))&&i.isOpen()?n._bHideMenu=!0:n._bShowMenu=!0:l.isOfType(t.CELLTYPE.ANYCONTENTCELL)?n._bShowMenu=!0:n._bShowDefaultMenu=!0}},onmouseup:function(e){clearTimeout(this._mTimeouts.delayedColumnReorderTimerId)},ondblclick:function(e){o.system.desktop&&e.target===this.getDomRef("rsz")&&(e.preventDefault(),h.doAutoResizeColumn(this,this._iLastHoveredVisibleColumnIndex))},ontap:function(e){if(clearTimeout(this._mTimeouts.delayedColumnReorderTimerId),!e.isMarked()){var i=jQuery(e.target),o=t.getCell(this,e.target),n=t.getCellInfo(o),s=this.getRows()[n.rowIndex];if(n.isOfType(t.CELLTYPE.ANY))if(n.isOfType(t.CELLTYPE.COLUMNHEADER)){var a=this._getPointerExtension();a._bShowMenu&&(t.Menu.openContextMenu(this,e),delete a._bShowMenu)}else if(n.isOfType(t.CELLTYPE.COLUMNROWHEADER))this._getSelectionPlugin().onHeaderSelectorPress();else if(s&&s.isSummary())e.preventDefault();else if(i.hasClass("sapUiTableGroupMenuButton"))t.Menu.openContextMenu(this,e);else if(i.hasClass("sapUiTableGroupIcon")||i.hasClass("sapUiTableTreeIcon"))s.toggleExpandedState();else{if(u._skipClick(e,i,n))return;var r=window.getSelection().toString();if(!e.shiftKey&&r.length>0&&"\n"!==r)return void l.debug("DOM Selection detected -> Click event on table skipped, Target: "+e.target);this._findAndfireCellEvent(this.fireCellClick,e)?e.preventDefault():u._handleClickSelection(e,o,this)}}},oncontextmenu:function(e){var i=jQuery(e.target).closest(".sapUiTableDataCell").attr("id");if("function"!=typeof i.startsWith||!1!==i.startsWith(this.getId())){var o=this._getPointerExtension();if(o._bShowDefaultMenu)e.setMarked("sapUiTableHandledByPointerExtension"),delete o._bShowDefaultMenu;else if(o._bShowMenu){t.Menu.openContextMenu(this,e)&&e.preventDefault(),e.setMarked("sapUiTableHandledByPointerExtension"),delete o._bShowMenu}else o._bHideMenu&&(e.setMarked("sapUiTableHandledByPointerExtension"),e.preventDefault(),delete o._bHideMenu)}}},g=e.extend("sap.ui.table.extensions.Pointer",{_init:function(i,o,n){return this._delegate=C,t.addDelegate(i,this._delegate,i),i._iLastHoveredVisibleColumnIndex=0,i._bIsColumnResizerMoving=!1,i._iFirstReorderableIndex=o==e.TABLETYPES.TREE?1:0,"PointerExtension"},_attachEvents:function(){var e=this.getTable();e&&(h.initColumnTracking(e),f.initRowHovering(e))},_detachEvents:function(){var e=this.getTable();if(e){var t=e.$();t.find(".sapUiTableCtrlScr, .sapUiTableCtrlScrFixed").off(),t.find(".sapUiTableCtrl > tbody > tr").off(),t.find(".sapUiTableRowSelectionCell").off()}},_debug:function(){this._ExtensionHelper=u,this._ColumnResizeHelper=h,this._ReorderHelper=c,this._ExtensionDelegate=C,this._RowHoverHandler=f,this._KNOWNCLICKABLECONTROLS=d},doAutoResizeColumn:function(e){var t=this.getTable();t&&h.doAutoResizeColumn(t,e)},doReorderColumn:function(e,i){var o=this.getTable();o&&t.Column.isColumnMovable(o.getColumns()[e])&&(o._mTimeouts.delayedColumnReorderTimerId=setTimeout(function(){c.initReordering(this,e,i)}.bind(o),200))},destroy:function(){var t=this.getTable();t&&t.removeEventDelegate(this._delegate),this._delegate=null,e.prototype.destroy.apply(this,arguments)}});return g}));