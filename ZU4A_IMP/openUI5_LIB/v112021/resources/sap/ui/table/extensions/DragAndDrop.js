sap.ui.define(["./ExtensionBase","../utils/TableUtils","sap/ui/core/library"],(function(t,e,o){"use strict";var i="sap.ui.table",l=o.dnd.DropPosition,n={getSessionData:function(t,e){return t.getComplexData(i+(null==e?"":"-"+e))},setSessionData:function(t,e,o){t.setComplexData(i+(null==o?"":"-"+o),e)},getInstanceSessionData:function(t,e){return this.getSessionData(t,e.getId())},setInstanceSessionData:function(t,e,o){this.setSessionData(t,o,e.getId())},scrollVertically:e.throttle((function(t,e,o,i){t._getScrollExtension().getVerticalScrollbar().scrollTop+=this.calculateScrollDistance(o,i)*(e?1:-1)}),50),scrollHorizontally:e.throttle((function(t,e,o,i){t._getScrollExtension().getHorizontalScrollbar().scrollLeft+=this.calculateScrollDistance(o,i)*(e?1:-1)}),50),calculateScrollDistance:function(t,e){var o=e/t;return Math.max(2,Math.round(50*o))}},a={ondragstart:function(t){var e=t.dragSession;if(e&&e.getDragControl()){var o=e.getDragControl(),i={};if(o.isA("sap.ui.table.Row")){if(o.isEmpty()||o.isGroupHeader()||o.isSummary())return void t.preventDefault();i.draggedRowContext=o.getRowBindingContext()}n.setInstanceSessionData(e,this,i)}},ondragenter:function(t){var o=t.dragSession;if(o&&o.getDropControl()){var i=n.getInstanceSessionData(o,this),a=o.getDragControl(),r=o.getDropControl();if(a){if(i||(i={}),r.isA("sap.ui.table.Row")){var s=i.draggedRowContext,g=r.getRowBindingContext(),c=o.getDropInfo().getDropPosition();if(r.isEmpty()&&c===l.On&&e.hasData(this)||s&&s===g||r.isGroupHeader()||r.isSummary())t.setMarked("NonDroppable");else{if(!g){var u=this.getRows()[e.getNonEmptyRowCount(this)-1];o.setDropControl(u||this)}if(o.getDropControl()!==this){var f=this.getDomRef().classList.contains("sapUiTableVScr"),d=this.getDomRef("sapUiTableCnt").getBoundingClientRect();o.setIndicatorConfig({width:d.width-(f?16:0),left:d.left+(this._bRtlMode&&f?16:0)})}}}else if(r.isA("sap.ui.table.Column")){var h=e.getCellInfo(e.getCell(this,t.target)).columnIndex;if(a.isA("sap.ui.table.Column")&&!e.Column.isColumnMovableTo(a,h,!0))return void t.setMarked("NonDroppable");d=this.getDomRef("sapUiTableCnt").getBoundingClientRect();o.setIndicatorConfig({height:d.height-(this._getScrollExtension().isHorizontalScrollbarVisible()?16:0)})}else a===r&&t.setMarked("NonDroppable");if(!i.verticalScrollEdge){var p=window.pageYOffset,D=this.getDomRef("table").getBoundingClientRect();i.verticalScrollEdge={bottom:D.bottom+p,top:D.top+p}}var S=window.pageXOffset,C=this.getDomRef("sapUiTableCtrlScr").getBoundingClientRect();i.horizontalScrollEdge={left:C.left+S,right:C.right+S},n.setInstanceSessionData(o,this,i)}}},ondragover:function(t){var e=t.dragSession;if(e){var o=n.getInstanceSessionData(e,this);if(o){var i=50,l=e.getDropControl(),a=this._getScrollExtension(),r=a.getVerticalScrollbar(),s=a.getHorizontalScrollbar(),g=o.verticalScrollEdge,c=o.horizontalScrollEdge;if(g&&r&&l!==this){var u=t.pageY;u>=g.top-i&&u<=g.top+i?n.scrollVertically(this,!1,100,g.top+i-u):u<=g.bottom+i&&u>=g.bottom-i&&n.scrollVertically(this,!0,100,u-g.bottom+i)}if(c&&s&&l!==this){var f=t.pageX;f>=c.left-i&&f<=c.left+i?n.scrollHorizontally(this,!1,100,c.left+i-f):f<=c.right+i&&f>=c.right-i&&n.scrollHorizontally(this,!0,100,f-c.right+i)}}}},onlongdragover:function(t){var o=t.dragSession;if(o){var i=e.getCell(this,t.target),l=e.getCellInfo(i).rowIndex,n=null==l?null:this.getRows()[l],a=o.getDropControl();!n||a!==n&&a||n.expand()}},ondragend:function(t){n.scrollVertically.cancel(),n.scrollHorizontally.cancel()}},r=t.extend("sap.ui.table.extensions.DragAndDrop",{_init:function(t,o,i){return this._oDelegate=a,e.addDelegate(t,this._oDelegate,t),"DragAndDropExtension"},_debug:function(){this._ExtensionDelegate=a},destroy:function(){var e=this.getTable();e&&e.removeEventDelegate(this._oDelegate),n.scrollVertically.cancel(),n.scrollHorizontally.cancel(),this._oDelegate=null,t.prototype.destroy.apply(this,arguments)}});return r}));