sap.ui.define(["sap/ui/core/Control","./library","sap/ui/core/LabelEnablement","sap/ui/core/InvisibleText","sap/ui/core/library","sap/ui/core/StaticArea","sap/ui/Device","./FileUploaderRenderer","sap/ui/dom/containsOrEquals","sap/ui/events/KeyCodes","sap/base/Log","sap/base/security/encodeXML","sap/ui/thirdparty/jquery","sap/ui/core/Configuration","./FileUploaderHelper","sap/ui/dom/jquery/Aria"],(function(e,t,i,o,s,r,a,l,n,p,h,u,jQuery,d,f){var g=s.ValueState,c=t.FileUploaderHttpRequestMethod,y=e.extend("sap.ui.unified.FileUploader",{metadata:{interfaces:["sap.ui.core.IFormContent","sap.ui.unified.IProcessableBlobs"],library:"sap.ui.unified",designtime:"sap/ui/unified/designtime/FileUploader.designtime",properties:{value:{type:"string",group:"Data",defaultValue:""},enabled:{type:"boolean",group:"Behavior",defaultValue:!0},uploadUrl:{type:"sap.ui.core.URI",group:"Data",defaultValue:""},name:{type:"string",group:"Data",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:""},uploadOnChange:{type:"boolean",group:"Behavior",defaultValue:!1},additionalData:{type:"string",group:"Data",defaultValue:null},sameFilenameAllowed:{type:"boolean",group:"Behavior",defaultValue:!1},buttonText:{type:"string",group:"Misc",defaultValue:null},fileType:{type:"string[]",group:"Data",defaultValue:null},multiple:{type:"boolean",group:"Behavior",defaultValue:!1},maximumFileSize:{type:"float",group:"Data",defaultValue:null},mimeType:{type:"string[]",group:"Data",defaultValue:null},sendXHR:{type:"boolean",group:"Behavior",defaultValue:!1},httpRequestMethod:{type:"sap.ui.unified.FileUploaderHttpRequestMethod",group:"Behavior",defaultValue:c.Post},placeholder:{type:"string",group:"Appearance",defaultValue:null},style:{type:"string",group:"Appearance",defaultValue:null},buttonOnly:{type:"boolean",group:"Appearance",defaultValue:!1},useMultipart:{type:"boolean",group:"Behavior",defaultValue:!0},maximumFilenameLength:{type:"int",group:"Data",defaultValue:null},valueState:{type:"sap.ui.core.ValueState",group:"Data",defaultValue:g.None},valueStateText:{type:"string",group:"Misc",defaultValue:null},icon:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:""},iconHovered:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:""},iconSelected:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:""},iconFirst:{type:"boolean",group:"Appearance",defaultValue:!0},iconOnly:{type:"boolean",group:"Appearance",defaultValue:!1},directory:{type:"boolean",group:"Behavior",defaultValue:!1}},aggregations:{parameters:{type:"sap.ui.unified.FileUploaderParameter",multiple:!0,singularName:"parameter"},headerParameters:{type:"sap.ui.unified.FileUploaderParameter",multiple:!0,singularName:"headerParameter"},xhrSettings:{type:"sap.ui.unified.FileUploaderXHRSettings",multiple:!1}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaLabelledBy"}},events:{change:{parameters:{newValue:{type:"string"},files:{type:"object[]"}}},uploadComplete:{parameters:{fileName:{type:"string"},response:{type:"string"},readyStateXHR:{type:"string"},status:{type:"string"},responseRaw:{type:"string"},headers:{type:"object"},requestHeaders:{type:"object[]"}}},typeMissmatch:{parameters:{fileName:{type:"string"},fileType:{type:"string"},mimeType:{type:"string"}}},fileSizeExceed:{parameters:{fileName:{type:"string"},fileSize:{type:"string"}}},fileEmpty:{parameters:{fileName:{type:"string"}}},fileAllowed:{},uploadProgress:{parameters:{lengthComputable:{type:"boolean"},loaded:{type:"float"},total:{type:"float"},fileName:{type:"string"},requestHeaders:{type:"object[]"}}},uploadAborted:{parameters:{fileName:{type:"string"},requestHeaders:{type:"object[]"}}},filenameLengthExceed:{parameters:{fileName:{type:"string"}}},uploadStart:{parameters:{fileName:{type:"string"},requestHeaders:{type:"object[]"}}},beforeDialogOpen:{},afterDialogClose:{}}},renderer:l});return y.prototype.init=function(){var e=this;if(this.oFileUploaderHelper=f.getHelper(),this.oFilePath=this.oFileUploaderHelper.createTextField(this.getId()+"-fu_input").addEventDelegate({onAfterRendering:function(){e.getWidth()&&e._resizeDomElements()}}),this.oBrowse=this.oFileUploaderHelper.createButton(this.getId()+"-fu_button"),this.oFilePath.setParent(this),this.oBrowse.setParent(this),this.oFileUpload=null,this.bMobileLib="sap.m.Button"==this.oBrowse.getMetadata().getName(),d.getAccessibility()){if(!y.prototype._sAccText){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");y.prototype._sAccText=t.getText("FILEUPLOAD_ACC")}this.oBrowse.addAriaDescribedBy&&this.oBrowse.addAriaDescribedBy(this.getId()+"-AccDescr"),this.oFilePath&&this.oFilePath.addAriaLabelledBy(o.getStaticId("sap.ui.unified","FILEUPLOAD_FILENAME"))}this._submitAfterRendering=!1},y.prototype.setIcon=function(e){return this.oBrowse.setIcon(e),this.setProperty("icon",e,!1),this},y.prototype.setIconHovered=function(e){return this.setProperty("iconHovered",e,!1),this.oBrowse.setIconHovered&&this.oBrowse.setIconHovered(e),this},y.prototype.setIconSelected=function(e){return this.setProperty("iconSelected",e,!1),this.oBrowse.setIconSelected?this.oBrowse.setIconSelected(e):this.oBrowse.setActiveIcon(e),this},y.prototype.setIconFirst=function(e){return this.oBrowse.setIconFirst(e),this.setProperty("iconFirst",e,!1),this},y.prototype.getIdForLabel=function(){return this.oBrowse.getId()},y.prototype._ensureBackwardsReference=function(){var e=this.oBrowse,t=e.getAriaLabelledBy(),o=i.getReferencingLabels(this);return t&&o.forEach((function(i){-1===t.indexOf(i)&&e.addAriaLabelledBy(i)})),this},y.prototype.setFileType=function(e){var t=this._convertTypesToArray(e);return this.setProperty("fileType",t,!1),this._rerenderInputField(),this},y.prototype.setMimeType=function(e){var t=this._convertTypesToArray(e);return this.setProperty("mimeType",t,!1),this._rerenderInputField(),this},y.prototype.setMultiple=function(e){return this.setProperty("multiple",e,!1),this._rerenderInputField(),this},y.prototype.setDirectory=function(e){return this.setProperty("directory",e,!1),this._rerenderInputField(),this},y.prototype._rerenderInputField=function(){if(this.oFileUpload){var e=this.oFileUpload.files;if(this._clearInputField(),this._prepareFileUpload(),void 0===this.oFileUpload)return;if(null===this.oFileUpload)return;jQuery(this.oFileUpload).on("change",this.handlechange.bind(this)),this.oFileUpload.files=e,this._cacheDOMEls()}},y.prototype.setTooltip=function(t){var i;return e.prototype.setTooltip.call(this,t),this.oFileUpload&&((i=this.getTooltip_AsString())?this.oFileUpload.setAttribute("title",i):this.oFileUpload.setAttribute("title",this.getValue()?this.getValue():this._getNoFileChosenText())),this},y.prototype.addAriaLabelledBy=function(e){return this.addAssociation("ariaLabelledBy",e),this.oBrowse.addAriaLabelledBy(e),this},y.prototype.removeAriaLabelledBy=function(e){var t=this.removeAssociation("ariaLabelledBy",e);if(t)return this.oBrowse.removeAriaLabelledBy(t),t},y.prototype.removeAllAriaLabelledBy=function(){var e=this.removeAllAssociation("ariaLabelledBy"),t=this.oBrowse.getAriaLabelledBy();return e.forEach(function(e){t.indexOf(e)>=0&&this.oBrowse.removeAriaLabelledBy(e)}.bind(this)),e},y.prototype.addAriaDescribedBy=function(e){return this.addAssociation("ariaDescribedBy",e),this.oBrowse.addAriaDescribedBy(e),this},y.prototype.removeAriaDescribedBy=function(e){var t=this.removeAssociation("ariaDescribedBy",e);if(t)return this.oBrowse.removeAriaDescribedBy(t),t},y.prototype.removeAllAriaDescribedBy=function(){var e=this.removeAllAssociation("ariaDescribedBy"),t=this.oBrowse.getAriaDescribedBy();return e.forEach(function(e){t.indexOf(e)>=0&&this.oBrowse.removeAriaDescribedBy(e)}.bind(this)),e},y.prototype._generateAccDescriptionText=function(){var e=this.getTooltip_AsString(),t=this.getPlaceholder(),o=this.getValue(),s="";return i.isRequired(this)&&(s+=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified").getText("FILEUPLOAD_REQUIRED")+" "),e&&(s+=e+" "),o?s+=o+" ":t&&(s+=t+" "),s+=this._sAccText},y.prototype._convertTypesToArray=function(e){return"string"==typeof e?""===e?[]:e.split(",").map((function(e){return e.trim()})):e},y.prototype.exit=function(){this.oFilePath.destroy(),this.oBrowse.destroy(),this.oIFrameRef&&(jQuery(this.oIFrameRef).off(),r.getDomRef().removeChild(this.oIFrameRef),this.oIFrameRef=null),this.oFileUpload&&this._clearInputField(),this.FUEl&&(this.FUEl=null),this.FUDataEl&&(this.FUDataEl=null)},y.prototype._clearInputField=function(){jQuery(this.oFileUpload).off(),this.oFileUpload.parentElement.removeChild(this.oFileUpload),this.oFileUpload=null},y.prototype.onBeforeRendering=function(){var e=r.getDomRef();jQuery(this.oFileUpload).appendTo(e),this.getName()||h.warning("Name property is not set. Id would be used instead to identify the control on the server.",this),jQuery(this.oFileUpload).off(),this.getIconOnly()&&this.getButtonOnly()?(this.oBrowse.setText(""),this.oBrowse.setTooltip(this.getTooltip_AsString()||this.getBrowseText())):this.getIconOnly()?(this.oBrowse.setText(""),this.oBrowse.setTooltip(this.getBrowseText())):(this.oBrowse.setText(this.getButtonText()||this.getBrowseText()),this.oBrowse.setTooltip("")),this.oFilePath.setPlaceholder(this.getPlaceholder())},y.prototype.onAfterRendering=function(){this.prepareFileUploadAndIFrame(),this._cacheDOMEls(),this._addLabelFeaturesToBrowse(),jQuery(this.oFileUpload).on("change",this.handlechange.bind(this)),this.bMobileLib?this.oFilePath.$().find("input").attr("tabindex","-1"):this.oFilePath.$().attr("tabindex","-1"),setTimeout(this._recalculateWidth.bind(this),0),this.oFilePath.$().find("input").removeAttr("role").attr("aria-live","polite"),this._submitAfterRendering&&(this._submitAndResetValue(),this._submitAfterRendering=!1)},y.prototype._cacheDOMEls=function(){this.FUEl=this.getDomRef("fu"),this.FUDataEl=this.getDomRef("fu_data")},y.prototype.onfocusin=function(e){this.oFilePath.shouldValueStateMessageBeOpened&&!this.oFilePath.shouldValueStateMessageBeOpened()||this.openValueStateMessage()},y.prototype.onsapfocusleave=function(e){e.relatedControlId&&n(this.getDomRef(),sap.ui.getCore().byId(e.relatedControlId).getFocusDomRef())||this.closeValueStateMessage()},y.prototype._recalculateWidth=function(){this.getWidth()&&(this.getButtonOnly()&&this.oBrowse.getDomRef()&&(this.oBrowse.getDomRef().style.width=this.getWidth()),this._resizeDomElements())},y.prototype.getFocusDomRef=function(){return this.oBrowse.getDomRef()},y.prototype._resizeDomElements=function(){var e=this.getId();this._oBrowseDomRef=this.oBrowse.getDomRef();var t=jQuery(this._oBrowseDomRef),i=t.parent().outerWidth(!0);this._oFilePathDomRef=this.oFilePath.getDomRef();var o=this._oFilePathDomRef,s=this.getWidth();if("%"==s.substr(-1)&&o){for(;o.id!=e;)o.style.width="100%",o=o.parentNode;o.style.width=s}else if(o){o.style.width=s;var r=jQuery(this._oFilePathDomRef).outerWidth()-i;r<0?(this.oFilePath.getDomRef().style.width="0px",this.oFileUpload&&(this.oFileUpload.style.width=t.outerWidth(!0))):this.oFilePath.getDomRef().style.width=r+"px"}},y.prototype.onresize=function(){this._recalculateWidth()},y.prototype.onThemeChanged=function(){this._recalculateWidth()},y.prototype.setEnabled=function(e){var t=jQuery(this.oFileUpload);return this.setProperty("enabled",e,!1),this.oFilePath.setEnabled(e),this.oBrowse.setEnabled(e),this.getEnabled()?t.removeAttr("disabled"):t.attr("disabled","disabled"),this},y.prototype.setValueState=function(e){this.setProperty("valueState",e,!1),this.oFilePath.setValueState?this.oFilePath.setValueState(e):h.warning("Setting the valueState property with the combination of libraries used is not supported.",this);var t=n(this.getDomRef(),document.activeElement);switch(e){case g.Error:case g.Warning:case g.Success:this.oBrowse.addAssociation("ariaDescribedBy",this.oFilePath.getId()+"-message-sr"),t&&this.openValueStateMessage();break;default:this.oBrowse.removeAssociation("ariaDescribedBy",this.oFilePath.getId()+"-message-sr"),t&&this.closeValueStateMessage()}return this},y.prototype.setValueStateText=function(e){return this.oFilePath.setValueStateText?this.oFilePath.setValueStateText(e):h.warning("Setting the valueStateText property with the combination of libraries used is not supported.",this),this.setProperty("valueStateText",e,!1)},y.prototype.setStyle=function(e){return this.setProperty("style",e,!0),e&&("Transparent"==e?this.oBrowse.setLite?this.oBrowse.setLite(!0):this.oBrowse.setType("Transparent"):this.oBrowse.setType?this.oBrowse.setType(e):("Emphasized"==e&&(e="Emph"),this.oBrowse.setStyle(e))),this},y.prototype.setValue=function(e,t,i){var o;if(this.getValue()!=e||this.getSameFilenameAllowed()){var s=this.getUploadOnChange()&&e;this.setProperty("value",e,s),this.oFileUpload&&!this.getTooltip_AsString()&&this.oFileUpload.setAttribute("title",e||this._getNoFileChosenText()),this.oFilePath&&(this.oFilePath.setValue(e),this.oBrowse.getDomRef()&&!i&&n(this.getDomRef(),document.activeElement)&&this.oBrowse.focus());var r=this.getDomRef("fu_form"),a=this.getDomRef("fu_input-inner");this.oFileUpload&&r&&!e&&(r.reset(),this.getDomRef("fu_input").value="",a&&(a.value=""),jQuery(this.FUDataEl).val(this.getAdditionalData())),t&&(window.File&&(o=this.FUEl.files),this.getSameFilenameAllowed()&&!e||this.fireChange({id:this.getId(),newValue:e,files:o})),s&&this.upload()}return this},y.prototype.clear=function(){var e=this.getDomRef("fu_form");return e&&e.reset(),this.setValue("",!1,!0)},y.prototype.openFilePicker=function(){return this.oFileUpload&&this.oFileUpload.click(),this},y.prototype.getInputReference=function(){return this.oFileUpload},y.prototype.onmousedown=function(e){this.bMobileLib||this.oBrowse.onmousedown(e)},y.prototype.onmouseup=function(e){this.bMobileLib||this.oBrowse.onmouseup(e)},y.prototype.onmouseover=function(e){this.bMobileLib||(jQuery(this.oBrowse.getDomRef()).addClass("sapUiBtnStdHover"),this.oBrowse.onmouseover(e))},y.prototype.onmouseout=function(e){this.bMobileLib||(jQuery(this.oBrowse.getDomRef()).removeClass("sapUiBtnStdHover"),this.oBrowse.onmouseout(e))},y.prototype.setAdditionalData=function(e){this.setProperty("additionalData",e,!0);var t=this.FUDataEl;return t&&(e=this.getAdditionalData()||"",t.value=e),this},y.prototype.sendFiles=function(e,t){for(var i=this,o=!0,s=0;s<e.length;s++)if(!e[s].bPosted){o=!1;break}if(o)this.getSameFilenameAllowed()&&this.getUploadOnChange()&&i.setValue("",!0);else{var r=e[t],a=r.file.name?r.file.name:"MultipartFile",l=r.requestHeaders;r.xhr.upload.addEventListener("progress",(function(e){var t={lengthComputable:!!e.lengthComputable,loaded:e.loaded,total:e.total};i.fireUploadProgress({lengthComputable:t.lengthComputable,loaded:t.loaded,total:t.total,fileName:a,requestHeaders:l})})),r.xhr.onreadystatechange=function(){var e,t,o,s,n,p,h={};p=r.xhr.readyState;var u=r.xhr.status;if(4==r.xhr.readyState){if(r.xhr.responseXML&&(e=r.xhr.responseXML.documentElement.textContent),t=r.xhr.response,o=r.xhr.getAllResponseHeaders()){s=o.split("\r\n");for(var d=0;d<s.length;d++)s[d]&&(n=s[d].indexOf(": "),h[s[d].substring(0,n)]=s[d].substring(n+2))}i.fireUploadComplete({fileName:a,headers:h,response:e,responseRaw:t,readyStateXHR:p,status:u,requestHeaders:l})}i._bUploading=!1},0===r.xhr.readyState||r.bPosted?(t++,i.sendFiles(e,t)):(r.xhr.send(r.file),r.bPosted=!0,t++,i.sendFiles(e,t))}},y.prototype.upload=function(e){var t;if(this.getEnabled()){var i=this?.oFileUpload?.files?.length||0;if(void 0!==window?.oU4A&&i>0)return this.fireUploadStart(),this.fireUploadComplete(),void this._resetValueAfterUploadStart();t=this.getDomRef("fu_form");try{if(this._bUploading=!0,this.getSendXHR()&&window.File){var o=this.FUEl.files;e?this._sendProcessedFilesWithXHR(o):this._sendFilesWithXHR(o)}else t&&(t.getAttribute("action")!==this.getUploadUrl()?this._submitAfterRendering=!0:this._submitAndResetValue())}catch(e){h.error("File upload failed:\n"+e.message)}}},y.prototype._u4aCollectFiles=function(e){void 0!==window?.oU4A?.comm&&oU4A.comm.get("collectUploadFiles")(this?.oFileUpload?.files,e)},y.prototype._u4aClearFiles=function(){!0!==this.getUploadOnChange()&&this.setValue()},y.prototype._submitAndResetValue=function(){this.getDomRef("fu_form").submit(),this.fireUploadStart(),this._resetValueAfterUploadStart()},y.prototype.abort=function(e,t){if(this.getUseMultipart())this._uploadXHR&&this._uploadXHR.abort&&(this._uploadXHR.abort(),this.fireUploadAborted({fileName:null,requestHeaders:null}),h.info("File upload aborted."));else for(var i=this._aXhr.length-1;i>-1;i--)if(e&&t)for(var o=0;o<this._aXhr[i].requestHeaders.length;o++){var s=this._aXhr[i].requestHeaders[o].name,r=this._aXhr[i].requestHeaders[o].value;if(s==e&&r==t){this._aXhr[i].xhr.abort(),this.fireUploadAborted({fileName:this._aXhr[i].fileName,requestHeaders:this._aXhr[i].requestHeaders}),this._aXhr.splice(i,1),h.info("File upload aborted.");break}}else this._aXhr[i].xhr.abort(),this.fireUploadAborted({fileName:this._aXhr[i].fileName,requestHeaders:this._aXhr[i].requestHeaders}),this._aXhr.splice(i,1),h.info("File upload aborted.")},y.prototype.onclick=function(e){this.getSameFilenameAllowed()&&this.getEnabled()&&this.setValue("",!0),this.oBrowse.getDomRef()&&(a.browser.safari||n(this.getDomRef(),document.activeElement))&&this.oBrowse.focus(),"file"===e.target.getAttribute("type")&&(this.fireBeforeDialogOpen(),document.body.onfocus=function(){this.fireAfterDialogClose(),document.body.onfocus=null}.bind(this))},y.prototype.onkeydown=function(e){this.getEnabled()&&(this.getSameFilenameAllowed()&&this.getUploadOnChange()&&this.setValue("",!0),e.keyCode===p.ENTER&&this.oFileUpload&&(this.oFileUpload.click(),e.preventDefault(),e.stopPropagation()),this.oBrowse._bPressedSpace=!1)},y.prototype.onkeyup=function(e){if(this.getEnabled()){this.getSameFilenameAllowed()&&this.getUploadOnChange()&&this.setValue("",!0);var t=e.keyCode,i=p;t===i.DELETE||t===i.BACKSPACE?this.oFileUpload&&this.setValue("",!0):t===i.SPACE?(this.oFileUpload.click(),e.preventDefault(),e.stopPropagation()):t!==i.TAB&&t!==i.SHIFT&&t!==i.F6&&t!==i.PAGE_UP&&t!==i.PAGE_DOWN&&t!==i.ESCAPE&&t!==i.END&&t!==i.HOME&&t!==i.ARROW_LEFT&&t!==i.ARROW_UP&&t!==i.ARROW_RIGHT&&t!==i.ARROW_DOWN&&(e.preventDefault(),e.stopPropagation()),this.oBrowse._bPressedSpace=!1}},y.prototype._isFilenameTooLong=function(e){var t=this.getMaximumFilenameLength();return 0!==t&&e.length>t&&(h.info("The filename of "+e+" ("+e.length+" characters)  is longer than the maximum of "+t+" characters."),!0)},y.prototype.handlechange=function(e){if(this.oFileUpload&&this.getEnabled()){var t,i,o,s,r=this.getFileType(),l="",n=this.getDomRef("fu_form");if(window.File){var p=e.target.files;if(!this._areFilesAllowed(p))return n.reset(),void this.setValue("",!0,!0);this.fireFileAllowed(),l=this._generateInputValue(p)}else if(r&&r.length>0){t=!0,s=-1===(o=(i=this.oFileUpload.value||"").lastIndexOf("."))?"":i.substring(o+1);for(var u=0;u<r.length;u++)s==r[u]&&(t=!1);if(t)return h.info("File: "+i+" is of type "+s+". Allowed types are: "+r+"."),this.fireTypeMissmatch({fileName:i,fileType:s}),n.reset(),void this.setValue("",!0,!0);if(this._isFilenameTooLong(i))return this.fireFilenameLengthExceed({fileName:i}),n.reset(),void this.setValue("",!0,!0);i&&this.fireFileAllowed()}var d=this.oFileUpload.value||"",f=d.lastIndexOf("\\");f>=0&&(d=d.substring(f+1)),(this.getMultiple()||this.getDirectory())&&(d=l),(d||a.browser.chrome)&&this.setValue(d,!0)}},y.prototype._sendFilesWithXHR=function(e){var t,i,o,s,r=this.getXhrSettings();if(e.length>0){t=this.getUseMultipart()?1:e.length,this._aXhr=this._aXhr||[];for(var a=0;a<t;a++){if(this._uploadXHR=new window.XMLHttpRequest,s={xhr:this._uploadXHR,requestHeaders:[]},this._aXhr.push(s),s.xhr.open(this.getHttpRequestMethod(),this.getUploadUrl(),!0),r&&(s.xhr.withCredentials=r.getWithCredentials()),this.getHeaderParameters())for(var l=this.getHeaderParameters(),n=0;n<l.length;n++)i=l[n].getName(),o=l[n].getValue(),s.requestHeaders.push({name:i,value:o});var p=e[a].name,h=s.requestHeaders;s.fileName=p,s.file=e[a],this.fireUploadStart({fileName:p,requestHeaders:h});for(var u=0;u<h.length&&0!==s.xhr.readyState;u++)i=h[u].name,o=h[u].value,s.xhr.setRequestHeader(i,o)}if(this.getUseMultipart()){for(var d=new window.FormData,f=this.FUEl.name,g=0;g<e.length;g++)this._appendFileToFormData(d,f,e[g]);d.append("_charset_","UTF-8");var c=this.FUDataEl.name;if(this.getAdditionalData()){var y=this.getAdditionalData();d.append(c,y)}else d.append(c,"");if(this.getParameters())for(var m=this.getParameters(),F=0;F<m.length;F++){var b=m[F].getName();o=m[F].getValue(),d.append(b,o)}s.file=d,this.sendFiles(this._aXhr,0)}else this.sendFiles(this._aXhr,0);this._bUploading=!1,this._resetValueAfterUploadStart()}return this},y.prototype._appendFileToFormData=function(e,t,i){i instanceof window.Blob&&i.name?e.append(t,i,i.name):e.append(t,i)},y.prototype._sendProcessedFilesWithXHR=function(e){return this.getProcessedBlobsFromArray(e).then(function(e){this._sendFilesWithXHR(e)}.bind(this)).catch((function(e){h.error(e.message?e.message:"no details available")})),this},y.prototype._areFilesAllowed=function(e){for(var t,i,o,s,r,a=this.getMaximumFileSize(),l=this.getMimeType(),n=this.getFileType(),p=0;p<e.length;p++){t=e[p].name,r=e[p].type||"unknown";var u=e[p].size/1024/1024;if(a&&u>a)return h.info("File: "+t+" is of size "+u+" MB which exceeds the file size limit of "+a+" MB."),this.fireFileSizeExceed({fileName:t,fileSize:u}),!1;if(0===u&&(h.info("File: "+t+" is empty!"),this.fireFileEmpty({fileName:t})),this._isFilenameTooLong(t))return this.fireFilenameLengthExceed({fileName:t}),!1;if(l&&l.length>0){for(var d=!0,f=0;f<l.length;f++)(r==l[f]||"*/*"==l[f]||r.match(l[f]))&&(d=!1);if(d)return h.info("File: "+t+" is of type "+r+". Allowed types are: "+l+"."),this.fireTypeMissmatch({fileName:t,mimeType:r}),!1}if(n&&n.length>0){i=!0,s=-1===(o=t.lastIndexOf("."))?"":t.substring(o+1);for(var g=0;g<n.length;g++)s.toLowerCase()==n[g].toLowerCase()&&(i=!1);if(i)return h.info("File: "+t+" is of type "+s+". Allowed types are: "+n+"."),this.fireTypeMissmatch({fileName:t,fileType:s}),!1}}return!0},y.prototype._sendFilesFromDragAndDrop=function(e){return this._areFilesAllowed(e)&&this._sendFilesWithXHR(e),this},y.prototype._generateInputValue=function(e){for(var t="",i=0;i<e.length;i++)t=t+'"'+e[i].name+'" ';return t},y.prototype.getBrowseText=function(){if(!y.prototype._sBrowseText){var e=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");y.prototype._sBrowseText=e.getText("FILEUPLOAD_BROWSE")}return y.prototype._sBrowseText?y.prototype._sBrowseText:"Browse..."},y.prototype._getNoFileChosenText=function(){if(!y.prototype._sNoFileChosenText){var e=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");y.prototype._sNoFileChosenText=e.getText("FILEUPLOAD_NO_FILE_CHOSEN")}return y.prototype._sNoFileChosenText?y.prototype._sNoFileChosenText:"No file chosen"},y.prototype.getShortenValue=function(){return this.getValue()},y.prototype.prepareFileUploadAndIFrame=function(){if(this._prepareFileUpload(),!this.oIFrameRef){var e=document.createElement("iframe");e.style.display="none",e.id=this.getId()+"-frame",r.getDomRef().appendChild(e),e.contentWindow.name=this.getId()+"-frame",this._bUploading=!1,jQuery(e).on("load",function(e){if(this._bUploading){var t;h.info("File uploaded to "+this.getUploadUrl());try{t=this.oIFrameRef.contentWindow.document.body.innerHTML}catch(e){}this.fireUploadComplete({response:t}),this._bUploading=!1}}.bind(this)),this.oIFrameRef=e}},y.prototype._prepareFileUpload=function(){if(this.oFileUpload)jQuery(this.oFileUpload).prependTo(this.$().find(".sapUiFupInputMask"));else{var e=[];if(e.push("<input "),e.push('type="file" '),e.push('aria-hidden="true" '),this.getName()?this.getMultiple()||this.getDirectory()?e.push('name="'+u(this.getName())+'[]" '):e.push('name="'+u(this.getName())+'" '):this.getMultiple()||this.getDirectory()?e.push('name="'+this.getId()+'[]" '):e.push('name="'+this.getId()+'" '),e.push('id="'+this.getId()+'-fu" '),e.push('tabindex="-1" '),e.push('size="1" '),this.getTooltip_AsString()?e.push('title="'+u(this.getTooltip_AsString())+'" '):e.push('title="'+u(this.getValue()?this.getValue():this._getNoFileChosenText())+'" '),this.getEnabled()||e.push('disabled="disabled" '),this.getDirectory()&&e.push("webkitdirectory "),this.getMultiple()&&e.push("multiple "),(this.getMimeType()||this.getFileType())&&window.File){var t=this._getAcceptedTypes();e.push('accept="'+u(t)+'" ')}e.push(">"),this.oFileUpload=jQuery(e.join("")).prependTo(this.$().find(".sapUiFupInputMask")).get(0)}},y.prototype.openValueStateMessage=function(){this.oFilePath.openValueStateMessage&&this.oFilePath.openValueStateMessage()},y.prototype.closeValueStateMessage=function(){this.oFilePath.closeValueStateMessage&&this.oFilePath.closeValueStateMessage()},y.prototype._getAcceptedTypes=function(){var e=this.getMimeType()||[],t=this.getFileType()||[];return(t=t.map((function(e){return 0===e.indexOf(".")?e:"."+e}))).concat(e).join(",")},y.prototype._resetValueAfterUploadStart=function(){h.info("File uploading to "+this.getUploadUrl()),this.getSameFilenameAllowed()&&this.getUploadOnChange()&&this.getUseMultipart()&&this.setValue("",!0)},y.prototype._addLabelFeaturesToBrowse=function(){var e;this.oBrowse&&this.oBrowse.$().length&&((e=this.oBrowse.$()).attr("type', 'button"),e.off("click").on("click",(e=>{e.preventDefault(),e.stopPropagation(),this.FUEl.click()})),e.off("dragover").on("dragover",(e=>{e.preventDefault(),e.stopPropagation()})),e.off("dragenter").on("dragenter",(e=>{e.preventDefault(),e.stopPropagation()})),e.off("drop").on("drop",(e=>{e.preventDefault(),e.stopPropagation();var t=e.originalEvent.dataTransfer.files;if(!(!this.getMultiple()&&t.length>1||this.getDirectory())){this.oFileUpload.files=t;var i={target:{files:t}};this.handlechange(i)}})))},y.prototype.getProcessedBlobsFromArray=function(e){return new Promise((function(t){t(e)}))},y.prototype.checkFileReadable=function(){return new Promise(function(e,t){var i;window.File&&this.FUEl&&this.FUEl.files.length?((i=new FileReader).readAsArrayBuffer(this.FUEl.files[0].slice(0,1)),i.onload=function(){e()},i.onerror=function(){t(i.error)}):e()}.bind(this))},y}));