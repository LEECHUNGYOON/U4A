sap.ui.define(["sap/ui/core/Element","sap/ui/core/Control","sap/ui/Device","sap/ui/core/Popup","./MenuItemBase","./library","sap/ui/core/library","sap/ui/unified/MenuRenderer","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/events/ControlEvents","sap/ui/events/PseudoEvents","sap/ui/events/checkMouseEnterOrLeave","sap/ui/core/Configuration"],(function(e,t,o,i,n,s,r,p,u,jQuery,a,h,d,l,g,c){"use strict";var f=i.Dock,m=r.OpenState,y=t.extend("sap.ui.unified.Menu",{metadata:{interfaces:["sap.ui.core.IContextMenu"],library:"sap.ui.unified",properties:{enabled:{type:"boolean",group:"Behavior",defaultValue:!0},ariaDescription:{type:"string",group:"Accessibility",defaultValue:null,deprecated:!0},maxVisibleItems:{type:"int",group:"Behavior",defaultValue:0},pageSize:{type:"int",group:"Behavior",defaultValue:5}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.unified.MenuItemBase",multiple:!0,singularName:"item"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaLabelledBy"}},events:{itemSelect:{parameters:{item:{type:"sap.ui.unified.MenuItemBase"}}}}},renderer:p});return function(s){function r(e){return!!e&&(e=e.$?e.$():jQuery(e)).closest(".sapUiSizeCompact,.sapUiSizeCondensed,.sapUiSizeCozy").hasClass("sapUiSizeCozy")}function v(e,t){var o=e.getParent();o&&o instanceof n&&o.onSubmenuToggle(t)}function b(e){var t=e.getMaxVisibleItems(),o=document.documentElement.clientHeight-10,i=e.$();if(t>0)for(var n=e.getItems(),s=0;s<n.length;s++)if(n[s].getDomRef()){o=Math.min(o,n[s].$().outerHeight(!0)*t);break}i.outerHeight(!0)>o?i.css("max-height",o+"px").toggleClass("sapUiMnuScroll",!0):i.css("max-height","").toggleClass("sapUiMnuScroll",!1)}y.prototype.bCozySupported=!0,y._DELAY_SUBMENU_TIMER=300,y._DELAY_SUBMENU_TIMER_EXT=400,y.prototype.init=function(){var e=this;this.bOpen=!1,this.oOpenedSubMenu=null,this.oHoveredItem=null,this.oPopup=null,this._bOpenedAsContextMenu=!1,this.fAnyEventHandlerProxy=jQuery.proxy((function(e){var t=this.getRootMenu();t==this&&this.isOpen()&&this.getDomRef()&&("mousedown"==e.type||"touchstart"==e.type)&&t.handleOuterEvent(this.getId(),e)}),this),this.fOrientationChangeHandler=function(){e.close()},this.bUseTopStyle=!1},y.prototype._setCustomEnhanceAccStateFunction=function(e){this._fnCustomEnhanceAccStateFunction=e},y.prototype.enhanceAccessibilityState=function(e,t){"function"==typeof this._fnCustomEnhanceAccStateFunction&&this._fnCustomEnhanceAccStateFunction(e,t)},y.prototype.exit=function(){this.oPopup&&(this.oPopup.detachClosed(this._menuClosed,this),this.oPopup.destroy(),delete this.oPopup),d.unbindAnyEvent(this.fAnyEventHandlerProxy),this._bOrientationChangeBound&&(jQuery(s).off("orientationchange",this.fOrientationChangeHandler),this._bOrientationChangeBound=!1),this._resetDelayedRerenderItems(),this._detachResizeHandler()},y.prototype.invalidate=function(e){e instanceof n&&this.getDomRef()?this._delayedRerenderItems():this.oPopup&&this.oPopup.isOpen()&&t.prototype.invalidate.apply(this,arguments)},y.prototype.onBeforeRendering=function(){this._resetDelayedRerenderItems(),this.$().off("mousemove")},y.prototype.onAfterRendering=function(){"sap-ui-static"!=this.$().parent().attr("id")&&(h.error("sap.ui.unified.Menu: The Menu is popup based and must not be rendered directly as content of the page."),this.close(),this.$().remove());for(var e=this.getItems(),t=0;t<e.length;t++)e[t].onAfterRendering&&e[t].getDomRef()&&e[t].onAfterRendering();this.oHoveredItem&&this.oHoveredItem.hover(!0,this),b(this),this.$().on("mousemove",this._focusMenuItem.bind(this))},y.prototype._focusMenuItem=function(e){if(o.system.desktop){var t=this.getItemByDomRef(e.target);this.isOpen()&&t&&(this.oOpenedSubMenu&&u(this.oOpenedSubMenu.getDomRef(),e.target)||(this.setHoveredItem(t),t&&t.focus(this),this._openSubMenuDelayed(t)))}},y.prototype.onThemeChanged=function(){this.getDomRef()&&this.getPopup().getOpenState()===m.OPEN&&(b(this),this.getPopup()._applyPosition(this.getPopup()._oLastPosition))},y.prototype.addItem=function(e){return this.addAggregation("items",e,!!this.getDomRef()),this._delayedRerenderItems(),this},y.prototype.insertItem=function(e,t){return this.insertAggregation("items",e,t,!!this.getDomRef()),this._delayedRerenderItems(),this},y.prototype.removeItem=function(e){return this.removeAggregation("items",e,!!this.getDomRef()),this._delayedRerenderItems(),this},y.prototype.removeAllItems=function(){var e=this.removeAllAggregation("items",!!this.getDomRef());return this._delayedRerenderItems(),e},y.prototype.destroyItems=function(){return this.destroyAggregation("items",!!this.getDomRef()),this._delayedRerenderItems(),this},y.prototype._delayedRerenderItems=function(){this.getDomRef()&&(this._resetDelayedRerenderItems(),this._discardOpenSubMenuDelayed(),this._itemRerenderTimer=setTimeout(function(){var e=this.getDomRef();if(e){var t=sap.ui.getCore().createRenderManager();p.renderItems(t,this),t.flush(e),t.destroy(),this.onAfterRendering(),this.getPopup()._applyPosition(this.getPopup()._oLastPosition)}}.bind(this),0))},y.prototype._resetDelayedRerenderItems=function(){this._itemRerenderTimer&&(clearTimeout(this._itemRerenderTimer),delete this._itemRerenderTimer)},y.prototype._detachResizeHandler=function(){this._hasResizeListener&&(o.resize.detachHandler(this._handleResizeChange,this),this._hasResizeListener=!1)},y.prototype.open=function(e,t,i,n,r,p,u){var a;this._bLeavingMenu=!1,this.isOpen()||(v(this,!0),this.oOpenerRef=t,this.bIgnoreOpenerDOMRef=!1,this.getPopup().open(0,i,n,r,p||"0 0",u||"flipfit flipfit",function(e){var t=this.getPopup()._getOfDom(r);t&&jQuery(t).is(":visible")&&function(e){var t;if(!e)return!1;e instanceof jQuery&&(e=e.get(0));return(t=e.getBoundingClientRect()).top>=0&&t.left>=0&&t.bottom<=(s.innerHeight||document.documentElement.clientHeight)&&t.right<=(s.innerWidth||document.documentElement.clientWidth)}(t)?this.getPopup()._applyPosition(e.lastPosition):this.close()}.bind(this)),this.bOpen=this.getPopup().isOpen(),o.resize.attachHandler(this._handleResizeChange,this),this._hasResizeListener=!0,(e||this.getRootMenu().getId()===this.getId())&&(a=this.getNextSelectableItem(-1),this.setHoveredItem(a),a&&a.focus(this)),d.bindAnyEvent(this.fAnyEventHandlerProxy),o.support.orientation&&this.getRootMenu()===this&&(jQuery(s).on("orientationchange",this.fOrientationChangeHandler),this._bOrientationChangeBound=!0))},y.prototype._handleResizeChange=function(){this.getPopup()._applyPosition(this.getPopup()._oLastPosition)},y.prototype.openAsContextMenu=function(t,o){var i,n,s,r,p;o=o instanceof e?o.getDomRef():o,t instanceof jQuery.Event?(p=jQuery(o).offset(),i=t.pageX-p.left,n=t.pageY-p.top,this._iX=t.clientX,this._iY=t.clientY):(i=t.offsetX||0,n=t.offsetY||0,this._iX=t.left||0,this._iY=t.top||0),s=c.getRTL(),r=f,s&&(i=o.clientWidth-i),this._bOpenedAsContextMenu=!0,this.open(!0,o,r.BeginTop,r.BeginTop,o,i+" "+n,"fit")},y.prototype._handleOpened=function(){var e,t,o,i,n,r,p,u,a,h;this._bOpenedAsContextMenu&&(e=this.$(),t=jQuery(s),o=this._iX,i=this._iY,n=t.scrollLeft()+t.width(),r=t.scrollTop()+t.height(),p=c.getRTL(),u=!1,a=e.width(),i+(h=e.height())>r&&(i-=h,u=!0),p?n-o+a>n?(o=n-(o+a),u=!0):(o=n-o,u=!0):o+a>n&&(o-=a,u=!0),this._bOpenedAsContextMenu=!1,u&&this.oPopup.setPosition("begin top","begin top",t,o+" "+i,"flipfit"))},y.prototype.close=function(e){this.isOpen()&&!y._dbg&&(this._discardOpenSubMenuDelayed(),v(this,!1),delete this._bFixed,d.unbindAnyEvent(this.fAnyEventHandlerProxy),this._bOrientationChangeBound&&(jQuery(s).off("orientationchange",this.fOrientationChangeHandler),this._bOrientationChangeBound=!1),this.closeSubmenu(),this.setHoveredItem(),e||(this.bIgnoreOpenerDOMRef=!0),this.getPopup().close(0),this.bOpen=this.getPopup().isOpen(),this._detachResizeHandler(),this._resetDelayedRerenderItems(),this.$().remove(),this.bOutput=!1,this.isSubMenu()&&(this.getParent().getParent().oOpenedSubMenu=null))},y.prototype.isOpen=function(){return this.getPopup().isOpen()},y.prototype._menuClosed=function(){if(this.oOpenerRef){if(!this.bIgnoreOpenerDOMRef)try{this.oOpenerRef.focus()}catch(e){h.warning("Menu.close cannot restore the focus on opener "+this.oOpenerRef+", "+e)}this.oOpenerRef=void 0}},y.prototype.onclick=function(e){this.selectItem(this.getItemByDomRef(e.target),!1,!(!e.metaKey&&!e.ctrlKey)),e.preventDefault(),e.stopPropagation()},y.prototype.onsapnext=function(e){var t,o,i=this.oHoveredItem?this.oHoveredItem.getSubmenu():void 0;e.keyCode===a.ARROW_DOWN||e.metaKey||e.altKey?(i&&i.isOpen()&&this.closeSubmenu(!1,!0),t=this.oHoveredItem?this.indexOfAggregation("items",this.oHoveredItem):-1,o=this.getNextSelectableItem(t),this.setHoveredItem(o),o&&o.focus(this),e.metaKey||e.altKey||(e.preventDefault(),e.stopPropagation())):i&&(i.isOpen()?(o=i.getNextSelectableItem(-1),i.setHoveredItem(o),o&&o.focus(this)):this.openSubmenu(this.oHoveredItem,!0))},y.prototype.onsapnextmodifiers=y.prototype.onsapnext,y.prototype.onsapprevious=function(e){var t=this.oHoveredItem?this.indexOfAggregation("items",this.oHoveredItem):-1,o=this.getPreviousSelectableItem(t),i=this.oHoveredItem?this.oHoveredItem.getSubmenu():null;if(e.keyCode!==a.ARROW_UP&&!e.metaKey&&!e.altKey)return this.isSubMenu()&&this.close(!0),e.preventDefault(),void e.stopPropagation();i&&i.isOpen()&&this.closeSubmenu(!1,!0),this.setHoveredItem(o),o&&o.focus(this),e.metaKey||e.altKey||(e.preventDefault(),e.stopPropagation())},y.prototype.onsappreviousmodifiers=y.prototype.onsapprevious,y.prototype.onsaphome=function(e){var t=this.getNextSelectableItem(-1);this.setHoveredItem(t),t&&t.focus(this),e.preventDefault(),e.stopPropagation()},y.prototype.onsapend=function(e){var t=this.getPreviousSelectableItem(this.getItems().length);this.setHoveredItem(t),t&&t.focus(this),e.preventDefault(),e.stopPropagation()},y.prototype.onsappagedown=function(e){var t,o=this.oHoveredItem?this.indexOfAggregation("items",this.oHoveredItem):-1;this.getPageSize()<1||(o+=this.getPageSize())>=this.getItems().length?this.onsapend(e):(t=this.getNextSelectableItem(o-1),this.setHoveredItem(t),t&&t.focus(this),e.preventDefault(),e.stopPropagation())},y.prototype.onsappageup=function(e){var t,o=this.oHoveredItem?this.indexOfAggregation("items",this.oHoveredItem):-1;this.getPageSize()<1||(o-=this.getPageSize())<0?this.onsaphome(e):(t=this.getPreviousSelectableItem(o+1),this.setHoveredItem(t),t&&t.focus(this),e.preventDefault(),e.stopPropagation())},y.prototype.onsapselect=function(e){this._sapSelectOnKeyDown=!0,e.preventDefault(),e.stopPropagation()},y.prototype.onkeyup=function(e){if(this.oHoveredItem&&"INPUT"!=jQuery(e.target).prop("tagName")){var t=this.oHoveredItem.getDomRef();jQuery(t).trigger("focus")}!this._sapSelectOnKeyDown&&(e.key!==a.Space||!o.os.macintosh&&s.navigator.maxTouchPoints<=1)||(this._sapSelectOnKeyDown=!1,(l.events.sapselect.fnCheck(e)||"Enter"===e.key)&&(this.selectItem(this.oHoveredItem,!0,!1),e.preventDefault(),e.stopPropagation()))},y.prototype.onsapbackspace=function(e){"INPUT"!=jQuery(e.target).prop("tagName")&&e.preventDefault()},y.prototype.onsapbackspacemodifiers=y.prototype.onsapbackspace,y.prototype.onsapescape=function(e){this._bLeavingMenu=!0,this.close(!0),e.preventDefault(),e.stopPropagation()},y.prototype.onsaptabnext=function(e){this.isSubMenu()&&e.preventDefault(),this._bLeavingMenu=!0,this.close(!0),e.stopPropagation()},y.prototype.onsaptabprevious=y.prototype.onsaptabnext,y.prototype._openSubMenuDelayed=function(e){e&&(this._discardOpenSubMenuDelayed(),this._delayedSubMenuTimer=setTimeout(function(){e.getSubmenu()&&(this.setHoveredItem(e),e&&e.focus(this),this.openSubmenu(e,!1,!0))}.bind(this),e.getSubmenu()?y._DELAY_SUBMENU_TIMER:y._DELAY_SUBMENU_TIMER_EXT))},y.prototype._discardOpenSubMenuDelayed=function(e){this._delayedSubMenuTimer&&(clearTimeout(this._delayedSubMenuTimer),this._delayedSubMenuTimer=null)},y.prototype.onmouseout=function(e){o.system.desktop&&g(e,this.getDomRef())&&(this.setHoveredItem(null),this.oOpenedSubMenu&&this.oOpenedSubMenu.getParent()===this.oHoveredItem||this.setHoveredItem(this.oHoveredItem),this._discardOpenSubMenuDelayed())},y.prototype.onsapfocusleave=function(e){!this.oOpenedSubMenu&&this.isOpen()&&this.getRootMenu().handleOuterEvent(this.getId(),e)},y.prototype.handleOuterEvent=function(e,t){var i=!1,n=o.support.touch||o.system.combi;if(this.bIgnoreOpenerDOMRef=!1,"mousedown"==t.type||"touchstart"==t.type){if(n&&(t.isMarked("delayedMouseEvent")||t.isMarked("cancelAutoClose")))return;for(var s=this;s&&!i;)u(s.getDomRef(),t.target)&&(i=!0),s=s.oOpenedSubMenu}else if("sapfocusleave"==t.type){if(n)return;if(t.relatedControlId)for(s=this;s&&!i;)(s.oOpenedSubMenu&&s.oOpenedSubMenu.getId()==t.relatedControlId||u(s.getDomRef(),jQuery(document.getElementById(t.relatedControlId)).get(0)))&&(i=!0),s=s.oOpenedSubMenu;i||(this.bIgnoreOpenerDOMRef=!0)}i||this.close()},y.prototype.getItemByDomRef=function(e){for(var t=this.getItems(),o=t.length,i=0;i<o;i++){var n=t[i],s=n.getDomRef();if(u(s,e))return n}return null},y.prototype.selectItem=function(e,t,i){if(e&&e instanceof n&&this.checkEnabled(e)){var s=e.getSubmenu();s?o.system.desktop||this.oOpenedSubMenu!==s?this.openSubmenu(e,t):this.closeSubmenu():this.getRootMenu().close(!0),e.fireSelect({item:e,ctrlKey:i}),this.getRootMenu().fireItemSelect({item:e})}},y.prototype.isSubMenu=function(){return this.getParent()&&this.getParent().getParent&&this.getParent().getParent()instanceof y},y.prototype.getRootMenu=function(){for(var e=this;e.isSubMenu();)e=e.getParent().getParent();return e},y.prototype.getMenuLevel=function(){for(var e=1,t=this;t.isSubMenu();)t=t.getParent().getParent(),e++;return e},y.prototype.getPopup=function(){return this.oPopup||(this.oPopup=new i(this,!1,!0,!1),this.oPopup.setDurations(0,0),this.oPopup.attachClosed(this._menuClosed,this),this.oPopup.attachOpened(this._handleOpened,this)),this.oPopup},y.prototype.setHoveredItem=function(e){this.oHoveredItem&&this.oHoveredItem.hover(!1,this),e?(this.oHoveredItem=e,e.hover(!0,this),this.scrollToItem(this.oHoveredItem)):this.oHoveredItem=null},y.prototype.openSubmenu=function(e,t,o){var n=e.getSubmenu();if(n&&this.checkEnabled(e))if(this.oOpenedSubMenu&&this.oOpenedSubMenu!==n&&this.closeSubmenu(),this.oOpenedSubMenu)this.oOpenedSubMenu._bFixed=o&&this.oOpenedSubMenu._bFixed||!o&&!this.oOpenedSubMenu._bFixed,this.oOpenedSubMenu._bringToFront();else{this.oOpenedSubMenu=n;var s=i.Dock;n.open(t,e,s.BeginTop,s.EndTop,e,"-4 4")}},y.prototype.closeSubmenu=function(e,t){if(this.oOpenedSubMenu){if(e&&this.oOpenedSubMenu._bFixed)return;t&&(this.oOpenedSubMenu.bIgnoreOpenerDOMRef=!0),this.oOpenedSubMenu.close(),this.oOpenedSubMenu=null}},y.prototype.scrollToItem=function(e){var t=this.getDomRef(),o=e?e.getDomRef():null;if(o&&t){var i=t.scrollTop,n=o.offsetTop,s=jQuery(t).height(),r=jQuery(o).height();i>n?t.scrollTop=n:n+r>i+s&&(t.scrollTop=Math.ceil(n+r-s))}},y.prototype._bringToFront=function(){jQuery(document.getElementById(this.getPopup().getId())).mousedown()},y.prototype.checkEnabled=function(e){return e&&e.getEnabled()&&this.getEnabled()},y.prototype.getNextSelectableItem=function(e){for(var t=this.getItems(),o=t[e],i=e+1;i<t.length;i++)if(t[i].getVisible())return t[i];return o&&o.getVisible()?o:null},y.prototype.getPreviousSelectableItem=function(e){for(var t=this.getItems(),o=t[e],i=e-1;i>=0&&!(i<0);i--)if(t[i].getVisible())return t[i];return o&&o.getVisible()?o:null},y.prototype.setRootMenuTopStyle=function(e){this.getRootMenu().bUseTopStyle=e,y.rerenderMenu(this.getRootMenu())},y.rerenderMenu=function(e){for(var t=e.getItems(),o=0;o<t.length;o++){var i=t[o].getSubmenu();i&&y.rerenderMenu(i)}e.invalidate(),e.rerender()},y.prototype.focus=function(){this.isOpen()&&t.prototype.focus.apply(this,arguments)},y.prototype.isCozy=function(){return!!this.bCozySupported&&(!!this.hasStyleClass("sapUiSizeCozy")||(!!r(this.oOpenerRef)||!!r(this.getParent())))}}(window),y}));