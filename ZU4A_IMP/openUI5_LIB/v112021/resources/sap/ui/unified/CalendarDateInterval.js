sap.ui.define(["./calendar/CalendarUtils","./Calendar","./calendar/DatesRow","./calendar/MonthPicker","./calendar/YearPicker","./calendar/YearRangePicker","./calendar/CalendarDate","./library","sap/ui/Device","./CalendarDateIntervalRenderer","sap/base/util/deepEqual","sap/m/Popover","sap/ui/core/CalendarType","sap/ui/core/Core","sap/base/Log","./DateRange","sap/ui/core/date/UI5Date"],(function(t,e,a,s,r,i,o,n,h,g,p,c,l,u,_,d,D){"use strict";var y=e.extend("sap.ui.unified.CalendarDateInterval",{metadata:{library:"sap.ui.unified",properties:{startDate:{type:"object",group:"Data"},days:{type:"int",group:"Appearance",defaultValue:7},showDayNamesLine:{type:"boolean",group:"Appearance",defaultValue:!0},pickerPopup:{type:"boolean",group:"Appearance",defaultValue:!1}},designtime:"sap/ui/unified/designtime/CalendarDateInterval.designtime"},renderer:g});function P(t){var e=new o(this._getFocusedDate(),this.getPrimaryCalendarType());this._togglePrevNext(e)}function f(t){this._togglePrevNexYearPicker(),this._updateHeadersYearPrimaryText(this._getYearString())}return y.prototype.init=function(){e.prototype.init.apply(this,arguments),this._iDaysMonthHead=35},y.prototype.onBeforeRendering=function(){this._getSucessorsPickerPopup()&&this.setProperty("_currentPicker","month"),e.prototype.onBeforeRendering.apply(this,arguments),this._bPoupupMode=this.getPickerPopup()},y.prototype._selectYearRange=function(){e.prototype._selectYearRange.apply(this,arguments),this.getAggregation("month")[0].setStartDate(this._getFocusedDate().toLocalJSDate())},y.prototype.exit=function(){e.prototype.exit.apply(this,arguments),this._oPopup&&(this._oPopup.destroy(),this._oPopup=null),this._oCalendar&&(this._oCalendar.removeDelegate(this._oFocusCalendarDelegate),this._oCalendar.destroy(),this._oCalendar=null)},y.prototype._initializeMonthPicker=function(){var t=this._createMonthPicker();t._bCalendar=!0,this.setAggregation("monthPicker",t),t._setSelectedDatesControlOrigin(this)},y.prototype._initializeYearPicker=function(){var t=this._createYearPicker();t._bCalendar=!0,this.setAggregation("yearPicker",t),t._setSelectedDatesControlOrigin(this)},y.prototype._initializeYearRangePicker=function(){this.setAggregation("yearRangePicker",this._createYearRangePicker())},y.prototype.setPickerPopup=function(t){this.setProperty("pickerPopup",t);var e,a,s=this.getAggregation("header");return t?(this._getMonthPicker()&&this._getMonthPicker().destroy(),this._getYearPicker()&&this._getYearPicker().destroy(),s.setVisibleButton2(!1),s.detachEvent("pressButton2",this._handleButton2,this),this._setHeaderText(this._getFocusedDate(!0))):(this._getMonthPicker()||this.setAggregation("monthPicker",this._createMonthPicker()),this._getYearPicker()||this.setAggregation("yearPicker",this._createYearPicker()),e=this._getMonthPicker(),a=this._getYearPicker(),e.setColumns(0),e.setMonths(6),a.setColumns(0),a.setYears(6),a._oMinDate.setYear(this._oMinDate.getYear()),a._oMaxDate.setYear(this._oMaxDate.getYear()),s.setVisibleButton2(!0),s.detachEvent("pressButton2",this._handleButton2,this),s.attachEvent("pressButton2",this._handleButton2,this)),this},y.prototype._createMonthPicker=function(){var t=new s(this.getId()+"--MP");return t.attachEvent("select",this._selectMonth,this),t._bNoThemeChange=!0,t.setColumns(0),t.setMonths(3),t.attachEvent("pageChange",P,this),t},y.prototype._createYearPicker=function(){var t=new r(this.getId()+"--YP");return t.attachEvent("select",this._selectYear,this),t.setColumns(0),t.setYears(3),t.attachEvent("pageChange",f,this),t},y.prototype._createYearRangePicker=function(){var t=new i(this.getId()+"--YRP");return t.attachEvent("select",this._selectYearRange,this),t.setPrimaryCalendarType(this.getPrimaryCalendarType()),t.setYears(6),t.setRangeSize(this._getYearPicker().getYears()),t},y.prototype._adjustYearRangeDisplay=function(){var t=this.getAggregation("yearRangePicker");if(this._getSucessorsPickerPopup())e.prototype._adjustYearRangeDisplay.call(this,arguments);else if(this.getPrimaryCalendarType()===l.Gregorian)t.setColumns(3),t.setYears(3);else t.setColumns(2),t.setYears(2)},y.prototype._getCalendar=function(){var t;return this._oCalendar||((t=new e(this.getId()+"--Cal")).attachEvent("select",this._handleCalendarPickerDateSelect,this),t.attachEvent("cancel",(function(t){this._closeCalendarPicker(!0);var e=this.getAggregation("header").getDomRef("B1");e&&e.focus()}),this),this._oFocusCalendarDelegate={onAfterRendering:function(){this.focus()}},t.addDelegate(this._oFocusCalendarDelegate,t),this._oCalendar=t),this._oCalendar},y.prototype._setAriaRole=function(t){var e=this.getAggregation("month")[0];return e._setAriaRole(t),e.invalidate(),this},y.prototype._handleButton1=function(t){this.getPickerPopup()?(this._showCalendarPicker(),this._showOverlay()):this._showMonthPicker()},y.prototype._showOverlay=function(){this.$("contentOver").css("display","")},y.prototype._hideOverlay=function(){this.$("contentOver").css("display","none")},y.prototype._setHeaderText=function(t){var a,s,r=(a=this.getStartDate()?e.prototype._setHeaderText.apply(this,[o.fromLocalJSDate(this.getStartDate(),this.getPrimaryCalendarType())]):e.prototype._setHeaderText.apply(this,arguments)).sAriaLabel,i=this.getAggregation("header"),n=this._getLocaleData(),h=o.fromLocalJSDate(D.getInstance(t.toLocalJSDate().getTime()+24*(this._getDays()-1)*60*60*1e3),this.getPrimaryCalendarType());h.setDate(1);var g=n.getIntervalPattern().replace("{0}","").replace("{1}",""),p=this._oYearFormat.format(h.toUTCJSDate(),!0),c=a.sMonth;this.getPickerPopup()&&("ja"===n.oLocale.sLanguage.toLowerCase()||"zh"===n.oLocale.sLanguage.toLowerCase()?(p!=a.sYear&&(c=c.replace(g,g+p+" "),r=r.replace(g,g+p+" ")),s=a.sYear+" "+c,r=a.sYear+" "+r):(p!=a.sYear&&(c=c.replace(g," "+a.sYear+g),r=r.replace(g," "+a.sYear+g)),s=c+" "+p,r=r+" "+p),i.setTextButton1(s,!0),i.setAriaLabelButton1(r))},y.prototype._showCalendarPicker=function(){var t=this.getStartDate(),e=this._getCalendar(),a=new d,s=D.getInstance(t.getTime());s.setDate(s.getDate()+this._getDays()-1),a.setStartDate(t),a.setEndDate(s),e.displayDate(this._getFocusedDate().toLocalJSDate()),e.removeAllSelectedDates(),e.addSelectedDate(a),e.setMinDate(this.getMinDate()),e.setMaxDate(this.getMaxDate()),this._openPickerPopup(e)},y.prototype._handleCalendarPickerDateSelect=function(t){var e=this._getCalendar().getSelectedDates()[0].getStartDate(),a=o.fromLocalJSDate(e);this._setStartDate(a),this._setFocusedDate(a),this._closeCalendarPicker()},y.prototype._closeCalendarPicker=function(t){this._oPopup&&this._oPopup.isOpen()&&this._oPopup.close(),t||this._renderMonth(),this._getCalendar()._closePickers()},y.prototype._getDaysLarge=function(){return 10},y.prototype._createMonth=function(t){var e=new a(t);return e._bCalendar=!0,e},y.prototype.setStartDate=function(e){if(t._checkJSDateObject(e),p(this.getStartDate(),e))return this;var a=e.getFullYear();t._checkYearInValidRange(a);var s=o.fromLocalJSDate(e,this.getPrimaryCalendarType());if(t._isOutside(s,this._oMinDate,this._oMaxDate))throw new Error("Date must be in valid range (minDate and maxDate); "+this);var r=this.getMinDate();r&&e.getTime()<r.getTime()&&(_.warning("startDate < minDate -> minDate as startDate set",this),e=D.getInstance(r.getTime()));var i=this.getMaxDate();i&&e.getTime()>i.getTime()&&(_.warning("startDate > maxDate -> maxDate as startDate set",this),e=D.getInstance(i.getTime())),this.setProperty("startDate",e,!0),s=o.fromLocalJSDate(e,this.getPrimaryCalendarType()),this._oStartDate=s;var n=this.getAggregation("month")[0];n.setStartDate(e),this._updateHeader(s);var h=this._getFocusedDate(!0).toLocalJSDate();return n.checkDateFocusable(h)||(this._setFocusedDate(s),n.displayDate(e)),this},y.prototype.getStartDate=function(){return this.getProperty("startDate")},y.prototype.setDays=function(t){t=Math.max(1,t);var e=this.getAggregation("yearRangePicker");if(this.setProperty("days",t,!0),t=this._getDays(),this.getAggregation("month")[0].setDays(t),!this.getPickerPopup()){var a=this._getMonthPicker(),s=Math.ceil(t/3);s>12&&(s=12),a.setMonths(s);var r=this._getYearPicker(),i=Math.floor(t/2);i>20&&(i=20),r.setYears(i),e.setRangeSize(i)}var o=this._getStartDate();return this._updateHeader(o),this.getDomRef()&&(t>this._getDaysLarge()?this.$().addClass("sapUiCalIntLarge"):this.$().removeClass("sapUiCalIntLarge"),t>this._iDaysMonthHead?this.$().addClass("sapUiCalIntHead"):this.$().removeClass("sapUiCalIntHead")),this},y.prototype._getDays=function(){var t=this.getDays();return h.system.phone&&t>8?8:t},y.prototype.setShowDayNamesLine=function(t){return this.setProperty("showDayNamesLine",t,!0),this.getAggregation("month")[0].setShowDayNamesLine(t),this},y.prototype._getShowMonthHeader=function(){return this._getDays()>this._iDaysMonthHead},y.prototype._getFocusedDate=function(t){if(!this._oFocusedDate||t){this._oFocusedDate=null,e.prototype._getFocusedDate.apply(this,arguments);var a=this.getStartDate(),s=this.getAggregation("month")[0];a?s.checkDateFocusable(this._oFocusedDate.toLocalJSDate())||(this._oFocusedDate=o.fromLocalJSDate(a,this.getPrimaryCalendarType())):this._setStartDate(this._oFocusedDate,!1,!0)}return this._oFocusedDate},y.prototype.setMonths=function(t){if(1==t)return this.setProperty("months",t,!1);throw new Error("Property months not supported "+this)},y.prototype.setFirstDayOfWeek=function(t){if(-1==t)return this.setProperty("firstDayOfWeek",t,!1);throw new Error("Property firstDayOfWeek not supported "+this)},y.prototype.focusDate=function(t){return this.getAggregation("month")[0].checkDateFocusable(t)||this._focusDateExtend(o.fromLocalJSDate(t,this.getPrimaryCalendarType()),!0,!0),e.prototype.focusDate.apply(this,arguments),this},y.prototype._focusOnShiftTab=function(){var t=this.getAggregation("header");this.getPickerPopup()&&t.getDomRef("B1")?t.getDomRef("B1").focus():!this.getPickerPopup()&&t.getDomRef("B2")&&t.getDomRef("B2").focus()},y.prototype.onsapescape=function(t){this.getPickerPopup()?(this._closeCalendarPicker(),this.fireCancel()):(0===this._iMode&&this.fireCancel(),this._closePickers()),this._updateHeadersButtons(),this._setHeaderText(this._getFocusedDate())},y.prototype._focusDateExtend=function(t,e,a){if(e){var s=this.getAggregation("month")[0],r=s._oItemNavigation?s._oItemNavigation.getFocusedIndex():0,i=new o(t,this.getPrimaryCalendarType());if(i.setDate(i.getDate()-r),this._setStartDate(i,!1,!0),!a)return!0}return!1},y.prototype._setMinMaxDateExtend=function(t){if(this._oStartDate)if(this._oStartDate.isBefore(this._oMinDate))_.warning("start date < minDate -> minDate will be start date",this),this._setStartDate(new o(this._oMinDate,this.getPrimaryCalendarType()),!0,!0);else{var e=new o(this._oStartDate);if(e.setDate(e.getDate()+this._getDays()-1),e.isAfter(this._oMaxDate)){_.warning("end date > maxDate -> start date will be changed",this);var a=new o(this._oMaxDate);a.setDate(a.getDate()-this._getDays()+1),this._setStartDate(a,!0,!0)}}},y.prototype._updateHeader=function(t){switch(this._setHeaderText(t),this._iMode){case 0:this._togglePrevNext(t,!0);break;case 1:this._togglePrevNext(t);break;case 2:case 3:this._togglePrevNexYearPicker()}},y.prototype._togglePrevNext=function(a,s){if(this._iMode>1||1==this._iMode&&this.getPickerPopup())return e.prototype._togglePrevNext.apply(this,arguments);var r,i,n,h,g,p=this._oMaxDate.getYear(),c=this._oMinDate.getYear(),l=this._oMaxDate.getMonth(),u=this._oMinDate.getMonth(),_=this._oMinDate.getDate(),d=this._oMaxDate.getDate(),D=this.getAggregation("header"),y=this._getDays();if(1==this._iMode&&!s){var P=this._getMonthPicker(),f=P.getMonths(),v=P.getProperty("_firstMonth"),m=v+f-1;return r=a.getYear(),0==v||r==c&&v<=u?D.setEnabledPrevious(!1):D.setEnabledPrevious(!0),void(m>10||r==p&&m>=l?D.setEnabledNext(!1):D.setEnabledNext(!0))}i=this._getStartDate(),(n=new o(i,this.getPrimaryCalendarType())).setDate(n.getDate()+y-1),t._isOutside(a,i,n)&&(i=new o(a,this.getPrimaryCalendarType()),(n=new o(i,this.getPrimaryCalendarType())).setDate(n.getDate()+y-1)),r=i.getYear(),h=i.getMonth(),g=i.getDate(),r<c||r==c&&(!s||h<u||h==u&&g<=_)?D.setEnabledPrevious(!1):D.setEnabledPrevious(!0),r=n.getYear(),h=n.getMonth(),g=n.getDate(),r>p||r==p&&(!s||h>l||h==l&&g>=d)?D.setEnabledNext(!1):D.setEnabledNext(!0)},y.prototype._shiftStartFocusDates=function(t,e,a){t.setDate(t.getDate()+a),e.setDate(e.getDate()+a),this._setFocusedDate(e),this._setStartDate(t,!0)},y.prototype._handlePrevious=function(t){var e,a,s,r=new o(this._getFocusedDate(),this.getPrimaryCalendarType());switch(this._iMode){case 0:a=new o(this._getStartDate(),this.getPrimaryCalendarType()),s=this._getDays(),this._shiftStartFocusDates(a,r,-1*s),this._addMonthFocusDelegate();break;case 1:if(!this.getPickerPopup())if((e=this._getMonthPicker()).getMonths()<12)e.previousPage(),this._togglePrevNext(r);else{r.setYear(r.getYear()-1);var i=this._focusDateExtend(r,!0,!1);this._setFocusedDate(r),this._updateHeader(r),this._setDisabledMonths(r.getYear()),i&&this.fireStartDateChange()}break;case 2:this.getPickerPopup()||(this._getYearPicker().previousPage(),f.call(this));break;case 3:this.getPickerPopup()||(this.getAggregation("yearRangePicker").previousPage(),f.call(this))}},y.prototype._handleNext=function(t){var e,a,s,r=new o(this._getFocusedDate(),this.getPrimaryCalendarType());switch(this._iMode){case 0:a=new o(this._getStartDate(),this.getPrimaryCalendarType()),s=this._getDays(),this._shiftStartFocusDates(a,r,s),this._addMonthFocusDelegate();break;case 1:if(!this.getPickerPopup())if((e=this._getMonthPicker()).getMonths()<12)e.nextPage(),this._togglePrevNext(r);else{r.setYear(r.getYear()+1);var i=this._focusDateExtend(r,!0,!1);this._setFocusedDate(r),this._updateHeader(r),this._setDisabledMonths(r.getYear()),i&&this.fireStartDateChange()}break;case 2:this.getPickerPopup()||(this._getYearPicker().nextPage(),f.call(this));break;case 3:this.getPickerPopup()||(this.getAggregation("yearRangePicker").nextPage(),f.call(this))}},y.prototype._getDisplayedMonths=function(t){var e=[],a=t.getMonth(),s=this._getDays();if(e.push(a),s>this._getDaysLarge()){var r=new o(t,this.getPrimaryCalendarType());r.setDate(r.getDate()+s-1);for(var i=r.getMonth();a!=i;)a=(a+1)%12,e.push(a)}return e},y.prototype._getDisplayedSecondaryMonths=function(t,e){var a=this._getDays(),s=new o(this._getStartDate(),e),r=s.getMonth(),i=new o(s,this.getPrimaryCalendarType());return i.setDate(i.getDate()+a-1),{start:r,end:(i=new o(i,e)).getMonth()}},y.prototype._openPickerPopup=function(t){if(!this._oPopup){var e=new c({placement:"VerticalPreferredBottom",showHeader:!1,showArrow:!1,verticalScrolling:!1});e.oPopup.setDurations(0,0),e.addEventDelegate({onsapescape:function(t){this._oCalendar.onsapescape(t),this._hideOverlay()}},this),this._oPopup=e}this._oPopup.addContent(t),this._oPopup.attachAfterClose((function(){this._closeCalendarPicker(!0),this._hideOverlay()}),this),this._oPopup.attachAfterOpen((function(){var t=a.$("B1"),e=this._oPopup.$(),s=Math.floor((e.width()-t.width())/2);this._oPopup.setOffsetX(u.getConfiguration().getRTL()?s:-s);var r=t.height();this._oPopup.setOffsetY("Top"===this._oPopup._getCalculatedPlacement()?r:-r)}),this);var a=this.getAggregation("header");this._oPopup.openBy(a.getDomRef("B1"))},y.prototype._getMaxDateAlignedToMinDate=function(t,e){var a=new o(t,this.getPrimaryCalendarType());return a.isBefore(e)&&(a=new o(e)).setDate(a.getDate()+this._getDays()-1),a},y.prototype._getStartDateAlignedToMinAndMaxDate=function(t,e,a){var s=new o(a,this.getPrimaryCalendarType());return s.isBefore(e)?s=new o(e,this.getPrimaryCalendarType()):s.isAfter(t)&&(s=t),s},y.prototype._calculateStartDate=function(t,e,a){var s=new o(t,this.getPrimaryCalendarType());return s.setDate(s.getDate()-this._getDays()+1),s=this._getMaxDateAlignedToMinDate(s,e),a=this._getStartDateAlignedToMinAndMaxDate(s,e,a)},y.prototype._setStartDate=function(t,e,a){var s=(t=this._calculateStartDate(this._oMaxDate,this._oMinDate,t)).toLocalJSDate();this.setProperty("startDate",s,!0),this._oStartDate=t;var r=this.getAggregation("month")[0];if(r.setStartDate(s),this._updateHeader(t),e){var i=this._getFocusedDate().toLocalJSDate();r.checkDateFocusable(i)?r.setDate(i):(this._setFocusedDate(t),r.setDate(s))}a||this.fireStartDateChange()},y.prototype._getStartDate=function(){return this._oStartDate||(this._oStartDate=this._getFocusedDate()),this._oStartDate},y}));