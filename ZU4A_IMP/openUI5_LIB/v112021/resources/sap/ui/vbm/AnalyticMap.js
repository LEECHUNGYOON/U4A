sap.ui.define(["./GeoMap","./VoBase","sap/ui/core/theming/Parameters","jquery.sap.global","sap/base/Log","./library","./AnalyticMapRenderer"],(function(e,t,o,jQuery,i,r,n){"use strict";var a=e.extend("sap.ui.vbm.AnalyticMap",{metadata:{library:"sap.ui.vbm",properties:{},aggregations:{regions:{type:"sap.ui.vbm.Region",multiple:!0,singularName:"region"}},events:{regionClick:{parameters:{code:{type:"string"}}},regionContextMenu:{parameters:{code:{type:"string"}}},regionSelect:{},regionDeselect:{}}},renderer:n});a.DefaultABAPGeoJSONURL="media/analyticmap/L0.json",a.DefaultGeoJSONURL="media/analyticmap/L0.json",a.DefaultRegionColor=o&&o.get("_sap_ui_vbm_shared_ChoroplethRegionBG")?o.get("_sap_ui_vbm_shared_ChoroplethRegionBG"):"rgb(213,218,221)",a.DefaultRegionColorBorder=o&&o.get("_sap_ui_vbm_shared_ChoroplethRegionBorder")?o.get("_sap_ui_vbm_shared_ChoroplethRegionBorder"):"rgb(255,255,255)",a.DefaultRegionSelectColor="RHLSA(0;1;1;1)",a.DefaultHotDeltaColor="RHLSA(0;1;1;1.0)",a.AltBorderColor=o&&o.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor")?o.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor"):"#676767";var s=o&&o.get("_sap_ui_vbm_shared_ChartDataPointNotSelectedBackgroundOpacity")?o.get("_sap_ui_vbm_shared_ChartDataPointNotSelectedBackgroundOpacity"):"0.6";return a.DefaultRegionNonSelectColor="RHLSA(0;1;1;"+s+")",a.prototype.exit=function(){e.prototype.exit.apply(this,arguments),this.detachEvent("submit",a.prototype.onAnalyticsSubmit,this)},a.prototype.onAfterRendering=function(){sap.ui.vbm.VBI.prototype.onAfterRendering.apply(this,arguments)},a.prototype.destroyRegions=function(){this.mbRegionsDirty=!0,this.destroyAggregation("regions")},a.prototype.addRegion=function(e){this.mbRegionsDirty=!0,this.addAggregation("regions",e)},a.prototype.removeRegion=function(e){this.mbRegionsDirty=!0,this.removeAggregation("regions",e)},a.prototype.insertRegion=function(e,t){this.mbRegionsDirty=!0,this.insertAggregation("regions",e,t)},a.prototype.removeAllRegions=function(){this.mbRegionsDirty=!0,this.removeAllAggregation("regions")},a.prototype.destroyLegend=function(){this.mbLegendDirty=!0,this.destroyAggregation("legend")},a.prototype.setLegend=function(e){this.mbLegendDirty=!0,this.setAggregation("legend",e)},a.prototype.onAnalyticsSubmit=function(e){var t,o,i,r=JSON.parse(e.mParameters.data);switch(r.Action.name){case"RGN_CONTEXTMENU":i={code:t=r.Action.instance.split(".")[1]},(o=this.findRegionInAggregation(t))&&o.fireContextMenu(i),this.fireRegionContextMenu(i);break;case"RGN_CLICK":i={code:t=r.Action.instance.split(".")[1]},(o=this.findRegionInAggregation(t))&&o.fireClick(i),this.fireRegionClick(i),r.Data&&r.Data.Merge&&this.setSelectionPropFireSelect(r.Data.Merge)}},a.prototype.init=function(){this.mProperties.scaleVisible=!1,e.prototype.init.apply(this,arguments),this.mbRegionsDirty=!1,this.mbLegendDirty=!1,this.mbThemingDirty=!0,this.attachEvent("submit",a.prototype.onAnalyticsSubmit,this),this.createRegions()},a.prototype.createRegions=function(){var e=this.mColC=a.DefaultRegionColor,t=this.mColCB=a.DefaultRegionColorBorder;function o(e,t,o,i,r,n,s,l){var g,p,h,u={};u.K=e,u.P=[],u.T=n,u.C=i,u.CB=r,u.HDC=a.DefaultHotDeltaColor,u.ACB=u.CB,u.G=s,u.S="false",u.XA=l;for(var c=0,m=t.length;c<m;++c){h=[];for(var d=0,y=(p=t[c]).length;d<y;++d){g="";for(var C=0,f=p[d].length;C<f;++C)C&&(g+=";"),g+=p[d][C];h.push(g)}u.P.push(h)}return u}var r,n=null,s=[],l="";s[0]=a.GeoJSONURL;var g=window.URI(a.DefaultABAPGeoJSONURL);g.addQuery("sap-language",sap.ui.getCore().getConfiguration().getLanguage()),s[1]=g.toString(),s[2]=sap.ui.require.toUrl("sap/ui/vbm/"+a.DefaultGeoJSONURL);for(var p=0;p<3;++p)if(l=s[p],!n&&l&&200===(r=jQuery.sap.syncGetJSON(l)).statusCode&&r.data&&!r.error){n=r.data;break}if(n){var h,u,c,m,d=[];this.mRegionApplicationTable=d,this.mRegionBox=[],this.mNames=[],this.mRegionProps=[];for(var y,C,f,R,b=n.features,B="",v=0,A=b.length;v<A;++v){y=[],f=[],R=[],C=[];var L=b[v];if("AQ"!==L.id2){L.id2||(L.id2=L.id),B=L.properties&&L.properties.name?L.properties.name:L.properties&&L.properties.NAME?L.properties.NAME:"",this.mNames[L.id2]=B,this.mRegionProps[L.id2]=L.properties;var _,S,D,M,T,P,N,I=L.geometry.coordinates;switch(L.geometry.type){case"Polygon":for(c=Number.MAX_VALUE,m=-Number.MAX_VALUE,h=Number.MAX_VALUE,u=-Number.MAX_VALUE,T=I.length,P=0;P<T;++P){for(_=I[P],y=[],N=0;N<_.length;++N)M=_[N],P||((S=M[0])<h&&(h=S),S>u&&(u=S),(D=M[1])<c&&(c=D),D>m&&(m=D)),y.push(M[0],M[1],"0");R.push(y)}f.push(R),C.push([h,u,c,m]);break;case"MultiPolygon":for(var G=0,V=I.length;G<V;++G){for(c=Number.MAX_VALUE,m=-Number.MAX_VALUE,h=Number.MAX_VALUE,u=-Number.MAX_VALUE,R=[],T=I[G].length,P=0;P<T;++P){for(_=I[G][P],y=[],N=0;N<_.length;++N)M=_[N],P||((S=M[0])<h&&(h=S),S>u&&(u=S),(D=M[1])<c&&(c=D),D>m&&(m=D)),y.push(M[0],M[1],"0");R.push(y)}C.push([h,u,c,m]),f.push(R)}break;default:continue}d.push(o(L.id2,f,L.geometry.type,e,t,B,L.id2,C)),this.mRegionBox[L.id2]=window.VBI.MathLib.GetSurroundingBox(C)}}}else i.error("The GeoJSON file is invalid or could not be parsed.\r\nPlease contact your Administrator.",l,"sap.ui.vbm.AnalyticMap")},a.prototype.getRegionsTemplateObject=function(){return{id:"Region",type:"{00100000-2012-0004-B001-F311DE491C77}","entity.bind":"Regions.Entity",datasource:"Regions","posarraymulti.bind":"Regions.PosList","color.bind":"Regions.Color",selectColor:a.DefaultRegionSelectColor,nonSelectColor:a.DefaultRegionNonSelectColor,"colorBorder.bind":"Regions.BorderColor","tooltip.bind":"Regions.ToolTip","hotDeltaColor.bind":"Regions.HotDeltaColor","altBorderDeltaColor.bind":"Regions.AltBorderColor","select.bind":"Regions.VB:s","labelText.bind":"Regions.LT","labelPos.bind":"Regions.LP","labelBgColor.bind":"Regions.LBC","labelBorderColor.bind":"Regions.LBBC","labelArrow.bind":"Regions.AR","labelType.bind":"Regions.LabelType"}},a.prototype.getRegionsTypeObject=function(){return{name:"Regions",minSel:"0",maxSel:"-1",key:"Key",A:[{name:"Key",alias:"K",type:"string"},{name:"PosList",alias:"P",type:"vectorarraymulti"},{name:"ToolTip",alias:"T",type:"string"},{name:"Color",alias:"C",type:"color"},{name:"BorderColor",alias:"CB",type:"color"},{name:"HotDeltaColor",alias:"HDC",type:"string"},{name:"AltBorderColor",alias:"ACB",type:"color"},{name:"Entity",alias:"G",type:"string"},{name:"VB:s",alias:"S",type:"boolean"},{name:"LT",alias:"LT",type:"string"},{name:"LP",alias:"LP",type:"string"},{name:"LBC",alias:"LBC",type:"color"},{name:"LBBC",alias:"LBBC",type:"color"},{name:"AR",alias:"AR",type:"boolean"},{name:"LabelType",alias:"LabelType",type:"string"}]}},a.prototype.getRegionsDataObjects=function(){var e=[],o=[],i=[];if(jQuery.extend(!0,e,this.mRegionApplicationTable),!e.length)return null;for(var r,n,s,l=this.getRegionMap(),g=0,p=e.length;g<p;++g)if(r=l[(n=e[g]).K]){n.HDC="RHLSA(0;1.0;1.0;0.4)",n.ACB=a.AltBorderColor,(s=r.getColor())&&(n.C=this.getPlugin()?window.VBI.Utilities.String2VBColor(s):s),(s=r.getTooltip())&&(n.T=s),n.LT=r.getLabelText(),n.S=r.getSelect(),n.LP="0",n.LBC=r.getLabelBgColor(),n.LBBC=r.getLabelBorderColor(),n.AR=r.getLabelArrow();var h=r.getLabelType(),u=t.prototype.getLabelProps(h);u&&n.LT&&(u.LBC&&(n.LBC=u.LBC),u.LBBC&&(n.LBBC=u.LBBC),u.LIC&&(n.LIC=u.LIC),u.LICC&&(n.LICC=u.LICC),u.LICTC&&(n.LICTC=u.LICTC)),n.LBC||(n.LBC="rgba(255,255,255,1.0)"),""==n.LBBC&&(n.LBBC=n.LBC),o.push(n)}else i.push(n);return{name:"Regions",type:"N",E:i.concat(o)}},a.prototype.addRegionsActions=function(e){return e.push({id:"AMap1",name:"RGN_CLICK",refScene:"MainScene",refVO:"Region",refEvent:"Click"}),e.push({id:"AMap2",name:"RGN_CONTEXTMENU",refScene:"MainScene",refVO:"Region",refEvent:"ContextMenu"}),e},a.prototype.findSelected=function(e,t){var o=this.getRegions();if(!o)return null;var i=[];if("object"==jQuery.type(t)){if(t.S==(e?"true":"false"))for(var r=0;r<o.length;++r)o[r].sId==t.K&&i.push(o[r])}else if("array"==jQuery.type(t))for(var n=0;n<t.length;++n)if(t[n].S==(e?"true":"false"))for(var a=0;a<o.length;++a)o[a].mProperties.code===t[n].K&&i.push(o[a]);return i},a.prototype.setSelectionPropFireSelect=function(t){for(var o={N:[]},i=t.N,r=0;r<i.length;++r){var n,a,s=i[r],l=s.E,g=!1;if("Regions"==s.name){n=[],a=[];for(var p=this.getRegionMap(),h=0;h<l.length;++h){var u=l[h],c="true"==u.S,m=p[u.K];if(m)c!=m.getSelect()&&(m.setProperty("select",c,!0),c&&this.mEventRegistry.regionSelect?n.push(m):!c&&this.mEventRegistry.regionDeselect&&a.push(m));else g=!0}a.length&&this.fireRegionDeselect({deselected:a}),n.length&&this.fireRegionSelect({selected:n}),g&&(this.invalidate(),this.mbForceDataUpdate=!0)}else o.N.push(s)}o.N.length&&e.prototype.setSelectionPropFireSelect.call(this,o)},a.prototype.getSelectedItems=function(e){var t=[];if(!e)return null;for(var o=0;o<e.length;++o)if("Regions"===e[o].name){var i=this.findSelected(!0,e[o].E);i&&i.length&&(t=t.concat(i))}else{var r=this.getAggregatorContainer(e[o].name).findSelected(!0,e[o].E);r&&r.length&&(t=t.concat(r))}return t},a.prototype.findRegionInAggregation=function(e){var t=this.getRegions();if(t)for(var o=0,i=t.length;o<i;++o)if(t[o].mProperties.code===e)return t[o];return null},a.prototype.updateVOData=function(t,o,i,r,n){this.mbThemingDirty&&this.applyTheming(this.mRegionApplicationTable),t.push(this.getRegionsTemplateObject()),r.push(this.getRegionsTypeObject()),i.push({name:"Regions",type:"N"}),o.push(this.getRegionsDataObjects()),e.prototype.updateVOData.apply(this,arguments),this.addRegionsActions(n)},a.prototype.resetDirtyStates=function(){e.prototype.resetDirtyStates.apply(this,arguments),this.mbRegionsDirty=!1},a.prototype.minimizeApp=function(t){var o,i;return e.prototype.minimizeApp.apply(this,arguments),this.getMapConfiguration()||(o=t)&&(o=o.SAPVB)&&(o=o.Scenes)&&((i=o.Set)||(i=o.Merge))&&(o=i.SceneGeo)&&o.refMapLayerStack&&(o.refMapLayerStack=""),t},a.prototype.invalidate=function(t){t instanceof sap.ui.vbm.Region&&(this.mbRegionsDirty=!0),e.prototype.invalidate.apply(this,arguments)},a.prototype.getRegionMap=function(){for(var e,t={},o=this.getRegions(),i=0,r=o?o.length:0;i<r;++i)t[(e=o[i]).getCode()]=e;return t},a.prototype.zoomToRegions=function(e,t){null==t&&(t=.9999);for(var o=[],i=0,r=e.length;i<r;++i){var n=this.mRegionBox[e[i]];null!=n&&o.push(n)}if(o.length){var a=null;(a=this.mVBIContext.GetMainScene())&&a.ZoomToAreas(o,t)}},a.prototype.getRegionsInfo=function(e){for(var t,o=[],r=0,n=e.length;r<n;++r){o[t=e[r]]={},o[t].BBox=this.mRegionBox[t],o[t].Name=this.mNames[t],o[t].Properties=this.mRegionProps[t],o[t].Midpoint=[0,0];var a=this.mVBIContext.GetMainScene();if(a){for(var s=[],l=0;l<this.mRegionApplicationTable.length;++l)if(this.mRegionApplicationTable[l].K===t){s=this.mRegionApplicationTable[l].XA;break}if(0!=s.length){var g,p,h,u,c,m;if(1==s.length)g=s[0];else{p=0;for(var d=0;d<s.length;++d){h=window.VBI.MathLib.DegToRad([s[d][0],s[d][2]]),u=window.VBI.MathLib.DegToRad([s[d][1],s[d][3]]),Math.abs(u[0]-h[0])>Math.PI&&(h[0]+=2*Math.PI),c=a.GetPointFromGeo(h,!1),m=a.GetPointFromGeo(u,!1);var y=Math.abs(m[0]-c[0])*Math.abs(m[1]-c[1])*.5;y>p&&(p=y,g=s[d])}}if(g){h=window.VBI.MathLib.DegToRad([g[0],g[2]]),u=window.VBI.MathLib.DegToRad([g[1],g[3]]),Math.abs(u[0]-h[0])>Math.PI&&(h[0]+=2*Math.PI),c=a.GetPointFromGeo(h,!1),m=a.GetPointFromGeo(u,!1);var C=[.5*(c[0]+m[0]),.5*(c[1]+m[1])];o[t].Midpoint=window.VBI.MathLib.RadToDeg(a.GetGeoFromPoint(C))}else i.error("Unable to calculate country mid point, box is empty",t,"sap.ui.vbm.AnalyticMap")}else i.error("Unable to calculate country mid point, region not found",t,"sap.ui.vbm.AnalyticMap")}else i.error("Unable to calculate country mid point, scene is empty",t,"sap.ui.vbm.AnalyticMap")}return o},a.prototype.onThemeChanged=function(e){this.mbThemingDirty=!0,this.invalidate()},a.prototype.applyTheming=function(e){if(o){var t=a.DefaultRegionColor;null!=o.get("_sap_ui_vbm_shared_ChoroplethRegionBG")&&(t=a.DefaultRegionColor=o.get("_sap_ui_vbm_shared_ChoroplethRegionBG"));var i=a.DefaultRegionColorBorder;if(null!=o.get("_sap_ui_vbm_shared_ChoroplethRegionBorder")&&(i=a.DefaultRegionColorBorder=o.get("_sap_ui_vbm_shared_ChoroplethRegionBorder")),this.getPlugin()&&(t=window.VBI.Utilities.String2VBColor(t),i=window.VBI.Utilities.String2VBColor(i)),t!=this.mColC||i!=this.mColCB){for(var r=0;r<e.length;++r)e[r].C===this.mColC&&(e[r].C=t),e[r].CB===this.mColCB&&(e[r].CB=i);this.mColC=t,this.mColCB=i}this.mbThemingDirty=!1}},a.prototype.isRegionSubscribed=function(e,t){if(t){var o=this.findRegionInAggregation(t);return o&&o.hasListeners(e)}return!1},a}));