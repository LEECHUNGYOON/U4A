sap.ui.define(["sap/ui/core/Control","sap/ui/core/RenderManager","jquery.sap.global","sap/base/Log","./library","./VBIRenderer","./lib/sapvbi","./lib/saputilities","./lib/sapvbicontext","./lib/sapdataprovider","./lib/sapresources","./lib/sapgeomath","./lib/sapmaplayer","./lib/sapmapprovider","./lib/sapmapmanager","./lib/sapvoutils","./lib/sapvobase","./lib/sapevents","./lib/saplabels","./lib/sappositioning","./lib/sapscene","./lib/sapwindow","./lib/sapactions","./lib/sapautomations","./lib/sapgeolocation","./lib/sapgeotool","./lib/sapscale","./lib/sapnavigation","./lib/sapvbmenu","./lib/sapprojection","./lib/sapvbcluster","./lib/sapparsing","./lib/sapconfig","./lib/saplassotrack","./lib/saprecttrack","./lib/sapheatmap"],(function(t,e,jQuery,i,o,n){"use strict";var a="sap.ui.vbm.VBI";VBI.Utilities.GetTransparentImage();var s=t.extend("sap.ui.vbm.VBI",{metadata:{library:"sap.ui.vbm",properties:{width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"800px"},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"600px"},config:{type:"object",group:"Misc",defaultValue:null},plugin:{type:"boolean",group:"Misc",defaultValue:!1},rectangularSelection:{type:"boolean",group:"Misc",defaultValue:!1},lassoSelection:{type:"boolean",group:"Misc",defaultValue:!1},rectZoom:{type:"boolean",group:"Misc",defaultValue:!1},allowKeyEventRepeat:{type:"boolean",group:"Behavior",defaultValue:!0},keyEventDelay:{type:"int",group:"Behavior",defaultValue:250},enableOverlappingTest:{type:"boolean",group:"Behavior",defaultValue:!0},ariaLabel:{type:"string",group:"Misc"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:!0,singularName:"ariaLabelledBy"}},events:{submit:{parameters:{data:{type:"string"}}},thumbnailClick:{parameters:{pos:{type:"string"},zoomLevel:{type:"int"}}},render:{parameters:{canvas:{type:"object"}}},changeTrackingMode:{parameters:{mode:{type:"int"},bSet:{type:"boolean"}}},zoom:{parameters:{canvas:{type:"object"}}},move:{parameters:{canvas:{type:"object"}}},openWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},closeWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},containerCreated:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},containerDestroyed:{parameters:{contentarea:{type:"object"},id:{type:"string"}}}}},renderer:n});return s.RttMap={},s.prototype.exit=function(){if(this.getPlugin()){var t=this.getPlugInControl();t&&(t.OnSubmit=null)}else this.mVBIContext&&this.mVBIContext.clear();""!=this.resizeID&&(sap.ui.core.ResizeHandler.deregister(this.resizeID),this.resizeID="")},s.prototype.resize=function(t){var e=(null!=this.oControl?this.oControl:this).mVBIContext;if(e){var i=e.GetMainScene();i&&i.resizeCanvas(t),e.m_Windows&&e.m_Windows.NotifyResize()}},s.prototype.init=function(){this.m_aLoadQueue=null,this.getPlugin()||(this.mVBIContext=new VBI.VBIContext(this)),this.resizeID="",this.m_renderList=[]},s.prototype.loadNative=function(t){var e=this.getId(),o=document.getElementById("VBI"+e);if(o){var n=function(t){try{var e;if(e=JSON.parse(t)){var i=e.SAPVB,o=JSON.stringify(i,null,"  ");this.fireSubmit({data:o})}}catch(t){VBI.m_bTrace&&VBI.Trace("Error submitting plugin event")}};if("object"==jQuery.type(t)){var s=JSON.stringify(t,null,"  ");try{o.Load(s),o.OnSubmit=n.bind(this)}catch(t){i.error("Error loading vbiJSON from object","",a)}}else if("string"==jQuery.type(t))try{o.Load(t),o.OnSubmit=n.bind(this)}catch(t){i.error("Error loading vbiJSON from string","",a)}}},s.prototype.loadHtml=function(t){var e=this.getId(),i=null;if("string"==typeof t)try{i=JSON.parse(t.indexOf("{")?t.substr(t.indexOf("{")):t)}catch(t){return}else"object"==typeof t&&(i=t);if(i){var o;if(!i.SAPVB)return this.mVBIContext&&(o=new VBI.Adaptor(this.mVBIContext).CreateLoadData(i))?void this.loadHtml(o):void 0;var n=!1,a=!1,s=!1,r=!1,l=!1,m=!1;if("object"===jQuery.type(i)){if(i.SAPVB)if(i.SAPVB.Config&&this.mVBIContext.GetConfig().load(i.SAPVB.Config,this.mVBIContext),i.SAPVB.Resources&&(this.mVBIContext.GetResources().load(i.SAPVB.Resources,this.mVBIContext),r=!0),i.SAPVB.DataTypes&&(this.mVBIContext.m_DataTypeProvider||(this.mVBIContext.m_DataTypeProvider=new VBI.DataTypeProvider),this.mVBIContext.m_DataTypeProvider.load(i.SAPVB.DataTypes,this.mVBIContext)),i.SAPVB.Data&&(this.mVBIContext.m_DataProvider||(this.mVBIContext.m_DataProvider=new VBI.DataProvider),this.mVBIContext.m_DataProvider.load(i.SAPVB.Data,this.mVBIContext),n=!0),i.SAPVB.MapProviders&&(this.mVBIContext.m_MapProviders||(this.mVBIContext.m_MapProviders=new VBI.MapProviders),this.mVBIContext.m_MapProviders.load(i.SAPVB.MapProviders,this.mVBIContext),m=!0),i.SAPVB.MapLayerStacks&&(this.mVBIContext.m_MapLayerStackManager||(this.mVBIContext.m_MapLayerStackManager=new VBI.MapLayerStackManager(this.mVBIContext)),this.mVBIContext.m_MapLayerStackManager.load(i.SAPVB.MapLayerStacks,this.mVBIContext),m=!0),i.SAPVB.Windows&&(this.mVBIContext.m_Windows||(this.mVBIContext.m_Windows=new VBI.Windows),this.mVBIContext.m_Windows.load(i.SAPVB.Windows,this.mVBIContext),s=!0),i.SAPVB.Actions&&(this.mVBIContext.m_Actions||(this.mVBIContext.m_Actions=new VBI.Actions),this.mVBIContext.m_Actions.load(i.SAPVB.Actions,this.mVBIContext)),i.SAPVB.Automation&&(this.mVBIContext.m_Automations||(this.mVBIContext.m_Automations=new VBI.Automations),this.mVBIContext.m_Automations.load(i.SAPVB.Automation,this.mVBIContext)),i.SAPVB.Menus&&(this.mVBIContext.m_Menus||(this.mVBIContext.m_Menus=new VBI.Menus),this.mVBIContext.m_Menus.load(i.SAPVB.Menus,this.mVBIContext)),i.SAPVB.Clustering&&(this.mVBIContext.m_Clustering||(this.mVBIContext.m_Clustering=new VBI.Clustering),this.mVBIContext.m_Clustering.load(i.SAPVB.Clustering,this.mVBIContext),l=!0),i.SAPVB.Scenes)this.mVBIContext.m_SceneManager||(this.mVBIContext.m_SceneManager=new VBI.SceneManager),this.mVBIContext.m_SceneManager.load(i.SAPVB.Scenes,this.mVBIContext),a=!0;else if(m)for(var p=this.mVBIContext.m_SceneManager.m_SceneArray,h=0;h<p.length;++h)p[h].RefreshMapLayerStack&&p[h].RefreshMapLayerStack();n&&this.mVBIContext.m_Windows&&this.mVBIContext.m_Windows.NotifyDataChange(),(a||s)&&this.mVBIContext.m_Windows&&this.mVBIContext.m_Windows.Awake(e),(a||n||l||r)&&this.mVBIContext.m_Windows&&this.mVBIContext.m_Windows.RenderAsync()}}},s.prototype.load=function(t){if(t)if(this.isRendered())this.getPlugin()?this.loadNative(t):this.loadHtml(t),""==this.resizeID&&this.mVBIContext.GetMainScene()&&(this.resize(),this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize));else{if(this.m_aLoadQueue||(this.m_aLoadQueue=[]),t.SAPVB&&t.SAPVB.Scenes&&t.SAPVB.Scenes.Merge&&t.SAPVB.Scenes.Merge.SceneGeo){var e=t.SAPVB.Scenes.Merge.SceneGeo.initialStartPosition,i=t.SAPVB.Scenes.Merge.SceneGeo.initialZoom;if(e||i)for(var o=this.m_aLoadQueue,n=0;n<o.length;++n)if(o[n].SAPVB&&o[n].SAPVB.Scenes&&o[n].SAPVB.Scenes.Set&&o[n].SAPVB.Scenes.Set.SceneGeo){var a=o[n].SAPVB.Scenes.Set.SceneGeo;a.initialStartPosition=e||a.initialStartPosition,a.initialZoom=i||a.initialZoom;break}}this.m_aLoadQueue.push(t)}},s.prototype.getPicOfOverlay=function(t){var e=this.mVBIContext.GetMainScene();return e&&e.GetOverlayPicture?e.GetOverlayPicture(t):""},s.prototype.minimize=function(t,e,i,o,n,a,s,r){var l=this.mVBIContext;l.moThumbnail||(l.moThumbnail={bThumbnailed:!1});var m=l.moThumbnail;m.nThumbWidth=t,m.nThumbHeight=e,m.strFont=n,m.strCol=a,m.nFontPos=s,m.strText=r,i&&(m.nFullWidth=i),o&&(m.nFullHeight=o);var p=l.GetMainScene();p&&l.DoMinimize(p)},s.prototype.maximize=function(t,e){var i,o,n=this.mVBIContext.GetMainScene();n&&this.mVBIContext.moThumbnail&&(i=t?String(t)+"px":this.mVBIContext.moThumbnail.strOrgWidth?this.mVBIContext.moThumbnail.strOrgWidth:this.getWidth(),o=e?String(e)+"px":this.mVBIContext.moThumbnail.strOrgHeight?this.mVBIContext.moThumbnail.strOrgHeight:this.getHeight(),this.mVBIContext.m_bThumbnail=!1,this.setWidth(i),this.setHeight(o),n.m_Ctx.moThumbnail=void 0,n.resizeCanvas(0))},s.prototype.zoomToGeoPosition=function(t,e,i){var o=null;(o=this.mVBIContext.GetMainScene())&&("array"==jQuery.type(t)&&"array"==jQuery.type(e)?t.length>1&&e.length>1?o.ZoomToMultiplePositions(t,e):o.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(t[0]),parseFloat(e[0])]),parseFloat(i)):o.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(t),parseFloat(e)]),parseFloat(i)))},s.prototype.zoomToAreas=function(t,e){var i=null;(i=this.mVBIContext.GetMainScene())&&i.ZoomToAreas(t,e)},s.prototype.getInfoForCluster=function(t,e){var i=null;return(i=this.mVBIContext.GetMainScene())?i.getInfoForCluster(t,e):null},s.prototype.setRectangularSelection=function(t){var e=this.mVBIContext.GetMainScene();return e&&(t&&e.m_nInputMode==window.VBI.InputModeRectSelect||(e.endTrackingMode(),t&&(this.setProperty("lassoSelection",!1,!0),this.setProperty("rectZoom",!1,!0),new e.RectSelection,e.m_Ctx.onChangeTrackingMode(VBI.InputModeRectSelect,!0)))),this.setProperty("rectangularSelection",t,!0),this},s.prototype.setLassoSelection=function(t){var e=this.mVBIContext.GetMainScene();return e&&(t&&e.m_nInputMode==window.VBI.InputModeLassoSelect||(e.endTrackingMode(),t&&(this.setProperty("rectangularSelection",!1,!0),this.setProperty("rectZoom",!1,!0),new e.LassoSelection,e.m_Ctx.onChangeTrackingMode(VBI.InputModeLassoSelect,!0)))),this.setProperty("lassoSelection",t,!0),this},s.prototype.setRectZoom=function(t){var e=this.mVBIContext.GetMainScene();return e&&(t&&e.m_nInputMode==window.VBI.InputModeRectZoom||(e.endTrackingMode(),t&&(this.setProperty("lassoSelection",!1,!0),this.setProperty("rectangularSelection",!1,!0),new e.RectangularZoom,e.m_Ctx.onChangeTrackingMode(VBI.InputModeRectZoom,!0)))),this.setProperty("rectZoom",t,!0),this},s.prototype.onAfterRendering=function(){if(this.$oldContent.length>0&&this.$().append(this.$oldContent),this.m_aLoadQueue){var t;for(t=0;t<this.m_aLoadQueue.length;++t)this.load(this.m_aLoadQueue[t]);this.m_aLoadQueue=null}""==this.resizeID&&this.mVBIContext.GetMainScene()&&(this.resize(),this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize));var e=this.getId();this.mVBIContext.m_Windows&&this.mVBIContext.m_Windows.Awake(e);for(var i,o=jQuery(this.getDomRef()).children(".vbi-hidden").children(),n=0;n<o.length;++n){i=o[n];var a=document.getElementById(i.attributes.getNamedItem("data").nodeValue);a&&(i.firstChild&&a.appendChild(i.firstChild),i.parentNode.removeChild(i))}},s.prototype.onBeforeRendering=function(){var t=this.getDomRef();t&&!e.isPreservedContent(t)&&e.preserveContent(t,!0,!1),this.$oldContent=e.findPreservedContent(this.getId())},s.prototype.isRendered=function(){return!!this.getDomRef()},s.prototype.getPlugInControl=function(){var t=this.getId(),e=document.getElementById("VBI"+t);return e||null},s.prototype.setConfig=function(t){if(t)return this.load(t)},s.prototype.setWidth=function(t){"number"==typeof t?this.setProperty("width",parseInt(t,10).toString()+"px"):this.setProperty("width",t)},s.prototype.setHeight=function(t){"number"==typeof t?this.setProperty("height",parseInt(t,10).toString()+"px"):this.setProperty("height",t)},s.prototype.addRenderItem=function(t,e){this.m_renderList.push({control:t,data:e}),this.invalidate()},s}));