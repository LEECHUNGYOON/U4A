/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/core/CustomData","sap/ovp/cards/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/navigation/PresentationVariant","sap/ovp/cards/jUtils","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/ovp/app/OVPLogger","sap/m/MessageToast","sap/ui/core/library","sap/ui/model/FilterOperator","sap/fe/navigation/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/m/MessageBox","sap/ovp/helpers/ODataDelegator","sap/ovp/cards/Filterhelper"],function(t,e,a,r,i,n,o,s,l,c,v,p,u,f,g,m,jQuery,d,h,y,S){"use strict";var P=new p("OVP.cards.NavigationHelper");var b=f.TextDirection;function I(n,o,s,l,c,v){if(!s){return[]}var p=[];var u=l.getProperty("/template");var f=i.isODataV4(o);if(!c&&!n){if(!v){var g=l.getProperty("/kpiAnnotationPath");if(g&&(u==="sap.ovp.cards.charts.analytical"||u==="sap.ovp.cards.v4.charts.analytical")){var m=f?s["@"+g]:s[g];var d=m&&m.Detail;if(d){var h=f?d.SemanticObject:d.SemanticObject&&d.SemanticObject.String;var y=f?d.$Type:d.RecordType;var S=f?d.Action:d.Action&&d.Action.String;if(y==="com.sap.vocabularies.UI.v1.KPIDetailType"&&h&&S){p.push({type:y,semanticObject:h,action:S,label:""})}else{P.error("Invalid Semantic object and action configured for annotation "+d.RecordType)}}else{throw new Error("KPI does not have a KPIDetailType annotation")}}}}if(!c){var v=l.getProperty("/identificationAnnotationPath");var b=v?v.split(","):[];if(b&&b.length>1){c=b[0]}else{c=v}}if(f){c="@"+c}var I=s[c];if(Array.isArray(I)){I=t.sortCollectionByImportance(I);for(var O=0;O<I.length;O++){var F=f?I[O].$Type:I[O].RecordType;var A=f?I[O].Label:I[O].Label&&I[O].Label.String;if(F==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){var h=f?I[O].SemanticObject:I[O].SemanticObject.String;var S=f?I[O].Action:I[O].Action.String;p.push({type:F,semanticObject:h,action:S,label:A||null})}if(F==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!I[O].Url.UrlRef){var D=o.getMetaModel();var C,V;if(f){C=n?n.getInterface(0).getPath():"/"+l.getInterface().getData().entitySet;var x=D.createBindingContext(C);V=a.format(I[O].Url,{context:x})}else{C=s.$path;var x=D.createBindingContext(C);V=e.format(x,I[O].Url)}var k=new r({key:"url",value:V});if(n&&u==="sap.ovp.cards.charts.analytical"){o=n.getModel()}k.setModel(o);k.setBindingContext(n);var N=k.getValue();var L=f?I[O].Value:I[O].Value.String;p.push({type:F,url:N,value:L,label:A||null})}}}return p}function O(t){if(!t){return false}var e=t.getProperty("/template");var a=t.getProperty("/navigation");return a==="noHeaderNav"&&["sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.smart.chart","sap.ovp.cards.v4.charts.analytical"].indexOf(e)>-1}function F(t,e){var a=i.isODataV4(t);if(e&&e.length){for(var r=0;r<e.length;r++){var n=e[r];var o=a?n.$Type:n.RecordType;if(o==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||o==="com.sap.vocabularies.UI.v1.DataFieldForAction"||o==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return true}}}return false}function A(t,e){var a=i.isODataV4(t);if(e){var r=a?"@com.sap.vocabularies.UI.v1.LineItem":"com.sap.vocabularies.UI.v1.LineItem";var n=e[r];var o=a?n&&n[0].$Type:n&&n[0].RecordType;if(o){return o==="com.sap.vocabularies.UI.v1.DataFieldForAction"||o==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"}}return false}function D(t,e,a){var r=i.isODataV4(t);var n=a&&a.getProperty("/annotationPath");if(e&&n){n=r?"@"+n:n;var o=e[n];return this.isNavigationInAnnotation(t,o)}return false}function C(t,e,a){var r=i.isODataV4(t);var n=a&&a.getProperty("/template");if(e&&a){var o=a.getProperty("/identificationAnnotationPath");var s=o;var l=a.getProperty("/contentFragment");if(l==="sap.ovp.cards.stack.Stack"||l==="sap.ovp.cards.quickview.Quickview"){var c=o?o.split(","):[];if(c&&c.length>1){if(l==="sap.ovp.cards.stack.Stack"){s=c[0]}else{s=c[1]}}}var v=r?e["@"+s]:e[s];if(this.isNavigationInAnnotation(t,v)){return true}if(n==="sap.ovp.cards.charts.analytical"||n==="sap.ovp.cards.v4.charts.analytical"){var p=a.getProperty("/kpiAnnotationPath");if(e&&p){var u=e[p];if(u&&u.Detail){var f=u.Detail.SemanticObject&&u.Detail.SemanticObject.String;var g=u.Detail.Action&&u.Detail.Action.String;if(f&&g){return true}}}}}else if(a&&(n==="sap.ovp.cards.linklist"||n==="sap.ovp.cards.v4.linklist")&&a.getProperty("/staticContent")&&a.getProperty("/targetUri")){return true}return false}function V(t,e){for(var a=0;a<t.property.length;a++){var r=t.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"];var i=r&&r.Bool;if(i){e.removeSelectOption(t.property[a].name)}}}function x(t,e){for(var a in t.property){if(typeof t.property[a]==="object"&&t.property[a].$kind==="Property"){var r=t.property[a];var i=r.annotations&&r.annotations["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||false;if(i){e.removeSelectOption(a)}}}}function k(t){var e=t.getParameterNames();for(var a=0;a<e.length;a++){if(t.getParameter(e[a])===""){t.removeParameter(e[a])}}var r=t.getSelectOptionsPropertyNames();for(a=0;a<r.length;a++){var i=t.getSelectOption(r[a]);for(var n=0;n<i.length;n++){if(i[n].Low===""&&!i[n].High){i.splice(n,1);n--}}t.removeSelectOption(r[a]);if(i.length>0){t.massAddSelectOption(r[a],i)}}return t}function N(t,e){var a=t.sFunctionLabel||"";var r={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:e,forceSubmit:true,context:t.oContext,functionImport:t.oFunctionImport};var n=new Promise(function(e,i){var n=t.oContext.getModel();var o;o="/"+r.functionImport.name;n.callFunction(o,{method:r.functionImport.httpMethod,urlParameters:r.urlParameters,batchGroupId:r.batchGroupId,changeSetId:r.changeSetId,headers:r.headers,success:function(t,a){e(a)},error:function(t){t.actionText=a;i(t)}})});n.then(function(t){return u.show(d.getText("Toast_Action_Success"),{duration:1e3})},function(t){var e=i.showODataErrorMessages(t);if(e===""&&t.actionText){e=d.getText("Toast_Action_Error")+' "'+t.actionText+'"'+"."}return h.error(e,{title:d.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:b.Inherit})})}function L(t){var e;if(t&&t.mainComponent){e=t.mainComponent._getFilterPreference(t.cardId)}return e}function T(t,e){var a=[];if(t&&t.filterAll==="card"){a=e.getSelectOptionsPropertyNames()}else if(t&&t.cardFilter){a=t.cardFilter}a.forEach(function(t){if(t!=="$.basicSearch"){e.removeSelectOption(t)}});return e}function E(t,e){var a=true;if(t&&t.filterAll==="global"){a=false}else if(t&&t.globalFilter){if(t.globalFilter.indexOf(e)>=0){a=false}}return a}function U(t,e){var a=t&&t.getUiState({allFilters:false});var r=a?JSON.stringify(a.getSelectionVariant()):"{}";var i=new n(r);return _(e,i)}function _(t,e){var a,r,i,n;var o=L();e=T(o,e);var s=t.filters;var l=t.parameters;for(var c=0;c<s.length;c++){a=s[c];if(a.path&&a.operator&&typeof a.value1!=="undefined"){r=a.value1.toString();i=typeof a.value2!=="undefined"?a.value2.toString():undefined;if(E(o,a.path)){e.addSelectOption(a.path,a.sign,a.operator,r,i)}}}var v,p,u;for(var f=0;f<l.length;f++){n=l[f];if(!n.path||!n.value){continue}v=n.path.split("/").pop();v=v.split(".").pop();if(v.indexOf("P_")===0){p=v;u=v.substr(2)}else{p="P_"+v;u=v}if(e.getParameter(p)){continue}if(e.getParameter(u)){continue}e.addParameter(v,n.value)}return e}function w(t,e,a,r,i){if(!t||!e){return}var n;if(a&&a.bStaticLinkListIndex){var o=e.getProperty("/staticContent");n=o[a.iStaticLinkListIndex]["customParams"];a=null}else{n=e.getProperty("/customParams")}if(!n||!t.templateBaseExtension.provideCustomParameter||!t.onCustomParams){return}var p=t.templateBaseExtension.provideCustomParameter(n)?t.templateBaseExtension.provideCustomParameter(n):t.onCustomParams(n);if(!p||!s.checkIfFunction(p)){return}var u=l({},a);var f=l({},r);var g;try{g=p(u,f)}catch(t){P.error("Could not process custom navigation parameters for the card. Plese check the implementation for the custom parameters extension implementation",t)}if(!g||!Array.isArray(g)&&!c(g)){return}var m=c(g);if(m&&v(g)){return}var d=m&&(!!g.bIgnoreEmptyString||!!g.ignoreEmptyString);var h=m?g.aSelectionVariant||g.selectionVariant:g;if(!Array.isArray(h)){return}var y,S,b,I,O,F;S=h.length;for(y=0;y<S;y++){b=h[y];if(!b){continue}I=b.path;O=b.value1;F=b.value2;if(!I||typeof I!=="string"||I===""){P.error("Custom Variant property path '"+I+"' should be valid string");continue}if(!(O||O===0||O===false||O==="")){continue}O=O.toString();F=F&&F.toString();if(a){delete a[I]}if(i){delete i[I]}if(O===""&&d){r.removeSelectOption(I)}r.addSelectOption(I,b.sign,b.operator,O,F)}if(d){k(r)}return d}function j(t,e){var a={};for(var r=0;e.property&&r<e.property.length;r++){var i=e.property[r].name;var n=t[i];if(t.hasOwnProperty(i)){if(Array.isArray(t[i])&&t[i].length===1){a[i]=t[i][0]}else if(jQuery.type(n)!=="object"){a[i]=n}}}return a}function B(t,e){var a={};for(var r in e.property){var i=t[r];if(t.hasOwnProperty(r)){if(Array.isArray(t[r])&&t[r].length===1){a[r]=t[r][0]}else if(jQuery.type(i)!=="object"){a[r]=i}}}return a}function M(e,a,r,s,l,c,v,p){var u={};var f,m;var d=r?r.globalFilter:undefined;var h=s&&s.getProperty("/staticContent");var y=i.isODataV4(a);var P=e.oMacroFilterBar;if(!h){var b=t.getCardSelections(s,y);var I=b.filters;var O=b.parameters;m=s&&s.getProperty("/staticParameters");I&&I.forEach(function(t){t.path=t.path&&t.path.replace("/",".");S.transformExcludeOperationForNavigation(t);switch(t.operator){case g.Contains:t.operator="CP";var e=t.value1;t.value1="*"+e+"*";break;case g.EndsWith:t.operator="CP";var e=t.value1;t.value1="*"+e;break;case g.StartsWith:t.operator="CP";var e=t.value1;t.value1=e+"*"}});b.filters=I;if(p&&c&&c.hasOwnProperty("$isOthers")){var F=p.getOtherNavigationDimensions();for(var A in F){var D=F[A];for(var C=0;C<D.length;C++){b.filters.push({path:A,operator:"EQ",value1:D[C],sign:"E"})}}}O&&O.forEach(function(t){t.path=t.path&&t.path.replace("/",".")});b.parameters=O;var V=t.getCardSorters(s,y);if(c){u=y?B(c,l):j(c,l)}var x=s&&s.getProperty("/kpiAnnotationPath");var k=s&&s.getProperty("/template");if(x&&(k==="sap.ovp.cards.charts.analytical"||k==="sap.ovp.cards.v4.charts.analytical")){var N=!y?l[x]:l["@"+x];var L=N&&N.Detail;if(!y&&L&&L.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){u["kpiID"]=N.ID.String}else if(L&&L.$Type==="com.sap.vocabularies.UI.v1.KPIDetailType"){u["kpiID"]=N.ID}}f=V&&new o(V);if(P){return P.getSelectionVariant().then(function(t){var r=_(b,t);return H(v,e,s,r,u,l,a,f,m)}.bind())}else{var T=this._buildSelectionVariant(d,b);return this._processCustomParameters(v,e,s,T,u,l,a,f,m)}}else{var T,m;if(P){return P.getSelectionVariant().then(function(t){T=R(r,t);m=$(h,v);return H(v,e,s,t,u,l,a,f,m)})}else{var E=d&&d.getUiState({allFilters:false});var U=E?JSON.stringify(E.getSelectionVariant()):"{}";T=new n(U);T=R(r,T);m=$(h,v);return H(v,e,s,T,u,l,a,f,m)}}}function R(t,e){var a=t||null;var r=L(a);return T(r,e)}function $(t,e){if(t[e.iStaticLinkListIndex].params){return t[e.iStaticLinkListIndex].params}else if(t[e.iStaticLinkListIndex].staticParameters){return t[e.iStaticLinkListIndex].staticParameters}}function H(t,e,a,r,n,o,s,l,c){var v;var p=e.oMacroFilterBar;if(t&&!t.bStaticLinkListIndex){v=w(e,a,t,r,n)}else if(t&&t.bStaticLinkListIndex){v=w(e,a,t,r,n)}else{v=w(e,a,t,r,n)}var u=v?m.SuppressionBehavior.ignoreEmptyString:undefined;if(c){for(var f in c){if(!n.hasOwnProperty(f)){n[f]=c[f]}}}for(var g in n){var d=y.getPropertyFromEntityType(g,o,s);var h=d.length>0?d[0]:{};var S=h&&h.nullable;if(n[g]===null&&S==="true"){r.addSelectOption(g,"I","EQ","",null);delete n[g]}}var P=i.getNavigationHandler();var b=P&&P.mixAttributesAndSelectionVariant(n,r.toJSONString(),u);var I=a&&a.getProperty("/staticContent");if(!I){if(p){x(o,b)}else{this._removeSensitiveAttributesFromNavSelectionVariantForODataV2Model(o,b)}}return{sNavSelectionVariant:b?b.toJSONString():null,sNavPresentationVariant:l?l.toJSONString():null}}return{_checkIfCardFiltersAreValid:E,processCustomParameters:w,_removeSensitiveAttributesFromNavSelectionVariantForODataV2Model:V,_removeSensitiveAttributesFromNavSelectionVariantForODataV4Model:x,_removeEmptyStringsFromSelectionVariant:k,_buildSelectionVariant:U,getEntityNavigationEntries:I,checkHeaderNavigationDisabledForAnalyticalCard:O,isNavigationInAnnotation:F,checkNavigationForLinkedList:A,checkLineItemNavigation:D,checkNavigation:C,callFunction:N,getFilterPreference:L,removeFilterFromGlobalFilters:T,getEntityNavigationParameters:M,getContextParametersForV2:j,getContextParametersForV4:B,_processCustomParameters:H,_updateSelectionVariant:_,_removeFilters:R,_getStaticParameters:$}});
//# sourceMappingURL=NavigationHelper.js.map