/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ui/core/Fragment","sap/ovp/cards/PersonalizationUtils","sap/ovp/cards/CommonUtils"],function(a,e,r,t,i,d){"use strict";return a.extend("sap.ovp.app.ManageCardsUtils",{constructor:function(a){if(!a){throw new Error("Main Controller is required to initialize ManageCardsUtil")}},onManageCardsMenuButtonPress:function(){this.aManageCardsDialogModelState=[];var a=d.getApp();var s=this;var o={onManageCardOkButtonPressed:function(e){if(e.getParameters().reason==="Ok"){var r=a.byId("manageCardsSelectionPanel").getP13nData();var t=a.getUIModel().getProperty("/aOrderedCards");var d=[];var o=r.length;for(var n=0;n<o;n++){if(r[n].visible!==t[n].visible){d.push({changeType:"visibility",content:{cardId:r[n].id,visibility:r[n].visible},isUserDependent:true})}r[n].visibility=r[n].visible}a.createOrDestroyCards.apply(a,[s.aManageCardsDialogModelState,r,false]);a.getUIModel().setProperty("/aOrderedCards",r);a.updateDashboardLayoutCards(r);var l=a.getOwnerComponent().oOvpConfig,g=l&&l.bInsightRTEnabled;if(g){a.updateCardVisibiltyForCM(r)}a.updateLayoutWithOrderedCards();i.savePersonalization(d,a.getView());for(var n=0;n<r.length;n++){var v=r[n];var p=a.aErrorCards.indexOf(v.id);if(p>-1&&v.visibility==false){a.aErrorCards.splice(p,1)}}if(document.querySelector(".sapFAvatar")){document.querySelector(".sapFAvatar").focus()}}var u=a.byId("manageCardsSelectionPanel");var C=a.byId("manageCardsDialog");if(u&&C){u.destroy();C.destroy()}},onManageCardResetButtonPressed:function(){var e=a.getLayout().getMetadata().getName();var t=a.getUIModel();var i=t.getProperty("/aOrderedCards");a.createOrDestroyCards.apply(a,[i,a.aManifestOrderedCards,e==="sap.ovp.ui.DashboardLayout"?true:false]);t.setProperty("/aOrderedCards",a.aManifestOrderedCards);a.resetDashboardLayout();a.updateDashboardLayoutCards(a.aManifestOrderedCards);a.updateLayoutWithOrderedCards();s.manageCardsDialog.getModel().setProperty("/cards",a.aManifestOrderedCards);var d=[];for(var o=0;o<i.length;o++){d.push(a.getView().byId(i[o].id))}var n=s.enhanceOrderedCardsForP13NDialog(i);var l=a.byId("manageCardsSelectionPanel");l.setP13nData(n);r.reset({selectors:d}).finally(function(){if(document.querySelector(".sapFAvatar")){document.querySelector(".sapFAvatar").focus()}})}};this.oManageCardsFragment=t.load({id:a.getView().getId(),name:"sap.ovp.app.ManageCard",controller:o}).then(function(r){s.manageCardsDialog=r;var t=a.getUIModel().getProperty("/aOrderedCards");var i=Object.assign([],t);s.aManageCardsDialogModelState=s.getManageCardsDialogModelState(t);var d=new e({cards:i});s.manageCardsDialog.setModel(d);a.getView().addDependent(s.manageCardsDialog);s.openManageCardsDialog(t)})},openManageCardsDialog:function(a){var e=d.getApp();var r=this.enhanceOrderedCardsForP13NDialog(a);var t=e.byId("manageCardsDialog");var i=e.byId("manageCardsSelectionPanel");i.setP13nData(r);t.open()},enhanceOrderedCardsForP13NDialog:function(a){var e=[];var r=d.getApp();a.forEach(function(a){e.push(a["id"])});var t=r._getCardsModel();var i=[];var s=r.getLayout().getMetadata().getName();if(s==="sap.ovp.ui.DashboardLayout"){var o=r._getCardArrayAsVariantFormatDashboard();o.forEach(function(a){var r=t.find(function(e){return e.id===a.id});var s=d.getUpdatedTitle(a.id);if(e.indexOf(a.id)!=-1){i.push({id:a.id,visibility:a.visibility,visible:a.visibility,name:a.id,label:s||r.settings.title})}});a=i}else if(s==="sap.ovp.ui.EasyScanLayout"){var n=r.getLayout().getContent();var t=r._getCardsModel();n.forEach(function(a){var r=a.getId();var s=r.split("--").pop();var o=t.find(function(a){return a.id===s});var n=d.getUpdatedTitle(s);if(e.indexOf(s)!=-1){i.push({id:s,visibility:a.getVisible(),visible:a.getVisible(),name:s,label:n||o.settings.title})}});a=i}this.aManageCardsDialogModelState=this.getManageCardsDialogModelState(a);r.getUIModel().setProperty("/aOrderedCards",a);this.manageCardsDialog.getModel().setProperty("/cards",a);return a},getManageCardsDialogModelState:function(a){var e=[];for(var r=0;r<a.length;r++){e.push({id:a[r].id,visibility:a[r].visibility})}return e}})});
//# sourceMappingURL=ManageCardsUtils.js.map