/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/fe/core/AppComponent","sap/fe/navigation/NavigationHandler","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel","sap/ovp/ui/DashboardLayoutUtil","sap/ui/core/mvc/ViewType","sap/ui/model/resource/ResourceModel","sap/ovp/app/resources","sap/ui/core/CustomData","sap/base/util/merge","sap/base/util/isEmptyObject","sap/ovp/app/OVPLogger","sap/ui/Device","sap/ovp/cards/CommonUtils","sap/ovp/placeholder/placeholderHelper","sap/m/App","sap/m/DynamicDateUtil","sap/ovp/cards/MetadataAnalyser","sap/ui/core/Core","sap/insights/CardHelper","sap/ui/VersionInfo","sap/ui/core/mvc/View","sap/suite/ui/commons/collaboration/CollaborationHelper","sap/ovp/cards/charts/OVPChartFormatter","sap/ovp/insights/CardProvider","sap/ui/core/ResizeHandler","sap/ui/rta/RuntimeAuthoring"],function(e,t,i,r,n,a,o,s,l,u,p,g,f,c,d,h,v,y,m,b,C,P,E,T,S,O,D){"use strict";var F=new g("OVP.app.Component");return e.extend("sap.ovp.app.Component",{metadata:{manifest:"json",routing:{config:{routerClass:"sap.m.routing.Router"},targets:{},routes:[]},properties:{},designtime:{actions:{},tool:{start:function(e){var t=e.getModel("ui");if(t){t.setProperty("/bRTAActive",true)}},stop:function(e){var t=e.getModel("ui");if(t){t.setProperty("/bRTAActive",false)}}},aggregations:{rootControl:{actions:{},propagateMetadata:function(){return{}}}}},version:"1.120.14",library:"sap.ovp.app",dependencies:{libs:["sap.ovp"],components:[]},config:{fullWidth:true,hideLightBackground:true}},onServicesStarted:function(){},getRoutingService:function(){return{beforeExit:function(){}}},getDashboardLayoutUtil:function(){return this.oDashboardLayoutUtil},_getOvpCardOriginalConfig:function(e){var t=this.getOvpConfig();return t.cards[e]},suspend:function(){if(this.ovpConfig.bInsightRTEnabled){S.unregisterProvider(this.getId())}var e=this.createId("mainView"),t=this.byId(e);var i=t.getController();var r=i.getLayout().resizeHandlerId;if(r){O.deregister(r)}},isCollaborationManagerServiceEnabled:function(){return false},restore:function(){var e=this.ovpConfig.cards,i=this.createId("mainView"),r=this.byId(i);var n=this.ovpConfig.refreshStrategyOnAppRestore&&this.ovpConfig.refreshStrategyOnAppRestore.entitySets;var a=r.getController();var o=new t(a,"ODataV2");c.enable(a,o);if(typeof n==="object"){var s=Object.keys(n);var l=e.filter(function(e){return s.includes(e.settings.entitySet)});for(var u=0;u<l.length;u++){var p=l[u];var g=r.createId(p.id);var f=this.byId(g);var d=f.getComponentInstance()&&f.getComponentInstance().getRootControl()&&f.getComponentInstance().getRootControl().getController();if(d){d.refreshCardContent()}}}T.registerCustomFormatters();if(this.ovpConfig.bInsightRTEnabled){var h=this.getMetadata().getManifestEntry("sap.app").id,v=this.getManifestObject().getRawJson(),y=v["sap.fiori"]&&v["sap.fiori"].registrationIds&&v["sap.fiori"].registrationIds[0]||h;e.forEach(function(e){var t=r.createId(e.id),i=this.byId(t),n=i.getComponentInstance()&&i.getComponentInstance().getRootControl()&&i.getComponentInstance().getRootControl().getController(),a=n&&n.getView()&&n.getView().getModel("ovpCardProperties");S.addInsightCard(a,y)}.bind(this));S.init(this.getId())}a.getLayout().initResizeHandler()},getOvpConfig:function(){var e;var t=[];var i=this.getMetadata();while(i&&i.getComponentName()!=="sap.ovp.app"){e=i.getManifestEntry("sap.ovp");if(e){t.unshift(e)}i=i.getParent()}t.unshift({});t.unshift(true);e=u.apply(u,t);return e},_removeExtraArrayElements:function(e,t){var i=e["staticContent"],r=t["staticContent"],n=e["tabs"],a=t["tabs"];if(i&&r){if(i.length>r.length){e["staticContent"].splice(r.length,i.length-r.length)}}if(n&&a){if(n.length>a.length){e["tabs"].splice(a.length,n.length-a.length)}}},_emptyAllArrayElements:function(e,t){var i=e["staticContent"],r=t["staticContent"],n=e["tabs"],a=t["tabs"];if(i&&r){for(var o=0;o<i.length;o++){e["staticContent"][o]={}}}if(n&&a){for(var o=0;o<n.length;o++){e["tabs"][o]={}}}},_mergeObjects:function(e,t){for(var i in t){if(t.hasOwnProperty(i)){var r=t[i];if(typeof r=="object"&&e[i]){if(r.operation==="DELETE"){delete e[i]}else{this._mergeObjects(e[i],r)}}else{if(typeof r=="object"&&!e[i]&&r.operation==="DELETE"){continue}e[i]=r}}}return e},_mergeLayerObject:function(e,t){if(!e[t+".settings"]){return e}var i=u({},e["settings"]),r=u({},e[t+".settings"]);this._removeExtraArrayElements(i,r);this._emptyAllArrayElements(i,r);e["settings"]=this._mergeObjects(i,r);return e},_mergeKeyUserChanges:function(e){if(!e.hasOwnProperty("customer.settings")&&!e.hasOwnProperty("customer_base.settings")&&!e.hasOwnProperty("vendor.settings")){return e}e=this._mergeLayerObject(e,"vendor");e=this._mergeLayerObject(e,"customer_base");e=this._mergeLayerObject(e,"customer");return e},_getFullyQualifiedNameForEntity:function(e,t){var i="",r;if(!e){return""}if(e.indexOf(".")>-1){return e}var n=t.getMetaModel();if(c.isODataV4(t)){var a=n.getObject("/");var o=a[e];i=o.$Type;return i}else{var s=n&&n.getODataEntityContainer();i=s&&s.namespace;if(i&&!(e.indexOf(i)>-1)){r=i+"."+e}else{r=e}return r}},_getDatePropertiesFromEntitySet:function(e,t,i){var r=[],n=[];var a=e.getMetaModel();var o=a&&a.getODataEntityContainer();var s=o.entitySet.filter(function(e){return e.entityType===i});var l=s.length>0?s[0]:{};var u=y.checkAnalyticalParameterisedEntitySet(e,l.name);if(u){var g=y.getParametersByEntitySet(e,l.name);if(g.entitySetName){r=y.getPropertyOfEntitySet(e,g.entitySetName);r.forEach(function(e){e._filterRestriction="single-value"})}}r=r.concat(t.property);for(var f in r){var d={};if(c.isDate(r[f])){d.PropertyPath=r[f].name}if(!p(d)){n.push(d)}}return n},_getAllControlConfiguration:function(e,t,i){for(var r=0;r<e.length;r++){if(i[e[r].PropertyPath]){var n=false;for(var a=0;a<t.length;a++){if(t[a].PropertyPath===e[r].PropertyPath){n=true}}if(!n){e[r].bNotPartOfSelectionField=true;t.push(e[r])}}}return t},_getSettingsForDateProperties:function(e,t){var i={};for(var r in e){if(t.fields&&t.fields[e[r].PropertyPath]){i[e[r].PropertyPath]=this.getConditionTypeForDateSetting(t.fields[e[r].PropertyPath])}else{if(t.customDateRangeImplementation||t.filter||t.selectedValues){i[e[r].PropertyPath]=this.getConditionTypeForDateSetting(t)}}}return i},getConditionTypeForDateSetting:function(e){if(e.customDateRangeImplementation){return{customDateRangeImplementation:e.customDateRangeImplementation}}else if(e.filter){return{filter:e.filter}}else if(e.selectedValues){return{selectedValues:e.selectedValues,exclude:e.exclude!==undefined?e.exclude:true}}else if(e.defaultValue){return{defaultValue:e.defaultValue}}return undefined},getViewSettings:function(e){if(this.getRouter()){this.getRouter().initialize()}var t=this.getMetadata().getManifestEntry("sap.app");var o=this.getMetadata().getManifestEntry("sap.ui");var s=i.get("icons.icon",o);var g=this.getModel(e.globalFilterModel);var d=g&&g.getMetaModel();this.setModel(g);var h=this.getMetadata().getComponentName();var y=h.replace(/\./g,"/");e.baseUrl=sap.ui.require.toUrl(y);e.useMacroFilterBar=g?c.isODataV4(g):false;if(e.smartVariantRequired===undefined||e.smartVariantRequired===null){e.smartVariantRequired=true}if(e.enableLiveFilter===undefined||e.enableLiveFilter===null){e.enableLiveFilter=true}if(e.showDateInRelativeFormat===undefined||e.showDateInRelativeFormat===null){e.showDateInRelativeFormat=true}if(e.filterSettings&&e.filterSettings.dateSettings&&e.filterSettings.dateSettings.useDateRange!==undefined&&e.useDateRangeType!==undefined){throw new Error("Defining both useDateRange and useDateRangeType in the manifest is not allowed")}e.useDateRangeType=e.filterSettings&&e.filterSettings.dateSettings&&e.filterSettings.dateSettings.useDateRange!==undefined?e.filterSettings.dateSettings.useDateRange:e.useDateRangeType;if(e.useDateRangeType===undefined||e.useDateRangeType===null){e.useDateRangeType=false}if(e.bHeaderExpanded===undefined||e.bHeaderExpanded===null){e.bHeaderExpanded=f.system.desktop?true:false}if(e.chartSettings===undefined||e.chartSettings===null){e.chartSettings={}}if(e.chartSettings.showDataLabel===undefined||e.chartSettings.showDataLabel===null){e.chartSettings.showDataLabel=false}if(e.globalFilterEntitySet&&e.globalFilterEntitySet!==" "){var m=d&&d.getODataEntitySet(e.globalFilterEntitySet);e.globalFilterEntityType=m&&m.entityType}var b=e.globalFilterEntityType;if(e.globalFilterEntityType&&e.globalFilterEntityType!==" "&&e.globalFilterEntityType.length>0){e.globalFilterEntityType=this._getFullyQualifiedNameForEntity(e.globalFilterEntityType,g);e.globalFilterEntityTypeNQ=e.globalFilterEntityType.split(".").pop()}var C=new r(e);var P=D.willRTAStartAfterReload();C.setProperty("/bRTAActive",P);C.setProperty("/applicationId",i.get("id",t));C.setProperty("/title",i.get("title",t));C.setProperty("/description",i.get("description",t));if(e.globalFilterEntityType){var E,T;if(c.isODataV4(g)){E=d.getObject("/"+e.globalFilterEntityType+"@com.sap.vocabularies.UI.v1.SelectionFields");T=d.getObject("/"+e.globalFilterEntityType);C.setProperty("/mainEntityVersion","ODataV4")}else{T=d.getODataEntityType(e.globalFilterEntityType);E=u([],T["com.sap.vocabularies.UI.v1.SelectionFields"]);C.setProperty("/mainEntityVersion","ODataV2");if(e.filterSettings&&e.filterSettings.dateSettings){var S=this._getDatePropertiesFromEntitySet(g,T,e.globalFilterEntityType);var O=this._getSettingsForDateProperties(S,e.filterSettings.dateSettings);if(C.getProperty("/useDateRangeType")&&O&&!p(O)){C.setProperty("/useDateRangeType",false);S.forEach(function(e){if(!O.hasOwnProperty(e["PropertyPath"])||!O[e["PropertyPath"]]){var t=e["PropertyPath"];O[t]={selectedValues:v.getAllOptionKeys().toString(),exclude:false}}})}E=this._getAllControlConfiguration(S,E,O);C.setProperty("/datePropertiesSettings",O)}}C.setProperty("/allControlConfiguration",E);C.setProperty("/mainEntityType",T)}if(s){if(s.indexOf("sap-icon")<0&&s.charAt(0)!=="/"){s=e.baseUrl+"/"+s}C.setProperty("/icon",s)}var F=e.cards;var R=[];var _;for(var M in F){if(F.hasOwnProperty(M)&&F[M]){_=this._mergeKeyUserChanges(F[M]);_.id=M;R.push(_)}}R.sort(function(e,t){if(e.id<t.id){return-1}else if(e.id>t.id){return 1}else{return 0}});C.setProperty("/cards",R);if(this.inResizableTestMode()===true){e.containerLayout="resizable"}if(e.containerLayout&&e.containerLayout==="resizable"){C.setProperty("/cardContainerFragment","sap.ovp.app.DashboardCardContainer");C.setProperty("/dashboardLayout",e.resizableLayout);var A=new n(C);this.oDashboardLayoutUtil=A}else{C.setProperty("/cardContainerFragment","sap.ovp.app.CardContainer")}this.setModel(C,"ui");var I=this._getOvpLibResourceBundle();this.setModel(I,"ovplibResourceBundle");var T;if(c.isODataV4(g)){T="/"+e.globalFilterEntityType}else{T=d&&d.getODataEntityType(e.globalFilterEntityType,true)}var w=this.createId("mainView");var V=new r({});return{id:w,height:"100%",preprocessors:{xml:{bindingContexts:{ui:C.createBindingContext("/"),meta:d.createBindingContext(T),contextPath:d.createBindingContext("/"+b),entitySet:b,converterContext:V.createBindingContext("/")},models:{ui:C,meta:d,contextPath:d,metaModel:d,converterContext:V}}},type:a.XML,viewName:"sap.ovp.app.Main",async:true,customData:[new l({key:"sap-ui-custom-settings",value:{"sap.ui.dt":{designtime:"sap/ovp/ui/OVPWrapper.designtime"}}})]}},_showErrorPage:function(){var e=this._getOvpLibResourceBundle();P.create({height:"100%",type:a.XML,viewName:"sap.ovp.app.Error"}).then(function(t){t.setModel(e,"ovplibResourceBundle");this.setAggregation("rootControl",t);if(this.oContainer){this.oContainer.invalidate()}}.bind(this))},_formParamString:function(e){var t=Object.keys(e);var i;var r="?";for(i=0;i<t.length;i++){r=r+t[i]+"="+e[t[i]]+"&"}return r.slice(0,-1)},_checkForAuthorizationForCards:function(e){var t=m.getConfiguration();var i=t&&t.getDesignMode();if(i){return Promise.resolve(e)}var r=[];var n=[];for(var a in e.cards){var o=e.cards[a];if(o&&o.settings&&o.settings.requireAppAuthorization){n.push(a);r.push({target:{shellHash:o.settings.requireAppAuthorization}})}}if(r.length>0&&sap.ushell&&sap.ushell.Container){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){return e.isNavigationSupported(r)}).then(function(t){var i=n.filter(function(e,i){if(!t[i].supported){return e}});for(var r=0;r<i.length;r++){for(var a in e.cards){if(i[r]===a){delete e.cards[a];break}}}return Promise.resolve(e)}).catch(function(e){F.error(e);return Promise.reject(e)})}else{return Promise.resolve(e)}},_checkForAuthorizationForLineItems:function(){return new Promise(function(e,t){var i=[],r=[],n=[];var a=this.getOvpConfig();var o=a["cards"];for(var s in o){if(o.hasOwnProperty(s)&&o[s]){var l=o[s];var u=l.settings;if((l.template==="sap.ovp.cards.linklist"||l.template==="sap.ovp.cards.v4.linklist")&&u.listFlavor==="standard"&&u.staticContent){var p=u.staticContent;for(var g=0;g<p.length;g++){if(p[g].semanticObject||p[g].action){var f="#"+p[g].semanticObject+"-"+p[g].action;if(p[g].params){var c=this._formParamString(p[g].params);f=f+c}if(r.indexOf(s)===-1){r.push(s)}if(i.indexOf(f)===-1){i.push(f);n.push({target:{shellHash:f}})}}}}}}if(sap.ushell&&sap.ushell.Container){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(t){t.isNavigationSupported(n).then(function(t){var n=this.getOvpConfig();this._aCardsWithStaticContent=r;for(var a=0;a<t.length;a++){if(t[a].supported===false&&this._aCardsWithStaticContent){for(var o=0;o<this._aCardsWithStaticContent.length;o++){var s=n["cards"][this._aCardsWithStaticContent[o]].settings.staticContent;for(var l=s.length-1;l>=0;l--){var u="#"+s[l].semanticObject+"-"+s[l].action;if(s[l].params){var p=this._formParamString(s[l].params);u=u+p}if(i[a]===u){s.splice(l,1)}}n["cards"][this._aCardsWithStaticContent[o]].settings.staticContent=s}}}delete this._aCardsWithStaticContent;e(n)}.bind(this)).catch(function(e){F.error(e);return Promise.reject(e)})}.bind(this))}else{e(a)}}.bind(this))},createContent:function(){if(E&&E.processAndExpandHash&&typeof E.processAndExpandHash==="function"){E.processAndExpandHash().catch(function(e){F.error(e)}).finally(function(){this._createContent()}.bind(this))}else{this._createContent()}},_createContent:function(){var e=this.getOvpConfig();var t=this.getModel(e.globalFilterModel);var i=[this._checkForAuthorizationForLineItems(e),s.pResourcePromise,this._isInsightRTEnabled(),C.load({library:"sap.ui.core"}),this._isTeamsModeActive()];if(c.isODataV4(t)){i.unshift(t&&t.getMetaModel().requestObject("/"+e.globalFilterModel))}else{i.unshift(t&&t.getMetaModel().loaded())}if(t&&!this.getAggregation("rootControl")){Promise.all(i).then(function(e){var t=e[3];this.ovpConfig=e[1];this.ovpConfig.sapUICoreVersionInfo=e[4];this.ovpConfig.isTeamsModeActive=e[5];this.ovpConfig.enableV4Insight=this._isInsightEnabledForV4Cards();if(this._isInsightDTEnabled()){this.ovpConfig.bInsightDTEnabled=true;return Promise.resolve(this.ovpConfig)}else{this.ovpConfig.bInsightRTEnabled=t?true:false;return this._checkForAuthorizationForCards(this.ovpConfig)}}.bind(this)).then(function(e){this.oOvpConfig=e;this.runAsOwner(function(){var e=this.createId("host"),t=new h(e),i=this.getViewSettings(this.oOvpConfig);P.create(i).then(function(e){e.bindElement({path:"/",model:"internal"});var i=new r({});e.setModel(i,"viewData");if(d.isPlaceHolderEnabled()){t.addPage(e);this.setAggregation("rootControl",t);d.showPlaceholder(t)}else{this.setAggregation("rootControl",e)}this.oContainer.invalidate()}.bind(this))}.bind(this))}.bind(this));if(!c.isODataV4(t)){t.attachMetadataFailed(function(){this._showErrorPage()}.bind(this))}}},_getOvpLibResourceBundle:function(){if(!this.ovplibResourceBundle){var e=m.getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=e?new o({bundleUrl:e.oUrlInfo.url,bundle:e}):null}return this.ovplibResourceBundle},createMapForEntityContainer:function(e){var t={};var i=e.entitySet;for(var r=0;r<i.length;r++){t[i[r].name]=i[r].entityType}return t},inResizableTestMode:function(){return this._getQueryParamUpToTop("resizableTest")=="true"},inLazyLoadingTestMode:function(){return this._getQueryParamUpToTop("sap-ovp-xx-lazyloadingtest")=="true"||this._getQueryParamUpToTop("sap-fe-xx-lazyloadingtest")=="true"},_isInsightEnabledForV4Cards:function(){return this._getQueryParamUpToTop("enable-v4-insight")==="true"},_isInsightDTEnabled:function(){return this._getQueryParamUpToTop("mode")==="myInsight"||this._getQueryParamUpToTop("mode")==="DT"},_isInsightRTEnabled:function(){var e=this._getQueryParamUpToTop("mode")==="RT";return new Promise(function(t,i){if(!b||!b.getServiceAsync){t(e);return}return b.getServiceAsync().then(function(i){t(!!i||e)}).catch(function(i){F.info("Failed to get CardHelperServiceInstance."+i);t(e)})})},_isTeamsModeActive:function(){var e=false;return new Promise(function(t,i){if(E&&E.isTeamsModeActive&&typeof E.isTeamsModeActive==="function"){return E.isTeamsModeActive().then(function(t){e=t}).catch(function(e){F.error("Failed to get Collaboration Helper."+e)}).finally(function(){t(e)})}else{t(e)}})},_getQueryParamUpToTop:function(e){var t=window;var i=this.getQueryParam(t.location.search,e);if(i!=null){return i}if(t==t.parent){return null}t=t.parent;return null},getQueryParam:function(e,t){var i=null;if(!e){return i}if(e.indexOf("?")!=-1){e=e.substring(e.indexOf("?"))}if(e.length>1&&e.indexOf(t)!=-1){e=e.substring(1);var r=e.split("&");for(var n=0;n<r.length;n++){var a=r[n].split("=");if(a[0]==t){i=a[1];break}}}return i}})});
//# sourceMappingURL=Component.js.map