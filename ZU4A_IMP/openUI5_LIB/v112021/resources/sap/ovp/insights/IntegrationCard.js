/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/app/OVPLogger","sap/ovp/app/NavigationHelper","sap/ovp/insights/helpers/AnalyticalCard","sap/ovp/insights/helpers/i18n","sap/ovp/insights/helpers/Batch","sap/ovp/insights/helpers/Filters","sap/ovp/app/resources","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ovp/cards/MetadataAnalyser","sap/ovp/helpers/ODataDelegator","sap/ovp/insights/helpers/CardHeader","sap/fe/navigation/SelectionVariant","sap/ovp/cards/CommonUtils","sap/ui/core/Core","sap/ovp/insights/helpers/ListContentHelper","sap/ovp/insights/helpers/ContentHelper","sap/ovp/insights/helpers/TableContentHelper","sap/insights/CardHelper","sap/m/MessageToast","sap/ovp/insights/helpers/CardAction","sap/ovp/cards/NavigationHelper","sap/ovp/handlers/SmartFilterbarHandler"],function(e,t,a,r,n,i,o,s,l,p,u,c,d,v,g,f,m,h,y,P,b,C,T){"use strict";var S=new e("sap.ovp.insights.IntegrationCard");var D="module:sap/insights/CardExtension";var O="";var V=function(e,t,a,r,n){var i=e&&e.getBinding(t);var o,s,l,p,u,c;var d,v,g;var f=r&&n!="sap.ovp.cards.charts.analytical"&&n!="sap.ovp.cards.charts.smart.chart";if(i){o=i.aApplicationFilters;s=i.getPath();l=i.mParameters.select;p=_(l&&l.split(","));l=p&&p.join();u=i.sSortParams;c=i.sRangeParams;d=i&&i.sCustomParams;v=d&&d.split("&");v=v&&v.filter(function(e){return e.indexOf("$expand")>-1});g=v&&v[0]}var m=c&&c.split("&")||[];var h,y;for(var P=0;P<m.length;P++){var b=m[P];if(b.indexOf("$skip")>-1){h=b.split("&")[0]}if(b.indexOf("$top")>-1){y=b.split("&")[0]}}if(f&&a&&a.length){var C=l&&l.split(",")||[];a.forEach(function(e){if(!C.includes(e)){C.push(e)}});l=C.join(",")}return{sBindingPath:s,aApplicationFilters:o,sSelect:l?"$select="+l:"",sSortParameters:u?u:"",skip:h?h:"$skip=0",top:y?y:"",sExpandParam:g||""}};var w=function(e,t){var a=e.view.getController(),r=a.oCardComponentData&&a.oCardComponentData.mainComponent,n=C.getEntityNavigationParameters(r,a.getModel(),e.cardComponentData,a.getCardPropertiesModel(),a.getEntityType()),i=n&&n.sNavSelectionVariant,o=i&&JSON.parse(i),s=o&&o.SelectOptions||[];return s.filter(function(e){return t.indexOf(e["PropertyName"])>-1})};var F=function(e,t,a,r,n){var i=n.view.getModel(),o=n&&n.entityType,s=o&&o.property;var l,u=[],c,d,v=o&&o.name,g=t&&t.name;var f=i.oMetadata._getEntityTypeByName(v);var m=a&&a.oMetadata._getEntityTypeByName(g);if(!f&&!m){return}else if(f&&!m){u=[f.property]}else if(f&&m){u=[f.property,m.property]}for(var h=0;h<u.length;h++){s=JSON.parse(JSON.stringify(u[h]));for(var y=0;y<s.length;y++){if(s[y].name===e){l=s[y];return l}if("P_"+s[y].name===e||s[y].name==="P_"+e||"$Parameter.P_"+s[y].name===e||s[y].name==="$Parameter.P_"+e){l=s[y];if(l&&p.checkAnalyticalParameterisedEntitySet(i,n.entitySet.name)){c=r.length&&I(e,r)}return c&&c.length?c[0]:l}}}if(p.checkAnalyticalParameterisedEntitySet(i,n.entitySet.name)){d=r.length&&I(e,r);if((!d||!d.length)&&e.includes("/")){var P=e.split("/");d=P.length&&I(P[P.length-1],r)}}if(d&&d.length){return d[0]}return undefined};var x=function(e,t){var a;if(e&&e[t]){return e[t]}else if(e&&e.extensions){a=e.extensions;for(var r=0;r<a.length;r++){if(a[r].name===t){return a[r].value}}}return""};var I=function(e,t){return t.filter(function(t){if(t.name===e||"P_"+t.name===e||t.name==="P_"+e||"$Parameter.P_"+t.name===e||t.name==="$Parameter.P_"+e||t.name==="$Parameter."+e||"$Parameter."+t.name===e){return t}})};var M=function(e){return e["sap:filterable"]?e["sap:filterable"]!=="false":true};var N=function(e,t,a){var r=t.filter(function(t){var a=e.some(function(e){return e===t.name});return M(t)&&a})||[];if(a&&a.length>0){e.forEach(function(e){var t="P_"+e.name;if(a.includes(t)){r.push(e)}})}return r};var E=function(e){var t=[];if(e&&e.extensions){t=e.extensions;for(var a=0;a<t.length;a++){if(t[a].name==="parameter"&&t[a].value==="mandatory"){return e.name}else if(t[a].name==="required-in-filter"&&t[a].value==="true"){return e.name}}}};var R=function(e,t){if(t&&t.length){var a=t.filter(function(t){return t.name===e.name});return a&&a[0]}};var A=function(e,t,a,r,n,o,s){var l=s.cardComponentData.mainComponent.oGlobalFilter,p=s.view.getModel("ovpCardProperties"),u=p&&p.getProperty("/bInsightRTEnabled");var c="";if(e["PropertyName"]&&e["PropertyName"]["PropertyPath"]){var v=e["PropertyName"]["PropertyPath"],g=T.getEntityType(l),f=l&&l.getModel(),m=f&&f.getMetaModel(),h=m&&m.getODataEntityType(g),y=l&&l.getConsiderAnalyticalParameters();var P;if(y){P=a.filter(function(e){return e.name===v})[0]}if(!P){P=F(v,h,f,a,s)}if(e["PropertyValue"]&&e["PropertyValue"]["String"]){v=P&&P.name?P.name:v;var b=E(P);var C=i.getParameterActualValue(v,l);var S=i.IsSemanticDateRangeValid(s,P);if(b&&r.includes(b)){n.push(b);if(!S){t[v]={value:u&&C?C:e["PropertyValue"]["String"],type:i.getPropertyType(P),description:P&&P.description?P.description:null,label:i.getLabelForConfigParams(v,l,t,s,e["PropertyValue"]["String"])}}else{c=i.getDateRangeControlValue(v,s)}t[v]["description"]=c||x(P,"description")}else if(b){o.push(b);var D=new d;var O=i.getLabelForConfigParams(v,l,t,s,e["PropertyValue"]["String"])||[];var V="";if(u&&C){V=i.getRelatedTextToRange({Low:C},O,l,v);D.addSelectOption(v,"I","EQ",C,null,V)}else{V=i.getRelatedTextToRange({Low:e["PropertyValue"]["String"]},O,l,v);D.addSelectOption(v,"I","EQ",e["PropertyValue"]["String"],null,V)}var S=i.IsSemanticDateRangeValid(s,P);if(!S){t[v]={value:D.toJSONString(),type:i.getPropertyType(P),description:P&&P.description?P.description:null};t[v].value=i.enhanceVariant(t[v].value)}else{c=i.getDateRangeControlValue(v,s)}t[v]["description"]=c||x(P,"description")}}}};var _=function(e){return e&&e.filter(function(t,a){return e.indexOf(t)===a})};var k=function(e,t){if(!v.isODataV4(t)){return e.property.map(function(e){return e.name})}else{return Object.keys(e.property)}};var L=function(e){var a={filters:{}};var r=a.filters;var n=e.cardComponentData.mainComponent.oGlobalFilter;var o=n&&n.getModel();var s=T.getEntityType(n);var l=e.view.getModel();var c=e.entityType,v,g=[];var f=[],m=[],h=[],y=[],P,b,C=[];var S=[];var D=o&&o.getMetaModel();var O=D&&D.getODataEntityContainer();var V=D&&D.getODataEntityType(s);var I=O&&O.entitySet&&O.entitySet.filter(function(e){return e.entityType===s});var M=I&&I.length>0?I[0]:{};var L=[];if(o){var j=p.checkAnalyticalParameterisedEntitySet(o,M&&M.name);if(j){var H=u.getParametersByEntitySet(o,M);if(H.entitySetName){L=H.parameters||[]}}}var U=u.getParametersByEntitySet(l,e.entitySet).parameters;i.handleConsiderAnalyticalParameters(e,U);var J=e.view.getModel("ovpCardProperties");var Q=J&&J.getProperty("/bInsightRTEnabled");var $="";U.forEach(function(t){var a="";var s=E(t);var p=i.getParameterDefaultValue(o,M,s,e);var u=i.getParameterDefaultValue(l,e.entitySet,s,e);var c=p||u||t.defaultValue||"";var d=i.getParameterActualValue(t.name,n);$=i.getLabelForConfigParams(t.name,n,r,e,c);var v=i.IsSemanticDateRangeValid(e,t);if(v){var f=d.conditionTypeInfo;var m=f&&f.data&&f.data["operation"];i.setFilterRestrictionToSemanticDateRange(t,true);c=i.getDateRangeDefaultValue(e,t.name)||c;d=i.getDateRangeValueForParameters(d)||d;var y=i.getDateOperationValue(m)||false;if(!y){if(Q&&$&&typeof $==="string"){$=$.substring(0,$.indexOf("(")-1)}else if(c){$=c;i.getLabelForConfigParams(t.name,n,r,e,c,true)}}a=i.getDateRangeControlValue(t.name,e)}if(s){h.push(t.name)}r[t.name]={value:Q&&d?d:c,type:i.getPropertyType(t),description:a||t&&t.description,label:$||""};r[t.name]["description"]=a||x(t,"description");g.push(t.name);C.push(t.name)});L=L.filter(function(e){return!C.includes(e)});if(c&&c.property&&V&&V.property){var B=k(c,l);S=N(B,V.property,L)}for(var q=0;q<S.length;q++){var W="";var K=S[q],X="";var z=R(K,c.property);var G=E(z);var Y=i.getFilterDefaultValue(K.name,V,c)||K.defaultValue||"";var Z=i.getParameterActualValue(K.name,n);if(C.includes(K.name)){$=i.getLabelForConfigParams(K.name,n,r,e,Y);var ee=i.IsSemanticDateRangeValid(e,K);if(ee){i.setFilterRestrictionToSemanticDateRange(K,true);Y=i.getDateRangeDefaultValue(e,K.name)||Y;Z=i.getDateRangeValueForParameters(Z)||Z;if(Q&&$&&typeof $==="string"){$=$.substring(0,$.indexOf("(")-1)}else if(Y){$=Y;i.getLabelForConfigParams(K.name,n,r,e,Y,true)}W=i.getDateRangeControlValue(K.name,e)}r[K.name]={value:Q&&Z?Z:Y,type:i.getPropertyType(K),description:W||K&&K.description,label:$};if(G){h.push(G)}g.push(K.name)}else{P=new d;var te=i.getLabelForConfigParams(K.name,n,r,e,Y);var Z;var ee=i.IsSemanticDateRangeValid(e,K);if(ee){i.setFilterRestrictionToSemanticDateRange(K,false);i.addDateRangeValueToSV(e,K,Y,P,te);W=i.getDateRangeControlValue(K.name,e)}else{if(Q){i.addFiltervalues(n,K.name,P,te)}else if(Y){var ae=i.getRelatedTextToRange({Low:Y},te,n,K.name);P.addSelectOption(K.name,"I","EQ",Y,null,ae)}else{P.addSelectOption(K.name,"I","EQ",X)}}r[K.name]={value:P.toJSONString(),type:i.getPropertyType(K),description:W||K&&K.description};r[K.name].value=i.enhanceVariant(r[K.name].value);if(G){y.push(G)}f.push(K.name)}r[K.name]["description"]=W||x(K,"description")}var re=e.cardComponentData.settings["selectionAnnotationPath"];var ne=e.entityType[re]&&JSON.parse(JSON.stringify(e.entityType[re]));var ie=[],oe;var se;for(var le in ne){if(ne.hasOwnProperty(le)){oe="";var pe=Array.isArray(ne[le])&&ne[le];if(le==="Parameters"){for(var ue=0;pe&&ue<pe.length;ue++){if(pe[ue]["PropertyName"][["PropertyPath"]].includes("/")){var ce=pe[ue]["PropertyName"][["PropertyPath"]].split("/");g.push(ce[ce.length-1])}else{g.push(pe[ue]["PropertyName"][["PropertyPath"]])}oe=pe[ue];A(oe,r,U,C,h,y,e)}}else if(le==="SelectOptions"){ie=ne["SelectOptions"];for(var de=0;pe&&de<pe.length;de++){se=ie[de]["PropertyName"]["PropertyPath"];se=se&&se.replace("/",".");var ve=e.view;var ge=ve.getController();var fe=t.getStaticParams(ge);var me=fe&&fe.sensitiveProperties;if(ie[de].Ranges){if(m.indexOf(se)===-1&&me.indexOf(se)===-1){m.push(se);f.push(se)}}else{f.push(se);oe=pe[de];A(oe,r,U,C,h,y,e)}}b=w(e,m)}}}if(b){b.forEach(function(t){var a=t&&t.PropertyName;var s=i.getLabelForConfigParams(a,n,r,e)||[];var l=t&&t.Ranges||[];l.forEach(function(e){var t=i.getRelatedTextToRange(e,s,n,a);if(t){e.Text=t}});var p={Parameters:[],SelectOptions:[t]};var u=F(a,V,o,U,e);if(u){a=u.name}r[a]={value:JSON.stringify(p),type:i.getPropertyType(u),description:u&&u.description};r[a]["description"]=x(v,"description");var c=E(u);if(c&&C.includes(c)){h.push(c)}else if(c){y.push(c)}})}var he=_(f);var ye=_(g);var Pe=_(h);var be=_(y);i.updateRangeValue(r);r["_relevantODataFilters"]={value:he};r["_relevantODataParameters"]={value:ye};r["_mandatoryODataParameters"]={value:Pe};r["_mandatoryODataFilters"]={value:be};return a};var j=function(e,t,a){var r="";if(t){for(var n=0;n<e.length;n++){r=r+"${"+e[n]+"},"}}if(a){if(t){return"{= extension.formatters.formatValueColor("+r+JSON.stringify(t)+")}"}else if(e.length){return"{= extension.formatters.kpiValueCriticality(${"+e[0]+"})}"}}else{return"{= extension.formatters.formatTrendIcon("+r+JSON.stringify(t)+")}"}};var H=function(e,t,a){var r=e.view.getModel("ovpCardProperties");var n=e.entityType[r.getProperty("/presentationAnnotationPath")];var o=i.getRequestAtLeastFields(n);var s=r.getProperty("/addODataSelect");var l=r.getProperty("/template");if(e){var p,u="";switch(e.cardComponentName){case"Analytical":var c=e.vizFrame;p=c&&c.getParent();u="data";break;case"List":p=e.view.byId("ovpList");u="items";break;case"Table":p=e.view.byId("ovpTable");u="items";break}var d=V(p,u,o,s,l);a["_contentSkipQuery"]={value:d.skip};if(e.cardComponentName==="List"||e.cardComponentName==="Table"){a["_contentTopQuery"]={value:"$top=13"}}else{a["_contentTopQuery"]={value:d.top}}a["_contentSortQuery"]={value:d.sSortParameters};a["_contentSelectQuery"]={value:d.sSelect};a["_contentExpandQuery"]={value:d.sExpandParam}}if(t==="Numeric"){var v=e.view.byId("kpiHBoxNumeric");var g=V(v,"items",o,s,l);a["_headerSkipQuery"]={value:g.skip};a["_headerTopQuery"]={value:g.top};a["_headerSortQuery"]={value:g.sSortParameters};a["_headerSelectQuery"]={value:g.sSelect};a["_headerExpandQuery"]={value:g.sExpandParam}}};var U=function(e,a){var r=e.cardComponentData.settings;var n=e.view;var i=n&&n.getController();var o=i.oCardComponentData&&i.oCardComponentData.mainComponent;var s=C.getEntityNavigationParameters(o,i.getModel(),e.cardComponentData,i.getCardPropertiesModel(),i.getEntityType()).sNavSelectionVariant;s=s?JSON.parse(s):"";var l=s&&s.SelectOptions;var p=r.requireAppAuthorization;var u={},c={},d={},g={};if(p){u=t.getNavigationIntentFromAuthString(p);d=u.parameters}var f=Object.keys(d);if(f.length>0){for(var m=0;m<f.length;m++){if(!Array.isArray(d[f[m]])){c[f[m]]={defaultValue:{value:d[f[m]]}}}}}if(l&&l.length){l.forEach(function(e){var t=e["PropertyName"];var r=a.filters._relevantODataFilters.value.includes(t),n=a.filters._relevantODataParameters.value.includes(e["PropertyName"]);var i;if(e&&t&&!c[t]&&e.Ranges.length&&e.Ranges[0].Option==="EQ"&&!(r||n)){i=e.Ranges[0].Low;if(i!==undefined||i!==null){try{i=JSON.parse(e.Ranges[0].Low)}catch(e){}if(!Array.isArray(i)){c[t]=i}}}})}g={inbounds:{intent:{signature:{additionalParameters:"allowed"}}}};v.updatePropertyValueForObject(g.inbounds.intent,u.semanticObject,"semanticObject");v.updatePropertyValueForObject(g.inbounds.intent,u.action,"action");v.updatePropertyValueForObject(g.inbounds.intent.signature,c&&Object.keys(c).length?c:null,"parameters");return g};var J=function(e,t){if(!e||!t){return}var a=e.getMetaModel();var r=a&&a.getODataEntityContainer();var n=r&&r.entitySet;if(!n||!Array.isArray(n)){return}var i=n.length;for(var o=0;o<i;o++){if(n[o].entityType===t){return n[o].name}}};var Q=function(e,t,a){if(e.startsWith("/sap/opu/odata")&&!e.endsWith(".xml")){return{uri:e,type:"ODataAnnotation"}}else if((!e.startsWith("/sap/opu/odata")||e.startsWith("/sap/opu/odata"))&&e.endsWith(".xml")){if(t&&a["sap.platform.abap"]){var r=a["sap.platform.abap"].uri;if(e.indexOf("./")===0){e=e.replace("./","")}else if(e.indexOf("/")===0){e=e.replace("/","")}else if(e.indexOf("../")===0){e=e.replace("../","")}e=r+"/"+e}return{uri:e,type:"XML"}}};var $=function(e,t){var a=e.cardComponentData.model.sServiceUrl;var r=e.view.getModel();var i;if(!v.isODataV4(r)){i="{{destinations.service}}"+a+"/$batch"}else{i="{{destinations.service}}"+a+"$batch"}var o={};var s=n.getBatchObject(e,t["configuration"]);o["request"]={url:i,method:"POST",headers:{Accept:"multipart/mixed","X-CSRF-Token":"{{csrfTokens.token1}}"},batch:s};if(o.request.batch.header){o.request.batch.header.url="{{parameters._headerDataUrl}}"}o.request.batch.content.url="{{parameters._contentDataUrl}}";if(!s.header){var l=o["request"].batch.content;l.headers["X-CSRF-Token"]="{{csrfTokens.token1}}";if(!v.isODataV4(r)){l.url="{{destinations.service}}"+a+"/"+l.url}else{l.url="{{destinations.service}}"+a+l.url}o["request"]=l}return o};var B=function(e){var t=e.cardComponentData.model.sServiceUrl;var a={};a["parameters"]=L(e)["filters"];a["destinations"]={service:{name:"(default)",defaultUrl:"/"}};a["csrfTokens"]={token1:{data:{request:{url:"{{destinations.service}}"+t,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};return a};var q=function(e,t,i){var o=c.getHeaderDetails(e),s=e.cardComponentData.cardId,l=e.cardComponentData.appComponent.getManifestObject().getRawJson(),p=l["sap.ovp"]["cards"][s].settings,u=e.cardComponentData.settings,d=u&&u.selectedKey,g,f=e.view.getModel();H(e,o,t["configuration"]["parameters"]);var h=t.extension&&o==="Numeric"?c.mainIndicatorDetails(e):"";var y=h&&h.path&&h.path.length?c.mainIndicatorNumberPath(h.path,h.ovpProp):"";r.createKeysFromText(s,p.title,"Title","card Title","header.title");r.createKeysFromText(s,p.subTitle,"Title","card subTitle","header.subTitle");var P=h&&h.valueColor?j(h.valueColor.path,h.valueColor.ovpProp,true):null;var b=h&&h.indicator?j(h.indicator.path,h.indicator.ovpProp,false):null;var C=h&&h.target?h.target:null;var T=h&&h.deviation?h.deviation:null;var S="",D,O="",V,w=[],F={},x={};if(C&&C.parts.length){S=c.targetDeviationValuePath(C,e.view.getModel("ovpCardProperties"),"targetValueFormatter");D=e.view.getModel("ovpCardProperties").getProperty("/bPercentageAvailableForTarget")?"%":null;if(S){v.updatePropertyValueForObject(x,h.target.text,"title");v.updatePropertyValueForObject(x,S,"number");v.updatePropertyValueForObject(x,D,"unit");w.push(x)}}if(h&&h.ovpProp){V=c.mainIndicatorNumberPath(h.path,h.ovpProp,true)}if(T&&T.parts.length){O=c.targetDeviationValuePath(T,e.view.getModel("ovpCardProperties"),"returnPercentageChange");x={};if(O){v.updatePropertyValueForObject(x,h.deviation.text,"title");v.updatePropertyValueForObject(x,O,"number");w.push(x)}}var I=a.getUoMForSubTitle(s);if(o!=="Default"){F={type:o,title:p.title,subTitle:p.subTitle,details:c.generateDetailsExpression(t,p,s,d)};v.updatePropertyValueForObject(F,I,"unitOfMeasurement");v.updatePropertyValueForObject(F,w,"sideIndicators");if(y){F["mainIndicator"]={};v.updatePropertyValueForObject(F.mainIndicator,y,"number");v.updatePropertyValueForObject(F.mainIndicator,P,"state");v.updatePropertyValueForObject(F.mainIndicator,b,"trend");v.updatePropertyValueForObject(F.mainIndicator,V,"unit")}g=F}else{g={type:o,title:p.title,subTitle:p.subTitle,details:c.generateDetailsExpression(t,p,s,d)}}if(i){g.data={path:n.getBatchRequestPath("/header/d/results/0",f)}}if(g.details){g.type="Numeric"}if(t["type"]==="List"||t["type"]==="Table"){g.status=m.getHeaderStatus(i,f)}return g};var W=function(e,t){var r=e.cardComponentData.settings;var n;switch(t["type"]){case"Analytical":n=a.createChartContent(e,r.chartAnnotationPath,t);n.chartProperties["title"]=n.title;delete n.title;break;case"List":n=f.getListContent(e,t);break;case"Table":n=h.getTableContent(e,t);break;default:n={};break}return n};var K=function(e){var t={},a=e.cardComponentData.cardId;t["extension"]=D;t["type"]=e.cardComponentName;t["configuration"]=B(e);t["data"]=$(e,t);t["header"]=q(e,t,t["data"].request.batch);t["content"]=W(e,t);var o=i.getSemanticDateConfiguration(e)||{};if(Object.keys(o).length){t["configuration"]["parameters"]["_semanticDateRangeSetting"]={value:JSON.stringify(o)}}r.replaceStringsWithKeys(t,a);var s=e.view.getModel("ovpCardProperties");var l=s&&s.getProperty("/bInsightDTEnabled");if(l){n.updateBatchObject(e,t["configuration"],true)}return t};var X=function(e){var t=e.cardComponentData.appComponent.getManifest()["sap.app"],a=t.id,n=e.cardComponentData.settings,i=e.cardComponentData.cardId,o=e.cardComponentData.appComponent.getManifestObject().getRawJson(),s=o["sap.app"].i18n&&o["sap.app"].i18n.bundleUrl||o["sap.app"].i18n,l=o["sap.platform.abap"]&&o["sap.platform.abap"].uri,p=n&&n.selectedKey,u=e.view.getModel("ovpCardProperties"),c=u&&u.getProperty("/bInsightRTEnabled"),d=u&&u.getProperty("/bInsightDTEnabled");var v=o["sap.fiori"]&&o["sap.fiori"].registrationIds&&o["sap.fiori"].registrationIds[0]||a,g=p?v+".cards."+i+".tab_"+p:v+".cards."+i;var f=p?"../../../":"../../";O=f+s;if(l){if(l.startsWith("/")){l=l.substring(1)}s=l+"/"+s}if(c){g="user."+g+"."+Date.now()}var m;if(c){m={title:t&&t.title||"",subtitle:t&&(t.subtitle||t.description)||""}}else{m=r.getKeysForAppProperties(t,o,e)}var h=m&&m.title,y=m&&m.subtitle,P=L(e),b={id:g,type:"card",embeddedBy:f,tags:{keywords:["Analytical","Card","Line","Sample"]},crossNavigation:U(e,P),dataSources:{}};if(d){b.i18n=f+s}if(h){b.title=h}if(y){b.subTitle=y}var C=e.cardComponentData.appComponent.getManifest()["sap.ovp"];var T=C.globalFilterModel;var S=e.cardComponentData.appComponent.getManifest()["sap.ui5"].models[T].dataSource;var D=t.dataSources;var V=D[S];var w={},F=[],x="",I;if(V&&V.settings){var M=V.settings.annotations,N;M.length&&M.forEach(function(e){for(var t in D){N=D[e].uri;if(t===e&&N){F.push(t);w[t]=Q(N,c,o);break}}});if(V&&V.uri){I=Q(V.uri,c,o)}x=V.settings&&V.settings["odataVersion"]}b.dataSources=w;b.dataSources["filterService"]={uri:V&&V.uri,settings:{annotations:F,odataVersion:x?x:"2.0"},type:I&&I.type};return b};var z=function(e){var t=e.cardComponentData.appComponent.getManifest()["sap.app"],a=t.id,r=e.cardComponentData.appComponent.getManifest()["sap.ovp"],n=e.view.getModel("ovpCardProperties"),i=n&&n.getProperty("/bInsightRTEnabled"),o="",s=e.cardComponentData.mainComponent.oGlobalFilter,l=T.getEntityType(s),p=e.cardComponentData.mainComponent.getOwnerComponent(),u=p.oOvpConfig.sapUICoreVersionInfo||{};if(!r.globalFilterEntitySet){o=J(s&&s.getModel(),l)}return{templateName:"OVP",parentAppId:a,filterEntitySet:r.globalFilterEntitySet?r.globalFilterEntitySet:o,cardType:i?"RT":"DT",versions:{ui5:u.version+"-"+u.buildTimestamp}}};var G=function(e){var t={};t["sap.card"]=K(e);t["sap.app"]=X(e);t["sap.insights"]=z(e);var a=b.getCardActions(e,t["sap.card"]);return a.then(function(a){if(a.header.enabled){t["sap.card"].header.actions=a.header.actions}if(a.content.enabled){switch(e.cardComponentName){case"Analytical":t["sap.card"].content.actions=a.content.actions;break;case"List":t["sap.card"].content.item.actions=a.content.actions;break;case"Table":t["sap.card"].content.row.actions=a.content.actions;break}}i.resetSemanticDateRangeConfig();return t})};var Y=function(e,t,a){var r=e["sap.card"]["header"][a];if(r&&r.startsWith("{{")){var n=r.split("{{")[1].split("}}")[0];var i=t.view.getModel("@i18n")||t.view.getModel("i18n");r=i?i.getProperty(n):undefined}return r?r:""};var Z=function(e,t,a,r){r.valueState=t;r.valueStateText=a;e.setValueState(r.valueState);e.setValueStateText(r.valueStateText)};var ee={createManifestFor:G,downloadCardManifest:function(e){},createCard:function(e){var t=G(e);var a=window.location.origin,r=a+"/resources",n=this;return t.then(function(e){return new Promise(function(t,a){try{if(!n.integrationLib){n.integrationLib=g.loadLibrary("sap.ui.integration",{async:true})}return n.integrationLib.then(function(){sap.ui.require(["sap/ui/integration/widgets/Card"],function(a){var n=new a({height:"533px",width:"314px",manifest:e,baseUrl:r});t(n)})}).catch(function(e){S.error("Failed to get sap.ui.integration"+e);a(e)})}catch(e){S.error("Failed to get sap.ui.integration"+e);a(e)}})})},UpdateManifestDeltaChanges:function(e,t,a,i){var o={_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}};e["sap.ui5"]=o;n.enhanceHeaderAndContentURLForSemanticDate(e["sap.card"]);n.enhanceHeaderAndContentURL(e["sap.card"]);var s=t.view.getModel("ovpCardProperties");var l=s&&s.getProperty("/bInsightRTEnabled");var p=s&&s.getProperty("/bInsightDTEnabled");if(p){if(e["sap.app"]["i18n"]!==O){e["sap.app"]["i18n"]=O}var u=Y(e,t,"title");var c=Y(e,t,"subTitle");var d=g.byId(a+"--titleTextInput");if(d&&d.getValue()){var f=g.byId(a+"--subTitleTextInput");var m=t.cardComponentData.cardId;if(this.titleChanged&&d.getValue()!==u){r.createKeysFromText(m,d.getValue(),"Title","card Title","header.title");this.titleChanged=false}var h=f.getValue();var y=f&&h&&this.subTitleChanged&&h!==c;if(y){r.createKeysFromText(m,h,"Title","card subTitle","header.subTitle");this.subTitleChanged=false}else if(f&&!h){this.subTitleChanged=false;delete e["sap.card"].header.subTitle}}r.inserti18nKeysManifest(e["sap.card"]);r.writei18nPayload();n.updateBatchObject(t,e["sap.card"]["configuration"],false);if(i==="Download"){this.downloadCardManifest(e)}r.reseti18nProperties()}else if(l){var P=t.view.getModel("@i18n")||t.view.getModel("i18n");if(e["sap.card"].type==="Analytical"){e["sap.card"]["content"].chartProperties.title.text=r.getI18nValueOrDefaultString(e["sap.card"]["content"].chartProperties.title.text,P)}else if(e["sap.card"].type==="Table"){var C=e["sap.card"].content.row.columns;if(Array.isArray(C)&&C.length){C.forEach(function(e,t){C[t].title=r.getI18nValueOrDefaultString(e.title,P)})}}else if(e["sap.card"].type==="List"){var T=e["sap.card"]["content"];var S=(((T||{}).item||{}).info||{}).value;var D=S&&S.split(",").slice(-1);var V=D&&D[0]&&D[0].split("/")[1];var w=e["sap.card"].configuration.parameters;var F=w[V]&&w[V].value;if(F&&F.startsWith("{{")){w[V].value=P.getProperty(V)}}r.fnReplacei18nKeysWithText(e,P);var x=b.checkCustomNavigationForCard(t);if(x){return v.getCurrentAppIntent().then(function(a){var r=e["sap.card"].configuration.parameters;var n=b.getOVPDefaultActions(a);if(t.cardComponentName==="Analytical"){if(r.state){r.state.value=n}}else{if(r.headerState){r.headerState.value=n}if(r.lineItemState){r.lineItemState.value=n}}return Promise.resolve(e)})}}return Promise.resolve(e)},showCard:function(e){var t=e.view.getModel("ovpCardProperties"),a=t&&t.getProperty("/bInsightRTEnabled"),n=t&&t.getProperty("/bInsightDTEnabled"),i=b.checkCustomNavigationForCard(e),p;if(i){p={type:"Warning",text:o.getText("CARD_MESSAGE_INFO")}}if(a){var u=G(e);return u.then(function(t){return this.UpdateManifestDeltaChanges(t,e).then(function(){return y.getServiceAsync("UIService").then(function(e){return e.showCardPreview(t,false,p).then(function(){return Promise.resolve(t)})}).catch(function(e){P.show(e.message)})})}.bind(this)).catch(function(e){S.error(e);return Promise.reject(e)})}else if(n){return this.createCard(e).then(function(t){var a=t.getManifest();return new Promise(function(n,i){var p=o.oResourceModel,u=Y(a,e,"title"),c=Y(a,e,"subTitle"),d={draggable:true,cardTitle:u,cardSubTitle:c,valueState:u?"None":"Error",valueStateText:u?"":o.getText("INT_Preview_Title_ValueStateText")},f=new l({dialogSettings:d}),m=v.getApp().getOwnerComponent(),h=m.createId("integrationCardPreview");this.handleCancel=function(){this.previewDialogPromise.then(function(e){e.close();r.reseti18nProperties();e.destroy();this.titleChanged=false;this.subTitleChanged=false}.bind(this))};this.handleTitleLiveChange=function(e){var a=e.getSource();var r=a.getValue();this.previewDialogPromise.then(function(){if(r&&t.getCardHeader().getTitle()!==r){Z(a,"None","",d);t.getCardHeader().setTitle(r);this.titleChanged=true}else if(!r){this.titleChanged=true;Z(a,"Error",o.getText("INT_Preview_Title_ValueStateText"),d)}else{Z(a,"None","",d)}}.bind(this))};this.handleSubTitleLiveChange=function(e){var a=e.getSource();var r=a.getValue();this.previewDialogPromise.then(function(){if(t.getCardHeader().getSubtitle()!==r){t.getCardHeader().setSubtitle(r);this.subTitleChanged=true}}.bind(this))};this.confirmActionHandler=function(){var t=g.byId(h+"--titleTextInput");var r=t&&t.getValue()&&t.getValue().trim();if(r.length===0){Z(t,"Error",o.getText("INT_Preview_Title_ValueStateText"),d);t.focus()}else{this.previewDialogPromise.then(function(t){this.UpdateManifestDeltaChanges(a,e,h,"Create").then(function(){t.close();t.destroy();n(a)}).catch(function(e){P.show(e.message)})}.bind(this))}};this.downloadCardManifestHandler=function(){this.previewDialogPromise.then(function(t){this.UpdateManifestDeltaChanges(a,e,h,"Download").then(function(){t.close();t.destroy();n(a)}).catch(function(e){P.show(e.message)})}.bind(this))};this.previewDialogPromise=s.load({id:h,type:"XML",name:"sap.ovp.insights.Preview",controller:this}).then(function(a){a.setModel(f);a.setModel(e.view.getModel("i18n"),"i18n");a.setModel(p,"ovpResourceModel");var r=g.byId(h+"--subFlexBoxNew");r.addItem(t);this.titleChanged=false;this.subTitleChanged=false;if(e.cardComponentName!=="Analytical"){g.byId(h+"--ovpIntPreviewOverflowLayer").setVisible(true)}a.open();return a}.bind(this)).catch(function(e){S.error("Integration card preview fragment failed to load, "+e)})}.bind(this))}.bind(this)).catch(function(e){S.error(e);return Promise.reject(e)})}},getFilterDetails:L};return ee},true);
//# sourceMappingURL=IntegrationCard.js.map