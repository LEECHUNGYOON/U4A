sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/base/util/extend","sap/suite/ui/generic/template/ObjectPage/controller/inlineCreationRows/RequiredPropHelper"],function(e,t,n,i){"use strict";function a(e,n,a,r,o){var s="@$ui5.context.isTransient",l="@$ui5.context.isInactive",c={INLINE_CREATION_ROWS:"creationRows",INLINE_CREATION_ROWS_HIDDEN_IN_EDIT_MODE:"creationRowsHiddenInEditMode"};var u={creationRows:new Set,creationRowsHiddenInEditMode:new Set};var f={creationRows:"/editable",creationRowsHiddenInEditMode:"/createMode"};var d=new Set,g=new Map,v=new Set,I=new Map,R=new Set,h=new Map;function b(){u.creationRows.clear();u.creationRowsHiddenInEditMode.clear();Array.from(h.values()).forEach(function(e){e.onBeforeRebindObjectPage()})}function C(e){var t=e.data("isCreationAllowedByBoolAndPathRestrictions");return["true",true].includes(t)}function p(e){return e.getAllCurrentContexts().some(function(e){return e.isInactive()&&!R.has(e.getPath())})}function E(e){return n.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(e)}function w(t){var a=t.getId(),s=h.get(a);if(!s){s=new i(n,t,E(t),r,e,o);h.set(a,s)}return s}function P(e){if(!n.oComponentUtils.isDraftEnabled()){return}var i=e.getSource();var r=i.getTable();if(t.isAnalyticalTable(r)||t.isTreeTable(r)){return}var o=a(i);var s=[c.INLINE_CREATION_ROWS,c.INLINE_CREATION_ROWS_HIDDEN_IN_EDIT_MODE].includes(o);if(!s){return}i.addEventDelegate({oninput:function(){m(i)}});var l=e.getParameters().bindingParams;var u=l.events.dataReceived||Function.prototype;l.events.dataReceived=function(e){u.call(this,e);var t=E(i),n=t.getBinding();if(p(n)){var a=e.getParameter("reason")==="SIDE_EFFECT_TARGET";if(a){W(i)}else{M(i.getTable());B(i,n);T(i);return}}_(i);D(i)}}function T(e){var t=e.getId();if(h.has(t)){h.get(t).onTableDataReceived()}}function m(e){var n=t.getControlWithFocus();var i=function(t){var n=t.getPath&&t.getPath();if(n&&!R.has(n)){N(e,true);R.add(n)}};var a=function(e){var t=e.getBindingContext&&e.getBindingContext();return t.isTransient&&t.isTransient()?t:false};while(n){var r=a(n);if(r&&(t.isSmartField(n)||t.isColumnListItem(n)||t.isRow(n))){i(r);break}else if(t.isSmartTable(n)){break}n=n.getParent()}}function _(t){var n=e.getModel("ui"),i=a(t),r=f[i],o=t.getId();if(u[i].has(o)){return}u[i].add(o);if(n.getProperty(r)){N(t)}if(!v.has(r)){n.bindProperty(r).attachChange(A.bind(null,i));v.add(r)}}function A(e,t){if(t.getSource().getValue()){var n=u[e];n.forEach(function(e){var t=sap.ui.getCore().byId(e);N(t)})}}function D(t){var n=e.getBindingContext(),i=t.getId();if(I.get(i)===n){return}var a=t.data("inlineCreationRowsConfig"),r=a.creatablePath,o=r.creatable;if(typeof o==="boolean"){return}e.getModel().bindProperty(o,n).attachChange(function(e){var n=!!e.getSource().getValue();n=r.negate?!n:n;if(n){_(t)}else{W(t)}});I.set(i,n)}function N(e,t){var n=E(e);var i=n.getBinding();var a={itemsBinding:i,isLengthFinal:n.isLengthFinal(),isResponsiveTable:n.isMTable()};return new Promise(function(n){y(e).then(function(r){if(t){O(i,r,true);M(e.getTable())}else{S(e,r,a)}n()})})}function S(e,t,n){var i=e.getTable();var r=a(e);var o=n.isResponsiveTable;var s=n.itemsBinding;var l=n.isLengthFinal;var c=C(e);var f=p(s);if(l&&s.isResolved()&&c&&!f){O(s,t,!o);u[r].delete(e.getId());var d=M.bind(null,i);j(i,d);B(e,s)}}function B(e,i){if(d.has(i)){return}d.add(i);i.attachCreateActivate(function(i){var a=i.getParameter("context");var r=e.getTable();if(t.isMTable(r)){var o=r.getItems();var s=o.find(function(e){return e.getBindingContext()===a});var l=s.getCells();for(var c=0;c<l.length;c++){l[c].setEditable&&l[c].setEditable(true)}}if(a&&!R.has(a.getPath&&a.getPath())){N(e,true);R.add(a.getPath())}var u=w(e);var f=u.handleActivateRow(a);if(!f){i.preventDefault();return}var d=e.getBindingContext(),g=e.getTableBindingPath();n.oServices.oApplicationController.executeSideEffects(d,[],[g])})}function O(e,t,n){e.create(t,n,{inactive:true,changeSetId:"Create"})}function y(e){return new Promise(function(t){var i=n.oServices.oCRUDManager.getDefaultValues(e,null,true);if(i instanceof Promise){i.then(function(e){var n=e[0];t(n)}).catch(function(){t(null)})}else{t(null)}})}function M(e){if(t.isMTable(e)){x(e)}}function x(e){var t,n=e.getId(),i=F(e);if(!i.oInActiveRow){return}H(e,i.oInActiveRow);if(g.get(n)){t=g.get(n)}else{t=i.oInActiveRow.getProperty("type");g.set(n,t)}j(i.oInActiveRow,L.bind(null,i.oInActiveRow,t))}function F(e){var t=[],n;e.getItems().forEach(function(e){var i=e.getBindingContext();var a=e.getBinding("type")&&e.getBinding("type").getPath();if(i.isInactive()&&a!==l){n=e}else if(i.isTransient()&&a!==s){t.push(e)}});return{aTransientRows:t,oInActiveRow:n}}function H(e,t){var n=e.getParent();var i=e.getColumns();var a=n.data("inlineCreationRowsConfig").nonInsertableProperties;var r=[];if(a&&a.length>0){for(var o=0;o<t.getCells().length;o++){for(var s=0;s<a.length;s++){if(a[s].PropertyPath===i[o].data("p13nData").leadingProperty){r.push(o)}}}var l=t.getCells();for(var s=0;s<r.length;s++){l[r[s]].setEditable&&l[r[s]].setEditable(false)}}}function L(e,t){var i=e.getDeleteControl();e.bindProperty("type",{path:l,formatter:function(e){return e?"Inactive":t}});i&&i.bindProperty("visible",{path:l,formatter:function(e){return!e}});var a=e.getBindingContext().created();a&&a.then(function(){e.isSelected()&&n.oCommonUtils.setEnabledToolbarButtons(e)})}function W(e){var t=E(e),n=t.getBinding();if(n.isResolved()&&n.isLengthFinal()){n.getAllCurrentContexts().forEach(function(e){if(e.isInactive()&&!R.has(e.getPath())){e.delete()}})}}function j(e,t){var n;if(e.getDomRef()){t()}else{n=e.addEventDelegate({onAfterRendering:function(){t();e.removeEventDelegate(n)}})}}function U(e){var t=E(e),n=a(e);if(n===c.INLINE_CREATION_ROWS){t.focusOnFirstTransientRow()}else if(n===c.INLINE_CREATION_ROWS_HIDDEN_IN_EDIT_MODE){if(!p(t.getBinding())){N(e)}else{t.focusOnFirstTransientRow()}}}return{onBeforeRebindObjectPage:b,addCreationRows:N,addCreationRowsImpl:S,onBeforeRebindControl:P,handleAddEntry:U}}return e.extend("sap.suite.ui.generic.template.ObjectPage.controller.inlineCreationRows.InlineCreationRowsHelper",{constructor:function(e,t,i,r,o){n(this,a(e,t,i,r,o))}})});
//# sourceMappingURL=InlineCreationRowsHelper.js.map