sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/ui/model/Sorter","sap/ui/core/library","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/genericUtilities/controlHelper"],function(e,r,t,n,a,o){"use strict";var i=n.MessageType;function s(e,r,n){var s=Function.prototype;var l;var u;var g;function f(){l=Object.create(null);if(u){for(var e in u){var r=u[e];r.destroy()}}u=Object.create(null)}function c(e,t){var n=Object.create(null);var a=function(e,r,t){if(t){n[t.getId()]=r}};t.controlId=r.oCommonUtils.getPositionableControlId(e,true,a);var i=[];var s,l;var u;for(var g=t.controlId&&o.byId(t.controlId);g;g=n[u]){u=g.getId();i.push(u);s=s||o.isObjectPageSection(g)&&g;l=l||o.isSmartTable(g)&&g}i.reverse();t.pathToControlId=i;t.groupers=s?[s]:[];if(s&&l){t.groupers.push(l);if(t.message.validation){t.getItemBindingPath=Function.prototype}else{var f=v(l);if(f){var c=r.oComponentUtils.getBindingPath();var d=f.presentationControlHandler.getBindingPath();var I=c+"/"+d;t.getItemBindingPath=function(){var e=t.message.aFullTargets.find(function(e){return e.startsWith(I)});if(!e){return null}var r=e.substring(I.length);var n=r.split("/")[0];return I+n}}else{t.getItemBindingPath=Function.prototype}}}else{t.getItemBindingPath=Function.prototype}}function d(e,r){var t=l[e];if(t){r=t.message;var n=t.controlId&&t.controlIds[t.controlId];r.controlIds.some(function(e){if(e===t.controlId){n=false}else if(!t.controlIds[e]){n=true;return true}});t=!n&&t}if(!t){r=r||a.getMessageById(e);var i=Object.create(null);r.controlIds.forEach(function(e){i[e]=o.byId(e)});t={message:r,controlIds:i};c(r.controlIds,t);l[e]=t}return t}function v(e){var r=e.getId();var t=u[r];if(!t){t=C(e);u[r]=t}return t}function I(e,r){var t=e.getTitleInfoForItem(r);return t&&t.title}function m(e,r){return r&&{label:e.presentationControlHandler.getColumnLabel(r),hidden:!r.getVisible()}}function p(e,r){var t=e.table.getTable().getColumns();var n=t.find(function(e){var t=e.getLeadingProperty?e.getLeadingProperty():e.data("p13nData").leadingProperty;return t===r});return m(e,n)}function h(e,r){var t=e.columnInfo;if(t){var n=t[r];if(n){return n}}else{t=Object.create(null);e.columnInfo=t}var a=p(e,r);t[r]=a;return a}function b(e,r){var t=e.getItemBindingPath();var n=e.message.aFullTargets.find(function(e){return e.startsWith(t)});if(!n){return}var a=n.substring(t.length);if(a.startsWith("/")){a=a.substring(1)}if(!a||a.indexOf("(")>0){return}return h(r,a)}function T(e,r,t){var n=r&&r.getMessages();if(n&&n.length){var a=I(e.presentationControlHandler,r);n.forEach(function(r){var n=d(r.id,r);if(!n.controlId){c([e.table.getId()],n)}if(n.groupers[1]===e.table){var o={index:t<0?9999999:t,rowCurrentlyShown:t>=0,rowIdentifier:a,columnInfo:b(n,e)};e.messageToMsgInTableInfo[r.id]=o}})}}function C(e){var t=r.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(e);var n=t.getBinding();if(!n){return null}var i=false;var l={table:e,presentationControlHandler:t,messageToMsgInTableInfo:Object.create(null)};var u=function(){if(i){return}var r=l.messageToMsgInTableInfo;l.messageToMsgInTableInfo=Object.create(null);if(!o.isTreeTable(e.getTable())){var n=T.bind(null,l);var u=t.getCurrentContexts()||[];u.forEach(n)}for(var g in r){if(!l.messageToMsgInTableInfo[g]){var f=r[g];var c=a.getMessageById(g);f.rowCurrentlyShown=c&&c.validation;l.messageToMsgInTableInfo[g]=f}}s()};l.tableLoaded=t.getUnbusyPromise().then(u);n.attachChange(u);e.attachUiStateChange(f);l.destroy=function(){i=true;n.detachChange(u);e.detachUiStateChange(f)};return l}function y(e){var t=d(e);var n=t.groupers;switch(n.length){case 0:return r.oCommonUtils.getText("GENERIC_MESSAGE_GROUP_NAME");case 1:return n[0].getTitle();default:var a=n[0].getTitle();var o=n[1];var i=o.getHeader();return r.oCommonUtils.getText("MESSAGE_GROUP_TABLE",[a,i])}}function P(e){switch(e){case i.Error:return 1;case i.Warning:return 2;case i.Success:return 3;case i.Information:return 4;case i.None:return 5;default:return 6}}function M(e,r,t){if(!r){return t?1:0}if(!t){return-1}return o.sortChildControls(e,r,t)}function O(e,r){var t=d(e.id);var a=d(r.id);var i=t.groupers.length===a.groupers.length&&t.groupers.every(function(e,r){return a.groupers[r]===e});if(i){var s=t.getItemBindingPath();var l=a.getItemBindingPath();if(s!==l){var u=t.groupers[1];var g=v(u);var f=g&&g.messageToMsgInTableInfo[e.id];var c=g&&g.messageToMsgInTableInfo[r.id];if(f&&c){if(f.index!==c.index){return f.index-c.index}}else if(f||c){return 1-2*!c}return(""+s).localeCompare(""+l)}var I=P(e.type)-P(r.type);if(I||!(t.controlId||a.controlId)){return I||e.message.localeCompare(r.message)}}if(!i&&(t.groupers.length===1||a.groupers.length===1)&&t.groupers[0]===a.groupers[0]){return t.groupers.length-a.groupers.length}var m=t.pathToControlId;var p=a.pathToControlId;var h=Math.max(m.length,p.length);for(var b=0;b<h;b++){if(m[b]!==p[b]){var T=b===0?n:o.byId(m[b-1]);return M(T,b<m.length&&o.byId(m[b]),b<p.length&&o.byId(p[b]))}}return e.message.localeCompare(r.message)}function S(e,r,t){e.read(r,{headers:{"sap-messages":"transientOnly"},canonicalRequest:false,error:t.bind(null,null),updateAggregatedMessages:false,success:function(n){var a=n&&e._getKey(n);var o=a?e.getContext("/"+a,r):null;t(o)}})}function w(e,r,t){return new Promise(function(a){var o=n.getModel();S(o,e,function(e){if(e){T(r,e,-1)}else{t.forEach(function(e){var r=d(e);var t=r.groupers[1];var n=t&&v(t);if(!n||n.messageToMsgInTableInfo[e]){return}n.messageToMsgInTableInfo[e]={index:9999999,rowCurrentlyShown:false,rowIdentifier:"",columnInfo:b(r,n)}})}a()})})}function x(e,t,n){var a=false;e.aFullTargets.some(function(o){if(o.startsWith(n)){r.oInfoObjectHandler.executeForAllInformationObjects("smartTable",function(r){if(!a){var i=n+r.getNavigationProperty();if(o===i||o.startsWith(i+"(")){a=true;var s=r.getId();var l=t[s];if(l){l.messages.push(e)}else{var u=[e];l={messages:u,promise:r.getControlAsync().then(function(e){var r=v(e);return r&&r.tableLoaded.then(function(){u.forEach(function(e){var r=d(e.id,e);if(!r.controlId){c([s],r)}})})})};t[s]=l}}}},true)}return a})}function E(e,r,n,a){f();var o=Object.create(null);r.forEach(function(e){var r=e.id;d(r,e);if(e.controlIds.length===0){x(e,o,a+"/")}});var i=[];for(var l in o){i.push(o[l].promise)}var u=function(){if(g){clearTimeout(g);g=0}var a=Object.create(null);var o=Object.create(null);var i=Object.create(null);var s;r.forEach(function(e){var r=d(e.id,e);if(r.groupers.length===0){s=s||function(){g=g||setTimeout(u);n.setProperty("/messageToUpdateFunction",null)};i[e.id]=s}a[e.id]=y(e.id);o[e.id]=F(e.id,e.additionalText)});n.setProperty("/messageToGroupName",a);n.setProperty("/messageToSubtitle",o);n.setProperty("/messageToUpdateFunction",i);var l=new t("");l.fnCompare=O;e.sort(l)};return Promise.all(i).then(function(){return B().then(function(){u();s=function(){var e=n.getProperty("/heartBeat")||0;e++;n.setProperty("/heartBeat",e)};return{getSubtitle:F}})})}function B(){var e=[];for(var r in u){var t=u[r];if(t){e.push(t.tableLoaded)}}return Promise.all(e).then(U)}function j(e,r){var t=o.byId(e.controlIds[0]);var n=t.getBindingContext();var a=r.presentationControlHandler.getCurrentContexts()||[];var i=-1;a.some(function(e,r){if(e===n){i=r;return true}});var s=r.presentationControlHandler.getColumnForCell(t);var l={index:i,rowCurrentlyShown:true,rowIdentifier:I(r.presentationControlHandler,n),columnInfo:m(r,s)};r.messageToMsgInTableInfo[e.id]=l;return l}function U(){var e=[];var r=Object.create(null);var t=function(t){var n=d(t);var a=n.groupers[1];var i=a&&!o.isTreeTable(a.getTable())&&v(a);if(i){var s=n.message;var l=i.messageToMsgInTableInfo[t];if(!(l&&l.rowCurrentlyShown)){if(s.validation){j(s,i)}else{var u=n.getItemBindingPath();if(u){var g=r[u];if(g){g.push(t)}else{g=[t];r[u]=g;var f=w(u,i,g);e.push(f)}}}}}};for(var n in l){t(n)}return Promise.all(e)}function H(e){var t="MSG_SUBTITLE_ROW";var n=[e.rowIdentifier];if(!e.rowCurrentlyShown){t+="_HIDDEN"}if(e.columnInfo){n.push(e.columnInfo.label);t+="_COLUMN";if(e.columnInfo.hidden){t+="_HIDDEN"}}return r.oCommonUtils.getText(t,n)}function F(e,r){var t=d(e);var n=t.groupers[1];if(!n){return r}var a=v(n);if(a){var o=a.messageToMsgInTableInfo[e];if(!o&&t.message.validation){o=j(t.message,a)}if(o&&o.rowIdentifier){return H(o)}}return r}return{getPrepareMessageDisplayPromise:E}}return e.extend("sap.suite.ui.generic.template.ObjectPage.controller.MessageSortingHandler",{constructor:function(e,t,n){r(this,s(e,t,n))}})});
//# sourceMappingURL=MessageSortingHandler.js.map