sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/fe/navigation/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(e,t,r,n,a,i,o,s,l,u,p,c){"use strict";var f=new o("lib.multipleViews.MultipleViewsHandler").getLogger();function g(e,o,g){var m=Object.create(null);var d=o.oComponentUtils.getTemplatePrivateModel();var v=g.pathInTemplatePrivateModel+"/items";var S=g.pathInTemplatePrivateModel+"/selectedKey";d.setProperty(g.pathInTemplatePrivateModel,Object.create(null));d.setProperty(v,Object.create(null));var y=new(g.mode==="single"?n:r)(e,o,g);d.setProperty(g.pathInTemplatePrivateModel+"/mode",y.getMode());var h;var C=new Promise(function(e){h=e});var b=o.oServices.oApplication.getBusyHelper().getBusyDelay();var P=e.getOwnerComponent().getModel();var O;var T;var E=[];var F;function M(){if(T){var e=g.getSearchValue&&g.getSearchValue();var t=e?{search:e}:{};var r;var n=g.presentationControlHandler||g.getPresentationControlHandler();if(g.mode==="single"&&n&&n.getBinding()){r=n.getBinding().sRefreshGroupId}for(var a in m){var i=m[a];var o=i.getPath();i.numberOfUpdates++;i.updateStartFunction(i.numberOfUpdates);P.read(o+"/$count",{urlParameters:t,filters:i.getFiltersForCount&&i.getFiltersForCount(),groupId:r,success:i.updateSuccessFunction.bind(null,i.numberOfUpdates),error:i.errorFunction.bind(null,i.numberOfUpdates)})}}}function w(e,t){var r="";var n=t["parameters"];if(!t||!t.entitySetName||!t.navPropertyName||n.length<1){r="/"+e.name;return r}var i=g.smartFilterBar&&g.smartFilterBar.getAnalyticalParameters();if(i&&i.length>0){var o=g.smartFilterBar&&g.smartFilterBar.getUiState({allFilters:false});var s=o?JSON.stringify(o.getSelectionVariant()):"{}";var l=new a(s);var c=[];n.forEach(function(e){i.forEach(function(t){if(t&&t.name===e){var r=t.name;var n=l.getParameter(r);if(t.type==="Edm.DateTime"||t.type==="Edm.DateTimeOffset"){n=new Date(n);n=p.localToUtc(n)}else if(t.type==="Edm.String"&&t["sap:parameter"]==="optional"){if(n===undefined){n=""}}n=u(t.control.getModel().formatValue(n,t.type));c.push(r+"="+n)}})});r="/"+t.entitySetName+"("+c.join(",")+")/"+t.navPropertyName}else{r="/"+e.name;f.error("SelectionParameters","There are no parameters to resolve");return r}return r}function B(t){var r;var n=t.getEntitySet();var a=e.getOwnerComponent();if(g.smartFilterBar&&g.smartFilterBar.getConsiderAnalyticalParameters&&g.smartFilterBar.getConsiderAnalyticalParameters()){var o=P.getMetaModel();var s=o.getODataEntitySet(n);var l=a.getAppComponent();var u=i.getParametersByEntitySet(l.getModel(),n);r=g.resolveParameterizedEntitySet?g.resolveParameterizedEntitySet(s,u):w(s,u);return r}var p=t.getBindingPath();r=p?p:"/"+n;var c=a.getComponentContainer();var f=c.getElementBinding();return f?f.getPath()+"/"+r:r}function I(e,r){var n=P.getMetaModel();var a=n.getODataEntityType(n.getODataEntitySet(e.getEntitySet()).entityType);var i=[],o;var s=r.variantAnnotationPath;if(s){var l=a[s];if(!l){return[]}if(!l.SelectOptions&&l.SelectionVariant){l=l.SelectionVariant;if(l.Path){s=l.Path.split("@")[1];l=s&&a[s]}}if(l.AnnotationPath){o=l.AnnotationPath.split("@")[1];l=a[o]}for(var u in l.SelectOptions){if(l.SelectOptions[u].PropertyName){var p=l.SelectOptions[u].PropertyName.PropertyPath;for(var c in l.SelectOptions[u].Ranges){var f=l.SelectOptions[u].Ranges[c].Sign&&l.SelectOptions[u].Ranges[c].Sign.EnumMember;var g=l.SelectOptions[u].Ranges[c].Option&&l.SelectOptions[u].Ranges[c].Option.EnumMember;g=f?U(f.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","")):g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var m=l.SelectOptions[u].Ranges[c].Low;var d=l.SelectOptions[u].Ranges[c].High;var v=R(m);if(d){var S=R(d);i.push(new t(p,g,v,S))}else{i.push(new t(p,g,v))}}}}}return i}function U(e,t){var r;var n=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(e==="I"){r=t}else if(e==="E"){if(n.has(t)){r=n.get(t)}else{r=t}}return r}function R(e){var t;if(e){if(e.String){t=e.String}else if(e.Bool){t=e.Bool.toLowerCase()==="true"}else{var r=Object.keys(e)[0];t=e[r]}}return t}function V(e){for(var t in m){var r=m[t];if(r.presentationControlHandler.getEntitySet()===e){return t}}return""}function H(e){return!!V(e)}function A(e){return e&&D().presentationControlHandler.getEntitySet()!==e&&V(e)||F}function N(e,t){var r=e.filters.slice(0);var n=D();e.filters=x(e.filters,n,t,false);if(T){for(var a in m){var i=m[a];K(r,i,t)}}}function K(e,t,r){t.getFiltersForCount=function(){return x(e,t,r,true)}}function x(e,t,r,n){if(y.getFiltersAdaptedFromItem){e=y.getFiltersAdaptedFromItem(e,t,r,n)}return e.concat(t.selectionVariantFilters)}function D(){return m[F]}function L(e,t){return y.formatMessageStrip(e,t)}function j(){return F}function G(){return y.getMode()}function z(e){if(!e){e=O}F=e;d.setProperty(S,F)}function W(){return y.getContentForIappState(F)}function _(e){var t;if(!e){return""}if(e.state==="error"){return o.oCommonUtils.getText("SEG_BUTTON_ERROR",e.text)}if(e.state===""||e.state==="busy"){var r=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});t=r.format(e.count)}return o.oCommonUtils.getText("SEG_BUTTON_TEXT",[e.text,e.state==="busyLong"?"...":t])}function k(e){F=y.getSelectedKeyAndRestoreFromIappState(e);if(m[F]){d.setProperty(S,F)}}var q={getState:j,setState:z,attachStateChanged:ne};function Q(){return y.getSFBVariantContentStateWrapper(q)}function J(){return y.getGeneralContentStateWrapper(q)}function X(){return m[F].templateSortOrder}function $(e){var t=D();if(e!==2){t.presentationControlHandler.rebind()}if(e>1){if(g.refreshModelOnTableRefresh){var r=o.oCommonUtils.refreshModel(t.presentationControlHandler.getEntitySet());if(r){re(t.presentationControlHandler)}}t.presentationControlHandler.refresh()}}function Y(e,t,r){var n=Array.isArray(t);var a=o.oComponentUtils.isComponentActive();if(n&&t.length===0||r&&c(r)){return}y.refreshOperation(e,t,r,F,n,a,$)}function Z(e,t){if(y.setControlVariant){y.setControlVariant(e,t)}}function ee(e,t,r,n){return o.oCommonUtils.getCustomDataText(e).then(function(e){r.text=e;n.text=e;return{modelEntry:r,pathToTheItem:t}})}function te(e){d.setProperty(e.pathToTheItem,e.modelEntry)}function re(e){if(y.refreshSiblingControls){y.refreshSiblingControls(e)}}function ne(e){E.push(e)}function ae(){return Object.keys(m)}(function(){s.testable(function(){return y},"getImplementingHelper");s.testable(function(){return T},"getShowCounts");s.testable(function(){return m[F]},"getCurrentViewMeta");var e=function(e,t,r,n){if(e.numberOfUpdates!==r){return}var a=v+"/"+e.switchingKey;var i=l({},d.getProperty(a));if(!i.state&&t=="busy"){setTimeout(function(){if(d.getProperty(a).state==="busy"){i=l({},d.getProperty(a));i.state="busyLong";d.setProperty(a,i)}},b)}i.state=t;if(!t){i.count=n}d.setProperty(a,i)};g.getSwitchingControlAsync().then(function(t){var r=t?t.getItems():[];for(var n=0;n<r.length;n++){var a=r[n];var i=a.getKey();if(n===0){O=i}var s={presentationControlHandler:g.presentationControlHandler||g.getPresentationControlHandler(i),switchingKey:i};var l=o.oCommonUtils.getElementCustomData(a);var u=v+"/"+s.switchingKey;var p=Object.create(null);p.text=l.text;p.count=0;p.state="";p.facetId=g.sectionKey;ee(a,u,p,s).then(te);s.templateSortOrder=l.TemplateSortOrder;s.getPath=B.bind(null,s.presentationControlHandler);s.selectionVariantFilters=I(s.presentationControlHandler,l);s.numberOfUpdates=0;s.updateStartFunction=e.bind(null,s,"busy");s.updateSuccessFunction=e.bind(null,s,"");s.errorFunction=e.bind(null,s,"error");m[i]=s}if(y.init){y.init(m,Y,D)}if(g.manifestSettings.showCounts===undefined){T=y.getDefaultShowCounts()}else{T=g.manifestSettings.showCounts}z(F);var c=d.bindProperty(S);c.attachChange(function(e){var t=e.getSource().getValue();E.forEach(function(e){e(t,F)});F=t;if(y.onSelectedKeyChanged){y.onSelectedKeyChanged(t)}var r=g.isDataToBeShown();var n=y.getRefreshMode(F);if(g.adaptRefreshRequestMode){n=g.adaptRefreshRequestMode(n);if(r&&n>0){$(n)}else{D().presentationControlHandler.setEnabledToolbarButtons()}}g.appStateChange()});h()})})();return{updateCounts:M,refreshOperation:Y,onRebindContentControl:N,formatMessageStrip:L,getSelectedKey:j,setSelectedKey:z,getContentForIappState:W,restoreFromIappState:k,getSFBVariantContentStateWrapper:Q,getGeneralContentStateWrapper:J,formatItemTextForMultipleView:_,determineSortOrder:X,setControlVariant:Z,hasEntitySet:H,getPreferredKey:A,refreshSiblingControls:re,resolveParameterizedEntitySet:w,getMode:G,registerKeyChange:ne,getKeys:ae,getInitializationPromise:function(){return C}}}return e.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(e,t,r){l(this,g(e,t,r))}})});
//# sourceMappingURL=MultipleViewsHandler.js.map