sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/fe/navigation/NavError","sap/suite/ui/generic/template/listTemplates/listUtils","sap/fe/navigation/SelectionVariant","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/Device","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/suite/ui/generic/template/ListReport/controller/LegacyStateHandler","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/utils"],function(e,t,a,n,r,i,o,s,l,c,p,u,f,m,S,d,g){"use strict";var v="ListReport.controller.IappStateHandler";var y=new o(v);var b=y.getLogger();var D=y.Level;var h="sap.suite.ui.generic.template.customData",V="sap.suite.ui.generic.template.extensionData",O="sap.suite.ui.generic.template.genericData";var C=["save-appvar-id"];function E(e,t){if(sap.ui.support){var a=b.getLevel();if(a<D.INFO){b.setLevel(D.INFO)}}var n;if(typeof t==="string"){n=t}else{n="";var r="";for(var i in t){n=n+r+i+": "+t[i];r="; "}}b.info(e,n,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler")}function P(e,a,o){var S=new m(a);var y;var D=new Promise(function(e){y=e});var P=[];var N=[];var w=a.byId(d.getStableId({type:"ListReportTable",subType:"SmartTable"}));if(w){P.push(o.oCommonUtils.getControlStateWrapper(w))}var F=a.byId(d.getStableId({type:"ListReportAction",subType:"SearchField"}));if(F){P.push(o.oCommonUtils.getControlStateWrapper(F))}var I=e.oMultipleViewsHandler.getGeneralContentStateWrapper();if(I){I.getLocalId=function(){return"$multipleViewsGeneralContent"};P.push(I)}if(a.getOwnerComponent().getSmartVariantManagement()&&!a.getOwnerComponent().getVariantManagementHidden()){N=P;P=[]}var x=e.oMultipleViewsHandler.getSFBVariantContentStateWrapper();if(x){x.getLocalId=function(){return"$multipleViewsSFBVariantContent"};N.push(x)}var A=[];function L(){A.forEach(function(e){e()})}var T={getLocalId:function(){return"$customFilters"},getState:function(){var e={appExtension:Object.create(null),adaptationExtensions:Object.create(null)};if(o.oComponentUtils.isDraftEnabled()){var n=o.oComponentUtils.getTemplatePrivateModel();e.editState=n.getProperty("/listReport/vDraftState")}a.getCustomAppStateDataExtension(e.appExtension);var r=true;var i=function(a,n){if(!(a instanceof t)){throw new p(v,"State must always be set with respect to a ControllerExtension")}if(!r){throw new p(v,"State must always be provided synchronously")}e.adaptationExtensions[a.getMetadata().getNamespace()]=n};a.templateBaseExtension.provideExtensionAppStateData(i);r=false;return e},setState:function(e){if(o.oComponentUtils.isDraftEnabled()){var n=o.oComponentUtils.getTemplatePrivateModel();n.setProperty("/listReport/vDraftState",e.editState)}a.restoreCustomAppStateDataExtension(e.appExtension);var r=true;var i=function(a){if(!(a instanceof t)){throw new p(v,"State must always be retrieved with respect to a ControllerExtension")}if(!r){throw new p(v,"State must always be restored synchronously")}return e.adaptationExtensions[a.getMetadata().getNamespace()]};a.templateBaseExtension.restoreExtensionAppStateData(i);r=false},attachStateChanged:function(e){if(a.byId("editStateFilter")){a.byId("editStateFilter").attachChange(e)}A.push(e)}};var U=o.oCommonUtils.getControlStateWrapper(e.oSmartFilterbar,{oCustomFiltersWrapper:T});var M=a.byId(d.getStableId({type:"ListReportPage",subType:"DynamicPage"}));var H=o.oCommonUtils.getControlStateWrapper(M);P.push(H);var W=e.oSmartFilterbar.getSmartVariant();if(W){var k=o.oCommonUtils.getControlStateWrapper(W,{managedControlWrappers:N.concat([U]),dynamicPageWrapper:H});P.push(k)}else{P.push(U)}function J(){var t=o.oComponentUtils.getTemplatePrivateModel();function a(e){t.setProperty("/generic/bDataAreShownInTable",e)}function n(){return t.getProperty("/generic/bDataAreShownInTable")}function r(e,t){if(e===n()){return}a(e);t()}return{getLocalId:function(){return"$dataLoaded"},setState:a,getState:n,attachStateChanged:function(t){e.oSmartFilterbar.attachSearch(r.bind(null,true,t));e.oSmartFilterbar.attachFilterChange(r.bind(null,false,t))}}}var R=J();P.push(R);P.forEach(function(e){e.attachStateChanged(te)});var j=o.oServices.oApplication.getNavigationHandler();var _=a.getOwnerComponent().getSmartVariantManagement();var B=o.oComponentUtils.getSettings();if(!o.oComponentUtils.isStateHandlingSuspended()){e.oSmartFilterbar.setSuppressSelection(true)}var Q=true;function K(e){R.setState(e)}function $(){var e=o.oComponentUtils.getTemplatePrivateModel();return e.getProperty("/generic/bDataAreShownInTable")}function G(){e.oSmartFilterbar.search()}function q(){var e={};P.forEach(function(t){if(t.getLocalId()){e[t.getLocalId()]=t.getState()}});return{version:sap.ui.version,controlStates:e}}function z(e){if(o.oComponentUtils.isDraftEnabled()){var t=e["IsActiveEntity"];if(t&&t[0]){var a=o.oComponentUtils.getTemplatePrivateModel();a.setProperty("/listReport/vDraftState",t[0])}}}function X(e){if(_){var t=e["sap-ui-fe-variant-id"];if(t&&t[0]){W.setCurrentVariantId(t[0])}}else{var a=e["sap-ui-fe-variant-id"],n=e["sap-ui-fe-filterbar-variant-id"],r=e["sap-ui-fe-chart-variant-id"],i=e["sap-ui-fe-table-variant-id"];Y(n&&n[0],r&&r[0],i&&i[0],a&&a[0])}}function Y(t,a,n,r){if(t||r){W.setCurrentVariantId(t||r)}if(n||r){e.oPresentationControlHandler.setCurrentVariantId(n||r);e.oMultipleViewsHandler.setControlVariant(a,n)}}function Z(e){a.restoreCustomAppStateDataExtension(e||{})}function ee(){if(!e.oSmartFilterbar.checkSearchAllowed()){return}e.refreshModel();if(u.system.phone){ge()}R.setState(true);te()}function te(){E("changeIappState called",{bDataAreShownInTable:$()});if(e.oSmartFilterbar.isDialogOpen()||Q){return}o.oComponentUtils.stateChanged()}function ae(t){var a=e.oSmartFilterbar.determineMandatoryFilterItems(),n;for(var r=0;r<a.length;r++){if(a[r].getName().indexOf("P_DisplayCurrency")!==-1){if(t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){n=t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(n){t.oSelectionVariant.addParameter("P_DisplayCurrency",n)}}break}}}function ne(t){var a=typeof t==="string"?JSON.parse(t):t;var n=a&&a.SortOrder;e.oPresentationControlHandler.applyNavigationSortOrder(n)}function re(t){ue(t.controlStates);if($()){G()}else{o.oComponentUtils.hidePlaceholder()}if(!e.oSmartFilterbar.checkSearchAllowed()){o.oComponentUtils.hidePlaceholder()}}function ie(t,n,r){X(n);z(n);if(t.presentationVariant!==undefined){ne(t.presentationVariant)}if(t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&t.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1){ae(t)}var i={viaExternalNavigation:true,selectionVariant:t.oSelectionVariant,urlParameters:n,selectedQuickVariantSelectionKey:r,semanticDates:(typeof t.semanticDates==="string"?JSON.parse(t.semanticDates):t.semanticDates)||{}};if(!e.oWorklistData.bWorkListEnabled){a.modifyStartupExtension(i);if(e.oSmartFilterbar.isCurrentVariantStandard()){i.semanticDates=f.addSemanticDateRangeDefaultValue(B,e.oSmartFilterbar,i.semanticDates,i.urlParameters||{},i.selectionVariant,true);i.semanticDates.Dates.forEach(function(e){i.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")})}Ve(i.selectionVariant,t.selectionVariant||"",true,i.semanticDates,false)}Z();e.oMultipleViewsHandler.handleStartUpObject(i);Ce(e.oSmartFilterbar.isCurrentVariantStandard())}function oe(t,n){X(t);var i={viaExternalNavigation:false,selectionVariant:"",urlParameters:t,selectedQuickVariantSelectionKey:n,semanticDates:{}};var o=e.oSmartFilterbar.getUiState();var l=new r(JSON.stringify(o.getSelectionVariant()));ye(l);var c=JSON.parse(JSON.stringify(l));var p=o.getSemanticDates();i.selectionVariant=l;i.semanticDates=p;a.modifyStartupExtension(i);if(!(s(JSON.parse(JSON.stringify(i.selectionVariant)),c)&&s(i.semanticDates,p))){Ve(i.selectionVariant,"",true,i.semanticDates,true)}Z();e.oMultipleViewsHandler.handleStartUpObject(i);if(!e.oWorklistData.bWorkListEnabled&&!e.oSmartFilterbar.getLiveMode()&&e.oSmartFilterbar.isCurrentVariantStandard()){i.semanticDates=f.addSemanticDateRangeDefaultValue(B,e.oSmartFilterbar,i.semanticDates||{},i.urlParameters,i.selectionVariant);i.semanticDates.Dates.forEach(function(e){i.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")})}Ce();W&&W.currentVariantSetModified(false)}function se(e,t){return s(e.map(JSON.stringify).sort(),t.map(JSON.stringify).sort())}function le(e,t){var a={};e.forEach(function(e){a[e.PropertyName]=e});t.forEach(function(e){a[e.PropertyName]=e});return Object.values(a)}function ce(t,i,o){X(i);var l=e.oSmartFilterbar.getUiState();var c=l.getSemanticDates();var p={viaExternalNavigation:false,selectionVariant:t.oSelectionVariant,urlParameters:i,selectedQuickVariantSelectionKey:o,semanticDates:(typeof t.semanticDates==="string"?JSON.parse(t.semanticDates):t.semanticDates)||{}};if(t.presentationVariant!==undefined){ne(t.presentationVariant)}var u=new r(JSON.stringify(l.getSelectionVariant()));ye(u);var m=JSON.parse(JSON.stringify(u));if(t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&t.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1){ae(t)}if(!e.oWorklistData.bWorkListEnabled){if(e.oSmartFilterbar.isCurrentVariantStandard()){a.modifyStartupExtension(p);p.semanticDates=f.addSemanticDateRangeDefaultValue(B,e.oSmartFilterbar,p.semanticDates,p.urlParameters,p.selectionVariant);var S=s(p.semanticDates,c);if(c&&c.Dates){p.semanticDates.Dates=le(c.Dates,p.semanticDates.Dates)}p.semanticDates.Dates.forEach(function(e){var t=p.selectionVariant.getSelectOption(e.PropertyName);var a=u.getSelectOption(e.PropertyName);if(t&&t.length!=0){return}if(a&&a.length!=0){p.selectionVariant.massAddSelectOption(e.PropertyName,a);return}p.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")});var d=e.oSmartFilterbar.getAllFilterItems().map(function(e){return e.getName()});var g=function(e){return d.includes(e.PropertyName)};var v=e.oSmartFilterbar.getAnalyticalParameters().map(function(e){return e.name});var y=function(e){return v.includes(e.PropertyName)};var b=n.getMergedVariants([u,p.selectionVariant]);var D=b.toJSONObject();var h=u.toJSONObject();if(!se(h.SelectOptions.filter(g),D.SelectOptions.filter(g))||!se(h.Parameters.filter(y),D.Parameters.filter(y))||!S){Ve(b,t.selectionVariant,true,p.semanticDates,false);W.currentVariantSetModified(true)}}else{p.selectionVariant=u;p.semanticDates=c;a.modifyStartupExtension(p);if(!(s(JSON.parse(JSON.stringify(p.selectionVariant)),m)&&s(p.semanticDates,c))){Ve(p.selectionVariant,t.selectionVariant,true,p.semanticDates,false)}}}Z();e.oMultipleViewsHandler.handleStartUpObject(p);Ce()}function pe(t,n,r){E("fnAdaptToAppState called",{sNavType:r});e.oSmartFilterbar.setSuppressSelection(false);Q=false;if(r===sap.fe.navigation.NavType.hybrid){t=t.iAppState;t.controlStates=t.data.permanentEntries.permanentState.data.controlStates;re(t);return}if(r===sap.fe.navigation.NavType.iAppState){re(t);return}var i=o.oComponentUtils.getSelectionInfo();var s=i&&i.pageEntitySet;var l=e.oMultipleViewsHandler.getPreferredKey(s);switch(r){case sap.fe.navigation.NavType.initial:oe(n,l);break;case sap.fe.navigation.NavType.xAppState:case sap.fe.navigation.NavType.URLParams:if(t.bNavSelVarHasDefaultsOnly||t.oSelectionVariant.getSelectOptionsPropertyNames().length&&g.isASubsetOfB(t.oSelectionVariant.getSelectOptionsPropertyNames(),C)){ce(t,n,l)}else{ie(t,n,l)}break;default:throw new p(v,"Invalid navigation type: "+r)}if($()){e.oSmartFilterbar.search();if(u.system.desktop){o.oCommonUtils.getControlStateWrapper(a.byId(d.getStableId({type:"ListReportPage",subType:"DynamicPage"}))).setHeaderState(a,true)}else{ge()}}else{o.oComponentUtils.hidePlaceholder()}te()}function ue(e){P.forEach(function(t){t.setState(e[t.getLocalId()])})}function fe(e){if(!e){return D.then(me)}var t;if(c(e)){t=sap.fe.navigation.NavType.initial}else{t=sap.fe.navigation.NavType.iAppState;e=S.getStateInCurrentFormat(e)}var a=l({oDefaultedSelectionVariant:new r,oSelectionVariant:new r(e&&e.selectionVariant)},e);D.then(function(){pe(a,{},t)});return D}function me(){var e=new Promise(function(e){try{var t=j.parseNavigation();t.done(function(t,a,n){if(n!==sap.fe.navigation.NavType.iAppState){pe(t,a,n)}e()});t.fail(function(t,a,n){b.warning(t.getErrorCode()+"app state could not be parsed - continuing with empty state");pe({},a,sap.fe.navigation.NavType.initial);e()})}catch(t){pe({},{},sap.fe.navigation.NavType.initial);e()}});return e}function Se(t){if(e.oWorklistData.bWorkListEnabled&&t.getParameter("context")!=="SET_VM_ID"){G()}}function de(e){Se(e)}function ge(){var e=a.getOwnerComponent().getModel("_templPriv");e.setProperty("/listReport/isHeaderExpanded",false)}function ve(t,a,n,r){var o=new i({selectionVariant:t,semanticDates:r});e.oSmartFilterbar.setUiState(o,{replace:a,strictMode:n})}function ye(e){[V,h,O].forEach(e.removeSelectOption.bind(e))}function be(t,a,n){if(t&&(a!==""||n)){var r=t.getParameterNames().concat(t.getSelectOptionsPropertyNames());for(var i=0;i<r.length;i++){e.oSmartFilterbar.addFieldToAdvancedArea(r[i])}}}function De(e,t,a){if(e.getParameter(t)&&!e.getParameter(a)){e.addParameter(a,e.getParameter(t))}if(e.getSelectOption(t)&&!e.getSelectOption(a)){var n=e.getSelectOption(t);n.forEach(function(t){e.addSelectOption(a,t.Sign,t.Option,t.Low,t.High)})}}function he(e){var t=a.getOwnerComponent().getModel().getMetaModel();var n=a.getOwnerComponent().getEntitySet();var r=t.getODataEntityType(t.getODataEntitySet(n).entityType);r.property.forEach(function(t){if(t["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var a=t["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||t["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var n=t.name;De(e,a,n);De(e,n,a)}})}function Ve(t,a,n,r,i){he(t);if(n){e.oSmartFilterbar.clearVariantSelection()}be(t,a,i);ve(t.toJSONObject(),n,false,r)}function Oe(){var t={loadDataOnAppLaunch:"ifAnyFilterExist"};var n=e.oMultipleViewsHandler.getOriginalEnableAutoBinding();if(n!==undefined&&n!==null){t.loadDataOnAppLaunch=n?"always":"never"}var r=a.getOwnerComponent().getDataLoadSettings();if(r&&r.loadDataOnAppLaunch===""){r.loadDataOnAppLaunch=undefined}return l(t,r)}function Ce(t){var n=e.oSmartFilterbar;var r=e.oWorklistData.bWorkListEnabled||n.getLiveMode()||e.bLoadListAndFirstEntryOnStartup;var i=Oe().loadDataOnAppLaunch;if(!W||a.getOwnerComponent().getVariantManagementHidden()){r=r||i==="always";r=r||i==="ifAnyFilterExist"&&n.getFiltersWithValues().length>0}else{var o=(r||i!=="never")&&n.checkSearchAllowed();W&&W.setExecuteOnStandard(o);if(e.oSmartFilterbar.isCurrentVariantStandard()){var s=W.getExecuteOnStandard();if(o!==s){r=s}else{r=r||i==="always";r=r||i==="ifAnyFilterExist"&&e.oSmartFilterbar.getFiltersWithValues().length>0}}else{r=r||e.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()}}r=r||t;r=r&&n.checkSearchAllowed();R.setState(!!r)}return{areDataShownInTable:$,setDataShownInTable:K,onSearchPressed:ee,customAppStateChange:L,changeIappState:te,onSmartFilterBarInitialized:y,onAfterSFBVariantLoad:de,applyState:fe,getCurrentAppState:q,setFiltersUsingUIState:ve}}return e.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(e,t,a){l(this,P(e,t,a))}})});
//# sourceMappingURL=IappStateHandler.js.map