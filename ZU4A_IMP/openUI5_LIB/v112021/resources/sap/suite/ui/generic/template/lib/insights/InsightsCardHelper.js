sap.ui.define(["sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/lib/filterHelper","sap/fe/navigation/SelectionVariant","sap/base/util/deepExtend","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/ui/core/library","sap/base/strings/formatMessage","sap/suite/ui/generic/template/genericUtilities/FeLogger"],function(e,t,a,r,n,i,s,o){"use strict";var l={};l.CardTypes={TABLE:"Table",ANALYTICAL:"Analytical",LIST:"List"};var u=i.ValueState;var p=new o("js.InsightsCardHelper").getLogger();l.createCardForPreview=function(e){return c(e)};l.isCardCreationAllowed=function(e){return!n.hasSemanticDateValue(e)};l.getCardId=function(e){var t=e.getManifestEntry("sap.app");return"user."+t.id+"."+Date.now()};var c=function(e){var t=e["component"];var a=t.getAppComponent();var r=a.getManifestEntry("sap.ui");var n=a.getManifestEntry("sap.app");if(n&&n["crossNavigation"]){delete n["crossNavigation"]}var i={};n.type="card";n.id=l.getCardId(a);i["sap.app"]=f(n);i["sap.ui"]=r;i["sap.card"]=g(e);i["sap.insights"]=d(e);i["sap.ui5"]=m();return i};var v=function(e){var t=e.oServices.oApplication.getNavigationHandler();return t.getIAppStateKey()};var m=function(){return{_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}}};var f=function(e){var t=r({},e);if(t&&t.dataSources&&t.dataSources.mainService&&t.dataSources.mainService.settings){t.dataSources["filterService"]=t.dataSources.mainService;t.dataSources["filterService"].settings["odataVersion"]="2.0"}return t};var g=function(e){var t={};var a=e["component"].getMetadata().getName();t["type"]=y(a);t["configuration"]=C(e);t["data"]=l.fnCreateManifestSapCardData(e,t);t["header"]=l.fnCreateManifestSapCardHeader(e,t);t["extension"]="module:sap/insights/CardExtension";if(t.type==="Analytical"){t["content"]=l.fnCreateManifestSapAnalyticalCardContent(e,t)}else{t["content"]=l.fnCreateManifestSapTableCardContent(e,t)}l.getCardActions(e,t);return t};var d=function(e){var t=e["component"],a=e["currentControlHandler"],r=t.getAppComponent().getManifestEntry("sap.app"),n=r.id,i="RT";return{parentAppId:n,cardType:i,allowedChartTypes:a.getAvailableChartTypes&&a.getAvailableChartTypes(),versions:{ui5:sap.ui.version+"-"+sap.ui.getVersionInfo().buildTimestamp},filterEntitySet:e.entitySet.name}};var y=function(e){switch(e){case"sap.suite.ui.generic.template.ListReport.Component":return l.CardTypes.TABLE;case"sap.suite.ui.generic.template.AnalyticalListPage.Component":return l.CardTypes.ANALYTICAL;default:return l.CardTypes.LIST}};var C=function(e){var t={};var a=e["component"];var r=a.getModel().sServiceUrl;t["parameters"]=l.getFilterDetails(e)["filters"];t["parameters"]["_entitySet"]={value:e.entitySet.name};t["parameters"]["_urlSuffix"]={value:"/Results"};t["destinations"]={service:{name:"(default)",defaultUrl:"/"}};t["csrfTokens"]={token1:{data:{request:{url:"{{destinations.service}}"+r,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};return t};l.getFilterDetails=function(r){var n={filters:{}},i=n.filters,s=r.oSmartFilterbar,o=s&&s.getModel(),l=r.view.getModel(),u=r.entityType,p=[],c=[],v=[],m=[],f,g=[],d=[],y=[];if(o){var C=e.checkAnalyticalParameterisedEntitySet(o,r.entitySet.name);if(C){var h=e.getParametersByEntitySet(o,r.entitySet.name);if(h.entitySetName){y=h.parameters||[]}}}var D=e.getParametersByEntitySet(l,r.entitySet.name,true).parameters;var O="";D.forEach(function(e){var a=P(e);var n=t.getParameterDefaultValue(l,r.entitySet.name,e);var o=t.getParameterActualValue(e,s);O=t.getLabelForConfigParams(e,s,i,r,n);var u=t.IsSemanticDateRangeValid(r,e);if(u){t.setFilterRestrictionToSemanticDateRange(e,true);n=t.getDateRangeDefaultValue(r,e)||n;o=t.getDateRangeValue(o,e,true)||o;if(O&&typeof O==="string"){O=O.substring(0,O.indexOf("(")-1)}else if(n){O=n;t.getLabelForConfigParams(e,s,i,r,n,true)}}if(a){v.push(e)}i[e]={value:o?o:n,type:t.getPropertyType(e),description:e&&e.description,label:O};i[e]["description"]=x(e,"description");p.push(e);g.push(e)});y=y.filter(function(e){return!g.includes(e)});if(u&&u.property){d=T(u.property,y)}for(var $=0;$<d.length;$++){var V=d[$],M="";var A=b(V,u.property);var I=P(A);var N=t.getFilterDefaultValue(V.name,u)||V.defaultValue||"";var L=t.getParameterActualValue(V.name,s);if(g.includes(V.name)){O=t.getLabelForConfigParams(V.name,s,i,r,N);var R=t.IsSemanticDateRangeValid(r,V);if(R){t.setFilterRestrictionToSemanticDateRange(V,true);N=t.getDateRangeDefaultValue(r,V.name)||N;L=t.getDateRangeValue(L,V,true)||L;if(O&&typeof O==="string"){O=O.substring(0,O.indexOf("(")-1)}else if(N){O=N;t.getLabelForConfigParams(V.name,s,i,r,N,true)}}i[V.name]={value:L?L:N,type:t.getPropertyType(V),description:V&&V.description,label:O};if(I){v.push(I)}p.push(V.name)}else{f=new a;var E=t.getLabelForConfigParams(V.name,s,i,r,N);var R=t.IsSemanticDateRangeValid(r,V);if(R){t.setFilterRestrictionToSemanticDateRange(V,false);t.addDateRangeValueToSV(r,V,N,f,E)}else{if(L){t.addFiltervalues(s,V.name,f,E)}else if(N){var F=t.getRelatedTextToRange({Low:N},E,s,V.name);f.addSelectOption(V.name,"I","EQ",N,null,F)}else{f.addSelectOption(V.name,"I","EQ",M)}}i[V.name]={value:f.toJSONString(),type:t.getPropertyType(V),description:V&&V.description};i[V.name].value=t.enhanceVariant(i[V.name].value);if(I){m.push(I)}c.push(V.name)}i[V.name]["description"]=x(V,"description")}var U=r["oFECustomFilterData"];if(U){f=new a;f.addSelectOption(U.name,"I","EQ",U.value);i[U.name]={value:f.toJSONString(),type:"string",description:""};i[U.name].value=t.enhanceVariant(i[U.name].value);c.push(U.name)}var w=s.getBasicSearchName(),H=s.getBasicSearchValue();if(H){f=new a;f.addSelectOption(w,"I","EQ",H);i[w]={value:f.toJSONString(),type:"string",description:""};i[w].value=t.enhanceVariant(i[w].value);c.push(w)}var _=S(c);var B=S(p);var k=S(v);var J=S(m);t.updateRangeValue(i);i["_relevantODataFilters"]={value:_};i["_relevantODataParameters"]={value:B};i["_mandatoryODataParameters"]={value:k};i["_mandatoryODataFilters"]={value:J};return n};var S=function(e){return e&&e.filter(function(t,a){return e.indexOf(t)===a})};var T=function(e,t){var a=e.filter(function(e){return h(e)})||[];if(t&&t.length>0){e.forEach(function(e){var r="P_"+e.name;if(t.includes(r)){a.push(e)}})}return a};var h=function(e){return e["sap:filterable"]?e["sap:filterable"]!=="false":true};var b=function(e,t){if(t&&t.length){var a=t.filter(function(t){return t.name===e.name});return a&&a[0]}};var P=function(e){var t=[];if(e&&e.extensions){t=e.extensions;for(var a=0;a<t.length;a++){if(t[a].name==="parameter"&&t[a].value==="mandatory"){return e.name}else if(t[a].name==="required-in-filter"&&t[a].value==="true"){return e.name}}}};var x=function(e,t){var a;if(e&&e[t]){return e[t]}else if(e&&e.extensions){a=e.extensions;for(var r=0;r<a.length;r++){if(a[r].name===t){return a[r].value}}}return undefined};var D=function(e,t){if(e&&t){if(e.indexOf("?")===-1){e+="?"+t}else{e+="&"+t}}return e};l.fnCreateManifestSapCardData=function(e,t){var a={};var r=e["component"],n=e["component"].getMetadata().getName();var i=r.getModel().sServiceUrl;var s=i;var o=e["currentControlHandler"];var l="";if(o.getBinding()){l=o.getBinding().getDownloadUrl()}if(n==="sap.suite.ui.generic.template.ListReport.Component"){var u="$top=15";l=D(l,u)}var p="$inlinecount=allpages";l=D(l,p);var c={};c.content={method:"GET",url:l,headers:{Accept:"application/json"}};a["request"]={url:"{{destinations.service}}"+s+"/$batch",method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}"},batch:c};return a};l.fnCreateManifestSapCardHeader=function(e,t){var a=e["currentControlHandler"].getToolbar();var r=e["component"].getMetadata().getName(),n=a.getTitleControl()&&a.getTitleControl().getText();if(n&&n.indexOf("(")>-1&&r==="sap.suite.ui.generic.template.ListReport.Component"){var i=n.split("(");n=i[0].trim()}var s="__count";var o={text:"{= ${"+s+"} === '0' ? '' : ${"+s+"} }"};var l={title:n,subTitle:"",actions:{},status:o,data:{path:"/content/d"}};return l};l.fnCreateManifestSapTableCardContent=function(e,t){var a=R(e);var r={data:{path:"/content/d/results"},maxItems:15,row:{columns:a,actions:{}}};return r};var O=function(e,t,a){var r;var n=a.getMeasures();var i=a.getDimensions();if(t==="Dimension"){r=i.filter(function(t){return t.getName()===e})[0].getLabel()||e}else{r=n.filter(function(t){return t.getName()===e})[0].getLabel()||e}return r};var $=function(e){var t=[],a=e._getVizFrame().getFeeds(),r,n;for(var i=0;i<a.length;i++){r=a[i].getProperty("values");n=[];for(var s=0;s<r.length;s++){var o=O(r[s].getProperty("name"),r[s].getProperty("type"),e);var l={type:a[i].getProperty("type"),uid:a[i].getProperty("uid"),values:[o]};n.push(l)}t=t.concat(n)}return t};l.fnCreateManifestSapAnalyticalCardContent=function(e,t){var a={},r=e["currentControlHandler"],n=r.getInnerChart(),i=n.getMeasures(),s=n.getDimensions(),o=n.getVisibleDimensions(),l=n.getVisibleMeasures(),u=n.getInResultDimensions();for(var p=0;p<u.length;p++){o.push(u[p])}a["data"]={path:"/content/d/results"};a["chartType"]=n.getChartType();a["measures"]=M(i,l);a["dimensions"]=I(s,o,e);a["feeds"]=$(n);a["chartProperties"]=V(n);a["actionableArea"]="Chart";a["actions"]={};return a};var V=function(e){var t={categoryAxis:{title:{visible:true}},valueAxis:{title:{visible:true}}};e.setVizProperties(t);return e.getVizProperties()};var M=function(e,t){var a=[];for(var r in e){var n=e[r];for(var i=0;i<t.length;i++){if(t[i]===n.getName()){a.push({name:n.getLabel(),value:"{"+n.getName()+"}"});break}}}return a};var A=function(e,t){var a=e["entityType"];var r=e["currentControlHandler"].getModel().getMetaModel();var n=r.getODataProperty(a,t.getName());var i="{"+n.name+"}";var s="{"+t.getTextProperty()+"}";if(n["com.sap.vocabularies.Common.v1.Text"]&&n["com.sap.vocabularies.Common.v1.Text"].Path){var o=n["com.sap.vocabularies.Common.v1.Text"]["com.sap.vocabularies.UI.v1.TextArrangement"];if(!o){o=a["com.sap.vocabularies.UI.v1.TextArrangement"]}var l=o&&o.EnumMember.split("/")[1];if(l==="TextOnly"){i="{= $"+s+" === '' ? '' : $"+s+"}"}else if(l==="TextLast"){i="{= $"+i+" === '' ? '' : $"+i+"}"+"{= $"+s+" === '' ? '' : ' (' + ($"+s+") + ')'}"}else if(l==="TextSeparate"){i="{= $"+i+" === '' ? '' : $"+i+"}"}else{i="{= $"+s+" === '' ? '' : $"+s+"}"+"{= $"+i+" === '' ? '' : ' (' + ($"+i+") + ')'}"}}return i};var I=function(e,t,a){var r=[];for(var n in e){var i=e[n];for(var s=0;s<t.length;s++){if(t[s]===i.getName()){if(i.getTextProperty()){r.push({name:i.getLabel(),value:"{"+i.getTextProperty()+"}",displayValue:A(a,i)})}else{r.push({name:i.getLabel(),value:"{"+i.getName()+"}",displayValue:A(a,i)})}break}}}return r};l.getCardActions=function(e,t){var a=window.hasher.getHash(),r=a.split("&/")[0];if(r.includes("?")){r=r.split("?")[0].split("-")}else{r=r.split("-")}var n={ibnTarget:{semanticObject:r[0],action:r[1]},sensitiveProps:[],ibnParams:{nhHybridIAppStateKey:v(e.oTemplateUtils)}};var i=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/headerState/value})}"}];var s=JSON.parse(JSON.stringify(n));var o=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/contentState/value}, ${})}"}];t.configuration.parameters.headerState={value:JSON.stringify(n)};t.configuration.parameters.contentState={value:JSON.stringify(s)};t.header.actions=i;if(t.type!="Analytical"){var l=e["component"].getModel("_templPriv");if(!l.getProperty("/listReport/bSupressCardRowNavigation")){t.content.row.actions=o}}};var N=function(e){var t=e["entityType"];var a=e["currentControlHandler"].getControl().getCustomData();var r=a.find(function(e){return e.getKey()==="lineItemQualifier"});var n=r&&r.getValue()?"#"+r.getValue():"";return t["com.sap.vocabularies.UI.v1.LineItem"+n]||[]};var L=function(e){var t=u.None;var a;var r=e.Criticality;if(r){a="'{'= ({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Negative'') || ({0} === ''1'') || ({0} === 1) ? ''"+u.Error+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Critical'') || ({0} === ''2'') || ({0} === 2) ? ''"+u.Warning+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Positive'') || ({0} === ''3'') || ({0} === 3) ? ''"+u.Success+"'' : "+"''"+u.None+"'' '}'";if(r.Path){var n="${"+r.Path+"}";t=s(a,n)}else if(r.EnumMember){var i="'"+r.EnumMember+"'";t=s(a,i)}else{p.warning("Case not supported, returning the default sap.ui.core.ValueState.None")}}else{p.warning("Case not supported, returning the default sap.ui.core.ValueState.None")}return t};var R=function(e){var t=e["entityType"];var a=e["currentControlHandler"].getModel().getMetaModel();var r=[];var n=e.oTemplateUtils.oCommonUtils;e["currentControlHandler"].getVisibleProperties(true).filter(function(i){var s=i.data("p13nData");var o=s&&s.description||"";var l=a.getODataProperty(t,s.leadingProperty);if(n.isSupportedColumn(i,l)){if(l&&(l["sap:label"]||l["com.sap.vocabularies.Common.v1.Label"])&&i.getVisible()){var u={};o="{"+o+"}";var p="{"+l.name+"}";var c="";var v;var m=t["com.sap.vocabularies.Common.v1.SemanticKey"];var f=!!m&&m.some(function(e){return e.PropertyPath===l.name});var g=N(e);var d=!!g&&g.some(function(e){v=e;return(e.Criticality&&e.Value&&e.Value.Path)===l.name});if(l["Org.OData.Measures.V1.ISOCurrency"]&&l["Org.OData.Measures.V1.ISOCurrency"].Path){p=p.concat(" "+"{"+c+l["Org.OData.Measures.V1.ISOCurrency"].Path+"}")}if(l["Org.OData.Measures.V1.Unit"]&&l["Org.OData.Measures.V1.Unit"].Path){p=p.concat(" "+"{"+c+l["Org.OData.Measures.V1.Unit"].Path+"}")}if(l["com.sap.vocabularies.Common.v1.Text"]&&l["com.sap.vocabularies.Common.v1.Text"].Path){var y=l["com.sap.vocabularies.Common.v1.Text"]["com.sap.vocabularies.UI.v1.TextArrangement"];if(!y){y=t["com.sap.vocabularies.UI.v1.TextArrangement"]}var C=y&&y.EnumMember.split("/")[1];if(f&&e.oTemplateUtils.oComponentUtils.isDraftEnabled()){var S=e["component"].getModel("i18n").getResourceBundle().getText("NEW_OBJECT");if(C==="TextOnly"){u["value"]="{= $"+o+" === '' ?  '"+S+"'  : $"+o+"}"}else if(C==="TextLast"){u["value"]="{= $"+p+" === '' ?  '' : $"+p+"}";u.additionalText="{= $"+o+" === '' ?  '"+S+"' : $"+o+"}"}else if(C==="TextSeparate"){u["value"]="{= $"+p+" === '' ? '' : $"+p+"}"}else{u["value"]="{= $"+o+" === '' ?  '"+S+"' : $"+o+"}";u.additionalText="{= $"+p+" === '' ?  '' : $"+p+"}"}u.identifier=true}else{if(C==="TextOnly"){u["value"]="{= $"+o+" === '' ? '' : $"+o+"}"}else if(C==="TextLast"){u["value"]="{= $"+p+" === '' ? '' : $"+p+"}"+"{= $"+o+" === '' ? '' : ' (' + ($"+o+") + ')'}"}else if(C==="TextSeparate"){u["value"]="{= $"+p+" === '' ? '' : $"+p+"}"}else{u["value"]="{= $"+o+" === '' ? '' : $"+o+"}"+"{= $"+p+" === '' ? '' : ' (' + ($"+p+") + ')'}"}}}else{u["value"]=p;if(f){u.identifier=f}if(d){u.state=L(v);u.showStateIcon=v.CriticalityRepresentation?v.CriticalityRepresentation.EnumMember!=="com.sap.vocabularies.UI.v1.CriticalityRepresentationType/WithoutIcon":true}}if(l["com.sap.vocabularies.Common.v1.Label"]&&l["com.sap.vocabularies.Common.v1.Label"].String){var T=l["com.sap.vocabularies.Common.v1.Label"].String,h=e["component"].getModel("i18n").getResourceBundle();if(T.match(/{@i18n>.+}/gi)&&h){u["title"]=h.getText(T.substring(T.indexOf(">")+1,T.length-1))}else{u["title"]=T}}else{u["title"]=l["sap:label"]}if(l.type==="Edm.DateTime"||l.type==="Edm.DateTimeOffset"){var b=JSON.stringify(s.typeInstance.oFormat.oFormatOptions).replace(/"/g,"'");u["value"]="{=$"+p+" ? format.dateTime($"+p+", "+b+") : ''}"}r.push(u)}}});return r};return l});
//# sourceMappingURL=InsightsCardHelper.js.map