/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/base/security/URLListValidator","./CollaborationHelper","./BaseHelperService","sap/ui/core/Element","./ContactHelper","sap/ui/Device","./CollaborationCardHelper","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/core/Lib"],function(e,a,r,t,i,o,n,s,l,p,d,c){"use strict";var h=i.extend("sap.suite.ui.commons.collaboration.TeamsHelperService",{constructor:function(e){this._providerConfig=e;this._providerConfig.shareAsLinkUrl="https://teams.microsoft.com/share";this._getShareAsTabUrl().then(function(e){this._providerConfig.shareAsTabUrl=e}.bind(this))}});var u="db5b69c6-0430-4ae1-8d6e-a65c2220b50c";var f=e.getLogger("sap.suite.ui.commons.collaboration.TeamsHelperService");var A="https://saps4hana.azure-api.net/bot/redirect?target-url=";var b=a.getLibraryResourceBundle("sap.suite.ui.commons");var C="sap-ui-cardTitle";var m="sap-ui-xx-cardId";var T="sap-ui-xx-cardVersion";var v;let g;const S=60*1e3;var _="sap-stageview-hash";var y={};var O="width=720,height=720";h.prototype.getOptions=function(e){y={isShareAsLinkEnabled:e&&typeof e.isShareAsLinkEnabled!=="undefined"?e.isShareAsLinkEnabled:true,isShareAsTabEnabled:e&&typeof e.isShareAsTabEnabled!=="undefined"?e.isShareAsTabEnabled:true,isShareAsCardEnabled:e&&typeof e.isShareAsCardEnabled!=="undefined"?e.isShareAsCardEnabled:false};var a=[];var r=[];if(s.system.desktop){if(y.isShareAsLinkEnabled){if(this._providerConfig.isShareAsLinkEnabled==="X"){a.push({text:b.getText("COLLABORATION_MSTEAMS_CHAT"),key:"COLLABORATION_MSTEAMS_CHAT",icon:"sap-icon://post",fesrStepName:"MST:ShareAsLink"})}else{f.info("Share as Chat option is not enabled in the tenant")}}else{f.info("Consumer disable Share as Chat option")}}else{f.info("Share as Chat option is not supported in Phone and Tablet")}if(s.system.desktop){if(y.isShareAsTabEnabled){if(this._providerConfig.isShareAsTabEnabled==="X"){a.push({text:b.getText("COLLABORATION_MSTEAMS_TAB"),key:"COLLABORATION_MSTEAMS_TAB",icon:"sap-icon://image-viewer",fesrStepName:"MST:ShareAsTab"})}else{f.info("Share as Tab option is not enabled in the tenant")}}else{f.info("Consumer disable Share as Tab option")}}else{f.info("Share as Tab option is not supported in Phone and Tablet")}if(s.system.desktop){if(y.isShareAsCardEnabled){const e=this._providerConfig.isShareAsCardEnabled;const r=this._providerConfig.isShareAsTabEnabled==="X";const t={text:b.getText("COLLABORATION_MSTEAMS_CARD"),key:"COLLABORATION_MSTEAMS_CARD",icon:"sap-icon://ui-notifications",fesrStepName:"MST:ShareAsCard"};switch(e){case"DISABLED":f.info("Share as Card option is not enabled in the tenant");break;case"ENABLED":a.push(t);break;case"":case undefined:if(r){a.push(t)}else{f.info("Share as Card option is not enabled in the tenant")}break;default:f.info("Share as Card option is not enabled in the tenant");break}}else{f.info("Consumer disable Share as Card option")}}else{f.info("Share as Card option is not supported in Phone and Tablet")}if(a.length===1){r=a;if(r[0].key==="COLLABORATION_MSTEAMS_CHAT"){r[0].text=b.getText("COLLABORATION_MSTEAMS_CHAT_SINGLE")}else if(r[0].key==="COLLABORATION_MSTEAMS_TAB"){r[0].text=b.getText("COLLABORATION_MSTEAMS_TAB_SINGLE")}else if(r[0].key==="COLLABORATION_MSTEAMS_CARD"){r[0].text=b.getText("COLLABORATION_MSTEAMS_CARD_SINGLE")}return r}if(a.length>1){r.push({type:"microsoft",text:b.getText("COLLABORATION_MSTEAMS_SHARE"),icon:"sap-icon://collaborate",subOptions:a})}return r};h.prototype.share=function(e,a){if(!a.url){f.error("url is not supplied in object so terminating Click");return}if(!r.validate(a.url)){f.error("Invalid URL supplied");return}if(e.key==="COLLABORATION_MSTEAMS_CHAT"){this._shareAsChat(a);return}if(e.key==="COLLABORATION_MSTEAMS_TAB"){this._shareAsTab(a);return}if(e.key==="COLLABORATION_MSTEAMS_CARD"){this._shareAsCard(a);return}};h.prototype._shareAsChat=function(e){var a=window.open("","_blank",O);var r=e.appTitle;if(e.subTitle.length>0){r+=": "+e.subTitle}a.opener=null;if(e.minifyUrlForChat){t.compactHash(e.url,[]).then(async function(t){var i=await this._modifyUrlForNavigationContext(e.url,t.url);a.location=this._providerConfig.shareAsLinkUrl+"?msgText="+encodeURIComponent(r)+"&preview=false"+"&href="+encodeURIComponent(i)}.bind(this))}else{a.location=this._providerConfig.shareAsLinkUrl+"?msgText="+encodeURIComponent(r)+"&preview=false"+"&href="+encodeURIComponent(e.url)}};h.prototype._modifyUrlForShareAsTab=async function(e){var a=e;var r=a.indexOf("#");if(r!==-1){var t=a.substring(0,r);var i=t.indexOf("?",0);var o="sap-ushell-config=lean&sap-collaboration-teams=true";if(i!==-1){t=t.substring(0,i+1)+o+"&"+t.substring(i+1)}else{t+="?"+o}a=t+a.substring(r);a=await this._addNavmodeInUrl(a,"explace")}return a};h.prototype._shareAsTab=async function(e){var a=await this._modifyUrlForShareAsTab(e.url);var r={subEntityId:{url:a,appTitle:e.appTitle,subTitle:e.subTitle,mode:"tab"}};if(e.minifyUrlForChat){t.compactHash(a,[]).then(async function(e){var t=await this._modifyUrlForNavigationContext(a,e.url);r.subEntityId.url=await this._addNavmodeInUrl(t,"explace");var i=this._providerConfig.shareAsTabUrl+"?&context="+encodeURIComponent(JSON.stringify(r));sap.m.URLHelper.redirect(i,true)}.bind(this))}else{var i=this._providerConfig.shareAsTabUrl+"?&context="+encodeURIComponent(JSON.stringify(r));sap.m.URLHelper.redirect(i,true)}};h.prototype._addNavmodeInUrl=function(e,a){const r=sap.ui.require("sap/ushell/Container");return r&&r.getServiceAsync("URLParsing").then(function(r){var t=e;var i=t.indexOf("#");var o=r.parseShellHash(t.substring(i));o.params["sap-ushell-navmode"]=a;o.params["sap-ushell-next-navmode"]=a;var n=r.constructShellHash(o);t=t.substring(0,i)+"#"+n;return Promise.resolve(t)})};h.prototype._modifyUrlForNavigationContext=function(e,a){if(e===a){return Promise.resolve(a)}const r=sap.ui.require("sap/ushell/Container");return r&&r.getServiceAsync("URLParsing").then(function(r){var t=e;var i=t.indexOf("#");var o=r.parseShellHash(t.substring(i));var n=Object.keys(o.params).length;var s=new URL(a);if(n>0){if(!s.searchParams.has("sap-collaboration-teams")){s.searchParams.set("sap-collaboration-teams","true")}else{s.searchParams.delete("sap-collaboration-teams")}}return Promise.resolve(s.toString())})};h.prototype._shareAsCard=function(e){if(e.cardId&&e.cardId.length>0&&e.cardManifest&&this.isFeatureFlagEnabled()){p.load({name:"sap.suite.ui.commons.collaboration.CollaborationBusyDialog",controller:this,type:"XML"}).then(function(a){v=a;v.open();g=setTimeout(function(){v.close();v.destroy()},S);l.postCard(e.cardId,e.cardManifest).then(function(a){var r=true;var t={cardId:a.card_id,version:a.version};if(a.error){if(a.error.code==="APS_UI_MSG/001"){r=true;t.cardId=e.cardId;if(a.error.message.length>0){try{var i=JSON.parse(atob(a.error.message)).version;t.version=i}catch(e){r=false}}}else{r=false}}if(r){this._updateUrl(e,t)}else{d.error(b.getText("SAVE_CARD_ERROR"));this._closeBusyDailog()}}.bind(this))}.bind(this))}else{this._updateUrl(e,{})}};h.prototype._updateUrl=async function(e,a){if(e.minifyUrlForChat){t.compactHash(e.url,[]).then(async function(r){var i=await this._modifyUrlForNavigationContext(e.url,r.url);if(y.isShareAsTabEnabled&&this._providerConfig.isShareAsTabEnabled){var o=await this._modifyUrlForShareAsTab(e.url);var n=await t.compactHash(o,[]);var s=n.url.split("sap-url-hash=")[1];if(s){i+="&"+_+"="+s}else{o=await this._modifyUrlForShareAsTab(i);i=await this._addNavmodeInUrl(o,"inplace")}this._closeBusyDialogAndOpenTeamsDialog(i,e,a)}else{this._closeBusyDialogAndOpenTeamsDialog(i,e,a)}}.bind(this))}else{var r=e.url;if(y.isShareAsTabEnabled&&this._providerConfig.isShareAsTabEnabled){var i=await this._modifyUrlForShareAsTab(r);r=await this._addNavmodeInUrl(i,"inplace")}this._closeBusyDialogAndOpenTeamsDialog(r,e,a)}};h.prototype._closeBusyDailog=function(){if(v){v.close();v.destroy();clearTimeout(g)}};h.prototype._closeBusyDialogAndOpenTeamsDialog=function(e,a,r){this._closeBusyDailog();var t=window.open("","_blank",O);t.opener=null;t.location=this._addCardParamsInUrl(e,a.appTitle,r)};h.prototype._addCardParamsInUrl=function(e,a,r){if(r.cardId){e=e+"&"+m+"="+r.cardId}if(r.version){e=e+"&"+T+"="+r.version}e=e+"&"+C+"="+encodeURIComponent(a);e=this._providerConfig.shareAsLinkUrl+"?href="+encodeURIComponent(A+e);return e};h.prototype._getShareAsTabUrl=function(){return this._getApplicationID().then(function(e){return"https://teams.microsoft.com/l/entity/"+e+"/tab"})};h.prototype._getApplicationID=function(){const e=sap.ui.require("sap/ushell/Container");return e&&e.getServiceAsync("URLParsing").then(function(e){return t._getCurrentUrl().then(function(a){var r=a.split("#")[0];if(r.indexOf("?")!==-1){var t=e&&e.parseParameters(r.substring(r.indexOf("?")));if(t&&t["sap-collaboration-xx-TeamsAppId"]&&t["sap-collaboration-xx-TeamsAppId"][0]&&t["sap-collaboration-xx-TeamsAppId"][0].length>0){return Promise.resolve(t["sap-collaboration-xx-TeamsAppId"][0])}return Promise.resolve(u)}else{return Promise.resolve(u)}})})};h.prototype.isFeatureFlagEnabled=function(){const e=this._providerConfig.isShareAsCardEnabled;if(window["sap-ushell-config"]&&window["sap-ushell-config"].renderers&&window["sap-ushell-config"].renderers.fiori2&&window["sap-ushell-config"].renderers.fiori2.componentData&&window["sap-ushell-config"].renderers.fiori2.componentData.config&&window["sap-ushell-config"].renderers.fiori2.componentData.config.sapHorizonEnabled&&e==="ENABLED"){return true}return false};h.prototype.isContactsCollaborationSupported=function(){return true};h.prototype.enableContactsCollaboration=function(e){if(this._providerConfig.applicationId&&this._providerConfig.tenantId&&e){if(!this.oContactHelper){this.oContactHelper=new n(this._providerConfig)}return this.oContactHelper.loadContactPopover(e)}};h.prototype.enableMinimalContactsCollaboration=async function(e){const a=await t.isTeamsModeActive();if(a||!e||this._providerConfig.isDirectCommunicationEnabled!=="ENABLED"){return Promise.reject()}if(!this.oContactHelper){this.oContactHelper=new n}return this.oContactHelper.loadMinimalContactPopover(e)};h.prototype.getTeamsContactCollabOptions=async function(){const e=await t.isTeamsModeActive();if(e||this._providerConfig.isDirectCommunicationEnabled!=="ENABLED"){return Promise.reject()}if(!this.oContactHelper){this.oContactHelper=new n}return this.oContactHelper.getTeamsContactOptions()};return h});
//# sourceMappingURL=TeamsHelperService.js.map