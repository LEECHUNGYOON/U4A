/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/suite/ui/commons/library","./ElementBase","./layout/Geometry","./Coordinate","./Utils","sap/ui/core/RenderManager","sap/ui/core/Lib"],function(t,e,o,i,r,s,n){"use strict";var a=t.networkgraph.LineArrowPosition,h=t.networkgraph.LineType,p=t.networkgraph.LineArrowOrientation,g=t.networkgraph.NodeShape,u=t.networkgraph.Orientation;var l=6,d=5,c=.45,f=15,y={Apex:{x:5.5,y:0},Second:{x:-5.5,y:-7.5},Third:{x:-5.5,y:7.5}},m={Apex:{x:16,y:0},Second:{x:5,y:-7.5},Third:{x:5,y:7.5}},_={Apex:{x:-12,y:0},Second:{x:-1,y:-7.5},Third:{x:-1,y:7.5}},C=5;var v=n.getResourceBundleFor("sap.suite.ui.commons");var S=e.extend("sap.suite.ui.commons.networkgraph.Line",{apiVersion:2,metadata:{library:"sap.suite.ui.commons",properties:{selected:{type:"boolean",group:"Misc",defaultValue:false},from:{type:"string",group:"Misc",defaultValue:null},to:{type:"string",group:"Misc",defaultValue:null},lineType:{type:"sap.suite.ui.commons.networkgraph.LineType",group:"Appearance",defaultValue:h.Solid},arrowPosition:{type:"sap.suite.ui.commons.networkgraph.LineArrowPosition",group:"Appearance",defaultValue:a.End},arrowOrientation:{type:"sap.suite.ui.commons.networkgraph.LineArrowOrientation",group:"Appearance",defaultValue:p.ParentOf},stretchToCenter:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{coordinates:{type:"sap.suite.ui.commons.networkgraph.Coordinate",multiple:true,singularName:"coordinate"},actionButtons:{type:"sap.suite.ui.commons.networkgraph.ActionButton",multiple:true,singularName:"actionButton"}},events:{hover:{},press:{parameters:{point:"Object",opener:"Object"}}}},renderer:function(t,e){var o=e._render({renderManager:t});this.oRm=t;if(o){t.unsafeHtml(o)}},onAfterRendering:function(){this._afterRenderingBase()},init:function(){this._oFrom=null;this._oTo=null;this._bFocusRendered=false;this._sKey="";this._bIsHidden=false}});S.prototype.aProcessRequiredProperties=["from","to"];S.prototype._afterRendering=function(){this._setupEvents();if(this.getFromNode()._bIsHidden||this.getToNode()._bIsHidden){this.$().hide()}this._removeFromInvalidatedControls()};S.prototype._render=function(t){var o=t.renderManager;var i=this.getSelected()?" "+this.SELECT_CLASS+" ":"",r=this._getElementId(t&&t.idSufix),s;var n=this._getStatusStyle({stroke:e.ColorType.Border,"stroke-width":e.ColorType.BorderWidth,"stroke-dasharray":e.ColorType.BorderStyle});var h=this._getStatusStyle({fill:e.ColorType.Background,stroke:e.ColorType.Border});var g=function(t,e,i){return this._renderControl("path",{d:s,class:t||this._getLineClass(),style:i?"":n,from:this.getFromNode().getKey(),to:this.getToNode().getKey(),id:r?r+"-"+e:""},null,o)}.bind(this);var l=function(t,e,o){return{id:r+"-"+o,class:"sapSuiteUiCommonsNetworkLineArrow",style:h,d:"M "+e[t+0].x+","+e[t+0].y+" L "+e[t+1].x+","+e[t+1].y+" L "+e[t+2].x+","+e[t+2].y+" Z"}};var d=function(t,e,i){var r=this._getArrowPoints(t,e);this._renderControl("path",l(0,r,i||"arrow"),null,o);if(this._isBothMiddleArrow()){this._renderControl("path",l(3,r,"arrow1"),null,o)}}.bind(this);var c=function(t,e,o){var i=t,r=e,s=" 0 0 0 ";if(o===u.LeftRight||o===u.RightLeft){e-=C;r+=C}if(o===u.TopBottom||o===u.BottomTop){t-=C;i+=C}if(o===u.BottomTop||o===u.LeftRight){s=" 0 0 1 "}return"M"+t+" "+e+"A"+C+" "+C+s+" "+i+" "+r};this._bFocusRendered=false;if(this._isIgnored()){return""}if(!this.getVisible()){o.openStart("g",r);o.style("display","none");o.attr("data-sap-ui",r);o.openEnd();o.close("g");return}s=this._createPath();this._renderControl("g",{class:"sapSuiteUiCommonsNetworkLine "+this._getStatusClass()+i,id:r,"data-sap-ui":r},false,o);g("sapSuiteUiCommonsNetworkLineInvisibleWrapper","invisibleWrapper",true);g("","path");if(this.getArrowOrientation()!==p.None&&this.getCoordinates().length>=2){if(this.getArrowOrientation()===p.Both){if(this.getArrowPosition()===a.Middle){d(p.ParentOf,a.Middle)}else{d(p.ChildOf,a.Start,"arrow");d(p.ParentOf,a.End,"arrow1")}}else{d()}}if(this._aNipples){var f=h?h:"";this._aNipples.forEach(function(t){o.openStart("path");this.applyStyles(o,this.getStyleObject(f));o.class("sapSuiteUiCommonsNetworkLineNipple");o.attr("d",c(t.x,t.y,t.orientation));o.openEnd();o.close("path")}.bind(this))}o.close("g")};S.prototype._renderFocusWrapper=function(){var t=function(t){var e=this._createElement("path",{d:this._createPath(t),class:"sapSuiteUiCommonsNetworkLineFocus"});this.$()[0].appendChild(e)}.bind(this);if(!this._bFocusRendered){t(d);t(-d);this._bFocusRendered=true}};S.prototype._resetLayoutData=function(){this._aNipples=null};S.prototype._createPath=function(t){if(!this.getSource()||!this.getTarget()){return}var e=[{x:this.getSource().getX(),y:this.getSource().getY()}],i="M"+this.getSource().getX()+","+this.getSource().getY(),r,s,n=this._isTopBottom(),a=n?"x":"y",h=n?"getX":"getY",p=this.getBends().concat([this.getTarget()]);for(var g=0;g<p.length;g++){r=e[g-1]?e[g-1][a]:NaN;s=p[g][h]();if(Math.abs(r-p[g][h]())<2){e.pop();s=r}e.push({x:n?s:p[g].getX(),y:!n?s:p[g].getY()})}for(var u=1;u<e.length;u++){i+=" L"+e[u].x+","+e[u].y}return o.getBezierPathCorners(i,l,t)};S.prototype._getLineClass=function(){var t=function(){switch(this.getLineType()){case h.Dashed:return"sapSuiteUiCommonsNetworkDashedLine";case h.Dotted:return"sapSuiteUiCommonsNetworkDottedLine";default:return""}}.bind(this);return"sapSuiteUiCommonsNetworkLinePath "+t()};S.prototype._getArrowFragmentVector=function(t){var e=this.getCoordinates(),i=e.length-1,r=0,s=function(t){return Math.abs(e[t].getX()-e[t+1].getX())+Math.abs(e[t].getY()-e[t+1].getY())};t=t||this.getArrowPosition();if(this.getBends().length===0){r=0}else if(t===a.Start){while(r<i-1&&this._doesLineFragmentCrossCollapsedGroup(r)){r++}if(s(r)<f){r++}if(this._doesLineFragmentCrossCollapsedGroup(r)){r=0}}else if(t===a.End){r=i-1;while(r>0&&this._doesLineFragmentCrossCollapsedGroup(r)){r--}if(s(r)<f){r--}}else{var n=[],h=0;for(var p=0;p<i;p++){if(e[p].getX()===e[p+1].getX()){h+=Math.abs(e[p+1].getY()-e[p].getY())}else if(e[p].getY()===e[p+1].getY()){h+=Math.abs(e[p+1].getX()-e[p].getX())}else{h+=o.getPointsDistance({x:e[p].getX(),y:e[p].getY()},{x:e[p+1].getX(),y:e[p+1].getY()})}n.push(h)}h=h/2;for(p=0;p<i&&r===0;p++){if(n[p]>=h&&!this._doesLineFragmentCrossCollapsedGroup(p)){r=p}}}if(r<0||r>i-1){r=0}return{center:{x:e[r].getX(),y:e[r].getY()},apex:{x:e[r+1].getX(),y:e[r+1].getY()}}};S.prototype._doesLineFragmentCrossCollapsedGroup=function(t){var e=this.getParent(),i=this.getCoordinates()[t],r=this.getCoordinates()[t+1];return e.getGroups().some(function(t){return t.getCollapsed()&&o.doLineRectangleIntersect({p1:{x:Math.min(i.getX(),r.getX())+1,y:Math.min(i.getY(),r.getY())+1},p2:{x:Math.max(i.getX(),r.getX())-1,y:Math.max(i.getY(),r.getY())-1}},{p1:{x:t.getX(),y:t.getY()},p2:{x:t.getX()+t._iWidth,y:t.getY()+t._iHeight}})})};S.prototype._getArrowPoints=function(t,e){var i,r,s,n,h=[];t=t||this.getArrowOrientation();e=e||this.getArrowPosition();var u=function(u){var l=f;if(e===a.Middle){s={x:(r.apex.x-r.center.x)*c+r.center.x,y:(r.apex.y-r.center.y)*c+r.center.y}}else{if(!(this.getToNode()._oGroup&&this.getToNode()._oGroup.getCollapsed())&&this.getToNode().getShape()===g.Circle&&e===a.End){l+=this.getToNode()._getCircleSize()/2}else if(!(this.getFromNode()._oGroup&&this.getFromNode()._oGroup.getCollapsed())&&this.getFromNode().getShape()===g.Circle&&e===a.Start){l+=this.getFromNode()._getCircleSize()/2}i=o.getNormalizedVector(r,l);if(e===a.Start){s=r.center}else if(e===a.End){i=o.getRotatedVector(i,Math.PI);s=r.apex}s=o.getPointSum(s,i.apex)}n=o.getAngleOfVector(r);if(t===p.ChildOf){n+=Math.PI}h.push(o.getPointSum(s,o.getRotatedPoint(u,n)))}.bind(this);r=this._getArrowFragmentVector(e);if(this._isBothMiddleArrow()){u(m.Apex);u(m.Second);u(m.Third);u(_.Apex);u(_.Second);u(_.Third)}else{u(y.Apex);u(y.Second);u(y.Third)}return h};S.prototype._getAccessibilityLabel=function(){var t=this.getFromNode().getTitle();var e=t?t:this.getFromNode().getAltText();var o=this.getToNode().getTitle();var i=o?o:this.getToNode().getAltText();return v.getText("NETWORK_GRAPH_ACCESSIBILITY_LINE_LABEL",[e,i])+" "+this.getTitle()};S.prototype.getFromNode=function(){this._checkForProcessData();if(!this._oFrom&&this.getParent()){this._oFrom=this.getParent().getNodeByKey(this.getFrom())}return this._oFrom};S.prototype.getToNode=function(){this._checkForProcessData();if(!this._oTo&&this.getParent()){this._oTo=this.getParent().getNodeByKey(this.getTo())}return this._oTo};S.prototype.setSource=function(t){var e;if(this.getCoordinates().length===0){e=new i;this.addAggregation("coordinates",e,true)}e=this.getCoordinates()[0];if(t.x||t.x===0){e.setX(t.x)}if(t.y||t.y===0){e.setY(t.y)}};S.prototype.getSource=function(){return this.getCoordinates()[0]};S.prototype.getTarget=function(){return this.getCoordinates().length>0?this.getCoordinates()[this.getCoordinates().length-1]:null};S.prototype.setTarget=function(t){var e;if(this.getCoordinates().length<2){e=new i;this.addAggregation("coordinates",e,true)}e=this.getCoordinates()[this.getCoordinates().length-1];if(t.x||t.x===0){e.setX(t.x)}if(t.y||t.y===0){e.setY(t.y)}};S.prototype.getBends=function(){return this.getCoordinates().filter(function(t,e){return e>0&&e<this.getCoordinates().length-1},this)};S.prototype.clearBends=function(){this.getBends().forEach(function(t){this.removeAggregation("coordinates",t,true)},this)};S.prototype.addBend=function(t){var e=new i;e.setX(t.x);e.setY(t.y);this.insertAggregation("coordinates",e,this.getCoordinates().length-1,true);return e};S.prototype.isHidden=function(){return this._bIsHidden};S.prototype.getKey=function(){return this._getLineId()};S.prototype.setHidden=function(t){this.$()[t?"hide":"show"]()};S.prototype._isIgnored=function(){var t=this.getFromNode(),e=this.getToNode(),o=t._oGroup&&t._oGroup.getCollapsed()&&e._oGroup&&e._oGroup.getCollapsed()&&t._oGroup===e._oGroup,i=!t._useInLayout()||!e._useInLayout();return!this._useInLayout||o||this._isLoop()||i};S.prototype._isLoop=function(){return this.getFromNode().getId()===this.getToNode().getId()};S.prototype._getLineId=function(){return this._sKey?this._sKey:"line_"+this.getFrom()+"-"+this.getTo()};S.prototype._setupEvents=function(){var t=this.$().find(".sapSuiteUiCommonsNetworkLineInvisibleWrapper");t.on("click",function(t){this._click({ctrlKey:t.ctrlKey,clientX:t.clientX,clientY:t.clientY})}.bind(this));t.on("mouseover",function(t){this._mouseOver()}.bind(this));t.on("mouseout",function(t){this._mouseOut()}.bind(this))};S.prototype._mouseOut=function(){this.$().removeClass(this.HIGHLIGHT_CLASS);if(!this.getSelected()){this._setStatusColors("")}};S.prototype._mouseOver=function(){var t=this.fireEvent("hover",{},true);if(!this.getSelected()&&t){this._setStatusColors("Hover");this.$().addClass(this.HIGHLIGHT_CLASS)}};S.prototype._setStatusColors=function(t){var o=this.$().find(".sapSuiteUiCommonsNetworkLineArrow"),i=this._getColor(e.ColorType[t+"Border"]),r=this._getColor(e.ColorType[t+"Background"]);o.css("fill",r);o.css("stroke",i);this.$("path").css("stroke",i);if(this.getParent()&&this.getParent()._isSwimLane()){var s=this.$().find(".sapSuiteUiCommonsNetworkLineNipple");s.css("fill",r);s.css("stroke",i)}};S.prototype._showActionButtons=function(t){var e=function(t,e,o){var r=i(t,e,o);if(r){t._setNodeOpacity(true);a._aShadedNodes.push(t)}return r};var i=function(t,e,i){return o.hasRectangleRectangleIntersection({p1:{x:S,y:v},p2:{x:i,y:e}},t._getContentRect())};var r=function(t,e){return{p1:{x:t.x,y:t.y},p2:{x:e.x,y:e.y}}};var s=0;var n=function(t,e){if(s<2){var o=jQuery("<div></div>",{class:t,css:{top:e.top,left:e.left,right:e.right,bottom:e.bottom}});g.append(o);s++}};var a=this.getParent(),h=a.$("divlinebuttons"),g=a.$("linetooltip"),u=a.$("linetooltipbuttons");var l=this.getFromNode(),d=this.getToNode();var c=10;a._aShadedNodes=[];var f=l.getTitle();var y=f?f:l.getAltText();var m='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipText">'+y+"</span>";if(this._isBothArrow()){m+='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipArrow sapSuiteUiCommonsNetworkGraphLineTooltipDualArrow"></span>'+'<span class="sapSuiteUiCommonsNetworkGraphLineTooltipArrow"></span>'+"</br>"}else if(this.getArrowOrientation()===p.ChildOf){m+='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipArrow"></span>'+"</br>"}else if(this.getArrowOrientation()===p.ParentOf){m+='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipArrow"></span>'+"</br>"}else{m+='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipArrow"></span>'+"</br>"}var _=d.getTitle();var C=_?_:d.getAltText();m+='<span class="sapSuiteUiCommonsNetworkGraphLineTooltipText">'+C+"</span>";g.html(m);u.html("");this.getActionButtons().forEach(function(t){this._appendActionButton({icon:t.getIcon(),enable:t.getEnabled(),title:t.getTitle(),id:t.getId(),click:function(e){t.firePress({buttonElement:e.target})}},u)}.bind(this));h.show();var v=t.y-g.outerHeight()/2,S=t.x-g.outerWidth()/2,T=v+g.outerHeight(),w=S+g.outerWidth();e(d,T,S+h.width());var x=e(l,v+g.height(),S),A=e(d,T,S+g.outerWidth()+c);if(a._isLayered()){var N={x:S,y:v};var L={x:w,y:v};var P={x:w,y:T};var b={x:S,y:T};var F=this.getCoordinates();for(var B=0;B<F.length-1&&s<2;B++){var k=F[B],I=F[B+1];var O={x:k.getX(),y:k.getY()};var G={x:I.getX(),y:I.getY()};var Y=r(O,G);var X=o.getSegmentsIntersection(Y,r(N,b));if(X&&!x){n("sapSuiteUiCommonsNetworkGraphTooltipLeftArrow",{top:X.y-v-c})}X=o.getSegmentsIntersection(Y,r(L,P));if(X&&!A){n("sapSuiteUiCommonsNetworkGraphTooltipRightArrow",{top:X.y-v-c})}X=o.getSegmentsIntersection(Y,r(b,P));if(X){n("sapSuiteUiCommonsNetworkGraphTooltipBottomArrow",{left:X.x-S-c})}X=o.getSegmentsIntersection(Y,r(N,L));if(X){n("sapSuiteUiCommonsNetworkGraphTooltipTopArrow",{left:X.x-S-c})}}h.css("top",v+"px");h.css("left",S+"px")}};S.prototype._hasVisibleActionButtons=function(){return this.getParent().$().find(".sapSuiteUiCommonsNetworkGraphLineButtons").is(":visible")};S.prototype._getEnabledActionButtons=function(){var t=[];this.getActionButtons().forEach(function(e){if(e.getEnabled()&&e.getDomRef()){t.push(e.getDomRef())}});return t};S.prototype._setActionButtonFocus=function(t,e){var o=this.getParent().$("divlinebuttons");o.removeClass(this.FOCUS_CLASS);o.find("."+this.FOCUS_CLASS).removeClass(this.FOCUS_CLASS);jQuery(t).toggleClass(this.FOCUS_CLASS,e)};S.prototype._click=function(t){var e=this.getParent(),o=t.skipConversion?{x:t.clientX,y:t.clientY}:e.getCorrectMousePosition({x:t.clientX,y:t.clientY}),i=e._tooltip._getOpener(this,o),r;e._selectLine({element:this,forceFocus:true,preventDeselect:t.ctrlKey});r=this.fireEvent("press",{opener:i,point:o},true);if(this.getSelected()&&r){this.getActionButtons().length===0?e._tooltip.openDetail({item:this,opener:i,point:o}):this._showActionButtons(o)}};S.prototype._setFocus=function(t){e.prototype._setFocus.call(this,t);if(t){this._renderFocusWrapper()}};S.prototype._isEndPosition=function(){return this.getArrowPosition()===a.End&&this.getArrowOrientation()===p.ParentOf||this.getArrowPosition()===a.Start&&this.getArrowOrientation()===p.ChildOf};S.prototype._moveToEnd=function(){return this._isEndPosition()||this.getArrowPosition()===a.Middle&&this.getArrowOrientation()===p.ParentOf};S.prototype._hideShow=function(t){if(t){this.$().hide();this._bIsHidden=true}else if(!this.getToNode()._bIsHidden&&!this.getFromNode()._bIsHidden){this.$().show();this._bIsHidden=false}};S.prototype._shift=function(t){this.getBends().forEach(function(e){e.setX(e.getX()+t.x);e.setY(e.getY()+t.y)});if(this.getSource()){this.setSource({x:this.getSource().getX()+t.x,y:this.getSource().getY()+t.y})}if(this.getTarget()){this.setTarget({x:this.getTarget().getX()+t.x,y:this.getTarget().getY()+t.y})}if(this._aNipples){this._aNipples.forEach(function(e){e.x+=t.x;e.y+=t.y})}};S.prototype._normalizePath=function(){var t,e;t=this.getFromNode().getCenterPosition();this.setSource({x:t.x,y:t.y});e=this.getToNode().getCenterPosition();this.setTarget({x:e.x,y:e.y});this.clearBends()};S.prototype._validateLayout=function(){return(!this.getSource()||isFinite(this.getSource().getX())&&isFinite(this.getSource().getY()))&&(!this.getTarget()||isFinite(this.getTarget().getX())&&isFinite(this.getTarget().getY()))&&!this.getBends().some(function(t){return!isFinite(t.getX())||!isFinite(t.getY())})};S.prototype.setSelected=function(t){var e=this.getParent(),o=t?"addClass":"removeClass";this._setStatusColors(t?"Selected":"");this.setProperty("selected",t,true);this.$()[o](this.SELECT_CLASS);if(e){if(t){e._mSelectedLines[this._getLineId()]=this}else{this._setStatusColors("");delete e._mSelectedLines[this._getLineId()]}}return this};S.prototype.setFrom=function(t){var e=this.getParent();this.setProperty("from",t,true);if(e){e.invalidate()}return this};S.prototype.setTo=function(t){var e=this.getParent();this.setProperty("to",t,true);if(e){e.invalidate()}return this};S.prototype._isTopBottom=function(){var t=this.getParent();return t&&t._isTopBottom()};S.prototype.getFocusDomRef=function(){return this.getDomRef("invisibleWrapper")};S.prototype._createSuggestionHelpText=function(){var t=25;var e=this.getTitle()?this.getTitle()+" ":"";var o=this.getFromNode().getTitle();var i=o?o:this.getFromNode().getAltText();var s=this.getToNode().getTitle();var n=s?s:this.getToNode().getAltText();return e+"("+r.trimText(i,t)+" -> "+r.trimText(n,t)+")"};S.prototype._isInCollapsedGroup=function(){var t=this.getFromNode(),e=this.getToNode();return t._oGroup===e._oGroup&&t._isInCollapsedGroup()};S.prototype._isBothMiddleArrow=function(){return this.getArrowOrientation()===p.Both&&this.getArrowPosition()===a.Middle};S.prototype._isBothArrow=function(){return this.getArrowOrientation()===p.Both};S.prototype._isOnScreen=function(t,o,i,r){var s=this.getCoordinates(),n,a;for(n=1;n<s.length;n++){a=e._isRectOnScreen(s[n-1].getX(),s[n].getX(),s[n-1].getY(),s[n].getY(),t,o,i,r);if(a){return true}}return false};return S});
//# sourceMappingURL=Line.js.map