sap.ui.define(["sap/suite/ui/commons/BasePanel","sap/ui/model/json/JSONModel","sap/suite/ui/commons/MenuButton","sap/m/Button","./util/BatchHelper","sap/ui/Device","sap/f/GridList","sap/ui/layout/cssgrid/GridBasicLayout","sap/base/Log","sap/m/VBox","sap/m/HeaderContainer","sap/m/Popover","sap/m/List","sap/m/StandardListItem","sap/m/library","sap/ui/core/library","sap/m/IllustratedMessage","sap/f/Card","sap/ui/core/format/DateFormat"],function(t,e,s,o,i,r,n,a,l,h,d,u,p,c,_,g,f,D,y){"use strict";const C=_.URLHelper;const m=_.Priority?_.Priority:g.Priority;const T=y.getDateTimeInstance({style:"medium",relative:true,relativeStyle:"short"});const I={SITUATION_ICON:"sap-icon://message-warning",PLACEHOLDER_ITEMS_COUNT:5,TODO_CARDS_LIMIT:5e3,TODO_SECTION_LIMIT:6,TODOS_REFRESH_INTERVAL:65e3,MOBILE_DEVICE_MAX_WIDTH:600};const P=t=>{const e=320;const s=400;const o=14.5;let i=1;let r=e;while(t/i>=e+o){r=t/i;i+=1}r-=o;return r>s?s:r};const M=(t,e)=>{const s={};const o=(t,e)=>parseFloat(window.getComputedStyle(t,null).getPropertyValue(e));e.forEach(e=>{s[e]=o(t,e)});return s};const E=t.extend("sap.suite.ui.commons.ToDoPanel",{metadata:{properties:{serviceUrl:{type:"string",group:"Misc",defaultValue:""},countUrl:{type:"string",group:"Misc",defaultValue:""},dataUrl:{type:"string",group:"Misc",defaultValue:""},targetAppUrl:{type:"string",group:"Misc",defaultValue:""}}}});E.prototype.init=function(){this._oData={length:0,isLoaded:false,hasError:false,cardWidth:"20rem",getSupported:false,isExpandedOnce:false,isCountCalledOnce:false,illustrationType:"sapIllus-NoTasks",refreshInfo:this.toRelativeDateTime(new Date),todoHorizontalCardCount:I.PLACEHOLDER_ITEMS_COUNT,illustrationTitle:this.getResourceBundle().getText("noToDoTitle"),illustrationDescription:this.getResourceBundle().getText("noToDoDesc"),isPhone:r.resize.width<I.MOBILE_DEVICE_MAX_WIDTH||r.system.phone,tiles:new Array(I.PLACEHOLDER_ITEMS_COUNT).fill({status:"Loading"}),displayTiles:new Array(I.PLACEHOLDER_ITEMS_COUNT).fill({status:"Loading"})};this._controlModel=new e(this._oData);this.setModel(this._controlModel,"_toDos");this.requests=[];this._toDoWrapper=new h(`${this.getId()}-toDosWrapper`,{items:[this._generateCardContainer(),this._generateMobileCardContainer(),this._generateErrorMessage()]});this.addContent(this._toDoWrapper);this.addAggregation("menuButtons",new s(`${this.getId()}-menuButton`,{icon:"sap-icon://slim-arrow-down",press:this._onPressMenuButton.bind(this)}));this._refreshBtn=new o(`${this.getId()}-refreshBtn`,{icon:"sap-icon://refresh",text:this.toRelativeDateTime(new Date),press:this._onPressRefresh.bind(this)});this.addAggregation("actionButtons",this._refreshBtn);t.prototype.init.apply(this,arguments)};E.prototype._onPressRefresh=function(){this.getParent()?.getSelectedPanel()?.loadToDos()};E.prototype._generateCardContainer=function(){if(!this.cardContainer){this.cardContainer=new n(`${this.getId()}-flexContainer`,{visible:"{= !${_toDos>/isPhone} && !${_toDos>/hasError} && (!${_toDos>/isLoaded} || ${_toDos>/length} > 0) }",showNoData:false,customLayout:new a(`${this.getId()}-layout`,{gridTemplateColumns:"repeat({_toDos>/todoHorizontalCardCount}, {_toDos>/cardWidth})",gridGap:"1rem"})}).addStyleClass("sapUiToDoCardsContainer");this.cardContainer.setModel(this._controlModel,"_toDos")}this.cardContainer.bindAggregation("items",{path:"_toDos>/displayTiles",length:1e3,factory:this.generateCardTemplate.bind(this)});return this.cardContainer};E.prototype._generateMobileCardContainer=function(){if(!this.mobileCardContainer){this.mobileCardContainer=new d(`${this.getId()}-headerContainer`,{visible:"{_toDos>/isPhone}",scrollStep:0,gridLayout:true,scrollTime:1e3,showDividers:false});this.mobileCardContainer.addStyleClass("sapMHeaderContainerAlign");this.mobileCardContainer.addStyleClass("sapMHeaderContainerToDoAlign");this.mobileCardContainer.addStyleClass("toDoCardHeight");this.mobileCardContainer.setModel(this._controlModel,"_toDos")}this.mobileCardContainer.bindAggregation("content",{path:"_toDos>/displayTiles",length:1e3,factory:this.generateCardTemplate.bind(this)});return this.mobileCardContainer};E.prototype._generateErrorMessage=function(){if(!this.errorCard){this.errorMessage=new f(`${this.getId()}-errorMessage`,{illustrationSize:"Spot",title:"{_toDos>/illustrationTitle}",description:"{_toDos>/illustrationDescription}",illustrationType:"{_toDos>/illustrationType}"});this.errorCard=new D(`${this.getId()}-errorCard`,{content:[this.errorMessage],visible:"{= ${_toDos>/tiles/length} === 0 || ${_toDos>/hasError} === true }"});this.errorCard.setModel(this._controlModel,"_toDos")}return this.errorCard};E.prototype._onPressMenuButton=function(t){if(!this._menuPopover){this._menuPopover=new u(`${this.getId()}-popover`,{placement:"VerticalPreferredBottom",showHeader:false,content:[new p(`${this.getId()}-list`,{itemPress:this._closePopover.bind(this),items:[new c(`${this.getId()}-viewAllListItem`,{type:"Active",icon:"sap-icon://inbox",title:this.getViewAllItemsText(),press:this.onPressViewAll.bind(this)}),new c(`${this.getId()}-refreshItems`,{type:"Active",icon:"sap-icon://refresh",title:this.getResourceBundle().getText("refresh"),press:this._onPressRefresh.bind(this)})]})]})}this._menuPopover.openBy(t.getParameter("button"))};E.prototype._closePopover=function(){this._menuPopover.close()};E.prototype.onPressViewAll=function(){C.redirect(this.getTargetAppUrl(),false)};E.prototype.setSupported=function(t){this._oData.getSupported=t};E.prototype.getSupported=function(){return this._oData.getSupported};E.prototype.getAppIntent=function(){const t=/#([^-\?]+)-([^?#]+)(\?(.+))?/;const e=this.getTargetAppUrl().match(t);if(e){const t={semanticObject:e[1],action:e[2]};const s={};if(e[4]){const t=e[4].split("&");for(const e of t){const[t,o]=e.split("=");s[t]=o}}return{target:t,params:s}}else{return null}};E.prototype._generateRequestObject=function(t){const e=this._calculateCardCount();const s=[this.getCountUrl(),`${this.getDataUrl()}&$skip=0&$top=${e}`];if(t&&t.excludeCount){s.shift()}else if(t&&t.onlyCount){s.splice(1,1)}return{rootURL:`${this.getServiceUrl()}$batch`,requestURLs:s,success:(...e)=>{const[s,o]=t&&t.excludeCount?[e[0],e[1]]:e;this._oData.length=s;if(!t||t&&!t.onlyCount){this.processData(o);this._handleEmptyCards()}}}};E.prototype._handleEmptyCards=function(){if(this._oData.length===0){this._oData.illustrationType="sapIllus-EmptyPlanningCalendar";this._oData.illustrationTitle=this.isExclusivePanel()?this.getResourceBundle().getText("noToDoTitle"):this.getResourceBundle().getText(this.getNoDataText());this._oData.illustrationDescription=this.isExclusivePanel()?this.getResourceBundle().getText("noToDoDesc"):this.getResourceBundle().getText("emptyToDoDesc")}};E.prototype.submitBatch=function(){return Promise.all(this.requests.map(async t=>{try{const e=await i.createMultipartRequest(t.rootURL,t.requestURLs);if(e.length){const s=e.map(t=>{if(typeof t==="string"){t=JSON.parse(t)}return t&&t.d&&t.d.results||t&&t.d&&!isNaN(+t.d)&&+t.d||!isNaN(+t)&&+t||0});if(t.success&&typeof t.success==="function"){t.success.apply(t,s)}return s}else{throw new Error("Invalid response")}}catch(t){this._handleError(t)}finally{this.clearRequests()}}))};E.prototype._handleError=function(t){this._oData.displayTiles=this._oData.tiles=[];this._oData.getSupported=this._oData.isLoaded=this._oData.hasError=true;this._oData.illustrationType="sapIllus-UnableToLoad";this._oData.illustrationTitle=this._oData.illustrationDescription="";l.error(t);this._controlModel.refresh()};E.prototype.clearRequests=function(){this.requests=[]};E.prototype.loadToDos=function(){if(this._loadToDos){return this._loadToDos}else{this._loadToDos=new Promise(t=>{const e=this.getParent()?.getSelectedKey();const s=[];this._oData.isLoaded=false;this._oData.isCountCalledOnce=false;this.setCount();if(this.getSupported()){this._generatePlaceHolderTiles();s.push(this._generateRequestObject({type:e,onlyCount:e!==this.getKey()}));this.requests=this.requests.concat(s);this.submitBatch().then(function(){this._oData.isLoaded=e===this.getKey();this._oData.isCountCalledOnce=true;this.setCount(this._oData.length);this._setSectionRefreshInterval();this._oData.refreshInfo=this.toRelativeDateTime(new Date);this._oData.lastRefreshedTime=new Date;this.updateRefreshInformation();if(this.isExclusivePanel()){this.getParent().setTitle(`${this.getResourceBundle().getText("toDosTitle")} (${this._oData.length})`)}}.bind(this)).finally(function(){this._controlModel.refresh();this.attachResizeHandler();this._loadToDos=undefined;t()}.bind(this))}else{this._handleError(`User not authorized to access: + ${this.getTargetAppUrl()}`);this.getParent()?.removeContent(this)}})}return this._loadToDos};E.prototype.attachResizeHandler=function(){const t=this.getParent();if(t){this._resizeObserver?.disconnect();this._resizeObserver=new ResizeObserver(this._adjustLayout.bind(this));this._resizeObserver.observe(t.getDomRef())}};E.prototype.isExclusivePanel=function(){const t=this.getParent().getContent();const e=t.filter(t=>t.getSupported());return e.length===1||t.length===1&&this.getSupported()};E.prototype._setSectionRefreshInterval=function(){clearInterval(this._oData.refreshFn);this._oData.refreshFn=setInterval(()=>{this._oData.lastRefreshedTime=this._oData.lastRefreshedTime||new Date;this._oData.refreshInfo=this.toRelativeDateTime(this._oData.lastRefreshedTime);this.updateRefreshInformation()},I.TODOS_REFRESH_INTERVAL)};E.prototype.updateRefreshInformation=function(){if(this.getParent().getSelectedKey()===this.getKey()){this._refreshBtn.setText(this._oData.refreshInfo);this.getParent()?.updateContainerHeader()}this._adjustLayout()};E.prototype._adjustLayout=function(){const t=this._calculateCardCount();const e=r.resize.width<I.MOBILE_DEVICE_MAX_WIDTH||r.system.phone;if(this._oData.tiles.length&&!this._oData.hasError){const e=this._oData.tiles.slice(0,t);this._controlModel.setProperty("/displayTiles",e);this._controlModel.setProperty("/viewAllVisible",this._oData.length>t);this._controlModel.setProperty("/viewAllUrl",this.getTargetAppUrl())}this._controlModel.setProperty("/isPhone",e)};E.prototype.isLoaded=function(){const t=this.getParent().getSelectedKey();let e=this._oData.isLoaded;if(t!==this.getKey()&&!e){e=this._oData.isCountCalledOnce}return e};E.prototype.setLoaded=function(t){this._oData.isLoaded=t};E.prototype._generatePlaceHolderTiles=function(){this._cardCount=this._calculateCardCount();this._oData.displayTiles=this._oData.tiles=new Array(this._cardCount).fill({status:"Loading"});this._oData.isLoaded=this._oData.hasError=false;this._controlModel.refresh()};E.prototype._calculateCardCount=function(){const t=this._controlModel.getProperty("/isPhone");const e=this._toDoWrapper?.getDomRef();let s=t?I.TODO_SECTION_LIMIT:1;if(e&&!t){const t=t=>{const e=M(t,["width","padding-left","padding-right","margin-left","margin-right"]);const s=Object.values(e).slice(1).reduce((t,e)=>t-e,e["width"]);const o=P(s);let i=Math.floor(s/o);i=i>0?i:1;this._controlModel.setProperty("/cardWidth",`${o/16}rem`);this._controlModel.setProperty("/todoHorizontalCardCount",i);return i};const o=t(e);s=Math.min(o,I.TODO_CARDS_LIMIT)}return s};E.prototype.toPriority=function(t){if(t==="VERY_HIGH"){return m.VeryHigh?m.VeryHigh:m.None}else if(t==="HIGH"){return m.High}else if(t==="MEDIUM"){return m.Medium}else if(t==="LOW"){return m.Low}else{return m.None}};E.prototype.toPriorityText=function(t){if(t==="VERY_HIGH"||t==="VeryHigh"){return"veryHighPriority"}else if(t==="HIGH"||t==="High"){return"highPriority"}else if(t==="MEDIUM"||t==="Medium"){return"mediumPriority"}else if(t==="LOW"||t==="Low"){return"lowPriority"}else{return"nonePriority"}};E.prototype.toRelativeDateTime=function(t){return T.format(new Date(t))};return E});
//# sourceMappingURL=ToDoPanel.js.map