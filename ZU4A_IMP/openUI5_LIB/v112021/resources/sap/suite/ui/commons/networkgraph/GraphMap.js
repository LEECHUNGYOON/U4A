/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./SvgBase","sap/ui/core/ResizeHandler","./GraphMapRenderer","sap/ui/core/Core","sap/ui/core/Lib"],function(jQuery,t,e,i,r,s){"use strict";var o=4;var a=s.getResourceBundleFor("sap.suite.ui.commons");var h=t.extend("sap.suite.ui.commons.networkgraph.GraphMap",{metadata:{library:"sap.suite.ui.commons",properties:{height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},directRenderNodeLimit:{type:"int",group:"Behavior",defaultValue:250},title:{type:"string",group:"Misc",defaultValue:""}},associations:{graph:{type:"sap.suite.ui.commons.networkgraph.Graph",multiple:false,singularName:"graph"}},events:{mapReady:{}}}});h.prototype.init=function(){this._oResizeListener=null;this.setBusyIndicatorDelay(0)};h.prototype.onAfterRendering=function(){var t=this.getGraph();if(t&&t._bIsLayedOut){this._renderMap()}else{this.setBusy(true)}};h.prototype._renderMap=function(){var t=this.getGraph();if(!t){return}var e,i,s,a,h,n,p,d=this,u=t._fZoomLevel,g=t.getNodes().length===0,l=t._isUseNodeHtml(),f="";var c=function(t,e){if(e){t.forEach(function(t){t._render({mapRender:true,idSufix:d.getId(),renderManager:e})})}else{t.forEach(function(t){f+=t._render({mapRender:true,idSufix:d.getId()})})}};var m=function(t,e){var i=r.createRenderManager();t.forEach(function(t){t._render({mapRender:true,renderManager:i,idSufix:d.getId()})});i.flush(e);i.destroy()};var v=function(){var e=r.createRenderManager();t.getGroups().forEach(function(t){t._render({mapRender:true,renderManager:e,idSufix:d.getId()})});e.flush(this.getDomRef("divgroups"));e.destroy()}.bind(this);var _=function(e,i){if(!i){a+=this._renderControl("rect",{x:o/2,y:o/2,width:Math.min((t.$scroller.width()-o/2)/u,(t.$svg.width()-o/2)/u),height:Math.min((t.$scroller.height()-o/2)/u,(t.$svg.height()-o/2)/u),class:e,id:this._getDomId("mapNavigator")})}else{this._renderControl("rect",{x:o/2,y:o/2,width:Math.min((t.$scroller.width()-o/2)/u,(t.$svg.width()-o/2)/u),height:Math.min((t.$scroller.height()-o/2)/u,(t.$svg.height()-o/2)/u),class:e,id:this._getDomId("mapNavigator")},null,i)}}.bind(this);if(!t._iWidth||!t._iHeight||g){if(t._bIsInvalid||g){this.setBusy(false);this.$().find(".sapSuiteUiCommonsNetworkGraphMapContent").html("");this.fireMapReady()}return}e=t.$("networkGraphSvg").attr("viewBox");if(!e){e="0 0 "+t._iWidth+" "+t._iHeight}var y=r.createRenderManager();y.openStart("svg",this._getDomId("svg"));y.attr("width","100%");y.attr("height","100%");y.class("sapSuiteUiCommonsNetworkGraphMapSvg");y.attr("viewBox",e);y.attr("aria-hidden","true");if(t._bIsRtl){y.attr("direction","rtl")}y.openEnd();if(this._useGraphClone()){this._renderControl("use",{"xlink:href":"#"+t._getDomId("svgbody")},null,y)}else{c(t.getLines(),y);if(!l){c(t.getNodes(),y)}}this._renderControl("rect",{x:0,y:0,width:t._iWidth,height:t._iHeight,class:"sapSuiteUiCommonsNetworkGraphMapBoundary","pointer-events":"fill"},null,y);if(!l){_("sapSuiteUiCommonsNetworkGraphMapNavigator",y)}y.close("svg");y.openStart("div",this._getDomId("divgroups"));y.class("sapSuiteUiCommonsNetworkGraphMapDivGroups");if(r.getConfiguration().getRTL()){y.class("sapSuiteUiCommonsNetworkGraphMapDivGroupsLeft")}y.openEnd();y.close("div");if(l){y.openStart("div",this._getDomId("divnodes"));y.class("sapSuiteUiCommonsNetworkGraphMapDivNodes");if(r.getConfiguration().getRTL()){y.class("sapSuiteUiCommonsNetworkGraphMapDivGroupsLeft")}y.openEnd();y.close("div");y.openStart("svg");y.class("sapSuiteUiCommonsNetworkGraphSvgNavigator");y.attr("width","100%");y.attr("height","100%");y.attr("viewBox",e);y.openEnd();_("sapSuiteUiCommonsNetworkGraphMapNavigator",y);y.close("svg")}var G=this.$();y.flush(G.find(".sapSuiteUiCommonsNetworkGraphMapContent")[0],true,false);y.destroy();v();if(l){var w=this.getDomRef("divnodes");m(t.getNodes(),w)}h=this.$("svg");i=t._iWidth;s=t._iHeight;n=Math.max(i/h.width(),s/h.height());this._setHtmlNodesPosition(n);p=Math.ceil(n/5);this._iStrokeWidth=p;this._correctLineWidth();this.$("svg").find("circle").css("stroke-width",p+"px");this._setupEvents();this._correctPosition();this.setBusy(false);this.fireMapReady()};h.prototype._setHtmlNodesPosition=function(t){var e=this.getGraph(),i=this.$("svg"),r=1/t,s,o;s=Math.floor(i.width()/2-e._iWidth/2*r);o=Math.floor(i.height()/2-e._iHeight/2*r);this.$("divgroups").css("transform","matrix("+r+", 0, 0, "+r+", "+s+", "+o+")");if(e._isUseNodeHtml){this.$("divnodes").css("transform","matrix("+r+", 0, 0, "+r+", "+s+", "+o+")")}};h.prototype._useGraphClone=function(){var t=this.getDirectRenderNodeLimit(),e=this.getGraph();if(e){return t>e.getNodes().length&&!e._isUseNodeHtml()}return false};h.prototype._correctLineWidth=function(t){var t=this.getGraph(),e=this._isMSBrowser()||(!this._useGraphClone()||t._preventZoomToChangeLineWidth());this.$("svg").css("stroke-width",e?this._iStrokeWidth+"px":"1px")};h.prototype._correctMapNavigator=function(){var t=this.$("mapNavigator"),e=parseFloat(t.attr("width")),i=parseFloat(t.attr("height")),r=parseFloat(t.attr("x")),s=parseFloat(t.attr("y")),o=this.getGraph(),a=o._iWidth,h=o._iHeight;if(e+r>a){t.attr("width",a-r)}if(i+s>h){t.attr("height",h-s)}};h.prototype._resize=function(){var t=this.getGraph(),e=t.$scroller,i=this.$("mapNavigator");i.attr("x",Math.max(o/2,e[0].scrollLeft/t._fZoomLevel));i.attr("y",Math.max(o/2,e[0].scrollTop/t._fZoomLevel));i.attr("width",e.width()/t._fZoomLevel);i.attr("height",e.height()/t._fZoomLevel);this._correctLineWidth();this._correctMapNavigator()};h.prototype._resizeHandler=function(){this._resize();var t=this.getGraph();if(t._isUseNodeHtml()){var e=this.$("svg"),i=this.getGraph().$svg;if(i){var r=Math.max(i.width()/e.width(),i.height()/e.height())*(1/t._fZoomLevel);this._setHtmlNodesPosition(r)}}};h.prototype._correctPosition=function(){var t=this.getGraph(),e=t&&t.$scroller,i=this.$("mapNavigator");if(t&&e[0]){i.attr("x",Math.max(o/2,e[0].scrollLeft/t._fZoomLevel));i.attr("y",Math.max(o/2,e[0].scrollTop/t._fZoomLevel));this._correctMapNavigator()}};h.prototype._setupEvents=function(){var t=false,e=this.getGraph(),i=this.$("svg"),r=e.$scroller;var s=function(t){var s=e.$svg,o=Math.max(s.width()/i.width(),s.height()/i.height()),a=i.find(".sapSuiteUiCommonsNetworkGraphMapBoundary"),h=r[0],n=a.offset().left,p=a.offset().top;h.scrollLeft=(t.pageX-n)*o-r.width()/2;h.scrollTop=(t.pageY-p)*o-r.height()/2};var o=function(){i.removeClass("sapSuiteUiCommonsNetworkGraphPanning");t=false};r.on("scroll",function(){this._correctPosition()}.bind(this));i.off();i.on("mousedown",function(e){t=true;s(e);e.preventDefault()});i.on("mousemove",function(e){if(t){if(!i.hasClass("sapSuiteUiCommonsNetworkGraphPanning")){i.addClass("sapSuiteUiCommonsNetworkGraphPanning")}s(e)}});i.on("mouseleave",function(t){o()});i.on("mouseup",function(t){o()})};h.prototype._onBeforeDataProcess=function(){if(this.getDomRef("svg")){this.$("svg").html("");this.setBusy(true)}};h.prototype._onGraphReady=function(){if(this.getVisible()){setTimeout(this._renderMap.bind(this),0);if(this._oResizeListener){e.deregister(this._oResizeListener)}this._oResizeListener=e.register(this.getGraph().$("wrapper")[0],jQuery.proxy(this._resizeHandler,this))}};h.prototype._removeListeners=function(){var t=this.getGraph();if(t){t.detachBeforeLayouting(this._onBeforeDataProcess,this);t.detachGraphReady(this._onGraphReady,this);t.detachZoomChanged(this._resize,this)}};h.prototype.destroy=function(){this._removeListeners();t.prototype.destroy.apply(this,arguments)};h.prototype.exit=function(){if(this._oResizeListener){e.deregister(this._oResizeListener);this._oResizeListener=null}};h.prototype.getTitle=function(){var t=this.getProperty("title");return t?t:a.getText("NETWORK_GRAPH_MAP_TITLE")};h.prototype.getGraph=function(){var t=this.getAssociation("graph");return t?r.byId(t):null||null};h.prototype.setGraph=function(t){this._removeListeners();this.setAssociation("graph",t);var e=this.getGraph();if(e){e.attachBeforeLayouting(this._onBeforeDataProcess,this);e.attachGraphReady(this._onGraphReady,this);e.attachZoomChanged(this._resize,this);if(e._isLayedOut()){this._onGraphReady()}}return this};return h});
//# sourceMappingURL=GraphMap.js.map