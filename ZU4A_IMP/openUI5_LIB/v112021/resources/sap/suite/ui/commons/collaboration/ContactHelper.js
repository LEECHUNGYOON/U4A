sap.ui.loader.config({shim:{"sap/suite/ui/commons/thirdparty/msal-browser":{amd:true,exports:"msal-browser"}}});sap.ui.define(["sap/ui/core/mvc/Controller","sap/suite/ui/commons/collaboration/GraphApiConfig","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/library","sap/ui/core/Core","sap/ui/model/resource/ResourceModel","sap/suite/ui/commons/thirdparty/msal-browser"],function(e,t,n,o,i,s,r){"use strict";var a=s.getLibraryResourceBundle("sap.suite.ui.commons");return e.extend("sap.suite.ui.commons.collaboration.ContactHelper",{constructor:function(e){if(e&&Object.keys(e).length){this.oGraphApiConfig=t.getConfig(e);this.myMSALObj=new msal.PublicClientApplication(this.oGraphApiConfig.msalConfig)}},handleMultipleAccounts:function(){var e=myMSALObj.getAllAccounts();if(e.length===0){console.warn("No account detected.")}else if(e.length>1){console.warn("Multiple accounts detected.")}else if(e.length===1){this.sUserName=e[0].username}},callApi:function(e,t){var n=new Headers;var o="Bearer "+t;n.append("Authorization",o);return fetch(e,{method:"GET",headers:n})},signIn:function(){return this.myMSALObj.loginPopup(this.oGraphApiConfig.loginRequest).then(function(e){if(e!==null){this.sUserName=e.account.username}else{this.handleMultipleAccounts()}return Promise.resolve(this.myMSALObj.getAccountByUsername(this.sUserName))}.bind(this)).catch(function(e){return Promise.reject(e)})},getAccount:function(){if(this.sUserName){return Promise.resolve(this.myMSALObj.getAccountByUsername(this.sUserName))}else{return this.signIn()}},getToken:function(e){return new Promise(function(t,n){this.getAccount().then(function(t){e.account=t;return this.myMSALObj.acquireTokenSilent(e)}.bind(this)).then(function(e){this.loginResponse=e;t(e)}.bind(this)).catch(function(o){if(o instanceof msal.InteractionRequiredAuthError){this.myMSALObj.acquireTokenPopup(e).then(function(e){this.loginResponse=e;t(e)}).catch(function(){console.error(o);n(o)})}else{console.error(o);n(o)}})}.bind(this))},getFullProfileByEmail:function(e){return this.getToken(this.oGraphApiConfig.loginRequest).then(function(t){var n=this.callApi(this.oGraphApiConfig.graphApiEndpoints.graphUserEndpoint+"/"+e+"?$select=displayName,jobTitle,mail,mobilePhone,officeLocation,businessPhones,department,employeeOrgData",t.accessToken).then(function(e){return e.json()});var o=this.callApi(this.oGraphApiConfig.graphApiEndpoints.graphUserEndpoint+"/"+e+"/presence",t.accessToken).then(function(e){return e.json()});var i=this.getPhotoByEmail(e);return Promise.all([n,o,i]).then(function(e){var t=Object.assign(e[0],e[1]);t.photo=e[2];return t})}.bind(this))},getPhotoByEmail:function(e){if(!e||e.length===0){return Promise.resolve()}return this.checkExistingToken().then(function(t){return this.callApi(this.oGraphApiConfig.graphApiEndpoints.graphUserEndpoint+"/"+e+"/photo/$value",t.accessToken)}.bind(this)).then(function(e){return e.blob()}).then(function(e){return URL.createObjectURL(e)})},checkExistingToken:function(){if(this.loginResponse){return Promise.resolve(this.loginResponse)}else{return this.getToken(this.oGraphApiConfig.loginRequest)}},getTeamsContactOptions:function(){var e=this;return Promise.resolve([{key:"chat",icon:"sap-icon://discussion",fesrStepName:"MST:ContactDetails",callBackHandler:function(t){e.handleMSTeamsPress(t)}},{key:"call",icon:"sap-icon://call",fesrStepName:"MST:ContactDetails",callBackHandler:function(t){e.handleMSTeamsPress(t)}},{key:"videoCall",icon:"sap-icon://video",fesrStepName:"MST:ContactDetails",callBackHandler:function(t){e.handleMSTeamsPress(t)}}])},handleMSTeamsPress:function(e){var t=e.getSource().data("email");var n=e.getSource().data("type");var o="";switch(n){case"chat":o="https://teams.microsoft.com/l/chat/0/0?users="+t;break;case"call":o="https://teams.microsoft.com/l/call/0/0?users="+t;break;case"videoCall":o="https://teams.microsoft.com/l/call/0/0?users="+t+"&withVideo=true";break;default:break}i.URLHelper.redirect(o,true)},formatUri:function(e){var t=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(t.test(e)){return"mailto:"+e}else{return"tel:"+e}},loadContactPopover:function(e){this.sEmail=e;return this.getFullProfileByEmail(e).then(function(e){if(e&&e.error){return Promise.reject(e)}var t=new o(e);t.setData(e);return n.load({name:"sap.suite.ui.commons.collaboration.ContactPopover",controller:this,type:"XML"}).then(function(e){this._oContactPopover=e;e.setModel(t,"userData");e.setModel(new sap.ui.model.resource.ResourceModel({bundle:a}),"i18n");return e}.bind(this))}.bind(this))},loadMinimalContactPopover:function(e){var t=new o({mail:e});return n.load({name:"sap.suite.ui.commons.collaboration.MinimalContactPopover",controller:this,type:"XML"}).then(function(e){this._oMinContactPopover=e;e.setModel(t,"userData");e.setModel(new sap.ui.model.resource.ResourceModel({bundle:a}),"i18n");return e}.bind(this))},afterClose:function(){if(this._oContactPopover){this._oContactPopover.destroy()}if(this._oMinContactPopover){this._oMinContactPopover.destroy()}}})});
//# sourceMappingURL=ContactHelper.js.map