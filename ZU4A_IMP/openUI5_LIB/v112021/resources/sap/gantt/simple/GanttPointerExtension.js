sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/gantt/misc/Utility","./GanttExtension","../drawer/CursorLine","./CoordinateUtils","./GanttUtils","sap/ui/core/format/DateFormat","sap/m/Text","sap/ui/core/format/TimezoneUtil"],(function(jQuery,t,e,o,n,i,r,a,l,s){"use strict";var g=".sapGanttPointer",c="contextmenu"+g,u=sap.gantt.DragOrientation,h=["mouseenter","mouseleave","click","dblclick","mouseup","mousedown"],d=h.map((function(t){return t+g})),p="mousemove",S=p+g,v=S+" mouseup"+g,f=h.reduce((function(t,e){return t[e]=e,t}),{});f[p]=p;var m="forward",b="backward",A="bottom",w="top",T=null,C={addEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),n=jQuery(e.getDomRefs().headerSvg);C.removeEventListeners(t),null===T&&(T=r.adhocLinesPresentAndEnabled(t)),d.forEach((function(t){o.on(t,e.onGanttChartMouseEvent.bind(e)),T?n.on(t,e.onGanttChartMouseEvent.bind(e)):n.off(t,e.onGanttChartMouseEvent.bind(e))})),o.on(v,e.onCrossSvgMouseEvent.bind(e)),n.on(v,e.onCrossSvgMouseEvent.bind(e)),o.on(S,e.updateGanttCursorLine.bind(e)),o.on("mouseover"+g,e.onGanttChartRowHoverOn.bind(e)),o.on("mouseout"+g,e.onGanttChartRowHoverOff.bind(e)),o.on(c,e.onGanttChartContextMenu.bind(e)),e._bIsMouseOnCorrectRow=!0,e._bMouseOnSvg=!0,T?this.bindBackgroundRowEventHeader(n,e):this.unbindBackgroundRowEventHeader(n),n.on(f.mousedown+g,(function(e){var o=t._getDragDropExtension();if(!o.isEventTargetAdhocLine(e)&&!o.isEventTargetDeltaLine(e))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1})),jQuery(document.getElementById(t.getId())).on(S,i.updateCursorPosition)},removeEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),n=jQuery(e.getDomRefs().headerSvg);o.off(g),null===T&&(T=r.adhocLinesPresentAndEnabled(t)),T?n.on(f.mousedown+g):n.off(f.mousedown+g)},doGanttAutoScroll:function(e,o,n,i){var r=e._getPointerExtension();if(r.iTableAutoScrollTimerId&&(window.clearTimeout(r.iTableAutoScrollTimerId),r.iTableAutoScrollTimerId=null),r._bAutoScroll){if(!r.allowAutoScroll())return;e._getDragDropExtension().isSnapping||r._toggleCursorLine(!1);var a=e._getResizeExtension();a.isResizing()&&a.onResizing(n);var l=e._getConnectExtension();l.isShapeConnecting()&&l.onShapeConnecting(n),e._getPopoverExtension()._updatePopoverWhenAutoScroll(n),e._getZoomExtension()._handleAutoScroll(n);var s=t.getConfiguration().getRTL(),g=30;b!==o&&w!==o||(g*=-1),r._iStep=b===o||m===o?g:0;var c,u=this.getScrollArea(e,o),h=!1;o===m||o===b?(c=s?"scrollLeftRTL":"scrollLeft",h=!0):(c="scrollTop",h=!1),l.storeScrollDistance(g,h);var d=u[c]()+g;u[c](d);var p=u[c]();p!==d&&l.storeScrollDistance(p-d,h),void 0!==i&&i===p||(r.iTableAutoScrollTimerId=window.setTimeout(C.doGanttAutoScroll.bind(C),50,e,o,n,p))}},getScrollArea:function(t,e){var o=t.getTable(),n=jQuery(o.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar));return e===m||e===b?jQuery(document.getElementById(t.getId()+"-hsb")):n},bindBackgroundRowEventHeader:function(t,e){jQuery(t[0]).on(f.click+g+" "+f.dblclick+g,(function(t){e.dispatchGanttClickHeader(t)}))},unbindBackgroundRowEventHeader:function(t){jQuery(t[0]).off(g)}},E=o.extend("sap.gantt.simple.GanttPointerExtension",{_init:function(t,e){return this._oCursorLineDrawer=new n,this.bPreventSingleClick=!1,this.iTableAutoScrollTimerId=null,this._iStep=0,this._iHoveredRowElement=null,"PointerExtension"},_attachEvents:function(){var t=this.getGantt();C.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();C.removeEventListeners(t)},destroy:function(){this._oCursorLineDrawer&&this._oCursorLineDrawer.destroy(),delete this.bPreventSingleClick}});return E.prototype.onGanttChartContextMenu=function(t){if(t.preventDefault(),!1!==this.isEventTargetOnGanttRow(t)){var e=this.getGantt(),o=this._getRowIndexFromEvent(t),n=e.getTable().getRows()[o].getAggregation("_settings");e.fireShapeContextMenu({rowSettings:n,pageX:t.pageX,pageY:t.pageY})}},E.prototype.onGanttChartRowHoverOn=function(t){if(!1!==this.isEventTargetOnGanttRow(t)){this._iHoveredRowElement=t.target;var e=this._getRowIndexFromEvent(t),o=this.getGantt()._getDragDropExtension();this._bIsMouseOnCorrectRow=!0,o._bEnableRowHighlight&&o.isDragging()&&(this._bIsMouseOnCorrectRow=!1,o.oLastDraggedShapeData._highlightedRowIndex&&o.oLastDraggedShapeData._highlightedRowIndex.forEach(function(t){t===e&&(this._bIsMouseOnCorrectRow=!0)}.bind(this))),this.onMouseHover(e,!0)}},E.prototype.onGanttChartRowHoverOff=function(t){if(this._iHoveredRowElement){for(var e=t.relatedTarget;e;){if(e==this._iHoveredRowElement)return;e=e.parentNode}var o=this._getRowIndexFromEvent(t);this.onMouseHover(o,!1),this._iHoveredRowElement=null}},E.prototype.onGanttChartMouseEvent=function(t){if(this.updateGanttCursorLine(t),t.type===f.mousedown&&(this.oMousedownTargetElement=t.target),t.type===f.click||t.type===f.dblclick){if(!1===this.isEventTargetOnGanttRow(t))return;this.dispatchGanttClick(t)}this.onMouseEnterLeaveEvent(t)},E.prototype.onCrossSvgMouseEvent=function(t){var e=this.getGantt();if(t.type===f.mousemove)if(this.needAutoscrollInContainerIfNecessary())this.updateCursorStyle("move"),this.tableAutoScroll(t);else{var o=e._getDragDropExtension(),n=e._getConnectExtension(),i=e._getResizeExtension(),r=e._getZoomExtension();(o.isDeltaLineDragging()||o.isAdhocLineDragging()||o.isDragging()||i.isResizing()||n.isShapeConnecting()||r.isTimeZooming())&&this.tableAutoScroll(t)}t.type===f.mouseup&&(this.oMouseupTargetElement=t.target,this._bAutoScroll=!1)},E.prototype.needAutoscrollInContainerIfNecessary=function(){var t=this.getGantt().getParent();if(t&&t.getGanttCharts){var e=t.getGanttCharts(),o=this.getGantt();return e.some((function(t){return t!==o&&t._getDragDropExtension().isDragging()}))}return!1},E.prototype.updateCursorStyle=function(t){document.body.style.cursor=t;var e=this.getDomRefs();null!=e?.ganttSvg?.style?.cursor&&(e.ganttSvg.style.cursor=t)},E.prototype.isPointerInGanttChart=function(t){return this._bMouseOnSvg},E.prototype.isPointerInCorrectRow=function(t){return this._bIsMouseOnCorrectRow},E.prototype.onMouseEnterLeaveEvent=function(t){this.updateCursorStyle("default"),t.type===f.mouseenter?this._bMouseOnSvg=!0:t.type===f.mouseleave&&(this._bMouseOnSvg=!1)},E.prototype.dispatchGanttClick=function(t){t.type===f.click?this.oMousedownTargetElement===this.oMouseupTargetElement&&(this.onGanttSingleClick(t),delete this.oMouseupTargetElement,delete this.oMousedownTargetElement):t.type===f.dblclick&&this.onGanttDoubleClick(t)},E.prototype.dispatchGanttClickHeader=function(t){t.type===f.click&&(this.onGanttSingleClick(t),delete this.oMouseupTargetElement,delete this.oMousedownTargetElement)},E.prototype.isEventTargetOnGanttRow=function(t){return jQuery(t.target).hasClass("sapGanttBackgroundSVGRow")},E.prototype._getRowIndexFromEvent=function(t){return parseInt(t.target.getAttribute("data-sap-ui-index"),10)},E.prototype._getRowIndexFromElement=function(t){return parseInt(t.getAttribute("data-sap-ui-index"),10)},E.prototype.onGanttSingleClick=function(t){this.getGantt().getSelection().clearAllSelectedShapeIds(),this.getGantt().getSelection().updateShape(null,{selected:!1,ctrl:t.ctrlKey||t.metaKey});var e=this.getGantt();r.resetStrokeDasharray(e);var o=this._getRowIndexFromEvent(t),n=e.getTable().getRows()[o];if(n){var i=function(){!1===this.bPreventSingleClick&&(this._selectTableRow(e,o),e.fireShapePress({shape:null,row:n})),this.bPreventSingleClick=!1}.bind(this);if(e.getDisableShapeDoubleClickEvent())return this.bPreventSingleClick=!1,void i();this.iSingleClickTimer=window.setTimeout(i.bind(this),300)}},E.prototype.onGanttDoubleClick=function(t){var e,o,n=this.getGantt(),i=n.getDisableShapeDoubleClickEvent();i||(window.clearTimeout(this.iSingleClickTimer),this.bPreventSingleClick=!0),e=this._getRowIndexFromEvent(t),o=n.getTable().getRows()[e],this._selectTableRow(n,e),i||n.fireShapeDoubleClick({shape:null,row:o})},E.prototype._selectTableRow=function(t,e){var o=this.getGantt().getTable().getSelectionBehavior(),n=sap.ui.table.SelectionBehavior;n.Row!==o&&n.RowOnly!==o||t.getSyncedControl().syncRowSelection(e)},E.prototype.onMouseHover=function(t,e){this.getGantt().getSyncedControl().syncRowHover(t,e)},E.prototype._getAutoScrollStep=function(){return this._bAutoScroll?this._iStep:0},E.prototype.updateGanttCursorLine=function(t){if(!1!==this.getGantt().getEnableCursorLine()&&!this.getGantt()._getDragDropExtension().isSnapping)if(t.type===f.mousemove){var e=i.getEventSVGPoint(this.getDomRefs().ganttSvg,t);this._toggleCursorLine(!0,e)}else t.type===f.mouseleave&&this._toggleCursorLine(!1)},E.prototype._toggleCursorLine=function(t,e){var o=this._getCursorLineDOMs(),n=this.getGantt().getParent(),i=n.isA("sap.gantt.simple.GanttChartContainer")&&n.getEnableStatusBar();t?(this._oCursorLineDrawer.drawSvg(o.allGanttSvg,o.allHeaderSvg,this.getGantt().getLocale(),e),i&&this.customBar(n,!0,this.getGantt().getAxisTime().viewToTime(e.x)),n._bCalcTimeStamp=!0,n._timeStamp=!1):(this._oCursorLineDrawer.destroySvg(o.allGanttSvg,o.allHeaderSvg),i&&this.customBar(n,!1))},E.prototype.customBar=function(t,o,n){var i=new l({text:""}),r=this.getGantt().getLocale(),s=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarDatePattern(),calendarWeekNumbering:this.getGantt().getAxisTimeStrategy().getCalendarWeekNumbering(),showTimezone:!1}),g=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarTimePattern(),showTimezone:!1});t.msgText.setWidth(o?"70%":"100%"),t.dateTimeText.setWidth(o?"30%":"0%"),t.dateTimeText.setText(o?e.getLowerCaseLabel(r.getFormattedDate(s,n)+" "+r.getFormattedDate(g,n)):i.getText())},E.prototype._getCursorLineDOMs=function(){return{allHeaderSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartHeaderSvg"),allGanttSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartSvg")}},E.prototype.tableAutoScroll=function(t){this._bAutoScroll=!1;var e=this.getGantt(),o=e._getDragDropExtension().isDragging(),n=e.getDragOrientation(),i=o&&n===u.Horizontal,r=o&&n===u.Vertical;this.ifAutoScrollToRight()&&!r?window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),m,t)}.bind(this),50):this.ifAutoScrollToLeft()&&!r?window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),b,t)}.bind(this),50):this.ifAutoScrollToDown()&&!i?window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),A,t)}.bind(this),50):this.ifAutoScrollToUp()&&!i?window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),w,t)}.bind(this),50):this._bAutoScroll=!1},E.prototype.ifAutoScrollToRight=function(){var t=this.getAutoScrollPosition();return this._bAutoScroll=t.iLocationX>t.oScrollAreaRect.left+t.iScrollAreaWidth-t.iScrollTriggerAreaWidth&&t.iLocationX<t.oScrollAreaRect.left+t.iScrollAreaWidth&&t.iScrollAreaScrollLeft+t.iScrollAreaWidth<t.oScrollArea.scrollWidth,this._bAutoScroll},E.prototype.ifAutoScrollToLeft=function(){var t=this.getAutoScrollPosition();return this._bAutoScroll=t.iLocationX<t.oScrollAreaRect.left+t.iScrollTriggerAreaWidth&&t.iLocationX>t.oScrollAreaRect.left&&t.iScrollAreaScrollLeft>0,this._bAutoScroll},E.prototype.ifAutoScrollToDown=function(){var t=this.getAutoScrollPosition();return this._bAutoScroll=t.iLocationY>t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight-t.iScrollTriggerAreaHeight&&t.iLocationY<t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight&&t.iScrollAreaScrollTop+t.iScrollAreaHeight-t.iBaseRowHeight<=t.iScrollHeight,this._bAutoScroll},E.prototype.ifAutoScrollToUp=function(){var t=this.getAutoScrollPosition();return this._bAutoScroll=t.iLocationY<t.oVisibleScrollAreaRect.top+t.iScrollTriggerAreaHeight&&t.iLocationY>t.oVisibleScrollAreaRect.top,this._bAutoScroll},E.prototype.getAutoScrollPosition=function(){var e=t.getConfiguration().getRTL(),o=this.getGantt().getTable(),n=document.getElementById(this.getGantt().getId()+"-gantt"),r=jQuery(n),a=n.getBoundingClientRect(),l=r.outerWidth(),s=r.outerHeight(),g=a,c=s,u=this.getGantt()._oExpandModel.getBaseRowHeight(),h=e?r.scrollLeftRTL():r.scrollLeft(),d=jQuery(o.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar)),p=d.scrollTop(),S=d.get(0).scrollHeight;return{iLocationX:i.getLatestCursorPosition().pageX,iLocationY:i.getLatestCursorPosition().pageY,oScrollAreaRect:a,oScrollArea:n,iScrollAreaWidth:l,iScrollTriggerAreaWidth:20,iScrollTriggerAreaHeight:20,iScrollAreaScrollLeft:h,oVisibleScrollAreaRect:g,iVisibleScrollAreaHeight:c,iScrollAreaScrollTop:p,iBaseRowHeight:u,iScrollHeight:S,iScrollAreaHeight:s}},E.prototype.allowAutoScroll=function(){return this.ifAutoScrollToRight()||this.ifAutoScrollToLeft()||this.ifAutoScrollToDown()||this.ifAutoScrollToUp()},E}));