/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/gantt/library","./GanttExtension","./CoordinateUtils","./GanttUtils","sap/gantt/misc/Format","./RenderUtils","sap/gantt/misc/Utility"],function(jQuery,t,e,a,i,r,n,o,s,g){"use strict";var h=".sapGanttDragDrop";var l=["mousemove","mouseup","keydown"];var p="mousedown";var d=l.reduce(function(t,e){t[e]=e;return t},{});d[p]=p;var u=l.map(function(t){return t+h});var f=p+h;var v=3;var c=a.dragdrop.GhostAlignment;var D=a.dragdrop.SnapMode;var m=sap.gantt.DragOrientation;var S={dispatchEvent:function(t){var e=this._getDragDropExtension();if(t.type===d.mousedown){e.onMouseDown(t)}else if(t.type===d.mousemove){e.onMouseMove(t)}else if(t.type===d.mouseup){e.onMouseUp(t)}else if(t.type===d.keydown){e.onKeydown(t)}},addEventListeners:function(t){this.removeEventListeners(t);var e=jQuery(t._getDragDropExtension().getDomRefs().ganttSvg);e.on(f,S.dispatchEvent.bind(t));var a=jQuery(t._getDragDropExtension().getDomRefs().headerSvg);a.on(f,S.dispatchEvent.bind(t))},removeEventListeners:function(t){var e=jQuery(t._getDragDropExtension().getDomRefs().ganttSvg);e.off(h);var a=jQuery(t._getDragDropExtension().getDomRefs().headerSvg);a.off(h)},addDragDropEventListeners:function(t){this.removeDragDropEventListeners(t);u.forEach(function(e){jQuery(document).on(e,S.dispatchEvent.bind(t))})},removeDragDropEventListeners:function(t){u.forEach(function(t){jQuery(document).off(t)})}};var y=i.extend("sap.gantt.simple.GanttDragDropExtension",{_init:function(t,e){this._initDragStates();return"DragDropExtension"},_attachEvents:function(){var t=this.getGantt();S.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();S.removeEventListeners(t)}});y.prototype._initDragStates=function(){this.bDragging=false;this.adhocLineDrag=false;this.deltaLineDrag=false;this.adhocLineDragStart=false;this.deltaLineDragStart=false;this.isCursorlineDisabled=false;this.bElementDraggable=false;this.oAdhocLineElmDraggable=false;this.oDeltaLineElmDraggable=false;this.oMouseDownTarget=null;this.oLastDraggedShapeData=null;this.mDragPoint={};this.bDragging=false;this.dragGhost=null;this.prevDragPoint={};this.snapTimer=null;this.snapVal=0;this.isSnapping=false;this.cursorLineSnapPoint=null};y.prototype.onAdhocMarkerMouseDown=function(t){var a=r.getEventSVGPoint(this.getDomRefs().headerSvg,t),i=t.target.getBBox();this.oMouseDownTarget=t.target;var n=e.byId(this.oMouseDownTarget.id),o={x:0,y:0};if(n){o=g.getShapeBias(n)}this.mDragPoint={cursorX:a.x,cursorY:a.y,shapeX:i.x,shapeY:i.y,shapeWidth:i.width,shapeBias:o};S.addDragDropEventListeners(this.getGantt());this.adhocLineDrag=true};y.prototype.onDeltaAreaMouseDown=function(t){var a=r.getEventSVGPoint(this.getDomRefs().headerSvg,t),i=t.target.getBBox();this.oMouseDownTarget=t.target;var n=e.byId(this.oMouseDownTarget.id),o={x:0,y:0};if(n){o=g.getShapeBias(n)}this.mDragPoint={cursorX:a.x,cursorY:a.y,shapeX:i.x,shapeY:i.y,shapeWidth:i.width,shapeBias:o};var s=n.getParent();this.oLastDraggedShapeData={timeStamp:s.getTimeStamp(),endTimeStamp:s.getEndTimeStamp()};S.addDragDropEventListeners(this.getGantt());this.deltaLineDrag=true};y.prototype.onAdhocLineDrop=function(t){if(this.oMouseDownTarget){var e=jQuery(this.oMouseDownTarget).control(0,true).getParent();var a=this._getAdhocDropData(t);if(a){e.fireAdhoclineDrop(a)}if(this.isCursorlineDisabled){this.getGantt().setEnableCursorLine(true)}this.stopDragging()}};y.prototype.onDeltaLineDrop=function(t){if(this.oMouseDownTarget){var e=jQuery(this.oMouseDownTarget).control(0,true).getParent();var a=this._getDeltaMarkerDropEvent(t);if(a){e.fireDeltalineDrop(a)}if(this.isCursorlineDisabled){this.getGantt().setEnableCursorLine(true)}this.stopDragging()}};y.prototype.onAdhocLineMove=function(t){if(!this.adhocLineDragStart){this.dragGhost=this.createDragGhost(this.oMouseDownTarget);this._hideScrollBarOnBody(true);this.adhocLineDragStart=true;if(this.getGantt().getEnableCursorLine()){this.getGantt().setEnableCursorLine(false);this.isCursorlineDisabled=true}}else{this.onLineDrag(t)}};y.prototype.onDeltaLineMove=function(t){if(!this.deltaLineDragStart){this.dragGhost=this.createDragGhost(this.oMouseDownTarget);this._hideScrollBarOnBody(true);this.deltaLineDragStart=true;if(this.getGantt().getEnableCursorLine()){this.getGantt().setEnableCursorLine(false);this.isCursorlineDisabled=true}}else{this.onLineDrag(t)}};y.prototype.onLineDrag=function(t){if(this.isValidDropZoneForLines(t)){this.updateCursorStyle("Move");this.updateHeaderCursorStyle("Move")}else{this.updateCursorStyle("not-allowed");this.updateHeaderCursorStyle("not-allowed")}this.showGhost(t)};y.prototype.onMouseDown=function(t){if(t.button!==0){return}this._bGhostsPositioned=false;this.bMultipleGhosts=false;this._bEnableRowHighlight=false;var a;if(this.isEventTargetAdhocLine(t)){this.oAdhocLineElmDraggable=this.isAdhocLineDraggable(t);if(this.oAdhocLineElmDraggable){this.onAdhocMarkerMouseDown(t);return}}if(this.isEventTargetDeltaLine(t)){this.oDeltaLineElmDraggable=this.isDeltaLineDraggable(t);if(this.oDeltaLineElmDraggable){this.onDeltaAreaMouseDown(t);return}}if(!this.getGantt().getEnableSelectAndDrag()){a=this.getShapeElementByTarget(t.target);if(a){this.shapeSelectedOnMouseDown=true;this.initiallySelected=a.getSelected();if(!(a.isA("sap.gantt.simple.Relationship")&&this.getGantt().getIsConnectorDetailsVisible())){this.getGantt().getSelection().updateShape(a.getShapeUid(),{selected:true,ctrl:t.ctrlKey||t.metaKey,draggable:a.getDraggable(),time:a.getTime(),endTime:a.getEndTime()})}}}this.bElementDraggable=this.isEventTargetDraggable(t);if(this.bElementDraggable){var i=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t);var o=this.getDraggableDOMElement(t.target),s=e.byId(o.id),h=s.getTask?s.getTask():s;if(h instanceof sap.gantt.simple.BaseConditionalShape){h=h._getActiveShapeElement()}var l=h.getDomRef("nonLabelGroup")?h.getDomRef("nonLabelGroup").getBBox():o.getBBox(),p={x:0,y:0};if(s){p=g.getShapeBias(s)}this.mDragPoint={cursorX:i.x,cursorY:i.y,shapeX:l.x,shapeY:l.y,shapeWidth:l.width,shapeBias:p};a=this.getShapeElementByTarget(o);this.oMouseDownTarget=o;this.oLastDraggedShapeData={shapeUid:a.getShapeUid(),startTime:a.getTime(),endTime:a.getEndTime()};if(this.oSourceRow){this.oSourceRow.destroy()}this.oSourceRow=this.getRowByShape(a);if(this.getGantt().getDragOrientation()===m.Horizontal){this.oCurrentRow=n.getRowInstancefromShape(a)}var d=n.getShapesWithUid(this._gantt.getId(),this._gantt.getSelectedShapeUid());this._aVisibleDraggableShapes=[];d.forEach(function(t){if(t&&t.getDraggable()&&t.sParentAggregationName!=="relationships"){this._aVisibleDraggableShapes.push(t)}}.bind(this));this.bMultipleGhosts=this.getGantt().getEnableMultipleGhosts()&&this._aVisibleDraggableShapes.length>1;this.mGhostLabelStyle={};this._bEnableRowHighlight=a.getDragHighlightRows().length>0&&this._aVisibleDraggableShapes.length==1;S.addDragDropEventListeners(this.getGantt())}else if(this.oSourceRow){this.oSourceRow.destroy();this.oSourceRow=undefined}};y.prototype.updateCursorStyle=function(t,e){document.body.style.cursor=t;this.getDomRefs().ganttSvg.style.cursor=t;if(e){this.getDomRefs().ganttChart.style.pointerEvents=e;this.getDomRefs().gantt.style.pointerEvents="auto";this._bArePointerEventsDisabled=true;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.pointerEvents=e}}else{if(this._bArePointerEventsDisabled){this.getDomRefs().ganttChart.style.removeProperty("pointer-Events");this.getDomRefs().gantt.style.removeProperty("pointer-Events");this._bArePointerEventsDisabled=false;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.removeProperty("pointer-Events")}}}};y.prototype.updateHeaderCursorStyle=function(t,e){this.getDomRefs().headerSvg.style.cursor=t;if(e){this.getDomRefs().ganttChart.style.pointerEvents=e;this.getDomRefs().gantt.style.pointerEvents="auto";this._bArePointerEventsDisabled=true;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.pointerEvents=e}}else{if(this._bArePointerEventsDisabled){this.getDomRefs().ganttChart.style.removeProperty("pointer-Events");this.getDomRefs().gantt.style.removeProperty("pointer-Events");this._bArePointerEventsDisabled=false;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.removeProperty("pointer-Events")}}}};y.prototype.onMouseMove=function(t){if(this.skipEvent(t)){return}if(!!this.adhocLineDrag&&!!this.oMouseDownTarget){this.onAdhocLineMove(t);return}if(!!this.deltaLineDrag&&!!this.oMouseDownTarget){this.onDeltaLineMove(t);return}if(this.bDragging===false){var a=this.getGantt(),i=this.getShapeElementByTarget(t.target);if(this._bEnableRowHighlight&&i){this.getShapeDndRowHighlightIndex(a,i)}var n=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t),o=this.isExceedDraggingThreshold(n),s=o&&this.isAllowedVerticalOrentationDrag();this.bDragging=s;this._aShapeNodes=[];this._aGhostImages=[];if(s&&this.oMouseDownTarget){this._hideScrollBarOnBody(true);var h=e.byId(this.oMouseDownTarget.id);var l=h.getTask?h.getTask():h;if(l instanceof sap.gantt.simple.BaseConditionalShape){l=l._getActiveShapeElement()}this.oTargetDom=l.getDomRef("nonLabelGroup")?l.getDomRef("nonLabelGroup"):this.oMouseDownTarget;this.dragGhost=this.createDragGhost(this.oTargetDom,true);var p=this.oTargetDom.getBBox();if(this.bMultipleGhosts){var d=g.getShapeBias(h);this._coordinateDiff={};var u=e.getConfiguration().getRTL();var f=u?p.x+d.x+p.width:p.x+d.x;var v=p.y+d.y;this._aVisibleDraggableShapes.forEach(function(t){if(t.getId()!==this.oMouseDownTarget.id){var e=t,a;if(t.getTask){e=t.getTask()}if(e instanceof sap.gantt.simple.BaseConditionalShape){e=e._getActiveShapeElement()}if(e.getDomRef("nonLabelGroup")){a=e.getDomRef("nonLabelGroup")}else{a=document.getElementById(t.getId())}this.createDragGhost(a,false);var i=u?a.getBBox().width:0;d=g.getShapeBias(t);var r={xDiff:a.getBBox().x+d.x+i-f,yDiff:a.getBBox().y+d.y-v,shape:t};this._coordinateDiff[t.getId()]=r}}.bind(this))}this._bFirstTimeDrag=true;var c=this._getDragStartEventData(t);if(c){this.getGantt().fireDragStart(c)}}else if(o){this.updateCursorStyle("not-allowed","none")}}else{var D=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t);if(Object.keys(this.prevDragPoint).length===0||this.prevDragPoint.cursorX!==D.x||this.prevDragPoint.cursorY!==D.y){this.prevDragPoint={cursorX:D.x,cursorY:D.y};if(this.bMultipleGhosts&&this._bFirstTimeDrag){this.iGhostTimer=window.setTimeout(function(){this._updateGhostShapesPosition()}.bind(this),100);this._bGhostsPositioned=true}this._bFirstTimeDrag=false;this.onDragging(t)}}};y.prototype.getShapeDndRowHighlightIndex=function(t,e){var a=t.getTable(),i=a.getRows(),r=i[0].getIndex();var n=e?e.getDragHighlightRows():this.oLastDraggedShapeData._dragHighlightRows;this.oLastDraggedShapeData._highlightedRowIndex=[];if(n){n.forEach(function(t){var e=i.filter(function(e){return e.getAggregation("_settings").getRowId()===t})[0];if(e){this.oLastDraggedShapeData._highlightedRowIndex.push(e.getIndex()-r)}}.bind(this));this.oLastDraggedShapeData._dragHighlightRows=n}};y.prototype._updateGhostShapesPosition=function(){var t=document.getElementsByClassName("sapGanttDragGhost");var e=document.getElementById("sapGanttDragGhostWrapper");if(e){var a=[],i;for(i=0;i<t.length;i++){a.push(t[i].offsetHeight)}while(document.getElementsByClassName("sapGanttDragGhost").length>1){e.lastElementChild.remove()}var r=a[0];for(i=1;i<this._aShapeNodes.length;i++){var n=this._aShapeNodes[i];var o=this._coordinateDiff[n.id].xDiff;var s=this._coordinateDiff[n.id].yDiff;var g={left:o+"px",top:s-r+"px"};var h=this._getGhostLabel(this._coordinateDiff[n.id].shape,n);var l="<div class='sapGanttDragGhost'>"+"<img class='sapGanttDragGhostImg' src='"+this._aGhostImages[i]+"'>"+h+"</div>";e.insertAdjacentHTML("beforeend",l);e.lastElementChild.style.left=g.left;e.lastElementChild.style.top=g.top;if(h!==""){this._updateGhostLabelStyle()}r+=a[i]}e.classList.remove("sapGanttDragElementHidden")}};y.prototype._getGhostLabel=function(t,a){if(!this.getGantt().getShowTextOnGhost()){return""}var i="",r="",n="13px",o="#000",s="Arial",g="normal";var h=t.getVerticalTextAlignment();var l=a.nextSibling;if(l&&l.tagName==="text"&&t.getShowTitle()&&t.getTitle()&&t.getTitle().length&&l.textContent&&l.textContent.length){r=l.textContent;n=l.style.fontSize||n;o=l.style.fill||o;s=l.style.fontFamily||s;g=l.style.fontWeight||g}else{return i}var p=e.getConfiguration().getRTL();var d="0px",u="0px";if(p){d=a.getBBox().x-t.getXBias()+a.getBBox().width-(l.getBBox().x+l.getBBox().width)+"px"}else{u=l.getBBox().x-(a.getBBox().x+t.getXBias())+"px"}var f=a.getBBox().height-l.getBBox().height;if(h==="Top"){f=0}else if(h==="Center"){f=f/2}this.mGhostLabelStyle={fontSize:n,color:o,fontFamily:s,fontWeight:g,top:f+"px",right:d,left:u};i="<div class='sapGanttDragGhostLabel'>"+r+"</div>";return i};y.prototype._updateGhostLabelStyle=function(){var t=document.getElementsByClassName("sapGanttDragGhostLabel");var e=t[t.length-1];for(var a in this.mGhostLabelStyle){e.style[a]=this.mGhostLabelStyle[a]}};y.prototype.onMouseUp=function(t){if(this.bElementDraggable===true&&this.bDragging===false){this.stopDragging(t);this._initDragStates();return}if(!!this.adhocLineDragStart&&!!this.oMouseDownTarget){this.onAdhocLineDrop(t);this._initDragStates();return}if(!!this.deltaLineDragStart&&!!this.oMouseDownTarget){this.onDeltaLineDrop(t);this._initDragStates();return}var e=this._getShapeDropEventData(t);this.stopDragging(t);if(e){var a=this.getGantt();if(a.getEnablePseudoShapes()){var i=e.targetRow&&e.targetRow.getIndex();var r=e.draggedShapeDates;a.pseudoShapeSpecificData=a.pseudoShapeSpecificData?a.pseudoShapeSpecificData:{};a.pseudoShapeSpecificData.oDraggedShapeDates=r;r&&Object.keys(r).forEach(function(t){var e=n.getShapesWithUid(a.getId(),[t])[0];var r=e.getParentRowSettings().getParentRow().getIndex&&e.getParentRowSettings().getParentRow().getIndex();a.pseudoShapeSpecificData.draggedShapeTRowIndex=i==undefined?r:i});a.pseudoShapeSpecificData.needUpdateForTasksInAggr=true}this.getGantt().triggerShapeDrop(e)}if(this.oMouseDownTarget){var o=this.getShapeElementByTarget(this.oMouseDownTarget);if(o){n.rerenderAssociatedRelationships(this.getGantt(),o)}}this._initDragStates()};y.prototype._getDragStartEventData=function(t){return{sourceGanttChart:this.getGantt(),draggedShapeDates:this._getDraggedShapeDates(),lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,cursorDateTime:this._getGhostTime(t).cursorTime}};y.prototype._getShapeDropEventData=function(t){var e=this.getGantt();var a=e._getPointerExtension();if(this.isValidDropZone(t)&&a.isPointerInCorrectRow()){var i;var r=this._getDraggedShapeDates();var o=this.getGanttChartByTarget(t.target);if(this.getGantt().getDragOrientation()===m.Horizontal){i=this.oCurrentRow}else{i=n.getRowInstance(t,o.getTable())}var s=this.getShapeElementByTarget(t.target);var g=this._getGhostTime(t);return{dragged:true,sourceGanttChart:e,targetGanttChart:o,draggedShapeDates:r,lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,targetRow:i,cursorDateTime:g.cursorTime,newDateTime:g.newDateTime,targetShape:s,sourceRowData:this.oSourceRow}}else{return{dragged:false}}};y.prototype._getAdhocDropData=function(t){if(this.isValidDropZoneForLines(t)){var e=this.getGantt();var a=e.getAxisTime();var i=r.getEventSVGPoint(this.getDomRefs().headerSvg,t);var n=o.dateToAbapTimestamp(a.viewToTime(this.mDragPoint.cursorX));var s=o.dateToAbapTimestamp(a.viewToTime(i.x));return{newTimeStamp:s,oldTimeStamp:n}}};y.prototype._getGhostTime=function(t,a){var i=this.getGantt();var n=this.getGanttChartByTarget(t.target);var o=n!=null?n.getId()!==i.getId():false;var s=o?n.getAxisTime():i.getAxisTime();var g=o?window.document.getElementById(n.getId()+"-svg"):window.document.getElementById(i.getId()+"-svg");var h=this.mDragPoint.shapeBias.x;var l=a?r.getEventSVGPoint(g,t).x:r.getEventSVGPoint(g,t).x-h;if(i.getSnapMode()!==D.None){l=l-this.snapVal}var p=s.viewToTime(l);var d=p;var u=e.getConfiguration().getRTL();var f=this.mDragPoint.shapeX+h,v=u?-this.mDragPoint.shapeWidth:this.mDragPoint.shapeWidth,S=this.mDragPoint.cursorX;var y=p;var T=p;var G=this.oLastDraggedShapeData.endTime-this.oLastDraggedShapeData.startTime;if(this.getGantt().getDragOrientation()===m.Vertical){y=this.oLastDraggedShapeData.startTime;T=this.oLastDraggedShapeData.endTime;d=y}else{if(this.getGantt().getGhostAlignment()===c.Start){T=G?new Date(y.getTime()+G):s.viewToTime(l+v);d=p}else if(this.getGantt().getGhostAlignment()===c.End){y=G?new Date(T.getTime()-G):s.viewToTime(l-v);d=p}else if(this.getGantt().getGhostAlignment()===c.None){var b=u?l-v-(S-f):l-(S-f);var x=s.viewToTime(b);y=x;T=G?new Date(y.getTime()+G):s.viewToTime(b+v);d=x}}return{newDateTime:d,cursorTime:p,time:y,endTime:T}};y.prototype._getDeltaMarkerDropEvent=function(t){if(this.isValidDropZoneForLines(t)){var a=jQuery(this.oMouseDownTarget).control(0,true).getParent();var i=e.getConfiguration().getRTL();var n=this.getGantt().getGhostAlignment();var s=this.getGantt().getAxisTime();var g=r.getEventSVGPoint(this.getDomRefs().headerSvg,t);var h,l;var p=this.mDragPoint.shapeWidth,d=this.mDragPoint.shapeX,u=this.mDragPoint.cursorX;if(n===c.Start){h=i?g.x-p:g.x;l=i?g.x:g.x+p}else if(n===c.None){h=g.x+(d-u);l=h+p}else if(n===c.End){h=i?g.x:g.x-p;l=i?g.x+p:g.x}return{newStartTime:o.dateToAbapTimestamp(s.viewToTime(i?l:h)),newEndTime:o.dateToAbapTimestamp(s.viewToTime(i?h:l)),oldStartTime:a.getTimeStamp(),oldEndTime:a.getEndTimeStamp()}}};y.prototype._getDraggedShapeDates=function(){var t=this.getGantt(),e=t.getSelection();var a=e.allSelectedDraggableUid();var i={};a.forEach(function(a){var r=e.getSelectedShapeDataByUid(a),o;if(!r.time||!r.endTime){o=t.setTimeForGroupShape(n.getShapesWithUid(t.getId(),[a])[0])}i[a]={time:r.time||o&&o.getTime(),endTime:r.endTime||o&&o.getEndTime()}});return i};y.prototype.getDroppedShapeStartTime=function(t,a,i){if(this.getGantt().getGhostAlignment()===c.None){var r=this.mDragPoint.shapeX,n=this.mDragPoint.shapeWidth,s=this.mDragPoint.cursorX;var g=e.getConfiguration().getRTL();var h=g?t+n-(s-r):t-(s-r);var l=a.viewToTime(h),p=o.abapTimestampToDate(l);return p}return i};y.prototype.isValidDropZone=function(t){return jQuery(t.target).closest("svg.sapGanttChartSvg").length===1};y.prototype.isValidDropZoneForLines=function(t){return jQuery(t.target).closest("svg.sapGanttChartHeaderSvg").length===1||jQuery(t.target).closest("svg.sapGanttChartSvg").length===1};y.prototype._hideScrollBarOnBody=function(t){jQuery(document.body).toggleClass("sapGanttDraggingOverflow",t)};y.prototype.onKeydown=function(e){if(this.skipEvent(e)){return}if(e.keyCode===t.ESCAPE){this.stopDragging(e);this.getGantt()._triggerCancelShapeDrop();this._initDragStates()}};y.prototype.stopDragging=function(t){this._enableTextSelection();this._avoidShapeSelectionAfterDragging();this.removeGhost();this.updateCursorStyle("default");this.updateHeaderCursorStyle("default");this._hideScrollBarOnBody(false);this._stopAutoScroll();S.removeDragDropEventListeners(this.getGantt())};y.prototype._avoidShapeSelectionAfterDragging=function(){if(this.bDragging&&this.oMouseDownTarget){var t=this.getShapeElementByTarget(this.oMouseDownTarget);window.setTimeout(function(){if(t){window.clearTimeout(t.iSingleClickTimer)}},100,this)}};y.prototype.isEventTargetDraggable=function(t){var e=this.getShapeElementByTarget(t.target);if(e){return e.getDraggable()&&(e.getSelected()||!this.getGantt().getEnableSelectAndDrag())}return false};y.prototype.getShapeElementByTarget=function(t){return jQuery(this.getDraggableDOMElement(t)).control(0,true)};y.prototype.getGanttChartByTarget=function(t){return jQuery(t).closest("svg.sapGanttChartSvg").control(0,true)};y.prototype.isEventTargetAdhocLine=function(t){return jQuery(t.target).control(0,true)&&jQuery(t.target).control(0,true).sParentAggregationName==="_marker"};y.prototype.isEventTargetDeltaLine=function(t){return jQuery(t.target).control(0,true)&&jQuery(t.target).control(0,true).sParentAggregationName==="_headerDeltaArea"};y.prototype.isAdhocLineDraggable=function(t){var e=jQuery(t.target).control(0,true).getParent();return e.getDraggable()&&e._getSelected()};y.prototype.isDeltaLineDraggable=function(t){var e=jQuery(t.target).control(0,true).getParent();return e.getDraggable()&&e._getIsSelected()};y.prototype.getDraggableDOMElement=function(t){return jQuery(t).closest("["+n.SHAPE_ID_DATASET_KEY+"]").get(0)};y.prototype.isExceedDraggingThreshold=function(t){return Math.abs(t.x-this.mDragPoint.cursorX)>v||Math.abs(t.y-this.mDragPoint.cursorY)>v};y.prototype.onDragging=function(t){if(this.dragGhost){this.isSnapping=false;var e=this.getGantt()._getPointerExtension();if(e.isPointerInGanttChart()===true&&e.isPointerInCorrectRow()===true){this.updateCursorStyle("move")}else{this.updateCursorStyle("not-allowed","none");this.updateHeaderCursorStyle("not-allowed","none");this._stopAutoScroll()}this.showGhost(t);this._disableTextSelection();if(this.getGantt().getSnapMode()!==D.None){this.executeSnappingEffect(t)}}};y.prototype.executeSnappingEffect=function(t){if(this.snapTimer){window.clearTimeout(this.snapTimer);this.snapTimer=null}this.snapTimer=window.setTimeout(function(){this.showGhost(t,true)}.bind(this),100)};y.prototype._stopAutoScroll=function(){var t=this.getGantt()._getPointerExtension();t._bAutoScroll=false};y.prototype.isDragging=function(){return this.bDragging};y.prototype.isAdhocLineDragging=function(){return this.adhocLineDragStart};y.prototype.isDeltaLineDragging=function(){return this.deltaLineDragStart};y.prototype.skipEvent=function(t){return this.bElementDraggable===false&&this.oAdhocLineElmDraggable===false&&this.oDeltaLineElmDraggable===false};y.prototype.showGhost=function(t,e){var a=this.getGantt().getGhostAlignment();var i=document.getElementById("sapGanttDragGhostWrapper");var r=this.adhocLineDragStart||this.deltaLineDragStart?this.calcGhostAligmentForLines(t,a):this.calcGhostOffsetByAlignment(t,a,e);if(this.adhocLineDragStart||this.deltaLineDragStart){var o=n.getTimeLabel(t,this.getGantt().getAxisTime(),this.getGantt().getLocale(),this.getDomRefs().headerSvg);document.getElementById("sapGanttDragText").innerText=o}i.style.left=r.left;i.style.top=r.top;if(!this._bGhostsPositioned){i.classList.remove("sapGanttDragElementHidden")}};y.prototype.calcGhostAligmentForLines=function(t,a){var i=e.getConfiguration().getRTL();var n=r.xPosOfEvent(t);if(this.adhocLineDragStart){n-=this.mDragPoint.shapeWidth/2}if(this.deltaLineDragStart){var o=this.mDragPoint.shapeWidth,s=this.mDragPoint.shapeX,g=this.mDragPoint.cursorX;if(a===c.Start){n=i?n-o:n}else if(a===c.None){n=n+(s-g)}else if(a===c.End){n=i?n:n-o}}var h=r.getSvgScreenPoint(this.getDomRefs().headerSvg,{pageX:this.mDragPoint.cursorX,clientX:this.mDragPoint.cursorX,pageY:this.mDragPoint.cursorY,clientY:this.mDragPoint.cursorY});return{left:n+"px",top:h.y+"px"}};y.prototype.calcGhostOffsetByAlignment=function(t,a,i){var n=e.getConfiguration().getRTL();var o=this.mDragPoint.shapeWidth,s=this.mDragPoint.shapeX+this.mDragPoint.shapeBias.x,g=this.mDragPoint.cursorX;var h;var l=document.getElementById("sapGanttDragGhostWrapper").offsetWidth-document.getElementsByClassName("sapGanttDragGhostImg")[0].offsetWidth;var p=r.xPosOfEvent(t);if(this.getGantt().getDragOrientation()===m.Vertical){var d=r.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});h=d.x+this.mDragPoint.shapeBias.x}else{if(a===c.Start){h=n?p-o:p}else if(a===c.None){h=p+(s-g)}else if(a===c.End){h=n?p:p-o}}var u=r.getEventPosition(t).pageY-2;if(this.getGantt().getDragOrientation()===m.Horizontal){var f=r.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});u=f.y+this.mDragPoint.shapeBias.y}if(i){this._generateSnapvalue(t,o);h=h-this.snapVal}if(n&&this.bMultipleGhosts){h=h-l}return{left:h+"px",top:u+"px"}};y.prototype._getSnapOffsetByAligment=function(t,a){var i={};var r=this.mDragPoint.shapeWidth;var n=e.getConfiguration().getRTL();if(a===c.Start){i.xPosStart=t.x;i.xPosEnd=n?t.x-r:t.x+r}else if(a===c.End){i.xPosStart=n?t.x+r:t.x-r;i.xPosEnd=t.x}else if(a===c.None){i.xPosStart=t.x-(this.mDragPoint.cursorX-this.mDragPoint.shapeX-this.mDragPoint.shapeBias.x);i.xPosEnd=i.xPosStart+r}return i};y.prototype._getSnappedTime=function(t,e,a,i){var r,n;var o=t%e;if(o>e/2){n=e-o;r=new Date(a.getTime()+n*i)}else{n=o;r=new Date(a.getTime()-n*i)}return r};y.prototype._computeSnapping=function(t,a,i){var r=this.getGantt();var n=e.getConfiguration().getRTL();var o=this.getGantt().getGhostAlignment();var s=this.mDragPoint.shapeWidth;var g,h;if(r.getSnapMode()===D.Left){g=n?a-1:t-1;h=n?i.x-g-s:i.x-g}else if(r.getSnapMode()===D.Right){g=n?t+1:a+1;h=n?i.x-g:i.x-g+s}else{if(Math.abs(t)<Math.abs(a)){g=n?t-1:t-1;h=n?i.x-g:i.x-g}else{g=n?a-1:a+1;h=n?i.x-g-s:i.x-g+s}}if(Math.abs(g)<Math.abs(this.snapVal)){this.snapVal=g;if(o===c.Start){this.cursorLineSnapPoint=h}else if(o===c.End){this.cursorLineSnapPoint=n?h+s:h-s}else if(o===c.None){this.cursorLineSnapPoint=n?h-this.mDragPoint.cursorX:h-(this.mDragPoint.cursorX-this.mDragPoint.shapeX)}}};y.prototype._computeSnapByTime=function(t,a,i,r){var n=e.getConfiguration().getRTL();var o=this.getGantt();var s=o.getAxisTime();var g=r[i].timeInterval/60;var h=6e4;var l=s.viewToTime(t.xPosStart);var p=s.viewToTime(t.xPosEnd);var d=l.getMinutes();var u=p.getMinutes();if(g>60){d=l.getHours();u=p.getHours();g=g/60;if(d%g===0||u%g===0){d=l.getMinutes()%30;u=p.getMinutes()%30;l.setMinutes(d);p.setMinutes(u);g=60}else{l.setMinutes(0);p.setMinutes(0);h=36e5}}else if(g<1){d=l.getSeconds();u=p.getSeconds();h=1e3;g=g*60}else{l.setSeconds(0);p.setSeconds(0)}if(d%g!==0||u%g!==0){var f=n?this._getSnappedTime(u,g,p,h):this._getSnappedTime(d,g,l,h);var v=n?this._getSnappedTime(d,g,l,h):this._getSnappedTime(u,g,p,h);var c=s.timeToView(f);var D=s.timeToView(v);if(n){this._computeSnapping(t.xPosEnd-c-1,t.xPosStart-D+1,a)}else{this._computeSnapping(t.xPosStart-c+1,t.xPosEnd-D-1,a)}a.x=a.x-this.snapVal;o._getPointerExtension()._toggleCursorLine(true,a);this.isSnapping=true}else{this.snapVal=0}};y.prototype._generateSnapvalue=function(t){var a=e.getConfiguration().getRTL();var i=this.getGantt().getGhostAlignment();var o=this.getDomRefs().ganttSvg;var g=r.getEventSVGPoint(o,t);var h=this._getSnapOffsetByAligment(g,i);var l=h.xPosStart;var p=h.xPosEnd;var d=g.y;var u=this.getGantt();var f=u._getPointerExtension();var v=u.getAxisTime();var c;var D=v.getZoomStrategy().getTimeLineOption(),m=v.getZoomStrategy().getTimeLineOptions();var S;var y=false;var T=Object.keys(m);var G=0;while(!y&&G<T.length){S=T[G];if(m[S]===D){c=S;y=true}G++}var b=u.getSnapTimeInterval();var x=v.getZoomStrategy();this.snapVal=Number.MAX_SAFE_INTEGER/2;if(b[c]&&b[c].timeInterval){this._computeSnapByTime(h,g,c,b);return}var E=s.getGanttRenderWidth(u);var L=v.getTickTimeIntervalLabel(x.getTimeLineOption(),null,[0,E]);var _=L[1];_.forEach(function(t){this._computeSnapping(l-t.value,p-t.value,g)}.bind(this));var w=n.getVisibleElements(o,".sapGanttChartDeltaLine",".baseShapeSelection");w.forEach(function(t){var e=t.getBBox().x;this._computeSnapping(l-e,p-e,g)}.bind(this));var P=n.getVisibleElements(o,".sapGanttChartAdhocLine",".baseShapeSelection");P.forEach(function(t){var e=t.getBBox().x;this._computeSnapping(l-e,p-e,g)}.bind(this));var B=n.getVisibleElements(o,".sapGanttChartShapes",".baseShapeSelection");B.forEach(function(t){var e=t.getBBox().x,i=e+t.getBBox().width,r=t.getBBox().y,n=r+t.getBBox().height;var o=d+t.getBBox().height;if(d>r&&d<n||o>r&&o<n){var s=a?l-e:l-i;var h=a?p-i:p-e;this._computeSnapping(s,h,g)}}.bind(this));var C=n.getVisibleElements(o,".calendarPattern","rect");C.forEach(function(t){var e=t.getBBox().x,i=e+t.getBBox().width;var r=a?l-e:l-i;var n=a?p-i:p-e;this._computeSnapping(r,n,g)}.bind(this));g.x=this.cursorLineSnapPoint;f._toggleCursorLine(true,g);this.isSnapping=true};y.prototype.removeGhost=function(){this.dragGhost=null;var t=document.getElementById("sapGanttDragGhostWrapper");if(t){t.parentNode.removeChild(t)}};y.prototype.createDragGhost=function(t,e){var a=jQuery("<div id='sapGanttDragGhostWrapper' class='sapGanttDragElementHidden'></div>");if(!this.bMultipleGhosts||e){jQuery(document.body).append(a)}var i=document.createElement("canvas");var r=t.getBBox();i.width=this.normalizeGhostImageWidth(r.width);i.height=r.height;if(this.adhocLineDrag){var n=jQuery(this.oMouseDownTarget).control(0,true).getParent()._getLine();var o=document.getElementById(n.sId);var s=jQuery(this.oMouseDownTarget).control(0,true).getParent()._getHeaderLine();var g=document.getElementById(s.sId);var h=o.getBBox();var l=g.getBBox();i.height+=h.height+l.height}if(this.deltaLineDrag){var p=jQuery(this.oMouseDownTarget).control(0,true).getParent();if(p.getVisibleDeltaStartEndLines()){var d=p._getStartLine();var u=p._getEndLine();var f=p._getHeaderStartLine();var v=p._getHeaderEndLine();var c=document.getElementById(d.sId);var D=document.getElementById(u.sId);var m=document.getElementById(f.sId);var S=document.getElementById(v.sId);var y={headerStartLine:m,startLine:c,headerEndLine:S,endLine:D};var T=m.getBBox();var G=c.getBBox();i.height+=G.height+T.height}}this.createGhostImage(t,i,g,o,y,e);return a};y.prototype.normalizeGhostImageWidth=function(t){return t};y.prototype.createGhostImage=function(t,e,a,i,r,n){var o=this.serializeClonedSvg(e,t,a,i,r);var s=this._b64EncodeUnicode(o);var g="data:image/svg+xml;base64,"+s;this.appendGhostImageToWrapper(t,g,n)};y.prototype._b64EncodeUnicode=function(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function t(e,a){return String.fromCharCode("0x"+a)}))};y.prototype.appendGhostImageToWrapper=function(t,a,i){var r=document.getElementById("sapGanttDragGhostWrapper");var n=this._getDragTextOverlayStyle(t);var o=i?"":"<div id='sapGanttDragText' class='sapGanttDragTextOverlay "+n.css+"'>"+"</div>";var s=e.byId(t.id);var g=!s&&t.parentNode&&e.byId(t.parentNode.id)instanceof sap.gantt.simple.BaseGroup;var h=!s&&t.parentNode&&t.parentNode.parentNode&&e.byId(t.parentNode.parentNode.id)instanceof sap.gantt.simple.BaseGroup;var l=this.getGantt().getEnableMultipleGhosts();if(g){s=e.byId(t.parentNode.id)}else if(h){s=e.byId(t.parentNode.parentNode.id)}if(l&&i&&this.getGantt().getShowTextOnGhost()){o=this._getGhostLabel(s,t)}if(!l){var p=this.getNumberOfDragObject(t);o="<div id='sapGanttDragText' class='sapGanttDragTextOverlay "+n.css+"'>"+p+"</div>"}if(this.bMultipleGhosts){var d;if(g){d=t.parentNode}else if(h){d=t.parentNode.parentNode}else{d=t}this._aShapeNodes.push(d);this._aGhostImages.push(a);if(!i){o=""}}var u="<div class='sapGanttDragGhost'>"+"<img class='sapGanttDragGhostImg' src='"+a+"'>"+o+"</div>";r.insertAdjacentHTML("beforeend",u);if(l&&i&&this.getGantt().getShowTextOnGhost()&&o!==""){this._updateGhostLabelStyle()}};y.prototype._getDragTextOverlayStyle=function(t){var a=e.getConfiguration().getRTL();var i=this.getGantt().getGhostAlignment();var r=this.mDragPoint.shapeWidth,n=this.mDragPoint.shapeX+this.mDragPoint.shapeBias.x,o=this.mDragPoint.cursorX;var s=o-n;var g=document.getElementById("sapGanttDragGhostWrapper");var h="";if(i===c.None){if(a){g.style.setProperty("--sapShapeDragTextOverlay-right-val",r-s+"px")}else{g.style.setProperty("--sapShapeDragTextOverlay-left-val",s+"px")}}else if(i===c.End){h="sapGanttDragTextOverlayGhostAlignEnd"}g.style.setProperty("--sapShapeDragTextOverlay-lineHeight",t.getBBox().height+"px");return{css:h}};y.prototype.serializeClonedSvg=function(t,a,i,r,n){var o=d3.ns.prefix.svg;var s=a.getBBox();var g=e.getConfiguration().getRTL();var h=document.createElementNS(o,"svg");h.setAttribute("width",t.width);h.setAttribute("height",t.height);var l=a.cloneNode(true);l.style.transform="translate(0, 0)";if(!this.getGantt().getShowTextOnGhost()){this.removeOriginalTextNode(l)}else if(g&&(l.tagName==="g"||l.tagName==="text")){this._aOriginalTextX=[];this._iCount=0;this._populateTextNodeX(a);this._repositionTextNode(l)}var p=document.createElementNS(o,"g");p.setAttribute("transform","translate("+-s.x+", "+-s.y+")");p.appendChild(l);if(this.adhocLineDrag){var d=i.cloneNode(true);var u=r.cloneNode(true);p.appendChild(d);p.appendChild(u)}if(this.deltaLineDrag){var f=e.byId(this.oMouseDownTarget.id).getParent();if(f.getVisibleDeltaStartEndLines()){var v=n.headerStartLine.cloneNode(true);var c=n.startLine.cloneNode(true);var D=n.headerEndLine.cloneNode(true);var m=n.endLine.cloneNode(true);p.appendChild(v);p.appendChild(c);p.appendChild(D);p.appendChild(m)}}var S=this.getGantt().getSvgDefs();if(S){var y=jQuery(document.getElementById(S.getId())).get(0).cloneNode(true);h.appendChild(y)}h.appendChild(p);return(new XMLSerializer).serializeToString(h)};y.prototype.removeOriginalTextNode=function(t){if(t.parentNode&&t.tagName==="text"){t.parentNode.removeChild(t)}var e=t.children||t.childNodes;var a=Array.prototype.slice.call(e);a.forEach(function(t){this.removeOriginalTextNode(t)}.bind(this))};y.prototype._repositionTextNode=function(t){if(t.tagName==="text"){t.setAttribute("x",this._aOriginalTextX[this._iCount]);this._iCount++}var e=t.children||t.childNodes;var a=Array.prototype.slice.call(e);a.forEach(function(t){this._repositionTextNode(t)}.bind(this))};y.prototype._populateTextNodeX=function(t){if(t.tagName==="text"){var e=0;var a=t.getAttribute("text-anchor");var i=t.getBBox();if(a==="start"){e=i.x}else if(a==="end"){e=i.x+i.width}else{e=i.x+i.width/2}this._aOriginalTextX.push(e)}var r=t.children||t.childNodes;var n=Array.prototype.slice.call(r);n.forEach(function(t){this._populateTextNodeX(t)}.bind(this))};y.prototype.getNumberOfDragObject=function(t){var a=this.getGantt().getSelection();var i=a.numberOfSelectedDraggableShapes();var r=e.getLibraryResourceBundle("sap.gantt");var n=r.getText("GNT_DRAGGED_OBJECT");var o=r.getText("GNT_DRAGGED_OBJECTS");var s=i>1?o:n;return i+" "+s};y.prototype._disableTextSelection=function(){jQuery(document.body).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none"}).bind("selectstart",function(t){t.preventDefault();return false})};y.prototype._enableTextSelection=function(){jQuery(document.body).attr("unselectable","off").css({"-moz-user-select":"","-webkit-user-select":"","user-select":""}).unbind("selectstart")};y.prototype.isAllowedVerticalOrentationDrag=function(){var t=this.getGantt();if(t.getDragOrientation()===m.Vertical){return t.oSelection.numberOfSelectedDraggableShapes()<2}return true};y.prototype.getRowByShape=function(t){var e=n.getRowInstancefromShape(t);var a=e.clone();a=this._addBackOriginalGanttRowProperties(e,a);return a};y.prototype._addBackOriginalGanttRowProperties=function(t,e){e.oPropagatedProperties=t._getPropertiesToPropagate();e.propagateProperties(true);e.oParent=t.getParent();return e};return y});
//# sourceMappingURL=GanttDragDropExtension.js.map