/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/ui/core/IconPool","./GanttUtils","./RenderUtils","./BasePath","sap/ui/core/theming/Parameters","sap/gantt/library","./CoordinateUtils","./BaseShape"],function(e,t,s,r,a,i,o,n,h,p){"use strict";var l=n.simple.connectorType;var c=6,d=20,g=15,u={FinishToFinish:0,FinishToStart:1,StartToFinish:2,StartToStart:3};var S=i.extend("sap.gantt.simple.Relationship",{metadata:{library:"sap.gantt",properties:{type:{type:"sap.gantt.simple.RelationshipType",group:"Appearance"},predecessor:{type:"string",group:"Data"},successor:{type:"string",group:"Data"},selectedStroke:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"#FF0000"},selectedStrokeWidth:{type:"sap.gantt.SVGLength",defaultValue:2},lShapeForTypeFS:{type:"boolean",defaultValue:true},lShapeForTypeSF:{type:"boolean",defaultValue:true},shapeTypeStart:{type:"sap.gantt.simple.connectorType",defaultValue:l.None},shapeTypeEnd:{type:"sap.gantt.simple.connectorType",defaultValue:l.Arrow},startShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},endShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},selectedStartShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},selectedEndShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},enableCurvedEdge:{type:"boolean",defaultValue:false},relationshipOverDivider:{type:"boolean",defaultValue:false},_lMarker:{type:"string",visibility:"hidden"}}},renderer:{apiVersion:2}});S.prototype.applySettings=function(e){e=e||{};i.prototype.applySettings.apply(this,arguments)};S.prototype._getLMarker=function(){return this.getProperty("_lMarker")};S.prototype.onclick=function(e){if(this.getGanttChartBase().getIsConnectorDetailsVisible()){var s=function(){var e=h.getLatestCursorPosition();var s=e.pageX,r=e.pageY;var a=document.elementsFromPoint(s,r),i=[],o=[];for(var n=0;n<a.length;n++){var p=a[n].parentNode;if(a[n].tagName==="path"&&t.byId(p.id).isA("sap.gantt.simple.Relationship")&&o.indexOf(p.id)===-1){o.push(p.id);var l=t.byId(p.id);i.push(l)}}if(i.length>0){this.getGanttChartBase().fireShapeConnectorList({pageX:s,pageY:r,connectorList:i})}};window.setTimeout(s.bind(this),300)}else{p.prototype.onclick.call(this,e)}};S.prototype.renderElement=function(e,s,a){this.oGantt=t.byId(a);var i=s.getProcessedType();if(!s.mRelatedShapes&&!s.mAnchors&&!r.relationexist(this.oGantt,s)||this.oGantt.getEnablePseudoShapes()&&this.mRelatedShapes.predecessor===this.mRelatedShapes.successor){return}this.mRelatedShapes=s.mRelatedShapes;if(this.mRelatedShapes.predecessor){var o=this.mRelatedShapes.predecessor.getParentRowSettings().getParent().getDomRef();var h=o.clientHeight;this.predYTop=o.offsetTop;this.predYBottom=this.predYTop+h}if(this.mRelatedShapes.successor){var p=this.mRelatedShapes.successor.getParentRowSettings().getParent().getDomRef();var l=p.clientHeight;this.sucYTop=p.offsetTop;this.sucYBottom=this.sucYTop+l}if(this.mRelatedShapes.predecessor&&this.mRelatedShapes.successor&&this.predYTop==this.sucYTop&&this.predYBottom==this.sucYBottom){var c=this.mRelatedShapes.successor.getParentRowSettings().getParent().getAggregation("_settings").getRowUid();var d=this.oGantt._oExpandModel.isRowExpanded(c);var g=this.oGantt.getShowParentRowOnExpand()&&!this.oGantt.getUseParentShapeOnExpand();var u=this.mRelatedShapes.predecessor._level;var S=this.mRelatedShapes.successor._level;if(d&&u&&S){var f=this.oGantt._oExpandModel.getBaseRowHeight();var y=this.oGantt.getExpandedRowHeight()?this.oGantt.getExpandedRowHeight():f;var v=g?this.predYTop+f+(u-1)*y:this.predYTop+(u-1)*y;var P=g?this.predYTop+f+u*y:this.predYTop+u*y;var E=g?this.sucYTop+f+(S-1)*y:this.sucYTop+(S-1)*y;var T=g?this.sucYTop+f+S*y:this.sucYTop+S*y;this.predYTop=v;this.predYBottom=P;this.sucYTop=E;this.sucYBottom=T}}switch(this.oGantt.getRelationshipShapeSize()){case n.simple.relationshipShapeSize.Small:this.SHAPE_SIZE=6;break;case n.simple.relationshipShapeSize.Large:this.SHAPE_SIZE=10;break;default:this.SHAPE_SIZE=8;break}this.calcLinePathD(s.mAnchors,i);this.renderRelationship(e,s.mAnchors,i,a)};S.prototype.getRlsAnchors=function(e,t){var s,r,a;var i=this.getShapeAnchors(t);if(t.predecessor&&t.successor){if(e===u.FinishToFinish){s=i.predecessor.tail;r=i.successor.tail}else if(e===u.FinishToStart){s=i.predecessor.tail;r=i.successor.head}else if(e===u.StartToFinish){s=i.predecessor.head;r=i.successor.tail}else if(e===u.StartToStart){s=i.predecessor.head;r=i.successor.head}}else if(t.predecessor&&!t.successor){if(e===u.FinishToFinish||e===u.FinishToStart){s=i.predecessor.tail;r={x:s.x+d,y:s.y};a={x:r.x,y:r.y+g/2}}else if(e===u.StartToFinish||e===u.StartToStart){s=i.predecessor.head;r={x:s.x-d,y:s.y};a={x:r.x-g,y:r.y+g/2}}}else if(!t.predecessor&&t.successor){if(e===u.FinishToFinish||e===u.StartToFinish){r=i.successor.tail;s={x:r.x+d,y:r.y};a={x:s.x,y:s.y+g/2}}else if(e===u.FinishToStart||e===u.StartToStart){r=i.successor.head;s={x:r.x-d,y:r.y};a={x:s.x-g,y:s.y+g/2}}}return{predecessor:s,successor:r,prompter:a}};S.prototype.calcLinePathD=function(e,s){var r=e.predecessor.x,a=e.predecessor.y;var i=e.successor.x,o=e.successor.y;var n,h=[r,a,i,o];var p=this.oGantt._edgePoint;if(a===o){n=this.calcIRlsPathD}else if(a!==o){if(s===u.FinishToFinish){n=this.calcURlsPathD;h.push(false,p)}else if(s===u.FinishToStart){if(r<=i){if(t.getConfiguration().getRTL()?this.getLShapeForTypeSF():this.getLShapeForTypeFS()){if(p==2&&this.getShapeTypeStart()=="None"||p==3&&Math.abs(r-i)>=p*c){n=this.calcLRlsPathD}else{n=this.calcSRlsPathD;h.push(s,p)}}else{if(Math.abs(r-i)>=2*p*c){n=this.calcZRlsPathD;h.push(p)}else{n=this.calcSRlsPathD;h.push(s,p)}}}else if(r>i){n=this.calcSRlsPathD;h.push(s,p)}}else if(s===u.StartToFinish){if(r<i){n=this.calcSRlsPathD;h.push(s,p)}else if(r>=i){if(t.getConfiguration().getRTL()?this.getLShapeForTypeFS():this.getLShapeForTypeSF()){if(p==2&&this.getShapeTypeStart()=="None"||p==3&&Math.abs(r-i)>=p*c){n=this.calcLRlsPathD}else{n=this.calcSRlsPathD;h.push(s,p)}}else{if(Math.abs(r-i)>=2*p*c){n=this.calcZRlsPathD;h.push(p)}else{n=this.calcSRlsPathD;h.push(s,p)}}}}else if(s===u.StartToStart){n=this.calcURlsPathD;h.push(true,p)}}if(n===this.calcLRlsPathD){var l=e.successor.dyTop?e.successor.dyTop:e.successor.dy;var d=e.successor.dyBottom?e.successor.dyBottom:e.successor.dy;h[2]=r<i?i+e.successor.dx:i-e.successor.dx;h[3]=a<o?o-l:o+d}this.setProperty("d",n.apply(this,h),true)};S.prototype.calcIRlsPathD=function(e,t,s,r){return this.getLinePathD([[e,t],[s,r]])};S.prototype.calcLRlsPathD=function(e,t,s,r){return this.getLinePathD([[e,t],[s,t],[s,r]])};S.prototype.calcURlsPathD=function(e,t,s,r,a,i){var o=e<s?s+i*c:e+i*c;var n=e<s?e-i*c:s-i*c;var h=!a?o:n;if(this.getRelationshipOverDivider()){var p=e<s?e+i*c:s+i*c;var l=e<s?s-i*c:e-i*c;var d=!a?p:l;var g=t>r?this.predYTop:this.predYBottom;var u=t<r?this.sucYTop:this.sucYBottom;if(!a&&e<s||a&&e>s){return this.getLinePathD([[e,t],[d,t],[d,g],[h,g],[h,r],[s,r]])}else{return this.getLinePathD([[e,t],[h,t],[h,u],[d,u],[d,r],[s,r]])}}else{return this.getLinePathD([[e,t],[h,t],[h,r],[s,r]])}};S.prototype.calcSRlsPathD=function(e,t,s,r,a,i){var o=a==1?e+i*c:e-i*c;var n=t>r?this.predYTop:this.predYBottom;var h=a==1?s-i*c:s+i*c;return this.getLinePathD([[e,t],[o,t],[o,n],[h,n],[h,r],[s,r]])};S.prototype.calcZRlsPathD=function(e,t,s,r,a){var i=e<s?e+a*c:e-a*c;if(this.getRelationshipOverDivider()){var o=t<r?this.sucYTop:this.sucYBottom;var n=e<s?s-a*c:s+a*c;return this.getLinePathD([[e,t],[i,t],[i,o],[n,o],[n,r],[s,r]])}else{return this.getLinePathD([[e,t],[i,t],[i,r],[s,r]])}};S.prototype.getConnectorEndPath=function(e,t,s){var r=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(r);var i=[];var o;var n=this.getEnableCurvedEdge()?a[a.length-4]:a[a.length/2-2];var h=this.getEnableCurvedEdge()?a[a.length-3]:a[a.length/2-1];var p=this.getEnableCurvedEdge()?a[a.length-2]:a[a.length/2+0];var l=this.getEnableCurvedEdge()?a[a.length-1]:a[a.length/2+1];if(n==p){if(h>l){i=this.getCoordinateUpDown(p,l,"up");o=a[0]<p?"rightUp":"leftUp"}else{i=this.getCoordinateUpDown(p,l,"down");o=a[0]<p?"rightDown":"leftDown"}}else if(n!=p){i=n<p?this.getCoordinate(p,l,"rightEnd"):this.getCoordinate(p,l,"leftEnd")}return this.renderSvg(i,"end",t,s,o)};S.prototype.getConnectorStartPath=function(e,t,s){var r=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(r);var i=a[0],o=a[1];var n=s==0||s==1?this.getCoordinate(i,o,"rightStart"):this.getCoordinate(i,o,"leftStart");return this.renderSvg(n,"start",t,s)};S.prototype.renderSvg=function(e,t,s,r,a){var i=[];var o=this._checkConnectorOverlap(s,r,t,a);if(o==l.Arrow){if(t=="start"){i.push(e[0],e[1],e[4],e[7])}else{i.push(e[0],e[3],e[5])}return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.Square){i.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.Diamond){i.push(e[0],e[2],e[4],e[6]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.Circle){i.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("basis-closed")(i)}else if(o===l.HorizontalRectangle){i.push(e[0],e[15],e[9],e[10],e[16]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.VerticalRectangle){i.push(e[0],e[11],e[12],e[13],e[14]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.None){i.push(e[0]);return d3.svg.line().interpolate("linear")(i)}};S.prototype._checkConnectorOverlap=function(e,s,a,i){var o=t.byId(e);var n=r._getVisibleRelationships(o);var h=this.getRelatedInRowShapes(e);var p=t.getConfiguration().getRTL();var c,d,g,S=[];var f=function(e){d=[1,2];if(h.predecessor&&h.successor){n.forEach(function(t){if(t.mProperties.successor&&t.mProperties.predecessor){if(h.successor.mProperties.shapeId===t.getSuccessor()&&d.indexOf(u[t.getType()])!==-1&&t._getLMarker()===e){S.push(t.getShapeTypeEnd())}}})}S=r.getFilteredShapeType(S);var t=S.length>1?l.HorizontalRectangle:this.getShapeTypeEnd();if(t==l.VerticalRectangle||t==l.HorizontalRectangle){t=t==l.VerticalRectangle?l.HorizontalRectangle:l.VerticalRectangle}return t}.bind(this);var y=function(e,t){return e===l.Arrow?t:e};if(a=="start"){if(p){d=s==0||s==1?[2,3]:[0,1];g=s==0||s==1?[1,3]:[0,2]}else{d=s==0||s==1?[0,1]:[2,3];g=s==0||s==1?[0,2]:[1,3]}if(h.predecessor&&h.successor){n.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(h.predecessor.mProperties.shapeId==e.getPredecessor()&&d.indexOf(u[e.getType()])!==-1){S.push(y(e.getShapeTypeStart(),"ArrowStart"))}if(h.predecessor.mProperties.shapeId==e.getSuccessor()&&g.indexOf(u[e.getType()])!==-1&&e._getLMarker()==""){S.push(y(e.getShapeTypeEnd(),"ArrowEnd"))}}})}S=r.getFilteredShapeType(S);c=S.length>1?l.HorizontalRectangle:this.getShapeTypeStart()}else{if(i=="rightUp"||i=="rightDown"||i=="leftUp"||i=="leftDown"){c=f(i)}else{if(p){d=s==1||s==3?[0,2]:[1,3];g=s==1||s==3?[0,1]:[2,3]}else{d=s==1||s==3?[1,3]:[0,2];g=s==1||s==3?[2,3]:[0,1]}if(h.predecessor&&h.successor){n.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(h.successor.mProperties.shapeId==e.getSuccessor()&&d.indexOf(u[e.getType()])!==-1&&e._getLMarker()==""){S.push(y(e.getShapeTypeEnd(),"ArrowEnd"))}if(h.successor.mProperties.shapeId==e.getPredecessor()&&g.indexOf(u[e.getType()])!==-1){S.push(y(e.getShapeTypeStart(),"ArrowStart"))}}})}S=r.getFilteredShapeType(S);c=S.length>1?l.HorizontalRectangle:this.getShapeTypeEnd()}}return c};S.prototype.getCoordinate=function(e,t,s){var r=s=="rightStart"||s=="leftEnd"?e+this.SHAPE_SIZE/2:e-this.SHAPE_SIZE/2;var a=s=="rightStart"||s=="leftEnd"?e+this.SHAPE_SIZE:e-this.SHAPE_SIZE;var i=s=="rightStart"||s=="leftEnd"?e+2*c:e-2*c;var o=s=="rightStart"||s=="leftEnd"?e+c:e-c;var n=[[e,t],[e,t-this.SHAPE_SIZE/2],[r,t-this.SHAPE_SIZE/2],[a,t-this.SHAPE_SIZE/2],[a,t],[a,t+this.SHAPE_SIZE/2],[r,t+this.SHAPE_SIZE/2],[e,t+this.SHAPE_SIZE/2],[r,t],[i,t-c/2],[i,t+c/2],[e,t-c],[o,t-c],[o,t+c],[e,t+c],[e,t-c/2],[e,t+c/2]];return n};S.prototype.getCoordinateUpDown=function(e,t,s){var r=s=="up"?t+this.SHAPE_SIZE/2:t-this.SHAPE_SIZE/2;var a=s=="up"?t+this.SHAPE_SIZE:t-this.SHAPE_SIZE;var i=s=="up"?t+2*c:t-2*c;var o=s=="up"?t+c:t-c;var n=[[e,t],[e+this.SHAPE_SIZE/2,t],[e+this.SHAPE_SIZE/2,r],[e+this.SHAPE_SIZE/2,a],[e,a],[e-this.SHAPE_SIZE/2,a],[e-this.SHAPE_SIZE/2,r],[e-this.SHAPE_SIZE/2,t],[e,r],[e+c/2,i],[e-c/2,i],[e+c,t],[e+c,o],[e-c,o],[e-c,t],[e+c/2,t],[e-c/2,t]];return n};S.prototype.getShapeAnchors=function(e){var t={predecessor:null,successor:null};Object.keys(e).forEach(function(s){var r=e[s];if(r==null){return}if(r.getShapeAnchors){t[s]=r.getShapeAnchors()}else{var a,i,o;if(r.getDomRef("nonLabelGroup")){a=r.getDomRef("nonLabelGroup").getBBox();i=3/4;o=1/4}else{a=r.getDomRef().getBBox();i=1/2;o=1/2}var n,h=0;n=window.getComputedStyle(r.getDomRef()).transform.match(/matrix.*\((.+)\)/);if(n){h=n[1].split(", ")[5]}t[s]={head:{x:a.x,y:a.y+a.height*i+parseFloat(h),dx:0,dyTop:a.height*i,dyBottom:a.height*o},tail:{x:a.x+a.width,y:a.y+a.height*i+parseFloat(h),dx:0,dyTop:a.height*i,dyBottom:a.height*o}}}});return t};S.prototype.renderRelationship=function(i,o,n,h){this.writeElementData(i,"g",true);a.renderAttributes(i,this,["style"]);i.openEnd();a.renderTooltip(i,this);i.openStart("path");if(!this.getEnableCurvedEdge()||o.prompter){i.attr("d",this.getD())}else{i.style("fill","none");i.attr("d",r.getPathCorners(this.getD(),5))}i.openEnd().close("path");i.openStart("path");if(!this.getEnableCurvedEdge()||o.prompter){i.attr("d",this.getD());i.style("fill","none")}else{i.style("fill","none");i.attr("d",r.getPathCorners(this.getD(),5))}i.style("stroke-width",8);i.style("stroke","none");i.style("pointer-events","stroke");i.openEnd().close("path");i.openStart("path");i.style("fill",this.getStartShapeColor());i.style("stroke-dasharray","none");i.attr("d",this.getConnectorStartPath(this.getD(),h,n));i.openEnd().close("path");i.openStart("path");i.style("fill",this.getEndShapeColor());i.style("stroke-dasharray","none");i.attr("d",this.getConnectorEndPath(this.getD(),h,n));i.openEnd().close("path");if(o.prompter){i.openStart("text");i.attr("x",o.prompter.x);i.attr("y",o.prompter.y);i.attr("font-size",g);i.attr("font-family","SAP-icons");i.attr("text-anchor",t.getConfiguration().getRTL()&&!e.browser.edge?"end":"start");i.attr("stroke-width",0);i.openEnd();i.text(s.getIconInfo("chain-link").content);i.close("text")}i.close("g")};S.prototype.getStyle=function(){return this.getInlineStyle({fill:this.getStroke()||o.get("sapUiBaseText"),stroke:this.getStroke()||o.get("sapUiBaseText"),"stroke-width":this.getStrokeWidth()||1,"stroke-dasharray":this.getStrokeDasharray(),opacity:this.getStrokeOpacity()})};S.prototype.getLinePathD=function(e){if(this.getEnableCurvedEdge()){return d3.svg.line().interpolate("linear")(e)}else{e=e.concat(e.slice(1,-1).reverse());return d3.svg.line().interpolate("linear-closed")(e)}};S.prototype.getSelectedStyle=function(){return this.getInlineStyle({fill:this.getSelectedStroke(),stroke:this.getSelectedStroke(),"stroke-width":this.getSelectedStrokeWidth(),"stroke-dasharray":this.getStrokeDasharray(),"pointer-events":"none"})};S.prototype.getBaseRowHeight=function(e){return t.byId(e).getTable()._getDefaultRowHeight()};S.prototype.getProcessedType=function(){var e=this.getProperty("type");var s=t.getConfiguration().getRTL();return s?3-u[e]:u[e]};S.prototype.getRelatedInRowShapes=function(e){var t=r.shapeElementById(this.getPredecessor(),e+"-svg");var s=r.shapeElementById(this.getSuccessor(),e+"-svg");return{predecessor:t?t:r.isRelationshipConnectedToPseudoShapes(this.getPredecessor(),e),successor:s?s:r.isRelationshipConnectedToPseudoShapes(this.getSuccessor(),e)}};return S},true);
//# sourceMappingURL=Relationship.js.map