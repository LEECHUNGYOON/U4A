/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/gantt/library","sap/base/util/ObjectPath","sap/gantt/axistime/AxisTimeStrategyBase","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/gantt/config/TimeHorizon","sap/gantt/axistime/ProportionTimeLineOptions"],function(t,e,o,i,a,s,r,n){"use strict";var m=i.extend("sap.gantt.axistime.ProportionZoomStrategy",{metadata:{library:"sap.gantt"}});m.prototype.init=function(){this._aZoomRate=new Array(10);this.setProperty("coarsestTimeLineOption",n["1month"],true);this.setProperty("finestTimeLineOption",n["5min"],true);this.setProperty("timeLineOptions",n,true);this.setProperty("timeLineOption",n["4day"],true);this.setProperty("zoomLevel",0,true);this.setProperty("zoomLevels",10,true)};m.prototype.applySettings=function(t){i.prototype.applySettings.call(this,t);this.initialSettings=t;return this};m.prototype.setVisibleHorizon=function(t){this.setVisibleHorizonWithReason(t,"visibleHorizonUpdated");return this};m.prototype.setVisibleHorizonWithReason=function(t,e,o,a){if(t&&!t.getStartTime()&&!t.getEndTime()){this._bHorizontalScroll=false}else{this._bHorizontalScroll=!!(t&&(!t.getStartTime()||!t.getEndTime()))}var s=this.getVisibleHorizon();if(s){s=s.clone()}i.prototype._setVisibleHorizon.apply(this,arguments);if(s){this.fireRedrawRequest(false,e,s,o,a)}return this};m.prototype.setTotalHorizon=function(t){i.prototype._setTotalHorizon.apply(this,arguments);if(this.getAxisTime()){this.calZoomBase();this.createAxisTime(this.getAxisTime().getLocale());this.fireRedrawRequest(true,"totalHorizonUpdated")}return this};m.prototype.updateStopInfo=function(t){this.setZoomLevel(t.index);return this};m.prototype.setZoomLevel=function(t){performance.mark("ProportionZoomStrategy.setZoomLevel--start");var e=sap.gantt.simple.VisibleHorizonUpdateSubType;if(t>=0&&t!==this.getZoomLevel()){var o=t>this.getZoomLevel()?e.ZoomIn:e.ZoomOut;this.setProperty("zoomLevel",t,true);if(this._aZoomRate[t]){var i=this.calVisibleHorizonByRate(this._aZoomRate[t]);this.setVisibleHorizonWithReason(i,"zoomLevelChanged",null,o)}}performance.mark("ProportionZoomStrategy.setZoomLevel--end");return this};m.prototype.setZoomLevels=function(t){this.setProperty("zoomLevels",t,true);if(t>1){this._aZoomRate=new Array(t)}else{this._aZoomRate=[1]}this._updateZoomRateOnStops();return this};m.prototype.syncContext=function(t){var e=false,o=false;var i={zoomLevel:undefined,axisTimeChanged:false};var s=this.getParent()?this.getParent()._iLastVisibleWidth:null;var r=s?s:this.getGanttVisibleWidth();if(r&&t!==r){this._updateVisibleHorizon(t)}var n=this._determineZoomBoundaryByStrategy();var m=this._determineZoomRateByChartWidth(t);if(m){this.updateGanttVisibleWidth(t);var h=this._oZoom.minRate||-1;this._oZoom.minRate=Math.max(n.minRate,m.minRate)||n.minRate;var l=this._oZoom.maxRate||-1;this._oZoom.maxRate=n.maxRate;var p=this._oZoom.rate||-1;o=!a.floatEqual(h,this._oZoom.minRate)||!a.floatEqual(l,this._oZoom.maxRate);if(o){this._updateZoomRateOnStops();this._adjustRateByBoundary()}if(m.suitableRate&&!this._bHorizontalScroll){this._oZoom.rate=m.suitableRate;this._adjustRateByBoundary()}this._bHorizontalScroll=false;var u=this.getZoomLevel(),g=this._calcZoomLevelFromZoomRate(this._oZoom.rate);var f=u!==g&&!this.getParent()._isDisplayTypeChanged;if(f){this.setProperty("zoomLevel",g,true)}i.zoomLevel=this.getZoomLevel();e=!a.floatEqual(p,this._oZoom.rate);if(e){this.getParent().getAxisTime().setZoomRate(this._oZoom.rate);this._updateTimeLineOption()}i.axisTimeChanged=e}return i};m.prototype._updateVisibleHorizon=function(t){var e=this.getVisibleHorizon();var o=this.getGanttVisibleWidth();var s=a.calculateHorizonByWidth(e,o,t);i.prototype._setVisibleHorizon.call(this,s)};m.prototype.updateInitialVisibleHorizon=function(t,e){this.getParent().getAxisTime().setZoomRate(this._aZoomRate[e]);this._updateTimeLineOption();i.prototype._setVisibleHorizon.call(this,t)};m.prototype._adjustRateByBoundary=function(){if(this._oZoom.rate){this._oZoom.rate=Math.max(this._oZoom.rate,this._oZoom.minRate);this._oZoom.rate=Math.min(this._oZoom.rate,this._oZoom.maxRate)}};m.prototype._updateZoomRateOnStops=function(){if(this._oZoom&&this._oZoom.maxRate&&this._oZoom.minRate){var t=this._oZoom.maxRate,e=this._oZoom.minRate,o=this.getZoomLevels();this._oLog={};this._oLog.fMax=Math.log(t);this._oLog.fMin=Math.log(e);this._oLog.fStep=(this._oLog.fMax-this._oLog.fMin)/o;if(o>0){for(var i=0;i<o;i++){this._aZoomRate[i]=Math.pow(Math.E,this._oLog.fMin+this._oLog.fStep*i)}}else{this._aZoomRate[0]=1}}};m.prototype._calcZoomLevelFromZoomRate=function(t){if(this._oZoom&&this._oLog&&t){return Math.round((Math.log(t)-this._oLog.fMin)/this._oLog.fStep)}};m.prototype._determineZoomBoundaryByStrategy=function(){if(this._oZoom&&this._oZoom.base){var t=this.getCoarsestTimeLineOption(),e=this.getFinestTimeLineOption();return{minRate:this._oZoom.base.scale/this.calZoomScale(t.innerInterval.unit,t.innerInterval.span,t.innerInterval.range),maxRate:this._oZoom.base.scale/this.calZoomScale(e.innerInterval.unit,e.innerInterval.span,e.innerInterval.range*4)}}};m.prototype._determineZoomRateByChartWidth=function(e){var o=this.getTotalHorizon(),r=this.getVisibleHorizon(),n={};if(!this._oZoom){return null}if(!a.judgeTimeHorizonValidity(r,o)){this.getVisibleHorizon().setStartTime(o.getStartTime(),true);this.getVisibleHorizon().setEndTime(o.getEndTime(),true);t.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.ProportionZoomStrategy.syncContext()")}if(o){var m=this.calZoomScaleByDate(s.abapTimestampToDate(o.getStartTime()),s.abapTimestampToDate(o.getEndTime()),e);n.minRate=this._oZoom.base.scale/m}if(r&&r.getStartTime()&&r.getEndTime()){var h=r.getStartTime();var l=r.getEndTime();if(h===l){i.prototype._setVisibleHorizon.call(this,o);var p=this.calVisibleHorizonByRate(this._aZoomRate[this.getZoomLevel()]);i.prototype._setVisibleHorizon.call(this,p);h=p.getStartTime();l=p.getEndTime()}var u=this.calZoomScaleByDate(s.abapTimestampToDate(h),s.abapTimestampToDate(l),e);n.suitableRate=this._oZoom.base.scale/u}return n};m.prototype._updateTimeLineOption=function(){var t=s.getTimeStampFormatter().parse("20000101000000"),e,i,a=this.getTimeLineOptions(),r=this.getProperty("timeLineOption");var n=this.getAxisTime();if(n){var m=n.timeToView(t);for(i in a){var h=a[i].innerInterval;var l=n.timeToView(o.get(h.unit).offset(t,h.span));var p=Math.abs(Math.ceil(l-m));if(p>=h.range){e=i;break}}r=e?a[e]:a[i];this.setProperty("timeLineOption",r,true)}};m.prototype.onSetTimeZoomRate=function(t){var e=this.calVisibleHorizonByRate(t);this.setVisibleHorizon(e)};m.prototype.getCurrentVisibleHorizon=function(){var t=this.getTotalHorizon(),e=this.getZoomLevel();if(!t||e===undefined){return undefined}var o=this._completeTimeHorizon(this.calVisibleHorizonByRate(this._aZoomRate[e]));return o};m.prototype.getRenderedVisibleHorizon=function(){var t=this.getTotalHorizon(),e=this.getZoomLevel(),o=this.getParent();if(!o||!t||e===undefined){return undefined}var i=o.getRenderedTimeRange();var a=new r({startTime:i[0],endTime:i[1]});return a};return m},true);
//# sourceMappingURL=ProportionZoomStrategy.js.map