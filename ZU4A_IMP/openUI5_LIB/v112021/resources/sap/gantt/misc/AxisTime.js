/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/core/Core","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/gantt/simple/GanttUtils","sap/gantt/misc/Memoizer","sap/ui/core/format/TimezoneUtil","sap/ui/core/date/UI5Date"],function(e,t,i,a,o,s,n,r){"use strict";var l={};var f=function(e,t,a,o,n,r,l){this.scale=d3.time.scale().domain(e).range(t).clamp(false);this.timeRange=e;this.viewRange=t;this.zoomRate=i.assign(a,1);this.zoomOrigin=i.assign(o,0);this.viewOffset=i.assign(n,0);this.locale=r;this._shapeWidthValue=s.createCache();this.timeZoneOffset=0;this._oZoomStrategy=l};f.prototype.CONSTANT={C_SEPARATOR:"_@@_",C_MESSAGE:{ARGUMENT_ERROR:"AxisOrdinal: Argument Error!"}};f.prototype.timeToView=function(e,i){if(t.getConfiguration().getRTL()!==true){return(this.scale(e)-this.zoomOrigin)*this.zoomRate-(i?0:this.viewOffset)}else{return this.viewRange[1]*this.zoomRate-((this.scale(e)+this.zoomOrigin)*this.zoomRate+(i?0:this.viewOffset))}};f.prototype.viewToTime=function(e,i){if(t.getConfiguration().getRTL()!==true){return this.scale.invert((e+(i?0:this.viewOffset))/this.zoomRate+this.zoomOrigin)}else{return this.scale.invert(this.viewRange[1]-(e+(i?0:this.viewOffset))/this.zoomRate-this.zoomOrigin)}};f.prototype.setTimeRange=function(e){if(this.timeRange[0].getTime()!=e[0].getTime()||this.timeRange[1].getTime()!=e[1].getTime()){this._shapeWidthValue.clearCache()}this.timeRange=e;this.scale.domain(e);return this};f.prototype.getTimeRange=function(){return this.scale.domain()};f.prototype.getTimeRangeSlice=function(e,i){var a=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(e),this.timeZoneOffset):this.viewToTime(e);var o=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(i),this.timeZoneOffset):this.viewToTime(i);if(t.getConfiguration().getRTL()!==true){return[a,o]}else{return[o,a]}};f.prototype.setViewRange=function(e){this.viewRange=e;this.scale.range(e);return this};f.prototype.getViewRange=function(){var e=this.scale.range();return[Math.round((e[0]-this.zoomOrigin)*this.zoomRate-this.viewOffset),Math.round((e[1]-this.zoomOrigin)*this.zoomRate-this.viewOffset)]};f.prototype.getZoomStrategy=function(){return this._oZoomStrategy};f.prototype.setZoomRate=function(e){this.zoomRate=i.assign(e,1);return this};f.prototype.getZoomRate=function(){return this.zoomRate};f.prototype.setZoomOrigin=function(e){if(this.zoomOrigin!=e){this._shapeWidthValue.clearCache()}this.zoomOrigin=i.assign(e,0);return this};f.prototype.getZoomOrigin=function(){return this.zoomOrigin};f.prototype.setViewOffset=function(e){this.viewOffset=i.assign(e,0);return this};f.prototype.getViewOffset=function(){return this.viewOffset};f.prototype.setLocale=function(e){this.locale=e;return this};f.prototype.getLocale=function(){return this.locale};f.prototype.clone=function(){return new f([new Date(this.timeRange[0].valueOf()),new Date(this.timeRange[1].valueOf())],this.viewRange.slice(0),this.zoomRate,this.zoomOrigin,this.viewOffset,this.locale,this._oZoomStrategy)};f.prototype._get2dContext=function(e,t){if(!l.context){l.context=document.createElement("canvas").getContext("2d")}if(l.fontSize!==e||l.fontFamily!==t){l.context.font=e+"px "+t;l.fontSize=e;l.fontFamily=t}return l.context};f.prototype._getShapeTextWidth=function(e,t,i){return this._get2dContext(t,i).measureText(e).width};f.prototype.getCurrentTickTimeIntervalLevel=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions(),i=0;for(var a in t){if(t[a]===e){return i}i++}};f.prototype.getCurrentTickTimeIntervalKey=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions();for(var i in t){if(t[i]===e){return i}}};f.prototype.getNowLabel=function(e){var t=new Date;if(e===undefined||e){t=this.convertToTimezone(t,"UTC");t=this.offsetTimezoneDiff(t)}var i=this.timeToView(t);return[{date:t,value:Math.round(i)}]};f.prototype.getFirstSmallIntervalIndex=function(e,t){for(var i=0;i<e.length;i++){var o=a.dateToAbapTimestamp(e[i].date);if(o>=t){return i}}};f.prototype.getTickTimeIntervalLabel=function(o,s,n){var r,l,h,g=null;var m=a.getTimeStampFormatter();var u=[];if(g){for(r=0;r<g.length;r++){u[r]={};l=g[r].getStartTime();h=g[r].getEndTime();u[r].startDate=m.parse(l);u[r].endDate=m.parse(h)}}var c=this.timeZoneOffset?[d3.time.second.offset(this.timeRange[0],this.timeZoneOffset),d3.time.second.offset(this.timeRange[1],this.timeZoneOffset)]:this.timeRange;var v=new f(c,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy);var T=null;var p=null;var d=null;var w=null;var y=null;var S=null;var O=null;var R=[];var z=[];var Z=null;if(s){S=this.timeZoneOffset?d3.time.second.offset(s[0],this.timeZoneOffset):s[0];O=this.timeZoneOffset?d3.time.second.offset(s[1],this.timeZoneOffset):s[1];T=this.timeZoneOffset?[d3.time.second.offset(s[0],this.timeZoneOffset),d3.time.second.offset(s[1],this.timeZoneOffset)]:s;p=[this.timeToView(s[0]),this.timeToView(s[1])];if(u&&u.length){this._calculateTimeRange(u,S,O,R)}Z=this._calculateScale(R,z,T,p,false)}else if(n){S=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(n[0]),this.timeZoneOffset):this.viewToTime(n[0]);O=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(n[1]),this.timeZoneOffset):this.viewToTime(n[1]);T=[S,O];p=n;if(u.length){this._calculateTimeRange(u,S,O,R)}Z=this._calculateScale(R,z,T,p,false)}else{S=c[0];O=c[1];T=c;p=this.viewRange;if(u.length){this._calculateTimeRange(u,S,O,R)}Z=this._calculateScale(R,z,T,p,c)}z=Z.viewRangeSet;d=Z.visibleScale;w=Z.dstScale;y=Z.normalScale;var _=[];var L,D,k,b;var C={unit:this._oZoomStrategy.getTimeLineOption().largeInterval.unit,span:this._oZoomStrategy.getTimeLineOption().largeInterval.span};var I={unit:this._oZoomStrategy.getTimeLineOption().smallInterval.unit,span:this._oZoomStrategy.getTimeLineOption().smallInterval.span};var F,V;var x=this._oZoomStrategy.getUpperRowFormatter(),P=this._oZoomStrategy.getLowerRowFormatter();if(C){var M=[];var A=[];var E=[];if(!(d instanceof Array)){M[0]=this._getTimeIntervalTicks(C,d)}else{for(F=0;F<w.length;F++){A[F]=w[F].ticks(e.get(C.unit).range,C.span);E[F]=y[F].ticks(e.get(C.unit).range,C.span)}for(F=0;F<d.length;F++){M[F]=d[F].ticks(e.get(C.unit).range,C.span)}}var U=[];if(M[0]!==null){for(F=0;F<M.length;F++){for(V=0;V<M[F].length;V++){L=this.offsetTimezoneDiff(M[F][V]);k=v.timeToView(L);b=i.getLowerCaseLabel(this.locale.getFormattedDate(x,L));U.push({date:L,value:Math.round(k),label:b})}}}if(A[0]!==null){for(F=0;F<A.length;F++){for(V=0;V<A[F].length;V++){L=A[F][V];D=E[F][V];k=v.timeToView(d3.time.second.offset(L.getTime(),-60*60));b=i.getLowerCaseLabel(this.locale.getFormattedDate(x,L));U.push({date:L,value:Math.round(k),label:b})}}}_.push(U)}else{_.push([])}if(I){var H=[];var W=[];var G=[];if(!(d instanceof Array)){G[0]=this._getTimeIntervalTicks(I,d)}else{for(F=0;F<w.length;F++){H[F]=w[F].ticks(e.get(I.unit).range,I.span);W[F]=y[F].ticks(e.get(I.unit).range,I.span)}for(F=0;F<d.length;F++){G[F]=d[F].ticks(e.get(I.unit).range,I.span)}}var N=[];if(G[0]){for(F=0;F<G.length;F++){for(V=0;V<G[F].length;V++){L=this.offsetTimezoneDiff(G[F][V]);var q;var j=false;if(u.length){for(var K=0;K<u.length;K++){if(L.getTime()===u[K].startDate.getTime()){q=d3.time.second.offset(L.getTime(),60*60);if(V===G[F].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){j=true}}if(V===G[F].length-1&&L.getTime()===d3.time.second.offset(u[K].endDate.getTime(),60*60).getTime()){q=d3.time.second.offset(L.getTime(),-60*60)}}}k=v.timeToView(L);var Y;if(j){break}else if(q){Y=i.getLowerCaseLabel(this.locale.getFormattedDate(x,q));b=i.getLowerCaseLabel(this.locale.getFormattedDate(P,q));q=null}else{Y=i.getLowerCaseLabel(this.locale.getFormattedDate(x,L));b=i.getLowerCaseLabel(this.locale.getFormattedDate(P,L))}N.push({date:L,value:Math.round(k),label:b,largeLabel:Y})}}}if(H[0]){for(F=0;F<H.length;F++){for(V=0;V<H[F].length;V++){L=H[F][V];D=W[F][V];var B;var J=false;if(V===H[F].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){if(R.length>0){for(var Q=0;Q<R.length;Q++){if(!R[Q].haveDST&&D.getTime()===R[Q].range[0].getTime()){J=true}}}}if(u.length){for(var X=0;X<u.length;X++){if(L.getTime()===u[X].startDate.getTime()){B=d3.time.second.offset(L.getTime(),60*60)}if(V===H[F].length-1&&L.getTime()===d3.time.second.offset(u[X].endDate.getTime(),60*60).getTime()){B=d3.time.second.offset(L.getTime(),-60*60)}}}if(!this._oZoomStrategy.isLowerRowTickHourSensitive()){k=v.timeToView(d3.time.second.offset(L.getTime(),-60*60))}else{k=v.timeToView(D)}if(J){break}else if(B){b=i.getLowerCaseLabel(this.locale.getFormattedDate(P,B));B=null}else{b=i.getLowerCaseLabel(this.locale.getFormattedDate(P,L))}N.push({date:L,value:Math.round(k),label:b})}}}_.push(N)}else{_.push([])}var $=_[0];var ee=_[1];var te=this.getZoomStrategy().getVisibleHorizon().getStartTime();this.largeIntervalLabel=true;this.largeIntervalPath=false;var ie=this.getFirstSmallIntervalIndex(ee,te);var ae,oe,se=30;var ne,re,le=0;var fe=t.getConfiguration().getRTL();if(ee[ie]){var he=ee[ie].largeLabel;this.firstTickPosition=ee[ie].value;var ge=false;var me=document.querySelector(".sapGanttTimeHeaderSvgText")||document.querySelector(".sapGanttTimeHeaderSvgText0");if(me){var ue=getComputedStyle(me);ne=ue.fontSize;re=ue.fontFamily;le=Math.ceil(this._getShapeTextWidth(he,ne,re))+se}ae=fe?this.firstTickPosition-le:this.firstTickPosition+le;for(r=0;r<$.length;r++){le=me?Math.ceil(this._getShapeTextWidth($[r].label,ne,re))+se:0;oe=fe?$[r].value-le:$[r].value+le;var ce=fe?$[r].value<this.firstTickPosition&&$[r].value>=ae:$[r].value>this.firstTickPosition&&$[r].value<=ae;var ve=fe?this.firstTickPosition<$[r].value&&this.firstTickPosition>=oe:this.firstTickPosition>$[r].value&&this.firstTickPosition<=oe;var Te=$[r].label!==he;if(ce||ve&&Te){this.largeIntervalLabel=false;break}}if(this.largeIntervalLabel){for(r=0;r<$.length;r++){if($[r].label===he){if($[r].value===this.firstTickPosition){this.largeIntervalPath=true}$[r].value=this.firstTickPosition;ge=true;break}}if(!ge){var pe={value:this.firstTickPosition,label:he};_[0].push(pe)}}}return _};f.prototype._getTimeIntervalTicks=function(t,i){if(t.unit!==sap.gantt.config.TimeUnit.week){return i.ticks(e.get(t.unit).range,t.span)}var a=["d3.time.sunday","d3.time.monday","d3.time.tuesday","d3.time.wednesday","d3.time.thursday","d3.time.friday","d3.time.saturday"];return i.ticks(e.get(a[this.getZoomStrategy().getFirstDayOfWeek()]).range,t.span)};f.prototype._calculateScale=function(e,t,i,a,o){var s=null;var n=[];var r=[];if(e.length){s=[];var l=0;var h=0;for(var g=0;g<e.length;g++){t[g]=[this.timeToView(e[g].range[0]),this.timeToView(e[g].range[1])];if(e[g].haveDST){n[l]=new f(e[g].dstRange,t[g],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;r[l]=new f(e[g].range,t[g],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;l++}else{s[h]=new f(e[g].range,t[g],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;h++}}}else if(o){s=new f(o,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale}else{i=[this.convertToTimezone(i[0]),this.convertToTimezone(i[1])];s=new f(i,a,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale}var m={viewRangeSet:t,visibleScale:s,dstScale:n,normalScale:r};return m};f.prototype._calculateTimeRange=function(e,t,i,a){if(e.length){var o=t;var s=i;var n=[];var r=[];var l,f;l=e[0].startDate;f=e[0].endDate;this._calculateRangeItem(l,f,o,s,n,r);if(e.length>1){for(var h=1;h<e.length;h++){if(n.length){var g=[];for(var m in n){g.push(n[m])}n=[];for(var u=0;u<g.length;u++){l=e[h].startDate;f=e[h].endDate;o=g[u].range[0];s=g[u].range[1];this._calculateRangeItem(l,f,o,s,n,r)}}}}for(var c in r){a.push(r[c])}for(var v in n){a.push(n[v])}}};f.prototype._calculateRangeItem=function(e,t,i,a,o,s){var n=null;if(i<e){if(a<t){if(a>e){n={};n.haveDST=false;n.range=[i,e];o.push(n);n={};n.haveDST=true;n.range=[e,a];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(a,60*60)];s.push(n)}else{n={};n.haveDST=false;n.range=[i,a];o.push(n)}}else{n={};n.haveDST=false;n.range=[i,e];o.push(n);n={};n.haveDST=true;n.range=[e,t];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(t.getTime(),60*60)];s.push(n);n={};n.haveDST=false;n.range=[t,a];o.push(n)}}else if(i>=e){if(i<t){if(a<=t){n={};n.haveDST=true;n.range=[i,a];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(a,60*60)];s.push(n)}else{n={};n.haveDST=true;n.range=[i,t];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(t.getTime(),60*60)];s.push(n);n={};n.haveDST=false;n.range=[t,a];o.push(n)}}else{n={};n.haveDST=false;n.range=[i,a];o.push(n)}}};f.prototype.convertToTimezone=function(e,t){var i=t||this.locale.getTimeZone();if(i!==n.getLocalTimezone()){var a=new r([e],i);return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds(),a.getMilliseconds())}return e};f.prototype.offsetTimezoneDiff=function(e){var t=this.locale.getTimeZone();if(t!==n.getLocalTimezone()){var i=e.getTime();var a=this.convertToTimezone(e,t);var o=a.getTime()-i;return new Date(i+o*-1)}return e};return f},true);
//# sourceMappingURL=AxisTime.js.map