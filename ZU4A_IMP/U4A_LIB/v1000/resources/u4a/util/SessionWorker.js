sap.ui.define("u4a.util.SessionWorker",["sap/ui/core/Control"],(function(e){"use strict";return e.extend("u4a.util.SessionWorker",{metadata:{library:"u4a.util",properties:{minute:{type:"int",defaultValue:0},activeWorker:{type:"boolean",defaultValue:!0}},events:{finished:{allowPreventDefault:!0}}},_oWorker:null,_sDynamicWorkerUrl:null,_maxMinute:120,_bVisHandlerRegistered:!1,_deadlineTs:null,_lastCycleStartTs:null,_dumpAndThrow:function(e){throw"undefined"!=typeof oU4AErroHandle&&"function"==typeof oU4AErroHandle.seterroHTML&&oU4AErroHandle.seterroHTML(e),new Error(e)},_terminateWorker:function(){if(this._oWorker)try{this._oWorker.terminate()}catch(e){}this._sDynamicWorkerUrl&&(URL.revokeObjectURL(this._sDynamicWorkerUrl),this._sDynamicWorkerUrl=null),this._oWorker=null},renderer:function(e,t){e.write("<div"),e.writeControlData(t),e.addStyle("display","none"),e.writeStyles(),e.write("></div>")},_getWorkerScript:function(){return'\n        /***************************************************\n         * u4a.util.SessionWorker 용 워커 스크립트\n         ***************************************************/\n        \n        self.workInterval = null;\n        self.keepTime = null;\n        self.targetTime = null;\n\n        self.onmessage = function(e){\n          var d = e.data;\n          if(d && d.cmd === "start"){\n            if(self.workInterval){ clearInterval(self.workInterval); self.workInterval = null; }\n            self.keepTime = d.keeptime * 60000; // 분 → ms (float 허용)\n            self.targetTime = Date.now() + self.keepTime;\n\n            self.workInterval = setInterval(function(){\n              var remain = self.targetTime - Date.now();\n              if(remain <= 0){\n                postMessage("X");\n                clearInterval(self.workInterval);\n                self.workInterval = null;\n              }\n            }, 1000);\n          }\n          if(d && d.cmd === "stop"){\n            if(self.workInterval){ clearInterval(self.workInterval); self.workInterval = null; }\n          }\n        };\n      '},_createDynamicWorker:function(){if(!(this._oWorker instanceof Worker))try{const e=new Blob([this._getWorkerScript()],{type:"application/javascript"});this._sDynamicWorkerUrl=URL.createObjectURL(e),this._oWorker=new Worker(this._sDynamicWorkerUrl),this._oWorker.onerror=function(e){this._terminateWorker(),this._dumpAndThrow("[SessionWorker] Worker runtime error: "+e.message)}.bind(this),this._oWorker.onmessage=function(e){"X"===e.data&&this._onCycleFinishedFromWorker()}.bind(this)}catch(e){this._terminateWorker(),this._dumpAndThrow("[SessionWorker] Failed to create dynamic worker: "+e.message)}},_armDeadlineIfNeeded:function(){if(null==this._deadlineTs){const e=6e4*this.getMinute();this._lastCycleStartTs=Date.now(),this._deadlineTs=this._lastCycleStartTs+e}},_getRemainMs:function(){return null==this._deadlineTs?0:this._deadlineTs-Date.now()},_startWorkerForRemain:function(e){this._createDynamicWorker();const t=e/6e4;try{this._oWorker.postMessage({cmd:"start",keeptime:t})}catch(e){this._terminateWorker(),this._dumpAndThrow("[SessionWorker] postMessage(start) failed: "+e.message)}},_onCycleFinishedFromWorker:function(){if(this.fireFinished(),this.getActiveWorker()&&this.getMinute()>0){const e=6e4*this.getMinute();this._lastCycleStartTs=Date.now(),this._deadlineTs=this._lastCycleStartTs+e;const t=this._getRemainMs();t>0&&this._startWorkerForRemain(t)}else this._deadlineTs=null,this._terminateWorker()},_resumeByDeadline:function(){if(!this.getActiveWorker())return void this._terminateWorker();if(this.getMinute()<=0)return void this._terminateWorker();this._armDeadlineIfNeeded();const e=this._getRemainMs();e<=0?this._onCycleFinishedFromWorker():this._startWorkerForRemain(e)},onAfterRendering:function(){const e=this.getActiveWorker(),t=this.getMinute();if(!e)return this._terminateWorker(),void(this._deadlineTs=null);if(t<0&&(this._terminateWorker(),this._deadlineTs=null,this._dumpAndThrow("The 'minute' must not be negative.")),0===t)return this._terminateWorker(),void(this._deadlineTs=null);t>this._maxMinute&&(this._terminateWorker(),this._deadlineTs=null,this._dumpAndThrow("The 'minute' cannot exceed 120.")),this._armDeadlineIfNeeded();const r=this._getRemainMs();r<=0?this._onCycleFinishedFromWorker():this._startWorkerForRemain(r),this._registerVisibilityHandler()},_registerVisibilityHandler:function(){this._bVisHandlerRegistered||(this._bVisHandlerRegistered=!0,document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&this._resumeByDeadline()}.bind(this)))},exit:function(){this._deadlineTs=null,this._terminateWorker()}})}));