sap.ui.define("u4a.util.PressTrigger",["sap/ui/core/Control"],function(a){"use strict";var b=a.extend("u4a.util.PressTrigger",{metadata:{library:"u4a.util",properties:{second:{type:"int",defaultValue:0},immediateRun:{type:"boolean",defaultValue:!1}},events:{finished:{allowPreventDefault:!0}}},renderer:function(a,b){a.write("<div"),a.writeControlData(b),a.addStyle("display","none"),a.writeStyles(),a.write("></div>")},onAfterRendering:function(){console.log("PressTrigger --- onAfterRendering"),this._detachBrowserEvents(),this._clearTriggerTimer(),this._unregisterVisibilityHandler(),this._registerVisibilityHandler(),this._isRunnable()&&(this._attachBrowserEvents(),this._startTriggerTimer())},_isRunnable:function(){return!0===this.getImmediateRun()&&0<this.getSecond()},_startTriggerTimer:function(){this._clearTriggerTimer();const a=this.getSecond();0>=a||(this._triggerTimerStartTime=Date.now(),this._triggerTimer=setTimeout(function(){this._handleInactivityTimeout()}.bind(this),1e3*a))},_clearTriggerTimer:function(){this._triggerTimer&&(clearTimeout(this._triggerTimer),this._triggerTimer=null)},_restartTriggerTimer:function(){this._clearTriggerTimer(),this._isRunnable()&&this._startTriggerTimer()},_attachBrowserEvents:function(){const a=sap.ui.Device.os.name,b=".u4aPressTrigger_"+this.getId(),c=this._onUserAction.bind(this);this._eventNamespace=b,this._boundHandler=c,"win"===a?$(window).on("click"+b,c):$(window).on("touchstart"+b,c),$(document).on("keyup"+b,c)},_detachBrowserEvents:function(){this._eventNamespace&&($(window).off(this._eventNamespace),$(document).off(this._eventNamespace),this._eventNamespace=null,this._boundHandler=null)},_onUserAction:function(){console.log("PressTrigger --- _onUserAction"),this._isRunnable()&&this._restartTriggerTimer()},_registerVisibilityHandler:function(){this._fnVisibilityHandler&&document.removeEventListener("visibilitychange",this._fnVisibilityHandler),this._fnVisibilityHandler=this._onVisibilityChange.bind(this),document.addEventListener("visibilitychange",this._fnVisibilityHandler)},_unregisterVisibilityHandler:function(){this._fnVisibilityHandler&&(document.removeEventListener("visibilitychange",this._fnVisibilityHandler),this._fnVisibilityHandler=null)},_onVisibilityChange:function(){if(document.hidden)return void(this._lastHiddenTime=Date.now());if(!document.hidden&&this._lastHiddenTime){const a=Date.now()-this._lastHiddenTime;this._adjustRemainingTime(a),this._lastHiddenTime=null}},_adjustRemainingTime:function(a){if(!this._triggerTimerStartTime||!this._isRunnable())return;const b=1e3*this.getSecond()-(Date.now()-this._triggerTimerStartTime),c=b-a;if(0>=c)return void this._handleInactivityTimeout();const d=Math.ceil(c/1e3);this.setProperty("second",d,!0),this._restartTriggerTimer()},_handleInactivityTimeout:function(){this._detachBrowserEvents(),this._clearTriggerTimer(),this.setProperty("immediateRun",!1,!0),this.fireFinished()},setImmediateRun:function(a){const b=this.getProperty("immediateRun");return(this.setProperty("immediateRun",a,!0),b===a)?this:(!0===a&&this._isRunnable()?(this._attachBrowserEvents(),this._restartTriggerTimer()):(this._detachBrowserEvents(),this._clearTriggerTimer()),this)},setSecond:function(a){return this.setProperty("second",a,!0),this._isRunnable()&&this._restartTriggerTimer(),this},exit:function(){this._detachBrowserEvents(),this._clearTriggerTimer(),this._unregisterVisibilityHandler()}});return b});