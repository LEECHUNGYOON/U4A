u4a.m.ImageMarkShapeType={Rect:"rect",Circle:"circle",Poly:"poly"},sap.ui.define("u4a.m.ImageMapGenerator",["sap/ui/core/Control"],function(e){"use strict";return e.extend("u4a.m.ImageMapGenerator",{metadata:{library:"u4a.m",properties:{imgMapWidth:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},imgMapHeight:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},imgWidth:{type:"sap.ui.core.CSSSize",defaultValue:""},imgHeight:{type:"sap.ui.core.CSSSize",defaultValue:""},shape:{type:"u4a.m.ImageMarkShapeType",defaultValue:u4a.m.ImageMarkShapeType.Rect},maximumFileSize:{type:"float",defaultValue:1}},defaultAggregation:"contents",aggregations:{_container:{type:"sap.m.VBox",multiple:!1,visibility:"hidden"}},events:{coordDisplay:{allowPreventDefault:!0}}},init:function(){this._ImageMapInfo={}},onBeforeRendering:function(){var e=new sap.m.VBox({width:"auto",height:"100%",renderType:"Bare"}).addStyleClass("u4aMImageMapGeneratorContainer");this._createImageMapToolbar(e),this.setAggregation("_container",e,!0)},renderer:function(e,t){e.openStart("div",t),e.class("u4aMImageMapGenerator"),e.style("width",t.getImgMapWidth()),e.style("height",t.getImgMapHeight()),e.style("display","flex"),e.style("flex-direction","column"),e.openEnd();var a=t.getAggregation("_container");null!=a&&sap.m.VBoxRenderer.render(e,a),e.close("div")},onAfterRendering:function(){this._createImageMapContainer();var t=this,e=this._ImageMapInfo,a=e.imageMapId,i=document.getElementById(a);i.oMapInfo||(i.oMapInfo={},i.oMapInfo.fileLoaded=!1,i.oMapInfo.mapntId=a+"--image-mapper-point",i.oMapInfo.mapShapeId=a+"--image-mapper-shape",i.oMapInfo.imageId=a+"-img",e.mapInfo=i.oMapInfo),void 0===jQuery.u4aImgMapGenerator&&jQuery.u4aJSloadAsync("/zu4a_imp/tools/imageMarkGenerator/jquery.u4a.imageMarkGenerator.js",function(){jQuery.u4aJSloadAsync("/zu4a_imp/tools/imageMarkGenerator/imageMarkGeneratorBootStrap.js",function(){})});a=e.imageMapId;$(document).trigger("ImageMapInit",{mapId:"#"+a}),this._setDefaultImageAreaSize();var n=i.oMapInfo.imageId,o=document.getElementById(n);null!=o&&(""==o.src&&(o.src="/zu4a_imp/sample_img?obkey=NOIMGNOBACK"),o.onload=function(e){t._imageLoad(e)})},setImgMapWidth:function(e){this.setProperty("imgMapWidth",e,!0);var t=document.getElementById(this.getId());null!=t&&(t.style.width=e)},setImgMapHeight:function(e){this.setProperty("imgMapHeight",e,!0);var t=document.getElementById(this.getId());null!=t&&(t.style.height=e)},setImgWidth:function(e){this.setProperty("imgWidth",e,!0);var t=this._ImageMapInfo.mapInfo;null!=t&&t.fileLoaded&&this._imageResize()},setImgHeight:function(e){this.setProperty("imgHeight",e,!0);var t=this._ImageMapInfo.mapInfo;null!=t&&t.fileLoaded&&this._imageResize()},setShape:function(e){this.setProperty("shape",e,!0),this._oCombo.setSelectedKey(e),this._shapeTypeChange(e)},setMaximumFileSize:function(e){this.setProperty("maximumFileSize",e,!0)},_imageResize:function(){var e,t,a,i,n=this._ImageMapInfo,o=n.mapInfo,s=o.imageId,r=n.imageMapId,p=this.getImgWidth(),l=this.getImgHeight();o.fileLoaded&&(null==(e=document.getElementById(r))||null!=(t=document.getElementById(s))&&(a=t.naturalWidth+"px",i=t.naturalHeight+"px",e.style.width=""==p?a:p,e.style.height=""==l?i:l))},_createImageMapToolbar:function(e){var t,a,i,n,o,s;e&&(t=this,a=new sap.m.Toolbar,(i=new sap.ui.unified.FileUploader({buttonOnly:!0,buttonText:"찾아보기..",fileType:["jpg","jpeg","bmp","gif","png"],maximumFileSize:this.getMaximumFileSize()}).addStyleClass("sapUiTinyMarginEnd")).oBrowse.setType(sap.m.ButtonType.Emphasized),i.attachEvent("typeMissmatch",function(e){t._typeMissmatch(e)}),i.attachEvent("change",function(e){t._fileChange(e)}),i.attachEvent("fileSizeExceed",function(e){t._fileSizeExceed(e)}),(n=new sap.m.ComboBox({width:"100px",selectedKey:"rect"}).addStyleClass("sapUiTinyMarginEnd")).addItem(new sap.ui.core.Item({key:"rect",text:"Rect"})),n.addItem(new sap.ui.core.Item({key:"poly",text:"Poly"})),n.attachEvent("selectionChange",function(e){t._comboSelectChange(e)}),this._oCombo=n,this.setShape(n.getSelectedKey()),o=new sap.m.Button({text:"코드보기",type:sap.m.ButtonType.Ghost}).addStyleClass("sapUiTinyMarginEnd"),s=new sap.m.Button({text:"Clear",type:sap.m.ButtonType.Ghost}).addStyleClass("sapUiTinyMarginEnd"),o.attachEvent("press",function(e){t._coordsDisplay(e)}),s.attachEvent("press",function(e){t._clearBtnPress(e)}),a.addContent(new sap.m.ToolbarSpacer),a.addContent(i),a.addContent(n),a.addContent(o),a.addContent(s),e.addItem(a),this._oTool=a,this._oFileup=i,this._oCodeBtn=o,this._oClearBtn=s)},_createImageMapContainer:function(){var e,t,a,i,n,o,s,r,p=this.getAggregation("_container");p&&(e=this.getId(),t=p.getId(),null!=(a=document.getElementById(t))&&((i=document.createElement("div")).style.display="flex",i.style.flex="1 1 auto",i.style.minHeight="1px",i.classList.add("u4aMImageMapGeneratorWapper"),a.appendChild(i),(n=document.createElement("div")).id=e+"-ImageMapArea",n.style.display="flex",n.style.flex="1 1 auto",n.style.padding="1rem",n.style.boxSizing="border-box",n.classList.add("u4aMImageMapArea"),n.style.justifyContent="center",n.style.alignItems="center",n.style.overflow="auto",i.appendChild(n),(o=document.createElement("div")).id=e+"-ImageMapContent",o.style.boxSizing="border-box",o.style.position="relative",o.style.maxHeight="100%",o.classList.add("u4aMImageMapContent"),n.appendChild(o),(s=document.createElement("div")).id=this.getId()+"-ImageMap",s.classList.add("u4aMImageMap"),s.style.position="relative",s.style.flex="0 0 auto",s.style.overflow="hidden",s.style.display="inline-block",s.style.border="2px solid rgb(221, 221, 221)",s.style.padding="2px",s.style.borderRadius="3px",o.appendChild(s),this._oTool.getDomRef().style.flex="0 0 auto",(r=this._ImageMapInfo).imageMapId=s.id,r.imageMapAreaId=n.id,r.imageMapContentId=o.id))},_typeMissmatch:function(e){this._message("이미지파일을 선택해 주세요.")},_fileChange:function(e){var a,i,t,n,o=e.getParameter("files");0!=o.length&&(a=this._ImageMapInfo.imageMapId,i=o[0],t=new FileReader,n=this,t.onloadend=function(e){n._oClearBtn.firePress();var t=n._btoa(e.target.result);$("#"+a).imageMapper("update",{src:"data:"+i.type+";base64,"+t,file:i.name}),n._ImageMapInfo.mapInfo.fileLoaded=!0},i?t.readAsArrayBuffer(i):$("#"+a).imageMapper("update",{src:"",file:""}))},_fileSizeExceed:function(e){this._message("파일 크기가 초과되었습니다.")},_btoa:function(e){for(var t="",a=new Uint8Array(e),i=a.byteLength,n=0;n<i;n++)t+=String.fromCharCode(a[n]);return window.btoa(t)},_clearBtnPress:function(e){this.setShape("rect"),this._oCombo.setSelectedKey("rect");var t=this._ImageMapInfo.imageMapId;$("#"+t).imageMapperRemove()},_coordsDisplay:function(e){var t,a,i=this._ImageMapInfo.imageMapId,n=$("#"+i).imageMapper("getData");0!=n.area[0].coords.length&&(t=this._getCoords(n),a={shapeType:this._oCombo.getSelectedKey(),coords:t},this.fireCoordDisplay(a))},_comboSelectChange:function(e){var t=e.getSource().getSelectedKey();this._shapeTypeChange(t)},_shapeTypeChange:function(e){var t,a,i=this._ImageMapInfo.imageMapId;null!=i&&(a={markIdx:(t=$("#"+i)).data("imageMapper"),shapeType:e},t.imageMapperRemove(),t.imageMapperTypeChange(a),this.setProperty("shape",e,!0))},_getCoords:function(e){var t,a=e.area[0],i=a.coords,n=i.length,o=a.shape,s=[];if(0!=n&&(jQuery.each(i,function(e,t){s.push(t.naturalX,t.naturalY)}),"circle"==o&&(t=Math.round(Math.sqrt(Math.pow(s[2]-s[0],2)+Math.pow(s[3]-s[1],2))),(s=s.slice(0,2)).push(t)),0!=(n=s.length))){for(var r="",p=0;p<n;p++)r+=s[p]+",";return r.slice(0,-1)}},_message:function(e){sap.m.MessageToast.show(e,{width:"30%",my:"center center",at:"center center"})},_setDefaultImageAreaSize:function(){var e=this._ImageMapInfo.mapInfo,t=e.mapCls,a=e.mapSvg,i=$("."+t),n=$("."+a);i.css({"max-width":"100%","max-height":"100%",width:"100%",height:"100%"}),n.css({width:"100%",position:"absolute",top:"0",right:"0",bottom:"0",left:"0",height:"100%"})},_imageLoad:function(e){var t,a,i=this._ImageMapInfo;i.mapInfo.fileLoaded&&(t=i.imageMapAreaId,(a=document.getElementById(t)).style.justifyContent="flex-start",a.style.alignItems="",a.style.overflow="auto",this._imageResize())},exit:function(){delete this._ImageMapInfo,delete this._oClearBtn,delete this._oCodeBtn,delete this._oCombo,delete this._oFileup,delete this._oTool}})});