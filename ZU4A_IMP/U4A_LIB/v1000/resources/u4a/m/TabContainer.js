jQuery.sap.require("sap.ui.core.Control");jQuery.sap.require("sap.m.TabContainer");jQuery.sap.declare("u4a.m.TabContainer");sap.m.TabContainer.extend("u4a.m.TabContainer",{metadata:{library:"u4a.m",properties:{selectedKey:{type:"string",group:"Data",defaultValue:""},}},_OldItemKeys:[],_bisRemoveCalled:false,_iKey:null,constructor:function(vId,mSettings){var aStashedItems=[];if(!mSettings&&typeof vId==='object'){mSettings=vId}if(mSettings&&Array.isArray(mSettings['items'])){aStashedItems=mSettings['items'];delete mSettings['items']}var Control=sap.ui.core.Control;Control.prototype.constructor.apply(this,arguments);var oControl=new sap.m.TabStrip(this.getId()+"--tabstrip",{hasSelect:true,itemSelect:function(oEvent){var oItem=oEvent.getParameter("item"),oSelectedItem=this._fromTabStripItem(oItem);this.setSelectedItem(oSelectedItem,oEvent);this.setProperty("selectedKey",oSelectedItem.getKey(),true)}.bind(this),itemClose:function(oEvent){var oItem=oEvent.getParameter("item"),oRemovedItem=this._fromTabStripItem(oItem);oEvent.preventDefault();if(this.fireItemClose({item:oRemovedItem})){this.removeItem(oRemovedItem)}}.bind(this)});this.setAggregation("_tabStrip",oControl,true);if(mSettings&&mSettings['showAddNewButton']){this.setShowAddNewButton(true)}aStashedItems.forEach(function(oItem){this.addItem(oItem)},this)},renderer:function(oRm,oControl){"use strict";sap.m.TabContainerRenderer.render(oRm,oControl)},removeItem:function(vItem){var bIsSelected;if(typeof vItem==="undefined"||vItem===null){return null}this._bisRemoveCalled=true;var aItems=this.getItems();var iItemLen=aItems.length;if(this._OldItemKeys.length==0){for(var i=0;i<iItemLen;i++){var oItem=aItems[i];this._OldItemKeys.push(oItem.getProperty("key"))}}for(var i=0;i<iItemLen;i++){var oItem=aItems[i];var sItemKey=oItem.getKey();if(this.getSelectedKey()==sItemKey){this._iKey=sItemKey;break}}vItem=this.removeAggregation("items",vItem);bIsSelected=vItem.getId()===this.getSelectedItem();this._getTabStrip().removeItem(this._toTabStripItem(vItem));return vItem},_getItemIndex:function(aItems,sSelecedKey){var iItemLen=aItems.length;for(var i=0;i<iItemLen;i++){var oItem=aItems[i];var sItemKey=oItem.getProperty("key");if(sItemKey==sSelecedKey){return i}}return-1},onBeforeRendering:function(){"use strict";try{var aItems=this.getItems();var iItemLen=aItems.length;if(iItemLen==0){this.setAssociation("selectedItem",null);this.setProperty("selectedKey","",true);return}var sTabSelectedKey=this.getSelectedKey();if(sTabSelectedKey==""){this.setProperty("selectedKey",aItems[0].getKey(),true);this.setSelectedItem(aItems[0]);return}if(this._bisRemoveCalled==false){for(var i=0;i<iItemLen;i++){var oItem=aItems[i];var sItemKey=oItem.getKey();if(sItemKey==""){return}if(sTabSelectedKey!=sItemKey){continue}if(oItem.getId()!=this.getSelectedItem()){this.setSelectedItem(oItem);break}}return}var iCurItmIdx=this._getItemIndex(aItems,sTabSelectedKey);if(iCurItmIdx==-1){var iOldItemLen=this._OldItemKeys.length;for(var i=0;i<iOldItemLen;i++){if(this._OldItemKeys[i]==this._iKey){break}}for(var j=i;j<iOldItemLen;j++){for(var k=0;k<iItemLen;k++){var curItem=aItems[k];if(this._OldItemKeys[j]==curItem.getProperty("key")){this.setSelectedItem(curItem);this.setProperty("selectedKey",this._OldItemKeys[j],true);return}}}this.setSelectedItem(aItems[iItemLen-1]);this.setProperty("selectedKey",aItems[iItemLen-1].getProperty("key"),true);return}this.setProperty("selectedKey",aItems[iCurItmIdx].getProperty("key"),true);this.setAssociation("selectedItem",aItems[iCurItmIdx],true)}catch(e){}finally{this._bisRemoveCalled=false;this._OldItemKeys=[];this._iKey=null}}});