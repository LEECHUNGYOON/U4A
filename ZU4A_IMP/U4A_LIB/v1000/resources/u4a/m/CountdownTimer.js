sap.ui.define("u4a.m.CountdownTimer",["sap/ui/core/Control"],function(a){"use strict";var b=a.extend("u4a.m.CountdownTimer",{metadata:{library:"u4a.m",properties:{fontSize:{type:"sap.ui.core.CSSSize",defaultValue:"20px"},fontColor:{type:"sap.ui.core.CSSColor",defaultValue:"#000000"},hourCount:{type:"int",defaultValue:0},minCount:{type:"int",defaultValue:0},secCount:{type:"int",defaultValue:0},visible:{type:"boolean",defaultValue:!0}},events:{countdownComplete:{}}},renderer:function(a,b){a.write("<div"),a.writeControlData(b),a.addStyle("font-size",b.getFontSize()),a.addStyle("color",b.getFontColor()),a.addStyle("font-weight","bold"),a.writeClasses(b),b.getVisible()||a.addStyle("display","none"),a.writeStyles(),a.write(">");const c=b.getHourCount(),d=b.getMinCount(),e=b.getSecCount(),f=b._pad2(c)+":"+b._pad2(d)+":"+b._pad2(e);a.writeEscaped(f),a.write("</div>")},setHourCount:function(a){return this.setProperty("hourCount",a,!0),this._handlePropertyChange(),this},setMinCount:function(a){return this.setProperty("minCount",a,!0),this._handlePropertyChange(),this},setSecCount:function(a){return this.setProperty("secCount",a,!0),this._handlePropertyChange(),this},setVisible:function(a){this.setProperty("visible",a,!0);const b=this.getDomRef();return b&&(b.style.display=a?"":"none"),this},exit:function(){this._terminateWorker(),this._bVisHandlerRegistered&&this._fnVisibilityHandler&&(document.removeEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!1,this._fnVisibilityHandler=null)},_handlePropertyChange:function(){const a=this.getHourCount(),b=this.getMinCount(),c=this.getSecCount();return this._bWorkerStarted&&0===a&&0===b&&0===c?void this._stopTimer(!1):this._oWorker||0!==a||0!==b||0!==c?!this._oWorker&&(0<a||0<b||0<c)?void this._tryStart():void(this._oWorker&&(0<a||0<b||0<c)&&(this._terminateWorker(),this._tryStart())):void this._Print("00:00:00")},_tryStart:function(){let a=this.getHourCount(),b=this.getMinCount(),c=this.getSecCount();if(60<=c&&(b+=Math.floor(c/60),c%=60),60<=b&&(a+=Math.floor(b/60),b%=60),this.setProperty("hourCount",a,!0),this.setProperty("minCount",b,!0),this.setProperty("secCount",c,!0),0===a&&0===b&&0===c)return this._Print("00:00:00"),void this._terminateWorker();this._terminateWorker();const d=this._pad2(a)+":"+this._pad2(b)+":"+this._pad2(c);this._Print(d);const e=3600*a+60*b+c,f=new Date;this._dEndTime=new Date(f.getTime()+1e3*(e+1));const g={countDownDate:this._dEndTime};this._oWorker=new Worker("/zu4a_imp/publish/CommonJS/workers/CountdownTimerWorker.js"),this._bWorkerStarted=!0,this._oWorker.onmessage=function(a){this._onWorkerMessage(a)}.bind(this),this._oWorker.postMessage(g),this._registerVisibilityHandler()},_registerVisibilityHandler:function(){this._bVisHandlerRegistered||(this._fnVisibilityHandler=function(){if(document.hidden)return;if(!this._bWorkerStarted||!this._dEndTime)return;const a=new Date,b=this._dEndTime-a;if(0>=b)return void this._stopTimer(!1);const c=Math.floor(b/1e3),d=Math.floor(c/3600),e=Math.floor(c%3600/60),f=Math.floor(c%60);this.setProperty("hourCount",d,!0),this.setProperty("minCount",e,!0),this.setProperty("secCount",f,!0),this._terminateWorker(),this._tryStart()}.bind(this),document.addEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!0)},_onWorkerMessage:function(){if(!this._dEndTime)return;const a=new Date;let b=this._dEndTime-a;if(0>=b)return this._updateCountdownValues(0,0,0),this._Print("00:00:00"),void this._stopTimer(!1);const c=Math.floor(b/1e3),d=Math.floor(c/3600),e=Math.floor(c%3600/60),f=Math.floor(c%60);this._updateCountdownValues(d,e,f),this._Print(this._pad2(d)+":"+this._pad2(e)+":"+this._pad2(f))},_updateCountdownValues:function(a,b,c){this.setProperty("hourCount",a,!1),this.setProperty("minCount",b,!1),this.setProperty("secCount",c,!1);const d=this.getModel();if(d){const e=this.getBindingPath("hourCount");e&&d.setProperty(e,a+"");const f=this.getBindingPath("minCount");f&&d.setProperty(f,b+"");const g=this.getBindingPath("secCount");g&&d.setProperty(g,c+"")}},_stopTimer:function(a){this._terminateWorker(),this._Print("00:00:00"),this._bWorkerStarted&&!a&&this.fireCountdownComplete(),this._bWorkerStarted=!1},_terminateWorker:function(){this._oWorker instanceof Worker&&(this._oWorker.terminate(),this._oWorker=null)},_Print:function(a){const b=this.getDomRef();b&&(b.innerHTML=a)},_pad2:function(a){return(10>a?"0":"")+a}});return b});