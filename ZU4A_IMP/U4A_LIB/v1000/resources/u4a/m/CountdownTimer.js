sap.ui.define("u4a.m.CountdownTimer",["sap/ui/core/Control"],(function(t){"use strict";return t.extend("u4a.m.CountdownTimer",{metadata:{library:"u4a.m",properties:{fontSize:{type:"sap.ui.core.CSSSize",defaultValue:"20px"},fontColor:{type:"sap.ui.core.CSSColor",defaultValue:"#000000"},hourCount:{type:"int",defaultValue:0},minCount:{type:"int",defaultValue:0},secCount:{type:"int",defaultValue:0},visible:{type:"boolean",defaultValue:!0}},events:{countdownComplete:{}}},renderer:function(t,e){t.write("<div"),t.writeControlData(e),t.addStyle("font-size",e.getFontSize()),t.addStyle("color",e.getFontColor()),t.addStyle("font-weight","bold"),e.getVisible()||t.addStyle("display","none"),t.writeStyles(),t.write(">");var n=e.getHourCount(),r=e.getMinCount(),i=e.getSecCount();t.writeEscaped(e._pad2(n)+":"+e._pad2(r)+":"+e._pad2(i)),t.write("</div>")},onAfterRendering:function(){var t=0|this.getHourCount(),e=0|this.getMinCount(),n=0|this.getSecCount();n>=60&&(e+=Math.floor(n/60),n%=60),e>=60&&(t+=Math.floor(e/60),e%=60),this.setProperty("hourCount",t,!0),this.setProperty("minCount",e,!0),this.setProperty("secCount",n,!0),this._Print(this._pad2(t)+":"+this._pad2(e)+":"+this._pad2(n)),0!==t||0!==e||0!==n?this._startOrUpdateWorker(t,e,n):this._bWorkerStarted?this._stopTimer():(this._terminateWorker(),this._Print("00:00:00"))},_startOrUpdateWorker:function(t,e,n){var r=3600*t+60*e+n;if(this._dEndTime=new Date(Date.now()+1e3*r+1e3),this._oWorker instanceof Worker)try{return this._oWorker.postMessage({countDownDate:this._dEndTime}),void(this._bWorkerStarted=!0)}catch(t){this._terminateWorker()}try{this._oWorker=this._createDynamicWorker()}catch(t){this._terminateWorker(),this._dumpAndThrow("[CountdownTimer] Worker creation failed: "+t.message)}this._oWorker.onerror=function(t){this._terminateWorker(),this._dumpAndThrow("[CountdownTimer] Worker runtime error: "+t.message+" ("+t.filename+":"+t.lineno+")")}.bind(this),this._oWorker.onmessage=function(t){this._onWorkerMessage(t)}.bind(this);try{this._oWorker.postMessage({countDownDate:this._dEndTime}),this._bWorkerStarted=!0}catch(t){this._terminateWorker(),this._dumpAndThrow("[CountdownTimer] Failed to post message: "+t.message)}this._registerVisibilityHandler()},_createDynamicWorker:function(){var t=this.getCountdownWorkerCode(),e=new Blob([t],{type:"application/javascript"}),n=URL.createObjectURL(e),r=new Worker(n),i=r.terminate;return r.terminate=function(){try{i.call(r)}finally{URL.revokeObjectURL(n)}},r},getCountdownWorkerCode:function(){return"\n        // ================================================================\n        // Copyright 2017. INFOCG Inc. all rights reserved.\n        // Title : u4a.m.CountdownTimer Worker\n        // Desc  : u4a.m.CountdownTimer 전용 Web Worker 스크립트\n        //         메인 스레드 부하 없이 초 단위 카운트다운 계산 담당.\n        // Revised on : 2025-11-01\n        // ================================================================\n\n        self.onmessage = function(e) {\n          var oReceiveData = e.data,\n              oSendData = {},\n              countDownDate = oReceiveData.countDownDate;\n\n          if(this.timerInterval){\n            clearInterval(this.timerInterval);\n            this.timerInterval=null;\n          }\n\n          this.timerInterval=setInterval(function(){\n            try{\n              var now=new Date().getTime();\n              var distance=countDownDate-now;\n\n              var hours=Math.floor((distance%(1000*60*60*24))/(1000*60*60));\n              var minutes=Math.floor((distance%(1000*60*60))/(1000*60));\n              var seconds=Math.floor((distance%(1000*60))/1000);\n\n              hours=(hours<0?0:hours);\n              minutes=(minutes<0?0:minutes);\n              seconds=(seconds<0?0:seconds);\n\n              oSendData.hourCount=fn_addZeros(hours,2);\n              oSendData.minCount=fn_addZeros(minutes,2);\n              oSendData.secCount=fn_addZeros(seconds,2);\n              oSendData.print=oSendData.hourCount+\":\"+oSendData.minCount+\":\"+oSendData.secCount;\n\n              postMessage(oSendData);\n\n              if(distance<0){\n                clearInterval(this.timerInterval);\n                this.timerInterval=null;\n                oSendData.isStop=true;\n                postMessage(oSendData);\n              }\n            }catch(e){}\n          }.bind(this),1000);\n        };\n\n        function fn_addZeros(n,width){\n          n=n+'';\n          return n.length>=width?n:new Array(width-n.length+1).join('0')+n;\n        }\n      "},_onWorkerMessage:function(t){var e=t.data;if(!0!==e.isStop){var n=parseInt(e.hourCount,10)||0,r=parseInt(e.minCount,10)||0,i=parseInt(e.secCount,10)||0;this.setProperty("hourCount",n,!0),this.setProperty("minCount",r,!0),this.setProperty("secCount",i,!0),this._Print(e.print)}else{if(this._dEndTime&&Date.now()<this._dEndTime.getTime())return;this._stopTimer()}},_registerVisibilityHandler:function(){this._bVisHandlerRegistered||(this._fnVisibilityHandler=function(){if(!document.hidden&&this._oWorker&&this._dEndTime)try{this._oWorker.postMessage({countDownDate:this._dEndTime})}catch(t){}}.bind(this),document.addEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!0)},_stopTimer:function(){this.setProperty("hourCount",0,!0),this.setProperty("minCount",0,!0),this.setProperty("secCount",0,!0),this._terminateWorker(),this._Print("00:00:00"),this.fireCountdownComplete(),this._bWorkerStarted=!1},_terminateWorker:function(){if(this._oWorker instanceof Worker){try{this._oWorker.terminate()}catch(t){}this._oWorker=null}},_Print:function(t){var e=document.getElementById(this.getId());e&&(e.innerHTML=t)},_pad2:function(t){return(t<10?"0":"")+t},exit:function(){this._terminateWorker(),this._bVisHandlerRegistered&&this._fnVisibilityHandler&&(document.removeEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!1,this._fnVisibilityHandler=null)},_dumpAndThrow:function(t){if("undefined"!=typeof oU4AErroHandle&&"function"==typeof oU4AErroHandle.seterroHTML)try{oU4AErroHandle.seterroHTML(t)}catch(t){}throw new Error(t)}})}));