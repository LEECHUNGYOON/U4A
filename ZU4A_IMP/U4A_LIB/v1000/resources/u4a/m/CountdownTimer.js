sap.ui.define("u4a.m.CountdownTimer",["sap/ui/core/Control","sap/ui/core/format/DateFormat"],(function(t,e){"use strict";return t.extend("u4a.m.CountdownTimer",{metadata:{library:"u4a.m",properties:{fontSize:{type:"sap.ui.core.CSSSize",defaultValue:"20px"},fontColor:{type:"sap.ui.core.CSSColor",defaultValue:"#000000"},hourCount:{type:"int",defaultValue:0},minCount:{type:"int",defaultValue:0},secCount:{type:"int",defaultValue:0},visible:{type:"boolean",defaultValue:!0},displayFormat:{type:"string",defaultValue:"HH:mm:ss"}},events:{countdownComplete:{}}},init:function(){this._oWorker=null,this._dEndTime=null,this._bWorkerStarted=!1,this._oDateFormat=null,this._sLastFmt=null,this._bVisHandlerRegistered=!1,this._fnVisibilityHandler=null},exit:function(){this._terminateWorker(),this._bVisHandlerRegistered&&this._fnVisibilityHandler&&(document.removeEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!1,this._fnVisibilityHandler=null)},renderer:function(t,e){t.openStart("div",e),t.style("font-size",e.getFontSize()),t.style("color",e.getFontColor()),t.style("font-weight","bold"),e.getVisible()||t.style("display","none"),t.openEnd(),t.text(e._formatDisplay(e.getHourCount(),e.getMinCount(),e.getSecCount())),t.close("div")},setDisplayFormat:function(t){return this.setProperty("displayFormat",t,!0),this._Print(this._formatDisplay(this.getHourCount(),this.getMinCount(),this.getSecCount())),this},onAfterRendering:function(){var t=0|this.getHourCount(),e=0|this.getMinCount(),n=0|this.getSecCount();if(n>=60&&(e+=Math.floor(n/60),n%=60),e>=60&&(t+=Math.floor(e/60),e%=60),this.setProperty("hourCount",t,!0),this.setProperty("minCount",e,!0),this.setProperty("secCount",n,!0),this._Print(this._formatDisplay(t,e,n)),0===t&&0===e&&0===n)return this._bWorkerStarted?(this._terminateWorker(),this._Print(this._formatDisplay(0,0,0)),this.fireCountdownComplete(),this._bWorkerStarted=!1,void(this._dEndTime=null)):(this._terminateWorker(),void(this._dEndTime=null));this._startOrUpdateWorker(t,e,n)},_startOrUpdateWorker:function(t,e,n){var i=3600*t+60*e+n;if(this._dEndTime=new Date(Date.now()+1e3*i+1e3),this._oWorker instanceof Worker)try{return this._oWorker.postMessage({countDownDate:this._dEndTime}),void(this._bWorkerStarted=!0)}catch(t){this._terminateWorker()}try{this._oWorker=this._createDynamicWorker()}catch(t){this._terminateWorker(),this._dumpAndThrow("[CountdownTimer] Worker creation failed: "+t.message)}this._oWorker.onerror=function(t){this._terminateWorker(),this._dumpAndThrow("[CountdownTimer] Worker runtime error: "+t.message+" ("+t.filename+":"+t.lineno+")")}.bind(this),this._oWorker.onmessage=function(t){this._onWorkerMessage(t)}.bind(this);try{this._oWorker.postMessage({countDownDate:this._dEndTime}),this._bWorkerStarted=!0}catch(t){this._terminateWorker(),this._dumpAndThrow("[CountdownTimer] Failed to post message: "+t.message)}this._registerVisibilityHandler()},_createDynamicWorker:function(){var t=this.getCountdownWorkerCode(),e=new Blob([t],{type:"application/javascript"}),n=URL.createObjectURL(e),i=new Worker(n),r=i.terminate;return i.terminate=function(){try{r.call(i)}finally{URL.revokeObjectURL(n)}},i},getCountdownWorkerCode:function(){return"\n            // ================================================================\n            // Copyright 2017. INFOCG Inc. all rights reserved.\n            // Title : u4a.m.CountdownTimer Worker\n            // Desc  : u4a.m.CountdownTimer 전용 Web Worker 스크립트\n            //         메인 스레드 부하 없이 초 단위 카운트다운 계산 담당.\n            // Revised on : 2025-11-01\n            // ================================================================\n\n            self.onmessage=function(e){\n                var oReceiveData=e.data,\n                    oSendData={},\n                    countDownDate=oReceiveData.countDownDate;\n\n                if(this.timerInterval){\n                    clearInterval(this.timerInterval);\n                    this.timerInterval=null;\n                }\n\n                this.timerInterval=setInterval(function(){\n                    try{\n                        var now=new Date().getTime();\n                        var distance=countDownDate-now;\n\n                        var hours=Math.floor((distance%(1000*60*60*24))/(1000*60*60));\n                        var minutes=Math.floor((distance%(1000*60*60))/(1000*60));\n                        var seconds=Math.floor((distance%(1000*60))/1000);\n\n                        hours=(hours<0?0:hours);\n                        minutes=(minutes<0?0:minutes);\n                        seconds=(seconds<0?0:seconds);\n\n                        oSendData.hourCount=fn_addZeros(hours,2);\n                        oSendData.minCount=fn_addZeros(minutes,2);\n                        oSendData.secCount=fn_addZeros(seconds,2);\n                        oSendData.print=oSendData.hourCount+\":\"+oSendData.minCount+\":\"+oSendData.secCount;\n\n                        postMessage(oSendData);\n\n                        if(distance<0){\n                            clearInterval(this.timerInterval);\n                            this.timerInterval=null;\n                            oSendData.isStop=true;\n                            postMessage(oSendData);\n                        }\n                    }catch(e){}\n                }.bind(this),1000);\n            };\n\n            function fn_addZeros(n,width){\n                n=n+'';\n                return n.length>=width?n:new Array(width-n.length+1).join('0')+n;\n            }\n        "},_onWorkerMessage:function(t){var e=t.data;if(!0!==e.isStop){var n=parseInt(e.hourCount,10)||0,i=parseInt(e.minCount,10)||0,r=parseInt(e.secCount,10)||0;this.setProperty("hourCount",n,!0),this.setProperty("minCount",i,!0),this.setProperty("secCount",r,!0),this._Print(this._formatDisplay(n,i,r))}else{if(this._dEndTime&&Date.now()<this._dEndTime.getTime())return;this._stopTimer()}},_registerVisibilityHandler:function(){this._bVisHandlerRegistered||(this._fnVisibilityHandler=function(){if(!document.hidden&&this._oWorker&&this._dEndTime)try{this._oWorker.postMessage({countDownDate:this._dEndTime})}catch(t){}}.bind(this),document.addEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!0)},_stopTimer:function(){this.setProperty("hourCount",0,!0),this.setProperty("minCount",0,!0),this.setProperty("secCount",0,!0),this._terminateWorker(),this._Print(this._formatDisplay(0,0,0)),this.fireCountdownComplete(),this._bWorkerStarted=!1,this._dEndTime=null},_terminateWorker:function(){if(this._oWorker instanceof Worker){try{this._oWorker.terminate()}catch(t){}this._oWorker=null}},_formatDisplay:function(t,n,i){var r=this.getDisplayFormat(),o={};["short","medium","long","full"].indexOf(r)>=0?o.style=r:o.pattern=r;var s=JSON.stringify(o);this._oDateFormat&&this._sLastFmt===s||(this._oDateFormat=e.getTimeInstance(o),this._sLastFmt=s);var a=new Date(1970,0,1,t,n,i);return this._oDateFormat.format(a)},_Print:function(t){var e=document.getElementById(this.getId());e&&(e.innerHTML=t)},_dumpAndThrow:function(t){if("undefined"!=typeof oU4AErroHandle&&"function"==typeof oU4AErroHandle.seterroHTML)try{oU4AErroHandle.seterroHTML(t)}catch(t){}throw new Error(t)}})}));