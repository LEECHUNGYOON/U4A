sap.ui.define("u4a.m.CurrentTimer",["sap/ui/core/Control","sap/ui/core/library"],(function(e,r){"use strict";var t=r.TextAlign;return e.extend("u4a.m.CurrentTimer",{metadata:{library:"u4a.m",properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:null},textAlign:{type:"sap.ui.core.TextAlign",defaultValue:t.Begin},fontSize:{type:"sap.ui.core.CSSSize",defaultValue:"20px"},fontColor:{type:"sap.ui.core.CSSColor",defaultValue:"#000000"},support2400:{type:"boolean",defaultValue:!1}}},renderer:function(e,r){var n=r.getWidth(),i=r.getFontSize(),a=r.getFontColor(),o=r.getTextAlign(),s=r.getSupport2400(),u=r._getFormattedCurrentTime(s);if(e.write("<span"),e.writeControlData(r),e.addStyle("display","inline-block"),n?e.addStyle("width",n):e.addStyle("max-width","100%"),e.addStyle("color",a),e.addStyle("font-size",i),o){var d=sap.ui.Device.browser.name;"ie"!==d&&"ed"!==d||o!==t.End?e.addStyle("text-align",o):e.addStyle("text-align","right")}e.writeStyles(),e.write(">"),e.writeEscaped(u),e.write("</span>")},onAfterRendering:function(){this._terminateWorker(),this._tryStart(),this._registerVisibilityHandler()},exit:function(){this._terminateWorker(),this._bVisHandlerRegistered&&this._fnVisibilityHandler&&(document.removeEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!1,this._fnVisibilityHandler=null)},_dumpAndThrow:function(e){throw"undefined"!=typeof oU4AErroHandle&&"function"==typeof oU4AErroHandle.seterroHTML&&oU4AErroHandle.seterroHTML(e),new Error(e)},_tryStart:function(){var e=this.getSupport2400();this._Print(this._getFormattedCurrentTime(e));try{this._oWorker=this._createDynamicWorker()}catch(e){this._terminateWorker(),this._dumpAndThrow("[CurrentTimer] Dynamic Worker creation failed: "+e.message)}this._bWorkerStarted=!0,this._oWorker.onerror=function(e){this._terminateWorker(),this._dumpAndThrow("[CurrentTimer] Worker runtime error: "+(e&&e.message?e.message:"Unknown"))}.bind(this);try{this._oWorker.postMessage({command:"start",support2400:e})}catch(e){this._terminateWorker(),this._dumpAndThrow("[CurrentTimer] Failed to post message to Worker: "+e.message)}this._oWorker.onmessage=function(e){if(e&&e.data&&e.data.__error)return this._terminateWorker(),void this._dumpAndThrow("[CurrentTimer] Worker internal error: "+e.data.__error);this._onWorkerMessage(e)}.bind(this)},_createDynamicWorker:function(){var e=this.getCurrentWorkerCode(),r=new Blob([e],{type:"application/javascript"}),t=URL.createObjectURL(r),n=new Worker(t),i=n.terminate;return n.terminate=function(){try{i.call(n)}finally{URL.revokeObjectURL(t)}},n},getCurrentWorkerCode:function(){return"\n\n                /***************************************************\n                 * CurrentTimer.js 용 워커 스크립트\n                 ***************************************************/            \n            \n            // Interval ID와 설정을 저장할 변수\n            var currentTimer = null;\n            var support2400 = false;\n\n                // worker 메시지 수신 listener\n                self.onmessage = function(e) {\n                    \n                    var oData = e.data;\n\n                    if (!oData || !oData.command) {\n                        return; // 유효하지 않은 메시지\n                    }\n\n                    // --- 'stop' 명령 처리 ---\n                    if (oData.command === 'stop') {\n                        if (currentTimer) {\n                            clearInterval(currentTimer);\n                            currentTimer = null;\n                        }\n                        return;\n                    }\n\n                    // --- 'start' 명령 처리 ---\n                    if (oData.command === 'start') {\n                        // 기존 Interval이 있다면 중지\n                        if (currentTimer) {\n                            clearInterval(currentTimer);\n                            currentTimer = null;\n                        }\n                        \n                        // 24시간제 설정 업데이트\n                        support2400 = !!oData.support2400; \n\n                        // 즉시 1회 실행 (주석 처리: start 시 메인스레드에서 이미 반영함)\n                        // _postTime(); \n\n                        // 1초 간격으로 Interval 시작\n                        currentTimer = setInterval(_postTime, 1000);\n                    }\n                };\n\n            // 시간을 계산하고 postMessage로 전송하는 함수\n            function _postTime() {\n                try {\n                    var currentDate = new Date();\n                    var iHour       = currentDate.getHours();\n                    var currentMinute  = addZeros(currentDate.getMinutes(), 2);\n                    var currentSeconds = addZeros(currentDate.getSeconds(), 2);\n                    \n                    var amPm = '';\n                    var currentHours;\n\n                    if (!support2400) {\n                        amPm = iHour >= 12 ? 'PM' : 'AM'; // AM/PM 결정\n                        \n                        iHour = iHour % 12;\n                        if (iHour === 0) { \n                            iHour = 12; // 0시는 12시로\n                        }\n                        currentHours = addZeros(iHour, 2);\n                    } else {\n                        currentHours = addZeros(iHour, 2);\n                    }\n                    \n                    var sDateTime = currentHours + \":\" + currentMinute + \":\" + currentSeconds + \" \" + amPm;\n                    postMessage(sDateTime.trim()); // amPm이 없을 경우 공백 제거\n\n                } catch(ex) {\n                    postMessage({ __error: ex && ex.message ? ex.message : \"Worker internal error\" });\n                    \n                    // 오류 발생 시 Interval 중지\n                    if (currentTimer) {\n                        clearInterval(currentTimer);\n                        currentTimer = null;\n                    }\n                }\n            }\n\n                function addZeros(n, width) {\n                    n = n + '';\n                    return n.length >= width ? n : new Array(width - n.length + 1).join('0') + n;\n                }\n            "},_terminateWorker:function(){if(this._oWorker instanceof Worker){try{this._oWorker.terminate()}catch(e){}this._oWorker=null}},_registerVisibilityHandler:function(){this._bVisHandlerRegistered||(this._fnVisibilityHandler=function(){if(this._oWorker)if(document.hidden)try{this._oWorker.postMessage({command:"stop"})}catch(e){}else{this._Print(this._getFormattedCurrentTime(this.getSupport2400()));try{this._oWorker.postMessage({command:"start",support2400:this.getSupport2400()})}catch(e){this._terminateWorker(),this._tryStart()}}else document.hidden||this._tryStart()}.bind(this),document.addEventListener("visibilitychange",this._fnVisibilityHandler),this._bVisHandlerRegistered=!0)},_onWorkerMessage:function(e){var r=document.getElementById(this.getId());r&&(r.innerHTML=e.data)},_Print:function(e){var r=this.getDomRef();r&&(r.innerHTML=e)},_getFormattedCurrentTime:function(e){var r=new Date,t=r.getHours(),n=r.getMinutes(),i=r.getSeconds(),a="";e||(a=t>=12?"PM":"AM",0===(t%=12)&&(t=12));var o=this._pad2(t),s=this._pad2(n),u=this._pad2(i);return e?o+":"+s+":"+u:o+":"+s+":"+u+" "+a},_pad2:function(e){return(e<10?"0":"")+e}})}));